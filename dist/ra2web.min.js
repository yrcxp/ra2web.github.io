var __classPrivateFieldSet=this&&this.__classPrivateFieldSet||function(g,P,I,L,_){if("m"===L)throw new TypeError("Private method is not writable");if("a"===L&&!_)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof P?g!==P||!_:!P.has(g))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===L?_.call(g,I):_?_.value=I:P.set(g,I),I},__classPrivateFieldGet=this&&this.__classPrivateFieldGet||function(g,P,I,L){if("a"===I&&!L)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof P?g!==P||!L:!P.has(g))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===I?L:"a"===I?L.call(g):L?L.value:P.get(g)},__decorate=this&&this.__decorate||function(g,P,I,L){var _,U=arguments.length,G=U<3?P:null===L?L=Object.getOwnPropertyDescriptor(P,I):L;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)G=Reflect.decorate(g,P,I,L);else for(var V=g.length-1;0<=V;V--)(_=g[V])&&(G=(U<3?_(G):3<U?_(P,I,G):_(P,I))||G);return 3<U&&G&&Object.defineProperty(P,I,G),G},__awaiter=this&&this.__awaiter||function(g,P,I,L){function s(g){return g instanceof I?g:new I(function(P){P(g)})}return new(I||(I=Promise))(function(I,_){function n(g){try{l(L.next(g))}catch(g){_(g)}}function o(g){try{l(L.throw(g))}catch(g){_(g)}}function l(g){g.done?I(g.value):s(g.value).then(n,o)}l((L=L.apply(g,P||[])).next())})},__metadata=this&&this.__metadata||function(g,P){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,P)},__param=this&&this.__param||function(g,P){return function(I,L){P(I,L,g)}};System.register("Application",["fontfaceobserver","detect-gpu","@puzzl/core/lib/async/cancellation","engine/Engine","engine/EngineType","gui/component/SplashScreen","network/WolConnection","network/gameopt/Parser","Config","util/Routing","tools/LobbyFormTester","tools/VxlTester","tools/ShpTester","tools/BuildingTester","data/IniFile","util/time","engine/ResourceLoader","ConsoleVars","util/Logger","tools/DevToolsApi","tools/VehicleTester","tools/InfantryTester","tools/AircraftTester","tools/SoundTester","LocalPrefs","gui/FullScreen","version","data/Strings","network/ServerRegions","gui/screen/options/GeneralOptions","engine/gameRes/GameResConfig","gui/component/BasicErrorBoxApi","engine/gameRes/GameRes","engine/gameRes/importError/FileNotFoundError","engine/gameRes/importError/ArchiveDownloadError","engine/gameRes/importError/InvalidArchiveError","engine/gameRes/importError/ArchiveExtractionError","engine/gameRes/importError/ChecksumError","engine/gameRes/importError/NoStorageError","data/MapFile","gui/component/ImageContext","util/BoxedVar","gui/replay/ReplayStorageFileSystem","gui/replay/ReplayStorageMigration","data/vfs/StorageQuotaError","Gui","data/vfs/IOError","network/WolService","data/vfs/FileNotFoundError","RouteHelper","data/CsfFile","util/Sentry","engine/gameRes/importError/NoWebAssemblyError","network/WolConfig"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be,Se,we,Ee,Ce,xe,Oe,Ae,Me,Re,Pe,Ie,ke,Be,Ne,Le,je,De,Fe,_e;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g},function(g){ce=g},function(g){he=g},function(g){ue=g},function(g){de=g},function(g){ge=g},function(g){pe=g},function(g){me=g},function(g){fe=g},function(g){ye=g},function(g){Te=g},function(g){ve=g},function(g){be=g},function(g){Se=g},function(g){we=g},function(g){Ee=g},function(g){Ce=g},function(g){xe=g},function(g){Oe=g},function(g){Ae=g},function(g){Me=g},function(g){Re=g},function(g){Pe=g},function(g){Ie=g},function(g){ke=g},function(g){Be=g},function(g){Ne=g},function(g){Le=g},function(g){je=g},function(g){De=g},function(g){Fe=g}],execute:function(){g("Application",_e=class ie{constructor(){this.viewport=new Oe.BoxedVar({x:0,y:0,width:0,height:0})}getVersion(){return ue.version}getEngineVersion(){return U.Engine.getVersion()}getEngineModHash(){return U.Engine.getModHash()}async main(){try{await this.loadConfig()}catch(z){return void console.error("Missing config.ini. Please see README.md")}var g=this.config.defaultLocale;let P;try{P=await this.loadTranslations(g),this.locale=g}catch(z){return void console.error(`Missing translation ${g}.`,z)}let L=new de.Strings(P);try{this.checkGlobalLibs()}catch(z){return console.error(z),void alert(L.get("TS:DownloadFailed"))}this.localPrefs=new ce.LocalPrefs(localStorage);var _=document.getElementById("ra2web-root");if(!_)throw new Error("Missing root element");this.rootEl=_,this.runtimeVars=new te.ConsoleVars,se.DevToolsApi.registerCommand("help",()=>{console.info("Available commands: "),[...se.DevToolsApi.listCommands()].forEach(g=>console.info("> "+g)),console.info("Available variables: "),[...se.DevToolsApi.listVars()].forEach(g=>console.info("> "+g))}),se.DevToolsApi.registerVar("freecamera",this.runtimeVars.freeCamera),se.DevToolsApi.registerCommand("version",()=>{console.info("Client version: "+this.getVersion()),console.info("Engine version: "+this.getEngineVersion()),console.info("Mod hash: "+U.Engine.getModHash())}),this.runtimeVars.forceResolution.onChange.subscribe(g=>{var P,I;g?.match(/^\d+x\d+$/)&&([P,I]=g.split("x").map(Number),this.setPreferredViewportSize({width:P,height:I}))}),se.DevToolsApi.registerVar("forcesize",this.runtimeVars.forceResolution),se.DevToolsApi.registerVar("debug_wireframes",this.runtimeVars.debugWireframes),se.DevToolsApi.registerVar("debug_paths",this.runtimeVars.debugPaths),se.DevToolsApi.registerVar("debug_text",this.runtimeVars.debugText),se.DevToolsApi.registerVar("debug_bot",this.runtimeVars.debugBotIndex),await this.initLogging(),this.fullScreen=new he.FullScreen(document),this.fullScreen.init(),this.fullScreen.onChange.subscribe(g=>{this.onFullScreenChange(g),this.updateViewportSize(g)}),window.addEventListener("resize",()=>this.updateViewportSize(this.fullScreen.isFullScreen())),this.updateViewportSize(this.fullScreen.isFullScreen());let W=new V.SplashScreen(this.viewport.value.width,this.viewport.value.height);this.splashScreen=W,W.render(this.rootEl),W.setLoadingText(L.get("GUI:LoadingEx")),W.setCopyrightText(L.get("TXT_COPYRIGHT")+"\n"+L.get("GUI:WWBrand")),W.setDisclaimerText(L.get("TS:Disclaimer"));var z=J.sleep(this.config.devMode?0:5e3);let K;this.loadGpuBenchmarkData().then(g=>this.gpuTier=g).catch(g=>this.sentry?.captureException(g));try{K=this.fsAccessLib=await SystemJS.import("file-system-access")}catch(z){return console.error(z),W.setLoadingText(""),W.setBackgroundImage(""),void this.handleGameResLoadError(new ee.DownloadError("Failed to download fsa lib",{cause:z}),L,!0)}U.Engine.setActiveEngine(G.EngineType.RedAlert2);var q=new URLSearchParams(location.search).get(Ne.RouteHelper.modQueryStringName)||void 0;let $=this.loadGameResConfig(this.localPrefs);try{let{configToPersist:g,cdnResLoader:P}=await new ye.GameRes(this.getVersion(),U.Engine.getActiveEngine(),q,K,this.localPrefs,L,_,W,this.viewport,this.config,ie.resPath,this.sentry).init($,(g,P)=>this.handleGameResLoadError(g,P),(g,P)=>this.handleGameResImportError(g,P));g&&(g.isCdn()?this.localPrefs.removeItem(ce.StorageKey.GameRes):this.localPrefs.setItem(ce.StorageKey.GameRes,g.serialize()),$=g),this.cdnResourceLoader=P}catch(z){return console.error(z),W.setLoadingText(""),W.setBackgroundImage(""),void this.handleGameResLoadError(z,L,!0)}this.gameResConfig=$,window.gtag?.("event","app_init",{res:this.gameResConfig.source,modName:U.Engine.getActiveMod()||"<none>"}),xe.ImageContext.cdnBaseUrl=this.gameResConfig.isCdn()?this.gameResConfig.getCdnBaseUrl():void 0,xe.ImageContext.vfs=U.Engine.vfs;try{let I=new Le.CsfFile(U.Engine.vfs.openFile(U.Engine.getFileNameVariant("ra2.csf")));var Q=I.getIsoLocale();if(void 0!==Q&&Q!==g)try{P=await this.loadTranslations(Q),this.locale=Q}catch(z){console.warn(`Failed to load translation ${Q}. Falling back to ${g}.`,z)}L=this.strings=new de.Strings(I),L.fromJson(P),U.Engine.loadRules(),this.sentry?.configureScope(g=>{g.setTag("mod",U.Engine.getActiveMod()||"<none>"),g.setExtra("mod",U.Engine.getActiveMod()||"<none>"),g.setExtra("modHash",U.Engine.getModHash())}),window.AudioContext||(window.AudioContext=(await SystemJS.import("web-audio-polyfill.js")).AudioContext)}catch(z){return console.error(z),W.setLoadingText(""),W.setBackgroundImage(""),void this.handleGameResLoadError(z,L,!0)}try{await new I.default("Fira Sans Condensed").load(),await new I.default("Fira Sans Condensed",{weight:"bold"}).load()}catch(z){console.error("Failed to load font",z)}try{await this.migrateReplayStorage(this.localPrefs,W,L)}catch(z){W.setLoadingText(""),z instanceof Re.StorageQuotaError||z instanceof Ie.IOError||z instanceof Be.FileNotFoundError||this.sentry?.captureException(new Error("Failed to migrate replays to new storage",{cause:z})),console.error("Failed to migrate replays to new storage",z)}await z,W.destroy(),this.splashScreen=void 0,this.initRouting()}async loadTranslations(g){return await new ee.ResourceLoader(ie.resPath).loadJson(`locale/${g}.json?v=`+this.getVersion())}checkGlobalLibs(){var g,P;for([g,P]of new Map([["CDWorkerHostLib",()=>window.CDWorkerHostLib],["THREE",()=>window.THREE],["Octree",()=>window.Octree],["SimplexNoise",()=>window.SimplexNoise],["LightningStrike",()=>window.THREE.LightningStrike],["TrailRenderer",()=>window.THREE.TrailRenderer],["SPE",()=>window.SPE],["GrowingPacker",()=>window.GrowingPacker],["lzo1x",()=>window.lzo1x]])){let I=!1;try{void 0!==P()&&(I=!0)}catch(g){}if(!I)throw new Error(`Library "${g}" was not found on window scope`)}}async loadConfig(){let g=await new ee.ResourceLoader("").loadText("config.ini");if(g.startsWith("<"))throw new Error("Config download failed. Response looks like an HTML document.");var P=(new X.IniFile).fromString(g);this.config=new K.Config,this.config.load(P)}async initLogging(){re.AppLogger.useDefaults(),this.config.debugLogging&&(this.runtimeVars.debugLogging.value=this.config.debugLogging),se.DevToolsApi.registerVar("debug_logging",this.runtimeVars.debugLogging);var e=g=>{var P;if("string"!=typeof g)re.AppLogger.setLevel(g?re.AppLogger.DEBUG:re.AppLogger.INFO);else for(P of g.split(","))re.AppLogger.get(P).setLevel(re.AppLogger.DEBUG)};if(e(!1),this.runtimeVars.debugLogging.value&&e(this.runtimeVars.debugLogging.value),this.runtimeVars.debugLogging.onChange.subscribe(e),this.config.debugGameState&&(this.runtimeVars.debugGameState.value=this.config.debugGameState),se.DevToolsApi.registerVar("debug_game_state",this.runtimeVars.debugGameState),e=this.config.sentry)try{this.sentry=new je.Sentry,await this.sentry.init(e,this.getVersion())}catch(e){console.error(e)}}loadGameResConfig(g){var P=g.getItem(ce.StorageKey.GameRes);if(P){let g=new me.GameResConfig(this.config.gameresBaseUrl??"");return g.unserialize(P),g.isCdn()&&!g.getCdnBaseUrl()?void 0:g}}async handleGameResLoadError(g,P,I=!1){let L=new fe.BasicErrorBoxApi(this.viewport,P,this.rootEl),_=P.get("ts:import_load_files_failed");g instanceof we.ChecksumError?_+="\n\n"+P.get("ts:import_checksum_mismatch",g.file):g instanceof Te.FileNotFoundError?_+="\n\n"+P.get("ts:import_file_not_found",g.file):g instanceof ee.DownloadError||g.message?.match(/XHR error|Failed to fetch/i)?_+="\n\n"+P.get("ts:downloadfailed"):g instanceof Ee.NoStorageError?_+="\n\n"+P.get("ts:import_no_storage"):g.message?.match(/out of memory|allocation/i)?_+="\n\n"+P.get("ts:gameinitoom"):"QuotaExceededError"===g.name||g instanceof Re.StorageQuotaError?_+="\n\n"+P.get("ts:storage_quota_exceeded"):g instanceof Ie.IOError?(_+="\n\n"+P.get("ts:storage_io_error"),I=!0):g instanceof Be.FileNotFoundError||this.sentry?.captureException(new Error(`Game res load failed (${g.message??g.name})`,{cause:g})),await L.show(_,I)}async handleGameResImportError(g,P){let I=new fe.BasicErrorBoxApi(this.viewport,P,this.rootEl),L=P.get("ts:import_failed");g instanceof Te.FileNotFoundError?L+="\n\n"+P.get("ts:import_file_not_found",g.file):g instanceof be.InvalidArchiveError?L+="\n\n"+P.get("ts:import_invalid_archive"):g instanceof Se.ArchiveExtractionError?g.cause?.message?.match(/out of memory|allocation/i)?L+="\n\n"+P.get("ts:import_out_of_memory"):(L+="\n\n"+P.get("ts:import_archive_extract_failed"),this.sentry?.captureException(new Error(`Game res import failed (${g.message??g.name})`,{cause:g}))):g instanceof De.NoWebAssemblyError?L+="\n\n"+P.get("ts:import_no_web_assembly"):g instanceof we.ChecksumError?L+="\n\n"+P.get("ts:import_checksum_mismatch",g.file):g instanceof ee.DownloadError||g.message?.match(/XHR error|Failed to fetch|CompileError: WebAssembly|SystemJS|NetworkError|Load failed/i)?L+="\n\n"+P.get("ts:downloadfailed"):g instanceof ve.ArchiveDownloadError?L=P.get("ts:import_archive_download_failed",g.url):g instanceof Ee.NoStorageError?L+="\n\n"+P.get("ts:import_no_storage"):g.message?.match(/out of memory|allocation/i)||g.name.match(/NS_ERROR_FAILURE|NS_ERROR_OUT_OF_MEMORY/)?L+="\n\n"+P.get("ts:import_out_of_memory"):"QuotaExceededError"===g.name||g instanceof Re.StorageQuotaError?L+="\n\n"+P.get("ts:storage_quota_exceeded"):g instanceof Ie.IOError||g instanceof Be.FileNotFoundError||"AbortError"===g.name||this.sentry?.captureException(new Error("Game res import failed "+(g.message??g.name),{cause:g})),await I.show(L)}async loadGpuBenchmarkData(){let g=!1;var P=await L.getGPUTier({override:{loadBenchmarks:async P=>{let I=new _.CancellationTokenSource;var L=setTimeout(()=>I.cancel(),5e3);try{let g=await new ee.ResourceLoader("").loadJson("https://unpkg.com/detect-gpu@5.0.42/dist/benchmarks/"+P,I.token);return g.shift(),g}catch(L){throw g=!0,L}finally{clearTimeout(L)}}}});return g?void 0:P}async migrateReplayStorage(g,P,I){var L,_=await U.Engine.getReplayDir();_&&(L=new Ae.ReplayStorageFileSystem(_,this.sentry),await new Me.ReplayStorageMigration(P,I,_,g,L).migrate())}initRouting(){let g,P=new q.Routing;P.addRoute("*",async()=>{g&&await g.destroy()}),P.addRoute("/",async()=>{var P=new ge.ServerRegions;this.gui=await this.initGui(P,this.strings),g=this}),P.addRoute("/game",async P=>{let I=new ge.ServerRegions;if(this.gui=await this.initGui(I,this.strings),this.gui){let q=this.gui.getRootController();if(g=this,await J.sleep(1e3),1<P.length)throw new Error("Unsupported number of URL parameters");var L=W.WolConnection.factory(re.AppLogger.get("net")),_=Fe.WolConfig.factory(Fe.ClientType.Cdral2);let $=new ke.WolService(_,L,this.getVersion(),this.locale);I.load(await $.loadServerList(this.config.serversUrl));var U,G=(U=this.localPrefs.getItem(ce.StorageKey.PreferredServerRegion))&&I.isAvailable(U)?I.get(U):I.getFirstAvailable();I.setSelectedRegion(G.id);var{gameId:V,gameTimestamp:K,gservUrl:_,playerName:L,gameOpts:U,tournament:G=!1}=Ne.RouteHelper.extractGameParams(P[0]);U?(U=(new z.Parser).parseOptions(U),q.createGame(V,K,_,L,U,!1,G)):q.joinGame(V,K,_,L,G)}}),P.addRoute("/replay",async P=>{g=this;var[I]=P;let L;if(void 0!==I){let g=decodeURIComponent(I);L=g.match(/^https?:\/\//i)?{replayUrl:g}:{replayId:I}}I=new ge.ServerRegions,this.gui=await this.initGui(I,this.strings,L)}),P.addRoute("/lobbytest",async()=>{if(!U.Engine.vfs)throw new Error("Original game files must be provided.");$.LobbyFormTester.main(this.rootEl,this.strings),g=$.LobbyFormTester}),P.addRoute("/vxltest",async()=>{if(!U.Engine.vfs)throw new Error("Original game files must be provided.");Q.VxlTester.main(U.Engine.vfs,this.runtimeVars),g=Q.VxlTester}),P.addRoute("/shptest",async()=>{if(!U.Engine.vfs)throw new Error("Original game files must be provided.");var P=new Ce.MapFile(U.Engine.vfs.openFile("mp03t4.map"));Y.ShpTester.main(U.Engine.vfs,P,this.rootEl,this.strings),g=Y.ShpTester}),P.addRoute("/buildtest",async()=>{if(!U.Engine.vfs)throw new Error("Original game files must be provided.");Z.BuildingTester.main(this.runtimeVars),g=Z.BuildingTester}),P.addRoute("/vehicletest",async()=>{if(!U.Engine.vfs)throw new Error("Original game files must be provided.");ae.VehicleTester.main(this.runtimeVars),g=ae.VehicleTester}),P.addRoute("/airtest",async()=>{if(!U.Engine.vfs)throw new Error("Original game files must be provided.");oe.AircraftTester.main(this.runtimeVars),g=oe.AircraftTester}),P.addRoute("/inftest",async()=>{if(!U.Engine.vfs)throw new Error("Original game files must be provided.");ne.InfantryTester.main(this.runtimeVars),g=ne.InfantryTester}),P.addRoute("/soundtest",async()=>{if(!U.Engine.vfs)throw new Error("Original game files must be provided.");le.SoundTester.main(U.Engine.vfs,this.runtimeVars),g=le.SoundTester}),P.init()}async initGui(g,P,I){var L=this.localPrefs.getItem(ce.StorageKey.Options);let _;if(L)try{_=(new pe.GeneralOptions).unserialize(L)}catch(g){console.warn("Couldn't read options from local storage",[g])}_||(_=new pe.GeneralOptions,_.graphics.resolution.value={width:this.config.viewport.width,height:this.config.viewport.height}),this.setPreferredViewportSize(_.graphics.resolution.value),_.graphics.resolution.onChange.subscribe(g=>{this.setPreferredViewportSize(g)});let U=new Pe.Gui(this.getVersion(),this.locale,this.getEngineVersion(),this.getEngineModHash(),this.gpuTier,this.config,this.gameResConfig,ie.resPath,this.localPrefs,_,this.rootEl,this.viewport,this.fullScreen,P,this.cdnResourceLoader,this.fsAccessLib,g,this.runtimeVars,this.sentry);try{await U.init(I)}catch(g){let I;return console.error("Failed to initialize GUI",[g]),g instanceof Re.StorageQuotaError||g instanceof Ie.IOError||g instanceof Be.FileNotFoundError?I=P.get("TS:GUIInitFSError"):(I=P.get("TS:GUIInitUnknownError"),this.sentry?.captureException(new Error(`Failed to initialize GUI (${g.name})`,{cause:g}))),void alert(I)}return U}setPreferredViewportSize(g){this.config.viewport.width=g?.width??Number.POSITIVE_INFINITY,this.config.viewport.height=g?.height??Number.POSITIVE_INFINITY,this.updateViewportSize(this.fullScreen.isFullScreen())}onFullScreenChange(g){navigator.keyboard&&(g?navigator.keyboard.lock(["Escape",...this.config.devMode?[]:["F5","F12"],"F11"])?.catch?.(g=>console.warn("Keyboard lock failed",g)):navigator.keyboard.unlock())}updateViewportSize(g){let P,I;I=g?(P=window.innerWidth,window.innerHeight):(P=Math.min(window.innerWidth,this.config.viewport.width),Math.min(window.innerHeight,this.config.viewport.height)),P=Math.max(800,P-P%2),I=Math.max(600,I-I%2),this.setViewportSize(P,I),this.splashScreen?.setSize(P,I)}setViewportSize(g,P){this.viewport.value={x:this.viewport.value.x,y:this.viewport.value.y,width:g,height:P}}async destroy(){await(this.gui?.destroy()),this.gui=void 0,this.splashScreen&&(this.splashScreen.destroy(),this.splashScreen=void 0)}}),_e.resPath="res/"}}}),System.register("automation/AiAutomationBridge",["automation/AutomationRegistry","automation/AutomationTypes"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class{constructor(){this.registry=new I.AutomationRegistry,this.readyState={appReady:!1,menuReady:!1,gameReady:!1},this.application=void 0,this.gui=void 0,this.rootController=void 0,this.mainMenuScreen=void 0,this.clickTargets=new Map,this.eventQueue=[],this.maxEventQueueSize=500,this.eventSourceGame=void 0,this.eventUnsubscribe=void 0,this.registerCommands()}registerApplication(g){return this.application=g,this.refreshReadyState(),this.getReadyState()}registerGuiContext({gui:g,rootController:P,mainMenuScreen:I}={}){return this.gui=g||this.gui,this.rootController=P||this.rootController,this.mainMenuScreen=I||this.mainMenuScreen,this.refreshReadyState(),this.getReadyState()}async invoke(g,P){return this.refreshReadyState(),this.registry.invoke(g,P,this)}registerCommands(){this.registry.register("system.ping",()=>({pong:!0,now:Date.now()})),this.registry.register("system.listCommands",()=>({commands:this.registry.list()})),this.registry.register("ready.getState",({context:g})=>g.getReadyState()),this.registry.register("ready.waitFor",async({params:g,context:P})=>{var I=g.state,_="number"==typeof g.timeoutMs?g.timeoutMs:3e4,U="number"==typeof g.pollIntervalMs?g.pollIntervalMs:100;if(!Object.values(L.ReadyStateKey).includes(I))throw new L.AutomationError(L.AutomationErrorCode.InvalidArg,`Unsupported ready state "${I}"`,{allowedStates:Object.values(L.ReadyStateKey)});return await P.waitForReadyState(I,_,U),P.getReadyState()}),this.registry.register("ui.listClickable",({params:g,context:P})=>{var I="string"==typeof g.scope?g.scope:"auto";return{scope:I,items:P.collectClickableTargets(I)}}),this.registry.register("ui.requireClickable",({params:g,context:P})=>{var I="string"==typeof g.scope?g.scope:"auto",_=P.collectClickableTargets(I);let U;if("string"==typeof g.id&&g.id.length?U=_.find(P=>P.id===g.id):"string"==typeof g.text&&g.text.length?U=_.find(P=>P.label?.includes(g.text)):"number"==typeof g.index&&(U=_[g.index]),!U)throw new L.AutomationError(L.AutomationErrorCode.NotFound,"Required clickable target not found",{scope:I,id:g.id,text:g.text,index:g.index});return U}),this.registry.register("ui.click",async({params:g,context:P})=>{var I="string"==typeof g.scope?g.scope:"auto";let _=P.collectClickableTargets(I);var U="boolean"==typeof g.force&&g.force;let G;if("string"==typeof g.id&&g.id.length)G=P.clickTargets.get(g.id);else if("string"==typeof g.text&&g.text.length)G=[...P.clickTargets.values()].find(P=>P.label?.includes(g.text));else if("number"==typeof g.index){var V=_[g.index];V&&(G=P.clickTargets.get(V.id))}if(!G)throw new L.AutomationError(L.AutomationErrorCode.NotFound,"Clickable target not found",{id:g.id,text:g.text,index:g.index,scope:I});if(G.disabled&&!U)throw new L.AutomationError(L.AutomationErrorCode.ActionFailed,`Target "${G.id}" is disabled`);return await Promise.resolve(G.handler()),P.refreshReadyState(),{clicked:!0,id:G.id,scope:G.scope,label:G.label}}),this.registry.register("ui.snapshot",({params:g,context:P})=>{var I="string"==typeof g.scope?g.scope:"auto";return{ready:P.getReadyState(),currentScreen:P.getCurrentScreenName(),clickables:P.collectClickableTargets(I)}}),this.registry.register("ui.clickAt",({params:g})=>{var P=Number(g.x),I=Number(g.y),_=Number.isFinite(g.button)?Number(g.button):0;if(!Number.isFinite(P)||!Number.isFinite(I))throw new L.AutomationError(L.AutomationErrorCode.InvalidArg,"ui.clickAt requires numeric x/y");var U=document.elementFromPoint(P,I);if(!U)throw new L.AutomationError(L.AutomationErrorCode.NotFound,`No element found at (${P}, ${I})`);let G={bubbles:!0,cancelable:!0,clientX:P,clientY:I,button:_};return U.dispatchEvent(new MouseEvent("mousedown",G)),U.dispatchEvent(new MouseEvent("mouseup",G)),U.dispatchEvent(new MouseEvent("click",G)),{clicked:!0,x:P,y:I,tagName:U.tagName,className:U.className||""}}),this.registry.register("ui.type",({params:g})=>{if("string"!=typeof g.selector||!g.selector.length)throw new L.AutomationError(L.AutomationErrorCode.InvalidArg,'"selector" is required');var P=document.querySelector(g.selector);if(!P)throw new L.AutomationError(L.AutomationErrorCode.NotFound,`Selector "${g.selector}" not found`);var I="string"==typeof g.value?g.value:String(g.value??"");return P.focus?.(),!1!==g.clear&&"value"in P&&(P.value=""),"value"in P?P.value=I:P.textContent=I,P.dispatchEvent(new Event("input",{bubbles:!0})),P.dispatchEvent(new Event("change",{bubbles:!0})),{typed:!0,selector:g.selector,valueLength:I.length}}),this.registry.register("game.startSkirmish",async({params:g,context:P})=>await P.startSkirmish(g)),this.registry.register("game.getState",({context:g})=>g.getGameState()),this.registry.register("game.getPlayers",({context:g})=>({players:g.getGamePlayers()})),this.registry.register("game.getMapInfo",({context:g})=>{var P=g.getGame(!0).map.tiles.getMapSize();return{width:P.width,height:P.height}}),this.registry.register("game.getUnits",({params:g,context:P})=>P.getUnits(g)),this.registry.register("game.getUnitData",async({params:g,context:P})=>await P.getUnitData(g)),this.registry.register("game.spawnUnit",async({params:g,context:P})=>await P.spawnUnit(g)),this.registry.register("game.orderMove",async({params:g,context:P})=>await P.orderMove(g)),this.registry.register("game.orderAttack",async({params:g,context:P})=>await P.orderAttack(g)),this.registry.register("game.executeKeyCommand",({params:g})=>{if("string"!=typeof g.command&&"number"!=typeof g.command)throw new L.AutomationError(L.AutomationErrorCode.InvalidArg,'"command" is required');var P=window.CdApi?.battleControl;if(!P)throw new L.AutomationError(L.AutomationErrorCode.NotReady,"CdApi battleControl is not ready");return P.executeKeyCommand(g.command),{executed:!0,command:g.command}}),this.registry.register("game.pollEvents",({params:g,context:P})=>{var I="number"==typeof g.limit?Math.max(1,Math.floor(g.limit)):50;I=Math.min(I,P.eventQueue.length);let L=P.eventQueue.slice(0,I);return!1!==g.clear&&P.eventQueue.splice(0,I),{events:L,remaining:P.eventQueue.length}}),this.registry.register("assert.true",({params:g})=>{if(!g.value)throw new L.AutomationError(L.AutomationErrorCode.AssertionFailed,g.message||"Expected truthy value");return{passed:!0}}),this.registry.register("assert.equal",({params:g})=>{if(g.actual!==g.expected)throw new L.AutomationError(L.AutomationErrorCode.AssertionFailed,g.message||"Expected values to be equal",{actual:g.actual,expected:g.expected});return{passed:!0}}),this.registry.register("assert.contains",({params:g})=>{var P=g.container,I=g.value;if("string"==typeof P){if(!P.includes(String(I)))throw new L.AutomationError(L.AutomationErrorCode.AssertionFailed,g.message||"Expected string to contain value",{container:P,value:I})}else if(!Array.isArray(P)||!P.includes(I))throw new L.AutomationError(L.AutomationErrorCode.AssertionFailed,g.message||"Expected array to contain value",{container:P,value:I});return{passed:!0}}),this.registry.register("assert.range",({params:g})=>{var P=Number(g.value),I=Number(g.min),_=Number(g.max);if(!Number.isFinite(P)||!Number.isFinite(I)||!Number.isFinite(_))throw new L.AutomationError(L.AutomationErrorCode.InvalidArg,"assert.range expects numeric value/min/max");if(P<I||P>_)throw new L.AutomationError(L.AutomationErrorCode.AssertionFailed,g.message||"Expected value in range",{value:P,min:I,max:_});return{passed:!0}})}getRootController(){return this.rootController||this.gui?.getRootController?.()||this.application?.gui?.getRootController?.()}getCurrentRootScreen(){return this.getRootController()?.getCurrentScreen?.()}getCurrentScreenName(){var g=this.getCurrentRootScreen();if(!g)return"none";if(g.mainMenuCtrl){var P=g.mainMenuCtrl.getCurrentScreen?.();if(P)return P.constructor?.name||"MainMenuScreen"}return g.constructor?.name||"unknown"}getMainMenuController(){return this.getCurrentRootScreen()?.mainMenuCtrl||this.mainMenuScreen?.mainMenuCtrl||void 0}getGameScreen(g=!1){var P=this.getCurrentRootScreen();if(P?.game)return P;if(g)throw new L.AutomationError(L.AutomationErrorCode.NotReady,"Game screen is not ready")}getGame(g=!0){return this.getGameScreen(g)?.game}getLocalPlayerName(g){return g?.playerName}getLocalPlayer(g,P=!0){var I=this.getLocalPlayerName(g);if(I){var _=g.game?.getPlayerByName?.(I);if(_)return _}if(P)throw new L.AutomationError(L.AutomationErrorCode.NotReady,"Local player is not available")}refreshReadyState(){this.readyState.appReady=!!(this.application||this.gui||this.getRootController()),this.readyState.menuReady=!!this.getMainMenuController(),this.readyState.gameReady=!!this.getGame(!1),this.refreshGameEventSubscription()}getReadyState(){return this.refreshReadyState(),{...this.readyState}}async waitForReadyState(g,P,I){for(var _=Date.now();;){if(this.refreshReadyState(),this.readyState[g])return;if(Date.now()-_>=P)throw new L.AutomationError(L.AutomationErrorCode.Timeout,`Timed out waiting for ready state "${g}"`,{timeoutMs:P});await this.sleep(I)}}sleep(g){return new Promise(P=>setTimeout(P,g))}normalizeIdPart(g){return String(g||"item").toLowerCase().replace(/[^\w]+/g,"_").replace(/^_+|_+$/g,"")||"item"}extractDomBounds(g){if(g?.getBoundingClientRect){let P=g.getBoundingClientRect();return{x:Math.round(P.x),y:Math.round(P.y),width:Math.round(P.width),height:Math.round(P.height)}}}extractSpriteBounds(g){if(g?.getPosition&&g?.getSize){var P=g.getPosition(),I=g.getSize();return{x:Math.round(P.x),y:Math.round(P.y),width:Math.round(I.width),height:Math.round(I.height)}}}collectClickableTargets(g="auto"){this.clickTargets.clear();let P=[];var I="auto"===g||"all"===g?["menu","hud"]:[g];return I.includes("menu")&&this.collectMenuClickables(P),I.includes("hud")&&this.collectHudClickables(P),P.sort((g,P)=>g.id.localeCompare(P.id))}collectMenuClickables(g){var P=this.getMainMenuController();if(P?.mainMenu){var I=P.mainMenu,L=Array.isArray(I.sidebarButtonConfigs)?I.sidebarButtonConfigs:[],_=Array.isArray(I.sidebarButtons)?I.sidebarButtons:[];L.forEach((P,L)=>{if(P?.label){var U=`menu.sidebar.${this.normalizeIdPart(P.label)}.${L}`,G=_[L]?.getElement?.()?.getElement?.(),V={id:U,scope:"menu",label:P.label,tooltip:P.tooltip||"",disabled:!!P.disabled,bounds:this.extractDomBounds(G)};this.clickTargets.set(U,{...V,handler:()=>I.onSidebarButtonClick(L)}),g.push(V)}})}}collectHudClickables(g){var P=this.getGameScreen(!1),I=P?.hud;I&&(this.collectHudButton(g,"hud.button.repair",I.repairButton,"Repair","hud"),this.collectHudButton(g,"hud.button.sell",I.sellButton,"Sell","hud"),Array.isArray(I.commandBarButtons)&&I.commandBarButtons.forEach((P,I)=>{var L=P?.props?.tooltip||`command_${I}`,_=`hud.command.${I}.${this.normalizeIdPart(L)}`;this.collectHudButton(g,_,P,L,"hud")}))}collectHudButton(g,P,I,L,_){if(I?.props?.onClick){var U={id:P,scope:_,label:L||P,tooltip:I.props.tooltip||"",disabled:!!I.disabled,bounds:this.extractSpriteBounds(I.sprite)};this.clickTargets.set(P,{...U,handler:()=>I.props.onClick()}),g.push(U)}}refreshGameEventSubscription(){var g=this.getGame(!1);if(!g)return this.eventSourceGame=void 0,this.eventUnsubscribe&&(this.eventUnsubscribe(),this.eventUnsubscribe=void 0),void(this.eventQueue.length=0);this.eventSourceGame!==g&&(this.eventSourceGame=g,this.eventUnsubscribe&&(this.eventUnsubscribe(),this.eventUnsubscribe=void 0),this.eventUnsubscribe=g.events.subscribe(P=>{this.pushGameEvent(P,g)}))}pushGameEvent(g,P){let I={type:g.type,tick:P.currentTick,timeMs:P.currentTime};g.target&&(I.targetId=g.target.id,I.targetName=g.target.name),g.gameObject&&(I.gameObjectId=g.gameObject.id,I.gameObjectName=g.gameObject.name),g.source&&(I.sourceId=g.source.id),g.prevOwner&&(I.prevOwner=g.prevOwner.name),g.attackerInfo&&(I.attacker={player:g.attackerInfo.player?.name,objId:g.attackerInfo.obj?.id,weapon:g.attackerInfo.weapon?.rules?.name}),this.eventQueue.push(I),this.eventQueue.length>this.maxEventQueueSize&&this.eventQueue.splice(0,this.eventQueue.length-this.maxEventQueueSize)}getGameState(){var g=this.getGameScreen(!0),P=g.game,I=P.getNonNeutralPlayers().map(g=>g.name),L=this.getLocalPlayer(g,!1);return{tick:P.currentTick,timeMs:P.currentTime,playerName:g.playerName,isObserver:!!L?.isObserver,players:I,gameStatus:P.status}}getGamePlayers(){return this.getGame(!0).getNonNeutralPlayers().map(g=>({name:g.name,isObserver:!!g.isObserver,isAi:!!g.isAi,isDefeated:!!g.defeated}))}getUnits(g={}){var P=this.getGame(!0);let I;if(g.playerName){var _=P.getPlayerByName(g.playerName);if(!_)throw new L.AutomationError(L.AutomationErrorCode.NotFound,`Player "${g.playerName}" not found`);I=_.getOwnedObjects()}else I=P.getWorld().getAllObjects();return{unitIds:I.filter(g=>g.isTechno()).map(g=>g.id)}}async getUnitData({unitId:g}={}){if("number"!=typeof g)throw new L.AutomationError(L.AutomationErrorCode.InvalidArg,'"unitId" must be a number');var P=this.getGame(!0),{GameApi:I}=await SystemJS.import("game/api/GameApi"),_=new I(P,!0).getUnitData(g);if(!_)throw new L.AutomationError(L.AutomationErrorCode.NotFound,`Unit ${g} not found`);return _}async spawnUnit({playerName:g,unitName:P,type:I,x:_,y:U}={}){if("string"!=typeof g||"string"!=typeof P||"string"!=typeof I||"number"!=typeof _||"number"!=typeof U)throw new L.AutomationError(L.AutomationErrorCode.InvalidArg,"spawnUnit requires playerName, unitName, type, x, y");var G=this.getGame(!0),V=G.getPlayerByName(g);if(!V)throw new L.AutomationError(L.AutomationErrorCode.NotFound,`Player "${g}" not found`);var{ObjectType:W}=await SystemJS.import("engine/type/ObjectType"),z={infantry:W.Infantry,vehicle:W.Vehicle,aircraft:W.Aircraft},K=z[I.toLowerCase()];if(void 0===K)throw new L.AutomationError(L.AutomationErrorCode.InvalidArg,`Unsupported unit type "${I}"`,{allowed:Object.keys(z)});var q=G.map.tiles.getByMapCoords(_,U);if(!q)throw new L.AutomationError(L.AutomationErrorCode.NotFound,`Tile (${_}, ${U}) not found`);if(!(I=G.rules.getObject(P,K)))throw new L.AutomationError(L.AutomationErrorCode.NotFound,`Unit rules "${P}" not found`);var $=G.createUnitForPlayer(I,V);return G.spawnObject($,q),{unitId:$.id}}async orderMove({playerName:g,unitIds:P,x:I,y:_,queue:U=!1,force:G=!1}={}){if("string"!=typeof g||!Array.isArray(P)||"number"!=typeof I||"number"!=typeof _)throw new L.AutomationError(L.AutomationErrorCode.InvalidArg,"orderMove requires playerName, unitIds, x, y");var V=this.getGame(!0),W=V.getPlayerByName(g);if(!W)throw new L.AutomationError(L.AutomationErrorCode.NotFound,`Player "${g}" not found`);var z=V.map.tiles.getByMapCoords(I,_);if(!z)throw new L.AutomationError(L.AutomationErrorCode.NotFound,`Tile (${I}, ${_}) not found`);I=V.createTarget(void 0,z);var{UnitSelectionLite:K}=await SystemJS.import("game/gameobject/selection/UnitSelectionLite"),{MoveOrder:q}=await SystemJS.import("game/order/MoveOrder"),$=new K(W);let Q=0;for(let g of P){var Y=V.getObjectById(g);if(Y?.isUnit()){var Z=new q(V,V.map,$,!!G);Z.set(Y,I),Z.isValid()&&Z.isAllowed()&&(Y.unitOrderTrait.addOrder(Z,!!U),Q++)}}return{movedCount:Q}}async orderAttack({playerName:g,unitIds:P,targetId:I,x:_,y:U,queue:G=!1,force:V=!1,allowIvanBomb:W=!0}={}){if("string"!=typeof g||!Array.isArray(P))throw new L.AutomationError(L.AutomationErrorCode.InvalidArg,"orderAttack requires playerName and unitIds");if("number"!=typeof I&&("number"!=typeof _||"number"!=typeof U))throw new L.AutomationError(L.AutomationErrorCode.InvalidArg,"orderAttack requires targetId or x/y");var z=this.getGame(!0);if(!z.getPlayerByName(g))throw new L.AutomationError(L.AutomationErrorCode.NotFound,`Player "${g}" not found`);let K,q;if("number"==typeof I){if(K=z.getObjectById(I),!K)throw new L.AutomationError(L.AutomationErrorCode.NotFound,`Target object ${I} not found`);q=z.createTarget(K,K.tile)}else{K=void 0;var $=z.map.tiles.getByMapCoords(_,U);if(!$)throw new L.AutomationError(L.AutomationErrorCode.NotFound,`Tile (${_}, ${U}) not found`);q=z.createTarget(void 0,$)}var{AttackOrder:Q}=await SystemJS.import("game/order/AttackOrder");let Y=0;for(let g of P){var Z=z.getObjectById(g);if(Z?.isUnit()){var X=new Q(z,{forceAttack:!!V,noIvanBomb:!W});X.set(Z,q),X.isValid()&&X.isAllowed()&&(Z.unitOrderTrait.addOrder(X,!!G),Y++)}}return{attackedCount:Y,targetId:K?.id}}async startSkirmish(g={}){this.refreshReadyState();var P=this.getRootController();if(!P?.createGame)throw new L.AutomationError(L.AutomationErrorCode.NotReady,"RootController is not ready");let I="string"==typeof g.map?g.map:"mp01t4.map";var{Engine:_}=await SystemJS.import("engine/Engine"),U=this.getMapVirtualFile(_,I),{MapFile:G}=await SystemJS.import("data/MapFile"),{MapDigest:V}=await SystemJS.import("engine/MapDigest"),W=await U,z=new G(W),K=Math.max(2,Math.min(8,z.startingLocations?.length||8)),q=z.getSection("Basic")?.getString?.("Name")||I,$="string"==typeof g.playerName?g.playerName:"Player 1",Q=!0===g.observer,Y=Math.max(Q?2:1,Math.min(7,"number"==typeof g.aiCount?Math.floor(g.aiCount):1)),Z="number"==typeof g.aiDifficulty?g.aiDifficulty:1,X=new Set,J=new Set,ee=new Array(9).fill(null),v=(g,P)=>{if("number"==typeof g&&0<=g&&!X.has(g))return X.add(g),g;for(let g=0;g<8;g++)if(!X.has(g))return X.add(g),g;return P},b=(g,P)=>{if("number"==typeof g&&0<=g&&g<K&&!J.has(g))return J.add(g),g;for(let g=0;g<K;g++)if(!J.has(g))return J.add(g),g;return P};let te,re,se;if(Q?(te=-3,re=-2,se=-2):(te="number"==typeof g.playerCountry&&0<=g.playerCountry?g.playerCountry:0,re=v(g.playerColor,0),se=b(g.playerStartPos,0)),Array.isArray(g.ai)&&g.ai.length)g.ai.forEach((g,P)=>{var I=P+1;I<K&&(ee[I]={difficulty:"number"==typeof g.difficulty?g.difficulty:Z,countryId:"number"==typeof g.country&&0<=g.country?g.country:I%9,colorId:v(g.color,I%8),startPos:b(g.startPos,I),teamId:"number"==typeof g.team?g.team:-2})});else for(let g=1;g<=Y&&g<K;g++)ee[g]={difficulty:Z,countryId:g%9,colorId:v(-1,g%8),startPos:b(-1,g),teamId:-2};let ae={gameMode:"number"==typeof g.gameMode?g.gameMode:1,shortGame:!1!==g.shortGame,mcvRepacks:!1!==g.mcvRepacks,superWeapons:!1!==g.superWeapons,credits:"number"==typeof g.credits?g.credits:1e4,unitCount:"number"==typeof g.unitCount?g.unitCount:0,gameSpeed:"number"==typeof g.gameSpeed?g.gameSpeed:6,techLevel:"number"==typeof g.techLevel?g.techLevel:10,cratesAppear:!0===g.cratesAppear,destroyableBridges:!1!==g.destroyableBridges,multiEngineer:!0===g.multiEngineer,buildOffAlly:!0===g.buildOffAlly,noDogEngiKills:!0===g.noDogEngiKills,mapName:I,mapDigest:V.compute(W),mapSizeBytes:W.getSize(),mapTitle:q,maxSlots:K,mapOfficial:!0,humanPlayers:[{name:$,countryId:te,colorId:re,startPos:se,teamId:"number"==typeof g.playerTeam?g.playerTeam:-2}],aiPlayers:ee},ne="skirmish-"+Date.now(),oe=Date.now();return P.createGame(ne,oe,void 0,$,ae,!0,!1,!1,!1),{gameId:ne,map:I,mapTitle:q}}async getMapVirtualFile(g,P){if(g.vfs?.fileExists?.(P))return g.vfs.openFile(P);var I=await g.getMapDir().catch(()=>{});if(I&&await I.containsEntry(P))return await I.openFile(P,!0);throw new L.AutomationError(L.AutomationErrorCode.NotFound,`Map "${P}" was not found`)}},(U="undefined"!=typeof window?window:globalThis).__RA2WEB_AUTOMATION__||(U.__RA2WEB_AUTOMATION__=new _),g("AiAutomationBridge",_),g("getAutomationBridge",function(){return U.__RA2WEB_AUTOMATION__}),g("initAiAutomationBridge",function(){return U.__RA2WEB_AUTOMATION__})}}}),System.register("automation/AutomationRegistry",["automation/AutomationTypes"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("AutomationRegistry",class{constructor(){this.commands=new Map}register(g,P,L={}){if("string"!=typeof g||!g.trim())throw new I.AutomationError(I.AutomationErrorCode.InvalidArg,"Command name must be a non-empty string");if("function"!=typeof P)throw new I.AutomationError(I.AutomationErrorCode.InvalidArg,`Handler for command "${g}" must be a function`);this.commands.set(g,{handler:P,meta:{timeoutMs:"number"==typeof L.timeoutMs?L.timeoutMs:1e4}})}unregister(g){this.commands.delete(g)}has(g){return this.commands.has(g)}list(){return[...this.commands.keys()].sort()}async invoke(g,P,L){var _=Date.now(),U=this.commands.get(g);if(!U)return I.createFailureResult(new I.AutomationError(I.AutomationErrorCode.NotFound,`Unknown command "${g}"`),_);try{P=I.expectObjectArg(P,"params");let G=await Promise.resolve(U.handler({command:g,params:P,context:L,meta:U.meta}));return I.createSuccessResult(G,_)}catch(g){return I.createFailureResult(I.toAutomationError(g),_)}}})}}}),System.register("automation/AutomationTypes",[],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[],execute:function(){g("AutomationErrorCode",I=Object.freeze({NotReady:"E_NOT_READY",Timeout:"E_TIMEOUT",NotFound:"E_NOT_FOUND",InvalidArg:"E_INVALID_ARG",ActionFailed:"E_ACTION_FAILED",AssertionFailed:"E_ASSERTION_FAILED"})),g("ReadyStateKey",Object.freeze({AppReady:"appReady",MenuReady:"menuReady",GameReady:"gameReady"})),g("AutomationError",L=class extends Error{constructor(g,P,I){super(P),this.name="AutomationError",this.code=g,this.details=I}}),g("isAutomationError",g=>g instanceof L||!!g&&"AutomationError"===g.name&&"string"==typeof g.code),g("toAutomationError",_=(g,P=I.ActionFailed,_)=>{if(g instanceof L)return g;var U="string"==typeof g?g:g?.message||"Unexpected automation error",G=_;return G||(G=g instanceof Error?{name:g.name,stack:g.stack}:void 0),new L(P,U,G)}),g("createResponseTiming",U=(g,P=Date.now())=>({startedAt:g,elapsedMs:Math.max(0,P-g)})),g("createSuccessResult",(g,P)=>({ok:!0,result:void 0===g?null:g,error:null,timing:U(P)})),g("createFailureResult",(g,P)=>{var I=_(g);return{ok:!1,result:null,error:{code:I.code,message:I.message,details:I.details},timing:U(P)}}),g("expectObjectArg",(g,P="params")=>{if(void 0===g)return{};if(null!==g&&"object"==typeof g&&!Array.isArray(g))return g;throw new L(I.InvalidArg,`"${P}" must be an object`,{receivedType:Array.isArray(g)?"array":typeof g})})}}}),System.register("BattleControlApi",[],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[],execute:function(){g("BattleControlApi",class{constructor(){I.set(this,new Set),L.set(this,void 0)}_setWorldInteraction(g){__classPrivateFieldSet(this,L,g,"f")}_notifyToggle(g){for(var P of __classPrivateFieldGet(this,I,"f"))try{P(g)}catch(g){console.error(g)}}onToggle(g){return __classPrivateFieldGet(this,I,"f").add(g),()=>{__classPrivateFieldGet(this,I,"f").delete(g)}}requestPan(g,P){var I=new THREE.Vector2(g,P);__classPrivateFieldGet(this,L,"f")?.customScrollHandler.requestScroll(I)}cancelPan(){__classPrivateFieldGet(this,L,"f")?.customScrollHandler.cancel()}executeKeyCommand(g){__classPrivateFieldGet(this,L,"f")?.keyboardHandler.executeCommand(g)}applyKeyModifiers(g){__classPrivateFieldGet(this,L,"f")?.applyKeyModifiers(g)}virtualTap(g,P,I=!1){return!!__classPrivateFieldGet(this,L,"f")?.virtualTap?.(g,P,!!I)}}),I=new WeakMap,L=new WeakMap}}}),System.register("ClientApi",["BattleControlApi"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("ClientApi",class{constructor(){this.battleControl=new I.BattleControlApi}})}}}),System.register("Config",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("Config",class{constructor(){this.corsProxies=[]}load(g){let P=g.getSection("General");if(!P)throw new Error("Missing [General] section in application config");this.generalData=P,this.viewport={width:P.getNumber("viewport.width"),height:P.getNumber("viewport.height")};let I=g.getSection("Sentry");I&&(this.sentry={dsn:I.getString("dsn"),env:I.getString("env"),defaultIntegrations:I.getBool("defaultIntegrations"),lazyLoad:I.getBool("lazyLoad",!0)});var L=g.getSection("CorsProxy");if(L)for(var[_,U]of L.entries)this.corsProxies.push([_,U])}get defaultLocale(){return this.generalData.getString("defaultLanguage","en-US")}get serversUrl(){return this.generalData.getString("serversUrl","servers.ini")}get gameresBaseUrl(){return this.generalData.getString("gameresBaseUrl")||void 0}get musicBaseUrl(){var g=this.generalData.getString("musicBaseUrl");if(g.length)return g}get autoLoadGameRes(){return this.generalData.getBool("autoLoadGameRes")}get gameResArchiveUrl(){return this.generalData.getString("gameResArchiveUrl")}get mapsBaseUrl(){return this.generalData.getString("mapsBaseUrl")}get modsBaseUrl(){return this.generalData.getString("modsBaseUrl")}get devMode(){return this.generalData.getBool("dev")}get discordUrl(){var g=this.generalData.getString("discordUrl");if(g.length)return g}get patchNotesUrl(){var g=this.generalData.getString("patchNotesUrl");if(g.length)return g}get ladderRulesUrl(){var g=this.generalData.getString("ladderRulesUrl");if(g.length)return g}get modSdkUrl(){var g=this.generalData.getString("modSdkUrl");if(g.length)return g}get donateUrl(){var g=this.generalData.getString("donateUrl");if(g.length)return g}get replaysUrlWhitelist(){return this.generalData.getArray("replaysUrlWhitelist")}get breakingNewsUrl(){var g=this.generalData.getString("breakingNewsUrl");if(g.length)return g}get quickMatchEnabled(){return this.generalData.getBool("quickMatchEnabled")}get unrankedQueueEnabled(){return this.generalData.getBool("unrankedQueueEnabled",!0)}get botsEnabled(){return this.generalData.getBool("botsEnabled")}get oldClientsBaseUrl(){var g=this.generalData.getString("oldClientsBaseUrl");if(g.length)return g}get debugGameState(){return this.generalData.getBool("debugGameState")}get debugLogging(){var g=this.generalData.getString("debugLogging")||void 0;return g?this.generalData.getBool("debugLogging")||g:void 0}getCorsProxy(g){let P;for(var[I,L]of this.corsProxies){if(I.startsWith(".")?g.endsWith(I):g===I)return L;"*"===I&&(P=L)}return P}})}}}),System.register("ConsoleVars",["util/BoxedVar"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("ConsoleVars",class{constructor(){this.debugWireframes=new I.BoxedVar(!1),this.debugPaths=new I.BoxedVar(!1),this.debugText=new I.BoxedVar(!1),this.debugBotIndex=new I.BoxedVar(0),this.debugLogging=new I.BoxedVar(!1),this.debugGameState=new I.BoxedVar(!1),this.forceResolution=new I.BoxedVar(void 0),this.freeCamera=new I.BoxedVar(!1),this.fps=new I.BoxedVar(!1),this.persistentHoverTags=new I.BoxedVar(!1),this.cheatsEnabled=new I.BoxedVar(!1),this.fullScreenZoomOut=new I.BoxedVar(1.3)}})}}}),System.register("data/AudioBagFile",["data/DataStream","data/vfs/VirtualFile"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("AudioBagFile",class{constructor(){this.fileData=new Map}fromVirtualFile(g,P){var I,L;for([I,L]of P.entries){var _=this.buildWavData(g.stream,L);this.fileData.set(I,_)}return this}getFileList(){return[...this.fileData.keys()]}containsFile(g){return this.fileData.has(g)}openFile(g){if(!this.containsFile(g))throw new Error(`File "${g}" not found`);return new L.VirtualFile(this.fileData.get(g),g)}buildWavData(g,P){let L=new I.DataStream;var _,U,G,V,W=0<(1&P.flags)?2:1;let z=0;0<(2&P.flags)?(L.writeString("RIFF"),L.writeUint32(P.length+36),L.writeString("WAVE"),L.writeString("fmt "),L.writeInt32(16),L.writeInt16(1),L.writeInt16(W),L.writeUint32(P.sampleRate),L.writeUint32(2*W*P.sampleRate),L.writeInt16(2*W),L.writeInt16(16),L.writeString("data"),L.writeUint32(P.length)):0<(8&P.flags)&&(_=11100*W*(P.sampleRate/22050|0),U=P.chunkSize,G=1017*(V=Math.max(2,Math.ceil(P.length/U))),z=(V*=U)-P.length,L.writeString("RIFF"),L.writeUint32(52+V),L.writeString("WAVE"),L.writeString("fmt "),L.writeUint32(20),L.writeInt16(17),L.writeInt16(W),L.writeUint32(P.sampleRate),L.writeInt32(_),L.writeInt16(U),L.writeInt16(4),L.writeInt16(2),L.writeInt16(1017),L.writeString("fact"),L.writeUint32(4),L.writeInt32(G),L.writeString("data"),L.writeUint32(V)),g.seek(P.offset),L.writeUint8Array(g.readUint8Array(P.length));for(let g=0;g<z;g++)L.writeUint8(0);return L.seek(0),L._trimAlloc=()=>{},L}})}}}),System.register("data/Bitmap",[],function(g,P){"use strict";var I,L,_;function d(g){switch(g){case I.Indexed:return 1;case I.Rgb:return 3;case I.Rgba:return 4;default:throw new Error("Unsupported pixel format "+g)}}return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("PixelFormat",I={}))[P.Rgb=1]="Rgb",P[P.Rgba=2]="Rgba",P[P.Indexed=3]="Indexed",g("Bitmap",L=class{constructor(g,P,L,_=I.Rgba){var U=d(_);this.data=L||new Uint8Array(U*g*P),this.pixelFormat=_,this.width=g,this.height=P}drawIndexedImage(g,P,I){var L=d(this.pixelFormat);const _=this.data;var U=this.width,G=L*U,V=L*U*this.height;let W=0+G*I+L*P,z=0;for(let P=0;P<g.height;P++){for(let P=0;P<g.width;P++){var K=g.data[z];0!==K&&0<=W&&W<V&&(_[W]=K,3<=L&&(_[W+1]=0,_[W+2]=0),4===L&&(_[W+3]=255)),W+=L,z++}W+=G-g.width*L}}}),_=class extends L{constructor(g,P,L){super(g,P,L,I.Indexed)}},g("IndexedBitmap",_),_=class extends L{constructor(g,P,L){super(g,P,L,I.Rgb)}},g("RgbBitmap",_),_=class extends L{constructor(g,P,L){super(g,P,L,I.Rgba)}drawRgbaImage(g,P,I){const L=this.data;var _=this.width,U=4*_,G=4*_*this.height;let V=0+U*I+4*P,W=0;for(let P=0;P<g.height;P++){for(let P=0;P<g.width;P++)0<=V&&V<G&&(L[V]=g.data[W],L[V+1]=g.data[W+1],L[V+2]=g.data[W+2],L[V+3]=g.data[W+3]),V+=4,W+=4;V+=U-4*g.width}}},g("RgbaBitmap",_)}}}),System.register("data/Crc32",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){g("Crc32",I=class r{static calculateCrc(g,P=4294967295){let I=P;for(let P=0,L=g.length;P<L;P++)I=(I>>>8^this.lookUp[255&I^g[P]])>>>0;return I=(I^P)>>>0,I}constructor(g=4294967295){this.polynomal=g,this.crc=g}append(g){for(let P=0,I=g.length;P<I;P++)this.crc=(this.crc>>>8^r.lookUp[255&this.crc^g[P]])>>>0}get(){return(this.crc^this.polynomal)>>>0}}),I.lookUp=new Uint32Array([0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117])}}}),System.register("data/CsfFile",[],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[],execute:function(){var P;I=new Uint32Array(new Uint8Array(Array.prototype.map.call("STRW",g=>g.charCodeAt(0)).reverse()).buffer)[0],L=g=>g.map(g=>~g>>>0),_=g=>{let P="";for(let I=0;I<g.length;I+=2)P+=String.fromCharCode(g[I+1]<<8|g[I]);return P},(P=U||g("CsfLanguage",U={}))[P.EnglishUS=0]="EnglishUS",P[P.EnglishUK=1]="EnglishUK",P[P.German=2]="German",P[P.French=3]="French",P[P.Spanish=4]="Spanish",P[P.Italian=5]="Italian",P[P.Japanese=6]="Japanese",P[P.Jabberwockie=7]="Jabberwockie",P[P.Korean=8]="Korean",P[P.Unknown=9]="Unknown",P[P.ChineseCN=100]="ChineseCN",P[P.ChineseTW=101]="ChineseTW",g("csfLocaleMap",G=(new Map).set(U.EnglishUS,"en-US").set(U.EnglishUK,"en-GB").set(U.German,"de-DE").set(U.French,"fr-FR").set(U.Spanish,"es-ES").set(U.Italian,"it-IT").set(U.Japanese,"ja-JP").set(U.Korean,"ko-KR").set(U.ChineseCN,"zh-CN").set(U.ChineseTW,"zh-TW")),g("CsfFile",class{constructor(g){this.language=U.Unknown,this.data={},g&&this.fromVirtualFile(g)}fromVirtualFile(g){let P=g.stream;P.readInt32(),P.readInt32();var G=P.readInt32();P.readInt32(),P.readInt32(),this.language=P.readInt32();for(let g=0;g<G;g++){P.readInt32();var V,W=P.readInt32(),z=P.readString(P.readInt32());1&W?(V=P.readInt32()===I,W=L(P.readUint8Array(2*P.readInt32())),W=_(W),V&&P.readString(P.readInt32()),this.data[z]=W):this.data[z]=""}this.language===U.Unknown&&this.autoDetectLocale()}autoDetectLocale(){switch(this.data["THEME:Intro"]){case"":this.language=U.ChineseTW;break;case"":this.language=U.ChineseCN}}getIsoLocale(){return G.get(this.language)}})}}}),System.register("data/DataStream",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){g("DataStream",I=class n{constructor(g,P,I=n.LITTLE_ENDIAN){this.endianness=I,this.position=0,this._dynamicSize=!0,this._byteLength=0,this._byteOffset=P||0,g instanceof ArrayBuffer?this.buffer=g:"object"==typeof g?(this.dataView=g,P&&(this._byteOffset+=P)):this.buffer=new ArrayBuffer(g||0)}get dynamicSize(){return this._dynamicSize}set dynamicSize(g){g||this._trimAlloc(),this._dynamicSize=g}get byteLength(){return this._byteLength-this._byteOffset}get buffer(){return this._trimAlloc(),this._buffer}set buffer(g){this._buffer=g,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}get byteOffset(){return this._byteOffset}set byteOffset(g){this._byteOffset=g,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}get dataView(){return this._dataView}set dataView(g){this._byteOffset=g.byteOffset,this._buffer=g.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+g.byteLength}bigEndian(){return this.endianness=n.BIG_ENDIAN,this}_realloc(g){if(this._dynamicSize){var P=this._byteOffset+this.position+g;let _=this._buffer.byteLength;if(P<=_)P>this._byteLength&&(this._byteLength=P);else{for(_<1&&(_=1);P>_;)_*=2;var I=new ArrayBuffer(_),L=new Uint8Array(this._buffer);new Uint8Array(I,0,L.length).set(L),this.buffer=I,this._byteLength=P}}}_trimAlloc(){if(this._byteLength!==this._buffer.byteLength){var g=new ArrayBuffer(this._byteLength);const I=new Uint8Array(g);var P=new Uint8Array(this._buffer,0,I.length);I.set(P),this.buffer=g}}seek(g){var P=Math.max(0,Math.min(this.byteLength,g));this.position=isNaN(P)||!isFinite(P)?0:P}isEof(){return this.position>=this.byteLength}mapInt32Array(g,P){this._realloc(4*g);var I=new Int32Array(this._buffer,this.byteOffset+this.position,g);return n.arrayToNative(I,void 0===P?this.endianness:P),this.position+=4*g,I}mapInt16Array(g,P){this._realloc(2*g);var I=new Int16Array(this._buffer,this.byteOffset+this.position,g);return n.arrayToNative(I,void 0===P?this.endianness:P),this.position+=2*g,I}mapInt8Array(g){this._realloc(g);var P=new Int8Array(this._buffer,this.byteOffset+this.position,g);return this.position+=g,P}mapUint32Array(g,P){this._realloc(4*g);var I=new Uint32Array(this._buffer,this.byteOffset+this.position,g);return n.arrayToNative(I,void 0===P?this.endianness:P),this.position+=4*g,I}mapUint16Array(g,P){this._realloc(2*g);var I=new Uint16Array(this._buffer,this.byteOffset+this.position,g);return n.arrayToNative(I,void 0===P?this.endianness:P),this.position+=2*g,I}mapUint8Array(g){this._realloc(g);var P=new Uint8Array(this._buffer,this.byteOffset+this.position,g);return this.position+=g,P}mapFloat64Array(g,P){this._realloc(8*g);var I=new Float64Array(this._buffer,this.byteOffset+this.position,g);return n.arrayToNative(I,void 0===P?this.endianness:P),this.position+=8*g,I}mapFloat32Array(g,P){this._realloc(4*g);var I=new Float32Array(this._buffer,this.byteOffset+this.position,g);return n.arrayToNative(I,void 0===P?this.endianness:P),this.position+=4*g,I}readInt32Array(g,P){g=void 0===g?this.byteLength-this.position/4:g;var I=new Int32Array(g);return n.memcpy(I.buffer,0,this.buffer,this.byteOffset+this.position,g*I.BYTES_PER_ELEMENT),n.arrayToNative(I,void 0===P?this.endianness:P),this.position+=I.byteLength,I}readInt16Array(g,P){g=void 0===g?this.byteLength-this.position/2:g;var I=new Int16Array(g);return n.memcpy(I.buffer,0,this.buffer,this.byteOffset+this.position,g*I.BYTES_PER_ELEMENT),n.arrayToNative(I,void 0===P?this.endianness:P),this.position+=I.byteLength,I}readInt8Array(g){g=void 0===g?this.byteLength-this.position:g;var P=new Int8Array(g);return n.memcpy(P.buffer,0,this.buffer,this.byteOffset+this.position,g*P.BYTES_PER_ELEMENT),this.position+=P.byteLength,P}readUint32Array(g,P){g=void 0===g?this.byteLength-this.position/4:g;var I=new Uint32Array(g);return n.memcpy(I.buffer,0,this.buffer,this.byteOffset+this.position,g*I.BYTES_PER_ELEMENT),n.arrayToNative(I,void 0===P?this.endianness:P),this.position+=I.byteLength,I}readUint16Array(g,P){g=void 0===g?this.byteLength-this.position/2:g;var I=new Uint16Array(g);return n.memcpy(I.buffer,0,this.buffer,this.byteOffset+this.position,g*I.BYTES_PER_ELEMENT),n.arrayToNative(I,void 0===P?this.endianness:P),this.position+=I.byteLength,I}readUint8Array(g){g=void 0===g?this.byteLength-this.position:g;var P=new Uint8Array(g);return n.memcpy(P.buffer,0,this.buffer,this.byteOffset+this.position,g*P.BYTES_PER_ELEMENT),this.position+=P.byteLength,P}readFloat64Array(g,P){g=void 0===g?this.byteLength-this.position/8:g;var I=new Float64Array(g);return n.memcpy(I.buffer,0,this.buffer,this.byteOffset+this.position,g*I.BYTES_PER_ELEMENT),n.arrayToNative(I,void 0===P?this.endianness:P),this.position+=I.byteLength,I}readFloat32Array(g,P){g=void 0===g?this.byteLength-this.position/4:g;var I=new Float32Array(g);return n.memcpy(I.buffer,0,this.buffer,this.byteOffset+this.position,g*I.BYTES_PER_ELEMENT),n.arrayToNative(I,void 0===P?this.endianness:P),this.position+=I.byteLength,I}writeInt32Array(g,P){if(this._realloc(4*g.length),g instanceof Int32Array&&(this.byteOffset+this.position)%g.BYTES_PER_ELEMENT==0)n.memcpy(this._buffer,this.byteOffset+this.position,g.buffer,g.byteOffset,g.byteLength),this.mapInt32Array(g.length,P);else for(let I=0;I<g.length;I++)this.writeInt32(g[I],P);return this}writeInt16Array(g,P){if(this._realloc(2*g.length),g instanceof Int16Array&&(this.byteOffset+this.position)%g.BYTES_PER_ELEMENT==0)n.memcpy(this._buffer,this.byteOffset+this.position,g.buffer,g.byteOffset,g.byteLength),this.mapInt16Array(g.length,P);else for(let I=0;I<g.length;I++)this.writeInt16(g[I],P);return this}writeInt8Array(g){if(this._realloc(g.length),g instanceof Int8Array&&(this.byteOffset+this.position)%g.BYTES_PER_ELEMENT==0)n.memcpy(this._buffer,this.byteOffset+this.position,g.buffer,g.byteOffset,g.byteLength),this.mapInt8Array(g.length);else for(let P=0;P<g.length;P++)this.writeInt8(g[P]);return this}writeUint32Array(g,P){if(this._realloc(4*g.length),g instanceof Uint32Array&&(this.byteOffset+this.position)%g.BYTES_PER_ELEMENT==0)n.memcpy(this._buffer,this.byteOffset+this.position,g.buffer,g.byteOffset,g.byteLength),this.mapUint32Array(g.length,P);else for(let I=0;I<g.length;I++)this.writeUint32(g[I],P);return this}writeUint16Array(g,P){if(this._realloc(2*g.length),g instanceof Uint16Array&&(this.byteOffset+this.position)%g.BYTES_PER_ELEMENT==0)n.memcpy(this._buffer,this.byteOffset+this.position,g.buffer,g.byteOffset,g.byteLength),this.mapUint16Array(g.length,P);else for(let I=0;I<g.length;I++)this.writeUint16(g[I],P);return this}writeUint8Array(g){if(this._realloc(g.length),g instanceof Uint8Array&&(this.byteOffset+this.position)%g.BYTES_PER_ELEMENT==0)n.memcpy(this._buffer,this.byteOffset+this.position,g.buffer,g.byteOffset,g.byteLength),this.mapUint8Array(g.length);else for(let P=0;P<g.length;P++)this.writeUint8(g[P]);return this}writeFloat64Array(g,P){if(this._realloc(8*g.length),g instanceof Float64Array&&(this.byteOffset+this.position)%g.BYTES_PER_ELEMENT==0)n.memcpy(this._buffer,this.byteOffset+this.position,g.buffer,g.byteOffset,g.byteLength),this.mapFloat64Array(g.length,P);else for(let I=0;I<g.length;I++)this.writeFloat64(g[I],P);return this}writeFloat32Array(g,P){if(this._realloc(4*g.length),g instanceof Float32Array&&(this.byteOffset+this.position)%g.BYTES_PER_ELEMENT==0)n.memcpy(this._buffer,this.byteOffset+this.position,g.buffer,g.byteOffset,g.byteLength),this.mapFloat32Array(g.length,P);else for(let I=0;I<g.length;I++)this.writeFloat32(g[I],P);return this}readInt32(g){var P=this._dataView.getInt32(this.position,void 0===g?this.endianness:g);return this.position+=4,P}readInt16(g){var P=this._dataView.getInt16(this.position,void 0===g?this.endianness:g);return this.position+=2,P}readInt8(){var g=this._dataView.getInt8(this.position);return this.position+=1,g}readUint32(g){var P=this._dataView.getUint32(this.position,void 0===g?this.endianness:g);return this.position+=4,P}readUint16(g){var P=this._dataView.getUint16(this.position,void 0===g?this.endianness:g);return this.position+=2,P}readUint8(){var g=this._dataView.getUint8(this.position);return this.position+=1,g}readFloat32(g){var P=this._dataView.getFloat32(this.position,void 0===g?this.endianness:g);return this.position+=4,P}readFloat64(g){var P=this._dataView.getFloat64(this.position,void 0===g?this.endianness:g);return this.position+=8,P}writeInt32(g,P){return this._realloc(4),this._dataView.setInt32(this.position,g,void 0===P?this.endianness:P),this.position+=4,this}writeInt16(g,P){return this._realloc(2),this._dataView.setInt16(this.position,g,void 0===P?this.endianness:P),this.position+=2,this}writeInt8(g){return this._realloc(1),this._dataView.setInt8(this.position,g),this.position+=1,this}writeUint32(g,P){return this._realloc(4),this._dataView.setUint32(this.position,g,void 0===P?this.endianness:P),this.position+=4,this}writeUint16(g,P){return this._realloc(2),this._dataView.setUint16(this.position,g,void 0===P?this.endianness:P),this.position+=2,this}writeUint8(g){return this._realloc(1),this._dataView.setUint8(this.position,g),this.position+=1,this}writeFloat32(g,P){return this._realloc(4),this._dataView.setFloat32(this.position,g,void 0===P?this.endianness:P),this.position+=4,this}writeFloat64(g,P){return this._realloc(8),this._dataView.setFloat64(this.position,g,void 0===P?this.endianness:P),this.position+=8,this}static memcpy(g,P,I,L,_){const U=new Uint8Array(g,P,_);var G=new Uint8Array(I,L,_);U.set(G)}static arrayToNative(g,P){return P===this.endianness?g:this.flipArrayEndianness(g)}static nativeToEndian(g,P){return this.endianness===P?g:this.flipArrayEndianness(g)}static flipArrayEndianness(g){const P=new Uint8Array(g.buffer,g.byteOffset,g.byteLength);for(let L=0;L<g.byteLength;L+=g.BYTES_PER_ELEMENT)for(let _=L+g.BYTES_PER_ELEMENT-1,U=L;_>U;_--,U++){var I=P[U];P[U]=P[_],P[_]=I}return g}static createStringFromArray(g){const P=[];for(let I=0;I<g.length;I+=32768)P.push(String.fromCharCode.apply(void 0,g.subarray(I,I+32768)));return P.join("")}readUCS2String(g,P){return n.createStringFromArray(this.readUint16Array(g,P))}writeUCS2String(g,P,I){void 0===I&&(I=g.length);let L=0;for(;L<g.length&&L<I;L++)this.writeUint16(g.charCodeAt(L),P);for(;L<I;L++)this.writeUint16(0);return this}readString(g,P){return void 0===P||"ASCII"===P?n.createStringFromArray(this.mapUint8Array(void 0===g?this.byteLength-this.position:g)):new TextDecoder(P).decode(this.mapUint8Array(g))}writeString(g,P,I){if(void 0===P||"ASCII"===P)if(void 0!==I){let P;var L=Math.min(g.length,I);for(P=0;P<L;P++)this.writeUint8(g.charCodeAt(P));for(;P<I;P++)this.writeUint8(0)}else for(let P=0;P<g.length;P++)this.writeUint8(g.charCodeAt(P));else this.writeUint8Array((new TextEncoder).encode(g.substring(0,I)));return this}writeUtf8WithLen(g){var P=(new TextEncoder).encode(g);return this.writeUint16(P.length).writeUint8Array(P)}readUtf8WithLen(){var g=this.readUint16();return(new TextDecoder).decode(this.mapUint8Array(g))}readCString(g){var P=this.byteLength-this.position,I=new Uint8Array(this._buffer,this._byteOffset+this.position);let L=P;void 0!==g&&(L=Math.min(g,P));let _=0;for(;_<L&&0!==I[_];_++);var U=n.createStringFromArray(this.mapUint8Array(_));return void 0!==g?this.position+=L-_:_!==P&&(this.position+=1),U}writeCString(g,P){if(void 0!==P){let L;var I=Math.min(g.length,P);for(L=0;L<I;L++)this.writeUint8(g.charCodeAt(L));for(;L<P;L++)this.writeUint8(0)}else{for(let P=0;P<g.length;P++)this.writeUint8(g.charCodeAt(P));this.writeUint8(0)}return this}toUint8Array(){return new Uint8Array(this.buffer,this.byteOffset,this.byteLength)}}),I.BIG_ENDIAN=!1,I.LITTLE_ENDIAN=!0,I.endianness=0<new Int8Array(new Int16Array([1]).buffer)[0]}}}),System.register("data/encoding/Blowfish",[],function(g,P){"use strict";function o(g){return((g=(g<<16>>>0|g>>>16)>>>0)<<8>>>0&4278255360|g>>>8&16711935)>>>0}return P&&P.id,{setters:[],execute:function(){g("Blowfish",class{constructor(g){this.m_p=new Uint32Array([608135816,2242054355,320440878,57701188,2752067618,698298832,137296536,3964562569,1160258022,953160567,3193202383,887688300,3232508343,3380367581,1065670069,3041331479,2450970073,2306472731]),this.m_s=[new Uint32Array([3509652390,2564797868,805139163,3491422135,3101798381,1780907670,3128725573,4046225305,614570311,3012652279,134345442,2240740374,1667834072,1901547113,2757295779,4103290238,227898511,1921955416,1904987480,2182433518,2069144605,3260701109,2620446009,720527379,3318853667,677414384,3393288472,3101374703,2390351024,1614419982,1822297739,2954791486,3608508353,3174124327,2024746970,1432378464,3864339955,2857741204,1464375394,1676153920,1439316330,715854006,3033291828,289532110,2706671279,2087905683,3018724369,1668267050,732546397,1947742710,3462151702,2609353502,2950085171,1814351708,2050118529,680887927,999245976,1800124847,3300911131,1713906067,1641548236,4213287313,1216130144,1575780402,4018429277,3917837745,3693486850,3949271944,596196993,3549867205,258830323,2213823033,772490370,2760122372,1774776394,2652871518,566650946,4142492826,1728879713,2882767088,1783734482,3629395816,2517608232,2874225571,1861159788,326777828,3124490320,2130389656,2716951837,967770486,1724537150,2185432712,2364442137,1164943284,2105845187,998989502,3765401048,2244026483,1075463327,1455516326,1322494562,910128902,469688178,1117454909,936433444,3490320968,3675253459,1240580251,122909385,2157517691,634681816,4142456567,3825094682,3061402683,2540495037,79693498,3249098678,1084186820,1583128258,426386531,1761308591,1047286709,322548459,995290223,1845252383,2603652396,3431023940,2942221577,3202600964,3727903485,1712269319,422464435,3234572375,1170764815,3523960633,3117677531,1434042557,442511882,3600875718,1076654713,1738483198,4213154764,2393238008,3677496056,1014306527,4251020053,793779912,2902807211,842905082,4246964064,1395751752,1040244610,2656851899,3396308128,445077038,3742853595,3577915638,679411651,2892444358,2354009459,1767581616,3150600392,3791627101,3102740896,284835224,4246832056,1258075500,768725851,2589189241,3069724005,3532540348,1274779536,3789419226,2764799539,1660621633,3471099624,4011903706,913787905,3497959166,737222580,2514213453,2928710040,3937242737,1804850592,3499020752,2949064160,2386320175,2390070455,2415321851,4061277028,2290661394,2416832540,1336762016,1754252060,3520065937,3014181293,791618072,3188594551,3933548030,2332172193,3852520463,3043980520,413987798,3465142937,3030929376,4245938359,2093235073,3534596313,375366246,2157278981,2479649556,555357303,3870105701,2008414854,3344188149,4221384143,3956125452,2067696032,3594591187,2921233993,2428461,544322398,577241275,1471733935,610547355,4027169054,1432588573,1507829418,2025931657,3646575487,545086370,48609733,2200306550,1653985193,298326376,1316178497,3007786442,2064951626,458293330,2589141269,3591329599,3164325604,727753846,2179363840,146436021,1461446943,4069977195,705550613,3059967265,3887724982,4281599278,3313849956,1404054877,2845806497,146425753,1854211946]),new Uint32Array([1266315497,3048417604,3681880366,3289982499,290971e4,1235738493,2632868024,2414719590,3970600049,1771706367,1449415276,3266420449,422970021,1963543593,2690192192,3826793022,1062508698,1531092325,1804592342,2583117782,2714934279,4024971509,1294809318,4028980673,1289560198,2221992742,1669523910,35572830,157838143,1052438473,1016535060,1802137761,1753167236,1386275462,3080475397,2857371447,1040679964,2145300060,2390574316,1461121720,2956646967,4031777805,4028374788,33600511,2920084762,1018524850,629373528,3691585981,3515945977,2091462646,2486323059,586499841,988145025,935516892,3367335476,2599673255,2839830854,265290510,3972581182,2759138881,3795373465,1005194799,847297441,406762289,1314163512,1332590856,1866599683,4127851711,750260880,613907577,1450815602,3165620655,3734664991,3650291728,3012275730,3704569646,1427272223,778793252,1343938022,2676280711,2052605720,1946737175,3164576444,3914038668,3967478842,3682934266,1661551462,3294938066,4011595847,840292616,3712170807,616741398,312560963,711312465,1351876610,322626781,1910503582,271666773,2175563734,1594956187,70604529,3617834859,1007753275,1495573769,4069517037,2549218298,2663038764,504708206,2263041392,3941167025,2249088522,1514023603,1998579484,1312622330,694541497,2582060303,2151582166,1382467621,776784248,2618340202,3323268794,2497899128,2784771155,503983604,4076293799,907881277,423175695,432175456,1378068232,4145222326,3954048622,3938656102,3820766613,2793130115,2977904593,26017576,3274890735,3194772133,1700274565,1756076034,4006520079,3677328699,720338349,1533947780,354530856,688349552,3973924725,1637815568,332179504,3949051286,53804574,2852348879,3044236432,1282449977,3583942155,3416972820,4006381244,1617046695,2628476075,3002303598,1686838959,431878346,2686675385,1700445008,1080580658,1009431731,832498133,3223435511,2605976345,2271191193,2516031870,1648197032,4164389018,2548247927,300782431,375919233,238389289,3353747414,2531188641,2019080857,1475708069,455242339,2609103871,448939670,3451063019,1395535956,2413381860,1841049896,1491858159,885456874,4264095073,4001119347,1565136089,3898914787,1108368660,540939232,1173283510,2745871338,3681308437,4207628240,3343053890,4016749493,1699691293,1103962373,3625875870,2256883143,3830138730,1031889488,3479347698,1535977030,4236805024,3251091107,2132092099,1774941330,1199868427,1452454533,157007616,2904115357,342012276,595725824,1480756522,206960106,497939518,591360097,863170706,2375253569,3596610801,1814182875,2094937945,3421402208,1082520231,3463918190,2785509508,435703966,3908032597,1641649973,2842273706,3305899714,1510255612,2148256476,2655287854,3276092548,4258621189,236887753,3681803219,274041037,1734335097,3815195456,3317970021,1899903192,1026095262,4050517792,356393447,2410691914,3873677099,3682840055]),new Uint32Array([3913112168,2491498743,4132185628,2489919796,1091903735,1979897079,3170134830,3567386728,3557303409,857797738,1136121015,1342202287,507115054,2535736646,337727348,3213592640,1301675037,2528481711,1895095763,1721773893,3216771564,62756741,2142006736,835421444,2531993523,1442658625,3659876326,2882144922,676362277,1392781812,170690266,3921047035,1759253602,3611846912,1745797284,664899054,1329594018,3901205900,3045908486,2062866102,2865634940,3543621612,3464012697,1080764994,553557557,3656615353,3996768171,991055499,499776247,1265440854,648242737,3940784050,980351604,3713745714,1749149687,3396870395,4211799374,3640570775,1161844396,3125318951,1431517754,545492359,4268468663,3499529547,1437099964,2702547544,3433638243,2581715763,2787789398,1060185593,1593081372,2418618748,4260947970,69676912,2159744348,86519011,2512459080,3838209314,1220612927,3339683548,133810670,1090789135,1078426020,1569222167,845107691,3583754449,4072456591,1091646820,628848692,1613405280,3757631651,526609435,236106946,48312990,2942717905,3402727701,1797494240,859738849,992217954,4005476642,2243076622,3870952857,3732016268,765654824,3490871365,2511836413,1685915746,3888969200,1414112111,2273134842,3281911079,4080962846,172450625,2569994100,980381355,4109958455,2819808352,2716589560,2568741196,3681446669,3329971472,1835478071,660984891,3704678404,4045999559,3422617507,3040415634,1762651403,1719377915,3470491036,2693910283,3642056355,3138596744,1364962596,2073328063,1983633131,926494387,3423689081,2150032023,4096667949,1749200295,3328846651,309677260,2016342300,1779581495,3079819751,111262694,1274766160,443224088,298511866,1025883608,3806446537,1145181785,168956806,3641502830,3584813610,1689216846,3666258015,3200248200,1692713982,2646376535,4042768518,1618508792,1610833997,3523052358,4130873264,2001055236,3610705100,2202168115,4028541809,2961195399,1006657119,2006996926,3186142756,1430667929,3210227297,1314452623,4074634658,4101304120,2273951170,1399257539,3367210612,3027628629,1190975929,2062231137,2333990788,2221543033,2438960610,1181637006,548689776,2362791313,3372408396,3104550113,3145860560,296247880,1970579870,3078560182,3769228297,1714227617,3291629107,3898220290,166772364,1251581989,493813264,448347421,195405023,2709975567,677966185,3703036547,1463355134,2715995803,1338867538,1343315457,2802222074,2684532164,233230375,2599980071,2000651841,3277868038,1638401717,4028070440,3237316320,6314154,819756386,300326615,590932579,1405279636,3267499572,3150704214,2428286686,3959192993,3461946742,1862657033,1266418056,963775037,2089974820,2263052895,1917689273,448879540,3550394620,3981727096,150775221,3627908307,1303187396,508620638,2975983352,2726630617,1817252668,1876281319,1457606340,908771278,3720792119,3617206836,2455994898,1729034894,1080033504]),new Uint32Array([976866871,3556439503,2881648439,1522871579,1555064734,1336096578,3548522304,2579274686,3574697629,3205460757,3593280638,3338716283,3079412587,564236357,2993598910,1781952180,1464380207,3163844217,3332601554,1699332808,1393555694,1183702653,3581086237,1288719814,691649499,2847557200,2895455976,3193889540,2717570544,1781354906,1676643554,2592534050,3230253752,1126444790,2770207658,2633158820,2210423226,2615765581,2414155088,3127139286,673620729,2805611233,1269405062,4015350505,3341807571,4149409754,1057255273,2012875353,2162469141,2276492801,2601117357,993977747,3918593370,2654263191,753973209,36408145,2530585658,25011837,3520020182,2088578344,530523599,2918365339,1524020338,1518925132,3760827505,3759777254,1202760957,3985898139,3906192525,674977740,4174734889,2031300136,2019492241,3983892565,4153806404,3822280332,352677332,2297720250,60907813,90501309,3286998549,1016092578,2535922412,2839152426,457141659,509813237,4120667899,652014361,1966332200,2975202805,55981186,2327461051,676427537,3255491064,2882294119,3433927263,1307055953,942726286,933058658,2468411793,3933900994,4215176142,1361170020,2001714738,2830558078,3274259782,1222529897,1679025792,2729314320,3714953764,1770335741,151462246,3013232138,1682292957,1483529935,471910574,1539241949,458788160,3436315007,1807016891,3718408830,978976581,1043663428,3165965781,1927990952,4200891579,2372276910,3208408903,3533431907,1412390302,2931980059,4132332400,1947078029,3881505623,4168226417,2941484381,1077988104,1320477388,886195818,18198404,3786409e3,2509781533,112762804,3463356488,1866414978,891333506,18488651,661792760,1628790961,3885187036,3141171499,876946877,2693282273,1372485963,791857591,2686433993,3759982718,3167212022,3472953795,2716379847,445679433,3561995674,3504004811,3574258232,54117162,3331405415,2381918588,3769707343,4154350007,1140177722,4074052095,668550556,3214352940,367459370,261225585,2610173221,4209349473,3468074219,3265815641,314222801,3066103646,3808782860,282218597,3406013506,3773591054,379116347,1285071038,846784868,2669647154,3771962079,3550491691,2305946142,453669953,1268987020,3317592352,3279303384,3744833421,2610507566,3859509063,266596637,3847019092,517658769,3462560207,3443424879,370717030,4247526661,2224018117,4143653529,4112773975,2788324899,2477274417,1456262402,2901442914,1517677493,1846949527,2295493580,3734397586,2176403920,1280348187,1908823572,3871786941,846861322,1172426758,3287448474,3383383037,1655181056,3139813346,901632758,1897031941,2986607138,3066810236,3447102507,1393639104,373351379,950779232,625454576,3124240540,4148612726,2007998917,544563296,2244738638,2330496472,2058025392,1291430526,424198748,50039436,29584100,3605783033,2429876329,2791104160,1057563949,3255363231,3075367218,3463963227,1469046755,985887462])];for(let U=0,G=0;U<18;++U){var P=g[G++%g.length],I=g[G++%g.length],L=g[G++%g.length],_=g[G++%g.length];this.m_p[U]^=P<<24|I<<16|L<<8|_}let U=0,G=0;for(let g=0;g<18;)[U,G]=this._encrypt(U,G),this.m_p[g++]=U,this.m_p[g++]=G;for(let g=0;g<4;++g)for(let P=0;P<256;)[U,G]=this._encrypt(U,G),this.m_s[g][P++]=U,this.m_s[g][P++]=G}encrypt(g){return this.runCipher(g,this._encrypt.bind(this))}decrypt(g){return this.runCipher(g,this._decrypt.bind(this))}runCipher(g,P){let I=new Uint32Array(g.length),L=g.length/2|0,_=0;for(;0<L--;){var U=o(g[_]),G=o(g[_+1]);[U,G]=P(U,G),I[_++]=o(U),I[_++]=o(G)}return I}_encrypt(g,P){let I=g,L=P;I^=this.m_p[0];let _=!1;for(let g=1;g<=16;g++,_=!_)_?I=this.round(I,L,g):L=this.round(L,I,g);return L^=this.m_p[17],[L,I]}_decrypt(g,P){let I=g,L=P;I^=this.m_p[17];let _=!1;for(let g=16;1<=g;g--,_=!_)_?I=this.round(I,L,g):L=this.round(L,I,g);return L^=this.m_p[0],[L,I]}s(g,P){return this.m_s[P][g>>(3-P<<3)&255]}bf_f(g){return(this.s(g,0)+this.s(g,1)>>>0^this.s(g,2))+this.s(g,3)>>>0}round(g,P,I){return g^this.bf_f(P)^this.m_p[I]}})}}}),System.register("data/encoding/BlowfishKey",[],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[],execute:function(){I="AihRvNoIbTn85FZRYNZRcT+i6KpU+maCsEqr3Q5q+LDB5tH7Tz2qQ38V",L=new Int8Array([-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]),_=class{constructor(){this.key1=new Uint32Array(64),this.key2=new Uint32Array(64)}},g("BlowfishKey",class{constructor(){this.pubkey=new _,this.glob1=new Uint32Array(64),this.glob2=new Uint32Array(130),this.glob1_hi=new Uint32Array(4),this.glob1_hi_inv=new Uint32Array(4)}init_bignum(g,P,I){for(let P=0;P<I;P++)g[P]=0;g[0]=P}move_key_to_big(g,P,I,L){let _;_=128&P[0]?255:0;const U=new Uint8Array(g.buffer,g.byteOffset);let G=4*L;for(;G>I;G--)U[G-1]=_;for(;0<G;G--)U[G-1]=P[I-G]}key_to_bignum(g,P,I){let L,_,U=0;if(2===P[U]){if(U++,128&P[U]){for(L=0,_=0;_<(127&P[U]);_++)L=(L<<8>>>0|P[U+_+1])>>>0;U+=1+(127&P[U])}else L=P[U],U++;L<=4*I&&this.move_key_to_big(g,P.subarray(U),L,I)}}len_bignum(g,P){let I=P-1;for(;0<=I&&0===g[I];)I--;return I+1}bitlen_bignum(g,P){var I;let L,_;if(0===(I=this.len_bignum(g,P)))return 0;for(L=32*I,_=2147483648;0==(_&g[I-1]);)_>>>=1,L--;return L}init_pubkey(){let g,P=0;var _;const U=new Uint8Array(256);for(this.init_bignum(this.pubkey.key2,65537,64),g=0;P<56;)_=(((L[I.charCodeAt(P++)]>>>0<<6>>>0|255&L[I.charCodeAt(P++)])>>>0<<6>>>0|255&L[I.charCodeAt(P++)])>>>0<<6>>>0|255&L[I.charCodeAt(P++)])>>>0,U[g++]=_>>16&255,U[g++]=_>>8&255,U[g++]=255&_;this.key_to_bignum(this.pubkey.key1,U,64),this.pubkey.len=this.bitlen_bignum(this.pubkey.key1,64)-1}len_predata(){var g=(this.pubkey.len-1)/8|0;return(1+(55/g|0))*(1+g)>>>0}cmp_bignum(g,P,I){for(;0<I;){if(g[--I]<P[I])return-1;if(g[I]>P[I])return 1}return 0}mov_bignum(g,P,I){for(let L=0;L<I;L++)g[L]=P[L]}shr_bignum(g,P,I){let L;var _=P/32|0;if(0<_){for(L=0;L<I-_;L++)g[L]=g[L+_];for(;L<I;L++)g[L]=0;P%=32}if(0!==P){for(L=0;L<I-1;L++)g[L]=(g[L]>>>P|g[L+1]<<32-P>>>0)>>>0;g[L]=g[L]>>>P}}shl_bignum(g,P,I){let L;var _=P/32|0;if(0<_){for(L=I-1;L>_;L--)g[L]=g[L-_];for(;0<L;L--)g[L]=0;P%=32}if(0!==P){for(L=I-1;0<L;L--)g[L]=(g[L]<<P>>>0|g[L-1]>>>32-P)>>>0;g[0]=g[0]<<P>>>0}}sub_bignum(g,P,I,L,_){var U,G;_+=_;var V=new Uint16Array(P.buffer,P.byteOffset),W=new Uint16Array(I.buffer,I.byteOffset);const z=new Uint16Array(g.buffer,g.byteOffset);let K=0;for(;-1!=--_;)U=V[K],G=W[K],z[K]=U-G-L&65535,L=U-G-L&65536?1:0,K++;return L}sub_bignum_word(g,P,I,L,_){var U,G;let V=0;for(;-1!=--_;)U=P[V],G=I[V],g[V]=U-G-L&65535,L=U-G-L&65536?1:0,V++;return L}inv_bignum(g,P,I){const L=new Uint32Array(64);var _;let U,G,V=0;for(this.init_bignum(L,0,I),this.init_bignum(g,0,I),G=this.bitlen_bignum(P,I),U=1<<G%32>>>0,V=((G+32)/32|0)-1,L[(_=4*((G-1)/32|0)>>>0)/4|0]=L[_/4|0]|1<<(G-1&31)>>>0;0<G;)G--,this.shl_bignum(L,1,I),-1!==this.cmp_bignum(L,P,I)&&(this.sub_bignum(L,L,P,0,I),g[V]=g[V]|U>>>0),U>>>=1,0===U&&(V--,U=2147483648);this.init_bignum(L,0,I)}inc_bignum(g,P){let I=0;for(;0==++g[I]&&0<--P;)I++}init_two_dw(g,P){this.mov_bignum(this.glob1,g,P),this.glob1_bitlen=this.bitlen_bignum(this.glob1,P),this.glob1_len_x2=(this.glob1_bitlen+15)/16|0,this.mov_bignum(this.glob1_hi,this.glob1.subarray(this.len_bignum(this.glob1,P)-2),2),this.glob1_hi_bitlen=this.bitlen_bignum(this.glob1_hi,2)-32>>>0,this.shr_bignum(this.glob1_hi,this.glob1_hi_bitlen,2),this.inv_bignum(this.glob1_hi_inv,this.glob1_hi,2),this.shr_bignum(this.glob1_hi_inv,1,2),this.glob1_hi_bitlen=(this.glob1_hi_bitlen+15)%16+1>>>0,this.inc_bignum(this.glob1_hi_inv,2),32<this.bitlen_bignum(this.glob1_hi_inv,2)&&(this.shr_bignum(this.glob1_hi_inv,1,2),this.glob1_hi_bitlen--),this.glob1_hi_inv_lo=65535&this.glob1_hi_inv[0],this.glob1_hi_inv_hi=this.glob1_hi_inv[0]>>>16&65535}mul_bignum_word(g,P,I,L){let _,U;var G=new Uint16Array(P.buffer,P.byteOffset);let V=U=0;for(_=0;_<L;_++)U=I*G[V]+g[V]+U,g[V]=65535&U,V++,U>>>=16;g[V]+=65535&U}mul_bignum(g,P,I,L){let _;var U=new Uint16Array(I.buffer,I.byteOffset);let G=new Uint16Array(g.buffer,g.byteOffset);this.init_bignum(g,0,2*L);let V=0;for(_=0;_<2*L;_++)this.mul_bignum_word(G.subarray(V),P,U[V],2*L),V++}not_bignum(g,P){let I;for(I=0;I<P;I++)g[I]=~g[I]>>>0}neg_bignum(g,P){this.not_bignum(g,P),this.inc_bignum(g,P)}get_mulword(g,P){let I=((((65535&(65535^g[P-1]))*this.glob1_hi_inv_lo+65536>>>1)+((65535^g[P-2])*this.glob1_hi_inv_hi+this.glob1_hi_inv_hi>>>1)+1>>>16)+((65535&(65535^g[P-1]))*this.glob1_hi_inv_hi>>>1)+((65535^g[P])*this.glob1_hi_inv_lo>>>1)+1>>>14)+this.glob1_hi_inv_hi*(65535^g[P])*2>>>this.glob1_hi_bitlen>>>0;return 65535<I&&(I=65535),65535&I}dec_bignum(g,P){let I=0;for(;--g[I]>>>0==4294967295&&0<--P;)I++}calc_a_bignum(g,P,I,L){var _;let U;var G=this.glob1,V=this.glob2;if(this.mul_bignum(this.glob2,P,I,L),this.glob2[2*L]=0,(_=2*this.len_bignum(this.glob2,2*L+1))>=this.glob1_len_x2){this.inc_bignum(this.glob2,2*L+1),this.neg_bignum(this.glob2,2*L+1),U=1+_-this.glob1_len_x2;let g=new Uint16Array(V.buffer),P=U,I=1+_;for(;0!==U;U--){I--;var W=this.get_mulword(g,I);P--;var z=g.subarray(P);0<W&&(this.mul_bignum_word(z,this.glob1,W,2*L),!(32768&g[I])&&0!==this.sub_bignum_word(z,z,new Uint16Array(G.buffer),0,2*L)&&g[I]--)}this.neg_bignum(this.glob2,L),this.dec_bignum(this.glob2,L)}this.mov_bignum(g,this.glob2,L)}clear_tmp_vars(g){this.init_bignum(this.glob1,0,g),this.init_bignum(this.glob2,0,g),this.init_bignum(this.glob1_hi_inv,0,4),this.init_bignum(this.glob1_hi,0,4),this.glob1_bitlen=0,this.glob1_hi_bitlen=0,this.glob1_len_x2=0,this.glob1_hi_inv_lo=0,this.glob1_hi_inv_hi=0}calc_a_key(g,P,I,L,_){var U,G=new Uint32Array(64);let V,W,z=0;for(this.init_bignum(g,1,_),U=this.len_bignum(L,_),this.init_two_dw(L,U),V=this.bitlen_bignum(I,U)<<24>>24,W=1<<(V-1)%32>>>1,z+=(((V+31)/32|0)>>>0)-1,V--,this.mov_bignum(g,P,U);-1!=--V;)0===W&&(W=2147483648,z--),this.calc_a_bignum(G,g,g,U),0!=(I[z]&W)?this.calc_a_bignum(g,G,P,U):this.mov_bignum(g,G,U),W>>>=1;this.init_bignum(G,0,U),this.clear_tmp_vars(_)}memcpy(g,P,I){let L=0;for(;0!=I--;)g[L]=P[L],L++}process_predata(g,P,I){var L=new Uint32Array(64),_=new Uint32Array(64);let U=0,G=0;for(var V=(this.pubkey.len-1)/8|0;1+V<=P;)this.init_bignum(L,0,64),this.memcpy(new Uint8Array(L.buffer),g.subarray(U),1+V),this.calc_a_key(_,L,this.pubkey.key2,this.pubkey.key1,64),this.memcpy(I.subarray(G),new Uint8Array(_.buffer),V),P-=1+V,U+=1+V,G+=V}decryptKey(g){this.init_pubkey();let P=new Uint8Array(256);return this.process_predata(g,this.len_predata(),P),P.subarray(0,56)}})}}}),System.register("data/encoding/Format3",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("Format3",class{static decode(g,P,I){let L=new Uint8Array(P*I),_=0,U=0;for(let G=0;G<I;G++){let I=(g[_+1]<<8|g[_])-2;_+=2;let G=0;for(;0<I--;){let V=g[_++];if(0!==V)G++,L[U++]=V;else for(I--,V=g[_++],G+V>P&&(V=P-G&255),G+=V;0!=V--;)L[U++]=0}}return L}})}}}),System.register("data/encoding/Format5",["data/encoding/Format80","data/encoding/MiniLzo"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("Format5",class{static decode(g,P,I=5){var L=new Uint8Array(P);return this.decodeInto(g,L,I),L}static decodeInto(g,P,_=5){var U=P.length;let G=0,V=0;for(;V<U;){var W=g[G+1]<<8|g[G];G+=2;var z=g[G+1]<<8|g[G];if(G+=2,!W||!z)break;let U;U=80===_?I.Format80.decode(g.subarray(G,G+W),z):L.MiniLzo.decompress(g.subarray(G,G+W),z);for(let g=0;g<z;++g)P[V+g]=U[g];G+=W,V+=z}}})}}}),System.register("data/encoding/Format80",["data/DataStream"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("Format80",class{static decode(g,P){var I=new Uint8Array(P);return this.decodeInto(g,I),I}static decodeInto(g,P){let L=new I.DataStream(new DataView(g.buffer,g.byteOffset,g.byteLength)),_=0;for(;;){var U=L.readUint8();if(128&U)if(64&U)if(62==(U&=63))for(var G=L.readInt16(),V=L.readUint8(),W=_+G;_<W;_++)P[_]=V;else if(63==U){G=L.readInt16();let g=L.readInt16();if(g>=_)throw new Error(`srcIndex >= destIndex  ${g}  `+_);for(var z=_+G;_<z;_++)P[_]=P[g++]}else{U=3+U;let g=L.readInt16();if(g>=_)throw new Error(`srcIndex >= destIndex  ${g}  `+_);for(var K=_+U;_<K;_++)P[_]=P[g++]}else{if(0==($=63&U))return _;P.set(L.readUint8Array($),_),_+=$}else{var q=L.readUint8(),$=3+((112&U)>>4);this.replicatePrevious(P,_,_-(((15&U)<<8)+q),$),_+=$}}}static replicatePrevious(g,P,I,L){if(P<I)throw new Error(`srcIndex > destIndex  ${I}  `+P);if(P-I==1)for(let I=0;I<L;I++)g[P+I]=g[P-1];else for(let _=0;_<L;_++)g[P+_]=g[I+_]}})}}}),System.register("data/encoding/MiniLzo",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("MiniLzo",class{static decompress(g,P){var I={inputBuffer:g,outputBuffer:null},L=lzo1x.decompress(I,{outputSize:P});if(0!==L)throw new Error("MiniLzo decode failed with code "+L);return I.outputBuffer}})}}}),System.register("data/hva/Section",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("Section",class{getMatrix(g){return this.matrices[g]}})}}}),System.register("data/HvaFile",["data/hva/Section","data/vfs/VirtualFile"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("HvaFile",class{constructor(g){g instanceof L.VirtualFile&&this.fromVirtualFile(g)}fromVirtualFile(g){this.filename=g.filename;let P=g.stream;this.sections=[],P.readCString(16);var L=P.readInt32(),_=P.readInt32();for(let g=0;g<_;++g){let g=new I.Section;g.name=P.readCString(16),g.matrices=new Array(L),this.sections.push(g)}for(let g=0;g<L;++g)for(let I=0;I<_;++I)this.sections[I].matrices[g]=this.readMatrix(P)}readMatrix(g){let P=[];for(let I=0;I<3;++I)P.push(g.readFloat32(),g.readFloat32(),g.readFloat32(),g.readFloat32());return P.push(0,0,0,1),(new THREE.Matrix4).fromArray(P).transpose()}})}}}),System.register("data/IdxEntry",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("IdxEntry",class{})}}}),System.register("data/IdxFile",["data/IdxEntry"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("IdxFile",class{constructor(g){this.entries=new Map,this.parse(g)}parse(g){var P=g.readCString(4);if("GABA"!==P)throw new Error(`Unable to load Idx file, did not find magic id, found ${P} instead`);if(2!==(P=g.readInt32()))throw new Error(`Unable to load Idx file, did not find magic number 2, found ${P} instead`);var L=g.readInt32();for(let P=0;P<L;P++){const P=new I.IdxEntry;let L=g.readString(16);var _=L.indexOf("\0");0!==_&&(L=L.substr(0,_)),P.filename=L+".wav",P.offset=g.readUint32(),P.length=g.readUint32(),P.sampleRate=g.readUint32(),P.flags=g.readUint32(),P.chunkSize=g.readUint32(),this.entries.set(P.filename,P)}}})}}}),System.register("data/IniFile",["data/IniSection","data/IniParser","data/vfs/VirtualFile"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("IniFile",class a{constructor(g){this.sections=new Map,g instanceof _.VirtualFile?this.fromVirtualFile(g):"object"==typeof g?this.fromJson(g):"string"==typeof g&&this.fromString(g)}fromVirtualFile(g){return this.fromString(g.readAsString())}fromString(g){return this.fromJson((new L.IniParser).parse(g))}fromJson(g){for(var P in g){var L;g.hasOwnProperty(P)&&(L=new I.IniSection(P).fromJson(g[P]),this.sections.set(P,L))}return this}toString(){let g=[];for(var P of this.sections.values())g.push(P.toString());return g.join("\r\n")}clone(){let g=new a;return this.sections.forEach((P,I)=>{g.sections.set(I,P.clone())}),g}getOrCreateSection(g){let P=this.sections.get(g);return P||(P=new I.IniSection(g),this.sections.set(g,P)),P}getSection(g){return this.sections.get(g)}getOrderedSections(){return[...this.sections.values()]}mergeWith(g){return g.sections.forEach((g,P)=>{this.getOrCreateSection(P).mergeWith(g)}),this}})}}}),System.register("data/IniParser",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("IniParser",class{parse(g){let P,I={},L=I,_=/^\[([^\]]*)\]\s*$|^([^=]+)(=(.*))?$/i;return g.split(/[\r\n]+/g).forEach(g=>{if(g&&!g.match(/^\s*[;#]/)){var U=(g=g.replace(/]\s*(\/\/|;|#).*$/,"]")).match(_);if(U){if(void 0!==U[1])return P=this.unsafe(U[1]),void(L=I[P]=I[P]||{});let g=this.unsafe(U[2]);U=U[3]?this.unsafe(U[4]||""):"",2<g.length&&"[]"===g.slice(-2)&&(g=g.substring(0,g.length-2),L[g]?Array.isArray(L[g])||(L[g]=[L[g]]):L[g]=[]),Array.isArray(L[g])?L[g].push(U):L[g]=U}}}),Object.keys(I).filter(g=>{if(!I[g]||"object"!=typeof I[g]||Array.isArray(I[g]))return!1;let P=this.dotSplit(g),L=I,_=P.pop();var U=_.replace(/\\\./g,".");return P.forEach(function(g){L[g]&&"object"==typeof L[g]||(L[g]={}),L=L[g]}),(L!==I||U!==_)&&(L[U]=I[g],!0)}).forEach(function(g){delete I[g]}),I}dotSplit(g){return g.replace(/\x01/g,"LITERAL\\1LITERAL").replace(/\\\./g,"").split(/\./).map(g=>g.replace(/\x01/g,"\\.").replace(/\x02LITERAL\\1LITERAL\x02/g,""))}isQuoted(g){return'"'===g.charAt(0)&&'"'===g.slice(-1)||"'"===g.charAt(0)&&"'"===g.slice(-1)}unsafe(g){if(g=(g||"").trim(),this.isQuoted(g))return g.substr(1,g.length-2);{let I=!1,L="";for(let _=0,U=g.length;_<U;_++){var P=g.charAt(_);if(I)-1!=="\\;#".indexOf(P)?L+=P:L+="\\"+P,I=!1;else{if(-1!==";#".indexOf(P))break;"\\"===P?I=!0:L+=P}}return I&&(L+="\\"),L=L.trim(),L}}})}}}),System.register("data/IniSection",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("IniSection",class r{constructor(g){this.entries=new Map,this.sections=new Map,this.name=g}fromJson(g){for(var P in g){var I;g.hasOwnProperty(P)&&(I=g[P],Array.isArray(I)||"object"!=typeof I?this.set(P,I):this.sections.set(P,new r(P).fromJson(I)))}return this}clone(){let g=new r(this.name);return this.entries.forEach((P,I)=>{g.set(I,P)}),this.sections.forEach((P,I)=>{g.sections.set(I,P.clone())}),g}set(g,P){this.entries.set(g,P)}get(g){return this.entries.get(g)}has(g){return this.entries.has(g)}getString(g,P=""){var I=this.get(g);return I&&"string"==typeof I?I:P}getNumber(g,P=0){var I=this.get(g);if(!I||"string"!=typeof I)return P;var L=this.parseNumber(I);return void 0===L?(console.warn(`Invalid value for key ${g}. "${I}" is not a valid number or percentage string.`),P):L}parseNumber(g){let P;if(P=g.match(/%$/)?Number(g.replace("%",""))/100:Number(g),!isNaN(P))return P}getFixed(g,P=0){return this.toFixedPointPrecision(this.getNumber(g,P))}toFixedPointPrecision(g){return(65536*g|0)/65536}getBool(g,P=!1){let I=this.getString(g).trim();return I=I&&I.toLowerCase(),!(!I||-1===["yes","1","true","on"].indexOf(I))||(!I||-1===["no","0","false","off"].indexOf(I))&&P}getKeyArray(g,P=[]){var I=this.get(g);return I&&Array.isArray(I)?I:P}getArray(g,P=/,\s*/,I=[]){let L=this.getString(g).trim();return L=L.replace(/,$/,"").replace(/,+/g,","),L?L.split(P):I}getNumberArray(g,P=/,\s*/,I=[]){let L=this.getString(g).trim();if(!L)return I;let _=[];for(var U of L.split(P)){if(!U)return I;var G=this.parseNumber(U);if(void 0===G)return console.warn(`Invalid value for key ${g}. "${U}" is not a valid number or percentage string.`),I;_.push(G)}return _}getFixedArray(g,P=/,\s*/,I=[]){return this.getNumberArray(g,P,I).map(g=>this.toFixedPointPrecision(g))}getEnum(g,P,I,L=!1){let _,U=this.getString(g).trim();if(!U)return I;if(L){var G=Object.getOwnPropertyNames(P).find(g=>g.toLowerCase()===U.toLowerCase());G&&(_=P[G])}else P.hasOwnProperty(U)&&(_=P[U]);return void 0===_?(console.warn(`Invalid value for key "${g}". "${U}" is not an accepted enum value.`),I):_}getEnumNumeric(g,P,I){var L=this.getString(g).trim();if(!L)return I;let _;return Number.isInteger(parseInt(L,10))&&P.hasOwnProperty(L)&&(_=parseInt(L,10)),void 0===_?(console.warn(`Invalid value for key "${g}". "${L}" is not an accepted enum value.`),I):_}getEnumArray(g,P,I=/,\s*/,L=[],_=!1){let U=this.getString(g).trim();if(!U)return L;let G=[];for(let W of U.split(I)){if(!W)return L;let I=!1;if(_){var V=Object.getOwnPropertyNames(P).find(g=>g.toLowerCase()===W.toLowerCase());V&&(G.push(P[V]),I=!0)}else P.hasOwnProperty(W)&&(G.push(P[W]),I=!0);if(!I)return console.warn(`Invalid value "${W}" for key "${g}".`),L}return G}getHighestNumericIndex(){let g,P=0;return this.entries.forEach((I,L)=>{g=parseInt(L,10),g>P&&(P=g)}),P}isNumericIndexArray(){return 0<this.getHighestNumericIndex()||this.has("0")}getConcatenatedValues(){let g="";for(var P of this.entries.values())"string"==typeof P&&(g+=P);return g}toString(g){let P=[],I=(g?g+".":"")+this.name;for(var[L,_]of(P.push(`[${I}]`),this.entries))if(Array.isArray(_))for(var U of _)P.push(L+"[]="+U);else P.push(L+"="+_);return P.push(""),P.join("\r\n")+[...this.sections.values()].map(g=>g.toString(I)).join("\r\n")}mergeWith(g){if(this.isNumericIndexArray()){let P=this.getHighestNumericIndex()+1;g.entries.forEach((g,I)=>{Number.isNaN(Number(I))||Array.isArray(g)||this.set((P++).toString(),g)})}else g.entries.forEach((g,P)=>{this.set(P,Array.isArray(g)?[...g]:g)});g.sections.forEach((g,P)=>{this.getOrCreateSection(P).mergeWith(g)})}getOrCreateSection(g){let P=this.sections.get(g);return P||(P=new r(g),this.sections.set(g,P)),P}getSection(g){return this.sections.get(g)}getOrderedSections(){return[...this.sections.values()]}})}}}),System.register("data/map/MapLighting",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("MapLighting",class{constructor(){this.level=0,this.ambient=1,this.red=1,this.green=1,this.blue=1,this.ground=0,this.forceTint=!1}read(g,P=""){return this.level=g.getNumber(P+"Level",.032),this.ambient=g.getNumber(P+"Ambient",1),this.red=g.getNumber(P+"Red",1),this.green=g.getNumber(P+"Green",1),this.blue=g.getNumber(P+"Blue",1),this.ground=g.getNumber(P+"Ground",0),this}copy(g){return this.level=g.level,this.ambient=g.ambient,this.red=g.red,this.green=g.green,this.blue=g.blue,this.ground=g.ground,this.forceTint=g.forceTint,this}})}}}),System.register("data/map/SpecialFlags",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("SpecialFlags",class{read(g){return this.initialVeteran=g.getBool("InitialVeteran"),this}})}}}),System.register("data/map/tag/CellTag",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("data/map/tag/CellTagsReader",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("CellTagsReader",class{read(g,P){let I=[];for(var[L,_]of g.entries)L={tagId:_,coords:this.readCoords(Number(L),P)},I.push(L);return I}readCoords(g,P){var I=P<4?128:1e3;return{x:g%I,y:Math.floor(g/I)}}})}}}),System.register("data/map/tag/Tag",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("Tag",class{})}}}),System.register("data/map/tag/TagRepeatType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("TagRepeatType",I={}))[P.OnceAny=0]="OnceAny",P[P.OnceAll=1]="OnceAll",P[P.Repeat=2]="Repeat"}}}),System.register("data/map/tag/TagsReader",["data/map/tag/TagRepeatType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("TagsReader",class{read(g){let P=[];for(var[L,_]of g.entries){var U=_.split(",");U.length<3?console.warn(`Invalid tag ${L}=${_}. Skipping.`):(_=Number(U[0]),void 0!==I.TagRepeatType[_]?(U={id:L,repeatType:_,name:U[1],triggerId:U[2]},P.push(U)):console.warn(`Invalid repeat value ${_} for tag id ${L}. Skipping.`))}return P}})}}}),System.register("data/map/trigger/Trigger",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("data/map/trigger/TriggerAction",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("data/map/trigger/TriggerActionType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("TriggerActionType",I={}))[P.NoAction=0]="NoAction",P[P.FireSale=9]="FireSale",P[P.TextTrigger=11]="TextTrigger",P[P.DestroyTrigger=12]="DestroyTrigger",P[P.ChangeHouse=14]="ChangeHouse",P[P.RevealMap=16]="RevealMap",P[P.RevealAroundWaypoint=17]="RevealAroundWaypoint",P[P.PlaySoundFx=19]="PlaySoundFx",P[P.PlaySpeech=21]="PlaySpeech",P[P.ForceTrigger=22]="ForceTrigger",P[P.TimerStart=23]="TimerStart",P[P.TimerStop=24]="TimerStop",P[P.TimerExtend=25]="TimerExtend",P[P.TimerShorten=26]="TimerShorten",P[P.TimerSet=27]="TimerSet",P[P.GlobalSet=28]="GlobalSet",P[P.GlobalClear=29]="GlobalClear",P[P.DestroyObject=32]="DestroyObject",P[P.AddOneTimeSuperWeapon=33]="AddOneTimeSuperWeapon",P[P.AddRepeatingSuperWeapon=34]="AddRepeatingSuperWeapon",P[P.AllChangeHouse=36]="AllChangeHouse",P[P.ResizePlayerView=40]="ResizePlayerView",P[P.PlayAnimAt=41]="PlayAnimAt",P[P.DetonateWarhead=42]="DetonateWarhead",P[P.ReshroudMap=51]="ReshroudMap",P[P.EnableTrigger=53]="EnableTrigger",P[P.DisableTrigger=54]="DisableTrigger",P[P.CreateRadarEvent=55]="CreateRadarEvent",P[P.LocalSet=56]="LocalSet",P[P.LocalClear=57]="LocalClear",P[P.SellBuilding=60]="SellBuilding",P[P.TurnOffBuilding=61]="TurnOffBuilding",P[P.TurnOnBuilding=62]="TurnOnBuilding",P[P.ApplyOneHundredDamage=63]="ApplyOneHundredDamage",P[P.ForceEnd=69]="ForceEnd",P[P.DestroyTag=70]="DestroyTag",P[P.SetAmbientStep=71]="SetAmbientStep",P[P.SetAmbientRate=72]="SetAmbientRate",P[P.SetAmbientLight=73]="SetAmbientLight",P[P.NukeStrike=95]="NukeStrike",P[P.PlaySoundFxAt=99]="PlaySoundFxAt",P[P.UnrevealAroundWaypoint=101]="UnrevealAroundWaypoint",P[P.LightningStrike=102]="LightningStrike",P[P.TimerText=103]="TimerText",P[P.CreateCrate=108]="CreateCrate",P[P.IronCurtainAt=109]="IronCurtainAt",P[P.EvictOccupiers=111]="EvictOccupiers",P[P.Cheer=113]="Cheer",P[P.StopSoundsAt=116]="StopSoundsAt"}}}),System.register("data/map/trigger/TriggerEvent",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("data/map/trigger/TriggerEventType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("TriggerEventType",I={}))[P.NoEvent=0]="NoEvent",P[P.EnteredBy=1]="EnteredBy",P[P.SpiedBy=2]="SpiedBy",P[P.AttackedByAny=6]="AttackedByAny",P[P.DestroyedByAny=7]="DestroyedByAny",P[P.AnyEvent=8]="AnyEvent",P[P.DestroyedAllUnits=9]="DestroyedAllUnits",P[P.DestroyedAllBuildings=10]="DestroyedAllBuildings",P[P.DestroyedAll=11]="DestroyedAll",P[P.CreditsExceed=12]="CreditsExceed",P[P.ElapsedTime=13]="ElapsedTime",P[P.MissionTimerExpired=14]="MissionTimerExpired",P[P.DestroyedBuildings=15]="DestroyedBuildings",P[P.DestroyedUnits=16]="DestroyedUnits",P[P.NoFactoriesLeft=17]="NoFactoriesLeft",P[P.BuildBuilding=19]="BuildBuilding",P[P.BuildUnit=20]="BuildUnit",P[P.BuildInfantry=21]="BuildInfantry",P[P.BuildAircraft=22]="BuildAircraft",P[P.CrossesHorizontalLine=25]="CrossesHorizontalLine",P[P.CrossesVerticalLine=26]="CrossesVerticalLine",P[P.GlobalIsSet=27]="GlobalIsSet",P[P.GlobalIsCleared=28]="GlobalIsCleared",P[P.DestroyedOrCaptured=29]="DestroyedOrCaptured",P[P.LowPower=30]="LowPower",P[P.DestroyedBridge=31]="DestroyedBridge",P[P.BuildingExists=32]="BuildingExists",P[P.ComesNearWaypoint=34]="ComesNearWaypoint",P[P.LocalIsSet=36]="LocalIsSet",P[P.LocalIsCleared=37]="LocalIsCleared",P[P.FirstDamagedCombat=38]="FirstDamagedCombat",P[P.HalfHealthCombat=39]="HalfHealthCombat",P[P.QuarterHealthCombat=40]="QuarterHealthCombat",P[P.FirstDamagedAny=41]="FirstDamagedAny",P[P.HalfHealthAny=42]="HalfHealthAny",P[P.QuarterHealthAny=43]="QuarterHealthAny",P[P.AttackedByHouse=44]="AttackedByHouse",P[P.AmbientLightBelow=45]="AmbientLightBelow",P[P.AmbientLightAbove=46]="AmbientLightAbove",P[P.ElapsedScenarioTime=47]="ElapsedScenarioTime",P[P.DestroyedOrCapturedOrInfiltrated=48]="DestroyedOrCapturedOrInfiltrated",P[P.PickupCrate=49]="PickupCrate",P[P.PickupCrateAny=50]="PickupCrateAny",P[P.RandomDelay=51]="RandomDelay",P[P.CreditsBelow=52]="CreditsBelow",P[P.SpyEnteringAsHouse=53]="SpyEnteringAsHouse",P[P.SpyEnteringAsInfantry=54]="SpyEnteringAsInfantry",P[P.DestroyedAllUnitsNaval=55]="DestroyedAllUnitsNaval",P[P.DestroyedAllUnitsLand=56]="DestroyedAllUnitsLand",P[P.BuildingNotExists=57]="BuildingNotExists"}}}),System.register("data/map/trigger/TriggerReader",["data/map/trigger/TriggerEventType","data/map/trigger/TriggerActionType"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("TriggerReader",class{read(g,P,I,L){let _=this.readTriggers(g),{events:U,unknownEventTypes:G}=this.readEvents(P),{actions:V,unknownActionTypes:W}=this.readActions(I),z=[...L.values()],K=new Set(_);for(let g of _.values()){var q=U.get(g.id);q&&g.events.push(...q),(q=V.get(g.id))&&g.actions.push(...q),!g.attachedTriggerId||(q=_.find(P=>P.id===g.attachedTriggerId))&&(g.attachedTrigger=q,K.delete(q))}for(let g of K){var $=z.find(P=>P.triggerId===g.id);if($){let P=g;for(;P;)P.tag=$,P=P.attachedTrigger}else{let P=g;for(;P;){console.warn(`Trigger ${P.id} has no associated tag or valid root trigger. Skipping.`);var Q=_.indexOf(P);-1!==Q&&_.splice(Q,1),P=P.attachedTrigger}}}return{triggers:_,unknownEventTypes:G,unknownActionTypes:W}}readTriggers(g){let P=[];for(var[I,L]of g.entries){var _=L.split(",");_.length<8?console.warn(`Invalid trigger ${I}=${L}. Skipping.`):(_={id:I,houseName:_[0],attachedTriggerId:"<none>"!==_[1]?_[1]:void 0,attachedTrigger:void 0,name:_[2],disabled:Boolean(Number(_[3])),difficulties:{easy:Boolean(Number(_[4])),medium:Boolean(Number(_[5])),hard:Boolean(Number(_[6]))},events:[],actions:[],tag:void 0},P.push(_))}return P}readEvents(g){let P=new Map,L=new Set;for(var[_,U]of g.entries){let g=U.split(",");if(g.length<4)console.warn(`Invalid event ${_}=${U}. Skipping.`);else{var G=Number(g.shift());let U=[];for(let P=0;P<G;P++){var V=Number(g.shift()),W=Number(g.shift());let G=g.splice(0,2===W?2:1);void 0!==I.TriggerEventType[V]?(W={triggerId:_,eventIndex:P,type:V,params:[W,...G.map(g=>g||"0")]},U.push(W)):(L.add(V),console.warn(`Unknown event type ${V} for trigger id ${_}. Skipping.`))}P.set(_,U)}}return{events:P,unknownEventTypes:L}}readActions(g){let P=new Map,I=new Set;for(var[_,U]of g.entries){let g=U.split(",");if(g.length<9)console.warn(`Invalid action ${_}=${U}. Skipping.`);else{var G=Number(g.shift());if(g.length<8*G)console.warn(`Invalid action ${_}=${U}. Skipping.`);else{let U=[];for(let P=0;P<G;P++){var V=Number(g.shift()),W=g.splice(0,7);void 0!==L.TriggerActionType[V]?(W={triggerId:_,index:P,type:V,params:[Number(W[0]||"0"),W[1]||"0",W[2]||"0",W[3]||"0",W[4]||"0",W[5]||"0",W[6]?this.readAZActionParam(W[6]):0]},U.push(W)):(I.add(V),console.warn(`Unknown action type ${V} for trigger id "${_}". Skipping.`))}P.set(_,U)}}}return{actions:P,unknownActionTypes:I}}readAZActionParam(g){var P="Z".charCodeAt(0),I="A".charCodeAt(0);P=P-I+1;return 1<g.length?g.charCodeAt(1)-I+(g.charCodeAt(0)-I+1)*P:g.charCodeAt(0)-I}})}}}),System.register("data/map/Variable",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("Variable",class i{constructor(g,P){this.name=g,this.value=P}clone(){return new i(this.name,this.value)}})}}}),System.register("data/MapFile",["data/mapObjects","data/IniFile","engine/TheaterType","util/string","data/encoding/Format5","data/Bitmap","data/map/tag/TagsReader","data/map/trigger/TriggerReader","data/DataStream","data/map/MapLighting","data/map/tag/CellTagsReader","data/map/Variable","data/map/SpecialFlags"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g}],execute:function(){Z=class d extends L.IniFile{fromString(g){super.fromString(g);let P=this.getSection("Map");if(!P)throw new Error("[Map] section not found");var I=P.getNumberArray("Size");if(this.fullSize={x:I[0],y:I[1],width:I[2],height:I[3]},I=P.getNumberArray("LocalSize"),this.localSize={x:I[0],y:I[1],width:I[2],height:I[3]},this.theaterType=P.getEnum("Theater",_.TheaterType,_.TheaterType.None,!0),this.theaterType===_.TheaterType.None)throw new Error(`Unsupported theater type "${P.getString("Theater")}"`);let L=this.getSection("Basic");return I=this.iniFormat=L?.getNumber("NewINIFormat")??0,this.readTiles(),this.readWaypoints(this.getOrCreateSection("Waypoints")),this.readStructures(this.getOrCreateSection("Structures")),this.readVehicles(),this.readInfantries(),this.readAircrafts(),this.readTerrains(this.getOrCreateSection("Terrain")),this.readOverlays(),this.readSmudges(),this.readLighting(),this.readTagsAndTriggers(),this.readCellTags(I),this.readVariableNames(),this.startingLocations=this.readStartingLocations(this.waypoints),this.specialFlags=(new Y.SpecialFlags).read(this.getOrCreateSection("SpecialFlags")),this}fromJson(g){if(g[d.artSectionPrefix]){let{[d.artSectionPrefix]:P,...I}=g;this.artOverrides=new L.IniFile(P),g=I}return super.fromJson(g)}readStartingLocations(g){let P=[];var I;for(I of g.filter(g=>g.number<8).sort((g,P)=>g.number<P.number?-1:1))P.push({x:I.rx,y:I.ry});return P}readLighting(){var g=this.getOrCreateSection("Lighting");this.lighting=(new q.MapLighting).read(g),this.ionLighting=(new q.MapLighting).read(g,"Ion"),this.ionLighting.forceTint=!0}readTagsAndTriggers(){this.tags=(new W.TagsReader).read(this.getOrCreateSection("Tags"));var g=this.getOrCreateSection("Triggers"),P=this.getOrCreateSection("Events"),I=this.getOrCreateSection("Actions"),{triggers:g,unknownEventTypes:P,unknownActionTypes:I}=(new z.TriggerReader).read(g,P,I,this.tags);this.triggers=g,this.unknownEventTypes=P,this.unknownActionTypes=I}readCellTags(g){this.cellTags=(new $.CellTagsReader).read(this.getOrCreateSection("CellTags"),g)}readVariableNames(){var g,P,I=this.getOrCreateSection("VariableNames");let L=new Map;for([g,P]of I.entries){var _,U,G=Number(g);Number.isNaN(G)?console.warn(`Map [VariableNames] contains non-numeric index "${g}". Skipping.`):([_,U]=P.split(","),U=new Q.Variable(_,Boolean(Number(U))),L.set(G,U))}this.variables=L}readTiles(){let g=this.getSection("IsoMapPack5");if(!g)throw new Error("[IsoMapPack5] section not found");var P=U.base64StringToUint8Array(g.getConcatenatedValues()),I=(2*this.fullSize.width-1)*this.fullSize.height,L=new Uint8Array(11*I+4);G.Format5.decodeInto(P,L);let _=new K.DataStream(L.buffer),V=2*this.fullSize.width-1;L=this.fullSize.height;var W,z,q,$,h=(g,P)=>P*V+g;this.tiles=new Array(V*L);for(let g=this.maxTileNum=0;g<I;g++){var Q=_.readUint16(),Y=_.readUint16(),Z=Math.max(0,_.readInt16());this.maxTileNum=Math.max(this.maxTileNum,Z),_.readInt16();var X=_.readUint8(),J=_.readUint8();_.readUint8();var ee=Q-Y+this.fullSize.width-1,te=Q+Y-this.fullSize.width-1;0<=ee&&ee<2*this.fullSize.width&&0<=te&&te<2*this.fullSize.height&&(X={dx:ee,dy:te,rx:Q,ry:Y,z:J,tileNum:Z,subTile:X},this.tiles[h(ee,Math.floor(te/2))]=X)}for(let g=0;g<this.fullSize.height;g++)for(let P=0;P<=2*this.fullSize.width-2;P++)this.tiles[h(P,g)]||($=(z=2*g+P%2)-(q=((W=P)+z)/2+1)+this.fullSize.width+1,this.tiles[h(P,g)]={dx:W,dy:z,rx:q,ry:$,z:0,tileNum:0,subTile:0})}readWaypoints(g){for(var[P,I]of(this.waypoints=[],g.entries)){var L;let g;isNaN(L=parseInt(P,10))||isNaN(g=parseInt(I,10))||(I=g-1e3*(P=Math.floor(g/1e3)),this.waypoints.push({number:L,rx:I,ry:P}))}}readStructures(g){for(var[,P]of(this.structures=[],g.entries))if(!((P=P.split(",")).length<=15)){let g=new I.Structure;g.owner=P[0],g.name=P[1],g.health=Number(P[2]),g.rx=Number(P[3]),g.ry=Number(P[4]),g.tag=this.readTagId(P[6]),g.poweredOn=Boolean(Number(P[9])),this.structures.push(g)}}readTagId(g){return"none"!==g.toLowerCase()?g:void 0}readVehicles(){this.vehicles=[];let g=this.getSection("Units");if(g)for(var P of g.entries.values()){var L=P.split(",");if(L.length<=11)console.warn(`Invalid Vehicle entry: "${P}"`);else{let g=new I.Vehicle;g.owner=L[0],g.name=L[1],g.health=Number(L[2]),g.rx=Number(L[3]),g.ry=Number(L[4]),g.direction=Number(L[5]),g.tag=this.readTagId(L[7]),g.veterancy=Number(L[8]),g.onBridge="1"===L[10],this.vehicles.push(g)}}}readInfantries(){this.infantries=[];let g=this.getSection("Infantry");if(g)for(var P of g.entries.values()){var L=P.split(",");let g=new I.Infantry;L.length<=8?console.warn(`Invalid Infantry entry: "${P}"`):(g.owner=L[0],g.name=L[1],g.health=Number(L[2]),g.rx=Number(L[3]),g.ry=Number(L[4]),g.subCell=Number(L[5]),g.direction=Number(L[7]),g.tag=this.readTagId(L[8]),g.veterancy=Number(L[9]),g.onBridge="1"===L[11],this.infantries.push(g))}}readAircrafts(){this.aircrafts=[];let g=this.getSection("Aircraft");if(g)for(var P of g.entries.values()){P=P.split(",");let g=new I.Aircraft;g.owner=P[0],g.name=P[1],g.health=Number(P[2]),g.rx=Number(P[3]),g.ry=Number(P[4]),g.direction=Number(P[5]),g.tag=this.readTagId(P[7]),g.veterancy=Number(P[8]),g.onBridge="1"===P[P.length-4],this.aircrafts.push(g)}}readTerrains(g){for(var[P,L]of(this.terrains=[],g.entries))if(P=Number(P),!isNaN(P)){let g=new I.Terrain;g.name=L,g.rx=P%1e3,g.ry=Math.floor(P/1e3),this.terrains.push(g)}}readOverlays(){this.overlays=[],this.maxOverlayId=0;let g=this.getSection("OverlayPack");if(g){var P=U.base64StringToUint8Array(g.getConcatenatedValues()),L=new Uint8Array(1<<18);G.Format5.decodeInto(P,L,80);let q=this.getSection("OverlayDataPack");if(q){P=U.base64StringToUint8Array(q.getConcatenatedValues());var _=new Uint8Array(1<<18);G.Format5.decodeInto(P,_,80);for(let g=0;g<this.fullSize.height;g++)for(let P=2*this.fullSize.width-2;0<=P;P--){var V,W,z=((V=P)+(W=2*g+P%2))/2+1,K=W-z+this.fullSize.width+1;if(255!==(W=L[V=z+512*K])){V=_[V];let g=new I.Overlay;g.id=W,g.value=V,g.rx=z,g.ry=K,this.overlays.push(g),this.maxOverlayId=Math.max(this.maxOverlayId,W)}}}else console.warn("[OverlayDataPack] section not found. Skipping.")}else console.warn("[Overlay] section not found. Skipping.")}readSmudges(){this.smudges=[];let g=this.getSection("Smudge");if(g)for(var P of g.entries.values()){var L=P.split(",");if(L.length<=2)console.warn(`Invalid Smudge entry: "${P}"`);else{let g=new I.Smudge;g.name=L[0],g.rx=Number(L[1]),g.ry=Number(L[2]),this.smudges.push(g)}}}decodePreviewImage(){let g=this.getSection("Preview"),P=this.getSection("PreviewPack");if(g&&P){var[,,I,L]=g.getArray("Size").map(g=>Number(g)),_=U.base64StringToUint8Array(P.getConcatenatedValues()),L=new V.RgbBitmap(I,L);return G.Format5.decodeInto(_,L.data),L}}},g("MapFile",Z),Z.artSectionPrefix="ART"}}}),System.register("data/mapObjects",["engine/type/ObjectType"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("MapObject",L=class{constructor(g){this.type=g}isStructure(){return this.type===I.ObjectType.Building}isVehicle(){return this.type===I.ObjectType.Vehicle}isInfantry(){return this.type===I.ObjectType.Infantry}isAircraft(){return this.type===I.ObjectType.Aircraft}isTerrain(){return this.type===I.ObjectType.Terrain}isSmudge(){return this.type===I.ObjectType.Smudge}isOverlay(){return this.type===I.ObjectType.Overlay}isNamed(){return"name"in this}isTechno(){return"health"in this}}),U=class extends L{},_=class extends U{},g("Structure",class extends _{constructor(){super(I.ObjectType.Building)}}),g("Vehicle",class extends _{constructor(){super(I.ObjectType.Vehicle)}}),g("Infantry",class extends _{constructor(){super(I.ObjectType.Infantry)}}),g("Aircraft",_=class extends _{constructor(){super(I.ObjectType.Aircraft)}}),g("Terrain",_=class extends U{constructor(){super(I.ObjectType.Terrain)}}),g("Smudge",U=class extends U{constructor(){super(I.ObjectType.Smudge)}}),g("Overlay",U=class extends L{constructor(){super(I.ObjectType.Overlay)}})}}}),System.register("data/MixEntry",["util/string","data/Crc32"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("MixEntry",_=class{static hashFilename(g){var P=(g=g.toUpperCase()).length,_=P>>2;if(3&P){g+=String.fromCharCode(P-(_<<2));let I=3-(3&P);for(;0!=I--;)g+=g[_<<2]}return L.Crc32.calculateCrc(I.binaryStringToUint8Array(g))}constructor(g,P,I){this.hash=g,this.offset=P,this.length=I}}),_.size=12}}}),System.register("data/MixFile",["data/DataStream","data/encoding/Blowfish","data/encoding/BlowfishKey","data/MixEntry","data/vfs/VirtualFile"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){var P;(P=V=V||{})[P.Checksum=65536]="Checksum",P[P.Encrypted=131072]="Encrypted",g("MixFile",class{constructor(g){this.stream=g,this.headerStart=84,this.index=new Map,this.parseHeader()}parseHeader(){var g=this.stream.readUint32();if(0==(g&~(V.Checksum|V.Encrypted))){if(0!=(g&V.Encrypted))return void(this.dataStart=this.parseRaHeader())}else this.stream.seek(0);this.dataStart=this.parseTdHeader(this.stream)}parseRaHeader(){const g=this.stream;var P=g.readUint8Array(80),G=(new _.BlowfishKey).decryptKey(P),V=g.readUint32Array(2);const W=new L.Blowfish(G);let z=new I.DataStream(W.decrypt(V));return P=z.readUint16(),z.readUint32(),g.position=this.headerStart,P=(3+(G=6+P*U.MixEntry.size))/4|0,V=g.readUint32Array(P+P%2),z=new I.DataStream(W.decrypt(V)),G=this.headerStart+G+(1+(~G>>>0)&7),this.parseTdHeader(z),G}parseTdHeader(g){var P=g.readUint16();g.readUint32();for(let L=0;L<P;L++){var I=new U.MixEntry(g.readUint32(),g.readUint32(),g.readUint32());this.index.set(I.hash,I)}return g.position}containsFile(g){return this.index.has(U.MixEntry.hashFilename(g))}openFile(g){var P=this.index.get(U.MixEntry.hashFilename(g));if(!P)throw new Error(`File "${g}" not found`);return G.VirtualFile.factory(this.stream,g,this.dataStart+P.offset,P.length)}})}}}),System.register("data/Mp3File",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("Mp3File",class{constructor(g){this.file=g}asFile(){return new File([this.file],this.file.name,{type:"audio/mp3"})}})}}}),System.register("data/Palette",["util/Color","util/math","data/vfs/VirtualFile"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("Palette",U=class a{constructor(g){g instanceof _.VirtualFile?this.fromVirtualFile(g):"object"==typeof g&&this.fromJson(g)}fromVirtualFile(g){var P=g.stream.readUint8Array(768);this.fromJson(P)}fromJson(g){this.colors=[];for(let P=0;P<g.length/3;++P)this.colors.push(I.Color.fromRgb(4*g[3*P],4*g[3*P+1],4*g[3*P+2]));this._hash=this.computeHash(this.colors)}getColor(g){return this.colors[g]}getColorAsHex(g){return this.getColor(g).asHex()}setColors(g){this.colors=g,this._hash=this.computeHash(this.colors)}get size(){return this.colors.length}get hash(){return this._hash}computeHash(g){let P=new Uint8Array(3*this.size),I=0;for(var _ of g)P[I]=_.r,P[I+1]=_.g,P[I+2]=_.b,I+=3;return L.fnv32a(P)}clone(){let g=new a;return g.colors=this.colors.map(g=>g.clone()),g._hash=this._hash,g}remap(g){var P=[63,59,55,52,48,44,41,37,33,30,26,22,19,15,11,8];for(let I=a.REMAP_START_IDX;I<a.REMAP_START_IDX+P.length;I++)this.colors[I].r=Math.floor(g.r/255*P[I-a.REMAP_START_IDX]*4),this.colors[I].g=Math.floor(g.g/255*P[I-a.REMAP_START_IDX]*4),this.colors[I].b=Math.floor(g.b/255*P[I-a.REMAP_START_IDX]*4);return this._hash=this.computeHash(this.colors),this}}),U.REMAP_START_IDX=16}}}),System.register("data/PcxFile",["pcx-js","engine/gfx/CanvasUtils"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("PcxFile",class{constructor(g){this.file=g;var P=this.file.stream;var L=new I.default(new Uint8Array(P.buffer,P.byteOffset,P.byteLength)).decode();P=L.pixelArray;this.fixAlpha(P),this.width=L.width,this.height=L.height,this.data=P}async toPngBlob(){var g=this.toCanvas();return await L.CanvasUtils.canvasToBlob(g)}toDataUrl(){return this.toCanvas().toDataURL()}toCanvas(){return L.CanvasUtils.canvasFromRgbaImageData(this.data,this.width,this.height)}fixAlpha(g){for(let P=0,I=g.length;P<I;P+=4)255===g[P]&&0===g[P+1]&&255===g[P+2]&&(g[P+3]=0)}})}}}),System.register("data/ShpFile",["data/encoding/Format3","data/ShpImage","data/vfs/VirtualFile"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("ShpFile",class r{constructor(g){this.height=0,this.width=0,this.numImages=0,this.images=[],g instanceof _.VirtualFile&&this.fromVirtualFile(g)}fromVirtualFile(g){this.filename=g.filename;let P=g.stream;if(0===P.readInt16()){this.width=P.readInt16(),this.height=P.readInt16(),this.numImages=P.readInt16();let g=[];for(let I=0;I<this.numImages;++I)g.push(this.readFrameHeader(P));this.images=[];for(let K=0;K<this.numImages;++K){var{compressionType:I,imageDataStartOffset:_,x:U,y:G,width:V,height:W}=g[K];let q=K<this.numImages-1?g[K+1].imageDataStartOffset:P.byteLength;q<_&&(q=P.byteLength);var z=q-_;P.seek(_),z=this.readImageData(P,V,W,I,z);let $=new L.ShpImage(z);$.x=U,$.y=G,$.width=V,$.height=W,this.images.push($)}}}readFrameHeader(g){var P=g.readInt16(),I=g.readInt16(),L=g.readInt16(),_=g.readInt16(),U=g.readUint8();return g.readUint8(),g.readUint8(),g.readUint8(),g.readInt32(),g.readInt32(),{x:P,y:I,width:L,height:_,compressionType:U,imageDataStartOffset:g.readInt32()}}readImageData(g,P,L,_,U){var G=P*L;if(_<=1){var V=new Uint8Array(g.buffer,g.byteOffset+g.position,G);return g.position+=G,V}if(2===_){let P=0,I=new Uint8Array(G);for(let _=0;_<L;++_){var W=g.readUint16()-2;I.set(new Uint8Array(g.buffer,g.byteOffset+g.position,W),P),g.position+=W,P+=W}return I}return 3!==_?new Uint8Array:(G=new Uint8Array(g.buffer,g.byteOffset+g.position,U),g.position+=U,I.Format3.decode(G,P,L))}getImage(g){if(g<0||this.images.length<=g)throw new RangeError(`Image index out of bounds (file=${this.filename}, index=${g}, length=${this.images.length})`);return this.images[g]}addImage(g){this.images.push(g),this.numImages++}clip(g,P){let I=new r;return I.filename=this.filename,I.width=Math.min(this.width,g),I.height=Math.min(this.height,P),I.images=this.images.map(g=>g.clip(I.width,I.height)),I.numImages=this.numImages,I}})}}}),System.register("data/ShpImage",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("ShpImage",class n{constructor(g){this.height=1,this.width=1,this.x=0,this.y=0,this.imageData=g??new Uint8Array(0)}clip(g,P){let I=new n;I.width=Math.min(this.width,g),I.height=Math.min(this.height,P);let L=new Uint8Array(g*P),_=0;for(let I=0;I<this.height&&!(I>=P);I++)for(let P=0;P<this.width;P++)P>=g||(L[_++]=this.imageData[I*this.width+P]);return I.imageData=L,I.x=this.x,I.y=this.y,I}})}}}),System.register("data/Strings",["sprintf-js","data/CsfFile"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("Strings",class{constructor(g){this.data={},g instanceof L.CsfFile?this.fromCsf(g):"object"==typeof g&&this.fromJson(g)}fromCsf(g){this.fromJson(g.data)}fromJson(g){for(var P of Object.keys(g))this.setValue(P,this.sanitizeValue(g[P]))}sanitizeValue(g){return g.replace(/%hs/g,"%s")}setValue(g,P){this.data[g.toLowerCase()]=P}has(g){return!!this.data[g.toLowerCase()]}get(g,...P){let L=this.data[g.toLowerCase()];return L?"string"!=typeof L?(console.warn(`Invalid string value for name "${g}"`),g):(P.length&&(L=I.sprintf(L,...P)),L):g.match(/^NOSTR:/i)?g.replace(/^NOSTR:/i,""):(console.warn(`String with name "${g}" not found"`),g)}})}}}),System.register("data/TmpFile",["data/TmpImage","data/vfs/VirtualFile"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("TmpFile",class{constructor(g){this.images=[],g instanceof L.VirtualFile&&this.fromVirtualFile(g)}fromVirtualFile(g){let P=g.stream;this.width=P.readInt32(),this.height=P.readInt32(),this.blockWidth=P.readInt32(),this.blockHeight=P.readInt32();var L=this.width*this.height,_=new Uint8Array(P.buffer,P.byteOffset+P.position,4*L);this.images=[];for(let g=0;g<L;g++){var U=_[4*g+3]<<24|_[4*g+2]<<16|_[4*g+1]<<8|_[4*g];P.seek(U),U=new I.TmpImage(P,this.blockWidth,this.blockHeight),this.images.push(U)}}})}}}),System.register("data/TmpImage",[],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[],execute:function(){var P;(P=I=I||{})[P.ExtraData=1]="ExtraData",P[P.ZData=2]="ZData",P[P.DamagedData=4]="DamagedData",L=g=>g<0?g+256:g,g("TmpImage",class{constructor(g,P,I){this.fromStream(g,P,I)}fromStream(g,P,L){this.x=g.readInt32(),this.y=g.readInt32(),g.readInt32(),g.readInt32();var _=g.readInt32();this.extraX=g.readInt32(),this.extraY=g.readInt32(),this.extraWidth=g.readInt32(),this.extraHeight=g.readInt32();var U=g.readUint32();this.height=g.readUint8(),this.terrainType=g.readUint8(),this.rampType=g.readUint8(),this.radarLeft=this.readRadarRgb(g.readInt8(),g.readInt8(),g.readInt8()),this.radarRight=this.readRadarRgb(g.readInt8(),g.readInt8(),g.readInt8()),g.seek(g.position+3),this.tileData=new Uint8Array(g.buffer,g.byteOffset+g.position,P*L/2),g.position+=P*L/2,this.hasZData=(U&I.ZData)===I.ZData,this.hasZData&&(g.position+=P*L/2),this.hasExtraData=(U&I.ExtraData)===I.ExtraData,this.hasExtraData&&(U=Math.abs(this.extraWidth*this.extraHeight),this.extraData=new Uint8Array(g.buffer,g.byteOffset+g.position,U),g.position+=U),this.hasZData&&this.hasExtraData&&0<_&&_<g.byteLength&&(g.position+=Math.abs(this.extraWidth*this.extraHeight))}readRadarRgb(g,P,I){return new THREE.Color(L(g)/255,L(P)/255,L(I)/255)}})}}}),System.register("data/vfs/Archive",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("data/vfs/FileNotFoundError",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){I=class extends Error{constructor(){super(...arguments),this.name="FileNotFoundError"}},g("FileNotFoundError",I)}}}),System.register("data/vfs/IOError",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){I=class extends Error{constructor(){super(...arguments),this.name="IOError"}},g("IOError",I)}}}),System.register("data/vfs/MemArchive",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("MemArchive",class{constructor(){this.entries=new Map}addFile(g){this.entries.set(g.filename,g)}containsFile(g){return this.entries.has(g)}openFile(g){if(!this.containsFile(g))throw new Error(`File "${g}" not found`);return this.entries.get(g)}})}}}),System.register("data/vfs/NameNotAllowedError",["data/vfs/IOError"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.IOError{constructor(){super(...arguments),this.name="NameNotAllowedError"}},g("NameNotAllowedError",L)}}}),System.register("data/vfs/RealFileSystem",["data/vfs/FileNotFoundError","data/vfs/RealFileSystemDir"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("RealFileSystem",class{constructor(){this.directories=[]}addRootDirectoryHandle(g){this.rootDirectory=this.addDirectoryHandle(g),this.rootDirectoryHandle=g}getRootDirectoryHandle(){return this.rootDirectoryHandle}addDirectoryHandle(g){var P=new L.RealFileSystemDir(g);return this.directories.push(P),P}addDirectory(g){this.directories.push(g)}async getDirectory(g){var P=await this.findDirectory(g);if(!P)throw new Error(`Directory "${g}" not found in real file system`);return P}async findDirectory(g){for(const P of this.directories)if(await P.containsEntry(g))return await P.getDirectory(g)}getRootDirectory(){return this.rootDirectory}async containsEntry(g){for(const P of this.directories)if(await P.containsEntry(g))return!0;return!1}async openFile(g,P=!1){for(const L of this.directories)try{return await L.openFile(g,P)}catch(g){if(!(g instanceof I.FileNotFoundError))throw g}throw new I.FileNotFoundError(`File "${g}" not found in real file system`)}async getRawFile(g){for(const P of this.directories)if(await P.containsEntry(g))return await P.getRawFile(g);throw new Error(`File "${g}" not found in real file system`)}async*getEntries(){for(var g of this.directories)for await(var P of g.getEntries())yield P}})}}}),System.register("data/vfs/RealFileSystemDir",["data/vfs/StorageQuotaError","util/string","data/vfs/FileNotFoundError","data/vfs/IOError","data/vfs/NameNotAllowedError","data/vfs/VirtualFile"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){g("RealFileSystemDir",class s{constructor(g,P=!1){this.handle=g,this.caseSensitive=P}get name(){return this.handle.name}async*getEntries(){try{for await(var g of this.handle.keys())yield g}catch(g){if("NotFoundError"===g.name)throw new _.FileNotFoundError(`Directory "${this.handle.name}" not found`,{cause:g});if(g instanceof DOMException)throw new U.IOError(`Directory "${this.handle.name}" could not be read (${g.name})`,{cause:g});throw g}}async listEntries(){let g=[];for await(var P of this.getEntries())g.push(P);return g}async*getFileHandles(){try{for await(const g of this.handle.values())"file"===g.kind&&(yield g)}catch(g){if("NotFoundError"===g.name)throw new _.FileNotFoundError(`Directory "${this.handle.name}" not found`,{cause:g});if(g instanceof DOMException)throw new U.IOError(`Directory "${this.handle.name}" could not be read (${g.name})`,{cause:g});throw g}}async*getRawFiles(){for await(const g of this.getFileHandles())yield await g.getFile()}async containsEntry(g){return void 0!==await this.resolveEntryName(g)}async resolveEntryName(g){if(this.caseSensitive)return(await this.handle.getFileHandle(g).catch(()=>this.handle.getDirectoryHandle(g)).catch(()=>{}))?.name;for await(const P of this.getEntries())if(L.equalsIgnoreCase(P,g))return P}async fixEntryCase(g){if(!this.caseSensitive)for await(var P of this.getEntries())if(L.equalsIgnoreCase(P,g)){g=P;break}return g}async getRawFile(g,P=!1,I){let L;try{var V=P?g:await this.fixEntryCase(g);L=await this.handle.getFileHandle(V)}catch(P){if("NotFoundError"===P.name)throw new _.FileNotFoundError(`File "${g}" not found in directory "${this.handle.name}"`,{cause:P});if(P instanceof TypeError&&P.message.includes("not allowed"))throw new G.NameNotAllowedError(`File name "${g}" is not allowed`,{cause:P});if(P instanceof DOMException)throw new U.IOError(`File "${g}" could not be read (${P.name})`,{cause:P});throw P}return V=await L.getFile(),I?new File([V],V.name,{type:I}):V}async openFile(g,P=!1){var I=await this.getRawFile(g,P);return V.VirtualFile.fromRealFile(I)}async writeFile(g,P){var L=P??(g instanceof File?g.name:g.filename);try{var V=await this.fixEntryCase(L);await this.deleteFile(V,!0);let I=await this.handle.getFileHandle(V,{create:!0}),_=await I.createWritable();try{await _.write(g instanceof File?g:new Uint8Array(g.stream.buffer,g.stream.byteOffset,g.stream.byteLength)),await _.close()}catch(P){throw await _.abort(),P}}catch(P){if("QuotaExceededError"===P.name)throw new I.StorageQuotaError({cause:P});if("NotFoundError"===P.name)throw new _.FileNotFoundError(`Directory "${this.handle.name}" not found`,{cause:P});if(P instanceof TypeError&&P.message.includes("not allowed"))throw new G.NameNotAllowedError(`File name "${L}" is not allowed`,{cause:P});if(P instanceof DOMException)throw new U.IOError(`File "${L}" could not be written (${P.name})`,{cause:P});throw P}}async deleteFile(g,P=!1){var L=P?g:await this.resolveEntryName(g);if(L)try{await this.handle.removeEntry(L)}catch(g){if(P&&"NotFoundError"===g.name)return;if("QuotaExceededError"===g.name)throw new I.StorageQuotaError({cause:g});if(g instanceof TypeError&&g.message.includes("not allowed"))throw new G.NameNotAllowedError(`File name "${L}" is not allowed`,{cause:g});if(g instanceof DOMException)throw new U.IOError(`File "${L}" could not be deleted (${g.name})`,{cause:g});throw g}}async getDirectory(g,P=this.caseSensitive){var I=P?g:await this.fixEntryCase(g);let L;try{L=await this.handle.getDirectoryHandle(I)}catch(P){if("NotFoundError"===P.name)throw new _.FileNotFoundError(`Directory "${g}" not found or parent directory "${this.handle.name}" is gone`,{cause:P});if(P instanceof TypeError&&P.message.includes("not allowed"))throw new G.NameNotAllowedError(`Directory name "${g}" is not allowed`,{cause:P});if(P instanceof DOMException)throw new U.IOError(`Directory "${g}" could not be read (${P.name})`,{cause:P});throw P}return new s(L,P)}async getOrCreateDirectory(g,P=this.caseSensitive){var L=P?g:await this.fixEntryCase(g);try{return new s(await this.handle.getDirectoryHandle(L,{create:!0}),P)}catch(P){if("QuotaExceededError"===P.name)throw new I.StorageQuotaError({cause:P});if("NotFoundError"===P.name)throw new _.FileNotFoundError(`Directory "${this.handle.name}" not found"`,{cause:P});if(P instanceof TypeError&&P.message.includes("not allowed"))throw new G.NameNotAllowedError(`Directory name "${g}" is not allowed`,{cause:P});if(P instanceof DOMException)throw new U.IOError(`Directory "${g}" could not be created (${P.name})`,{cause:P});throw P}}async deleteDirectory(g,P=!1){var L=await this.resolveEntryName(g);if(L)try{await this.handle.removeEntry(L,{recursive:P})}catch(g){if("QuotaExceededError"===g.name)throw new I.StorageQuotaError({cause:g});if("InvalidModificationError"===g.name)throw new U.IOError("Can't delete non-empty directory when recursive = false");if(g instanceof TypeError&&g.message.includes("not allowed"))throw new G.NameNotAllowedError(`Directory name "${L}" is not allowed`,{cause:g});if(g instanceof DOMException)throw new U.IOError(`Directory "${L}" could not be deleted (${g.name})`,{cause:g});throw g}}})}}}),System.register("data/vfs/StorageQuotaError",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){I=class extends Error{constructor(g){super("Storage quota exceeded",g),this.name="StorageQuotaError"}},g("StorageQuotaError",I)}}}),System.register("data/vfs/VirtualFile",["data/DataStream","data/vfs/IOError"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("VirtualFile",class{static async fromRealFile(g){try{const P=new I.DataStream(await g.arrayBuffer());return P._trimAlloc=()=>{},new this(P,g.name)}catch(P){if(P instanceof DOMException)throw new L.IOError(`File "${g.name}" could not be read (${P.name})`,{cause:P});throw P}}static fromBytes(g,P){let L=new I.DataStream(g);return L._trimAlloc=()=>{},new this(L,P)}static factory(g,P,L=0,_=g.byteLength){var U=new DataView(g.buffer,g.byteOffset+L,_);const G=new I.DataStream(U);return G._trimAlloc=()=>{},new this(G,P)}constructor(g,P){this.stream=g,this.filename=P}readAsString(g){return this.stream.seek(0),this.stream.readString(this.stream.byteLength,g)}getBytes(){return new Uint8Array(this.stream.buffer,this.stream.byteOffset,this.stream.byteLength)}getSize(){return this.stream.byteLength}asFile(g){return new File([this.getBytes()],this.filename,{type:g})}})}}}),System.register("data/vfs/VirtualFileSystem",["data/AudioBagFile","data/IdxFile","data/MixFile","engine/EngineType","util/string","data/vfs/FileNotFoundError","data/vfs/MemArchive"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g}],execute:function(){g("VirtualFileSystem",class{constructor(g,P){this.rfs=g,this.logger=P,this.allArchives=new Map,this.archivesByPriority=[]}fileExists(g){for(const P of this.archivesByPriority)if(P.containsFile(g))return!0;return!1}openFile(g){for(const P of this.archivesByPriority)if(P.containsFile(g))return P.openFile(g);throw new V.FileNotFoundError(`File "${g}" not found in VFS`)}addArchive(g,P){this.allArchives.has(P)||(this.allArchives.set(P,g),this.archivesByPriority.push(g)),this.logger.info(`Added archive "${P}" to VFS`)}hasArchive(g){return this.allArchives.has(g)}removeArchive(g){var P=this.allArchives.get(g);P&&(this.allArchives.delete(g),this.archivesByPriority.splice(this.archivesByPriority.indexOf(P),1),this.logger.info(`Removed archive "${g}" from VFS`))}listArchives(){return[...this.allArchives.keys()]}async addMixFile(g){await this.addArchiveByFilename(g,g=>new _.MixFile(g.stream))}async addBagFile(g){const P=await this.openFileWithRfs(g.replace(".bag",".idx"));await this.addArchiveByFilename(g,g=>{var _=new L.IdxFile(P.stream);return(new I.AudioBagFile).fromVirtualFile(g,_)})}async addArchiveByFilename(g,P){var I;this.allArchives.has(g)||(I=await this.openFileWithRfs(g))&&this.addArchive(P(I),g)}async openFileWithRfs(g){let P;try{P=await this.rfs.openFile(g)}catch(g){if(!(g instanceof V.FileNotFoundError))throw g}if(!P){if(!this.fileExists(g))throw new V.FileNotFoundError(`File "${g}" not found`);P=this.openFile(g)}return P}async loadImplicitMixFiles(g){this.logger.info("Initializing implicit mix files..."),g===U.EngineType.YurisRevenge&&await this.addMixFile("langmd.mix"),await this.addMixFile("language.mix"),g===U.EngineType.YurisRevenge&&await this.addMixFile("ra2md.mix"),await this.addMixFile("ra2.mix"),g===U.EngineType.YurisRevenge&&await this.addMixFile("cachemd.mix"),await this.addMixFile("cache.mix"),g===U.EngineType.YurisRevenge&&await this.addMixFile("loadmd.mix"),await this.addMixFile("load.mix"),g===U.EngineType.YurisRevenge&&await this.addMixFile("localmd.mix"),await this.addMixFile("local.mix"),g===U.EngineType.YurisRevenge&&await this.addMixFile("ntrlmd.mix"),await this.addMixFile("neutral.mix"),g===U.EngineType.YurisRevenge&&await this.addMixFile("audiomd.mix"),await this.addMixFile("audio.mix"),await this.addBagFile("audio.bag"),g===U.EngineType.YurisRevenge&&await this.addMixFile("conqmd.mix"),await this.addMixFile("conquer.mix"),g===U.EngineType.YurisRevenge&&await this.addMixFile("genermd.mix"),await this.addMixFile("generic.mix"),g===U.EngineType.YurisRevenge&&await this.addMixFile("isogenmd.mix"),await this.addMixFile("isogen.mix"),g===U.EngineType.YurisRevenge&&await this.addMixFile("cameomd.mix"),await this.addMixFile("cameo.mix"),g===U.EngineType.YurisRevenge&&await this.addMixFile("multimd.mix"),await this.addMixFile("multi.mix")}async loadExtraMixFiles(g){let P=new Set;for await(var I of this.rfs.getEntries())P.add(I.toLowerCase());for(var L of["ecache","expand","elocal"])for(let I=99;0<=I;I--){let _=[""+L+G.pad(I,"00")+".mix"];for(var V of(g===U.EngineType.YurisRevenge&&_.push(`${L}md${G.pad(I,"00")}.mix`),_))P.has(V)&&await this.addMixFile(V)}let W=[".mmx"];g===U.EngineType.YurisRevenge&&W.push(".yro");for(const g of W)for(const I of P)I.endsWith(g)&&this.addArchive(new _.MixFile((await this.rfs.openFile(I)).stream),I)}async loadStandaloneFiles(g){let P=["ini","csf"],I=new Set(g?.exclude),L=[];for await(var _ of this.rfs.getEntries()){let g=_.toLowerCase();P.some(P=>g.endsWith("."+P))&&!I.has(g)&&L.push(await this.rfs.openFile(_,!0))}if(L.length){let g=new W.MemArchive;for(var U of L)g.addFile(U);this.addArchive(g,"mem.archive")}}})}}}),System.register("data/vxl/normals",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){I=THREE.Vector3,g("normals1",[new I(.54946297,-183e-6,-.835518),new I(.00014400001,.54940403,-.83555698),new I(-.54940403,-68000001e-12,-.83555698),new I(106e-6,-.54946297,-.835518),new I(.94900799,.00031599999,-.31525001),new I(-186e-6,.94899702,-.31528401),new I(-.94899702,.00031800001,-.31528401),new I(-447e-6,-.94900799,-.31525001),new I(.95084399,-279e-6,.30967101),new I(202e-6,.95084798,.30965701),new I(-.95084798,-70000002e-12,.30965701),new I(147e-6,-.95084399,.30967101),new I(.55237001,-11e-6,.83359897),new I(19999999e-12,.55238003,.833592),new I(-.55238003,57000001e-12,.83359301),new I(-66000001e-12,-.55237001,.83359897)]),g("normals2",[new I(.67121398,.19849201,-.714194),new I(.26964301,.58439398,-.76536),new I(-.040546,.096988,-.99445897),new I(-.57242799,-.091913998,-.81478697),new I(-.17140099,-.57270998,-.80163902),new I(.36255699,-.30299899,-.88133103),new I(.81034702,-.34897199,-.470698),new I(.103962,.93867201,-.328767),new I(-.324047,.58766901,-.74137598),new I(-.80086499,.34046099,-.49264699),new I(-.66549802,-.59014702,-.45698899),new I(.314767,-.803002,-.506073),new I(.97262901,.151076,-.17655),new I(.680291,.68423599,-.26272699),new I(-.52007902,.82777703,-.210483),new I(-.96164399,-.179001,-.207847),new I(-.262714,-.937451,-.22840101),new I(.219707,-.97130102,.091124997),new I(.92380798,-.229975,.30608699),new I(-.082488999,.97065997,.225866),new I(-.59179801,.69678998,.40528899),new I(-.92529601,.36660099,.097111002),new I(-.705051,-.68777502,.172828),new I(.7324,-.68036699,-.026304999),new I(.85516202,.37458199,.358311),new I(.47300601,.83648002,.276705),new I(-.097617,.65411198,.750072),new I(-.90412402,-.153725,.39865801),new I(-.211916,-.85808998,.46773201),new I(.50022697,-.67440802,.543091),new I(.584539,-.110249,.80384099),new I(.43737301,.45464399,.77588898),new I(-.042440999,.083318003,.995619),new I(-.59625101,.22013199,.77202803),new I(-.506455,-.39697701,.76544899),new I(.070569001,-.47847399,.87526202)]),g("normals3",[new I(.45651099,-.073968001,-.88663799),new I(.50769401,.38511699,-.77067),new I(.095431998,.22666401,-.96928602),new I(-.35876599,.54318798,-.75910097),new I(-.361276,.13299499,-.92292601),new I(-.48311701,-.32406601,-.813375),new I(-.018073,-.197559,-.980124),new I(.3211,-.501477,-.80337799),new I(.79949099,.069615997,-.59662998),new I(.390971,.77130598,-.50222403),new I(.080782004,.61448997,-.784778),new I(-.73275,.41143101,-.54203498),new I(-.73525399,.0091019999,-.67773098),new I(-.80249399,-.39490801,-.44727099),new I(-.13413,-.58915502,-.79680902),new I(.71955299,-.37622699,-.58369303),new I(.96687502,.173593,-.187132),new I(.760831,.51910597,-.38944301),new I(-.114642,.87551898,-.46938601),new I(-.53236699,.76885903,-.354177),new I(-.96226698,.024977,-.27095801),new I(-.46738699,-.721986,-.51018202),new I(.058449998,-.85235399,-.51968902),new I(.49823299,-.74374002,-.44566301),new I(.93915099,-.27024499,-.212044),new I(.58393198,.80944198,-.061857),new I(.183797,.97322798,-.138007),new I(-.88435501,.45221901,-.115822),new I(-.943178,-.33206701,.012138),new I(-.69844002,-.70656699,-.113772),new I(-.228411,-.95470601,-.190694),new I(.73156399,-.675861,-.089588001),new I(.96925098,.046804,.24158201),new I(.85564703,.50347698,.119916),new I(-.25115299,.96794701,-80999998e-12),new I(-.64779502,.75674897,.087711997),new I(-.96916401,.14519399,.1991),new I(-.41479301,-.88896698,.194126),new I(.25077501,-.961178,-.115109),new I(.47862899,-.84259301,.246883),new I(.89004397,-.39614201,.225595),new I(.52405101,.76235998,.37970701),new I(.11962,.94548202,.30291),new I(-.76085001,.49007499,.42536199),new I(-.86978501,-.20215,.450122),new I(-.70946699,-.60242403,.36570701),new I(.019308999,-.95887101,.28318599),new I(.626113,-.564677,.53770101),new I(.769943,-.126663,.62541503),new I(.76419097,.35070199,.54131401),new I(-.001878,.74136698,.67109799),new I(-.37088001,.81836802,.43900099),new I(-.71390897,.12865201,.68831801),new I(-.295165,-.73866397,.60601401),new I(.186195,-.73836899,.648184),new I(.387523,-.35878301,.84917599),new I(.481022,.124846,.86777401),new I(.391808,.54505599,.741216),new I(-.0035359999,.36559799,.93076599),new I(-.42049801,.484961,.76680797),new I(-.35490301,.019470001,.93470001),new I(-.54783702,-.35920799,.75554299),new I(-.106662,-.445115,.88909799),new I(.086796001,-.059307002,.99445897)]),g("normals4",[new I(.52657801,-.35962099,-.77031702),new I(.150482,.43598399,.88728398),new I(.414195,.73825502,-.53237402),new I(.075152002,.91624898,-.393498),new I(-.316149,.93073601,-.18379299),new I(-.77381903,.62333399,-.11251),new I(-.90084201,.42853701,-.069568001),new I(-.99894202,-.010971,.044665001),new I(-.979761,-.15767001,-.123324),new I(-.91127402,-.362371,-.19562),new I(-.62406898,-.72094101,-.301301),new I(-.310173,-.80934501,-.498752),new I(.146613,-.81581903,-.55941403),new I(-.71651602,-.69435602,-.066887997),new I(.50397199,-.114202,-.85613698),new I(.45549101,.87262702,-.176211),new I(-.00501,-.114373,-.99342501),new I(-.104675,-.327701,-.93896502),new I(.56041199,.75258899,-.34575599),new I(-.060575999,.82162797,-.566796),new I(-.30234101,.79700702,-.522847),new I(-.671543,.67074001,-.314863),new I(-.77840102,-.12835699,.61450499),new I(-.92404997,.278382,-.261985),new I(-.69977301,-.55049098,-.45527801),new I(-.56824797,-.51718903,-.64000797),new I(.054097999,-.93286401,-.356143),new I(.75838202,.57289302,-.31088799),new I(.0036200001,.30502599,-.95233703),new I(-.060849998,-.98688602,-.14951099),new I(.63523,.045478001,-.77098298),new I(.52170497,.241309,-.81828701),new I(.26940399,.63542497,-.72364098),new I(.045676,.67275399,-.738455),new I(-.180511,.67465699,-.71571898),new I(-.397131,.63664001,-.66104198),new I(-.55200398,.47251499,-.687038),new I(-.77217001,.08309,-.62996),new I(-.669819,-.119533,-.73284),new I(-.54045498,-.31844401,-.77878201),new I(-.38613501,-.522789,-.75999397),new I(-.261466,-.68856698,-.676395),new I(-.019412,-.69610298,-.71767998),new I(.30356899,-.48184401,-.82199299),new I(.68193901,-.19512901,-.70490003),new I(-.24488901,-.116562,-.96251899),new I(.80075902,-.022979001,-.59854603),new I(-.37027499,.095583998,-.92399102),new I(-.33067101,-.32657799,-.88543999),new I(-.16322,-.52757901,-.83367902),new I(.12639,-.313146,-.941257),new I(.34954801,-.27222601,-.89649802),new I(.23991799,-.085825004,-.96699202),new I(.390845,.081537001,-.91683799),new I(.25526699,.26869699,-.92878503),new I(.146245,.48043799,-.86474901),new I(-.32601601,.47845599,-.81534898),new I(-.46968201,-.112519,-.87563598),new I(.81844002,-.25852001,-.51315099),new I(-.474318,.292238,-.83043301),new I(.778943,.39584199,-.48637101),new I(.62409401,.39377299,-.67487001),new I(.74088597,.203834,-.63995302),new I(.48021701,.565768,-.67029703),new I(.38093001,.42453501,-.82137799),new I(-.093422003,.50112402,-.86031801),new I(-.236485,.29619801,-.92538702),new I(-.131531,.093959004,-.98684901),new I(-.82356203,.29577699,-.48400599),new I(.61106598,-.624304,-.486664),new I(.069495998,-.52033001,-.85113299),new I(.226522,-.66487902,-.711775),new I(.47130799,-.56890398,-.67395699),new I(.38842499,-.74262398,-.54556),new I(.78367501,-.48072901,-.39338499),new I(.962394,.135676,-.235349),new I(.876607,.172034,-.449406),new I(.63340503,.58979303,-.50094098),new I(.182276,.80065799,-.57072097),new I(.177003,.76413399,.62029701),new I(-.544016,.675515,-.49772099),new I(-.67929697,.28646699,-.67564201),new I(-.59039098,.091369003,-.801929),new I(-.82436001,-.13312399,-.55018902),new I(-.71579403,-.33454201,-.61296099),new I(.17428599,-.89248401,.416049),new I(-.082528003,-.83712298,-.54075301),new I(.28333101,-.88087398,-.37918901),new I(.675134,-.42662701,-.60181701),new I(.84372002,-.512335,-.160156),new I(.97730398,-.098555997,-.18752),new I(.846295,.522672,-.102947),new I(.67714101,.72132498,-.145501),new I(.32096499,.87089199,-.37219399),new I(-.178978,.911533,-.37023601),new I(-.44716901,.82670099,-.341474),new I(-.70320302,.496328,-.50908101),new I(-.97718102,.063562997,-.202674),new I(-.87817001,-.412938,.241455),new I(-.83583099,-.35855001,-.415728),new I(-.499174,-.69343299,-.51959199),new I(-.188789,-.92375302,-.33322501),new I(.19225401,-.96936101,-.152896),new I(.51594001,-.783907,-.34539199),new I(.90592498,-.30095199,-.29787099),new I(.99111199,-.127746,.037106998),new I(.99513501,.098424003,-.0043830001),new I(.76012301,.64627701,.067367002),new I(.205221,.95958,-.192591),new I(-.042750001,.97951299,-.19679099),new I(-.43801701,.89892697,.0084920004),new I(-.82199401,.48078501,-.30523899),new I(-.89991701,.081710003,-.42833701),new I(-.92661202,-.144618,-.347096),new I(-.79365999,-.55779201,-.24283899),new I(-.43134999,-.84777898,-.30855799),new I(-.0054919999,-.96499997,.26219299),new I(.58790499,-.80402601,-.088940002),new I(.69949299,-.66768599,-.254765),new I(.88930303,.359795,-.282291),new I(.780972,.197037,.59267199),new I(.52012098,.50669599,.68755698),new I(.40389499,.69396102,.59605998),new I(-.154983,.89923602,.40909001),new I(-.65733802,.53716803,.528543),new I(-.74619502,.33409101,.575827),new I(-.62495202,-.049144,.77911502),new I(.31814101,-.254715,.913185),new I(-.555897,.405294,.725752),new I(-.79443401,.099405997,.59916002),new I(-.64036101,-.68946302,.33849499),new I(-.12671299,-.73409498,.66711998),new I(.105457,-.78081697,.61579502),new I(.40799299,-.48091599,.77605498),new I(.69513601,-.54512,.468647),new I(.97319102,-.0064889998,.229908),new I(.94689399,.317509,-.050799001),new I(.56358302,.82561201,.027183),new I(.325773,.94542301,.0069490001),new I(-.171821,.98509699,-.0078149997),new I(-.67044097,.73993897,.054768998),new I(-.822981,.55496198,.121322),new I(-.96619302,.117857,.229307),new I(-.95376903,-.29470399,.058945),new I(-.86438698,-.50272799,-.010015),new I(-.53060901,-.84200603,-.097365998),new I(-.162618,-.98407501,.071772002),new I(.081446998,-.99601102,.036439002),new I(.74598402,-.66596299,.00076199998),new I(.94205701,-.32926899,-.064106002),new I(.93970197,-.28108999,.194803),new I(.77121401,.55067003,.319363),new I(.641348,.73069,.23402099),new I(.080682002,.99669099,.0098789996),new I(-.046725001,.97664303,.20972501),new I(-.53107601,.82100099,.209562),new I(-.69581503,.65599,.29243499),new I(-.97612202,.216709,-.014913),new I(-.96166098,-.14412899,.23331399),new I(-.772084,-.61364698,.165299),new I(-.44960001,-.83605999,.314426),new I(-.39269999,-.91461599,.096247002),new I(.390589,-.91947001,.044890001),new I(.58252901,-.79919797,.148127),new I(.866431,-.48981199,.096864),new I(.90458697,.111498,.41145),new I(.95353699,.23232999,.191806),new I(.497311,.77080297,.398177),new I(.194066,.95631999,.218611),new I(.422876,.882276,.206797),new I(-.373797,.84956598,.37217399),new I(-.53449702,.71402299,.4522),new I(-.881827,.23716,.40759799),new I(-.904948,-.014069,.42528901),new I(-.751827,-.51281703,.41445801),new I(-.50101501,-.69791698,.51175803),new I(-.23519,-.92592299,.295555),new I(.228983,-.95393997,.193819),new I(.734025,-.63489801,.241062),new I(.91375297,-.063253,-.40131599),new I(.90573502,-.161487,.391875),new I(.85892999,.342446,.38074899),new I(.62448603,.60758102,.49077699),new I(.28926399,.85747898,.42550799),new I(.069968,.90216899,.42567101),new I(-.28617999,.94069999,.182165),new I(-.57401299,.80511898,-.14930899),new I(.111258,.099717997,-.98877603),new I(-.30539301,-.94422799,-.12316),new I(-.60116601,-.78957599,.123163),new I(-.290645,-.81213999,.50591898),new I(-.064920001,-.87716299,.47578499),new I(.408301,-.862216,.29978901),new I(.56609702,-.72556603,.39126399),new I(.83936399,-.427387,.33586901),new I(.81889999,-.041305002,.57244802),new I(.71978402,.41499701,.55649698),new I(.88174403,.45027,.140659),new I(.40182301,-.89822,-.17815199),new I(-.054019999,.79134399,.60898),new I(-.29377401,.76399398,.57446498),new I(-.450798,.61034697,.65135098),new I(-.63822103,.186694,.74687302),new I(-.87287003,-.25712699,.41470799),new I(-.58725703,-.52170998,.618828),new I(-.35365799,-.64197397,.680291),new I(.041648999,-.61127299,.79032302),new I(.348342,-.77918297,.52108699),new I(.499167,-.62244099,.602826),new I(.79001898,-.30383101,.53250003),new I(.66011798,.060733002,.74870199),new I(.60492098,.29416099,.73996001),new I(.38569701,.37934601,.84103203),new I(.239693,.207876,.94833201),new I(.012623,.25853199,.96591997),new I(-.100557,.457147,.88368797),new I(.046967,.62858802,.77631903),new I(-.43039101,-.44540501,.785097),new I(-.43429101,-.196228,.87913901),new I(-.25663701,-.336867,.90590203),new I(-.131372,-.15891001,.97851402),new I(.102379,-.208767,.972592),new I(.195687,-.450129,.87125802),new I(.62731898,-.42314801,.65377098),new I(.68743902,-.171583,.70568198),new I(.27592,-.021255,.96094602),new I(.45936701,.15746599,.87417799),new I(.285395,.583184,.76055598),new I(-.81217402,.46030301,.35846099),new I(-.189068,.64122301,.743698),new I(-.338875,.47648001,.811252),new I(-.92099398,.347186,.176727),new I(.040638998,.024465,.99887401),new I(-.73913199,-.35374701,.57318997),new I(-.60351199,-.28661501,.74405998),new I(-.188676,-.547059,.81555402),new I(-.026045,-.39782,.91709399),new I(.26789701,-.649041,.71202302),new I(.518246,-.28489101,.80638599),new I(.493451,-.066532999,.86722499),new I(-.328188,.140251,.93414301),new I(.328188,.140251,.93414301),new I(-.328188,.140251,.93414301),new I(-.328188,.140251,.93414301),new I(-.328188,.140251,.93414301)])}}}),System.register("data/vxl/Section",["data/vxl/normals","data/vxl/VoxelField"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("Section",class{get spanX(){return this.maxBounds.x-this.minBounds.x}get spanY(){return this.maxBounds.y-this.minBounds.y}get spanZ(){return this.maxBounds.z-this.minBounds.z}get scaleX(){return this.spanX/this.sizeX}get scaleY(){return this.spanY/this.sizeY}get scaleZ(){return this.spanZ/this.sizeZ}get scale(){return new THREE.Vector3(this.scaleX,this.scaleY,this.scaleZ)}getAllVoxels(){let g=[],P=new L.VoxelField(this.sizeX+1,this.sizeY+1,this.sizeZ+1);for(let L=0,U=this.spans.length;L<U;L++){var I=this.spans[L].voxels;for(let L=0,U=I.length;L<U;L++){var _=I[L];g.push(_),P.add(_)}}return{voxels:g,voxelField:P}}getNormals(){switch(this.normalsMode){case 1:return I.normals1;case 2:return I.normals2;case 3:return I.normals3;case 4:return I.normals4;default:throw new Error("Invalid normalsmode "+this.normalsMode)}}scaleHvaMatrix(g){return(g=g.clone()).elements[12]*=this.hvaMultiplier,g.elements[13]*=this.hvaMultiplier,g.elements[14]*=this.hvaMultiplier,g}toPlain(){return{name:this.name,normalsMode:this.normalsMode,minBounds:this.minBounds.toArray(),maxBounds:this.maxBounds.toArray(),sizeX:this.sizeX,sizeY:this.sizeY,sizeZ:this.sizeZ,hvaMultiplier:this.hvaMultiplier,transfMatrix:this.transfMatrix.toArray(),spans:this.spans}}fromPlain(g){return this.name=g.name,this.normalsMode=g.normalsMode,this.minBounds=(new THREE.Vector3).fromArray(g.minBounds),this.maxBounds=(new THREE.Vector3).fromArray(g.maxBounds),this.sizeX=g.sizeX,this.sizeY=g.sizeY,this.sizeZ=g.sizeZ,this.hvaMultiplier=g.hvaMultiplier,this.transfMatrix=(new THREE.Matrix4).fromArray(g.transfMatrix),this.spans=g.spans,this}})}}}),System.register("data/vxl/Span",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("data/vxl/SpanOffsets",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("data/vxl/Voxel",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("data/vxl/VoxelField",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("VoxelField",class{constructor(g,P,I){this.sizeX=g,this.sizeY=P,this.sizeZ=I,this.arr=new Array(g*P*I)}add(g){this.arr[g.x+g.y*this.sizeX+g.z*this.sizeX*this.sizeY]=g}get(g,P,I){if(!(g>=this.sizeX||P>=this.sizeY||I>=this.sizeZ))return this.arr[g+P*this.sizeX+I*this.sizeX*this.sizeY]}})}}}),System.register("data/vxl/VxlHeader",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){g("VxlHeader",I=class{read(g){this.fileName=g.readCString(16),this.paletteCount=g.readUint32(),this.headerCount=g.readUint32(),this.tailerCount=g.readUint32(),this.bodySize=g.readUint32(),this.paletteRemapStart=g.readUint8(),this.paletteRemapEnd=g.readUint8(),g.seek(g.position+768)}}),I.size=32}}}),System.register("data/VxlFile",["data/vfs/VirtualFile","data/vxl/Section","data/vxl/VxlHeader"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("VxlFile",class{constructor(g){this.voxelCount=0,g instanceof I.VirtualFile&&this.fromVirtualFile(g)}fromVirtualFile(g){this.filename=g.filename;let P=g.stream;if(this.sections=[],!(P.byteLength<_.VxlHeader.size)){let g=new _.VxlHeader;if(g.read(P),g.headerCount&&g.tailerCount&&g.tailerCount===g.headerCount){for(let I=0;I<g.headerCount;++I){const g=new L.Section;this.readSectionHeader(g,P),this.sections.find(P=>P.name===g.name)&&console.warn(`Duplicate section name "${g.name}" found in VXL "${this.filename}".`),this.sections.push(g)}var I=P.position;P.seek(P.position+g.bodySize);let _=[];for(let I=0;I<g.tailerCount;++I)_[I]=this.readSectionTailer(this.sections[I],P);let U=0;for(let L=0;L<g.headerCount;++L)P.seek(I),U+=this.readSectionBodySpans(this.sections[L],_[L],P);this.voxelCount=U}}}readSectionHeader(g,P){g.name=P.readCString(16),P.readUint32(),P.readUint32(),P.readUint32()}readSectionTailer(g,P){var I=P.readUint32(),L=P.readUint32(),_=P.readUint32();return g.hvaMultiplier=P.readFloat32(),g.transfMatrix=this.readTransfMatrix(P),g.minBounds=new THREE.Vector3(P.readFloat32(),P.readFloat32(),P.readFloat32()),g.maxBounds=new THREE.Vector3(P.readFloat32(),P.readFloat32(),P.readFloat32()),g.sizeX=P.readUint8(),g.sizeY=P.readUint8(),g.sizeZ=P.readUint8(),g.normalsMode=P.readUint8(),{startingSpanOffset:I,endingSpanOffset:L,dataSpanOffset:_}}readTransfMatrix(g){let P=[];for(let I=0;I<3;++I)P.push(g.readFloat32(),g.readFloat32(),g.readFloat32(),g.readFloat32());return P.push(0,0,0,1),(new THREE.Matrix4).fromArray(P).transpose()}readSectionBodySpans(g,P,I){I.seek(I.position+P.startingSpanOffset);var{sizeX:L,sizeY:_,sizeZ:U}=g;let G=new Array(_);for(let g=0;g<_;++g){G[g]=new Array(L);for(let P=0;P<L;++P)G[g][P]=I.readInt32()}let V=new Array(_);for(let g=0;g<_;++g){V[g]=new Array(L);for(let P=0;P<L;++P)V[g][P]=I.readInt32()}let W=g.spans=[],z=0;for(let g=0;g<_;++g)for(let P=0;P<L;++P){var K={x:P,y:g,voxels:this.readSpanVoxels(G[g][P],V[g][P],P,g,U,I)};W.push(K),z+=K.voxels.length}return z}readSpanVoxels(g,P,I,L,_,U){if(-1===g||-1===P)return[];let G=[];for(let g=0;g<_;){g+=U.readUint8();var V=U.readUint8();for(let P=0;P<V;++P){var W={x:I,y:L,z:g++,colorIndex:U.readUint8(),normalIndex:U.readUint8()};G.push(W)}U.readUint8()}return G}fromPlain(g){return this.sections=g.sections.map(g=>(new L.Section).fromPlain(g)),this.voxelCount=g.voxelCount,this}toPlain(){return{sections:this.sections.map(g=>g.toPlain()),voxelCount:this.voxelCount}}getSection(g){return this.sections[g]}})}}}),System.register("data/WavFile",["wavefile","data/vfs/VirtualFile"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("WavFile",class{constructor(g){g instanceof Uint8Array?this.fromRawData(g):g instanceof L.VirtualFile&&this.fromVirtualFile(g)}fromRawData(g){return this.rawData=g,this}fromVirtualFile(g){var P=g.stream;return this.rawData=new Uint8Array(P.buffer,P.byteOffset,P.byteLength),this}getRawData(){return this.rawData}getData(){if(!this.decodedData){if(!this.rawData)throw new Error("No data loaded");this.decodedData=this.decodeData(this.rawData),this.rawData=void 0}return this.decodedData}setData(g){this.rawData=void 0,this.decodedData=g}decodeData(g){let P=new I.WaveFile(g);return"4"===P.bitDepth&&P.fromIMAADPCM(),P.toBuffer()}isRawImaAdpcm(){return this.rawData&&"4"===new I.WaveFile(this.rawData).bitDepth}})}}}),System.register("data/zip/Zip",["data/Crc32","data/zip/ZipUtils"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("Zip",class{constructor(g=!1){this.zip64=g,console.info("Started zip with zip64: "+this.zip64),this.fileRecord=[],this.finished=!1,this.byteCounterBig=BigInt(0),this.outputStream=new ReadableStream({start:g=>{console.info("OutputStream has started!"),this.outputController=g},cancel:()=>{console.info("OutputStream has been canceled!")}})}enqueue(g){this.outputController.enqueue(g)}close(){this.outputController.close()}getZip64ExtraField(g,P){return L.ZipUtils.createByteArray([{data:1,size:2},{data:28,size:2},{data:g,size:8},{data:g,size:8},{data:P,size:8},{data:0,size:4}])}isWritingFile(){return 0<this.fileRecord.length&&!1===this.fileRecord[this.fileRecord.length-1].done}startFile(g,P){if(this.isWritingFile()||this.finished)throw new Error("Tried adding file while adding other file or while zip has finished");console.info("Start file: "+g);var _=new Date(P);this.fileRecord=[...this.fileRecord,{name:g,sizeBig:BigInt(0),crc:new I.Crc32,done:!1,date:_,headerOffsetBig:this.byteCounterBig}];var U=(new TextEncoder).encode(g);U=L.ZipUtils.createByteArray([{data:67324752,size:4},{data:45,size:2},{data:2056,size:2},{data:0,size:2},{data:L.ZipUtils.getTimeStruct(_),size:2},{data:L.ZipUtils.getDateStruct(_),size:2},{data:0,size:4},{data:this.zip64?4294967295:0,size:4},{data:this.zip64?4294967295:0,size:4},{data:U.length,size:2},{data:this.zip64?32:0,size:2},{data:U},{data:this.zip64?this.getZip64ExtraField(BigInt(0),this.byteCounterBig):[]}]);this.enqueue(U),this.byteCounterBig+=BigInt(U.length)}appendData(g){if(!this.isWritingFile()||this.finished)throw new Error("Tried to append file data, but there is no open file!");this.enqueue(g),this.byteCounterBig+=BigInt(g.length),this.fileRecord[this.fileRecord.length-1].crc.append(g),this.fileRecord[this.fileRecord.length-1].sizeBig+=BigInt(g.length)}endFile(){if(!this.isWritingFile()||this.finished)throw new Error("Tried to end file, but there is no open file!");{const P=this.fileRecord[this.fileRecord.length-1];console.info("End file: "+P.name);var g=L.ZipUtils.createByteArray([{data:P.crc.get(),size:4},{data:P.sizeBig,size:this.zip64?8:4},{data:P.sizeBig,size:this.zip64?8:4}]);this.enqueue(g),this.byteCounterBig+=BigInt(g.length),this.fileRecord[this.fileRecord.length-1].done=!0}}finish(){if(this.isWritingFile()||this.finished)throw new Error("Empty zip, or there is still a file open");{console.info("Finishing zip");let _=BigInt(0);var g,P,I=this.byteCounterBig;this.fileRecord.forEach(g=>{const{date:P,crc:I,sizeBig:U,name:G,headerOffsetBig:V}=g;var W=(new TextEncoder).encode(G);W=L.ZipUtils.createByteArray([{data:33639248,size:4},{data:45,size:2},{data:45,size:2},{data:2056,size:2},{data:0,size:2},{data:L.ZipUtils.getTimeStruct(P),size:2},{data:L.ZipUtils.getDateStruct(P),size:2},{data:I.get(),size:4},{data:this.zip64?4294967295:U,size:4},{data:this.zip64?4294967295:U,size:4},{data:W.length,size:2},{data:this.zip64?32:0,size:2},{data:0,size:2},{data:0,size:2},{data:0,size:2},{data:0,size:4},{data:this.zip64?4294967295:V,size:4},{data:W},{data:this.zip64?this.getZip64ExtraField(U,V):[]}]);this.enqueue(W),this.byteCounterBig+=BigInt(W.length),_+=BigInt(W.length)}),this.zip64&&(P=this.byteCounterBig,g=L.ZipUtils.createByteArray([{data:101075792,size:4},{data:44,size:8},{data:45,size:2},{data:45,size:2},{data:0,size:4},{data:0,size:4},{data:this.fileRecord.length,size:8},{data:this.fileRecord.length,size:8},{data:_,size:8},{data:I,size:8}]),this.enqueue(g),this.byteCounterBig+=BigInt(g.length),P=L.ZipUtils.createByteArray([{data:117853008,size:4},{data:0,size:4},{data:P,size:8},{data:1,size:4}]),this.enqueue(P),this.byteCounterBig+=BigInt(P.length)),I=L.ZipUtils.createByteArray([{data:101010256,size:4},{data:0,size:2},{data:0,size:2},{data:this.zip64?65535:this.fileRecord.length,size:2},{data:this.zip64?65535:this.fileRecord.length,size:2},{data:this.zip64?4294967295:_,size:4},{data:this.zip64?4294967295:I,size:4},{data:0,size:2}]),this.enqueue(I),this.close(),this.byteCounterBig+=BigInt(I.length),this.finished=!0,console.info(`Done writing zip file. Wrote ${this.fileRecord.length} files and a total of ${this.byteCounterBig} bytes.`)}}})}}}),System.register("data/zip/ZipUtils",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("ZipUtils",class{static createByteArray(g){var P=g.reduce((g,P)=>g+(P.size||P.data.length),0);const I=new Uint8Array(P),L=new DataView(I.buffer);let _=0;return g.forEach(g=>{if(void 0!==g.data.length)I.set(g.data,_),_+=g.data.length;else{switch(g.size){case 1:L.setInt8(_,parseInt(g.data));break;case 2:L.setInt16(_,parseInt(g.data),!0);break;case 4:L.setInt32(_,parseInt(g.data),!0);break;case 8:L.setBigInt64(_,BigInt(g.data),!0);break;default:throw new Error("createByteArray: No handler defined for data size "+g.size+" of entry data "+JSON.stringify(g.data))}_+=g.size}}),I}static getTimeStruct(g){return(g.getHours()<<6|g.getMinutes())<<5|g.getSeconds()/2}static getDateStruct(g){return(g.getFullYear()-1980<<4|g.getMonth()+1)<<5|g.getDate()}})}}}),System.register("engine/Animation",["util/math"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){var P;(P=L||g("AnimationState",L={}))[P.NOT_STARTED=0]="NOT_STARTED",P[P.RUNNING=1]="RUNNING",P[P.STOPPED=2]="STOPPED",P[P.DELAYED=3]="DELAYED",P[P.PAUSED=4]="PAUSED",g("Animation",class{constructor(g,P){this.props=g,this.state=L.NOT_STARTED,this.endLoopFlag=!1,this.playToEndFlag=!1,this.speed=P}getState(){return this.state}start(g,P=0){this.time=g,this.frameNo=this.props.reverse?this.props.end:this.props.start,this.loopNo=0,this.delayFrames=P,this.state=P?L.DELAYED:L.RUNNING}pause(){this.state===L.RUNNING&&(this.state=L.PAUSED)}unpause(){this.state===L.PAUSED&&(this.state=L.RUNNING)}reset(){this.state=L.NOT_STARTED}stop(){this.state=L.STOPPED}update(g){var P=(g-this.time)/1e3,I=this.props.rate*this.speed.value;if(!((I=Math.floor(P*I))<1)&&(this.time=g,this.state!==L.PAUSED)){if(0<this.delayFrames){if(this.delayFrames=Math.max(0,this.delayFrames-I),0<this.delayFrames)return void(this.state=L.DELAYED);this.state=L.RUNNING}this.computeNextFrame(I)&&(this.state=L.STOPPED)}}endLoop(){this.endLoopFlag=!0}endLoopAndPlayToEnd(){this.endLoopFlag=!0,this.playToEndFlag=!0}rewind(){this.props.reverse?this.frameNo=this.loopNo?this.props.loopEnd:this.props.end:this.frameNo=this.loopNo?this.props.loopStart:this.props.start}getCurrentFrame(){return this.frameNo}computeNextFrame(g){let P=this.frameNo;for(;0<g;){var _=this.endLoopFlag&&this.playToEndFlag?this.props.reverse?this.props.start:this.props.end:this.props.reverse?this.props.loopStart:this.props.loopEnd;if(!this.props.reverse&&P+g<=_||this.props.reverse&&P-g>=_){P+=this.props.reverse?-g:g;break}if(-1!==this.props.loopCount&&this.loopNo>=this.props.loopCount-1)return this.frameNo=_,!0;if(this.endLoopFlag)return!(this.endLoopFlag=!1);g-=1+(this.props.reverse?P-_:_-P),P=this.props.reverse?this.props.loopEnd:this.props.loopStart,this.loopNo++,this.props.randomLoopDelay&&(this.state=L.DELAYED,this.delayFrames=I.getRandomInt(this.props.randomLoopDelay[0],this.props.randomLoopDelay[1]))}return this.frameNo=P,!1}})}}}),System.register("engine/animation/Runner",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("engine/animation/SimpleRunner",["engine/Animation"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("SimpleRunner",class{tick(g){let P=this.animation;if(P)switch(P.getState()){case I.AnimationState.STOPPED:return;case I.AnimationState.NOT_STARTED:P.start(g);case I.AnimationState.RUNNING:default:P.update(g)}}getCurrentFrame(){return this.animation.getCurrentFrame()}shouldUpdate(){return this.animation.getState()!==I.AnimationState.STOPPED}})}}}),System.register("engine/AnimProps",["game/GameSpeed","util/math"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("AnimProps",_=class s{constructor(g,P){this.art=g,this.init(P)}init(g){this.shadow=this.art.getBool("Shadow"),this.reverse=this.art.getBool("Reverse"),this.frameCount="number"==typeof g?g:this.shadow?g.numImages/2:g.numImages,this.end=this.art.getNumber("End",this.frameCount-1);var P=this.art.getNumberArray("RandomRate").sort();2===P.length?this.rate=L.getRandomInt(P[0],P[1])/60:this.rate=this.art.getNumber("Rate",60*s.defaultRate)/60,this.start=this.art.getNumber("Start",0),this.loopStart=this.art.getNumber("LoopStart",0),this.loopEnd=Math.max(this.loopStart,this.art.getNumber("LoopEnd",this.end+1)-1),this.loopCount=this.art.getNumber("LoopCount",1),P=this.art.getNumberArray("RandomLoopDelay").sort(),this.randomLoopDelay=2===P.length?[P[0],P[1]]:void 0}getArt(){return this.art}setArt(g){this.art=g,this.init(this.frameCount)}}),_.defaultRate=I.GameSpeed.BASE_TICKS_PER_SECOND}}}),System.register("engine/AsyncResourceCollection",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("engine/Engine",["data/IniFile","data/ShpFile","data/VxlFile","data/TmpFile","data/Palette","engine/Theater","engine/TheaterType","version","data/vfs/VirtualFileSystem","data/vfs/RealFileSystem","engine/LazyResourceCollection","data/WavFile","engine/LazyAsyncResourceCollection","data/Mp3File","engine/mixDatabase","engine/gameRes/GameResSource","data/Crc32","game/ini/GameModes","util/string","engine/MapList","data/HvaFile","game/ini/MixinRulesType","engine/EngineType"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce;return P&&P.id,{setters:[function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g}],execute:function(){g("Engine",ce=class{static getVersion(){return K.version.split(".").slice(0,2).join(".")}static getModHash(){if(!this.modHash)throw new Error("Rules must be loaded first");return this.modHash}static getActiveMod(){return this.activeMod}static setActiveMod(g){this.activeMod=g}static initGameResSource(g){this.gameResSource=g}static async initRfs(g){let P=this.rfs=new $.RealFileSystem;return P.addRootDirectoryHandle(g),P}static async initVfs(g,P){return this.vfs=new q.VirtualFileSystem(g,P),I.iniFiles.setVfs(this.vfs),I.palettes.setVfs(this.vfs),I.images.setVfs(this.vfs),I.voxels.setVfs(this.vfs),I.voxelAnims.setVfs(this.vfs),I.tileData.setVfs(this.vfs),I.sounds.setVfs(this.vfs),I.themes.setDir(await(this.rfs?.findDirectory(I.rfsSettings.musicDir))),I.taunts.setDir(await(this.rfs?.findDirectory(I.rfsSettings.tauntsDir))),this.vfs}static supportsTheater(g){var P=this.getActiveEngine();return this.theaterSettings.get(P)?.some(P=>P.type===g)||!1}static getTheaterSettings(g,P){if(!this.theaterSettings.has(g))throw new Error('Unknown engineType "'+g);var I=this.theaterSettings.get(g).find(g=>g.type===P);if(!I)throw new Error(`Unsupported theater "${z.TheaterType[P]}"`);return I}static async loadTheater(g){if(!I.rules||!I.art)throw new Error("Rules and art should be loaded first");if(void 0===I.gameResSource)throw new Error("No gameResSource is set");var P=I.getActiveEngine();let L;var _,U=I.getTheaterSettings(P,g);if(I.gameResSource!==ee.GameResSource.Cdn)for(var G of U.mixes)await I.vfs.addMixFile(G);return I.theaters.has(g)?L=I.theaters.get(g):(_=I.getTheaterIni(P,g),P=I.getTileData(),L=W.Theater.factory(g,_,U,P,I.palettes),I.theaters.set(g,L)),I.activeTheater=L,L}static unloadTheater(g){if(I.vfs){var P,L=I.getActiveEngine();for(P of I.getTheaterSettings(L,g).mixes)I.vfs.removeArchive(P)}}static unloadSideMixData(){for(var g of["sidec01.mix","sidec01cd.mix"]){var P,L=J.mixDatabase.get(g);if(!L)return void console.warn(`Mix "${g}" not found in mix database`);for(P of L)("pal"===P.split(".").pop()?I.palettes:I.images).clear(P)}}static getTheaterIni(g,P){var L=I.getTheaterSettings(g,P).theaterIni;return I.getIni(L)}static loadRules(){var g=this.getFileNameVariant("rules.ini"),P=this.getFileNameVariant("art.ini"),L=this.getFileNameVariant("ai.ini");let _=this.iniFiles.get(g),U=this.iniFiles.get(P);var G=this.iniFiles.get(L);if(!_)throw new Error(`Rules "${g}" not found`);if(!U)throw new Error(`Art "${P}" not found`);if(!G)throw new Error(`AI "${L}" not found`);if(P=this.iniFiles.get(I.customRulesFileName),L=this.iniFiles.get(I.customArtFileName),!P)throw new Error(`Rules "${I.customRulesFileName}" not found`);if(!L)throw new Error(`Art "${I.customArtFileName}" not found`);I.art=U.clone().mergeWith(L),I.rules=I.patchAudioVisualRules(_.clone().mergeWith(P)),I.ai=G,I.modHash=I.computeModHash()}static patchAudioVisualRules(g){if(this.activeEngine===le.EngineType.YurisRevenge){let I=g.getSection("General");if(I){let L=g.getSection("AudioVisual");var P;for(P of["DamageFireTypes","OreTwinkle","BarrelExplode","BarrelDebris","BarrelParticle","NukeTakeOff","Wake","DropPod","DeadBodies","MetallicDebris","BridgeExplosions","IonBlast","IonBeam","WeatherConClouds","WeatherConBolts","WeatherConBoltExplosion","DominatorWarhead","DominatorDamage","DominatorCaptureRange","DominatorFirstAnim","DominatorSecondAnim","DominatorFireAtPercentage","ChronoPlacement","ChronoBeam","ChronoBlast","ChronoBlastDest","WarpIn","WarpOut","WarpAway","IronCurtainInvokeAnim","ForceShieldInvokeAnim","WeaponNullifyAnim","ChronoSparkle1","InfantryExplode","FlamingInfantry","InfantryHeadPop","InfantryNuked","InfantryVirus","InfantryBrute","InfantryMutate","Behind","MoveFlash","Parachute","BombParachute","DropZoneAnim","EMPulseSparkles"])L?.set(P,I.getString(P))}}return g}static computeModHash(){if(!this.vfs)throw new Error("VFS not initialized");let g=[this.customRulesFileName,this.customArtFileName,this.customMpModesFileName,this.shroudFileName,this.getFileNameVariant("rules.ini"),this.getFileNameVariant("art.ini"),this.getFileNameVariant("ai.ini"),...I.mixinRulesFileNames.values()];var P,L,_,U=this.theaterSettings.get(this.getActiveEngine());if(!U)throw new Error('Unsupported engineType "'+this.getActiveEngine());for(P of U)g.push(P.theaterIni);let G=this.getMpModes();for(L of G.getAll())g.push(L.rulesOverride);let V=new te.Crc32;for(_ of g){if(!this.vfs.fileExists(_))throw new Error(`File ${_} not found`);var W=this.vfs.openFile(_).stream;V.append(new Uint8Array(W.buffer,W.byteOffset,W.byteLength))}return V.append(se.binaryStringToUint8Array(this.getVersion())),V.get()}static getRules(){if(!I.rules)throw new Error("Rules must be loaded first");return I.rules}static getArt(){if(!I.art)throw new Error("Art must be loaded first");return I.art}static getAi(){if(!I.ai)throw new Error("AI must be loaded first");return I.ai}static getFileNameVariant(g){var P=this.getActiveEngine();let I;if(P===le.EngineType.YurisRevenge)I="md";else{if(P!==le.EngineType.RedAlert2)throw new Error("Unsupported engine type "+le.EngineType[P]);I=""}return I?g.replace(/\.([^.]+)$/,I+".$1"):g}static getMpModes(){return new re.GameModes(this.getIni(this.customMpModesFileName),g=>this.getIni(g))}static getSoundIni(){var g=this.getIni("soundcd.ini");return this.getIni(this.getFileNameVariant("sound.ini")).clone().mergeWith(g)}static getUiIni(){var g=this.getFileNameVariant("ui.ini");return this.getIni(g)}static getIni(g){if(!this.iniFiles.has(g))throw new Error(`INI file ${g} not found.`);return this.iniFiles.get(g)}static async loadMapList(){if(!this.vfs)throw new Error("File system not initialized");var g,P,_,U=this.getMpModes();let G=new ae.MapList(U);for(g of(G.addFromIni(this.getIni(this.getFileNameVariant("missions.pkt"))),this.vfs.listArchives())){var V=g.toLowerCase().replace(/\.[^.]+$/,"")+".pkt";this.vfs.fileExists(V)&&G.addFromIni(new L.IniFile(this.vfs.openFile(V)))}let W=new ae.MapList(U),z=this.supportedMapTypes.get(this.getActiveEngine());if(!z)throw new Error(`No map types defined for engine type "${I.getActiveEngine()}"`);if(this.rfs)for await(var K of this.rfs.getEntries()){let I=K.toLowerCase();try{I.endsWith(".pkt")?(P=new L.IniFile(await this.rfs.openFile(K,!0)),G.addFromIni(P)):z.some(g=>I.endsWith("."+g))&&(_=await this.rfs.openFile(K,!0),W.addFromMapFile(_))}catch(g){console.warn(`Couldn't read file "${K}"`,g)}}return W.sortByName(),G.mergeWith(W),this.mapList=G,G}static getTileData(){return I.tileData}static getImages(){return I.images}static getVoxels(){return I.voxels}static getVoxelAnims(){return I.voxelAnims}static getPalettes(){return I.palettes}static getSounds(){return I.sounds}static getThemes(){return I.themes}static getTaunts(){return I.taunts}static getActiveEngine(){if(!this.activeEngine)throw new Error("Engine type not initialized");return this.activeEngine}static setActiveEngine(g){this.activeEngine=g}static getLastTheaterType(){return I.activeTheater?.type}static getCacheDir(){try{return this.getOrCreateDir(this.rfsSettings.cacheDir,!0)}catch(g){return void console.error("Couldn't get cache directory",[g])}}static async getReplayDir(){var g=this.getActiveMod();if(g){let P=await this.getModDir(),L=await(P?.getDirectory(g));return L?.getOrCreateDirectory(I.rfsSettings.replayDir)}return this.getOrCreateDir(this.rfsSettings.replayDir)}static getModDir(){return this.getOrCreateDir(I.rfsSettings.modDir)}static getMapDir(){return this.getOrCreateDir(I.rfsSettings.mapDir)}static async getOrCreateDir(g,P=!1){let I=this.rfs?.getRootDirectory();if(I)return await I.getOrCreateDirectory(g,P)}static getMapList(){return this.mapList}static destroy(){this.activeEngine=void 0,this.activeTheater=void 0,this.activeMod=void 0,this.modHash=void 0,this.mapList=void 0,this.rfs=void 0,this.vfs=void 0,this.art=void 0,this.iniFiles.clear(),this.images.clear(),this.palettes.clear(),this.rules=void 0,this.ai=void 0,this.theaters.clear(),this.tileData.clear(),this.voxels.clear(),this.voxelAnims.clear()}}),(I=ce).UI_ANIM_SPEED=2,ce.rfsSettings={menuVideoFileName:"ra2ts_l.webm",splashImgFileName:"glsl.png",mapDir:"maps",modDir:"mods",musicDir:"music",tauntsDir:"Taunts",cacheDir:"cache",replayDir:"replays"},ce.supportedMapTypes=new Map([[le.EngineType.RedAlert2,["mpr","map"]],[le.EngineType.YurisRevenge,["mpr","map","yrm"]]]),ce.images=new Q.LazyResourceCollection(g=>new _.ShpFile(g)),ce.voxels=new Q.LazyResourceCollection(g=>new U.VxlFile(g)),ce.voxelAnims=new Q.LazyResourceCollection(g=>new ne.HvaFile(g)),ce.sounds=new Q.LazyResourceCollection(g=>new Y.WavFile(g)),ce.themes=new Z.LazyAsyncResourceCollection(g=>new X.Mp3File(g),!1),ce.taunts=new Z.LazyAsyncResourceCollection(async g=>new Y.WavFile(new Uint8Array(await g.arrayBuffer()))),ce.iniFiles=new Q.LazyResourceCollection(g=>new L.IniFile(g)),ce.tileData=new Q.LazyResourceCollection(g=>new G.TmpFile(g)),ce.palettes=new Q.LazyResourceCollection(g=>new V.Palette(g)),ce.theaters=new Map,ce.theaterSettings=(new Map).set(le.EngineType.RedAlert2,[{type:z.TheaterType.Temperate,theaterIni:"temperat.ini",mixes:["isotemp.mix","temperat.mix","tem.mix"],extension:".tem",newTheaterChar:"T",isoPaletteName:"isotem.pal",unitPaletteName:"unittem.pal",overlayPaletteName:"temperat.pal",libPaletteName:"libtem.pal"},{type:z.TheaterType.Snow,theaterIni:"snow.ini",mixes:["isosnow.mix","snow.mix","sno.mix"],extension:".sno",newTheaterChar:"A",isoPaletteName:"isosno.pal",unitPaletteName:"unitsno.pal",overlayPaletteName:"snow.pal",libPaletteName:"libsno.pal"},{type:z.TheaterType.Urban,theaterIni:"urban.ini",mixes:["isourb.mix","urb.mix","urban.mix"],extension:".urb",newTheaterChar:"U",isoPaletteName:"isourb.pal",unitPaletteName:"uniturb.pal",overlayPaletteName:"urban.pal",libPaletteName:"liburb.pal"}]).set(le.EngineType.YurisRevenge,[{type:z.TheaterType.Temperate,theaterIni:"temperatmd.ini",mixes:["isotemp.mix","isotemmd.mix","temperat.mix","tem.mix"],extension:".tem",newTheaterChar:"T",isoPaletteName:"isotem.pal",unitPaletteName:"unittem.pal",overlayPaletteName:"temperat.pal",libPaletteName:"libtem.pal"},{type:z.TheaterType.Snow,theaterIni:"snowmd.ini",mixes:["isosnomd.mix","snowmd.mix","isosnow.mix","snow.mix","sno.mix"],extension:".sno",newTheaterChar:"A",isoPaletteName:"isosno.pal",unitPaletteName:"unitsno.pal",overlayPaletteName:"snow.pal",libPaletteName:"libsno.pal"},{type:z.TheaterType.Urban,theaterIni:"urbanmd.ini",mixes:["isourbmd.mix","isourb.mix","urb.mix","urban.mix"],extension:".urb",newTheaterChar:"U",isoPaletteName:"isourb.pal",unitPaletteName:"uniturb.pal",overlayPaletteName:"urban.pal",libPaletteName:"liburb.pal"},{type:z.TheaterType.NewUrban,theaterIni:"urbannmd.ini",mixes:["isoubnmd.mix","isoubn.mix","ubn.mix","urbann.mix"],extension:".ubn",newTheaterChar:"N",isoPaletteName:"isoubn.pal",unitPaletteName:"unitubn.pal",overlayPaletteName:"urbann.pal",libPaletteName:"libubn.pal"},{type:z.TheaterType.Desert,theaterIni:"desertmd.ini",mixes:["isodesmd.mix","desert.mix","des.mix","isodes.mix"],extension:".des",newTheaterChar:"D",isoPaletteName:"isodes.pal",unitPaletteName:"unitdes.pal",overlayPaletteName:"desert.pal",libPaletteName:"libdes.pal"},{type:z.TheaterType.Lunar,theaterIni:"lunarmd.ini",mixes:["isolunmd.mix","isolun.mix","lun.mix","lunar.mix"],extension:".lun",newTheaterChar:"L",isoPaletteName:"isolun.pal",unitPaletteName:"unitlun.pal",overlayPaletteName:"lunar.pal",libPaletteName:"liblun.pal"}]),ce.customRulesFileName="rulescd.ini",ce.customArtFileName="artcd.ini",ce.customMpModesFileName="mpmodescd.ini",ce.shroudFileName="shroud.shp",ce.mixinRulesFileNames=(new Map).set(oe.MixinRulesType.NoDogEngiKills,"nodogengikills.ini")}}}),System.register("engine/EngineType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("EngineType",I={}))[P.AutoDetect=0]="AutoDetect",P[P.TiberianSun=1]="TiberianSun",P[P.Firestorm=2]="Firestorm",P[P.RedAlert2=3]="RedAlert2",P[P.YurisRevenge=4]="YurisRevenge"}}}),System.register("engine/GameAnimationLoop",["network/IrcConnection"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("GameAnimationLoop",class{constructor(g,P,L,_,U={}){this.localPlayer=g,this.renderer=P,this.sound=L,this.gameTurnMgr=_,this.options=U,this.isStarted=!1,this.rendererErrorState=!1,this.doBackgroundFrame=g=>{if(this.isStarted&&this.paused){let P=this.updateDeltaGameFrames(g);for(this.turnMgrIsWaiting&&(P=1);0<P;)this.turnMgrIsWaiting=!1===this.tickGame(g),P--}},this.doFrame=g=>{if(this.isStarted&&!this.paused){let L=this.updateDeltaGameFrames(g);(this.turnMgrIsWaiting||!this.options.skipFrames&&1<L)&&(L=1);let _=this.renderer.getStats();if(_&&_.begin(),this.options.skipBudgetMillis){let I=this.options.skipBudgetMillis;for(;0<L;){var P=performance.now();if(this.turnMgrIsWaiting=!1===this.tickGame(g),L--,P=performance.now()-P,I=Math.max(0,I-P),I<=0)break}}else for(;0<L;)this.turnMgrIsWaiting=!1===this.tickGame(g),L--;var I=this.gameTurnMgr.getTurnMillis();I=Math.max(0,(g-(this.startTime+this.lastGameFrame*I))/I);this.updateRenderer(g,I),this.render()&&(_&&_.end(),this.rafId=requestAnimationFrame(this.doFrame))}},this.handleVisibilityChange=()=>{var g=document.hidden;if(this.paused!==g){if(this.localPlayer&&!this.localPlayer.isObserver&&this.paused&&this.doBackgroundFrame(performance.now()),(this.paused=g)||(this.startTime=void 0,this.lastGameFrame=0),this.localPlayer&&!this.localPlayer.isObserver)try{this.gameTurnMgr.setPassiveMode?.(this.paused)}catch(g){if(!(g instanceof I.IrcConnection.SocketError))throw g}this.paused?(this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=void 0),this.backgroundIntervalId=setInterval(()=>{var g=performance.now();this.doBackgroundFrame(g)},1e3)):(this.backgroundIntervalId&&(clearInterval(this.backgroundIntervalId),this.backgroundIntervalId=void 0),this.rafId=requestAnimationFrame(this.doFrame)),this.sound.audioSystem.setMuted(this.paused)}}}start(){this.isStarted||(this.isStarted=!0,this.paused=!1,this.startTime=void 0,this.lastGameFrame=0,document.hidden?this.handleVisibilityChange():this.rafId=requestAnimationFrame(this.doFrame),document.addEventListener("visibilitychange",this.handleVisibilityChange))}updateDeltaGameFrames(g){var P=this.gameTurnMgr.getTurnMillis(),I=P!==this.lastGameTurnMillis;this.lastGameTurnMillis=P,I&&(this.lastGameFrame=0,this.startTime=g);let L=0;return this.startTime?(I=g-this.startTime,L=(P=Math.round(I/P))-this.lastGameFrame,this.lastGameFrame=P):this.startTime=g,L}tickGame(g){if(!this.options.onError)return this.gameTurnMgr.doGameTurn(g);try{return this.gameTurnMgr.doGameTurn(g)}catch(g){return this.gameTurnMgr.setErrorState(),void this.options.onError(g)}}updateRenderer(g,P){if(this.options.onError){if(!this.rendererErrorState)try{this.renderer.update(g,P)}catch(g){return this.gameTurnMgr.setErrorState(),this.rendererErrorState=!0,void this.options.onError(g)}}else this.renderer.update(g,P)}render(){if(this.options.onError)try{this.renderer.render()}catch(g){return this.gameTurnMgr.setErrorState(),this.rendererErrorState=!0,this.options.onError(g,!0),!1}else this.renderer.render();return!0}stop(){this.isStarted&&(this.isStarted=!1,this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=void 0),this.backgroundIntervalId&&(clearInterval(this.backgroundIntervalId),this.backgroundIntervalId=void 0),document.removeEventListener("visibilitychange",this.handleVisibilityChange))}destroy(){this.stop(),this.renderer.flush()}})}}}),System.register("engine/gameRes/CdnManifest",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("engine/gameRes/CdnResourceLoader",["data/DataStream","data/Crc32","data/vfs/VirtualFile","engine/ResourceLoader"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=class u extends U.ResourceLoader{static async clearCache(g){for await(var P of g.getEntries())P.startsWith(u.cachePrefix)&&await g.deleteFile(P)}constructor(g,P,I){super(g),this.cdnManifest=P,this.cacheDir=I}getFileNameFromUrl(g){return g.split("?")[0].split("/").pop()}async fetchResource(g,P,G){let V=this.getFileNameFromUrl(g);var W=u.cachePrefix+V,z=this.cdnManifest.checksums[V];try{if(V.endsWith(".mix")&&void 0!==z&&this.cacheDir&&await this.cacheDir.containsEntry(W)){let P=await this.cacheDir.getRawFile(W);var K=new Uint8Array(await P.arrayBuffer());if(L.Crc32.calculateCrc(K)===z)return G?.onProgress?.(K.length),K;try{await this.cacheDir.deleteFile(W)}catch(g){console.error("Couldn't delete file from local CDN cache",g)}}}catch(g){console.error(`Couldn't read file "${W}" from local CDN cache`,g)}if(void 0!==z&&(g+=(g.includes("?")?"&":"?")+"h="+z),K=await super.fetchResource(g,P,G),L.Crc32.calculateCrc(K)!==z)throw new U.DownloadError(`Checksum mismatch for URL "${g}"`);try{await(this.cacheDir?.writeFile(_.VirtualFile.factory(new I.DataStream(K),W)))}catch(g){console.error("Couldn't write file to local CDN cache",g)}return K}},g("CdnResourceLoader",G),G.cachePrefix="cdncache_"}}}),System.register("engine/gameRes/FileSystemAccessLib",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("engine/gameRes/FileSystemUtil",["data/vfs/FileNotFoundError","data/vfs/IOError"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("FileSystemUtil",class{static async getDirContents(g){let P=[];try{for await(var _ of g.values())P.push(_)}catch(P){if("NotFoundError"===P.name)throw new I.FileNotFoundError(`Directory "${g.name}" not found`,{cause:P});if(P instanceof DOMException)throw new L.IOError(`Directory "${g.name}" could not be read (${P.name})`,{cause:P});throw P}return P}static async listDir(g){let P=[];try{for await(var _ of g.keys())P.push(_)}catch(P){if("NotFoundError"===P.name)throw new I.FileNotFoundError(`Directory "${g.name}" not found`,{cause:P});if(P instanceof DOMException)throw new L.IOError(`Directory "${g.name}" could not be read (${P.name})`,{cause:P});throw P}return P}static async showArchivePicker(g){var P=await g.showOpenFilePicker({types:[{description:"Archive",accept:{"application/vnd.rar":[".rar"],"application/zip":[".zip"],"application/x-tar":[".tar"],"application/gzip":[".gz"],"application/x-bzip":[".bz"],"application/x-bzip2":[".bz2"],"application/x-xz":[".xz"],"application/x-7z-compressed":[".7z"],"application/octet-stream":[".exe"]}}]});return Array.isArray(P)?P[0]:P}static polyfillGetFile(){const g=FileSystemFileHandle.prototype.getFile;FileSystemFileHandle.prototype.getFile=function(){return g.call(this).then(g=>new File([g],this.name,{type:g.type,lastModified:g.lastModified}))}}})}}}),System.register("engine/gameRes/GameRes",["data/DataStream","data/MixFile","engine/Engine","engine/EngineType","engine/ResourceLoader","util/Logger","engine/gameRes/GameResConfig","engine/gameRes/importError/ChecksumError","engine/gameRes/importError/FileNotFoundError","engine/gameRes/importError/NoStorageError","data/Crc32","data/Palette","data/ShpFile","data/PcxFile","engine/gfx/ImageUtils","data/Bitmap","engine/gfx/CanvasUtils","gui/component/GameResBoxApi","engine/gameRes/GameResSource","data/vfs/RealFileSystem","engine/resourceConfigs","engine/gameRes/CdnResourceLoader","LocalPrefs","engine/gameRes/FileSystemUtil","data/vfs/StorageQuotaError","data/vfs/FileNotFoundError","data/vfs/IOError","engine/gameRes/GameResImporter"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce,he,ue,de;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g},function(g){ce=g},function(g){he=g},function(g){ue=g},function(g){de=g}],execute:function(){g("GameRes",class{constructor(g,P,I,L,_,U,G,V,W,z,K,q){this.appVersion=g,this.engineType=P,this.modName=I,this.fsAccessLib=L,this.localPrefs=_,this.strings=U,this.rootEl=G,this.splashScreen=V,this.viewport=W,this.appConfig=z,this.appResPath=K,this.sentry=q}async init(g,P,I){const L=!!this.modName;let U,G,V,z,K,$,Q=!1,Y=!1,l=(g,P)=>{if(g&&this.splashScreen.setLoadingText(g),P){let g;g="string"==typeof P?P:U=URL.createObjectURL(P),this.splashScreen.setBackgroundImage(g)}};try{G=await this.getBrowserFsHandle("native")}catch(G){if(!(G instanceof q.NoStorageError))throw G}try{V=!!G&&await this.migrateStorageToNative(G,l)}catch(G){console.warn("Storage migration to native failed",G),this.sentry?.captureException(new Error("Failed to migrate files to native file system",{cause:G})),V=!1}finally{l(this.strings.get("GUI:LoadingEx"))}try{var Z=V?G:await this.getBrowserFsHandle("fallback");Z&&(z=await _.Engine.initRfs(Z))}catch(G){if(!(G instanceof q.NoStorageError))throw G;console.warn("No storage adapters available.")}if(!g&&z&&await this.lookForGameFiles(z.getRootDirectory())&&((g=new W.GameResConfig("")).source=re.GameResSource.Local,Y=!0),z&&(X=await _.Engine.getModDir(),K=await this.loadMod(z,X)),z&&z.addDirectory(await _.Engine.getMapDir()),g){var X=await this.loadSplashScreenBackground(z?.getRootDirectory(),K,g);"string"==typeof X?this.splashScreen.setBackgroundImage(X):X&&(U=URL.createObjectURL(X),this.splashScreen.setBackgroundImage(U));try{$=await this.loadResources(z,g,l),Q=!0}catch(G){console.error("Failed to load initial game resources"),console.error(G),this.splashScreen.setLoadingText(""),this.splashScreen.setBackgroundImage(""),await P(G,this.strings)}}let J=new te.GameResBoxApi(this.viewport,this.strings,this.rootEl,this.fsAccessLib),ee=this.appConfig.gameResArchiveUrl;for(;!Q;){let _,V;if(this.splashScreen.setLoadingText(""),this.splashScreen.setBackgroundImage(""),U&&(URL.revokeObjectURL(U),U=void 0),_=this.appConfig.autoLoadGameRes&&this.appConfig.gameresBaseUrl&&!L?void 0:await J.promptForGameRes(ee,!!this.appConfig.gameresBaseUrl&&!L),g=new W.GameResConfig(this.appConfig.gameresBaseUrl??""),Y=!0,_)if(_ instanceof URL)V=re.GameResSource.Archive,ee=_.toString();else if("file"===_.kind)V=re.GameResSource.Archive;else{if("directory"!==_.kind)throw new Error("Unexpected FileSystemHandle type "+_.kind);V=re.GameResSource.Local}else V=re.GameResSource.Cdn;if(g.source=V,V!==re.GameResSource.Cdn)try{if(!z)throw new q.NoStorageError("No storage adapters available");await new de.GameResImporter(this.appConfig,this.strings,this.sentry).import(_,z.getRootDirectory(),this.engineType,(g,P)=>{l(g,P),g&&console.info(g)}),console.info("Game assets successfully imported.")}catch(G){console.error("Failed to import game assets"),console.error(G),this.splashScreen.setLoadingText(""),this.splashScreen.setBackgroundImage(""),await I(G,this.strings);continue}finally{this.splashScreen.setLoadingText("")}try{this.splashScreen.setLoadingText(this.strings.get("GUI:LoadingEx")),$=await this.loadResources(z,g,l),Q=!0}catch(G){console.error("Failed to load game assets"),console.error(G),this.splashScreen.setLoadingText(""),this.splashScreen.setBackgroundImage(""),await P(G,this.strings)}}return U&&URL.revokeObjectURL(U),{configToPersist:Y?g:void 0,cdnResLoader:$}}async loadMod(g,P){let I,L=this.modName;return L&&(await P.containsEntry(L)?(console.info(`Loading mod "${L}"...`),I=await P.getDirectory(L),g.addDirectory(I),_.Engine.setActiveMod(L)):(console.info(`Mod "${L}" not found. Ignoring.`),L=this.modName=void 0)),I}async lookForGameFiles(g){let P=["language.mix","multi.mix","ra2.mix"];this.engineType===U.EngineType.YurisRevenge&&P.push("langmd.mix","multimd.mix","ra2md.mix");let I=await g.listEntries();return P.every(g=>I.includes(g))}async migrateStorageToNative(g,P){var I="_storage_migration_pending";if(this.localPrefs.getItem(I)){for await(var L of g.keys())await g.removeEntry(L,{recursive:!0});this.localPrefs.removeItem(I)}else if((await g.keys().next()).value)return!0;if(void 0===this.localPrefs.getItem(oe.StorageKey.LastGpuTier))return!0;let U;console.info("Migrating to new storage...");try{U=await this.getBrowserFsHandle("fallback")}catch(P){if(P instanceof q.NoStorageError)return console.info("No existing storage found. Migration skipped."),!1;throw P}if(navigator.storage?.estimate){var G=await navigator.storage.estimate();if(void 0===G.usage||void 0===G.quota)return!1;if(G.usage>(G.quota-5242880)/2)return console.info("Migration to native storage skipped because of insufficient space."),!1}(await le.FileSystemUtil.listDir(U)).includes(_.Engine.rfsSettings.cacheDir)&&await U.removeEntry(_.Engine.rfsSettings.cacheDir,{recursive:!0}),this.localPrefs.setItem(I,"1");try{await this.migrateDir(U,g,P)}catch(P){for await(var V of g.keys())await g.removeEntry(V,{recursive:!0});throw P}finally{this.localPrefs.removeItem(I)}try{indexedDB.deleteDatabase("fileSystem"),this.fsAccessLib.support.adapter.cache&&await(globalThis.caches?.delete("sandboxed-fs"))}catch(P){console.warn(P)}return console.info("Migration done."),!0}async migrateDir(g,P,I){var L;for(L of await le.FileSystemUtil.getDirContents(g))try{if("directory"===L.kind){var _=await P.getDirectoryHandle(L.name,{create:!0});await this.migrateDir(L,_,I)}else{var U=L.name.replace(/\u200f/g,"");I(this.strings.get("TS:storage_migrating_file",P.name+"/"+L.name));let g=await P.getFileHandle(U,{create:!0});var G=await g.createWritable();let _=await L.getFile();await _.stream().pipeTo(G)}}catch(g){if("QuotaExceededError"===g.name)throw new ce.StorageQuotaError({cause:g});throw new Error(`Failed migrating "${L.name}"`,{cause:g})}}async loadResources(g,P,I){let L;if(_.Engine.initGameResSource(P.source),P.isCdn()){var U=P.getCdnBaseUrl();let I=new G.ResourceLoader(U);var W=await I.loadJson("manifest.json");if(2!==W.version)throw new Error("Unknown manifest version "+W.version);if("mix"!==W.format)throw new Error("Unsupported CDN resource format "+W.format);g=g||new se.RealFileSystem,L=new ne.CdnResourceLoader(U,W,await _.Engine.getCacheDir())}else{if(!g)throw new q.NoStorageError("No available storage adapters");console.info("Checking integrity of mix files..."),await this.checkMixesIntegrity(g.getRootDirectory()),console.info("Mixes are valid.")}const z=V.AppLogger.get("vfs");z.info("Initializing virtual filesystem...");let K=await _.Engine.initVfs(g,z);return await K.loadStandaloneFiles({exclude:["keyboard.ini","theme.ini"].map(g=>_.Engine.getFileNameVariant(g))}),await K.loadExtraMixFiles(_.Engine.getActiveEngine()),await this.loadCustomMix(K),await this.loadMixes(P,L,K,I),await _.Engine.loadMapList(),await this.initUiCssVariables(this.rootEl),L}async checkMixesIntegrity(g){let P=new Map([["ra2.mix",["E7BA3BE","5DC70844"]],["multi.mix",["984EFDB6","3CDB648F"]]]);for(var[I,L]of(this.engineType===U.EngineType.YurisRevenge&&P.set("ra2md.mix",["49A9E8EA"]).set("multimd.mix",["743DA541"]).set("expandmd01.mix",["F3D92D6C"]),P.entries())){let _,U;try{_=await g.getRawFile(I,!0),U=await _.arrayBuffer()}catch(P){if(P instanceof he.FileNotFoundError)throw new K.FileNotFoundError(I);if(P instanceof DOMException)throw new ue.IOError(`Failed to read file (${P.name})`,{cause:P});throw P}let G=$.Crc32.calculateCrc(new Uint8Array(U));if(!L.includes(G.toString(16).toUpperCase()))throw new z.ChecksumError(`Checksum mismatch for "${I}" (size: ${_.size}). Checksum "${G}" doesn't match known values`,I)}}async loadCustomMix(g){let P=new G.ResourceLoader(this.appResPath);var _=await P.loadBinary("ra2cd.mix?v="+this.appVersion);_=new L.MixFile(new I.DataStream(_));g.addArchive(_,"ra2cd.mix")}async loadMixes(g,P,U,G){if(g.isCdn()){var V=g.getCdnBaseUrl();G(this.strings.get("TS:Downloading"),V+_.Engine.rfsSettings.splashImgFileName);var W;V=[ae.ResourceType.Ini,ae.ResourceType.Ui,ae.ResourceType.Strings];let q=await P.loadResources(V,void 0,g=>{G(this.strings.get("TS:DownloadingPg",g))});for(W of(G(this.strings.get("GUI:LoadingEx")),V)){var z=P.getResourceFileName(W),K=new L.MixFile(new I.DataStream(q.pop(W)));U.addArchive(K,z)}}else if(await U.loadImplicitMixFiles(_.Engine.getActiveEngine()),V=await _.Engine.getCacheDir())try{await ne.CdnResourceLoader.clearCache(V)}catch(g){if(!(g instanceof ce.StorageQuotaError))throw g}}async initUiCssVariables(g){let P;var I=[["pudlgbgn.shp",this.engineType===U.EngineType.YurisRevenge?"dialogn.pal":"dialog.pal"],["mnbttn.shp","mainbttn.pal"],["cue_i.pcx"],["cce_i.pcx"],["cce_il.pcx"],["cce_ir.pcx"]];let L=await this.convertImagesToPng(_.Engine.vfs,I);L.set("menulogo.png",_.Engine.vfs.openFile("menulogo.png").asFile("image/png")),L.set("icons24.pcx",await this.generateIconSprite(_.Engine.vfs));var G,V={"--res-menu-logo":"menulogo.png","--res-icons-24":"icons24.pcx","--res-dlg-bgn":"pudlgbgn.shp","--res-mnbttn":"mnbttn.shp","--res-cue-i":"cue_i.pcx","--res-cce-i":"cce_i.pcx","--res-cce-il":"cce_il.pcx","--res-cce-ir":"cce_ir.pcx"};for(G of(P={},Object.keys(V))){var W=L.get(V[G]);W?(W=URL.createObjectURL(W),P[G]=`url("${W}")`):console.warn(`Image "${V[G]}" not found in browser FS`)}Object.keys(P).forEach(I=>{g.style.setProperty(I,P[I])})}async loadSplashScreenBackground(g,P,I){var L=_.Engine.rfsSettings.splashImgFileName;if(I.isCdn())return I.getCdnBaseUrl()+L;{let _;if(P)try{_=await P.getRawFile(L,!1,"image/png")}catch(I){I instanceof he.FileNotFoundError||console.warn("Failed to load splash image",I)}if(g&&!_)try{_=await g.getRawFile(L,!1,"image/png")}catch(I){console.warn("Failed to load splash image",I)}return _}}async getBrowserFsHandle(g){let P=[];var I;for("fallback"!==g&&this.fsAccessLib.support.adapter.native&&P.push({name:"native",module:void 0}),"native"!==g&&(P.push({name:"indexeddb",module:this.fsAccessLib.adapters.indexeddb}),this.fsAccessLib.support.adapter.cache&&P.push({name:"cache",module:this.fsAccessLib.adapters.cache}));I=P.shift();)try{console.info(`Loading storage adapter "${I.name}"...`);let P=await this.fsAccessLib.getOriginPrivateDirectory(I.module);try{let g=await P.getFileHandle("browsercheck",{create:!0});if("function"!=typeof g.createWritable)throw new Error("createWritable not supported");(await g.getFile()).name!==g.name&&le.FileSystemUtil.polyfillGetFile()}catch(g){if("NotFoundError"===g.name&&"indexeddb"===I.name&&await new Promise(()=>{indexedDB.deleteDatabase("fileSystem"),this.localPrefs.removeItem(oe.StorageKey.GameRes),location.reload()}),"QuotaExceededError"!==g.name)throw g}finally{try{await P.removeEntry("browsercheck")}catch(g){}}return console.info(`Storage adapter "${I.name}" loaded successfully.`),P}catch(g){console.warn("Couldn't load FS adapter "+I.name,[g])}throw new q.NoStorageError("No available FS adapters.")}async convertImagesToPng(g,P){let I=new Map;for(var[L,_]of P){let P;if(L.endsWith(".shp")){var U=new Y.ShpFile(g.openFile(L));if(!_)throw new Error(`No palette specified for image "${L}"`);_=new Q.Palette(g.openFile(_)),P=await X.ImageUtils.convertShpToPng(U,_)}else{if(!L.endsWith(".pcx")){console.warn(`Unknown image type "${L}"`);continue}{let I=new Z.PcxFile(g.openFile(L));P=await I.toPngBlob()}}I.set(L,P)}return I}async generateIconSprite(g){let P=["wouref.pcx","wodref.pcx","wouact.pcx","wodact.pcx","dnarrowr.pcx","dnarrowp.pcx","uparrowr.pcx","uparrowp.pcx","sbgript.pcx","sbgripm.pcx","sbgripb.pcx","trakgrip.pcx"];var I=P.map(P=>new Z.PcxFile(g.openFile(P)));let L=new J.RgbaBitmap(24*P.length,24);for(let g=0;g<I.length;g++){var _=new J.RgbaBitmap(I[g].width,I[g].height,I[g].data);L.drawRgbaImage(_,24*g,0)}var U=ee.CanvasUtils.canvasFromRgbaImageData(L.data,L.width,L.height);return await ee.CanvasUtils.canvasToBlob(U)}})}}}),System.register("engine/gameRes/GameResConfig",["engine/gameRes/GameResSource"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("GameResConfig",class{constructor(g){this.defaultCdnBaseUrl=g}unserialize(g){var[P,L]=g.split(","),P=Number(P);if(!I.GameResSource[P])throw new Error(`Unknown game res source "${P}"`);this.source=P,this.cdnUrl=L?decodeURI(L):void 0}serialize(){return this.source+(this.cdnUrl?","+encodeURI(this.cdnUrl):"")}isCdn(){return this.source===I.GameResSource.Cdn}getCdnBaseUrl(){return this.cdnUrl??this.defaultCdnBaseUrl}})}}}),System.register("engine/gameRes/GameResImporter",["data/MixFile","engine/Engine","engine/EngineType","util/time","engine/gameRes/importError/ChecksumError","engine/gameRes/importError/FileNotFoundError","engine/gameRes/importError/ArchiveExtractionError","data/vfs/VirtualFile","engine/mixDatabase","data/Palette","data/ShpFile","engine/gfx/ImageUtils","util/string","engine/gameRes/VideoConverter","engine/gameRes/importError/InvalidArchiveError","data/vfs/FileNotFoundError","data/vfs/IOError","data/vfs/RealFileSystemDir","engine/gameRes/importError/NoWebAssemblyError","network/HttpRequest","engine/gameRes/importError/ArchiveDownloadError"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne;function k(g){return g/1024/1024}function B(g){return function(P,I,L,_,U){let G=g(P,I,L,_,U);var V,W=ne.get(G.node.name);return W&&(G.node.contents=new Uint8Array(W),W=G.stream_ops.write,G.stream_ops={...G.stream_ops},G.stream_ops.write=(V=W,function(g,P,I,L,_,U){_||(g.node.usedBytes=g.node.contents.byteLength);var G=V(g,P,I,L,_,U);return _||(g.node.usedBytes=G),G})),G}}return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g}],execute:function(){ne=(new Map).set("ra2.mix",281895456).set("ra2md.mix",204527696).set("language.mix",53116040).set("langmd.mix",84883510).set("multi.mix",25856283).set("multimd.mix",31264268).set("theme.mix",76862662).set("thememd.mix",46859102).set("expandmd01.mix",4813968),g("GameResImporter",class{constructor(g,P,I){this.appConfig=g,this.strings=P,this.sentry=I}async import(g,P,I,G){let z=["ra2.mix","language.mix","multi.mix"];I===_.EngineType.YurisRevenge&&z.push("ra2md.mix","langmd.mix","expandmd01.mix","multimd.mix");var K=L.Engine.getFileNameVariant("theme.mix");z.push(K);let q=new Set([K]),$=L.Engine.rfsSettings.tauntsDir,Q=this.strings;if(G(Q.get("ts:import_preparing_for_import")),g instanceof URL||"file"===g.kind){if(!window.WebAssembly)throw new re.NoWebAssemblyError("WebAssembly is not available");let L,_,J,te;try{let g=await SystemJS.import("7z-wasm");J=await g({quit:(g,P)=>{L=g,_=P}})}catch(I){if(I.message.match(/Load failed|Failed to fetch/))throw new se.DownloadError("Failed to load 7z-wasm",{cause:I});if(I instanceof WebAssembly.RuntimeError)throw new ee.IOError("Couldn't load 7z-wasm",{cause:I});throw I}{let P;if(g instanceof URL){let L=0;var Z=g.toString();let _=Z;(K=this.appConfig.getCorsProxy(g.hostname))&&(_=""+K+encodeURIComponent(Z));try{P=await(new se.HttpRequest).fetchBinary(_,void 0,{onProgress(g,P){L+=g,G(P?Q.get("ts:downloadingpgsize",k(L),k(P),L/P*100):Q.get("ts:downloadingpgunkn",k(L)))}}),te="archive"}catch(I){if(!L&&I instanceof se.DownloadError)throw new ae.ArchiveDownloadError(Z,"Archive download failed",{cause:I});throw I}}else{let I=await g.getFile();P=new Uint8Array(await I.arrayBuffer()),te=I.name}G(Q.get("ts:import_loading_archive")),J.FS.chdir("/tmp");try{var ne=J.FS.open(te,"w+");J.FS.write(ne,P,0,P.byteLength,0,!0),J.FS.close(ne)}catch(I){if(I instanceof DOMException)throw new ee.IOError(`File "${te}" could not be read (${I.name})`,{cause:I});throw I}}J.FS.open=B(J.FS.open);for(let g of[...z,$]){if(G(Q.get("ts:import_extracting",g)),await U.sleep(100),J.callMain(["x","-ssc-","-r",te,g]),L){if(1!==L)throw new X.InvalidArchiveError("7-Zip exited with code "+L,{cause:_});if(_?.message?.match(/out of memory|allocation/i))throw new RangeError("Out of memory",{cause:_});throw new W.ArchiveExtractionError("Archive extraction failed with code "+L,{cause:_})}let z;for(;;){var oe=J.FS.lookupPath(J.FS.cwd()).node;if(z=Object.keys(oe.contents),oe=z.filter(P=>!Y.equalsIgnoreCase(P,g)&&P!==te),1!==oe.length||!J.FS.lookupPath(oe[0]).node.isFolder)break;J.FS.chdir(oe[0])}if(g!==$){let L=g;var le=z.find(g=>Y.equalsIgnoreCase(g,L))??L;let _;G(Q.get("ts:import_importing",L));try{_=this.readFileFromEmFs(J.FS,le),J.FS.unlink(le)}catch(I){if(44!==I.errno)throw I;if(q.has(L)){console.warn(`Mix file "${L}" not found. Skipping.`);continue}throw new V.FileNotFoundError(L)}await this.importMixArchive(_,P,G,Q)}else{let g=z.find(g=>Y.equalsIgnoreCase(g,$));if(g){le=J.FS.lookupPath(g).node,le=Object.keys(le.contents).map(P=>g+"/"+P);try{let I=await P.getOrCreateDirectory($);for(var ce of le){G(Q.get("ts:import_importing",ce));let g=this.readFileFromEmFs(J.FS,ce);J.FS.unlink(ce),await I.writeFile(g,g.filename.toLowerCase())}J.FS.rmdir(g)}catch(I){if(!(I instanceof DOMException||I instanceof ee.IOError||44===I.errno))throw I;console.warn("Failed to copy taunts folder. Skipping.",[I])}}else console.warn("Taunts folder not found in archive. Skipping.")}J.FS.chdir("/tmp")}J.FS.unlink(te);try{await P.openFile("ra2.mix")}catch(I){I instanceof ee.IOError&&(G(this.strings.get("GUI:LoadingEx")),location.reload(),await new Promise(()=>{}))}}else{let L,_=new te.RealFileSystemDir(g,!0),U=await _.listEntries();for(let g of z){G(Q.get("ts:import_importing",g));var he=U.find(P=>Y.equalsIgnoreCase(P,g))??g;let L;try{L=await _.openFile(he)}catch(I){if(I instanceof J.FileNotFoundError){if(q.has(g)){console.warn(`Mix file "${g}" not found. Skipping.`);continue}throw new V.FileNotFoundError(g)}throw I}await this.importMixArchive(L,P,G,Q)}ne=U.find(g=>Y.equalsIgnoreCase(g,$))??$;try{L=await _.getDirectory(ne)}catch(I){if(!(I instanceof J.FileNotFoundError||I instanceof ee.IOError))throw I;console.warn(`Directory "${ne}" not found (${I.name}). Skipping.`,I)}if(L)try{let g=await P.getOrCreateDirectory($,!0);for await(var ue of L.getRawFiles())G(Q.get("ts:import_importing",g.name+"/"+ue.name)),await g.writeFile(ue,ue.name.toLowerCase())}catch(I){if(!(I instanceof ee.IOError))throw I;console.warn("Failed to copy taunts folder. Skipping.",[I])}}}readFileFromEmFs(g,P){g.chmod(P,448);let I=g.lookupPath(P).node;var L=I.contents.subarray(0,I.usedBytes);return z.VirtualFile.fromBytes(L,P.slice(P.lastIndexOf("/")+1))}async importMixArchive(g,P,U,W){let z=g.filename.toLowerCase();var K=z.match(/^theme[^.]*\.mix$/);if(!g.getSize()){if(K)return void console.warn(`Mix file ${g.filename} is empty. Skipping.`);throw new G.ChecksumError(`Mix file "${z}" is empty`,z)}if(K||await P.writeFile(g,z),K){var q=L.Engine.rfsSettings.musicDir;q=await P.getOrCreateDirectory(q,!0);await this.importMusic(g,q,g=>U(W.get("ts:import_importing_pg",z,g)))}else if(z===(L.Engine.getActiveEngine()===_.EngineType.YurisRevenge?"langmd.mix":"language.mix")){U(W.get("ts:import_importing_long",z));var $=new I.MixFile(g.stream);L.Engine.getActiveEngine()===_.EngineType.YurisRevenge&&(q=await this.importSplashImage($,P),U(void 0,q)),await this.importVideo($,P)}else if(L.Engine.getActiveEngine()===_.EngineType.RedAlert2&&z.match(/ra2\.mix/)){let L=new I.MixFile(g.stream);if(!L.containsFile("local.mix"))throw new V.FileNotFoundError("local.mix");$=new I.MixFile(L.openFile("local.mix").stream),$=await this.importSplashImage($,P),U(void 0,$)}}async importMusic(g,P,L){let _;try{_=new I.MixFile(g.stream)}catch(g){return console.warn("Failed to read music mix archive. Skipping."),void console.error(g)}var U=K.mixDatabase.get(g.filename.toLowerCase());if(U){var G,V=U.length;let I=V;for(G of U){if(L(Math.floor((V-I)/V*100)),I--,!G.match(/\.wav$/))throw new Error(`Music file "${G}" is not a WAV file`);var W=G.replace(".wav",".mp3");if(_.containsFile(G)){var z=_.openFile(G);if(z.stream.byteLength){let I;try{let g=await this.createFFMpeg();g.FS("writeFile",G,new Uint8Array(z.stream.buffer,z.stream.byteOffset,z.stream.byteLength)),await g.run("-i",G,"-vn","-ar","22050","-b:a","96k",W),I=g.FS("readFile",W),g.FS("unlink",G),g.FS("unlink",W)}catch(g){console.warn(`Failed to convert music file "${G}". Skipping.`),console.error(g);continue}z=new Blob([I],{type:"application/octet-stream"});try{await P.writeFile(new File([z],W))}catch(g){console.warn(`Failed to write music file "${W}". Skipping.`),console.error(g);continue}}else console.warn(`Music file "${G}" is empty in the mix archive. Skipping.`)}else console.warn(`Music file "${G} was not found in mix archive. Skipping.`)}}else console.warn(`File "${g.filename} not found in mix database. Skipping music import.`)}async importVideo(g,P){var I=await this.createFFMpeg().catch(g=>{if(g.message.match(/Load failed|Failed to fetch/))throw new se.DownloadError("Failed to load FFMpeg",{cause:g});throw g}),_="ra2ts_l.bik",U=L.Engine.rfsSettings.menuVideoFileName;if(!g.containsFile(_))throw new V.FileNotFoundError(_);_=g.openFile(_),_=await(new Z.VideoConverter).convertBinkVideo(I,_),_=new Blob([_],{type:"video/webm"}),await P.writeFile(new File([_],U,{type:"video/webm"}))}async createFFMpeg(){let g=(0,(await SystemJS.import("@ffmpeg/ffmpeg")).createFFmpeg)({corePath:"lib/ffmpeg-core.js?v=1",log:!0});var P=window.define;return window.define=void 0,await g.load(),window.define=P,g}async importSplashImage(g,P){var I=L.Engine.getFileNameVariant("glsl.shp"),_=L.Engine.getFileNameVariant("gls.pal");if(!g.containsFile(I))throw new V.FileNotFoundError(I);if(I=new $.ShpFile(g.openFile(I)),!g.containsFile(_))throw new V.FileNotFoundError(_);let U;_=new q.Palette(g.openFile(_)),I=await Q.ImageUtils.convertShpToPng(I,_),_=L.Engine.rfsSettings.splashImgFileName;try{U=new File([I],_,{type:I.type})}catch(g){console.error("Failed to convert splash image. Skipping.",g),this.sentry?.captureException(new Error(`Failed to convert splash image (type=${I.type})`,{cause:g}))}return U&&await P.writeFile(U),I}})}}}),System.register("engine/gameRes/GameResSource",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("GameResSource",I={}))[P.Archive=0]="Archive",P[P.Cdn=1]="Cdn",P[P.Local=2]="Local"}}}),System.register("engine/gameRes/importError/ArchiveDownloadError",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){I=class extends Error{constructor(g,P,I){super(P,I),this.url=g}},g("ArchiveDownloadError",I)}}}),System.register("engine/gameRes/importError/ArchiveExtractionError",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){I=class extends Error{},g("ArchiveExtractionError",I)}}}),System.register("engine/gameRes/importError/ChecksumError",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){I=class extends Error{constructor(g,P){super(g),this.file=P}},g("ChecksumError",I)}}}),System.register("engine/gameRes/importError/FileNotFoundError",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){I=class extends Error{constructor(g){super(`File "${g}" not found.`),this.file=g}},g("FileNotFoundError",I)}}}),System.register("engine/gameRes/importError/InvalidArchiveError",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){I=class extends Error{},g("InvalidArchiveError",I)}}}),System.register("engine/gameRes/importError/NoStorageError",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){I=class extends Error{},g("NoStorageError",I)}}}),System.register("engine/gameRes/importError/NoWebAssemblyError",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){I=class extends Error{},g("NoWebAssemblyError",I)}}}),System.register("engine/gameRes/VideoConverter",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("VideoConverter",class{async convertBinkVideo(g,P,I="webm"){var L=P.filename,_=P.filename.replace(/\.\w+$/,"")+"."+I;g.FS("writeFile",L,new Uint8Array(P.stream.buffer,P.stream.byteOffset,P.stream.byteLength)),"webm"===I?await g.run("-i",L,"-vcodec","libvpx","-crf","10","-b:v","2M","-deadline","realtime","-speed","2","-an",_):await g.run("-i",L,"-vcodec","libx264","-crf","25","-b:v","2M","-an",_);var U=g.FS("readFile",_);return g.FS("unlink",L),g.FS("unlink",_),U}})}}}),System.register("engine/gfx/batch/BatchedMesh",[],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("BatchMode",I={}))[P.Instancing=0]="Instancing",P[P.Merging=1]="Merging",L=class extends THREE.Mesh{constructor(g,P,L=I.Instancing){super(g,P),this.geometry=g,this.material=P,this.batchMode=L,this.isBatchedMesh=!0,this.castShadow=!1,this.opacity=1,this.extraLight=new THREE.Vector3(0,0,0),this.paletteIndex=0,this.clippingPlanes=[],this.clippingPlanesHash="",this.layers.disable(0)}getOpacity(){return this.opacity}setOpacity(g){this.opacity=g}getExtraLight(){return this.extraLight}setExtraLight(g){this.extraLight=g}getPaletteIndex(){return this.paletteIndex}setPaletteIndex(g){this.paletteIndex=g}getClippingPlanes(){return this.clippingPlanes}setClippingPlanes(g){this.clippingPlanes=g,this.updateClippingPlanesHash(g)}updateClippingPlanesHash(g){this.clippingPlanesHash=g.map(g=>[...g.normal.toArray(),g.constant]).flat().join(",")}getClippingPlanesHash(){return this.clippingPlanesHash}},g("BatchedMesh",L)}}}),System.register("engine/gfx/batch/InstancedMesh",[],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[],execute:function(){(I=new THREE.MeshDepthMaterial).depthPacking=THREE.RGBADepthPacking,I.clipping=!0,I.defines={INSTANCE_TRANSFORM:""},G=THREE.ShaderLib.distanceRGBA,L=THREE.UniformsUtils.clone(G.uniforms),_={USE_SHADOWMAP:"",INSTANCE_TRANSFORM:""},U=new THREE.ShaderMaterial({defines:_,uniforms:L,vertexShader:G.vertexShader,fragmentShader:G.fragmentShader,clipping:!0}),G=class extends THREE.Mesh{constructor(g,P,L,_,G=!1){super((new THREE.InstancedBufferGeometry).copy(g)),this.maxInstances=L,this.uniformScale=_,this.useInstanceColor=G,this.initAttributes(this.geometry),this.material=this.decorateMaterial(P.clone()),this.frustumCulled=!1,this.customDepthMaterial=I,this.customDistanceMaterial=U}initAttributes(g){let P=[];for(let g=0;g<4;g++)P.push({name:"instanceMatrix"+g,data:new Float32Array(4*this.maxInstances),itemSize:4,normalized:!0});for(var{name:I,data:L,itemSize:_,normalized:U}of(this.useInstanceColor&&P.push({name:"instanceColor",data:new Uint8Array(3*this.maxInstances),itemSize:3,normalized:!0}),P.push({name:"instanceOpacity",data:new Float32Array(this.maxInstances).fill(1),itemSize:1,normalized:!0}),P)){let P=new THREE.InstancedBufferAttribute(L,_,U,1);P.dynamic=!0,g.addAttribute(I,P)}this.instanceMatrixAttributes=new Array(4).fill(0).map((P,I)=>g.getAttribute("instanceMatrix"+I))}decorateMaterial(g){let P=g;return P.defines??(P.defines={}),P.defines.INSTANCE_TRANSFORM="",this.uniformScale?P.defines.INSTANCE_UNIFORM="":delete P.defines.INSTANCE_UNIFORM,this.useInstanceColor?P.defines.INSTANCE_COLOR="":delete P.defines.INSTANCE_COLOR,P.defines.INSTANCE_OPACITY="",g}setRenderCount(g){if(g>this.maxInstances)throw new RangeError("Exceeded maximum number of instances");this.geometry.maxInstancedCount=g}setMatrixAt(g,P){for(let L=0;L<4;L++){var I=4*L;this.instanceMatrixAttributes[L].setXYZW(g,P.elements[I++],P.elements[I++],P.elements[I++],P.elements[+I])}}updateFromMeshes(g){var P,I=!!g[0].material.palette,L=this.geometry.attributes;let _=L.instanceOpacity,U=L.instancePaletteOffset,G=L.instanceExtraLight;for(let P=0,L=g.length;P<L;P++){let L=g[P];this.setMatrixAt(P,L.matrixWorld);var V,W,z=L.getOpacity();_.getX(P)!==z&&(_.setX(P,z),_.needsUpdate=!0),I&&(V=L.getPaletteIndex(),U.getX(P)!==V&&(U.setX(P,V),U.needsUpdate=!0),W=L.getExtraLight(),z=Math.fround(W.x),V=Math.fround(W.y),W=Math.fround(W.z),z===G.getX(P)&&V===G.getY(P)&&W===G.getZ(P)||(G.setXYZ(P,z,V,W),G.needsUpdate=!0))}for(P of(this.setRenderCount(g.length),this.instanceMatrixAttributes))P.needsUpdate=!0}dispose(){this.geometry.dispose(),this.material.dispose()}},g("InstancedMesh",G)}}}),System.register("engine/gfx/batch/MergedSpriteMesh",["util/array","engine/gfx/material/PaletteBasicMaterial"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=new THREE.Vector3,U=new THREE.Vector4,G=class r extends THREE.Mesh{static createMergedGeometry(g,P,I){let _=new THREE.BufferGeometry;for(var U of Object.keys(g.attributes)){let I=g.getAttribute(U);var G=new I.array.constructor(P*I.array.length);_.addAttribute(U,new THREE.BufferAttribute(G,I.itemSize,I.normalized))}var V,W=g.getAttribute("position").count;for(V of(I instanceof L.PaletteBasicMaterial&&_.addAttribute("vertexColorMult",new THREE.BufferAttribute(new Float32Array(W*P*4),4)),I.palette&&_.addAttribute("vertexPaletteOffset",new THREE.BufferAttribute(new Float32Array(W*P),1)),Object.values(_.attributes)))V.setDynamic(!0);if(g.index){_.setIndex(new THREE.BufferAttribute(new Uint32Array(P*g.index.array.length),1));for(let I=0;I<P;I++){let P=I*W;_.index.array.set(Uint32Array.from(g.index.array,g=>g+P),I*g.index.array.length)}}return _}constructor(g,P,I){super(r.createMergedGeometry(g,I,P)),this.maxInstances=I,this.material=this.decorateMaterial(P.clone()),this.verticesPerItem=g.getAttribute("position").count,this.indicesPerItem=g.index?.count,this.frustumCulled=!1}decorateMaterial(g){let P=g;return P.defines??(P.defines={}),g.palette&&(P.defines.VERTEX_PALETTE_OFFSET=""),g instanceof L.PaletteBasicMaterial&&(P.useVertexColorMult=!0),g}updateFromMeshes(g){var P,I=this.geometry.attributes,L=I.position,G=I.uv,V=I.vertexColorMult,W=I.vertexPaletteOffset,z=g.length;if(z>this.maxInstances)throw new RangeError("Exceeded maximum number of instances");for(let P=0;P<z;P++){var K=P*this.verticesPerItem;let I=g[P];this.setGeometryAt(K,I.geometry,_.setFromMatrixPosition(I.matrixWorld),L,G);var q=I.getExtraLight();V&&this.setColorMultAt(K,U.set(1+q.x,1+q.y,1+q.z,I.getOpacity()),V),W&&this.setPaletteIndexAt(K,I.getPaletteIndex(),W)}for(P of(this.geometry.setDrawRange(0,z*(this.geometry.index?this.indicesPerItem:this.verticesPerItem)),Object.values(I)))P.dynamic&&(P.updateRange.count=z<this.maxInstances?z*this.verticesPerItem*P.itemSize:-1)}setGeometryAt(g,P,L,_,U){var G=P.attributes,V=G.position.array;let W=_.array;for(let P=0;P<this.verticesPerItem;P++){var z=3*(g+P),K=Math.fround(V[3*P]+Math.fround(L.x)),q=Math.fround(V[3*P+1]+Math.fround(L.y)),$=Math.fround(V[3*P+2]+Math.fround(L.z));K===W[z]&&q===W[1+z]&&$===W[2+z]||(W[z]=K,W[1+z]=q,W[2+z]=$,_.needsUpdate=!0)}let Q=U.array;G=G.uv.array,I.equals(G,Q.subarray(2*g,2*g+G.length))||(Q.set(G,2*g),U.needsUpdate=!0)}setColorMultAt(g,P,I){if(I.getX(g)!==P.x||I.getY(g)!==P.y||I.getZ(g)!==P.z||I.getW(g)!==P.w){I.needsUpdate=!0;for(let L=0;L<this.verticesPerItem;L++)I.setXYZW(g+L,P.x,P.y,P.z,P.w)}}setPaletteIndexAt(g,P,I){if(I.getX(g)!==P){I.needsUpdate=!0;for(let L=0;L<this.verticesPerItem;L++)I.setX(g+L,P)}}dispose(){this.geometry.dispose(),this.material.dispose()}},g("MergedSpriteMesh",G)}}}),System.register("engine/gfx/batch/MeshBatchManager",["engine/gfx/batch/BatchedMesh","engine/gfx/batch/MeshInstancingBatch","engine/gfx/RenderableContainer","engine/gfx/batch/MeshMergingBatch"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=class extends _.RenderableContainer{constructor(g){super(),this.renderableContainer=g,this.batches=new Map}create3DObject(){let g=this.get3DObject();g||(g=new THREE.Object3D,g.name="mesh_batch_manager",g.matrixAutoUpdate=!1,this.set3DObject(g)),super.create3DObject()}updateMeshes(){var g=this.renderableContainer.get3DObject();g&&(g=this.collectMeshes(g),g=this.fillBatches(this.groupMeshesByBatchKey(g)),this.cleanUnusedBatches(g))}collectMeshes(g){let P=[];return g.traverseVisible(g=>{g.isBatchedMesh&&P.push(g)}),P}fillBatches(g){let P=new Map([...this.batches.keys()].map(g=>[g,0]));for(var[_,G]of g){let g=this.batches.get(_),z=0;for(;G.length;){var V=G[0].batchMode===I.BatchMode.Instancing,W=V?1024:128;let P=G.splice(0,W),K=g?.[z];K||(g||(g=[],this.batches.set(_,g)),K=new(V?L.MeshInstancingBatch:U.MeshMergingBatch)(W),K.castShadow=P[0].castShadow,K.receiveShadow=P[0].receiveShadow,K.renderOrder=P[0].renderOrder,K.clippingPlanes=P[0].getClippingPlanes(),g.push(K),this.add(K),this.processRenderQueue()),K.setMeshes(P),z++}P.set(_,z)}return P}cleanUnusedBatches(g){for(var[P,I]of g){let g=this.batches.get(P);if(g){var L;for(L of g.splice(I))this.remove(L),L.dispose();g.length||this.batches.delete(P)}}}groupMeshesByBatchKey(g){let P=new Map;for(let _=0,U=g.length;_<U;_++){var I=g[_],L=this.getBatchKey(I);let U=P.get(L);U||(U=[],P.set(L,U)),U.push(I)}return P}getBatchKey(g){return g.batchMode+"_"+(g.batchMode===I.BatchMode.Instancing?g.geometry.uuid:g.geometry.attributes.position.count)+"_"+g.material.uuid+"_"+Number(g.castShadow)+"_"+g.renderOrder+"_"+Number(g.receiveShadow)+"_"+g.getClippingPlanesHash()}dispose(){this.batches.forEach(g=>g.forEach(g=>g.dispose()))}},g("MeshBatchManager",G)}}}),System.register("engine/gfx/batch/MeshInstancingBatch",["engine/gfx/batch/InstancedMesh"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("MeshInstancingBatch",class{get castShadow(){return this._castShadow}set castShadow(g){this._castShadow=g,this.instancedMesh&&(this.instancedMesh.castShadow=g)}get receiveShadow(){return this._receiveShadow}set receiveShadow(g){this._receiveShadow=g,this.instancedMesh&&(this.instancedMesh.receiveShadow=g)}get clippingPlanes(){return this._clippingPlanes}set clippingPlanes(g){this._clippingPlanes=g,this.instancedMesh&&(this.instancedMesh.material.clippingPlanes=g)}get renderOrder(){return this._renderOrder}set renderOrder(g){this._renderOrder=g,this.instancedMesh&&(this.instancedMesh.renderOrder=g)}constructor(g){this.maxInstances=g,this._castShadow=!1,this._receiveShadow=!1,this._clippingPlanes=[],this._renderOrder=0}get3DObject(){return this.target}create3DObject(){if(!this.target){let g=new THREE.Object3D;g.matrixAutoUpdate=!1,this.target=g,this.instancedMesh&&g.add(this.instancedMesh)}}setMeshes(g){if(g.length>this.maxInstances)throw new RangeError("Meshes array exceeds max number of instances");var P;g.length?(P=!!g[0].material.palette,this.instancedMesh||(this.instancedMesh=new I.InstancedMesh(g[0].geometry,g[0].material,this.maxInstances,!0),this.instancedMesh.castShadow=this._castShadow,this.instancedMesh.renderOrder=this._renderOrder,this.instancedMesh.material.clippingPlanes=this._clippingPlanes,P&&(this.instancedMesh.geometry.addAttribute("instancePaletteOffset",new THREE.InstancedBufferAttribute(new Float32Array(this.maxInstances),1)),this.instancedMesh.geometry.addAttribute("instanceExtraLight",new THREE.InstancedBufferAttribute(new Float32Array(3*this.maxInstances),3))),this.target?.add(this.instancedMesh)),this.instancedMesh.updateFromMeshes(g)):this.instancedMesh&&(this.target?.remove(this.instancedMesh),this.instancedMesh.dispose(),this.instancedMesh=void 0)}update(){}dispose(){this.instancedMesh?.dispose()}})}}}),System.register("engine/gfx/batch/MeshMergingBatch",["engine/gfx/batch/MergedSpriteMesh"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("MeshMergingBatch",class{get castShadow(){return this._castShadow}set castShadow(g){this._castShadow=g,this.mergedGeoMesh&&(this.mergedGeoMesh.castShadow=g)}get receiveShadow(){return this._receiveShadow}set receiveShadow(g){this._receiveShadow=g,this.mergedGeoMesh&&(this.mergedGeoMesh.receiveShadow=g)}get clippingPlanes(){return this._clippingPlanes}set clippingPlanes(g){this._clippingPlanes=g,this.mergedGeoMesh&&(this.mergedGeoMesh.material.clippingPlanes=g)}get renderOrder(){return this._renderOrder}set renderOrder(g){this._renderOrder=g,this.mergedGeoMesh&&(this.mergedGeoMesh.renderOrder=g)}constructor(g){this.maxInstances=g,this._castShadow=!1,this._receiveShadow=!1,this._clippingPlanes=[],this._renderOrder=0}get3DObject(){return this.target}create3DObject(){if(!this.target){let g=new THREE.Object3D;g.matrixAutoUpdate=!1,this.target=g,this.mergedGeoMesh&&g.add(this.mergedGeoMesh)}}setMeshes(g){if(g.length>this.maxInstances)throw new RangeError("Meshes array exceeds max number of instances");g.length?(this.mergedGeoMesh||(this.mergedGeoMesh=new I.MergedSpriteMesh(g[0].geometry,g[0].material,this.maxInstances),this.mergedGeoMesh.castShadow=this._castShadow,this.mergedGeoMesh.receiveShadow=this._receiveShadow,this.mergedGeoMesh.renderOrder=this._renderOrder,this.mergedGeoMesh.material.clippingPlanes=this._clippingPlanes,this.target?.add(this.mergedGeoMesh)),this.mergedGeoMesh.updateFromMeshes(g)):this.mergedGeoMesh&&(this.target?.remove(this.mergedGeoMesh),this.mergedGeoMesh.dispose(),this.mergedGeoMesh=void 0)}update(){}dispose(){this.mergedGeoMesh?.dispose()}})}}}),System.register("engine/gfx/BufferGeometryUtils",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("BufferGeometryUtils",class{static mergeVertices(g,P=1e-4){P=Math.max(P,Number.EPSILON);const I={},L=g.getIndex();var _=g.getAttribute("position"),U=(L||_).count;let G=0;var V=Object.keys(g.attributes);const W={},z={},K=[],q=[(g,P)=>g.getX(P),(g,P)=>g.getY(P),(g,P)=>g.getZ(P),(g,P)=>g.getW(P)];for(let P=0,I=V.length;P<I;P++){var $=V[P];W[$]=[];var Q=g.morphAttributes[$];Q&&(z[$]=new Array(Q.length).fill(void 0).map(()=>[]))}_=Math.log10(1/P);var Y=Math.pow(10,_);for(let P=0;P<U;P++){var Z=L?L.getX(P):P;let _="";for(let P=0,I=V.length;P<I;P++){var X=V[P],J=g.getAttribute(X),ee=J.itemSize;for(let g=0;g<ee;g++)_+=~~(q[g](J,Z)*Y)+","}if(_ in I)K.push(I[_]);else{for(let P=0,I=V.length;P<I;P++){var te=V[P],re=g.getAttribute(te),se=g.morphAttributes[te],ae=re.itemSize;const I=W[te],L=z[te];for(let g=0;g<ae;g++){const P=q[g];if(I.push(P(re,Z)),se)for(let g=0,I=se.length;g<I;g++)L[g].push(P(se[g],Z))}}I[_]=G,K.push(G),G++}}const ne=g.clone();for(let P=0,I=V.length;P<I;P++){var oe=V[P];const I=g.getAttribute(oe);var le=new I.array.constructor(W[oe]);le=new THREE.BufferAttribute(le,I.itemSize,I.normalized);if(ne.addAttribute(oe,le),oe in z)for(let P=0;P<z[oe].length;P++){const I=g.morphAttributes[oe][P];var ce=new I.array.constructor(z[oe][P]);ce=new THREE.BufferAttribute(ce,I.itemSize,I.normalized);ne.morphAttributes[oe][P]=ce}}return ne.setIndex(new THREE.BufferAttribute(new Uint32Array(K),1)),ne}static mergeBufferGeometries(g,P=!1){var I=null!==g[0].index;const L=new Set(Object.keys(g[0].attributes)),_={},U=new THREE.BufferGeometry;let G=0;for(let W=0;W<g.length;++W){var V=g[W];let z=0;if(I!=(null!==V.index))throw new Error("mergeBufferGeometries() failed with geometry at index "+W+". All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them.");if(Object.keys(V.morphAttributes).length)throw new Error("mergeBufferGeometries() failed with geometry at index "+W+". Morph attributes are not supported");for(const g in V.attributes){if(!L.has(g))throw new Error("mergeBufferGeometries() failed with geometry at index "+W+'. All geometries must have compatible attributes; make sure "'+g+'" attribute exists among all geometries, or in none of them.');void 0===_[g]&&(_[g]=[]),_[g].push(V.attributes[g]),z++}if(z!==L.size)throw new Error("mergeBufferGeometries() failed with geometry at index "+W+". Make sure all geometries have the same number of attributes.");if(P){let g;if(I)g=V.index.count;else{if(void 0===V.attributes.position)throw new Error("mergeBufferGeometries() failed with geometry at index "+W+". The geometry must have either an index or a position attribute");g=V.attributes.position.count}U.addGroup(G,g,W),G+=g}}if(I){let P=0;const I=[];for(let L=0;L<g.length;++L){const _=g[L].index;for(let g=0;g<_.count;++g)I.push(_.getX(g)+P);P+=g[L].attributes.position.count}U.setIndex(new THREE.BufferAttribute(new(65535<I.length?Uint32Array:Uint16Array)(I),1))}for(const g in _){var W=this.mergeBufferAttributes(_[g]);if(!W)throw new Error("mergeBufferGeometries() failed while trying to merge the "+g+" attribute.");U.addAttribute(g,W)}return U}static mergeBufferAttributes(g){let P,I,L,_=0;for(let G=0;G<g.length;++G){var U=g[G];if(U.isInterleavedBufferAttribute)throw new Error("mergeBufferAttributes() failed. InterleavedBufferAttributes are not supported.");if(void 0===P&&(P=U.array.constructor),P!==U.array.constructor)throw new Error("mergeBufferAttributes() failed. BufferAttribute.array must be of consistent array types across matching attributes.");if(void 0===I&&(I=U.itemSize),I!==U.itemSize)throw new Error("mergeBufferAttributes() failed. BufferAttribute.itemSize must be consistent across matching attributes.");if(void 0===L&&(L=U.normalized),L!==U.normalized)throw new Error("mergeBufferAttributes() failed. BufferAttribute.normalized must be consistent across matching attributes.");_+=U.array.length}const G=new P(_);let V=0;for(let P=0;P<g.length;++P)G.set(g[P].array,V),V+=g[P].array.length;return new THREE.BufferAttribute(G,I,L)}})}}}),System.register("engine/gfx/CanvasUtils",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("CanvasUtils",class{static canvasFromRgbImageData(g,P,I){let L=document.createElement("canvas"),_=L.getContext("2d");if(!_)throw new Error("Couldn't acquire canvas 2d context");let U=_.createImageData(P,I);L.width=P,L.height=I;let G=0;for(let P=0,I=g.length;P<I;P+=3)U.data[G]=g[P],U.data[G+1]=g[P+1],U.data[G+2]=g[P+2],U.data[G+3]=255,G+=4;return _.putImageData(U,0,0),L}static canvasFromRgbaImageData(g,P,I){let L=document.createElement("canvas"),_=L.getContext("2d");if(!_)throw new Error("Couldn't acquire canvas 2d context");let U=_.createImageData(P,I);L.width=P,L.height=I;let G=0;for(let P=0,I=g.length;P<I;P+=4)U.data[G]=g[P],U.data[G+1]=g[P+1],U.data[G+2]=g[P+2],U.data[G+3]=g[P+3],G+=4;return _.putImageData(U,0,0),L}static canvasFromIndexedImageData(g,P,I,L){let _=document.createElement("canvas"),U=_.getContext("2d");if(!U)throw new Error("Couldn't acquire canvas 2d context");let G=U.createImageData(P,I);_.width=P,_.height=I;let V=0;return g.forEach(g=>{var{r:P,g:I,b:_}=L.getColor(g);G.data[V++]=P,G.data[V++]=I,G.data[V++]=_,G.data[V++]=g?255:0}),U.putImageData(G,0,0),_}static async canvasToBlob(g){let P=await new Promise(P=>{try{g.toBlob(g=>{P(g)})}catch(g){console.error(g),P(null)}});if(!P){console.warn("Failed to convert canvas to blob. Falling back to dataURL generation.");try{P=this.dataUrlToBlob(g.toDataURL())}catch(g){throw new Error("Failed to generate image from canvas using fallback",{cause:g})}}return P}static dataUrlToBlob(g){if(!(L=g.match(/^data:((.*?)(;charset=.*?)?)(;base64)?,/)))throw new Error("invalid dataURI");var P=L[2]?L[1]:"text/plain"+(L[3]||";charset=utf-8"),I=!!L[4],L=g.slice(L[0].length);let _=(I?atob:decodeURIComponent)(L),U=[];for(let g=0;g<_.length;g++)U.push(_.charCodeAt(g));return new Blob([new Uint8Array(U)],{type:P})}static drawText(g,P,I=0,L=0,{color:_="white",backgroundColor:U,outlineColor:G,outlineWidth:V,fontSize:W,fontFamily:z="Arial, sans-serif",fontWeight:K="normal",borderColor:q,borderWidth:$=0,paddingTop:Q=0,paddingBottom:Y=0,paddingLeft:Z=0,paddingRight:X=0,textAlign:J="left",width:ee,height:te,autoEnlargeCanvas:re=!1}){var se=K+` ${W}px `+z;g.font=se;var ae=g.measureText(P),ne=g.measureText("A"),oe=ne.actualBoundingBoxAscent+ne.actualBoundingBoxDescent,le=Math.ceil(Math.max(ae.width,Math.abs(ae.actualBoundingBoxLeft)+Math.abs(ae.actualBoundingBoxRight))),ce=le+2*$+Z+X;ce={x:"right"===J&&void 0===ee?g.canvas.width-ce:I,y:L,width:ee??ce,height:te??oe+2*$+Q+Y};re&&(ce.x+ce.width>g.canvas.width||ce.y+ce.height>g.canvas.height)&&(oe=0<g.canvas.width+g.canvas.height?g.getImageData(0,0,g.canvas.width,g.canvas.height):void 0,ce.x+ce.width>g.canvas.width&&(g.canvas.width=ce.x+ce.width),ce.y+ce.height>g.canvas.height&&(g.canvas.height=ce.y+ce.height),oe&&g.putImageData(oe,0,0)),U&&(g.fillStyle=U,g.fillRect(ce.x,ce.y,ce.width,ce.height)),q&&(g.strokeStyle=q,g.lineWidth=1,g.strokeRect(.5+ce.x,.5+ce.y,ce.width-1,ce.height-1)),g.fillStyle=_,g.font=se;let he=$+Z;return"right"===J?he=ce.width-$-X-le:"center"===J&&(he+=Math.floor((ce.width-2*$-Z-X-le)/2)),ae=ae.actualBoundingBoxAscent+Q+(ne.actualBoundingBoxAscent-ae.actualBoundingBoxAscent),G&&(g.strokeStyle=G,g.lineWidth=2*(V??1),g.strokeText(P,ce.x+he+.5,ce.y+ae,ce.width)),g.fillText(P,ce.x+he+.5,ce.y+ae,ce.width),ce}})}}}),System.register("engine/gfx/DebugUtils",["game/Coords","data/Bitmap","three"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("DebugUtils",class{static createWireframe(g,P){return new _.Mesh(this.createBoxGeometry(g,P),new THREE.MeshBasicMaterial({wireframe:!0}))}static createBoxGeometry(g,P,L=!1){var _=I.Coords.getWorldTileSize(),U=g.width*_,G=g.height*_;_=I.Coords.tileHeightToWorld(P);let V=new THREE.BoxBufferGeometry(U,_,G);return L?V.translate(0,_/2,0):V.translate(U/2,_/2,G/2),V}static createIndexedCheckerTex(g,P){let I=new L.IndexedBitmap(64,64,new Uint8Array(4096).fill(g));for(let g=0;g<32;g++)for(let L=0;L<32;L++)I.data[g+64*L]=P,I.data[g+32+64*(L+32)]=P;let _=new THREE.DataTexture(I.data,64,64,THREE.AlphaFormat);return _.needsUpdate=!0,_.minFilter=THREE.NearestFilter,_.magFilter=THREE.NearestFilter,_}})}}}),System.register("engine/gfx/drawable/PalDrawable",["data/Bitmap"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("PalDrawable",class{constructor(g){this.pal=g}draw(){var g=this.pal.size;let P=new I.RgbaBitmap(g,1),L=0;for(let I=0,U=g;I<U;++I){var _=this.pal.getColor(I);P.data[L]=_.r,P.data[L+1]=_.g,P.data[L+2]=_.b,P.data[L+3]=I?255:0,L+=4}return P}})}}}),System.register("engine/gfx/drawable/TmpDrawable",["data/Bitmap"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("TmpDrawable",class{drawTileBlock(g,P,I,L,_,U){let G=P.data;var V=L/2;let W=I/2-2+P.width*U+_;var z=P.width*P.height;let K=0,q=0,$=0;for(;q<V;q++){$+=4;for(let P=0;P<$;P++){var Q=g.tileData[K];0!==Q&&0<=W&&W<z&&(G[W]=Q),W++,K++}W+=P.width-($+2)}for(W+=4;q<L;q++){$-=4;for(let P=0;P<$;P++){var Y=g.tileData[K];0<=W&&W<z&&(G[W]=Y),W+=1,K++}W+=P.width-($-2)}}draw(g,P,L){let _=P,U=L,G=0,V=0;g.hasExtraData&&(G+=Math.max(0,g.x-g.extraX),V+=Math.max(0,g.y-g.extraY),_+=Math.max(0,g.x-g.extraX),U+=Math.max(0,g.y-g.extraY));var W=new I.IndexedBitmap(_,U);return this.drawTileBlock(g,W,P,L,G,V),g.hasExtraData&&this.drawExtraData(g,W),W}drawExtraData(g,P){if(g.hasExtraData){let W=P.data;var I=P.width,L=P.height,_=Math.max(0,g.extraX-g.x),U=I,G=I*L;let z=0+U*Math.max(0,g.extraY-g.y)+_,K=0;for(let P=0;P<g.extraHeight;P++){for(let P=0;P<g.extraWidth;P++){var V=g.extraData[K];0!==V&&0<=z&&z<G&&(W[z]=V),z+=1,K++}z+=U-g.extraWidth}}}})}}}),System.register("engine/gfx/FrustumCuller",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("FrustumCuller",class{cull(g,P){var I=[];return function e(g,P,I,L=0){let _,U=g.children;var G,V=g.visible;if(P.intersectsBox(g.box)){if(g.visible=!0,null!==U)for(_=0,G=U.length;_<G;++_)U[_].isOctree?e(U[_],P,I,L+1):!V&&g.config.skipInvisMatrixUpdate&&U[_].updateMatrixWorld(!1);I.push(g)}else g.visible=!1}(g,P,I),I}})}}}),System.register("engine/gfx/geometry/BufferGeometrySerializer",["data/DataStream"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("BufferGeometrySerializer",class{serialize(g){if(Object.keys(g.morphAttributes).length)throw new Error("Morph attributes are not supported");if(1<g.groups.length)throw new Error("Groups are not supported");var P,L=Object.keys(g.attributes),_=g.index,U=1+22*L.length+Object.values(g.attributes).map(g=>this.getTypedArrayByteSize(g.array)).reduce((g,P)=>g+P,0)+1+(_?this.getTypedArrayByteSize(_.array):0);let G=new I.DataStream(new ArrayBuffer(U));for(P of(G.writeUint8(L.length),L)){var V=g.getAttribute(P);G.writeCString(P,20),G.writeUint8(V.itemSize),G.writeUint8(Number(V.normalized)),this.writeTypedArray(G,V.array)}return G.writeUint8(Number(Boolean(_))),_&&this.writeTypedArray(G,_.array),G.seek(0),G.dynamicSize=!1,G.buffer}unserialize(g){let P=new THREE.BufferGeometry;var I,L=g.readUint8();for(let I=0;I<L;I++){var _=g.readCString(20),U=g.readUint8(),G=Boolean(g.readUint8()),V=this.readTypedArray(g);G=new THREE.BufferAttribute(V,U,G);P.addAttribute(_,G)}return Boolean(g.readUint8())&&(I=this.readTypedArray(g),P.setIndex(new THREE.BufferAttribute(I,1))),P}writeTypedArray(g,P){if(g.writeUint32(P.length),P instanceof Float32Array)g.writeUint8(0),g.writeFloat32Array(P);else if(P instanceof Uint32Array)g.writeUint8(1),g.writeUint32Array(P);else{if(!(P instanceof Uint16Array))throw new Error(`Unsupported array type "${P.constructor.name}"`);g.writeUint8(2),g.writeUint16Array(P)}}readTypedArray(g){var P=g.readUint32(),I=g.readUint8();switch(I){case 0:return g.readFloat32Array(P);case 1:return g.readUint32Array(P);case 2:return g.readUint16Array(P);default:throw new Error(`Unsupported array type "${I}"`)}}getTypedArrayByteSize(g){return 5+g.BYTES_PER_ELEMENT*g.length}})}}}),System.register("engine/gfx/geometry/VxlGeometryCache",["data/DataStream","data/vfs/VirtualFile","engine/gfx/geometry/BufferGeometrySerializer","data/vfs/FileNotFoundError"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("VxlGeometryCache",G=class a{constructor(g,P){this.cacheDir=g,this.activeMod=P,this.geometries=new Map}async loadFromStorage(g,P){let I=this.geometries.get(g);if(!I){let V=this.cacheDir;if(V){var L=this.getCacheFileName(P,g.name);try{var G=await V.openFile(L);I=(new _.BufferGeometrySerializer).unserialize(G.stream),this.set(g,I)}catch(g){g instanceof U.FileNotFoundError||console.error(`Failed to load buffer geometry from cache file "${L}"`,g)}}}return I}async persistToStorage(g,P,U){this.geometries.has(g)||this.set(g,(new _.BufferGeometrySerializer).unserialize(new I.DataStream(U))),await(this.cacheDir?.writeFile(new L.VirtualFile(new I.DataStream(U),this.getCacheFileName(P,g.name))))}async clearStorage(){await this.clearStorageFiles()}async clearOtherModStorage(){let g=a.cacheFilePrefix+this.getModPrefix();await this.clearStorageFiles(P=>!P.startsWith(g))}async clearStorageFiles(g=()=>!0){let P=this.cacheDir;if(P)for await(var I of P.getEntries())I.startsWith(a.cacheFilePrefix)&&g(I)&&await P.deleteFile(I)}getCacheFileName(g,P){var I=this.getModPrefix();return""+a.cacheFilePrefix+I+g.replace(".vxl","")+"_"+P}getModPrefix(){return this.activeMod?this.activeMod+"#":"#"}clear(){this.geometries.forEach(g=>{for(var P of(g.dispose(),Object.keys(g.attributes)))g.removeAttribute(P)}),this.geometries.clear()}get(g){return this.geometries.get(g)}set(g,P){this.geometries.set(g,P)}}),G.cacheFilePrefix="geocache_"}}}),System.register("engine/gfx/ImageUtils",["data/Bitmap","engine/gfx/CanvasUtils"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("ImageUtils",class r{static async convertShpToPng(g,P){var I=r.convertShpToCanvas(g,P);return await L.CanvasUtils.canvasToBlob(I)}static convertShpToBitmap(g,P,L=!1){let _=0,U=0,G=g.width,V=g.height;G!==V&&L&&(_=G>V?0:Math.floor((V-G)/2),U=G>V?Math.floor((G-V)/2):0,G=V=Math.max(G,V));let W=new I.IndexedBitmap(g.numImages*G,V);for(let P=0;P<g.numImages;P++){var z=g.getImage(P),K=new I.IndexedBitmap(z.width,z.height,z.imageData);W.drawIndexedImage(K,P*G+z.x+_,z.y+U)}return W}static convertShpToCanvas(g,P,I=!1){var _=this.convertShpToBitmap(g,P,I);return L.CanvasUtils.canvasFromIndexedImageData(_.data,_.width,_.height,P)}})}}}),System.register("engine/gfx/lighting/LightingDirector",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("LightingDirector",class{constructor(g,P,I){this.lighting=g,this.renderer=P,this.gameSpeed=I,this.effects=[],this.onFrame=g=>{if(this.effects.length){let P=!1;this.effects.slice().forEach((I,L)=>{I.isRunning||(I.isRunning=!0,I.startTime=g,I.mapLighting.copy(this.lighting.getBaseAmbient()));var _=I.update(g,this.gameSpeed.value);_.done&&(this.effects.splice(this.effects.indexOf(I),1),L||(P=!0)),L||_.updated&&this.lighting.applyAmbientOverride(I.mapLighting)}),this.effects.length?P&&this.lighting.applyAmbientOverride(this.effects[0].mapLighting):this.lighting.applyAmbientOverride(void 0)}}}init(){this.renderer.onFrame.subscribe(this.onFrame)}addEffect(g){this.effects.push(g),this.effects.sort((g,P)=>P.priority-g.priority)}dispose(){this.renderer.onFrame.unsubscribe(this.onFrame)}})}}}),System.register("engine/gfx/lighting/LightingFx",["data/map/MapLighting"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){var P;(P=L||g("LightingFxPriority",L={}))[P.Normal=0]="Normal",P[P.High=1]="High",g("LightingFx",class{constructor(){this.priority=L.Normal,this.mapLighting=new I.MapLighting,this.isRunning=!1}update(g,P){return{done:!0}}})}}}),System.register("engine/gfx/lighting/LightningStormFx",["engine/gfx/lighting/LightingFx"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.LightingFx{constructor(g,P){super(),this.durationGameSeconds=g,this.ionLighting=P,this.cloudAnims=[]}waitForCloudAnim(g){this.cloudAnims.push(g)}update(g,P){let I=!1,L=!1;return g===this.startTime&&(this.mapLighting.copy(this.ionLighting),I=!0),(g-this.startTime)/1e3*P>this.durationGameSeconds&&!this.cloudAnims.some(g=>!g.isAnimFinished())&&(L=!0),{done:L,updated:I}}},g("LightningStormFx",L)}}}),System.register("engine/gfx/lighting/NukeLightingFx",["engine/gfx/lighting/LightingFx"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.LightingFx{constructor(){super(),this.priority=I.LightingFxPriority.High}update(g,P){let I=!1,L=!1;this.initialAmbient??(this.initialAmbient=this.mapLighting.ambient);let _,U=(g-this.startTime)/1e3*P;var G;return 3.3<=U?(U-=3.3,G=Math.min(1,U/.5),_=this.initialAmbient+1.5*(1-G),1===G&&(L=!0)):U<.3&&(G=U/.3,_=this.initialAmbient+1.5*G),void 0!==_&&this.mapLighting.ambient!==_&&(I=!0,this.mapLighting.ambient=_),{done:L,updated:I}}},g("NukeLightingFx",L)}}}),System.register("engine/gfx/material/PaletteBasicMaterial",["engine/gfx/material/paletteShaderLib"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L={uniforms:THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,I.paletteShaderLib.uniforms]),vertexShader:THREE.ShaderChunk.meshbasic_vert.replace("#include <common>","#include <common>\n"+[I.paletteShaderLib.instanceParsVertex,I.paletteShaderLib.paletteColorParsVertex,I.paletteShaderLib.vertexColorMultParsVertex].join("\n")).replace("void main() {","void main() {\n"+[I.paletteShaderLib.instanceVertex,I.paletteShaderLib.paletteColorVertex,I.paletteShaderLib.vertexColorMultVertex].join("\n")),fragmentShader:THREE.ShaderChunk.meshbasic_frag.replace("#include <common>","#include <common>\n"+[I.paletteShaderLib.paletteColorParsFrag,I.paletteShaderLib.vertexColorMultParsFrag].join("\n")).replace("#include <color_fragment>","#include <color_fragment>\n"+[I.paletteShaderLib.paletteColorFrag,I.paletteShaderLib.paletteBasicLightFragment,I.paletteShaderLib.vertexColorMultFrag].join("\n"))},_=class extends THREE.MeshBasicMaterial{get palette(){return this.uniforms.palette.value}set palette(g){this.uniforms.palette.value=g}get paletteOffset(){return this.uniforms.paletteOffsetCount.value[0]}set paletteOffset(g){this.uniforms.paletteOffsetCount.value[0]=g}get paletteCount(){return this.uniforms.paletteOffsetCount.value[1]}set paletteCount(g){this.uniforms.paletteOffsetCount.value[1]=g}get extraLight(){return this.uniforms.extraLight.value}set extraLight(g){this.uniforms.extraLight.value=g}set useVertexColorMult(g){g?(this.defines??(this.defines={}),this.defines.USE_VERTEX_COLOR_MULT=""):this.defines&&delete this.defines.USE_VERTEX_COLOR_MULT}constructor({palette:g,paletteCount:P,paletteOffset:I,extraLight:_,useVertexColorMult:U,...G}={}){super(G),this.uniforms=THREE.UniformsUtils.clone(L.uniforms),g&&(this.palette=g),P&&(this.paletteCount=P),I&&(this.paletteOffset=I),_&&this.extraLight.copy(_),U&&(this.useVertexColorMult=U),this.vertexShader=L.vertexShader,this.fragmentShader=L.fragmentShader,this.type="PaletteBasicMaterial"}copy(g){return super.copy(g),this.fragmentShader=g.fragmentShader,this.vertexShader=g.vertexShader,this.uniforms=THREE.UniformsUtils.clone(g.uniforms),this.palette=g.palette,this}},g("PaletteBasicMaterial",_)}}}),System.register("engine/gfx/material/PaletteLambertMaterial",["engine/gfx/material/paletteShaderLib"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L={uniforms:THREE.UniformsUtils.merge([THREE.ShaderLib.lambert.uniforms,I.paletteShaderLib.uniforms]),vertexShader:THREE.ShaderChunk.meshlambert_vert.replace("#include <common>","#include <common>\n"+I.paletteShaderLib.instanceParsVertex).replace("void main() {","void main() {\n"+I.paletteShaderLib.instanceVertex),fragmentShader:THREE.ShaderChunk.meshlambert_frag.replace("#include <common>","#include <common>\n"+I.paletteShaderLib.paletteColorParsFrag).replace("#include <color_fragment>","#include <color_fragment>\n"+I.paletteShaderLib.paletteColorFrag).replace("#include <lights_fragment_end>","#include <lights_fragment_end>\n"+I.paletteShaderLib.paletteFullLightFragment)},_=class extends THREE.MeshLambertMaterial{get palette(){return this.uniforms.palette.value}set palette(g){this.uniforms.palette.value=g}get paletteOffset(){return this.uniforms.paletteOffsetCount.value[0]}set paletteOffset(g){this.uniforms.paletteOffsetCount.value[0]=g}get paletteCount(){return this.uniforms.paletteOffsetCount.value[1]}set paletteCount(g){this.uniforms.paletteOffsetCount.value[1]=g}get extraLight(){return this.uniforms?.extraLight.value}set extraLight(g){this.uniforms.extraLight.value=g}constructor({palette:g,paletteCount:P,paletteOffset:I,extraLight:_,...U}={}){super(U),this.uniforms=THREE.UniformsUtils.clone(L.uniforms),g&&(this.palette=g),P&&(this.paletteCount=P),I&&(this.paletteOffset=I),_&&this.extraLight.copy(_),this.vertexShader=L.vertexShader,this.fragmentShader=L.fragmentShader,this.type="PaletteLambertMaterial"}copy(g){return super.copy(g),this.fragmentShader=g.fragmentShader,this.vertexShader=g.vertexShader,this.uniforms=THREE.UniformsUtils.clone(g.uniforms),this.palette=g.palette,this}},g("PaletteLambertMaterial",_)}}}),System.register("engine/gfx/material/PalettePhongMaterial",["engine/gfx/material/paletteShaderLib"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L={uniforms:THREE.UniformsUtils.merge([THREE.ShaderLib.phong.uniforms,I.paletteShaderLib.uniforms]),vertexShader:THREE.ShaderChunk.meshphong_vert.replace("#include <common>","#include <common>\n"+I.paletteShaderLib.instanceParsVertex).replace("void main() {","void main() {\n"+I.paletteShaderLib.instanceVertex),fragmentShader:THREE.ShaderChunk.meshphong_frag.replace("#include <common>","#include <common>\n"+I.paletteShaderLib.paletteColorParsFrag).replace("#include <color_fragment>","#include <color_fragment>\n"+I.paletteShaderLib.paletteColorFrag).replace("#include <lights_fragment_end>","#include <lights_fragment_end>\n"+I.paletteShaderLib.paletteFullLightFragment)},_=class extends THREE.MeshPhongMaterial{get palette(){return this.uniforms.palette.value}set palette(g){this.uniforms.palette.value=g}get paletteOffset(){return this.uniforms.paletteOffsetCount.value[0]}set paletteOffset(g){this.uniforms.paletteOffsetCount.value[0]=g}get paletteCount(){return this.uniforms.paletteOffsetCount.value[1]}set paletteCount(g){this.uniforms.paletteOffsetCount.value[1]=g}get extraLight(){return this.uniforms?.extraLight.value}set extraLight(g){this.uniforms.extraLight.value=g}constructor({palette:g,paletteCount:P,paletteOffset:I,extraLight:_,...U}={}){super(U),this.uniforms=THREE.UniformsUtils.clone(L.uniforms),g&&(this.palette=g),P&&(this.paletteCount=P),I&&(this.paletteOffset=I),_&&this.extraLight.copy(_),this.vertexShader=L.vertexShader,this.fragmentShader=L.fragmentShader,this.type="PalettePhongMaterial"}copy(g){return super.copy(g),this.fragmentShader=g.fragmentShader,this.vertexShader=g.vertexShader,this.uniforms=THREE.UniformsUtils.clone(g.uniforms),this.palette=g.palette,this}},g("PalettePhongMaterial",_)}}}),System.register("engine/gfx/material/paletteShaderLib",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("paletteShaderLib",{uniforms:{palette:{type:"t",value:null},paletteOffsetCount:{value:[0,1]},extraLight:{value:new THREE.Vector3(0,0,0)}},instanceParsVertex:"\n#ifdef INSTANCE_TRANSFORM\n    attribute float instancePaletteOffset;\n    varying float vInstancePaletteOffset;\n    attribute vec3 instanceExtraLight;\n    varying vec3 vInstanceExtraLight;\n#endif\n",instanceVertex:"\n  #ifdef INSTANCE_TRANSFORM\n    vInstancePaletteOffset = instancePaletteOffset;\n    vInstanceExtraLight = instanceExtraLight;\n  #endif\n",paletteColorParsVertex:"\n#ifdef VERTEX_PALETTE_OFFSET\n    attribute float vertexPaletteOffset;\n    varying float vVertexPaletteOffset;\n#endif\n",paletteColorVertex:"\n  #ifdef VERTEX_PALETTE_OFFSET\n    vVertexPaletteOffset = vertexPaletteOffset;\n  #endif\n",paletteColorParsFrag:"\nuniform sampler2D palette;\n#ifdef VERTEX_PALETTE_OFFSET\n    varying float vVertexPaletteOffset;\n#endif\nuniform vec2 paletteOffsetCount;\nuniform vec3 extraLight;\n\n#ifdef INSTANCE_TRANSFORM\nvarying float vInstancePaletteOffset;\nvarying vec3 vInstanceExtraLight;\n#endif\n",paletteColorFrag:"\n  float paletteColorIndex;\n\n  #ifdef USE_MAP\n  paletteColorIndex = texelColor.a;\n  #endif\n\n  #ifdef USE_COLOR\n  paletteColorIndex = vColor.r;\n  #endif\n\n  #ifdef INSTANCE_TRANSFORM\n  diffuseColor = texture2D(palette, vec2(paletteColorIndex, (vInstancePaletteOffset + 0.5) / paletteOffsetCount.y));\n  #elif defined(VERTEX_PALETTE_OFFSET)\n  diffuseColor = texture2D(palette, vec2(paletteColorIndex, (vVertexPaletteOffset + 0.5) / paletteOffsetCount.y));\n  #else\n  diffuseColor = texture2D(palette, vec2(paletteColorIndex, (paletteOffsetCount.x + 0.5) / paletteOffsetCount.y));\n  #endif\n\n  #ifdef INSTANCE_OPACITY\n  diffuseColor.a *= vInstanceOpacity * opacity;\n  #else\n  diffuseColor.a *= opacity;\n  #endif\n  diffuseColor = clamp(diffuseColor, 0.0, 1.0);\n",paletteBasicLightFragment:"\n  #ifdef INSTANCE_TRANSFORM\n  diffuseColor.rgb += vInstanceExtraLight.rgb * diffuseColor.rgb;\n  #else\n  diffuseColor.rgb += extraLight.rgb * diffuseColor.rgb;\n  #endif\n\n  diffuseColor = clamp(diffuseColor, 0.0, 1.0);\n",paletteFullLightFragment:"\n  #ifdef INSTANCE_TRANSFORM\n  vec3 extraIrradiance = vInstanceExtraLight.rgb;\n  #else\n  vec3 extraIrradiance = extraLight.rgb;\n  #endif\n\n  #if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n    #pragma unroll_loop\n    for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n      directionalLight = directionalLights[ i ];\n      getDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n\n      directLight.color = extraIrradiance;\n      RE_Direct( directLight, geometry, material, reflectedLight );\n    }\n  #endif\n\n  #if defined( RE_IndirectDiffuse )\n  RE_IndirectDiffuse( extraIrradiance, geometry, material, reflectedLight );\n  #endif\n",vertexColorMultParsVertex:"\n#ifdef USE_VERTEX_COLOR_MULT\nattribute vec4 vertexColorMult;\nvarying vec4 vVertexColorMult;\n#endif\n",vertexColorMultVertex:"\n  #ifdef USE_VERTEX_COLOR_MULT\n  vVertexColorMult = vertexColorMult;\n  #endif\n",vertexColorMultParsFrag:"\n#ifdef USE_VERTEX_COLOR_MULT\nvarying vec4 vVertexColorMult;\n#endif\n",vertexColorMultFrag:"\n  #ifdef USE_VERTEX_COLOR_MULT\n  diffuseColor.rgba *= vVertexColorMult.rgba;\n  #endif\n"})}}}),System.register("engine/gfx/MathUtils",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("MathUtils",class{static rotateObjectAboutPoint(g,P,I,L,_=!1){(_=void 0!==_&&_)&&g.parent.localToWorld(g.position),g.position.sub(P),g.position.applyAxisAngle(I,L),g.position.add(P),_&&g.parent.worldToLocal(g.position),g.rotateOnAxis(I,L)}static translateTowardsCamera(g,P,I){var L=(new THREE.Quaternion).setFromEuler(P.rotation);g.setRotationFromQuaternion(L),g.translateZ(I*Math.cos(P.rotation.y)),g.setRotationFromEuler(new THREE.Euler(0,0,0))}})}}}),System.register("engine/gfx/OctreeContainer",["engine/gfx/RenderableContainer","engine/gfx/FrustumCuller","game/Coords"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){G=class o extends I.RenderableContainer{static factory(g){var{near:P,far:I}=g,_=new THREE.Box3(new THREE.Vector3(2*P,2*P,2*P),new THREE.Vector3(2*I,2*I,2*I));let U=new Octree(_,{maxDepth:Math.ceil(Math.log2(2*(I-P)/128)),splitThreshold:10,joinThreshold:5,skipInvisMatrixUpdate:!0});return U.name="octree",P=new L.FrustumCuller,new o(U,P,g)}constructor(g,P,I){super(g),this.autoCull=!0,this.lastCameraPosition=new THREE.Vector3,this.tree=g,this.frustumCuller=P,this.camera=I}update(g,P){super.update(g,P),this.autoCull&&this.cullChildren()}cullChildren(){if(!this.camera.position.equals(this.lastCameraPosition)){this.lastCameraPosition.copy(this.camera.position);var g=this.computeProjectionMatrix();this.camera.updateMatrixWorld(!1),this.camera.matrixWorldInverse.getInverse(this.camera.matrixWorld),g=(new THREE.Matrix4).multiplyMatrices(g,this.camera.matrixWorldInverse);let P=new THREE.Frustum;P.setFromMatrix(g),this.frustumCuller.cull(this.tree,P)}}computeProjectionMatrix(){return U?U.copy(this.camera):U=this.camera.clone(),U.top+=3*_.Coords.LEPTONS_PER_TILE*_.Coords.COS_ISO_CAMERA_BETA,U.bottom-=3*_.Coords.LEPTONS_PER_TILE*_.Coords.COS_ISO_CAMERA_BETA,U.left-=2*_.Coords.LEPTONS_PER_TILE*3*_.Coords.COS_ISO_CAMERA_BETA,U.right+=2*_.Coords.LEPTONS_PER_TILE*3*_.Coords.COS_ISO_CAMERA_BETA,U.updateProjectionMatrix(),U.projectionMatrix}updateChild(g){var P=g.get3DObject();P&&P.parent&&this.tree.updateObject(P)}},g("OctreeContainer",G)}}}),System.register("engine/gfx/OverlayUtils",["engine/gfx/CanvasUtils"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("OverlayUtils",class{static createGroundCircle(g,P){var I=new THREE.LineBasicMaterial({color:P,transparent:!0,depthTest:!1,depthWrite:!1});let L=new THREE.CircleGeometry(g,64);L.vertices.shift(),L.vertices.push(L.vertices[0]);let _=new THREE.Line(L,I);return _.rotation.x=Math.PI/2,_.renderOrder=1e6,_}static createTextBox(g,P){let L=document.createElement("canvas");L.width=L.height=0;var _=L.getContext("2d",{alpha:!P.backgroundColor||!!P.backgroundColor.match(/^rgba/)});return I.CanvasUtils.drawText(_,g,0,0,{...P,autoEnlargeCanvas:!0}),L}})}}}),System.register("engine/gfx/Renderable",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("engine/gfx/RenderableContainer",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("RenderableContainer",class{constructor(g){this.children=new Set,this.renderQueue=[],g&&this.set3DObject(g)}set3DObject(g){this.container=g}get3DObject(){return this.container}getChildren(){return[...this.children]}add(...g){for(var P of g)this.children.has(P)||(this.children.add(P),this.renderQueue.push(P))}remove(...g){for(var P of g){var I;this.children.has(P)&&(this.children.delete(P),-1===(I=this.renderQueue.indexOf(P))?(P=P.get3DObject())&&P.parent&&this.get3DObject().remove(P):this.renderQueue.splice(I,1))}}removeAll(){this.remove(...this.children)}processRenderQueue(){if(!this.get3DObject())throw new Error("A THREE.Object3D must be passed in the constructor or using the setter.");let g;for(;g=this.renderQueue.shift();){g.create3DObject();var P=g.get3DObject();P&&this.get3DObject().add(P)}}create3DObject(){this.processRenderQueue()}update(g,P){for(var I of(this.renderQueue.length&&this.processRenderQueue(),this.children))this.renderQueue.length&&this.processRenderQueue(),I.update(g,P)}})}}}),System.register("engine/gfx/Renderer",["stats.js","util/event","engine/gfx/RendererError"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("Renderer",class{get onFrame(){return this._onFrame.asEvent()}constructor(g,P){this.isContextLost=!1,this._onFrame=new L.EventDispatcher,this.handleContextLost=g=>{g.preventDefault(),this.isContextLost=!0},this.handleContextRestored=()=>{var g=this.renderer.domElement;this.renderer.dispose(),this.renderer=this.createGlRenderer(g),this.isContextLost=!1},this.width=g,this.height=P,this.scenes=new Set}getCanvas(){return this.renderer.domElement}getStats(){return this.stats}supportsInstancing(){if(!this.renderer)throw new Error("Renderer not yet initialized");return!!this.renderer.extensions.get("ANGLE_instanced_arrays")}initStats(g){this.stats||(this.stats=new I.default,this.stats.showPanel(0),this.stats.dom.style.top="auto",this.stats.dom.style.bottom="0px",this.stats.dom.classList.add("stats-layer"),g.appendChild(this.stats.dom))}destroyStats(){this.stats&&(this.stats.dom.parentNode.removeChild(this.stats.dom),this.stats=void 0)}init(g){let P=this.createGlRenderer();g.appendChild(P.domElement),P.domElement.addEventListener("contextmenu",g=>{g.preventDefault()}),P.domElement.addEventListener("mousedown",g=>{g.preventDefault()}),P.domElement.addEventListener("wheel",g=>{g.stopPropagation()},{passive:!0}),P.domElement.addEventListener("webglcontextlost",this.handleContextLost),P.domElement.addEventListener("webglcontextrestored",this.handleContextRestored),this.renderer=P}createGlRenderer(g){let P;try{P=new THREE.WebGLRenderer({canvas:g,preserveDrawingBuffer:!0,powerPreference:"high-performance"})}catch(g){throw new _.RendererError("Failed to initialize WebGL renderer",{cause:g})}return P.setSize(this.width,this.height),P.autoClear=!1,P.autoClearDepth=!1,P.shadowMap.enabled=!0,P.localClippingEnabled=!0,P.toneMapping=THREE.NoToneMapping,P}setViewportSize(g,P){this.width=g,this.height=P,this.renderer&&this.renderer.setSize(g,P)}addScene(g){this.scenes.add(g),g.create3DObject()}removeScene(g){this.scenes.delete(g)}getScenes(){return[...this.scenes]}update(g,P){this.scenes.forEach(I=>{I.update(g,P)}),this._onFrame.dispatch(this,g)}render(){this.isContextLost||(this.renderer.clear(),this.scenes.forEach(g=>{this.renderer.clearDepth(),this.renderer.setViewport(g.viewport.x,g.viewport.y,g.viewport.width,g.viewport.height),this.renderer.render(g.scene,g.camera)}))}flush(){this.renderer.renderLists.dispose()}destroy(){this.renderer.domElement.remove(),this.renderer.domElement.removeEventListener("webglcontextlost",this.handleContextLost),this.renderer.domElement.removeEventListener("webglcontextrestored",this.handleContextRestored),this.renderer.dispose(),this.destroyStats()}})}}}),System.register("engine/gfx/RendererError",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){I=class extends Error{},g("RendererError",I)}}}),System.register("engine/gfx/Scene",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("engine/gfx/SpriteUtils",["util/math","engine/gfx/BufferGeometryUtils"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){(_=class o{constructor(){this.USE_INDEXED_GEOMETRY=!0,this.VERTICES_PER_SPRITE=this.USE_INDEXED_GEOMETRY?8:12,this.TRIANGLES_PER_SPRITE=4}createSpriteGeometry(g){if("object"!=typeof g)throw new Error("Invalid argument");var P=g.camera,_=g.texture;g.textureArea||(g.textureArea={x:0,y:0,width:_.image.width,height:_.image.height}),g.offset||(g.offset={x:0,y:0});var U=g.textureArea.width,G=g.textureArea.height,V={width:g.texture.image.width,height:g.texture.image.height},W=Math.cos(P.rotation.y)*(g.scale??1),z=W/Math.sin(-P.rotation.x),K=U*W,q=G*(g.flat?z:W);let $;U=(_=g.depth&&!g.flat)&&I.isBetween(-g.offset.x,0,K/W)?-g.offset.x:K/W/2,G=this.createRectGeometry(U*W,q);let Q=this.createRectGeometry(K-U*W,q);return this.addRectUvs(G,{...g.textureArea,width:U},V),this.addRectUvs(Q,{...g.textureArea,x:g.textureArea.x+U,width:g.textureArea.width-U},V),Q.applyMatrix((new THREE.Matrix4).makeTranslation((K-U*W+U*W)/2,0,0)),$=L.BufferGeometryUtils.mergeBufferGeometries([G,Q]),$.applyMatrix((new THREE.Matrix4).makeTranslation(-(K/2-U*W/2),0,0)),G=g.align,U=g.offset,$.applyMatrix((new THREE.Matrix4).makeTranslation(G.x*K/2+U.x*W,G.y*q/2-U.y*(g.flat?z:W),0)),_?this.applyDepth($,P,g.depthOffset??0):g.depth&&g.flat&&g.depthOffset&&this.applyFlatDepth($,g.depthOffset),_=new THREE.Euler(P.rotation.x,P.rotation.y,0,"YXZ"),$.applyMatrix((new THREE.Matrix4).makeRotationFromEuler(_).multiply(g.flat?(new THREE.Matrix4).makeRotationFromEuler(new THREE.Euler(-P.rotation.x-Math.PI/2,0,0)):(new THREE.Matrix4).identity())),$}createRectGeometry(g,P){return this.USE_INDEXED_GEOMETRY?this.createIndexedRectGeometry(g,P):this.createNonIndexedRectGeometry(g,P)}createNonIndexedRectGeometry(g,P){let I=new THREE.BufferGeometry;var L=new Float32Array([-.5*g,.5*P,0,-.5*g,-.5*P,0,.5*g,.5*P,0,-.5*g,-.5*P,0,.5*g,-.5*P,0,.5*g,.5*P,0]);return I.addAttribute("position",new THREE.BufferAttribute(L,3)),I}createIndexedRectGeometry(g,P){let I=new THREE.BufferGeometry;var L=new Float32Array([-.5*g,.5*P,0,.5*g,.5*P,0,-.5*g,-.5*P,0,.5*g,-.5*P,0]);return I.addAttribute("position",new THREE.BufferAttribute(L,3)),L=new Uint16Array([0,2,1,2,3,1]),I.setIndex(new THREE.BufferAttribute(L,1)),I}addRectUvs(g,P,I){var L=new Float32Array(2*g.getAttribute("position").count);this.USE_INDEXED_GEOMETRY?this.writeIndexedRectUvsIntoBuffer(L,0,P,I):this.writeNonIndexedRectUvsIntoBuffer(L,0,P,I),g.addAttribute("uv",new THREE.BufferAttribute(L,2))}writeNonIndexedRectUvsIntoBuffer(g,P,I,L){var _=I.x/L.width,U=1-(I.y+I.height)/L.height,G=I.width/L.width,V=I.height/L.height;g.set([_,U+V,_,U,_+G,U+V,_,U,_+G,U,_+G,U+V],12*P)}writeIndexedRectUvsIntoBuffer(g,P,I,L){var _=I.x/L.width,U=1-(I.y+I.height)/L.height,G=I.width/L.width,V=I.height/L.height;g.set([_,U+V,_+G,U+V,_,U,_+G,U],8*P)}applyDepth(g,P,I){let L=g.getAttribute("position");for(let g=0,U=L.count;g<U;g++){var _=L.getX(g)*o.MAGIC_DEPTH_SCALE;let U;U=_<0?I-Math.abs(_)/Math.cos(P.rotation.x)*Math.tan(P.rotation.y):I-_/Math.cos(P.rotation.x)/Math.tan(P.rotation.y),L.setZ(g,U)}}applyFlatDepth(g,P){let I=g.getAttribute("position");for(let g=0,L=I.count;g<L;g++)I.setZ(g,P)}}).MAGIC_DEPTH_SCALE=.8,g("SpriteUtils",new _)}}}),System.register("engine/gfx/TextureAtlas",["data/Bitmap"],function(g,P){"use strict";var I;function u(g){let P=g.target;P.isDisposed=!0,P.removeEventListener("dispose",u)}function d(g,P,L,_){let U=new I.IndexedBitmap(P,L);return g.forEach(g=>{if(!g.fit)throw new Error("Couldn't fit all images in a single texture");var P=g.image,I=g.fit.x,L=g.fit.y;_?.set(P,{x:I,y:L,width:g.w,height:g.h}),U.drawIndexedImage(P,I,L)}),U}return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("TextureAtlas",class{getTexture(){if(!this.texture)throw new Error("Texture atlas not initialized");return this.texture}getImageRect(g){if(!this.imageRects)throw new Error("Texture atlas not initialized");var P=this.imageRects.get(g);if(!P)throw new Error("Image not found in atlas");return P}pack(g){let P=[];g.forEach(g=>{P.push({w:g.width+g.width%2,h:g.height+g.height%2,image:g})}),P.sort((g,P)=>1e4*(P.w-g.w)+P.h-g.h);let I=new GrowingPacker;I.fit(P);var L,_,U,G=I.root.w,V=I.root.h,W=new Map,z=d(P,G,V,W);let K=new THREE.DataTexture(z.data,G,V,THREE.AlphaFormat);K.needsUpdate=!0,K.flipY=!0,K.minFilter=THREE.NearestFilter,K.magFilter=THREE.NearestFilter,K.onUpdate=(L=P,_=G,U=V,g=>{g.image={width:g.image.width,height:g.image.height,get data(){return g.isDisposed?new Uint8Array(this.width*this.height):(console.log("TextureAtlas: Rebuilding texture for upload to GPU..."),d(L,_,U).data)}},g.addEventListener("dispose",u)}),this.width=G,this.height=V,this.imageRects=W,this.texture=K}dispose(){this.texture?.dispose()}})}}}),System.register("engine/gfx/TextureUtils",["data/Bitmap","util/math","engine/gfx/CanvasUtils","engine/gfx/drawable/PalDrawable"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("TextureUtils",G=class c{static textureFromPalette(g){var P=g.hash,I=c.cache.get(P);return I||(I=new U.PalDrawable(g).draw(),I=this.textureFromPalBitmap(I),c.cache.set(P,I),I)}static textureFromPalettes(g){if(!g.length)throw new Error("At least one palette is required");var P=L.fnv32a(g.map(g=>g.hash));if(V=c.cache.get(P))return V;let _;var G,V=g.map(g=>new U.PalDrawable(g).draw());_=new I.RgbaBitmap(V[0].width,V.length);let W=0;for(G of V)_.drawRgbaImage(G,0,W++);return V=this.textureFromPalBitmap(_),c.cache.set(P,V),V}static textureFromPalBitmap(g){var P=_.CanvasUtils.canvasFromRgbaImageData(g.data,g.width,g.height);let I=new THREE.Texture(P);return I.minFilter=THREE.NearestFilter,I.magFilter=THREE.NearestFilter,I.needsUpdate=!0,I.flipY=!1,I}}),G.cache=new Map}}}),System.register("engine/ImageFinder",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){g("ImageFinder",I=class s{constructor(g,P){this.images=g,this.theater=P}findByObjectArt(g){return this.find(g.imageName,g.useTheaterExtension)}find(g,P){var I=this.getFilename(g,P),L=this.images.get(I);if(!L)throw new s.MissingImageError(`No image file found for artName="${g}" (file=${I})`);return L}tryFind(g,P){let I;try{I=this.find(g,P)}catch(g){if(!(g instanceof s.MissingImageError))throw g}return I}getFilename(g,P){let I=g.toLowerCase();return I+=P?this.theater.settings.extension:".shp",I=this.applyNewTheaterIfNeeded(g,I),I}applyNewTheaterIfNeeded(g,P){return-1===["G","N","C","Y"].indexOf(g[0])||-1===["A","T","U","D","L","N"].indexOf(g[1])?P:this.applyNewTheater(P)}applyNewTheater(g){let P;var I=g[0],L=g.substr(2);return P=I+this.theater.settings.newTheaterChar.toLowerCase()+L,this.images.has(P)||(P=I+"g"+L,this.images.has(P)||(P=g)),P}}),function(g){class t extends Error{}g.MissingImageError=t}(I||g("ImageFinder",I={}))}}}),System.register("engine/IsoCoords",["game/Coords"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("IsoCoords",class s{static init(g){s.worldOrigin=g}static worldToScreen(g,P){if(!s.worldOrigin)throw new Error("Coords not initialized with world origin");return g-=s.worldOrigin.x,P-=s.worldOrigin.y,{x:(g/=I.Coords.ISO_WORLD_SCALE)-(P/=I.Coords.ISO_WORLD_SCALE),y:(g+P)/2}}static screenToWorld(g,P){if(!s.worldOrigin)throw new Error("Coords not initialized with world origin");return{x:(g+2*P)/2*I.Coords.ISO_WORLD_SCALE+s.worldOrigin.x,y:(2*P-g)/2*I.Coords.ISO_WORLD_SCALE+s.worldOrigin.y}}static vecWorldToScreen(g){let P=s.worldToScreen(g.x,g.z);return P.y-=s.tileHeightToScreen(I.Coords.worldToTileHeight(g.y)),P}static tileToScreen(g,P){var L=I.Coords.tileToWorld(g,P);return s.worldToScreen(L.x,L.y)}static tileHeightToScreen(g){return g*(I.Coords.ISO_TILE_SIZE/2)}static tile3dToScreen(g,P,I){let L=s.tileToScreen(g,P);return L.y-=s.tileHeightToScreen(I),L}static screenTileToScreen(g,P){return{x:g*I.Coords.ISO_TILE_SIZE,y:P*I.Coords.ISO_TILE_SIZE/2}}static screenToScreenTile(g,P){return{x:g/I.Coords.ISO_TILE_SIZE,y:P/(I.Coords.ISO_TILE_SIZE/2)}}static screenTileToWorld(g,P){var I=s.screenTileToScreen(g,P);return s.screenToWorld(I.x,I.y)}static getScreenTileSize(){return{width:s.tileToScreen(1,0).x-s.tileToScreen(0,1).x,height:s.tileToScreen(1,1).y-s.tileToScreen(0,0).y}}static screenDistanceToWorld(g,P){return I.Coords.screenDistanceToWorld(g,P)}})}}}),System.register("engine/LazyAsyncResourceCollection",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("LazyAsyncResourceCollection",class{constructor(g,P=!0){this.resourceFactory=g,this.cache=P,this.resources=new Map}setDir(g){this.rfsDir=g}set(g,P){this.resources.set(g,P)}async has(g){return!!this.resources.has(g)||(await(this.rfsDir?.containsEntry(g))??!1)}async get(g){let P;return P=this.resources.get(g),!P&&await(this.rfsDir?.containsEntry(g))&&(P=await this.resourceFactory(await this.rfsDir.getRawFile(g)),this.cache&&this.resources.set(g,P)),P}clear(){this.resources.clear()}})}}}),System.register("engine/LazyResourceCollection",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("LazyResourceCollection",class{constructor(g){this.resourceFactory=g,this.resources=new Map}setVfs(g){this.vfs=g}set(g,P){this.resources.set(g,P)}has(g){return!!this.resources.has(g)||(this.vfs?.fileExists(g)??!1)}get(g){let P;return P=this.resources.get(g),!P&&this.vfs?.fileExists(g)&&(P=this.resourceFactory(this.vfs.openFile(g)),this.resources.set(g,P)),P}clear(g){g?this.resources.delete(g):this.resources.clear()}})}}}),System.register("engine/Lighting",["engine/type/LightingType","data/map/MapLighting","util/event","util/disposable/CompositeDisposable"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=new THREE.Vector3,g("Lighting",class{get onChange(){return this._onChange.asEvent()}get mapLighting(){return this.ambientOverride??this.baseAmbient}constructor(g){if(this.baseAmbient=new L.MapLighting,this.tileLights=new Map,this.disposables=new U.CompositeDisposable,this._onChange=new _.EventDispatcher,g){this.baseAmbient.copy(g.getAmbient());let e=g=>{this.baseAmbient.copy(g),this._onChange.dispatch(this,void 0)};g.onChange.subscribe(e),this.disposables.add(()=>g.onChange.unsubscribe(e))}}forceUpdate(g){this._onChange.dispatch(this,g)}applyAmbientOverride(g){this.ambientOverride=g,this._onChange.dispatch(this,void 0)}getBaseAmbient(){return(new L.MapLighting).copy(this.baseAmbient)}addTileLight(g,P){this.tileLights.has(g)||this.tileLights.set(g,new Set),this.tileLights.get(g).add(P)}removeTileLight(g,P){let I=this.tileLights.get(g);I&&(I.delete(P),I.size||this.tileLights.delete(g))}compute(g,P,L=0){return g===I.LightingType.None?new THREE.Vector3(1,1,1):this.computeTint(g).add(this.computeTileTint(P,g,G)).multiplyScalar(this.mapLighting.ambient+this.mapLighting.ground+this.computeLevel(g,P.z+L)+this.computeTileLightIntensity(P))}computeNoAmbient(g,P,I=0){return this.computeLevel(g,P.z+I)+this.computeTileLightIntensity(P)}computeLevel(g,P){return g>=I.LightingType.Level?this.mapLighting.level*(P-1):0}computeTint(g){let P=1,L=1,_=1;return(g>=I.LightingType.Full||this.mapLighting.forceTint)&&(P=this.mapLighting.red,L=this.mapLighting.green,_=this.mapLighting.blue),new THREE.Vector3(P,L,_)}computeTileTint(g,P,L=new THREE.Vector3){let _=0,U=0,G=0;if(P>=I.LightingType.Full){var V=this.tileLights.get(g);if(V?.size)for(var W of V)_+=W.red,U+=W.green,G+=W.blue}return L.set(_,U,G)}computeTileLightIntensity(g){let P=0;var I=this.tileLights.get(g);if(I?.size)for(var L of I)P+=L.intensity;return P}getAmbientIntensity(){return this.mapLighting.ambient+this.mapLighting.ground}dispose(){this.disposables.dispose()}})}}}),System.register("engine/MapDigest",["data/Crc32"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("MapDigest",class{static compute(g){return I.Crc32.calculateCrc(g.getBytes()).toString(16)}})}}}),System.register("engine/MapList",["engine/MapManifest"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("MapList",class i{constructor(g){this.gameModes=g,this.manifests=[]}addFromIni(g){let P=g.getSection("MultiMaps");if(!P)throw new Error("Invalid map list. Missing [MultiMaps] section.");return this.manifests=this.manifests.concat([...P.entries.values()].map(P=>{var L=g.getSection(P);if(!L)throw new Error(`Invalid map list. Missing [${P}] section.`);return(new I.MapManifest).fromIni(L,this.gameModes.getAll())})),this.dedupeEntries(),this}add(g){this.manifests.push(g)}addFromMapFile(g){this.add((new I.MapManifest).fromMapFile(g,this.gameModes.getAll()))}getAll(){return this.manifests}getByName(g){return this.manifests.find(P=>P.fileName.toLowerCase()===g.toLowerCase())}sortByName(){this.manifests.sort((g,P)=>g.fileName.localeCompare(P.fileName))}clone(){let g=new i(this.gameModes);return g.manifests=[...this.manifests],g}mergeWith(g){return this.manifests.push(...g.manifests),this.dedupeEntries(),this}dedupeEntries(){this.manifests=[...new Map(this.manifests.map(g=>[g.fileName.toLowerCase(),g])).values()]}})}}}),System.register("engine/MapManifest",["data/IniFile"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("MapManifest",class{fromIni(g,P){return this.fileName=g.getString("File")||g.name.toLowerCase()+".map",this.uiName=g.getString("Description"),this.maxSlots=g.getNumber("MaxPlayers"),this.official=!0,this.gameModes=P.filter(P=>g.getArray("GameMode").includes(P.mapFilter)),this}getFullMapTitle(g){return this.addTitleSlotsSuffix(g.get(this.uiName),this.maxSlots)}addTitleSlotsSuffix(g,P){return g.match(/(\(|)\s*\d(-\d)?\s*(\)|)\s*$/)||(g+=` (2${2<P?"-"+P:""})`),g}fromMapFile(g,P){var L=g.readAsString();let _=g.filename;const U=new I.IniFile(this.extractIniSection("Basic",L)).getSection("Basic");if(!U)throw new Error(`Map "${_}" is missing the [Basic] section`);this.fileName=_,this.uiName="NOSTR:"+(U.getString("Name")||_.replace(/\.[^.]+$/,""));let G=(L=this.extractIniSection("Waypoints",L))?new I.IniFile(L).getSection("Waypoints"):void 0;this.maxSlots=[...G?.entries.keys()??[]].filter(g=>Number(g)<8).length,this.official=U.getBool("Official");let V=U.getArray("GameMode",void 0,["standard"]);return this.gameModes=P.filter(g=>V.includes(g.mapFilter)),this}extractIniSection(g,P){var I=P.indexOf(`[${g}]`);if(-1!==I){let g=I+1;for(;g<P.length&&("["!==P[g]||"\n"!==P[g-1]);g++);return P.slice(I,g)}}})}}}),System.register("engine/MapSupport",["game/rules/Rules","engine/Engine","game/theater/TileSets","engine/TheaterType","engine/type/ObjectType"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){g("MapSupport",class{static check(g,P){if(g.iniFormat<4)return P.get("TS:MapUnsupportedGame");if(g.startingLocations.length<2)return P.get("TXT_SCENARIO_TOO_SMALL",g.startingLocations.length);if(!L.Engine.supportsTheater(g.theaterType))return P.get("TS:MapUnsupportedTheater",U.TheaterType[g.theaterType]);var V,W,z,K,q,$,Q,Y=L.Engine.getTheaterIni(L.Engine.getActiveEngine(),g.theaterType);let Z=new _.TileSets(Y);if(g.maxTileNum>Z.readMaxTileNum())return P.get("TS:MapUnsupportedTileSet");let X=new I.Rules(L.Engine.getRules().clone().mergeWith(g));if(!X.hasOverlayId(g.maxOverlayId))return P.get("TS:MapUnsupportedOverlay",g.maxOverlayId);let J=X.getIni().getOrderedSections().map(g=>g.name.toLowerCase());for(V of X.weaponTypes.values()){if(!X.getIni().getSection(V))return P.get("TS:MapUnsupportedWeapon",V);var ee=X.getWeapon(V);let g=ee.projectile,I=ee.warhead;if(!g||!I)return P.get("TS:MapUnsupportedWeapon",V);if(!J.includes(g.toLowerCase()))return P.get("TS:MapUnsupportedProjectile",g);if(!J.includes(I.toLowerCase()))return P.get("TS:MapUnsupportedWarhead",I)}for(W of[...X.general.baseUnit,...X.general.harvesterUnit])if(W&&!X.hasObject(W,G.ObjectType.Vehicle))return P.get("TS:MapUnsupportedTechno",W);for(z of X.general.defaultMirageDisguises)if(z&&!X.terrainRules.has(z))return P.get("TS:MapUnsupportedTerrain",z);for(K of[X.general.engineer,X.general.crew.alliedCrew,X.general.crew.sovietCrew,X.general.alliedDisguise,X.general.sovietDisguise])if(K&&!X.infantryRules.has(K))return P.get("TS:MapUnsupportedTechno",K);for(q of[X.crateRules.crateImg,X.crateRules.waterCrateImg])if(q&&!X.overlayRules.has(q))return P.get("TS:MapUnsupportedOverlay",q);for($ of X.buildingRules.values())if($.undeploysInto&&!X.hasObject($.undeploysInto,G.ObjectType.Vehicle))return P.get("TS:MapUnsupportedTechno",$.undeploysInto);for(Q of[...X.infantryRules.values(),...X.vehicleRules.values(),...X.aircraftRules.values()]){if(Q.spawns&&!X.hasObject(Q.spawns,G.ObjectType.Aircraft))return P.get("TS:MapUnsupportedTechno",Q.spawns);if(Q.deploysInto&&!X.hasObject(Q.deploysInto,G.ObjectType.Building))return P.get("TS:MapUnsupportedTechno",Q.deploysInto)}}})}}}),System.register("engine/mixDatabase",[],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[],execute:function(){g("mixDatabase",I=(new Map).set("cameo.mix",["adogicon.shp","adoguico.shp","aengicon.shp","aenguico.shp","agapgen.shp","agisicon.shp","ahrvicon.shp","ahrvuico.shp","aparicon.shp","apchicon.shp","apcicon.shp","artyicon.shp","asaticon.shp","ayaricon.shp","batricon.shp","beagicon.shp","bggyicon.shp","bolticon.shp","brrkicon.shp","carricon.shp","ccomicon.shp","ccomuico.shp","chemicon.shp","chroicon.shp","clckicon.shp","clegicon.shp","cleguico.shp","clonicon.shp","cnsticon.shp","crryicon.shp","csphicon.shp","darken.shp","desoicon.shp","desouico.shp","desticon.shp","detnicon.shp","dlphicon.shp","dlphuico.shp","dogicon.shp","doguico.shp","dredicon.shp","dronicon.shp","e1icon.shp","e1uico.shp","e2icon.shp","e2uico.shp","e4icon.shp","empicon.shp","engnicon.shp","facticon.shp","falcicon.shp","fixicon.shp","flakicon.shp","flkticon.shp","flktuico.shp","forticon.shp","fsdicon.shp","fspicon.shp","fstdicon.shp","fvicon.shp","fvuico.shp","gapicon.shp","gat2icon.shp","gateicon.shp","gbayicon.shp","gcanicon.shp","giicon.shp","giuico.shp","gorep.shp","gtnkicon.shp","gtnkuico.shp","gwepicon.shp","handicon.shp","harvicon.shp","harvuico.shp","heliicon.shp","hindicon.shp","hmecicon.shp","hovricon.shp","htkicon.shp","htkuico.shp","htnkicon.shp","htnkuico.shp","ioncicon.shp","ircricon.shp","ironicon.shp","ivanicon.shp","ivanuico.shp","ivncicon.shp","ivncuico.shp","jjeticon.shp","jjetuico.shp","landicon.shp","lasricon.shp","liteicon.shp","lpsticon.shp","mcvicon.shp","mcvuico.shp","metricon.shp","mltiicon.shp","mmchicon.shp","msslicon.shp","mtnkicon.shp","mtnkuico.shp","mutcicon.shp","nga2icon.shp","ngaticon.shp","nhpdicon.shp","npsiicon.shp","npwricon.shp","nradicon.shp","nrcticon.shp","nreficon.shp","ntchicon.shp","nukeicon.shp","nwalicon.shp","nwepicon.shp","obliicon.shp","obmbicon.shp","orcaicon.shp","otrnicon.shp","paraicon.shp","pillicon.shp","plticon.shp","plugicon.shp","podsicon.shp","powricon.shp","prisicon.shp","proicon.shp","psicicon.shp","psicuico.shp","psisicon.shp","psiticon.shp","psituico.shp","rad1icon.shp","rad2icon.shp","rad3icon.shp","radricon.shp","rboticon.shp","reficon.shp","rfixicon.shp","rtnkicon.shp","rtnkuico.shp","samicon.shp","sapcicon.shp","sapicon.shp","sbagicon.shp","sealicon.shp","sealuico.shp","seekicon.shp","shadicon.shp","shaduico.shp","shkicon.shp","shkuico.shp","smchicon.shp","smcvicon.shp","smcvuico.shp","snipicon.shp","snipuico.shp","soniicon.shp","spoticon.shp","spyicon.shp","spyuico.shp","sqdicon.shp","sreficon.shp","srefuico.shp","stnkicon.shp","subicon.shp","subticon.shp","tanyicon.shp","tanyuico.shp","techicon.shp","tempicon.shp","teslaicon.shp","tickicon.shp","tnkdicon.shp","tnkduico.shp","towricon.shp","trkaicon.shp","trsticon.shp","trstuico.shp","tslaicon.shp","ttnkicon.shp","ttnkuico.shp","turbicon.shp","twr1icon.shp","twr2icon.shp","twr3icon.shp","v3icon.shp","v3uico.shp","wallicon.shp","weapicon.shp","weaticon.shp","weedicon.shp","wethicon.shp","xxicon.shp","yardicon.shp","yuriicon.shp","yuriuico.shp","yurpicon.shp","yurpuico.shp","zepicon.shp","zepuico.shp"]).set("theme.mix",["200meter.wav","blowitup.wav","burn.wav","destroy.wav","eaglehun.wav","fortific.wav","grinder.wav","hm2.wav","indeep.wav","industro.wav","jank.wav","motorize.wav","power.wav","ra2-opt.wav","ra2-sco.wav","tension.wav"]).set("thememd.mix",["brainfre.wav","bully.wav","deceiver.wav","defend.wav","drok.wav","optionx.wav","phatatta.wav","scorex.wav","tactics.wav","trancelv.wav"])),L=["addon.shp","bkgdlg.shp","bkgdmd.shp","bkgdsm.shp","bttnbkgd.shp","button00.shp","button01.shp","button02.shp","button03.shp","button04.shp","button05.shp","button06.shp","button07.shp","button08.shp","button09.shp","button10.shp","button11.shp","credits.shp","diplobtn.shp","gclock2.shp","key.ini","lendcap.shp","lspacer.shp","optbtn.shp","pbeacon.shp","power.shp","powerp.shp","pwrlvl.shp","radar.shp","radar01.shp","radar02.shp","r-dn.shp","rdrbeacn.shp","rendcap.shp","repair.shp","r-up.shp","sell.shp","side1.shp","side2.shp","side2b.shp","side3.shp","sidebar.pal","sidebttn.shp","tab00.shp","tab01.shp","tab02.shp","tab03.shp","tabs.shp","top.shp","uibkgd.pal","wayp.shp"],I.set("sidec01.mix",L).set("sidec02.mix",L),L=["reportbug.shp"],I.set("sidec01cd.mix",L).set("sidec02cd.mix",L)}}}),System.register("engine/renderable/AlphaRenderable",["data/Palette","engine/renderable/builder/ShpBuilder","util/Color","game/Coords"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("AlphaRenderable",class l{static getOrCreateAlphaPalette(){let g=l.alphaPalette;if(!g){g=new I.Palette(new Array(768).fill(0));let L=[];for(let g=0;g<256;g++){var P=127<g?2*(g-127):0;L.push(new _.Color(P,P,P))}g.setColors(L),l.alphaPalette=g}return g}constructor(g,P,I){this.shpFile=g,this.camera=P,this.visible=!0,this.drawOffset={...I}}setVisible(g){this.visible=g,this.object3d&&(this.object3d.visible=g)}setSize(g){this.shpSize=g,this.builder?.setSize(g)}create3DObject(){if(!this.object3d){var g=l.getOrCreateAlphaPalette();let P=new L.ShpBuilder(this.shpFile,g,this.camera,U.Coords.ISO_WORLD_SCALE);this.shpSize&&P.setSize(this.shpSize),P.setFrame(0),P.setOffset(this.drawOffset);let I=P.build();I.visible=this.visible,I.renderOrder=999995;let _=I.material;_.depthTest=!1,_.depthWrite=!0,_.transparent=!0,_.blending=THREE.CustomBlending,_.blendEquation=THREE.AddEquation,_.blendSrc=THREE.DstColorFactor,_.blendDst=THREE.OneFactor,this.builder=P,this.object3d=I}}get3DObject(){return this.object3d}update(g){}dispose(){this.builder?.dispose()}})}}}),System.register("engine/renderable/builder/BatchShpBuilder",["engine/renderable/builder/ShpTextureAtlas","engine/gfx/SpriteUtils","engine/gfx/TextureUtils","engine/gfx/material/PaletteBasicMaterial"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("BatchShpBuilder",class{get verticesPerSprite(){return L.SpriteUtils.VERTICES_PER_SPRITE}get trianglesPerSprite(){return L.SpriteUtils.TRIANGLES_PER_SPRITE}constructor(g,P,I,L,_=1,U=!1,G=1e4,V=1){this.shpFile=g,this.palette=P,this.camera=I,this.textureCache=L,this.opacity=_,this.transparent=U,this.batchSize=G,this.scale=V,this.specIndexes=new Map}initTexture(){var g;this.textureCache.has(this.shpFile)?this.atlas=this.textureCache.get(this.shpFile):(g=(new I.ShpTextureAtlas).fromShpFile(this.shpFile),this.textureCache.set(this.shpFile,g),this.atlas=g)}getSpriteGeometryOptions(g){var P={x:(P=this.shpFile.getImage(g.frameNo)).x-g.shpFile.width/2+g.offset.x,y:P.y-g.shpFile.height/2+g.offset.y};return{texture:this.atlas.getTexture(),textureArea:this.atlas.getTextureArea(g.frameNo),flat:g.flat,depth:g.depth,align:{x:1,y:-1},offset:P,camera:this.camera,scale:this.scale}}setPalette(g){if(this.palette=g,this.mesh){var P=_.TextureUtils.textureFromPalette(g);this.mesh.material.palette=P}}build(){if(this.mesh)return this.mesh;this.initTexture();var g=_.TextureUtils.textureFromPalette(this.palette);let P=new THREE.BufferGeometry;var I,G=this.batchSize*this.verticesPerSprite,V=new THREE.BufferAttribute(new Float32Array(3*G),3);P.addAttribute("position",V),this.positionAttribute=V,P.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(2*G),2)),L.SpriteUtils.USE_INDEXED_GEOMETRY&&(I=this.batchSize*this.trianglesPerSprite*3,P.setIndex(new THREE.BufferAttribute(new Uint32Array(3*I),1)));var W;G=new THREE.BufferAttribute(new Float32Array(4*G),4);P.addAttribute("vertexColorMult",G),this.colorMultAttribute=G;let z=0;for(W of this.specIndexes.keys())this.specIndexes.set(W,z),this.setSpecGeometry(W,P,z),z++;if(this.firstFreeSpriteIdx=z<this.batchSize?z:-1,z<this.batchSize){let g=V.array;for(let P=z;P<this.batchSize-1;P++)g[P*this.verticesPerSprite*3]=P+1;g[(this.batchSize-1)*this.verticesPerSprite*3]=-1}g=new U.PaletteBasicMaterial({map:this.atlas.getTexture(),palette:g,alphaTest:this.transparent?.05:.5,flatShading:!0,transparent:this.transparent,opacity:this.opacity,useVertexColorMult:!0});let K=new THREE.Mesh(P,g);return K.matrixAutoUpdate=!1,K.frustumCulled=!1,this.mesh=K,K}add(g){if(!this.specIndexes.has(g)){if(this.isFull())throw new Error("Batch is full");var P=this.mesh?.geometry;if(P){var I=this.firstFreeSpriteIdx;if(-1===I)throw new Error("No free sprite index found");this.specIndexes.set(g,I);var L=(this.positionAttribute?.array)[I*this.verticesPerSprite*3];this.setSpecGeometry(g,P,I),this.firstFreeSpriteIdx=L}else this.specIndexes.set(g,void 0)}}setSpecGeometry(g,P,I){var _=this.getSpriteGeometryOptions(g);let U=L.SpriteUtils.createSpriteGeometry(_);_=g.position,U.applyMatrix((new THREE.Matrix4).makeTranslation(_.x,_.y,_.z));let G=U;if(G.getAttribute("position").count!==this.verticesPerSprite)throw new Error("Vertex count mismatch");P.merge(G,I*this.verticesPerSprite),G.index&&(P.index.array.set(Uint32Array.from(G.index.array,g=>g+I*this.verticesPerSprite),I*G.index.array.length),P.index.needsUpdate=!0);var V;_=g.lightMult??new THREE.Vector3(1,1,1);for(V of(this.setLightingAt(I,_,this.colorMultAttribute.array),this.setVisibilityAt(I,!0,this.colorMultAttribute.array),Object.values(P.attributes)))V.needsUpdate=!0}has(g){return this.specIndexes.has(g)}remove(g){if(this.specIndexes.has(g)){if(this.mesh){var P=this.specIndexes.get(g);this.setVisibilityAt(P,!1,this.colorMultAttribute.array),this.colorMultAttribute.needsUpdate=!0,this.positionAttribute.array[P*this.verticesPerSprite*3]=this.firstFreeSpriteIdx,this.firstFreeSpriteIdx=P}this.specIndexes.delete(g)}}update(g){var P;!this.specIndexes.has(g)||(P=this.mesh?.geometry)&&this.setSpecGeometry(g,P,this.specIndexes.get(g))}isFull(){return this.specIndexes.size===this.batchSize}isEmpty(){return 0===this.specIndexes.size}setLightingAt(g,P,I){for(let L=0;L<this.verticesPerSprite;L++)I[g*this.verticesPerSprite*4+4*L]=P.x,I[g*this.verticesPerSprite*4+4*L+1]=P.y,I[g*this.verticesPerSprite*4+4*L+2]=P.z}setVisibilityAt(g,P,I){for(let L=0;L<this.verticesPerSprite;L++)I[g*this.verticesPerSprite*4+4*L+3]=P?1:0}updateLighting(){if(this.mesh){let g=this.colorMultAttribute.array;this.specIndexes.forEach((P,I)=>{var L=I.lightMult??new THREE.Vector3(1,1,1);this.setLightingAt(P,L,g)}),this.colorMultAttribute.needsUpdate=!0}}dispose(){this.mesh&&(this.mesh.geometry.dispose(),this.mesh.material.dispose())}})}}}),System.register("engine/renderable/builder/CanvasSpriteBuilder",["engine/gfx/SpriteUtils","engine/renderable/builder/CanvasTextureAtlas"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("CanvasSpriteBuilder",_=class s{static clearCaches(){s.textureCache.clear()}constructor(g,P){this.images=g,this.camera=P,this.offset={x:0,y:0},this.align={x:0,y:0},this.opacity=1,this.forceTransparent=!1,this.frustumCulled=!1,this.frameGeometries=new Map,this.setFrame(0)}setOffset(g){this.offset=g}setAlign(g,P){var L;this.align={x:g,y:P},this.mesh&&(this.frameGeometries.get(this.frameNo)?.dispose(),L=I.SpriteUtils.createSpriteGeometry(this.getSpriteGeometryOptions()),this.frameGeometries.set(this.frameNo,L),this.mesh.geometry=L)}initTexture(){if(s.textureCache.has(this.images))this.atlas=s.textureCache.get(this.images);else{let g=new L.CanvasTextureAtlas;g.pack(this.images),s.textureCache.set(this.images,g),this.atlas=g}}getSpriteGeometryOptions(){var g=this.images[this.frameNo],P={x:-g.width/2-this.align.x*(g.width/2)+this.offset.x,y:-g.height/2-this.align.y*(g.height/2)+this.offset.y};return{texture:this.atlas.getTexture(),textureArea:this.atlas.getImageRect(g),align:{x:1,y:-1},offset:P,camera:this.camera}}setFrame(g){if(this.frameNo!==g&&(this.frameNo=g,this.mesh)){let P=this.frameGeometries.get(g);P||(P=I.SpriteUtils.createSpriteGeometry(this.getSpriteGeometryOptions()),this.frameGeometries.set(g,P)),this.mesh.geometry=P}}getFrame(){return this.frameNo}getSize(){return{width:this.images[this.frameNo].width,height:this.images[this.frameNo].height}}get frameCount(){return this.images.length}setOpacity(g){var P=this.opacity;P!==g&&(this.opacity=g,this.mesh&&(this.mesh.material.opacity=g),Math.floor(P)===Math.floor(g)||this.forceTransparent||this.updateTransparency())}setForceTransparent(g){this.forceTransparent!==g&&(this.forceTransparent=g,this.updateTransparency())}updateTransparency(){this.mesh&&(this.mesh.material.transparent=this.forceTransparent||this.opacity<1)}setExtraLight(g){throw new Error("Not implemented")}setFrustumCulled(g){this.frustumCulled=g,this.mesh&&(this.mesh.frustumCulled=g)}build(){if(this.mesh)return this.mesh;this.initTexture();var g=I.SpriteUtils.createSpriteGeometry(this.getSpriteGeometryOptions());this.frameGeometries.set(this.frameNo,g);var P=new THREE.MeshBasicMaterial({map:this.atlas.getTexture(),flatShading:!0,opacity:this.opacity,transparent:this.opacity<1||this.forceTransparent});let L=new THREE.Mesh(g,P);return L.matrixAutoUpdate=!1,L.frustumCulled=this.frustumCulled,this.mesh=L,L}dispose(){this.frameGeometries.forEach(g=>g.dispose()),this.mesh?.material?.dispose()}}),_.textureCache=new Map}}}),System.register("engine/renderable/builder/CanvasTextureAtlas",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("CanvasTextureAtlas",class{getTexture(){if(!this.texture)throw new Error("Texture atlas not initialized");return this.texture}getImageRect(g){if(!this.imageRects)throw new Error("Texture atlas not initialized");var P=this.imageRects.get(g);if(!P)throw new Error("Image not found in atlas");return P}pack(g){let P=[];g.forEach(g=>{P.push({w:g.width,h:g.height,image:g})}),P.sort((g,P)=>1e3*(P.w-g.w)+P.h-g.h);let I=new GrowingPacker;I.fit(P);var L=I.root.w,_=I.root.h;let U=document.createElement("canvas"),G=U.getContext("2d",{alpha:!0});U.width=L,U.height=_;let V=new Map;P.forEach(g=>{if(!g.fit)throw new Error("Couldn't fit all images in a single texture");var P=g.image,I=g.fit.x,L=g.fit.y;V.set(P,{x:I,y:L,width:g.w,height:g.h}),G.drawImage(P,I,L)});let W=new THREE.Texture(U);W.minFilter=THREE.NearestFilter,W.magFilter=THREE.NearestFilter,W.needsUpdate=!0,this.texture=W,this.imageRects=V}})}}}),System.register("engine/renderable/builder/ObjectBuilder",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("engine/renderable/builder/ShpAggregator",["data/ShpFile","data/ShpImage"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("ShpAggregator",class{static getShpFrameInfo(g,P){return{file:g,hasShadow:P,frameCount:Math.floor(g.numImages*(P?.5:1))}}aggregate(g,P){let _=new I.ShpFile;_.filename=P;let U=[],G=new Map,V=0;for(var{file:W,hasShadow:z,frameCount:K}of g)if(!G.has(W)){G.set(W,V);for(let g=0;g<K;g++)_.addImage(W.getImage(g)),U.push(z?W.getImage(K+g):new L.ShpImage),V++}return U.forEach(g=>_.addImage(g)),{file:_,imageIndexes:G}}})}}}),System.register("engine/renderable/builder/ShpBuilder",["engine/gfx/TextureUtils","engine/gfx/SpriteUtils","engine/renderable/builder/ShpTextureAtlas","engine/gfx/material/PaletteBasicMaterial","engine/gfx/batch/BatchedMesh"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){g("ShpBuilder",V=class a{static prepareTexture(g){var P;a.textureCache.has(g)||(P=(new _.ShpTextureAtlas).fromShpFile(g),a.textureCache.set(g,P))}static clearCaches(){a.textureCache.forEach(g=>g.dispose()),a.textureCache.clear(),a.geometryCache.forEach(g=>g.forEach(g=>g.dispose())),a.geometryCache.clear()}constructor(g,P,I,L=1,_=!1,U=0){this.scale=L,this.depth=_,this.depthOffset=U,this.batchPalettes=[],this.useMeshBatching=!1,this.opacity=1,this.forceTransparent=!1,this.offset={x:0,y:0},this.frameOffset=0,this.flat=!1,this.shpFile=g,this.palette=P,this.camera=I,this.shpSize={width:g.width,height:g.height},this.setFrame(0)}useMaterial(g,P,I){if(g.format!==THREE.AlphaFormat)throw new Error("Texture must have format THREE.AlphaFormat");this.materialCacheKey=g.uuid+"_"+P.uuid+"_"+Number(I);let L,_=a.materialCache.get(this.materialCacheKey);return _?(L=_.material,_.usages++):(L=new U.PaletteBasicMaterial({map:g,palette:P,alphaTest:.05,paletteCount:this.batchPalettes.length,flatShading:!0,transparent:I}),_={material:L,usages:1},a.materialCache.set(this.materialCacheKey,_)),L}freeMaterial(){if(!this.materialCacheKey)throw new Error("Material cache key not set");let g=a.materialCache.get(this.materialCacheKey);g&&(1===g.usages?(a.materialCache.delete(this.materialCacheKey),g.material.dispose()):g.usages--)}setBatched(g){if(this.mesh)throw new Error("Batching can only be set before calling build()");this.useMeshBatching=g}setOffset(g){if(this.mesh)throw new Error("Offset can only be set before calling build()");this.offset=g}setFrameOffset(g){if(this.mesh)throw new Error("frameOffset can only be set before calling build()");this.frameOffset=g}initTexture(){a.prepareTexture(this.shpFile),this.atlas=a.textureCache.get(this.shpFile)}getSpriteGeometryOptions(g){g+=this.frameOffset;var P={x:(P=this.shpFile.getImage(g)).x-Math.floor(this.shpSize.width/2)+Math.floor(this.offset.x),y:P.y-Math.floor(this.shpSize.height/2)+Math.floor(this.offset.y)};return{texture:this.atlas.getTexture(),textureArea:this.atlas.getTextureArea(g),flat:this.flat,align:{x:1,y:-1},offset:P,camera:this.camera,depth:this.depth,depthOffset:this.depthOffset,scale:this.scale}}getGeometryCacheKey(g){return g+this.frameOffset+"_"+this.shpSize.width+"_"+this.shpSize.height+"_"+this.offset.x+"_"+this.offset.y+"_"+this.flat+"_"+this.depth+"_"+this.depthOffset}setFrame(g){if(this.frameNo!==g&&(this.frameNo=g,this.mesh)){let I=this.getGeometryCache();var P=this.getGeometryCacheKey(g);let _=I.get(P);_||(_=L.SpriteUtils.createSpriteGeometry(this.getSpriteGeometryOptions(g)),I.set(P,_)),this.mesh.geometry=_}}getGeometryCache(){let g=a.geometryCache.get(this.shpFile);return g||(g=new Map,a.geometryCache.set(this.shpFile,g)),g}getFrame(){return this.frameNo}setSize(g){this.shpSize={width:g.width,height:g.height}}getSize(){return this.shpSize}get frameCount(){return this.shpFile.numImages}getBatchPaletteIndex(g){var P=this.batchPalettes.findIndex(P=>P.hash===g.hash);if(-1===P)throw new Error("Provided palette not found in the list of batch palettes. Call setBatchPalettes first.");return P}setPalette(g){if(this.palette=g,this.mesh)if(this.useMeshBatching){var P=this.getBatchPaletteIndex(g);this.mesh.setPaletteIndex(P)}else{P=I.TextureUtils.textureFromPalette(g),this.mesh.material.palette=P}}setBatchPalettes(g){if(!this.useMeshBatching)throw new Error("Can't use multiple palettes when not batching");if(this.mesh)throw new Error("Palettes must be set before creating 3DObject");this.batchPalettes=g}setExtraLight(g){if(this.extraLight=g,this.mesh)if(this.useMeshBatching)this.mesh.setExtraLight(g);else{this.mesh.material.extraLight=g}}setOpacity(g){var P=this.opacity;P!==g&&(this.opacity=g,this.updateOpacity()),Math.floor(P)===Math.floor(g)||this.forceTransparent||this.updateTransparency()}setForceTransparent(g){g!==this.forceTransparent&&(this.forceTransparent=g,this.updateTransparency())}updateOpacity(){this.mesh&&(this.useMeshBatching?this.mesh.setOpacity(this.opacity):this.mesh.material.opacity=this.opacity)}updateTransparency(){var g,P,I;this.mesh&&(g=this.forceTransparent||this.opacity<1,this.useMeshBatching?(P=this.mesh.material.map,I=this.mesh.material.palette,this.freeMaterial(),this.mesh.material=this.useMaterial(P,I,g)):this.mesh.material.transparent=g)}build(){if(this.mesh)return this.mesh;this.initTexture();var g,P=this.atlas.getTexture(),_=this.getGeometryCacheKey(this.frameNo);let V,W=this.getGeometryCache(),z=W.get(_);z||(g=this.getSpriteGeometryOptions(this.frameNo),z=L.SpriteUtils.createSpriteGeometry(g),W.set(_,z));var K;_=this.opacity<1||this.forceTransparent;return this.useMeshBatching?(K=I.TextureUtils.textureFromPalettes(this.batchPalettes),K=this.useMaterial(P,K,_),V=new G.BatchedMesh(z,K,G.BatchMode.Merging),V.castShadow=!1):(K=I.TextureUtils.textureFromPalette(this.palette),_=new U.PaletteBasicMaterial({map:P,palette:K,alphaTest:.5,flatShading:!0,transparent:_}),V=new THREE.Mesh(z,_)),V.matrixAutoUpdate=!1,this.mesh=V,this.setPalette(this.palette),this.updateOpacity(),this.extraLight&&this.setExtraLight(this.extraLight),V}dispose(){this.mesh&&(this.useMeshBatching?this.freeMaterial():this.mesh.material.dispose(),this.mesh=void 0)}}),V.textureCache=new Map,V.geometryCache=new Map,V.materialCache=new Map}}}),System.register("engine/renderable/builder/ShpTextureAtlas",["data/Bitmap","engine/gfx/TextureAtlas"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("ShpTextureAtlas",class{fromShpFile(g){let P=[];for(let L=0;L<g.numImages;L++){var _=g.getImage(L);P.push(new I.IndexedBitmap(_.width,_.height,_.imageData))}let U=new L.TextureAtlas;return U.pack(P),this.images=P,this.atlas=U,this}getTextureArea(g){return this.atlas.getImageRect(this.images[g])}getTexture(){return this.atlas.getTexture()}dispose(){this.atlas.dispose()}})}}}),System.register("engine/renderable/builder/SpriteBuilder",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("engine/renderable/builder/VxlBatchedBuilder",["engine/gfx/TextureUtils","engine/gfx/batch/BatchedMesh","engine/renderable/builder/VxlBuilder","engine/gfx/material/PalettePhongMaterial"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=class a extends _.VxlBuilder{constructor(g,P,I,L,_,U){super(U),this.vxlFile=g,this.hvaFile=P,this.palettes=I,this.palette=L,this.vxlGeometryPool=_,this.clippingPlanes=[],this.opacity=1,this.castShadow=!0}createVxlMeshes(){var g=I.TextureUtils.textureFromPalettes(this.palettes);let P=this.useMaterial(g);this.materialCacheKey=g;let _=this.getPaletteIndex(this.palette),U=this.vxlFile.sections,G=new Map;return U.forEach((g,I)=>{var U=this.vxlGeometryPool.get(g);let V=new L.BatchedMesh(U,P),W=g.transfMatrix,z=this.hvaFile?.sections[I];z&&(W=g.scaleHvaMatrix(z.getMatrix(0))),V.applyMatrix(W),G.set(g.name,V),V.castShadow=this.castShadow,V.setPaletteIndex(_),this.extraLight&&V.setExtraLight(this.extraLight),V.setOpacity(this.opacity),V.setClippingPlanes(this.clippingPlanes)}),G}useMaterial(g){let P,I=a.materialCache.get(g);return I?(P=I.material,I.usages++):(P=new U.PalettePhongMaterial({palette:g,paletteCount:this.palettes.length,vertexColors:THREE.VertexColors,transparent:!0}),I={material:P,usages:1},a.materialCache.set(g,I)),P}freeMaterial(){let g=a.materialCache.get(this.materialCacheKey);g&&(1===g.usages?(a.materialCache.delete(this.materialCacheKey),g.material.dispose()):g.usages--)}getPaletteIndex(g){var P=this.palettes.findIndex(P=>P.hash===g.hash);if(-1===P)throw new Error("Provided palette not found in the list of available palettes");return P}setPalette(g){if(this.palette=g,this.object){let P=this.getPaletteIndex(g);this.sections.forEach(g=>g.setPaletteIndex(P))}}setExtraLight(g){this.extraLight=g,this.object&&this.sections.forEach(P=>P.setExtraLight(g))}setShadow(g){this.castShadow=g,this.sections?.forEach(P=>{P.castShadow=g})}setClippingPlanes(g){this.clippingPlanes=g,this.object&&this.sections.forEach(P=>P.setClippingPlanes(g))}setOpacity(g){this.opacity=g,this.object&&this.sections.forEach(P=>P.setOpacity(g))}dispose(){this.object&&(this.freeMaterial(),this.object=void 0)}},g("VxlBatchedBuilder",G),G.materialCache=new Map}}}),System.register("engine/renderable/builder/VxlBuilder",["game/Coords"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("VxlBuilder",class{constructor(g){this.camera=g}build(){if(this.object)return this.object;let g=this.object=new THREE.Object3D,P=Math.cos(this.camera.rotation.y)*I.Coords.ISO_WORLD_SCALE;g.scale.set(P,P,P);let L=new THREE.Object3D;return L.rotation.x=-Math.PI/2,L.rotation.z=+Math.PI/2,L.matrixAutoUpdate=!1,L.updateMatrix(),g.add(L),(this.sections=this.createVxlMeshes()).forEach(g=>{var I;g.matrixAutoUpdate=!1,L.add(g),this.localBoundingBox||(g.geometry.boundingBox||g.geometry.computeBoundingBox(),this.localBoundingBox=new THREE.Box3(g.geometry.boundingBox.min.clone().multiplyScalar(P),g.geometry.boundingBox.max.clone().multiplyScalar(P)),I=this.localBoundingBox.min.x,this.localBoundingBox.min.x=this.localBoundingBox.min.y,this.localBoundingBox.min.y=I,I=this.localBoundingBox.max.x,this.localBoundingBox.max.x=this.localBoundingBox.max.y,this.localBoundingBox.max.y=I)}),g.matrixAutoUpdate=!1,g.updateMatrix(),g}getSection(g){if(!this.sections)throw new Error("Vxl object must be built first");return this.sections.get(g)}getLocalBoundingBox(){return this.localBoundingBox}})}}}),System.register("engine/renderable/builder/VxlBuilderFactory",["engine/renderable/builder/VxlBatchedBuilder","engine/renderable/builder/VxlNonBatchedBuilder"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("VxlBuilderFactory",class{constructor(g,P,I){this.vxlGeometryPool=g,this.useBatching=P,this.camera=I}create(g,P,_,U){return this.useBatching?new I.VxlBatchedBuilder(g,P,_,U,this.vxlGeometryPool,this.camera):new L.VxlNonBatchedBuilder(g,P,U,this.vxlGeometryPool,this.camera)}})}}}),System.register("engine/renderable/builder/vxlGeometry/VxlGeometryCulledBuilder",["engine/gfx/BufferGeometryUtils"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("VxlGeometryCulledBuilder",class{build(g){let{voxels:P,voxelField:L}=g.getAllVoxels(),_=new THREE.BoxBufferGeometry(1,1,1);var U=_.getAttribute("position").array,G=U.length/3,V=_.getAttribute("normal").array,W=_.getIndex().array;let z=[],K=[],q=[],$=[];var Q=g.minBounds,Y=g.scale,Z=g.getNormals();let X=0;for(let g=0,I=P.length;g<I;g++){var J=P[g],ee=Z[Math.min(P[g].normalIndex,Z.length-1)];let I=new Array(G);for(let g=0,P=3*G;g<P;g+=3)L.get(J.x+V[g],J.y+V[g+1],J.z+V[g+2])||(I[g/3]=X,z.push(Q.x+J.x*Y.x+U[g],Q.y+J.y*Y.y+U[g+1],Q.z+J.z*Y.z+U[g+2]),K.push(ee.x,ee.y,ee.z),q.push(J.colorIndex/255,0,0),X++);for(let g=0,P=W.length;g<P;g+=3){var te=I[W[g]],re=I[W[g+1]],se=I[W[g+2]];void 0!==te&&void 0!==re&&void 0!==se&&$.push(te,re,se)}}let ae=new THREE.BufferGeometry;return ae.setIndex(new THREE.BufferAttribute(new Uint32Array($),1)),ae.addAttribute("position",new THREE.BufferAttribute(new Float32Array(z),3)),ae.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(K),3)),ae.addAttribute("color",new THREE.BufferAttribute(new Float32Array(q),3)),ae=I.BufferGeometryUtils.mergeVertices(ae),ae.computeBoundingBox(),ae}})}}}),System.register("engine/renderable/builder/vxlGeometry/VxlGeometryMonotoneBuilder",["engine/gfx/BufferGeometryUtils"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("VxlGeometryMonotoneBuilder",class{build(g,P=!1){let _=g.getAllVoxels().voxelField;var{vertices:U,faces:G}=function(g,P){for(var I=[],_=[],U=0;U<3;++U){var G=(U+1)%3,V=(U+2)%3,W=new Int32Array(3),z=new Int32Array(3),K=new Int32Array(2*(P[G]+1)),q=new Int32Array(P[G]),$=new Int32Array(P[G]),Q=new Int32Array(2*P[V]),Y=new Int32Array(2*P[V]),Z=new Int32Array(24*P[V]),X=[[0,0],[0,0]];for(z[U]=1,W[U]=-1;W[U]<P[U];){var J=[],ee=0;for(W[V]=0;W[V]<P[V];++W[V]){var te=0,re=0,se=0;for(W[G]=0;W[G]<P[G];++W[G],re=se){var ae=0<=W[U]?g(W[0],W[1],W[2]):0,ne=W[U]<P[U]-1?g(W[0]+z[0],W[1]+z[1],W[2]+z[2]):0;!(se=ae)==!ne?se=0:ae||(se=-ne),re!==se&&(K[te++]=W[G],K[te++]=se)}K[te++]=P[G];for(var oe=K[te++]=0,le=0,ce=0;le<ee&&ce<te-2;){let g=J[q[le]];var he=g.left[g.left.length-1][0],ue=g.right[g.right.length-1][0],de=g.color,ge=K[ce],pe=K[ce+2],me=K[ce+1];he<pe&&ge<ue&&me===de?(g.merge_run(W[V],ge,pe),$[oe++]=q[le],++le,ce+=2):(pe<=ue&&(me&&(fe=new L(me,W[V],ge,pe),$[oe++]=J.length,J.push(fe)),ce+=2),ue<=pe&&(g.close_off(W[V]),++le))}for(;le<ee;++le)J[q[le]].close_off(W[V]);for(;ce<te-2;ce+=2){var fe;ge=K[ce],pe=K[ce+2];(me=K[ce+1])&&(fe=new L(me,W[V],ge,pe),$[oe++]=J.length,J.push(fe))}var ye=$;$=q,q=ye,ee=oe}for(le=0;le<ee;++le){J[q[le]].close_off(P[V])}for(W[U]++,le=0;le<J.length;++le){var Te=J[le],ve=!1;for((se=Te.color)<0&&(ve=!0,se=-se),ce=0;ce<Te.left.length;++ce){Q[ce]=I.length;var be=[0,0,0],Se=Te.left[ce];be[U]=W[U],be[G]=Se[0],be[V]=Se[1],I.push({position:be,value:se})}for(ce=0;ce<Te.right.length;++ce)Y[ce]=I.length,be=[0,0,0],Se=Te.right[ce],be[U]=W[U],be[G]=Se[0],be[V]=Se[1],I.push({position:be,value:se});var we=0,Ee=0,Ce=1,xe=1,Oe=!0;for(Z[Ee++]=Q[0],Z[Ee++]=Te.left[0][0],Z[Ee++]=Te.left[0][1],Z[Ee++]=Y[0],Z[Ee++]=Te.right[0][0],Z[Ee++]=Te.right[0][1];Ce<Te.left.length||xe<Te.right.length;){var Ae,Me,Re=!1;Ce===Te.left.length?Re=!0:xe!==Te.right.length&&(Ae=Te.left[Ce],Me=Te.right[xe],Re=Ae[1]>Me[1]);var Pe=Re?Y[xe]:Q[Ce],Ie=Re?Te.right[xe]:Te.left[Ce];if(Re!==Oe)for(;we+3<Ee;)ve===Re?_.push([Z[we],Z[we+3],Pe]):_.push([Z[we+3],Z[we],Pe]),we+=3;else for(;we+3<Ee;){for(ce=0;ce<2;++ce)for(var ke=0;ke<2;++ke)X[ce][ke]=Z[Ee-3*(ce+1)+ke+1]-Ie[ke];var Be=X[0][0]*X[1][1]-X[1][0]*X[0][1];if(Re===0<Be)break;0!=Be&&(ve===Re?_.push([Z[Ee-3],Z[Ee-6],Pe]):_.push([Z[Ee-6],Z[Ee-3],Pe])),Ee-=3}Z[Ee++]=Pe,Z[Ee++]=Ie[0],Z[Ee++]=Ie[1],Re?++xe:++Ce,Oe=Re}}}}return{vertices:I,faces:_}}(P?(g,P,I)=>{var L=_.get(g,P,I);return L?L.colorIndex:0}:(g,P,I)=>{var L=_.get(g,P,I);return L?L.normalIndex+256*L.colorIndex:0},[g.sizeX,g.sizeY,g.sizeZ]),V=g.minBounds,W=g.scale,z=g.getNormals();let K=new Float32Array(3*U.length),q=new Float32Array(3*U.length),$=new Float32Array(3*U.length),Q=0,Y=0,Z=0;for(let g=0,I=U.length;g<I;g++){var X=U[g],J=P?X.value:X.value/256|0;K[Q++]=V.x+X.position[0]*W.x,K[Q++]=V.y+X.position[1]*W.y,K[Q++]=V.z+X.position[2]*W.z,$[Z++]=J/255,$[Z++]=0,$[Z++]=0,P||(X=X.value%256,X=z[Math.min(X,z.length-1)],q[Y++]=X.x,q[Y++]=X.y,q[Y++]=X.z)}let ee=new Uint32Array(3*G.length),te=0;for(let g=0,P=G.length;g<P;g++){var re=G[g];ee[te++]=re[0],ee[te++]=re[1],ee[te++]=re[2]}let se=new THREE.BufferGeometry;return se.addAttribute("position",new THREE.BufferAttribute(K,3)),P||se.addAttribute("normal",new THREE.BufferAttribute(q,3)),se.addAttribute("color",new THREE.BufferAttribute($,3)),se.setIndex(new THREE.BufferAttribute(ee,1)),se=I.BufferGeometryUtils.mergeVertices(se),se.computeBoundingBox(),P&&se.computeVertexNormals(),se}}),L=class{constructor(g,P,I,L){this.color=g,this.left=[[I,P]],this.right=[[L,P]]}close_off(g){this.left.push([this.left[this.left.length-1][0],g]),this.right.push([this.right[this.right.length-1][0],g])}merge_run(g,P,I){var L=this.left[this.left.length-1][0],_=this.right[this.right.length-1][0];L!==P&&(this.left.push([L,g]),this.left.push([P,g])),_!==I&&(this.right.push([_,g]),this.right.push([I,g]))}}}}}),System.register("engine/renderable/builder/vxlGeometry/VxlGeometryNaiveBuilder",["engine/gfx/BufferGeometryUtils"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("VxlGeometryNaiveBuilder",class{build(g){var{voxels:P,voxelField:L}=g.getAllVoxels();let _=new THREE.BoxBufferGeometry(1,1,1);var U=_.getAttribute("position").array.length/3,G=_.getAttribute("normal").array;let V=new THREE.BufferGeometry;return V.setIndex(this.createIndexAttr(P,_,U)),V.addAttribute("position",this.createPositionAttr(g,P,_)),V.addAttribute("normal",this.createNormalAttr(g,P,U)),V.addAttribute("color",this.createColorAttr(P,U,G,L)),V=I.BufferGeometryUtils.mergeVertices(V),V.computeBoundingBox(),V}createPositionAttr(g,P,I){var L=I.getAttribute("position").array,_=L.length;let U=new Float32Array(L.length*P.length);var G=g.minBounds,V=g.scale;for(let g=0,I=P.length;g<I;g++){var W=g*_,z=P[g];for(let g=0,P=L.length;g<P;g+=3)U[W+g]=G.x+z.x*V.x+L[g],U[W+g+1]=G.y+z.y*V.y+L[g+1],U[W+g+2]=G.z+z.z*V.z+L[g+2]}return new THREE.BufferAttribute(U,3)}createNormalAttr(g,P,I){let L=new Float32Array(I*P.length*3);var _=g.getNormals();for(let g=0,V=P.length;g<V;g++){var U=g*I*3,G=_[Math.min(P[g].normalIndex,_.length-1)];for(let g=0,P=3*I;g<P;g+=3)L[U+g]=G.x,L[U+g+1]=G.y,L[U+g+2]=G.z}return new THREE.BufferAttribute(L,3)}createColorAttr(g,P,I,L){let _=new Float32Array(P*g.length*3);for(let W=0,z=g.length;W<z;W++){var U=W*P*3,G=g[W];for(let g=0,W=3*P;g<W;g+=3){var V=L.get(G.x+I[g],G.y+I[g+1],G.z+I[g+2]);_[U+g]=V?0:G.colorIndex/255,_[U+g+1]=0,_[U+g+2]=0}}return new THREE.BufferAttribute(_,3)}createIndexAttr(g,P,I){var L=P.getIndex().array;let _=new Uint32Array(g.length*L.length);for(let P=0,U=g.length;P<U;P++)for(let g=0,U=L.length;g<U;g++)_[P*U+g]=P*I+L[g];return new THREE.BufferAttribute(_,1)}})}}}),System.register("engine/renderable/builder/vxlGeometry/VxlGeometryPool",["engine/renderable/entity/unit/ModelQuality","util/typeGuard","engine/renderable/builder/vxlGeometry/VxlGeometryMonotoneBuilder"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("VxlGeometryPool",class{constructor(g,P=I.ModelQuality.High){this.cache=g,this.modelQuality=P}setModelQuality(g){this.modelQuality=g}getModelQuality(){return this.modelQuality}async loadFromStorage(g,P){return(await Promise.all(g.sections.map(g=>this.cache.loadFromStorage(g,P)))).every(L.isNotNullOrUndefined)}async persistToStorage(g,P,I){for(let _=0;_<g.sections.length;_++){var L=g.sections[_];await this.cache.persistToStorage(L,P,I[_])}}clear(){this.cache.clear()}async clearStorage(){await this.cache.clearStorage()}async clearOtherModStorage(){await this.cache.clearOtherModStorage()}get(g){let P=this.cache.get(g);return P||(P=(new _.VxlGeometryMonotoneBuilder).build(g),this.cache.set(g,P)),P}})}}}),System.register("engine/renderable/builder/VxlNonBatchedBuilder",["engine/gfx/TextureUtils","engine/renderable/builder/VxlBuilder","engine/gfx/material/PalettePhongMaterial"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class extends L.VxlBuilder{constructor(g,P,I,L,_){super(_),this.vxlFile=g,this.hvaFile=P,this.palette=I,this.vxlGeometryPool=L,this.clippingPlanes=[],this.castShadow=!0}createVxlMeshes(){var g=this.palette;g=I.TextureUtils.textureFromPalette(g);let P=this.material=new _.PalettePhongMaterial({palette:g,vertexColors:THREE.VertexColors});this.extraLight&&(P.extraLight=this.extraLight),P.clippingPlanes=this.clippingPlanes;let L=this.vxlFile.sections,U=new Map;return L.forEach((g,I)=>{var L=this.vxlGeometryPool.get(g);let _=new THREE.Mesh(L,P),G=g.transfMatrix,V=this.hvaFile?.sections[I];V&&(G=g.scaleHvaMatrix(V.getMatrix(0))),_.applyMatrix(G),U.set(g.name,_),_.castShadow=this.castShadow}),U}setPalette(g){var P;this.palette=g,this.object&&(P=I.TextureUtils.textureFromPalette(g),this.material.palette=P)}setExtraLight(g){this.extraLight=g,this.object&&(this.material.extraLight=g)}setShadow(g){this.castShadow=g,this.sections?.forEach(P=>P.castShadow=g)}setClippingPlanes(g){this.clippingPlanes=g,this.object&&(this.material.clippingPlanes=g)}setOpacity(g){this.material.transparent=g<1,this.material.opacity=g}dispose(){this.object&&this.material.dispose()}},g("VxlNonBatchedBuilder",U)}}}),System.register("engine/renderable/CameraPan",["util/math"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("CameraPan",class{constructor(g){this.freeCamera=g,this.pan={x:0,y:0}}setPanLimits(g){this.panLimits=g,this.setPan({x:this.pan.x,y:this.pan.y})}getPanLimits(){return{...this.panLimits}}getPan(){return{...this.pan}}setPan(g){this.panLimits&&!this.freeCamera.value&&(g.x=I.clamp(g.x,this.panLimits.x,this.panLimits.x+this.panLimits.width),g.y=I.clamp(g.y,this.panLimits.y,this.panLimits.y+this.panLimits.height)),this.pan={x:g.x,y:g.y}}})}}}),System.register("engine/renderable/CameraZoom",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("CameraZoom",class{constructor(g){this.freeCamera=g,this.zoom=1}getZoom(){return this.zoom}applyStep(g){this.freeCamera.value&&(this.zoom=Math.max(.1,this.zoom+g))}})}}}),System.register("engine/renderable/DebugRenderable",["data/Palette","engine/gfx/DebugUtils","engine/gfx/TextureUtils","engine/gfx/material/PaletteBasicMaterial","three","engine/gfx/batch/BatchedMesh"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){g("DebugRenderable",W=class u{static getOrCreateTexture(){let g=u.checkerboardTex;return g||(g=L.DebugUtils.createIndexedCheckerTex(I.Palette.REMAP_START_IDX-1,I.Palette.REMAP_START_IDX),u.checkerboardTex=g),g}static clearCaches(){u.checkerboardTex?.dispose(),u.geometryCache.forEach(g=>g.dispose()),u.geometryCache.clear()}constructor(g,P,I,L){this.foundation=g,this.height=P,this.palette=I,this.options=L,this.batchPalettes=[],this.useMeshBatching=!1,this.opacity=1}useMaterial(g){this.materialCacheKey=g.uuid;let P,I=u.materialCache.get(this.materialCacheKey);return I?(P=I.material,I.usages++):(P=new U.PaletteBasicMaterial({map:u.getOrCreateTexture(),palette:g,alphaTest:.05,paletteCount:this.batchPalettes.length,flatShading:!0,transparent:!0}),I={material:P,usages:1},u.materialCache.set(this.materialCacheKey,I)),P}freeMaterial(){if(!this.materialCacheKey)throw new Error("Material cache key not set");let g=u.materialCache.get(this.materialCacheKey);g&&(1===g.usages?(u.materialCache.delete(this.materialCacheKey),g.material.dispose()):g.usages--)}getGeometryCacheKey(){return this.foundation.width+"_"+this.foundation.height+"_"+this.height}setBatched(g){if(this.mesh)throw new Error("Batching can only be set before calling build()");this.useMeshBatching=g}getBatchPaletteIndex(g){var P=this.batchPalettes.findIndex(P=>P.hash===g.hash);if(-1===P)throw new Error("Provided palette not found in the list of batch palettes. Call setBatchPalettes first.");return P}setPalette(g){if(this.palette=g,this.mesh)if(this.useMeshBatching){var P=this.getBatchPaletteIndex(g);this.mesh.setPaletteIndex(P)}else{P=_.TextureUtils.textureFromPalette(g),this.mesh.material.palette=P}}setBatchPalettes(g){if(!this.useMeshBatching)throw new Error("Can't use multiple palettes when not batching");if(this.mesh)throw new Error("Palettes must be set before creating 3DObject");this.batchPalettes=g}setOpacity(g){this.opacity!==g&&(this.opacity=g,this.updateOpacity())}updateOpacity(){this.mesh&&(this.useMeshBatching?this.mesh.setOpacity(this.opacity):this.mesh.material.opacity=this.opacity)}create3DObject(){if(!this.mesh){var g,P,I=this.getGeometryCacheKey();let W,z=u.geometryCache,K=z.get(I);K||(K=L.DebugUtils.createBoxGeometry(this.foundation,this.height,this.options?.centerFoundation),z.set(I,K)),this.useMeshBatching?(g=_.TextureUtils.textureFromPalettes(this.batchPalettes),P=this.useMaterial(g),W=new V.BatchedMesh(K,P,V.BatchMode.Merging),W.castShadow=!1):(g=_.TextureUtils.textureFromPalette(this.palette),P=u.getOrCreateTexture(),P=new U.PaletteBasicMaterial({palette:g,map:P,alphaTest:.05,transparent:!0}),W=new G.Mesh(K,P)),W.matrixAutoUpdate=!1,this.mesh=W,this.setPalette(this.palette),this.updateOpacity()}}get3DObject(){return this.mesh}update(g){}dispose(){this.mesh&&(this.useMeshBatching?this.freeMaterial():this.mesh.material.dispose(),this.mesh=void 0)}}),W.geometryCache=new Map,W.materialCache=new Map}}}),System.register("engine/renderable/Entity",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("engine/renderable/entity/Aircraft",["game/Coords","engine/renderable/WithPosition","engine/gfx/DebugUtils","util/math","game/gameobject/unit/VeteranLevel","engine/renderable/entity/HighlightAnimRunner","engine/Animation","game/gameobject/common/DeathType","game/gameobject/unit/ZoneType","engine/renderable/entity/InvulnerableAnimRunner","engine/renderable/entity/BoxIntersectObject3D","engine/renderable/entity/unit/RotorHelper","engine/renderable/entity/unit/ExtraLightHelper","engine/renderable/DebugRenderable"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g}],execute:function(){g("Aircraft",class{constructor(g,P,I,L,_,U,G,W,z,K,$,Q,Y){this.gameObject=g,this.rules=P,this.voxels=I,this.voxelAnims=L,this.palette=_,this.lighting=G,this.debugFrame=W,this.gameSpeed=z,this.selectionModel=K,this.vxlBuilderFactory=$,this.useSpriteBatching=Q,this.pipOverlay=Y,this.rotorSpeeds=[],this.vxlBuilders=[],this.highlightAnimRunner=new V.HighlightAnimRunner(this.gameSpeed),this.invulnAnimRunner=new q.InvulnerableAnimRunner(this.gameSpeed),this.plugins=[],this.objectRules=g.rules,this.objectArt=g.art,this.label="aircraft_"+this.objectRules.name,this.init()}init(){this.paletteRemaps=[...this.rules.colors.values()].map(g=>this.palette.clone().remap(g)),this.palette.remap(this.gameObject.owner.color),this.lastOwnerColor=this.gameObject.owner.color,this.withPosition=new L.WithPosition,this.updateBaseLight(),this.extraLight=(new THREE.Vector3).copy(this.baseExtraLight)}updateBaseLight(){this.baseExtraLight=(new THREE.Vector3).setScalar(this.lighting.computeNoAmbient(this.objectArt.lightingType,this.gameObject.tile)+this.rules.audioVisual.extraAircraftLight)}updateLighting(){this.plugins.forEach(g=>g.updateLighting?.()),this.updateBaseLight(),this.extraLight.copy(this.baseExtraLight)}get3DObject(){return this.target}getIntersectTarget(){return this.target}getUiName(){var g=this.plugins.reduce((g,P)=>P.getUiNameOverride?.()??g,void 0);return void 0!==g?g:this.gameObject.getUiName()}create3DObject(){let g=this.get3DObject();g||(g=new $.BoxIntersectObject3D(new THREE.Vector3(1,1/3,1).multiplyScalar(I.Coords.LEPTONS_PER_TILE*(this.gameObject.rules.spawned?.5:1))),g.name=this.label,g.userData.id=this.gameObject.id,this.target=g,g.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(g),this.vxlBuilders.forEach(g=>g.setExtraLight(this.extraLight)),this.pipOverlay&&(this.pipOverlay.create3DObject(),this.posObj?.add(this.pipOverlay.get3DObject())))}setPosition(g){this.withPosition.setPosition(g.x,g.y,g.z)}getPosition(){return this.withPosition.getPosition()}registerPlugin(g){this.plugins.push(g)}highlight(){this.plugins.some(g=>g.shouldDisableHighlight?.())||this.highlightAnimRunner.animation.getState()!==W.AnimationState.RUNNING&&this.highlightAnimRunner.animate(2)}update(g){this.plugins.forEach(P=>P.update(g)),this.pipOverlay?.update(g),this.gameObject.veteranLevel!==this.lastVeteranLevel&&(this.gameObject.veteranLevel===G.VeteranLevel.Elite&&void 0!==this.lastVeteranLevel&&this.highlightAnimRunner.animate(30),this.lastVeteranLevel=this.gameObject.veteranLevel);var P=this.highlightAnimRunner.shouldUpdate(),I=this.gameObject.invulnerableTrait.isActive(),L=I!==this.lastInvulnerable;(this.lastInvulnerable=I)&&L&&this.invulnAnimRunner.animate(),this.invulnAnimRunner.shouldUpdate()&&this.invulnAnimRunner.tick(g),(P||L)&&(P&&this.highlightAnimRunner.tick(g),_=I?this.invulnAnimRunner.getValue():0,V=(P?this.highlightAnimRunner.getValue():0)||_,U=this.lighting.getAmbientIntensity(),Y.ExtraLightHelper.multiplyVxl(this.extraLight,this.baseExtraLight,U,V));var _=(P=this.gameObject.warpedOutTrait.isActive())!==this.lastWarpedOut;this.lastWarpedOut=P;var U=this.gameObject.cloakableTrait?.isCloaked(),V=U!==this.lastCloaked;if(this.lastCloaked=U,_||V){let g=P||U?.5:1;this.vxlBuilders.forEach(P=>P.setOpacity(g)),this.placeholder?.setOpacity(g)}U=this.gameObject.owner.color,this.lastOwnerColor!==U&&(this.palette.remap(U),this.lastOwnerColor=U,this.vxlBuilders.forEach(g=>g.setPalette(this.palette)),this.placeholder?.setPalette(this.palette)),(U=this.gameObject.zone)!==this.lastZone&&(this.gameObject.rules.missileSpawn&&U===K.ZoneType.Air&&this.lastZone!==K.ZoneType.Air&&this.renderableManager.createTransientAnim("V3TAKOFF",g=>g.setPosition(this.withPosition.getPosition())),this.lastZone=U),this.updateVxlRotation()}updateVxlRotation(){var{pitch:g,yaw:P,roll:I}=this.gameObject;this.tiltObj.rotation.z=THREE.Math.degToRad(I),this.tiltObj.rotation.x=THREE.Math.degToRad(g),this.tiltObj.rotation.y=THREE.Math.degToRad(P),this.rotors&&this.rotors.forEach((g,P)=>{this.rotorSpeeds[P]=Q.RotorHelper.computeRotationStep(this.gameObject,this.rotorSpeeds[P]??0,this.objectArt.rotors[P]),this.rotorSpeeds[P]&&(g.rotateOnAxis(this.objectArt.rotors[P].axis,this.rotorSpeeds[P]),g.updateMatrix())})}createObjects(g){if(this.debugFrame.value){let P=_.DebugUtils.createWireframe({width:1,height:1},1);P.translateX(-I.Coords.getWorldTileSize()/2),P.translateZ(-I.Coords.getWorldTileSize()/2),g.add(P)}let P=this.tiltObj=new THREE.Object3D;P.rotation.order="YXZ";var L=this.createMainObject();P.add(L);let U=this.posObj=new THREE.Object3D;U.matrixAutoUpdate=!1,U.add(P),g.add(U)}createMainObject(){var g=this.objectArt.imageName.toLowerCase(),P=g+".vxl",I=this.voxels.get(P);if(!I)return console.warn(`VXL missing for aircraft ${this.objectRules.name}. Vxl file ${P} not found. `),this.placeholder=new Z.DebugRenderable({width:.5,height:.5},this.objectArt.height,this.palette,{centerFoundation:!0}),this.placeholder.setBatched(this.useSpriteBatching),this.useSpriteBatching&&this.placeholder.setBatchPalettes(this.paletteRemaps),this.placeholder.create3DObject(),this.placeholder.get3DObject();P=this.objectArt.noHva?void 0:this.voxelAnims.get(g+".hva"),g=[...this.rules.colors.values()].map(g=>this.palette.clone().remap(g));let L=this.vxlBuilderFactory.create(I,P,g,this.palette);return this.vxlBuilders.push(L),g=L.build(),this.objectArt.rotors&&(this.rotors=this.objectArt.rotors.map(g=>{var P=L.getSection(g.name);if(!P)throw new Error(`Aircraft "${this.objectRules.name}" VXL section "${g.name}" not found`);return P})),g}onCreate(g){this.renderableManager=g,this.plugins.forEach(P=>P.onCreate(g))}onRemove(g){var P;this.renderableManager=void 0,this.plugins.forEach(P=>P.onRemove(g)),this.gameObject.isDestroyed&&this.objectRules.explosion.length&&this.gameObject.deathType!==z.DeathType.Temporal&&this.gameObject.deathType!==z.DeathType.None&&(P=(P=this.objectRules.explosion)[U.getRandomInt(0,P.length-1)],g.createTransientAnim(P,g=>{let P=this.withPosition.getPosition();this.gameObject.rules.missileSpawn&&(P=P.clone().add(this.gameObject.moveTrait.velocity.clone().setLength(this.rules.general.getMissileRules(this.gameObject.name).bodyLength))),g.setPosition(P)}))}dispose(){this.plugins.forEach(g=>g.dispose()),this.pipOverlay?.dispose(),this.vxlBuilders.forEach(g=>g.dispose()),this.placeholder?.dispose()}})}}}),System.register("engine/renderable/entity/Anim",["engine/renderable/WithPosition","engine/AnimProps","engine/Animation","engine/renderable/ShpRenderable","engine/ImageFinder","engine/gfx/DebugUtils","engine/renderable/MapSpriteTranslation","engine/animation/SimpleRunner","engine/gfx/MathUtils","game/Coords"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g}],execute:function(){g("Anim",class{constructor(g,P,L,_,U,G,V,W,z,K=new THREE.Vector3(0,0,0),q,$){this.objectArt=P,this.extraOffset=L,this.imageFinder=_,this.theater=U,this.camera=G,this.debugFrame=V,this.gameSpeed=W,this.useSpriteBatching=z,this.extraLight=K,this.worldSound=q,this.renderOrder=0,this.name=g,this.palette=$??this.theater.getPalette(this.objectArt.paletteType,this.objectArt.customPaletteName),this.withPosition=new I.WithPosition}get3DObject(){return this.target}create3DObject(){let g=this.get3DObject();g||(g=new THREE.Object3D,g.name="anim_"+this.name,this.target=g,g.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(g))}setPosition(g){this.withPosition.setPosition(g.x,g.y,g.z)}getPosition(){return this.withPosition.getPosition()}update(g){if(this.animationRunner){(I=this.objectArt.startSound??this.objectArt.report)&&!this.soundHandle&&this.animation?.getState()===_.AnimationState.NOT_STARTED&&(this.soundHandle=this.worldSound?.playEffect(I,this.withPosition.getPosition(),void 0,1,.25)),this.animationRunner.tick(g),this.mainObj.get3DObject().visible=this.animation.getState()!==_.AnimationState.DELAYED,this.mainObj.setFrame(this.animationRunner.getCurrentFrame());var P=this.objectArt.translucent,I=this.objectArt.translucency;if(P||0<I){let g;g=P?(P=this.animation.props,1-this.animationRunner.getCurrentFrame()/(P.end-P.start)):1-I,this.mainObj.setOpacity(g)}}}createObjects(g){var P={width:1,height:1};this.debugFrame.value&&(U=V.DebugUtils.createWireframe(P,0),g.add(U));let I=new W.MapSpriteTranslation(P.width,P.height);var{spriteOffset:L,anchorPointWorld:_}=I.compute(),U=this.computeSpriteAnchorOffset(L);let G=new THREE.Object3D;if(G.matrixAutoUpdate=!1,this.mainObj=this.createMainObject(U),this.mainObj){if(this.mainObj.setExtraLight(this.extraLight),P=this.useSpriteBatching&&!this.renderOrder,this.mainObj.setBatched(P),P&&this.mainObj.setBatchPalettes([this.palette]),L=this.objectArt.translucent,U=this.objectArt.translucency,(L||0<U)&&this.mainObj.setForceTransparent(!0),this.mainObj.create3DObject(),this.renderOrder){if(P)throw new Error("Render order not supported with batching");this.mainObj.getShapeMesh().renderOrder=this.renderOrder,this.mainObj.getShapeMesh().material.depthTest=!this.renderOrder,this.mainObj.getShapeMesh().material.transparent=!!this.renderOrder}G.add(this.mainObj.get3DObject()),G.position.x=_.x,G.position.z=_.y,this.objectArt.zAdjust&&K.MathUtils.translateTowardsCamera(G,this.camera,-this.objectArt.zAdjust*q.Coords.ISO_WORLD_SCALE),G.updateMatrix(),g.add(G)}}setExtraLight(g){this.extraLight=g,this.mainObj?.setExtraLight(this.extraLight)}setRenderOrder(g){if(this.mainObj)throw new Error("Render order must be set before 3DObject is created");this.renderOrder=g}computeSpriteAnchorOffset(g){var P=this.objectArt.getDrawOffset();return{x:g.x+P.x+this.extraOffset.x,y:g.y+P.y+this.extraOffset.y}}createMainObject(g){let P;try{P=this.shpFile=this.imageFinder.findByObjectArt(this.objectArt)}catch(g){if(g instanceof G.ImageFinder.MissingImageError)return void console.warn(g.message);throw g}let I=U.ShpRenderable.factory(P,this.palette,this.camera,g);I.setFlat(this.objectArt.flat);var V=new L.AnimProps(this.objectArt.art,P);return this.animation=new _.Animation(V,this.gameSpeed),this.animationRunner=new z.SimpleRunner,this.animationRunner.animation=this.animation,I}getAnimProps(){return this.animation?.props}getShpFile(){return this.shpFile}remapColor(g){if(this.mainObj)throw new Error("Palette can only be remapped before creating 3DObject");let P=this.palette.clone();P.remap(g),this.palette=P}isAnimFinished(){return this.animation?.getState()===_.AnimationState.STOPPED}isAnimNotStarted(){return this.animation?.getState()===_.AnimationState.NOT_STARTED}endAnimationLoop(){this.animation?.endLoopAndPlayToEnd()}reset(){this.animation?.reset()}dispose(){this.mainObj?.dispose(),this.soundHandle?.isLoop&&this.soundHandle.stop()}})}}}),System.register("engine/renderable/entity/BoxIntersectObject3D",[],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[],execute:function(){I=new THREE.Ray,L=new THREE.Matrix4,_=new THREE.Box3,U=new THREE.Vector3,G=class extends THREE.Object3D{constructor(g){super(),this.boxSize=g}raycast(g,P){if(this.parent){L.getInverse(this.parent.matrixWorld),I.copy(g.ray).applyMatrix4(L),U.copy(this.position);let G=_.setFromCenterAndSize(U,this.boxSize);if(I.intersectsBox(G)){const I=new THREE.Vector3;G.getCenter(I),I.applyMatrix4(this.parent.matrixWorld),P.push({distance:g.ray.origin.distanceTo(I),point:I,object:this})}}}},g("BoxIntersectObject3D",G)}}}),System.register("engine/renderable/entity/Building",["engine/renderable/builder/ShpBuilder","engine/renderable/entity/building/DamageType","engine/renderable/entity/building/AnimationType","engine/gfx/OverlayUtils","game/gameobject/Building","engine/Animation","game/map/wallTypes","game/Coords","util/math","engine/AnimProps","engine/renderable/WithPosition","engine/renderable/ShpRenderable","engine/ImageFinder","engine/gfx/DebugUtils","engine/renderable/MapSpriteTranslation","engine/renderable/entity/building/BuildingAnimArtProps","util/typeGuard","engine/renderable/entity/HighlightAnimRunner","game/rules/TechnoRules","game/gameobject/trait/AttackTrait","game/SideType","game/gameobject/trait/FactoryTrait","game/gameobject/trait/UnitRepairTrait","game/gameobject/common/DeathType","engine/renderable/entity/InvulnerableAnimRunner","engine/renderable/entity/building/BuildingShpHelper","engine/renderable/entity/unit/ExtraLightHelper","engine/renderable/AlphaRenderable","engine/renderable/DebugRenderable","engine/gfx/MathUtils"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce,he,ue,de,ge,pe,me,fe,ye;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g},function(g){ce=g},function(g){he=g},function(g){ue=g},function(g){de=g},function(g){ge=g},function(g){pe=g}],execute:function(){me=(new Map).set(_.AnimationType.PRODUCTION,_.AnimationType.IDLE).set(_.AnimationType.BUILDUP,_.AnimationType.IDLE).set(_.AnimationType.SPECIAL_DOCKING,_.AnimationType.IDLE).set(_.AnimationType.SPECIAL_REPAIR_START,_.AnimationType.SPECIAL_REPAIR_LOOP).set(_.AnimationType.SPECIAL_REPAIR_LOOP,_.AnimationType.SPECIAL_REPAIR_END).set(_.AnimationType.SPECIAL_REPAIR_END,_.AnimationType.IDLE).set(_.AnimationType.SUPER_CHARGE_START,_.AnimationType.SUPER_CHARGE_LOOP).set(_.AnimationType.SUPER_CHARGE_LOOP,_.AnimationType.SUPER_CHARGE_END).set(_.AnimationType.SUPER_CHARGE_END,_.AnimationType.IDLE).set(_.AnimationType.FACTORY_DEPLOYING,_.AnimationType.IDLE).set(_.AnimationType.FACTORY_ROOF_DEPLOYING,_.AnimationType.IDLE),fe=(new Map).set(_.AnimationType.SUPER_CHARGE_START,[_.AnimationType.SUPER,1]).set(_.AnimationType.SUPER_CHARGE_LOOP,[_.AnimationType.SUPER,2]).set(_.AnimationType.SUPER_CHARGE_END,[_.AnimationType.SUPER,3]).set(_.AnimationType.SPECIAL_REPAIR_START,[_.AnimationType.SPECIAL,0]).set(_.AnimationType.SPECIAL_REPAIR_LOOP,[_.AnimationType.SPECIAL,1]).set(_.AnimationType.SPECIAL_REPAIR_END,[_.AnimationType.SPECIAL,2]).set(_.AnimationType.SPECIAL_DOCKING,[_.AnimationType.SPECIAL,0]).set(_.AnimationType.SPECIAL_SHOOT,[_.AnimationType.SPECIAL,0]).set(_.AnimationType.FACTORY_DEPLOYING,[_.AnimationType.FACTORY_DEPLOYING,0]).set(_.AnimationType.FACTORY_UNDER_DOOR,[_.AnimationType.FACTORY_DEPLOYING,1]).set(_.AnimationType.FACTORY_ROOF_DEPLOYING,[_.AnimationType.FACTORY_ROOF_DEPLOYING,0]).set(_.AnimationType.FACTORY_UNDER_ROOF_DOOR,[_.AnimationType.FACTORY_ROOF_DEPLOYING,1]),g("Building",ye=class c{constructor(g,P,I,L,U,G,V,W,z,K,q,Q,Z,X,ee,re,se,ae,ne,oe,le,ue=_.AnimationType.IDLE){this.gameObject=g,this.selectionModel=P,this.rules=I,this.art=L,this.imageFinder=U,this.voxels=V,this.voxelAnims=W,this.palette=z,this.animPalette=K,this.isoPalette=q,this.camera=Q,this.lighting=Z,this.debugFrame=X,this.gameSpeed=ee,this.vxlBuilderFactory=re,this.useSpriteBatching=se,this.buildingImageDataCache=ne,this.pipOverlay=oe,this.worldSound=le,this.initialAnimType=ue,this.animObjects=new Map,this.animations=new Map,this.animSounds=new Map,this.powered=!0,this.repairStopRequested=!1,this.repairStartRequested=!1,this.highlightAnimRunner=new te.HighlightAnimRunner(this.gameSpeed),this.invulnAnimRunner=new ce.InvulnerableAnimRunner(this.gameSpeed),this.plugins=[],this.objectArt=g.art,this.objectRules=g.rules,this.type=this.objectRules.name,this.paletteRemaps=[...this.rules.colors.values()].map(g=>this.palette.clone().remap(g)),this.palette.remap(this.gameObject.owner.color),this.lastOwnerColor=this.gameObject.owner.color,this.updateBaseLight(),this.vxlExtraLight=(new THREE.Vector3).copy(this.baseVxlExtraLight),this.shpExtraLight=(new THREE.Vector3).copy(this.baseShpExtraLight);var de=this.animArtProps=new J.BuildingAnimArtProps;let ge,pe;this.animArtProps.read(this.objectArt.art,this.art);try{ge=this.imageFinder.findByObjectArt(this.objectArt)}catch(g){if(!(g instanceof Y.ImageFinder.MissingImageError))throw g;console.warn(g.message)}this.mainShpFile=ge;try{pe=this.objectArt.bibShape?this.imageFinder.find(this.objectArt.bibShape,this.objectArt.useTheaterExtension):void 0}catch(g){if(!(g instanceof Y.ImageFinder.MissingImageError))throw g;console.warn(g.message)}this.bibShpFile=pe;let me=new he.BuildingShpHelper(this.imageFinder);de=this.animShpFiles=me.collectAnimShpFiles(de,this.objectArt);let fe=this.shpFrameInfos=me.getShpFrameInfos(this.objectArt,ge,pe,de),ye=this.buildingImageDataCache.get(this.gameObject.name);ye||(ye=ae.aggregate(fe.values(),`agg_${this.objectRules.name}.shp`),this.buildingImageDataCache.set(this.gameObject.name,ye)),this.aggregatedImageData=ye,this.withPosition=new $.WithPosition}updateBaseLight(){this.baseShpExtraLight=this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile).addScalar(-1),this.baseVxlExtraLight=(new THREE.Vector3).setScalar(this.lighting.computeNoAmbient(this.objectArt.lightingType,this.gameObject.tile))}updateLighting(){this.updateBaseLight(),this.vxlExtraLight.copy(this.baseVxlExtraLight),this.shpExtraLight.copy(this.baseShpExtraLight),this.plugins.forEach(g=>g.updateLighting?.())}get3DObject(){return this.target}getIntersectTarget(){return this.intersectTarget}updateIntersectTarget(){this.intersectTarget=[this.placeholderObj?.get3DObject(),this.mainObj?.getShapeMesh(),this.bib?.getShapeMesh(),...[...this.animObjects.values()].flat().map(g=>g.getShapeMesh())].filter(ee.isNotNullOrUndefined)}getUiName(){var g=this.plugins.reduce((g,P)=>P.getUiNameOverride?.()??g,void 0);return void 0!==g?g:this.gameObject.getUiName()}create3DObject(){let g=this.get3DObject();if(!g){g=new THREE.Object3D,g.name="building_"+this.type,g.userData.id=this.gameObject.id,this.target=g,g.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this);var P=this.gameObject.rules.alphaImage;if(P){var L=this.imageFinder.tryFind(P,!1);if(L){let P=new de.AlphaRenderable(L,this.camera,new THREE.Vector2(0,(z.Coords.ISO_TILE_SIZE+1)/2));P.create3DObject(),g.add(P.get3DObject())}else console.warn(`<${this.objectRules.name}>: Alpha image "${P}" not found`)}this.objectRules.lightIntensity&&(this.createLamp(g),this.objectRules.isLightpost)||(this.createObjects(g),this.updateIntersectTarget(),this.pipOverlay&&(this.pipOverlay.create3DObject(),g.add(this.pipOverlay.get3DObject())),this.updateImage(this.computeDamageType(this.gameObject.healthTrait.health)),this.mainObj?.setExtraLight(this.shpExtraLight),[...this.animObjects.values()].forEach(g=>{g.forEach(g=>{this.animations.get(g).props.getArt().has("UseNormalLight")||g.setExtraLight(this.shpExtraLight)})}),this.bib?.setExtraLight(this.shpExtraLight),this.turretBuilders?.forEach(g=>{g instanceof I.ShpBuilder?g.setExtraLight(this.shpExtraLight):g.setExtraLight(this.vxlExtraLight)}))}}createLamp(g){var P=this.objectRules;let I=(1+P.lightRedTint)*(1+Math.abs(P.lightIntensity))-1,L=(1+P.lightGreenTint)*(1+Math.abs(P.lightIntensity))-1,_=(1+P.lightBlueTint)*(1+Math.abs(P.lightIntensity))-1;var U=Math.max(I,L,_);1<U&&(I/=U,L/=U,_/=U),U=new THREE.Color(I,L,_).multiplyScalar(.9).getHexString();let G=c.lampTextures.get(U);G||(G=this.createLampTexture(U),c.lampTextures.set(U,G)),U=new THREE.MeshBasicMaterial({map:G,depthTest:!1,depthWrite:!1,transparent:!0,blending:THREE.CustomBlending,blendEquation:0<P.lightIntensity?THREE.AddEquation:THREE.ReverseSubtractEquation,blendSrc:THREE.DstColorFactor,blendDst:THREE.OneFactor}),P=P.lightVisibility,P=new THREE.PlaneBufferGeometry(2*P,2*P);let V=new THREE.Mesh(P,U);V.rotation.x=-Math.PI/2,V.renderOrder=999995,V.matrixAutoUpdate=!1,V.updateMatrix(),g.add(V)}createLampTexture(g){let P=document.createElement("canvas");P.width=P.height=32;let I=P.getContext("2d");I.fillStyle="black",I.fillRect(0,0,32,32);let L=I.createRadialGradient(16,16,0,16,16,16);L.addColorStop(0,"#"+g),L.addColorStop(1,"black"),I.arc(16,16,16,0,2*Math.PI),I.fillStyle=L,I.fill();let _=new THREE.Texture(P);return _.needsUpdate=!0,_}setPosition(g){var P=this.gameObject.getFoundationCenterOffset();this.withPosition.setPosition(g.x-P.x,g.y,g.z-P.y)}getPosition(){return this.withPosition.getPosition()}registerPlugin(g){this.plugins.push(g)}highlight(){this.plugins.some(g=>g.shouldDisableHighlight?.())||this.highlightAnimRunner.animate(2)}update(g){if(!this.objectRules.isLightpost){this.gameObject.isDestroyed||void 0!==this.currentAnimType||this.setAnimation(this.initialAnimType,g),this.plugins.forEach(P=>P.update(g)),this.pipOverlay?.update(g);var P=this.gameObject.c4ChargeTrait?.hasCharge();!this.gameObject.isDestroyed&&this.lastHasC4Charge!==P&&P&&(this.lastHasC4Charge=P,this.highlight());var I=this.highlightAnimRunner.shouldUpdate(),U=this.gameObject.invulnerableTrait.isActive();P=U!==this.lastInvulnerable;(this.lastInvulnerable=U)&&P&&this.invulnAnimRunner.animate(),this.invulnAnimRunner.shouldUpdate()&&this.invulnAnimRunner.tick(g),(I||P||U)&&(I&&this.highlightAnimRunner.tick(g),U=U?this.invulnAnimRunner.getValue():0,z=(I?this.highlightAnimRunner.getValue():0)||U,U=this.lighting.getAmbientIntensity(),ue.ExtraLightHelper.multiplyVxl(this.vxlExtraLight,this.baseVxlExtraLight,U,z),ue.ExtraLightHelper.multiplyShp(this.shpExtraLight,this.baseShpExtraLight,z));var W,z=this.gameObject.warpedOutTrait.isActive();if(z!==this.lastWarpedOut){let g=(this.lastWarpedOut=z)?.5:1;for(W of[this.mainObj,this.bib,...[...this.animObjects.values()].flat()])W?.setOpacity(g);this.turretBuilders?.forEach(P=>P.setOpacity(g)),this.placeholderObj?.setOpacity(g)}this.gameObject.isDestroyed||(K=this.gameObject.owner.color,this.lastOwnerColor!==K&&(this.palette.remap(K),this.mainObj?.setPalette(this.palette),[...this.animObjects.values()].forEach(g=>{g.forEach(g=>g.setPalette(this.palette))}),this.bib?.setPalette(this.palette),this.turretBuilders?.forEach(g=>g.setPalette(this.palette)),this.placeholderObj?.setPalette(this.palette),this.lastOwnerColor=K)),!this.gameObject.isDestroyed&&me.has(this.currentAnimType)&&(q=me.get(this.currentAnimType),this.hasObjectWithStoppedAnimation(this.currentAnimType)&&this.setAnimation(q,g)),this.gameObject.isDestroyed||this.gameObject.buildStatus!==G.BuildStatus.BuildDown||this.currentAnimType===_.AnimationType.UNBUILD||this.setAnimation(_.AnimationType.UNBUILD,g);var K=this.gameObject.attackTrait?.attackState;if((void 0===this.lastAttackState||this.lastAttackState!==K&&!this.gameObject.isDestroyed)&&(this.lastAttackState=K,!this.gameObject.isDestroyed&&this.hasAnimation(_.AnimationType.SPECIAL_SHOOT)&&(K===se.AttackState.FireUp?this.setAnimation(_.AnimationType.SPECIAL_SHOOT,g):this.currentAnimType===_.AnimationType.SPECIAL_SHOOT&&this.setAnimation(_.AnimationType.IDLE,g)),K===se.AttackState.JustFired&&this.objectArt.muzzleFlash)){let g=this.createMuzzleFlashAnim(this.spriteOffset,this.renderableManager);g&&(g.create3DObject(),this.spriteWrap.add(g.get3DObject()),this.muzzleAnims=this.muzzleAnims||[],this.muzzleAnims.push(g))}var q=this.gameObject.factoryTrait;if(q){var $=q.status;if(this.lastFactoryStatus!==$&&!this.gameObject.isDestroyed&&(K=this.lastFactoryStatus,this.lastFactoryStatus=$,void 0!==K)){let P,I=!1;[re.FactoryType.BuildingType,re.FactoryType.NavalUnitType].includes(q.type)?P=_.AnimationType.PRODUCTION:q.type===re.FactoryType.UnitType?(P=q.deliveringUnit?.rules.consideredAircraft?_.AnimationType.FACTORY_ROOF_DEPLOYING:_.AnimationType.FACTORY_DEPLOYING,I=!0):P=void 0,P&&this.hasAnimation(P)&&($===ne.FactoryStatus.Delivering?this.setAnimation(P,g):I&&this.setAnimation(_.AnimationType.IDLE,g))}}$=this.gameObject.unitRepairTrait?.status,this.lastRepairStatus===$||this.gameObject.isDestroyed||(Z=this.lastRepairStatus,this.lastRepairStatus=$,this.hasAnimation(_.AnimationType.SPECIAL_REPAIR_START)&&($===oe.RepairStatus.Repairing?(this.currentAnimType!==_.AnimationType.SPECIAL_REPAIR_LOOP&&this.currentAnimType!==_.AnimationType.SPECIAL_REPAIR_END||Z!==oe.RepairStatus.Idle?this.setAnimation(_.AnimationType.SPECIAL_REPAIR_START,g):this.repairStartRequested=!0,this.repairStopRequested=!1):(this.currentAnimType===_.AnimationType.SPECIAL_REPAIR_START?this.repairStopRequested=!0:this.endCurrentAnimation(),this.repairStartRequested=!1)));let J=this.gameObject.superWeaponTrait?.getSuperWeapon(this.gameObject);!J||!this.hasAnimation(_.AnimationType.SUPER_CHARGE_START)||this.gameObject.isDestroyed||(X=J.getTimerSeconds()<=60*this.objectRules.chargedAnimTime)!==this.lastSuperWeaponAlmostCharged&&((this.lastSuperWeaponAlmostCharged=X)?this.setAnimation(_.AnimationType.SUPER_CHARGE_START,g):this.endCurrentAnimation()),this.repairStopRequested&&this.currentAnimType===_.AnimationType.SPECIAL_REPAIR_LOOP&&(this.endCurrentAnimation(),this.repairStopRequested=!1),this.repairStartRequested&&this.currentAnimType===_.AnimationType.IDLE&&(this.setAnimation(_.AnimationType.SPECIAL_REPAIR_START,g),this.repairStartRequested=!1),this.muzzleAnims&&this.updateMuzzleAnims(g),z||(this.animations.forEach((P,I)=>{switch(P.getState()){case V.AnimationState.STOPPED:return;case V.AnimationState.DELAYED:P.update(g),I.get3DObject().visible=P.getState()!==V.AnimationState.DELAYED;break;case V.AnimationState.NOT_STARTED:P.start(g);case V.AnimationState.RUNNING:default:P.update(g)}I.setFrame(P.getCurrentFrame())}),this.animObjects.forEach((g,P)=>{let I=this.animArtProps.getByType(P);g.forEach((g,P)=>{var L=I[P];let _=this.animations.get(g);var U=L.translucent;L=L.translucency;if(U||0<L){let P;P=U?(U=_.props,1-_.getCurrentFrame()/(U.end-U.start)):1-L,g.setOpacity(P)}})})),this.toggleRangeCircleVisibility((this.gameObject.showWeaponRange||this.selectionModel.isSelected()&&-1!==this.gameObject.rules.techLevel)&&!z);$=this.gameObject.wallTrait?.wallType!==this.lastWallType;var Q,Y,Z=void 0===this.lastOccupiedState||this.lastOccupiedState!==!!this.gameObject.garrisonTrait?.isOccupied(),X=void 0===this.lastHealth||this.lastHealth!==this.gameObject.healthTrait.health;($||Z||X)&&(Q=this.computeDamageType(this.gameObject.healthTrait.health),X=X&&Q!==this.computeDamageType(this.lastHealth),this.lastOccupiedState=!!this.gameObject.garrisonTrait?.isOccupied(),this.lastHealth=this.gameObject.healthTrait.health,this.lastWallType=this.gameObject.wallTrait?.wallType,($||Z||X)&&this.updateImage(Q),X&&Q===L.DamageType.DESTROYED&&this.objectRules.explosion.length&&this.createExplosionAnims(this.renderableManager)),this.gameObject.turretTrait&&((Q=this.gameObject.turretTrait.facing)!==this.lastTurretFacing&&(this.lastTurretFacing=Q,this.turretRot.rotation.y=THREE.Math.degToRad(Q),this.turretRot.updateMatrix()),Q=this.gameObject.turretTrait.isRotating()&&!z,this.lastTurretRotating!==Q&&(this.lastTurretRotating=Q,(Y=this.objectRules.turretRotateSound)&&(Q&&!this.gameObject.isDestroyed?this.turretRotateSound=this.worldSound?.playEffect(Y,this.gameObject,this.gameObject.owner):this.turretRotateSound?.stop()))),this.gameObject.poweredTrait&&(this.gameObject.isDestroyed?this.poweredSound&&(this.poweredSound.stop(),this.poweredSound=void 0):(Y=this.gameObject.poweredTrait.isPoweredOn()&&!z)!==this.lastPowered&&(this.setPowered(Y),this.lastPowered=Y,this.poweredSound?.stop(),(Y=Y?this.gameObject.rules.workingSound:this.gameObject.rules.notWorkingSound)&&!z&&(this.poweredSound=this.worldSound?.playEffect(Y,this.gameObject,this.gameObject.owner,.25))))}}createExplosionAnims(g){var P=this.objectArt.foundation,I=this.objectRules.explosion;for(let _=0;_<P.width;_++)for(let U=0;U<P.height;U++){var L=I[K.getRandomInt(0,I.length-1)];g.createTransientAnim(L,g=>{g.setPosition(z.Coords.tile3dToWorld(_,U,0).add(this.withPosition.getPosition()))})}}updateMuzzleAnims(g){let P=this.muzzleAnims,I=[];P.forEach(P=>{P.update(g),P.isAnimFinished()&&(this.spriteWrap.remove(P.get3DObject()),P.dispose(),I.push(P))}),I.forEach(g=>P.splice(P.indexOf(g),1))}getNormalizedAnimType(g){let P=0,I=g;return fe.has(g)&&([I,P]=fe.get(g)),[I,P]}hasObjectWithStoppedAnimation(g){var P,[P,I]=this.getNormalizedAnimType(g);if(P=this.animObjects.get(P)){let L=this.animations.get(P[I]);if(!L)throw new Error(`Missing animation for type '${_.AnimationType[g]}'`);if(L.getState()===V.AnimationState.STOPPED)return!0}return!1}computeDamageType(g){if(!g)return L.DamageType.DESTROYED;let P;return P=g>100*this.rules.audioVisual.conditionYellow?L.DamageType.NORMAL:g>100*this.rules.audioVisual.conditionRed?L.DamageType.CONDITION_YELLOW:L.DamageType.CONDITION_RED,(P&&this.objectRules.canBeOccupied||P===L.DamageType.CONDITION_RED)&&(P-=1),P}updateImage(g){let P=g===L.DamageType.DESTROYED;P?(this.objectRules.leaveRubble&&this.rubbleObj&&(this.rubbleObj.get3DObject().visible=!0),this.mainObj&&(this.mainObj.get3DObject().visible=!1)):this.gameObject.wallTrait?this.updateWallImage(this.gameObject.wallTrait.wallType,g):this.updateMainObjFrame(!!this.gameObject.garrisonTrait?.isOccupied(),g),this.bib&&(P&&(this.bib.get3DObject().visible=!1),this.bib.setFrame(g!==L.DamageType.NORMAL?1:0)),this.turret&&P&&(this.turret.visible=!1),this.animObjects.forEach((I,U)=>{I.forEach((G,V)=>{if(U!==_.AnimationType.BUILDUP&&U!==_.AnimationType.UNBUILD){P&&I.forEach(g=>g.get3DObject().visible=!1);let K=this.animations.get(G);var W=g!==L.DamageType.NORMAL,z=this.animArtProps.getByType(U)[V];!W||z.damagedArt?(K.props.setArt(W?z.damagedArt:z.art),K.rewind()):console.warn(`<${this.gameObject.name}>: Missing damaged anim ${_.AnimationType[U]},`+V)}})});let I=g!==L.DamageType.NORMAL&&!P;this.fireObjects.forEach(g=>{g.get3DObject().visible=I;let P=this.animations.get(g);P.rewind();var L=P.props.getArt().getString("StartSound");L&&this.handleSoundChange(L,g,I,.15)})}updateMainObjFrame(g,P){let I=g?2:P;this.mainShpFile&&this.mainObj&&(I>=this.shpFrameInfos.get(this.mainShpFile).frameCount&&(console.warn(`Building ${this.objectRules.name} has damage frame `+I+` (occupied=${g}, damageType=${L.DamageType[P]}) out of bounds`),I=L.DamageType.NORMAL),this.mainObj.setFrame(I))}updateWallImage(g,P){var I;this.mainObj&&this.mainShpFile&&((I=this.shpFrameInfos.get(this.mainShpFile).frameCount<W.wallTypes.length?1:W.wallTypes.length)-1<g&&(g=I-1,console.warn(`Building ${this.objectRules.name} is a wall but has fewer frames than facings.`)),this.mainObj.setFrame(g+P*I))}createObjects(g){var P=this.objectArt.foundation;this.debugFrame.value&&(U=Z.DebugUtils.createWireframe(P,this.objectArt.height),g.add(U));let I=new X.MapSpriteTranslation(P.width,P.height);var{spriteOffset:L,anchorPointWorld:_}=I.compute(),U=this.spriteOffset=this.computeSpriteAnchorOffset(L);let G=this.spriteWrap=new THREE.Object3D;G.matrixAutoUpdate=!1;let V=G,W={...U},K=!1;if(L=this.objectArt.zShapePointMove,(this.gameObject.rules.refinery||this.gameObject.rules.nukeSilo)&&L.length){V=new THREE.Object3D,V.matrixAutoUpdate=!1,G.add(V),K=!0,L={x:-L[0]/z.Coords.ISO_TILE_SIZE,y:-L[1]/z.Coords.ISO_TILE_SIZE};let g=new X.MapSpriteTranslation(L.x,L.y);var{spriteOffset:q,anchorPointWorld:L}=g.compute();V.position.x=L.x,V.position.z=L.y,V.updateMatrix(),W.x+=q.x,W.y+=q.y}if(this.mainShpFile?(this.mainObj=this.createMainObject(this.mainShpFile,W,K),this.mainObj.create3DObject(),V.add(this.mainObj.get3DObject()),this.mainObj.getFlat()&&(pe.MathUtils.translateTowardsCamera(this.mainObj.get3DObject(),this.camera,+z.Coords.ISO_WORLD_SCALE),this.mainObj.get3DObject().updateMatrix())):(this.placeholderObj=new ge.DebugRenderable(P,this.objectArt.height,this.palette),this.placeholderObj.setBatched(this.useSpriteBatching),this.useSpriteBatching&&this.placeholderObj.setBatchPalettes(this.paletteRemaps),this.placeholderObj.create3DObject(),g.add(this.placeholderObj.get3DObject())),this.objectRules.leaveRubble&&(this.rubbleObj=this.createRubbleObject(U),this.rubbleObj&&(this.rubbleObj.setExtraLight(this.shpExtraLight),this.rubbleObj.create3DObject(),this.rubbleObj.get3DObject().visible=!1,G.add(this.rubbleObj.get3DObject()))),this.createAnimObjects(W,K).forEach(g=>{V.add(g)}),this.fireObjects=this.createFireObjects(U),this.fireObjects.forEach(g=>{G.add(g.get3DObject())}),this.objectRules.turret&&(({turret:q,turretRot:P}=this.createTurretObject(U,_)),this.turret=q,this.turretRot=P,G.add(this.turret)),this.bibShpFile){this.bib=this.createBibObject(this.bibShpFile,U),this.bib.create3DObject();let g=this.bib.get3DObject();pe.MathUtils.translateTowardsCamera(g,this.camera,-1),g.updateMatrix(),G.add(this.bib.get3DObject())}if((this.gameObject.primaryWeapon||this.gameObject.rules.hasRadialIndicator)&&(U=this.gameObject.psychicDetectorTrait?.radiusTiles??this.gameObject.gapGeneratorTrait?.radiusTiles??this.gameObject.primaryWeapon?.range)){U=this.rangeCircle=this.createRangeCircle(U);let P=this.rangeCircleWrapper=new THREE.Object3D;P.matrixAutoUpdate=!1,P.position.x=_.x/2,P.position.z=_.y/2,P.updateMatrix(),P.visible=!1,P.add(U),g.add(P)}G.position.x=_.x,G.position.z=_.y,G.updateMatrix(),g.add(G)}computeSpriteAnchorOffset(g){var P=this.objectArt.getDrawOffset();return{x:g.x+P.x,y:g.y+P.y}}createMainObject(g,P,I=!1){let L=!1;this.objectRules.turret&&"CAOUTP"!==this.objectRules.name&&(L=!0);let _=Q.ShpRenderable.factory(this.aggregatedImageData.file,this.palette,this.camera,P,this.objectArt.hasShadow,0,!L,0,I);return _.setSize(g),_.setFrameOffset(this.aggregatedImageData.imageIndexes.get(g)),_.setBatched(this.useSpriteBatching),this.useSpriteBatching&&_.setBatchPalettes(this.paletteRemaps),_.setFlat(L),_}createRubbleObject(g){var P=this.mainShpFile;if(P){let I=Q.ShpRenderable.factory(this.aggregatedImageData.file,this.isoPalette,this.camera,g,this.objectArt.hasShadow);if(I.setSize(P),!(this.shpFrameInfos.get(P).frameCount<4))return I.setFrameOffset(this.aggregatedImageData.imageIndexes.get(P)),I.setBatched(this.useSpriteBatching),this.useSpriteBatching&&I.setBatchPalettes([this.isoPalette]),I.setFlat(!0),I.setFrame(3),I;console.warn(`Building image ${this.objectArt.imageName} has no rubble frame (missing 4th frame)`)}}createAnimObjects(g,P){let I=[];return this.animArtProps.getAll().forEach((L,_)=>{let U=[],G=1;for(var V of L){var W=this.animShpFiles.get(V);if(W){let L=this.createAnimObject(V,W,g,G++,P);L&&(I.push(L.get3DObject()),U.push(L))}}this.animObjects.set(_,U)}),I}createFireObjects(g){let P=[],L=0;for(;;){let G=this.objectArt.art.getString("DamageFireOffset"+L++);if(!G)break;var _=this.rules.audioVisual.fireNames,U=_[K.getRandomInt(0,_.length-1)];let W;try{W=this.imageFinder.find(U,this.objectArt.useTheaterExtension)}catch(g){if(g instanceof Y.ImageFinder.MissingImageError){console.warn(g.message);continue}throw g}_=G.split(/\.|,/).filter(g=>""!==g);let $=parseInt(_[0],10),Z=parseInt(_[1],10);_=this.animPalette;let X=new I.ShpBuilder(W,_,this.camera,z.Coords.ISO_WORLD_SCALE,!0,3);X.setOffset({x:g.x+$,y:g.y+Z});let J=new Q.ShpRenderable(X);J.setBatched(this.useSpriteBatching),this.useSpriteBatching&&J.setBatchPalettes([_]),J.create3DObject(),J.get3DObject().visible=!1,U=this.art.getAnimation(U),U=new q.AnimProps(U.art,W),this.animations.set(J,new V.Animation(U,this.gameSpeed)),P.push(J)}return P}createMuzzleFlashAnim(g,P){if(this.objectArt.muzzleFlash?.length){var I=K.getRandomInt(0,this.objectArt.muzzleFlash.length-1),L=this.objectArt.muzzleFlash[I];if((I=this.gameObject.owner.country?.side===ae.SideType.GDI?this.gameObject.primaryWeapon:this.gameObject.secondaryWeapon)&&(I=I.rules.anim).length){I=I[K.getRandomInt(0,I.length-1)];let _={x:g.x+L.x,y:g.y+L.y};return P.createAnim(I,g=>{g.extraOffset=_},!0)}}}createAnimObject(g,P,I,L,U){var G=g.art;let W=new q.AnimProps(G,P);g.type!==_.AnimationType.BUILDUP&&g.type!==_.AnimationType.UNBUILD||(z=W.shadow?P.numImages/2:P.numImages,W.rate=z/(60*this.rules.general.buildupTime));var z={x:I.x+g.offset.x,y:I.y+g.offset.y};let K=Q.ShpRenderable.factory(this.aggregatedImageData.file,this.palette,this.camera,z,W.shadow,0,!g.flat,L,U&&!g.flat);return K.setSize(P),K.setFrameOffset(this.aggregatedImageData.imageIndexes.get(P)),K.setBatched(this.useSpriteBatching),this.useSpriteBatching&&K.setBatchPalettes(this.paletteRemaps),K.setFlat(g.flat),(g.translucent||0<g.translucency)&&K.setForceTransparent(!0),K.create3DObject(),this.animations.set(K,new V.Animation(W,this.gameSpeed)),K}createBibObject(g,P){let I=Q.ShpRenderable.factory(this.aggregatedImageData.file,this.palette,this.camera,P,this.objectArt.hasShadow);return I.setSize(g),I.setFrameOffset(this.aggregatedImageData.imageIndexes.get(g)),I.setBatched(this.useSpriteBatching),this.useSpriteBatching&&I.setBatchPalettes(this.paletteRemaps),I.setFlat(!0),I}createTurretObject(g,P){this.turretBuilders=[];let L=new THREE.Object3D;L.matrixAutoUpdate=!1;let _=new THREE.Object3D;_.matrixAutoUpdate=!1;let U=this.objectRules.turretAnim;var G={x:this.objectRules.turretAnimX,y:this.objectRules.turretAnimY};let V;if(this.objectRules.turretAnimIsVoxel){var W=!this.objectArt.noHva;let g=U.toLowerCase()+".vxl";var K=this.voxels.get(g);if(K){var q=W?this.voxelAnims.get(g.replace(".vxl",".hva")):void 0;let P=this.vxlBuilderFactory.create(K,q,this.paletteRemaps,this.palette);this.turretBuilders.push(P),V=P.build(),V.children.forEach(g=>g.castShadow=!1)}else console.warn(`Turret missing for building ${this.type}. Vxl file ${g} not found. `);if(U.toLowerCase().includes("tur")){let P=g.replace("tur","barl");if(q=this.voxels.get(P)){var $=W?this.voxelAnims.get(P.replace(".vxl",".hva")):void 0;let g=this.vxlBuilderFactory.create(q,$,this.paletteRemaps,this.palette);this.turretBuilders.push(g);let I=g.build();I.children.forEach(g=>g.castShadow=!1),_.add(I)}}$=z.Coords.screenDistanceToWorld(G.x,G.y),L.position.x=-P.x+$.x,L.position.z=-P.y+$.y}else{let L;try{L=this.imageFinder.find(U,this.objectArt.useTheaterExtension)}catch(P){if(!(P instanceof Y.ImageFinder.MissingImageError))throw P;console.warn(P.message)}if(L){let P=new I.ShpBuilder(L,this.palette,this.camera,z.Coords.ISO_WORLD_SCALE,!0,2);P.setBatched(this.useSpriteBatching),this.useSpriteBatching&&P.setBatchPalettes(this.paletteRemaps),this.turretBuilders.push(P),P.setOffset({x:g.x+G.x,y:g.y+G.y}),V=P.build()}}return V&&_.add(V),L.add(_),pe.MathUtils.translateTowardsCamera(L,this.camera,-(this.objectRules.turretAnimZAdjust+this.objectRules.turretAnimY/Math.cos(this.camera.rotation.y))*z.Coords.ISO_WORLD_SCALE),L.updateMatrix(),{turret:L,turretRot:_}}createRangeCircle(g){var P=g*z.Coords.getWorldTileSize();let I=this.gameObject.owner.color,L=U.OverlayUtils.createGroundCircle(P,I.asHex());return L.matrixAutoUpdate=!1,L.updateMatrix(),L}toggleRangeCircleVisibility(g){var P;this.rangeCircleWrapper&&(this.rangeCircleWrapper.visible=g,(P=this.gameObject.overpoweredTrait?.isOverpowered())!==this.lastOverpowered&&(this.lastOverpowered=P,this.rangeCircle&&(this.rangeCircleWrapper.remove(this.rangeCircle),this.rangeCircle.material.dispose(),this.rangeCircle.geometry.dispose()),(P=this.gameObject.overpoweredTrait?.getWeapon()?.range)&&(this.rangeCircle=this.createRangeCircle(P),this.rangeCircleWrapper.add(this.rangeCircle))))}setAnimationVisibility(g,P,I=-1){let L=this.animObjects.get(g);if(void 0===L)throw new Error(`Missing animObjects for animType "${_.AnimationType[g]}"`);if(-1!==I){if(I>=L.length)throw new RangeError(`Index ${I} exceeds length of animation objects (${L.length}) of type `+_.AnimationType[g]);L=[L[I]]}for(var U of L){U.get3DObject().visible=P;let g=this.animations.get(U).props.getArt(),I=g.getString("Report");I=I||g.getString("StartSound"),I&&this.handleSoundChange(I,U,P)}}setActiveAnimationVisible(){let g=this.animArtProps.getByType(_.AnimationType.ACTIVE);this.objectRules.refinery&&(g=[g[0]]),g.forEach(({showWhenUnpowered:g},P)=>{try{this.setAnimationVisibility(_.AnimationType.ACTIVE,this.powered||g,P)}catch(g){RangeError}})}setPowered(g){if(this.powered=g,this.currentAnimType===_.AnimationType.IDLE&&this.setActiveAnimationVisible(),this.objectRules.superWeapon&&this.hasAnimation(_.AnimationType.SUPER)){var[P,I]=this.getNormalizedAnimType(_.AnimationType.SUPER_CHARGE_LOOP),L=this.animObjects.get(P);if(void 0===L)throw new Error(`Missing anim object for normalized anim type "${_.AnimationType[P]}"`);I=L[I];let U=this.animations.get(I);g?U.unpause():U.pause()}else this.animObjects.get(_.AnimationType.ACTIVE).forEach((P,I)=>{let L=this.animations.get(P);L&&(!g&&this.animArtProps.getByType(_.AnimationType.ACTIVE)[I].pauseWhenUnpowered?L.pause():L.unpause())})}hasAnimation(g){return g===_.AnimationType.IDLE||([g]=this.getNormalizedAnimType(g),this.animObjects.has(g)&&!!this.animObjects.get(g).length)}setAnimation(g,P){if(!this.gameObject.healthTrait.health)throw new Error("We can't switch building animation for a destroyed building");switch(this.hasAnimation(g)||(g=_.AnimationType.IDLE),this.currentAnimType=g,this.setAnimationVisibility(_.AnimationType.IDLE,!1),this.setAnimationVisibility(_.AnimationType.SPECIAL,!1),this.setAnimationVisibility(_.AnimationType.PRODUCTION,!1),this.setAnimationVisibility(_.AnimationType.SUPER,!1),this.setAnimationVisibility(_.AnimationType.BUILDUP,!1),this.setAnimationVisibility(_.AnimationType.UNBUILD,!1),this.setAnimationVisibility(_.AnimationType.FACTORY_DEPLOYING,!1),this.setAnimationVisibility(_.AnimationType.FACTORY_ROOF_DEPLOYING,!1),this.setActiveAnimationVisible(),g!==_.AnimationType.BUILDUP&&g!==_.AnimationType.UNBUILD?(this.mainObj&&(this.mainObj.get3DObject().visible=!0),this.bib&&(this.bib.get3DObject().visible=!0),this.turret&&(this.turret.visible=!0)):(this.mainObj&&(this.mainObj.get3DObject().visible=!1),this.bib&&(this.bib.get3DObject().visible=!1),this.turret&&(this.turret.visible=!1)),g!==_.AnimationType.FACTORY_DEPLOYING&&g!==_.AnimationType.FACTORY_ROOF_DEPLOYING||this.mainObj&&(this.mainObj.get3DObject().visible=!1),g){case _.AnimationType.PRODUCTION:this.setAnimationVisibility(_.AnimationType.PRODUCTION,!0),this.animObjects.get(_.AnimationType.PRODUCTION).forEach(g=>{this.animations.get(g).start(P)});break;case _.AnimationType.BUILDUP:this.setAnimationVisibility(_.AnimationType.ACTIVE,!1),this.setAnimationVisibility(_.AnimationType.BUILDUP,!0),this.animObjects.get(_.AnimationType.BUILDUP).forEach(g=>{this.animations.get(g).start(P)});break;case _.AnimationType.UNBUILD:this.setAnimationVisibility(_.AnimationType.ACTIVE,!1),this.setAnimationVisibility(_.AnimationType.UNBUILD,!0),this.animObjects.get(_.AnimationType.UNBUILD).forEach(g=>{this.animations.get(g).start(P)});break;case _.AnimationType.FACTORY_DEPLOYING:if(this.hasAnimation(_.AnimationType.FACTORY_DEPLOYING)&&this.objectRules.factory){this.setAnimationVisibility(_.AnimationType.FACTORY_DEPLOYING,!0),this.animObjects.get(_.AnimationType.FACTORY_DEPLOYING).forEach(g=>{this.animations.get(g).start(P)});break}case _.AnimationType.FACTORY_ROOF_DEPLOYING:if(this.hasAnimation(_.AnimationType.FACTORY_ROOF_DEPLOYING)&&this.objectRules.factory){this.setAnimationVisibility(_.AnimationType.FACTORY_ROOF_DEPLOYING,!0),this.animObjects.get(_.AnimationType.FACTORY_ROOF_DEPLOYING).forEach(g=>{this.animations.get(g).start(P)});break}case _.AnimationType.SPECIAL_REPAIR_START:case _.AnimationType.SPECIAL_REPAIR_LOOP:case _.AnimationType.SPECIAL_REPAIR_END:case _.AnimationType.SPECIAL_DOCKING:if(this.hasAnimation(_.AnimationType.SPECIAL)&&(g===_.AnimationType.SPECIAL_DOCKING&&this.objectRules.refinery||g!==_.AnimationType.SPECIAL_DOCKING&&this.objectRules.unitRepair)){var[I,L]=this.getNormalizedAnimType(g);this.setAnimationVisibility(I,!0,L),L=this.animObjects.get(I)[L],this.animations.get(L).start(P);break}case _.AnimationType.SPECIAL_SHOOT:if(this.objectRules.isBaseDefense){this.setAnimationVisibility(_.AnimationType.ACTIVE,!1);var[L,U]=this.getNormalizedAnimType(g);this.setAnimationVisibility(L,!0,U),U=this.animObjects.get(L)[U],this.animations.get(U).start(P);break}case _.AnimationType.SUPER_CHARGE_START:case _.AnimationType.SUPER_CHARGE_LOOP:case _.AnimationType.SUPER_CHARGE_END:if(this.objectRules.superWeapon&&this.hasAnimation(_.AnimationType.SUPER)){var[U,G]=this.getNormalizedAnimType(g);this.setAnimationVisibility(U,!0,G),G=this.animObjects.get(U)[G],this.animations.get(G).start(P);break}case _.AnimationType.IDLE:default:this.currentAnimType=_.AnimationType.IDLE,this.objectRules.superWeapon&&this.hasAnimation(_.AnimationType.SUPER)?(this.setAnimationVisibility(_.AnimationType.SUPER,!0,0),G=this.animObjects.get(_.AnimationType.SUPER)[0],this.animations.get(G).start(P)):(this.setAnimationVisibility(_.AnimationType.IDLE,!0),this.animObjects.get(_.AnimationType.IDLE).forEach(g=>{this.animations.get(g).start(P)}))}}doWithAnimation(g,P){var[I,L]=this.getNormalizedAnimType(g);let U=this.animObjects.get(I);if(void 0===U)throw new Error(`Missing animObjects for anim type "${_.AnimationType[I]}"`);I!==g&&(U=[U[L]]),U.forEach((g,I)=>{P(this.animations.get(g),g)})}doWithCurrentAnimation(g){this.doWithAnimation(this.currentAnimType,g)}endCurrentAnimation(){this.doWithCurrentAnimation(g=>g.endLoop())}handleSoundChange(g,P,I,L=1){if(I){var _;this.animSounds.has(P)&&this.animSounds.get(P).isPlaying()||(_=this.worldSound?.playEffect(g,this.gameObject,this.gameObject.owner,L))&&this.animSounds.set(P,_)}else{let g=this.animSounds.get(P);g&&g.isLoop&&(g.stop(),this.animSounds.delete(P))}}onCreate(g){this.renderableManager=g,this.plugins.forEach(P=>P.onCreate(g)),this.objectRules.ambientSound&&(this.ambientSound=this.worldSound?.playEffect(this.objectRules.ambientSound,this.gameObject,void 0,.25)),this.pipOverlay?.onCreate(g)}onRemove(g){if(this.renderableManager=void 0,this.plugins.forEach(P=>P.onRemove(g)),this.animSounds.forEach(g=>g.stop()),this.ambientSound?.stop(),this.turretRotateSound?.stop(),this.poweredSound?.stop(),this.gameObject.isDestroyed)return this.gameObject.deathType===le.DeathType.Temporal||this.gameObject.deathType===le.DeathType.None?void 0:void(this.objectRules.explosion.length&&this.createExplosionAnims(g))}dispose(){this.plugins.forEach(g=>g.dispose()),this.pipOverlay?.dispose(),this.placeholderObj?.dispose(),this.mainObj?.dispose(),this.rubbleObj?.dispose(),this.bib?.dispose(),this.fireObjects?.forEach(g=>g.dispose()),this.turretBuilders?.forEach(g=>g.dispose()),[...this.animObjects?.values()??[]].forEach(g=>g.forEach(g=>g.dispose()))}}),ye.lampTextures=new Map}}}),System.register("engine/renderable/entity/building/AnimationType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("AnimationType",I={}))[P.IDLE=0]="IDLE",P[P.PRODUCTION=1]="PRODUCTION",P[P.ACTIVE=2]="ACTIVE",P[P.SPECIAL=3]="SPECIAL",P[P.SUPER=4]="SUPER",P[P.BUILDUP=5]="BUILDUP",P[P.UNBUILD=6]="UNBUILD",P[P.FACTORY_DEPLOYING=7]="FACTORY_DEPLOYING",P[P.FACTORY_ROOF_DEPLOYING=8]="FACTORY_ROOF_DEPLOYING",P[P.SUPER_IDLE=9]="SUPER_IDLE",P[P.SUPER_CHARGE_START=10]="SUPER_CHARGE_START",P[P.SUPER_CHARGE_LOOP=11]="SUPER_CHARGE_LOOP",P[P.SUPER_CHARGE_END=12]="SUPER_CHARGE_END",P[P.SPECIAL_DOCKING=13]="SPECIAL_DOCKING",P[P.SPECIAL_REPAIR_START=14]="SPECIAL_REPAIR_START",P[P.SPECIAL_REPAIR_LOOP=15]="SPECIAL_REPAIR_LOOP",P[P.SPECIAL_REPAIR_END=16]="SPECIAL_REPAIR_END",P[P.SPECIAL_SHOOT=17]="SPECIAL_SHOOT",P[P.FACTORY_UNDER_DOOR=18]="FACTORY_UNDER_DOOR",P[P.FACTORY_UNDER_ROOF_DOOR=19]="FACTORY_UNDER_ROOF_DOOR"}}}),System.register("engine/renderable/entity/building/BuildingAnimArtProps",["engine/renderable/entity/building/AnimationType","data/IniSection","engine/renderable/entity/building/BuildingAnimData","engine/type/ObjectType"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=(new Map).set(I.AnimationType.IDLE,["IdleAnim"]).set(I.AnimationType.PRODUCTION,["ProductionAnim"]).set(I.AnimationType.SUPER,["SuperAnim","SuperAnimTwo","SuperAnimThree","SuperAnimFour"]).set(I.AnimationType.ACTIVE,["ActiveAnim","ActiveAnimTwo","ActiveAnimThree","ActiveAnimFour"]).set(I.AnimationType.SPECIAL,["SpecialAnim","SpecialAnimTwo","SpecialAnimThree","SpecialAnimFour"]).set(I.AnimationType.FACTORY_DEPLOYING,["DeployingAnim","UnderDoorAnim"]).set(I.AnimationType.FACTORY_ROOF_DEPLOYING,["RoofDeployingAnim","UnderRoofDoorAnim"]).set(I.AnimationType.BUILDUP,["Buildup"]).set(I.AnimationType.UNBUILD,["Buildup"]),g("BuildingAnimArtProps",class{constructor(){this.animsByType=new Map}read(g,P){G.forEach((G,V)=>{let W=[];G.forEach((G,z)=>{var K=g.getString(G);if(K){let z,$,Q=new _.BuildingAnimData;if(Q.name=K,Q.type=V,P.hasObject(K,U.ObjectType.Animation)&&($=P.getObject(K,U.ObjectType.Animation),z=$.art),V===I.AnimationType.BUILDUP||V===I.AnimationType.UNBUILD)z=z?z.clone():new L.IniSection(K),z.has("Shadow")||z.set("Shadow","yes"),V===I.AnimationType.UNBUILD&&z.set("Reverse","yes");else if(!z)throw new Error(`Missing building anim section "${K}"`);Q.art=z,Q.pauseWhenUnpowered=g.getBool(G+"Powered",!0),Q.showWhenUnpowered=!g.getBool(G+"PoweredLight",!1);var q=g.getString(G+"Damaged");q&&P.hasObject(q,U.ObjectType.Animation)&&(Q.damagedArt=P.getObject(q,U.ObjectType.Animation).art),Q.offset={x:g.getNumber(G+"X"),y:g.getNumber(G+"Y")};let Y=z.getString("Image");Y=Y||K,Q.image=Y,Q.flat="UnderDoorAnim"===G||"UnderRoofDoorAnim"===G||z.getBool("Flat"),$&&(Q.translucent=$.translucent,Q.translucency=$.translucency),W.push(Q)}}),this.animsByType.set(V,W)})}getByType(g){if(!this.animsByType.has(g))throw new Error(`Animation type "${I.AnimationType[g]}" has no data`);return this.animsByType.get(g)}getAll(){return this.animsByType}})}}}),System.register("engine/renderable/entity/building/BuildingAnimData",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("BuildingAnimData",class{})}}}),System.register("engine/renderable/entity/building/BuildingShpHelper",["engine/AnimProps","engine/ImageFinder","engine/renderable/builder/ShpAggregator"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("BuildingShpHelper",class{constructor(g){this.imageFinder=g}getShpFrameInfos(g,P,L,U){let G=new Map;for(var[V,W]of(P&&G.set(P,_.ShpAggregator.getShpFrameInfo(P,g.hasShadow)),L&&G.set(L,_.ShpAggregator.getShpFrameInfo(L,g.hasShadow)),U))V=new I.AnimProps(V.art,W),V=_.ShpAggregator.getShpFrameInfo(W,V.shadow),G.set(W,V);return G}collectAnimShpFiles(g,P){let I=new Map;return g.getAll().forEach((g,_)=>{for(var U of g){let _;try{_=this.imageFinder.find(U.image,P.useTheaterExtension)}catch(g){if(g instanceof L.ImageFinder.MissingImageError){console.warn(g.message);continue}throw g}I.set(U,_)}}),I}})}}}),System.register("engine/renderable/entity/building/DamageType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("DamageType",I={}))[P.NORMAL=0]="NORMAL",P[P.CONDITION_YELLOW=1]="CONDITION_YELLOW",P[P.CONDITION_RED=2]="CONDITION_RED",P[P.DESTROYED=3]="DESTROYED"}}}),System.register("engine/renderable/entity/building/PsychicDetectPlugin",["engine/renderable/fx/DetectionLineFx"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("PsychicDetectPlugin",class{constructor(g,P,I,L){this.gameObject=g,this.psychicDetectorTrait=P,this.localPlayer=I,this.camera=L,this.lineEffects=new Map}onCreate(g){this.renderableManager=g}update(g){if(this.localPlayer.value===this.gameObject.owner){let g=this.psychicDetectorTrait.detectionLines;var P,L,_,U,G=g!==this.lastDetectionLines;this.lastDetectionLines=g;let $=g.map(g=>({hash:g.source.id+"_"+(g.target.obj?.id??g.target.tile.id),line:g}));if(G){for(let g of this.lineEffects.keys())$.find(({hash:P})=>P===g)||(this.disposeLine(this.lineEffects.get(g)),this.lineEffects.delete(g));for(var{line:V,hash:W}of $)this.lineEffects.has(W)||(P=V.source.position.worldPosition.clone(),L=V.target.getWorldCoords().clone(),V=new THREE.Color(V.source.owner.color.asHex()),V=new I.DetectionLineFx(this.camera,P,L,V,1e6),this.lineEffects.set(W,V),this.renderableManager.addEffect(V))}for({line:_,hash:U}of $){let g=this.lineEffects.get(U);if(!g)throw new Error("Line hash should have been found");var z=_.source.position.worldPosition.clone(),K=_.target.getWorldCoords().clone(),q=new THREE.Color(_.source.owner.color.asHex());g.color.equals(q)||(g.color.copy(q),g.needsUpdate=!0),g.sourcePos.equals(z)||(g.sourcePos.copy(z),g.needsUpdate=!0),g.targetPos.equals(K)||(g.targetPos.copy(K),g.needsUpdate=!0)}}else this.lineEffects.forEach(g=>this.disposeLine(g))}onRemove(){this.renderableManager=void 0,this.dispose()}dispose(){this.lineEffects.forEach(g=>this.disposeLine(g))}disposeLine(g){g.remove(),g.dispose()}})}}}),System.register("engine/renderable/entity/Debris",["engine/renderable/WithPosition","engine/renderable/ShpRenderable","engine/renderable/MapSpriteTranslation","engine/Animation","engine/AnimProps","engine/animation/SimpleRunner","game/Coords","engine/renderable/ShadowRenderable"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g}],execute:function(){g("Debris",class{constructor(g,P,I,L,_,U,G,V,W,z,K){this.gameObject=g,this.rules=P,this.imageFinder=I,this.voxels=L,this.palette=U,this.camera=G,this.lighting=V,this.gameSpeed=W,this.vxlBuilderFactory=z,this.useSpriteBatching=K,this.plugins=[],this.objectRules=g.rules,this.objectArt=g.art,this.label="debris_"+this.objectRules.name,this.init()}init(){this.baseShpExtraLight=this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation).addScalar(-1),this.baseVxlExtraLight=(new THREE.Vector3).addScalar(this.lighting.computeNoAmbient(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation)),this.vxlExtraLight=(new THREE.Vector3).copy(this.baseVxlExtraLight),this.shpExtraLight=(new THREE.Vector3).copy(this.baseShpExtraLight),this.withPosition=new I.WithPosition}registerPlugin(g){this.plugins.push(g)}updateLighting(){this.plugins.forEach(g=>g.updateLighting?.()),this.baseShpExtraLight=this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation).addScalar(-1),this.baseVxlExtraLight=(new THREE.Vector3).addScalar(this.lighting.computeNoAmbient(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation)),this.vxlExtraLight.copy(this.baseVxlExtraLight),this.shpExtraLight.copy(this.baseShpExtraLight)}get3DObject(){return this.target}create3DObject(){let g=this.get3DObject();g||(g=new THREE.Object3D,g.name=this.label,this.target=g,g.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(g),this.vxlBuilder?.setExtraLight(this.vxlExtraLight),this.shpRenderable?.setExtraLight(this.shpExtraLight))}setPosition(g){this.withPosition.setPosition(g.x,g.y,g.z)}getPosition(){return this.withPosition.getPosition()}update(g,P=0){this.plugins.forEach(P=>P.update(g));var I=this.gameObject.tile.z+this.gameObject.tileElevation;if((void 0===this.lastElevation||this.lastElevation!==I)&&(this.lastElevation=I,this.baseVxlExtraLight=(new THREE.Vector3).addScalar(this.lighting.computeNoAmbient(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation)),this.baseShpExtraLight=this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation).addScalar(-1),this.vxlExtraLight.copy(this.baseVxlExtraLight),this.shpExtraLight.copy(this.baseShpExtraLight),this.shadowWrap&&(this.shadowWrap.position.y=-W.Coords.tileHeightToWorld(this.gameObject.tileElevation),this.shadowWrap.updateMatrix())),0<P){var L=this.gameObject.velocity.clone().multiplyScalar(P).add(this.gameObject.position.worldPosition);this.setPosition(L)}this.vxlBuilder?(({rotationAxis:I,angularVelocity:L}=this.gameObject),this.vxlRotObj.rotateOnAxis(I,THREE.Math.degToRad(L)),this.vxlRotObj.updateMatrix()):(this.shpAnimRunner.tick(g),this.shpRenderable.setFrame(this.shpAnimRunner.animation.getCurrentFrame()),this.shpShadowRenderable.setFrame(this.shpAnimRunner.animation.getCurrentFrame()))}createObjects(g){let P=this.vxlRotObj=new THREE.Object3D;P.matrixAutoUpdate=!1,P.rotation.order="YXZ";var I=this.createMainObject();P.add(I),g.add(P)}computeSpriteAnchorOffset(g){var P=this.objectArt.getDrawOffset();return{x:g.x+P.x,y:g.y+P.y}}createMainObject(){let g=new THREE.Object3D;if(g.matrixAutoUpdate=!1,this.rules.voxelAnimRules.has(this.gameObject.name)){var P=this.getVxlFileName(this.objectRules,this.objectArt);if(!(K=this.voxels.get(P)))throw new Error(`VXL missing for anim ${this.objectRules.name}. Vxl file ${P} not found. `);let L=this.vxlBuilderFactory.create(K,void 0,[this.palette],this.palette);this.vxlBuilder=L;var I=L.build();g.add(I)}else{let q=new _.MapSpriteTranslation(1,1);var{spriteOffset:W,anchorPointWorld:P}=q.compute(),K=this.computeSpriteAnchorOffset(W);I=this.imageFinder.findByObjectArt(this.objectArt);let $=this.shpRenderable=L.ShpRenderable.factory(I,this.palette,this.camera,K,!1);$.setBatched(this.useSpriteBatching),this.useSpriteBatching&&$.setBatchPalettes([this.palette]),$.create3DObject(),g.add($.get3DObject()),W=z.ShadowRenderable.getOrCreateShadowPalette();let Q=this.shpShadowRenderable=L.ShpRenderable.factory(I,W,this.camera,K,!1);Q.setBatched(this.useSpriteBatching),this.useSpriteBatching&&Q.setBatchPalettes([W]),Q.setOpacity(.5),Q.create3DObject();let Y=this.shadowWrap=new THREE.Object3D;Y.matrixAutoUpdate=!1,Y.add(Q.get3DObject()),g.add(Y),g.position.x=P.x,g.position.z=P.y,g.updateMatrix(),$.setFlat(this.objectArt.flat),I=new G.AnimProps(this.objectArt.art,I),I=new U.Animation(I,this.gameSpeed),this.shpAnimRunner=new V.SimpleRunner,this.shpAnimRunner.animation=I}return g}getVxlFileName(g,P){let I=P.imageName;return g.shareSource&&(I=g.shareSource,g.shareTurretData?I+="tur":g.shareBarrelData&&(I+="barl")),I.toLowerCase()+".vxl"}onCreate(g){this.plugins.forEach(P=>P.onCreate(g))}onRemove(g){var P;this.plugins.forEach(P=>P.onRemove(g)),this.gameObject.isDestroyed&&this.get3DObject()&&(P=this.gameObject.explodeAnim)&&g.createTransientAnim(P,g=>g.setPosition(this.withPosition.getPosition()))}dispose(){this.plugins.forEach(g=>g.dispose()),this.shpRenderable?.dispose(),this.shpShadowRenderable?.dispose(),this.vxlBuilder?.dispose()}})}}}),System.register("engine/renderable/entity/HighlightAnimRunner",["engine/animation/SimpleRunner","engine/Animation","engine/AnimProps","data/IniSection","data/ShpFile"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){V=class extends I.SimpleRunner{constructor(g,P=.5,I=2,V=5){super(),this.maxAmount=P;let W=new _.AnimProps(new U.IniSection("dummy"),new G.ShpFile);W.rate=V,W.loopEnd=I-1,W.loopCount=2,this.animation=new L.Animation(W,g),this.animation.stop()}animate(g){this.animation.props.loopCount=g,this.animation.reset()}getValue(){return(1-this.getCurrentFrame())*this.maxAmount}},g("HighlightAnimRunner",V)}}}),System.register("engine/renderable/entity/Infantry",["engine/renderable/WithPosition","engine/ImageFinder","engine/gfx/DebugUtils","engine/renderable/ShpRenderable","game/Coords","engine/animation/SimpleRunner","engine/Animation","engine/AnimProps","data/IniSection","game/gameobject/infantry/sequenceMap","game/gameobject/unit/ZoneType","game/gameobject/infantry/StanceType","game/art/SequenceType","util/math","game/gameobject/infantry/InfDeathType","game/gameobject/unit/VeteranLevel","engine/renderable/entity/HighlightAnimRunner","game/gameobject/common/DeathType","game/type/MovementZone","engine/renderable/entity/unit/BlobShadow","engine/renderable/entity/BoxIntersectObject3D","engine/renderable/entity/unit/ExtraLightHelper","engine/renderable/DebugRenderable","engine/gfx/MathUtils"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g}],execute:function(){g("Infantry",class{constructor(g,P,L,_,U,G,V,W,z,K,q,$,Q,Y,Z){this.gameObject=g,this.rules=P,this.art=L,this.imageFinder=_,this.palette=G,this.camera=V,this.lighting=W,this.debugFrame=z,this.gameSpeed=K,this.selectionModel=q,this.useSpriteBatching=$,this.useMeshInstancing=Q,this.pipOverlay=Y,this.worldSound=Z,this.crashingSequencePlaying=!1,this.deathAnimSequencePlaying=!1,this.idleActionDue=!1,this.disguiseChanged=!1,this.highlightAnimRunner=new ee.HighlightAnimRunner(this.gameSpeed),this.plugins=[],this.objectArt=g.art,this.label="infantry_"+g.rules.name,this.paletteRemaps=[...this.rules.colors.values()].map(g=>this.palette.clone().remap(g)),this.palette=this.palette.remap(this.gameObject.owner.color),this.withPosition=new I.WithPosition,this.updateBaseLight(),this.extraLight=(new THREE.Vector3).copy(this.baseExtraLight)}updateBaseLight(){this.baseExtraLight=this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation).addScalar(-1+this.rules.audioVisual.extraInfantryLight)}registerPlugin(g){this.plugins.push(g)}updateLighting(){this.plugins.forEach(g=>g.updateLighting?.()),this.updateBaseLight(),this.extraLight.copy(this.baseExtraLight)}get3DObject(){return this.target}getIntersectTarget(){return this.target}getUiName(){var g=this.plugins.reduce((g,P)=>P.getUiNameOverride?.()??g,void 0);return void 0!==g?g:this.gameObject.getUiName()}create3DObject(){let g=this.get3DObject();g||(g=new ae.BoxIntersectObject3D(new THREE.Vector3(.5,2/3,.5).multiplyScalar(G.Coords.LEPTONS_PER_TILE)),g.name=this.label,g.userData.id=this.gameObject.id,this.target=g,g.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(g),this.shpRenderable?.setExtraLight(this.extraLight),this.pipOverlay&&(this.pipOverlay.create3DObject(),this.posWrap.add(this.pipOverlay.get3DObject())))}setPosition(g){this.withPosition.setPosition(g.x,g.y,g.z)}getPosition(){return this.withPosition.getPosition()}highlight(){this.plugins.some(g=>g.shouldDisableHighlight?.())||this.highlightAnimRunner.animation.getState()!==W.AnimationState.RUNNING&&this.highlightAnimRunner.animate(2)}update(g){this.plugins.forEach(P=>P.update(g));var{zone:P,stance:I,isCrashing:L,isMoving:_,isFiring:U,isPanicked:V,owner:z,veteranLevel:K}=this.gameObject;this.pipOverlay?.update(g),this.blobShadow?.update(g),K!==this.lastVeteranLevel&&(K===J.VeteranLevel.Elite&&void 0!==this.lastVeteranLevel&&this.highlightAnimRunner.animate(30),this.lastVeteranLevel=K);var Z=this.gameObject.tile.z+this.gameObject.tileElevation;void 0!==this.lastElevation&&this.lastElevation===Z||(this.lastElevation=Z,this.updateBaseLight(),this.extraLight.copy(this.baseExtraLight)),this.highlightAnimRunner.shouldUpdate()&&(this.highlightAnimRunner.tick(g),ne.ExtraLightHelper.multiplyShp(this.extraLight,this.baseExtraLight,this.highlightAnimRunner.getValue()));var ee=this.disguise?.owner??z;this.lastOwnerColor!==ee.color&&(this.palette.remap(ee.color),(this.shpRenderable??this.placeholder)?.setPalette(this.palette),this.lastOwnerColor=ee.color);var te=this.gameObject.warpedOutTrait.isActive(),K=te!==this.lastWarpedOut;if(this.lastWarpedOut=te,Z=this.gameObject.cloakableTrait?.isCloaked(),ee=Z!==this.lastCloaked,this.lastCloaked=Z,(K||ee)&&(this.shpRenderable??this.placeholder)?.setOpacity(te||Z?.5:1),L||void 0!==this.lastZone&&this.lastZone===P||(P===$.ZoneType.Water?this.gameObject.rules.enterWaterSound&&this.worldSound?.playEffect(this.gameObject.rules.enterWaterSound,this.gameObject,z):this.lastZone===$.ZoneType.Water&&this.gameObject.rules.leaveWaterSound&&this.worldSound?.playEffect(this.gameObject.rules.leaveWaterSound,this.gameObject,z),this.blobShadow&&this.shpRenderable?.setShadowVisible(!this.blobShadow.get3DObject().visible)),this.gameObject.isDestroyed&&this.deathPromiseResolve)if(this.deadBodyAnimRenderable){if((this.shpRenderable??this.placeholder).get3DObject().visible=!1,this.deadBodyAnimRenderable.update(g),this.deadBodyAnimRenderable.isAnimFinished())return void this.deathPromiseResolve()}else{if(!this.deathAnimRenderable){if(this.deathAnimSequencePlaying)return this.animRunner&&this.animRunner.animation.getState()!==W.AnimationState.STOPPED?(this.animRunner.tick(g),void this.updateShapeFrame(this.computeFacingNumber(this.gameObject.direction))):void([X.InfDeathType.Gunfire,X.InfDeathType.Explode].includes(this.gameObject.infDeathType)&&this.gameObject.rules.isHuman&&this.gameObject.zone===$.ZoneType.Ground?this.prepareDeadBodyAnim():this.deathPromiseResolve());if(Z=this.sequenceQueue.shift())return this.deathAnimSequencePlaying=!0,void this.setAnimParams(Z,g,!1);throw new Error("We should have a death sequence scheduled right now")}if((this.shpRenderable??this.placeholder).get3DObject().visible=!1,this.deathAnimRenderable.update(g),this.deathAnimRenderable.isAnimFinished())return void([X.InfDeathType.Gunfire,X.InfDeathType.Explode].includes(this.gameObject.infDeathType)&&this.gameObject.rules.isHuman?this.prepareDeadBodyAnim():this.deathPromiseResolve())}else{if(this.gameObject.warpedOutTrait.isActive())return;L&&(this.crashingSequencePlaying||(this.crashingSequencePlaying=!0,(re=q.getCrashingSequences(this.gameObject))&&(this.sequenceQueue=re)))}void 0!==this.lastDirection&&this.lastDirection===this.gameObject.direction||(this.lastDirection=this.gameObject.direction,this.computedDirection=this.gameObject.direction);var re=this.idleActionDue;this.idleActionDue=this.gameObject.idleActionTrait.actionDueThisTick();let se=this.idleActionDue&&!re;if(void 0===this.lastMoving||this.lastMoving!==_||void 0===this.lastFiring||this.lastFiring!==U||void 0===this.lastZone||this.lastZone!==P||void 0===this.lastPanicked||this.lastPanicked!==V||this.disguiseChanged){var ae=this.disguiseChanged,oe=this.lastFiring!==U;if(this.lastMoving=_,this.lastFiring=U,this.lastZone=P,this.lastPanicked=V,this.computedDirection=this.gameObject.direction,this.disguiseChanged=!1,!L&&(this.sequenceQueue=[],!oe||U||ae)){let L=this.findSequenceBy(P,I,_,U,V);void 0!==L&&(this.disguise&&[Y.SequenceType.FireUp,Y.SequenceType.FireProne].includes(L)&&(L=Y.SequenceType.Ready),this.setAnimParams(L,g,!U))}}if(void 0!==this.lastStance&&this.lastStance===I||(this.sequenceQueue=[],se=!1,oe=q.getStanceTransitionSequenceBy(this.lastStance,I),this.lastStance=I,oe&&this.objectArt.sequences.has(oe)&&this.sequenceQueue.push(oe),void 0!==(ae=this.findSequenceBy(P,I,_,U,V))&&this.sequenceQueue.push(ae),void 0!==this.currentSequenceParams?.onlyFacing&&(this.computedDirection=this.directionFromFacingNo(this.currentSequenceParams.onlyFacing)),ae=this.sequenceQueue.shift(),this.setAnimParams(ae,g,!oe),ae===Y.SequenceType.Paradrop?(ae=this.rules.audioVisual.parachute,this.paradropAnim=this.renderableManager.createAnim(ae,void 0,!0),this.paradropAnim.remapColor(z.color),this.paradropAnim.create3DObject(),this.paradropAnim.get3DObject().position.y=G.Coords.tileHeightToWorld(1),this.paradropAnim.get3DObject().updateMatrix(),this.posWrap.add(this.paradropAnim.get3DObject())):this.paradropAnim&&(this.paradropAnim.endAnimationLoop(),this.blobShadow&&(this.posWrap.remove(this.blobShadow.get3DObject()),this.blobShadow.dispose(),this.blobShadow=void 0,this.shpRenderable?.setShadowVisible(!0)))),this.paradropAnim&&(this.paradropAnim.update(g),this.paradropAnim.isAnimFinished()&&(this.posWrap.remove(this.paradropAnim.get3DObject()),this.paradropAnim=void 0)),this.sequenceQueue.length||_||U||I!==Q.StanceType.None&&I!==Q.StanceType.Guard||P===$.ZoneType.Air||!se||(.5<=Math.random()?(z=this.findIdleSequence(P,I,this.objectArt))&&this.setAnimParams(z,g,!1):this.computedDirection=Math.floor(360*Math.random())),this.animRunner){if(this.animRunner.animation.getState()===W.AnimationState.STOPPED&&this.currentSequenceParams){let L;[Y.SequenceType.Idle1,Y.SequenceType.Idle2].includes(this.currentSequenceParams.type)&&void 0!==this.currentSequenceParams.onlyFacing&&(this.computedDirection=this.directionFromFacingNo(this.currentSequenceParams.onlyFacing)),L=this.sequenceQueue.length?this.sequenceQueue.shift():this.findSequenceBy(P,I,_,U,V),void 0!==L&&this.setAnimParams(L,g,!U)}this.animRunner.tick(g),U=this.computeFacingNumber(this.computedDirection),this.updateShapeFrame(U)}}findIdleSequence(g,P,I){let L=q.getIdleSequenceBy(g,P);if(L?.length&&(L=L.filter(g=>I.sequences.has(g)),L.length||g===$.ZoneType.Ground||(L=q.getIdleSequenceBy($.ZoneType.Ground,P)?.filter(g=>I.sequences.has(g)))),L)return L[Z.getRandomInt(0,L.length-1)]}prepareDeadBodyAnim(){var g=(g=this.rules.audioVisual.deadBodies)[Z.getRandomInt(0,g.length-1)];this.deadBodyAnimRenderable=this.renderableManager.createAnim(g,void 0,!0),this.deadBodyAnimRenderable.create3DObject(),this.posWrap.add(this.deadBodyAnimRenderable.get3DObject())}findSequenceBy(g,P,I,L,_){var U=q.findSequence(g,P,I,L,_,[...this.objectArt.sequences.keys()]);if(void 0!==U)return U;console.warn(`Couldn't find a sequence for infantry "${this.gameObject.name}" (moving=${I}, firing=${L})`)}setAnimParams(g,P,I=!0){if(this.animRunner){var L=this.objectArt.sequences.get(g);if(L){this.currentSequenceParams=L;let _=this.animRunner.animation.props;_.loopCount=I?-1:1,_.loopEnd=L.frameCount-1,[Y.SequenceType.Deploy,Y.SequenceType.Undeploy,Y.SequenceType.Paradrop].includes(g)?g===Y.SequenceType.Paradrop?_.rate=2*z.AnimProps.defaultRate:_.rate=z.AnimProps.defaultRate:_.rate=z.AnimProps.defaultRate/2,[Y.SequenceType.Walk].includes(g)&&(_.rate/=1.33),this.animRunner.animation.start(P)}else console.warn(`Infantry "${this.gameObject.name}" is missing sequence "${Y.SequenceType[g]}"`)}}updateShapeFrame(g){var P,I;this.currentSequenceParams&&this.shpRenderable&&this.animRunner&&(({startFrame:P,facingMult:I}=this.currentSequenceParams),(I=P+I*g+this.animRunner.animation.getCurrentFrame())<this.shpRenderable.frameCount&&this.shpRenderable.setFrame(I))}computeFacingNumber(g){return Math.round((g-45+360)%360/360*8)%8}directionFromFacingNo(g){return 45+360*g/8}createObjects(g){if(this.debugFrame.value){let P=_.DebugUtils.createWireframe({width:.5,height:.5},1);P.translateX(-G.Coords.getWorldTileSize()/4),P.translateZ(-G.Coords.getWorldTileSize()/4),g.add(P)}let P=this.posWrap=new THREE.Object3D;P.matrixAutoUpdate=!1,g.add(P);var I=this.createMainObject(this.objectArt);P.add(I),(this.gameObject.rules.movementZone!==re.MovementZone.Fly||this.objectArt.isVoxel)&&this.gameObject.stance!==Q.StanceType.Paradrop||(this.blobShadow=new se.BlobShadow(this.gameObject,3,this.useMeshInstancing),this.blobShadow.create3DObject(),this.posWrap.add(this.blobShadow.get3DObject()))}createMainObject(g){let P;try{P=this.imageFinder.findByObjectArt(g)}catch(g){if(!(g instanceof L.ImageFinder.MissingImageError))throw g;console.warn(`<${this.gameObject.name}>: `+g.message)}if(!P)return this.placeholder=new oe.DebugRenderable({width:.25,height:.25},this.objectArt.height,this.palette,{centerFoundation:!0}),this.placeholder.setBatched(this.useSpriteBatching),this.useSpriteBatching&&this.placeholder.setBatchPalettes(this.paletteRemaps),this.placeholder.create3DObject(),this.placeholder.get3DObject();var I=g.getDrawOffset();let _=this.shpRenderable=U.ShpRenderable.factory(P,this.palette,this.camera,I,g.hasShadow);_.setBatched(this.useSpriteBatching),this.useSpriteBatching&&_.setBatchPalettes(this.paletteRemaps),_.create3DObject();let q=_.get3DObject();return le.MathUtils.translateTowardsCamera(q,this.camera,15*G.Coords.ISO_WORLD_SCALE),q.updateMatrix(),I=new z.AnimProps(new K.IniSection("dummy"),P),I=new W.Animation(I,this.gameSpeed),this.animRunner=new V.SimpleRunner,this.animRunner.animation=I,q}setDisguise(g){this.gameObject.isDestroyed||this.gameObject.isCrashing||(this.objectArt=g?.objectArt??this.gameObject.art,this.updateShpRenderableFromArt(this.objectArt),this.disguiseChanged=!0,this.disguise=g)}updateShpRenderableFromArt(g){var P=(this.shpRenderable??this.placeholder)?.get3DObject();P&&(this.posWrap.remove(P),(this.shpRenderable??this.placeholder)?.dispose()),this.posWrap.add(this.createMainObject(g))}onCreate(g){this.renderableManager=g,this.plugins.forEach(P=>P.onCreate(g)),this.gameObject.rules.ambientSound&&(this.ambientSound=this.worldSound?.playEffect(this.gameObject.rules.ambientSound,this.gameObject))}onRemove(g){if(this.renderableManager=void 0,this.plugins.forEach(P=>P.onRemove(g)),this.ambientSound?.stop(),this.gameObject.isDestroyed&&this.gameObject.deathType!==te.DeathType.Temporal&&this.gameObject.deathType!==te.DeathType.Crush&&this.gameObject.stance!==Q.StanceType.Paradrop){var P,I=q.getDeathSequence(this.gameObject,this.gameObject.infDeathType);if(I)1<I.length?(P=I[Z.getRandomInt(0,I.length-1)],this.sequenceQueue=[P]):this.sequenceQueue=[I[0]],this.disguise&&(this.objectArt=this.gameObject.art,this.updateShpRenderableFromArt(this.gameObject.art));else{if(!this.gameObject.rules.isHuman)return;if(!(I=q.getDeathAnim(this.rules,this.gameObject.infDeathType)))return;let P=this.art.getAnimation(I);if(this.deathAnimRenderable=g.createAnim(I,void 0,!0),this.deathAnimRenderable.create3DObject(),this.create3DObject(),this.posWrap.add(this.deathAnimRenderable.get3DObject()),P.isFlamingGuy){let g=P.art.clone();g.set("Shadow","yes"),g.set("LoopCount","0"),g.set("Start",String(8*P.runningFrames)),this.deathAnimRenderable.getAnimProps().setArt(g)}}return this.renderableManager=g,new Promise(g=>{this.deathPromiseResolve=()=>{this.renderableManager=void 0,g()}})}}dispose(){this.plugins.forEach(g=>g.dispose()),this.pipOverlay?.dispose(),this.shpRenderable?.dispose(),this.placeholder?.dispose(),this.deathAnimRenderable?.dispose(),this.deadBodyAnimRenderable?.dispose(),this.paradropAnim?.dispose(),this.blobShadow?.dispose()}})}}}),System.register("engine/renderable/entity/InvulnerableAnimRunner",["engine/animation/SimpleRunner","engine/Animation","engine/AnimProps","data/IniSection","data/ShpFile"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){V=class extends I.SimpleRunner{constructor(g,P=-.75,I=-.5,V=10,W=10){super(),this.minAmount=P,this.maxAmount=I,this.steps=V;let z=new _.AnimProps(new U.IniSection("dummy"),new G.ShpFile);z.rate=W,z.loopEnd=V,z.loopCount=-1,this.animation=new L.Animation(z,g),this.animation.stop()}animate(){this.animation.reset()}getValue(){return this.minAmount+(1+Math.sin(2*Math.PI*this.getCurrentFrame()/this.steps))/2*(this.maxAmount-this.minAmount)}},g("InvulnerableAnimRunner",V)}}}),System.register("engine/renderable/entity/map/MapBounds",["engine/IsoCoords","engine/renderable/WithVisibility","util/disposable/CompositeDisposable"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("MapBounds",class{constructor(g){this.map=g,this.withVisibility=new L.WithVisibility,this.disposables=new _.CompositeDisposable;let t=()=>{this.target&&this.wrapperObj&&(this.target.remove(this.wrapperObj),this.wrapperObj=this.build(),this.target.add(this.wrapperObj))};g.mapBounds.onLocalResize.subscribe(t),this.disposables.add(()=>g.mapBounds.onLocalResize.unsubscribe(t))}build(){var g=this.map.mapBounds.getClampedFullSize(),P=this.map.mapBounds.getLocalSize();let I=this.createBoundRect({x:g.x,y:g.y},{x:g.x+g.width,y:g.y+g.height},16711680);I.matrixAutoUpdate=!1;let L=this.createBoundRect({x:P.x,y:P.y},{x:P.x+P.width,y:P.y+P.height-1},255);L.matrixAutoUpdate=!1;let _=new THREE.Object3D;return _.matrixAutoUpdate=!1,_.add(I),_.add(L),_}createBoundRect(g,P,L){var _=I.IsoCoords.screenTileToWorld(g.x,g.y),U=I.IsoCoords.screenTileToWorld(P.x,P.y),G=I.IsoCoords.screenTileToWorld(P.x,g.y),V=I.IsoCoords.screenTileToWorld(g.x,P.y),W=new THREE.LineBasicMaterial({color:L,transparent:!0,depthTest:!1,depthWrite:!1});let z=new THREE.Geometry;z.vertices.push(new THREE.Vector3(_.x,0,_.y),new THREE.Vector3(V.x,0,V.y),new THREE.Vector3(U.x,0,U.y),new THREE.Vector3(G.x,0,G.y),new THREE.Vector3(_.x,0,_.y)),this.disposables.add(z,W);let K=new THREE.Line(z,W);return K.renderOrder=1e6,K}get3DObject(){return this.target}create3DObject(){if(!this.target){let g=new THREE.Object3D;g.matrixAutoUpdate=!1,g.name="map_bounds",g.visible=this.withVisibility.isVisible(),this.target=g,!this.wrapperObj&&g.visible&&(this.wrapperObj=this.build(),this.target.add(this.wrapperObj))}}update(){}setVisible(g){g!==this.withVisibility.isVisible()&&(this.withVisibility.setVisible(g),this.target&&((this.target.visible=g)?(this.wrapperObj||(this.wrapperObj=this.build()),this.target.add(this.wrapperObj)):this.wrapperObj&&this.target.remove(this.wrapperObj)))}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/entity/map/MapGrid",["game/Coords","engine/IsoCoords"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("MapGrid",class{constructor(g){this.size=g,this.build()}build(){var g=this.size,P=I.Coords.getWorldTileSize(),_=L.IsoCoords.screenTileToWorld(0,0),U=L.IsoCoords.screenTileToWorld(g.width,g.height),G=L.IsoCoords.screenTileToWorld(0,g.height);g=L.IsoCoords.screenTileToWorld(g.width,0),_=U.x-_.x,G=G.y-g.y,g=new THREE.PlaneGeometry(_,G,_/P,G/P),P=new THREE.MeshBasicMaterial({color:9474192,wireframe:!0,side:THREE.DoubleSide});let V=new THREE.Mesh(g,P);V.matrixAutoUpdate=!1,V.rotation.x=Math.PI/2,V.updateMatrix();let W=new THREE.Object3D;W.matrixAutoUpdate=!1,W.add(V),W.position.x=_/2,W.position.z=G/2,W.position.y=-1*I.Coords.ISO_WORLD_SCALE,W.updateMatrix(),this.target=W}get3DObject(){return this.target}create3DObject(){}update(){}})}}}),System.register("engine/renderable/entity/map/MapRenderable",["engine/renderable/entity/map/MapTileLayer","engine/renderable/entity/map/MapTileLayerDebug","engine/renderable/entity/map/MapSurface","engine/renderable/entity/map/MapBounds","engine/renderable/entity/map/MapShroudLayer","engine/renderable/builder/ShpAggregator","engine/renderable/entity/map/MapSpriteBatchLayer","game/map/BridgeOverlayTypes"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g}],execute:function(){g("MapRenderable",class{constructor(g,P,I,L,_,U,G,V,W,z,K,q,$){this.gameObj=g,this.mapShroud=P,this.mapRadiation=I,this.lighting=L,this.theater=_,this.rules=U,this.art=G,this.imageFinder=V,this.camera=W,this.debugWireframe=z,this.gameSpeed=K,this.worldSound=q,this.useSpriteBatching=$,this.lastDebugValue=!1,this.invalidatedRadTiles=new Set,this.radTileLights=new Map,this.handleRadChange=g=>{for(var P of g)this.invalidatedRadTiles.add(P)},this._objects=[],this.init()}get3DObject(){return this.target}getGameObject(){return this.gameObj}init(){var g=this.getGameObject();this.tileLayer=new I.MapTileLayer(g,this.theater,this.art,this.imageFinder,this.camera,this.debugWireframe,this.gameSpeed,this.worldSound,this.lighting,this.useSpriteBatching),this.addObject(this.tileLayer),this.debugLayer=new L.MapTileLayerDebug(g,this.theater,this.camera),this.debugLayer.setVisible(!1),this.addObject(this.debugLayer),this.mapSurface=new _.MapSurface(g,this.theater),this.addObject(this.mapSurface),this.mapBounds=new U.MapBounds(g),this.mapBounds.setVisible(!1),this.mapShroud&&(this.shroudLayer=new G.MapShroudLayer(this.mapShroud,this.imageFinder,this.camera),this.addObject(this.shroudLayer)),this.addObject(this.mapBounds),g=new V.ShpAggregator,this.terrainLayer=new W.MapSpriteBatchLayer("map_terrain_layer",[...this.rules.terrainRules.values()].filter(g=>!g.isAnimated&&this.art.hasObject(g.name,g.type)),()=>!1,this.theater,this.art,this.imageFinder,this.camera,this.lighting,g),this.addObject(this.terrainLayer),this.overlayLayer=new W.MapSpriteBatchLayer("map_overlay_layer",[...this.rules.overlayRules.values()].filter(g=>this.art.hasObject(g.name,g.type)&&!z.BridgeOverlayTypes.isBridge(this.rules.getOverlayId(g.name))),g=>g.rules.wall,this.theater,this.art,this.imageFinder,this.camera,this.lighting,g),this.addObject(this.overlayLayer),this.smudgeLayer=new W.MapSpriteBatchLayer("map_smudge_layer",[...this.rules.smudgeRules.values()].filter(g=>this.art.hasObject(g.name,g.type)),()=>!1,this.theater,this.art,this.imageFinder,this.camera,this.lighting,g),this.addObject(this.smudgeLayer),this.mapRadiation.onChange.subscribe(this.handleRadChange)}setShroud(g){g!==this.mapShroud&&(!g&&this.shroudLayer&&(this.removeObject(this.shroudLayer),this.shroudLayer.dispose(),this.shroudLayer=void 0),this.mapShroud=g,this.mapShroud&&(this.shroudLayer?this.shroudLayer.setShroud(this.mapShroud):(this.shroudLayer=new G.MapShroudLayer(this.mapShroud,this.imageFinder,this.camera),this.addObject(this.shroudLayer))))}addObject(g){this._objects.push(g),this.target&&(g.create3DObject(),this.target.add(g.get3DObject()))}removeObject(g){var P=this._objects.indexOf(g);-1!==P&&(this._objects.splice(P,1),this.target&&g.get3DObject()&&this.target.remove(g.get3DObject()))}create3DObject(){let g=this.get3DObject();if(!g){g=new THREE.Object3D,g.name="map",g.matrixAutoUpdate=!1,this.target=g;for(let P=0,I=this._objects.length;P<I;++P)this._objects[P].create3DObject(),g.add(this._objects[P].get3DObject())}}update(g,P){if(this.create3DObject(),this.debugWireframe.value!==this.lastDebugValue&&(this.lastDebugValue=this.debugWireframe.value,this.debugLayer.setVisible(this.debugWireframe.value),this.mapBounds.setVisible(this.debugWireframe.value)),this._objects.forEach(I=>I.update(g,P)),this.invalidatedRadTiles.size){for(var I of this.invalidatedRadTiles){var L,_=this.mapRadiation.getRadLevel(I);_?(L=Math.min(1,_/this.rules.radiation.radLevelMax),this.radTileLights.has(I)&&this.lighting.removeTileLight(I,this.radTileLights.get(I)),_=this.rules.radiation.radColor,L={intensity:this.rules.radiation.radLightFactor*L,red:_[0]/255*L,green:_[1]/255*L,blue:_[2]/255*L},this.lighting.addTileLight(I,L),this.radTileLights.set(I,L)):(this.lighting.removeTileLight(I,this.radTileLights.get(I)),this.radTileLights.delete(I))}this.lighting.forceUpdate([...this.invalidatedRadTiles]),this.invalidatedRadTiles.clear()}}updateLighting(g){this.tileLayer.updateLighting(g),this.terrainLayer.updateLighting(),this.overlayLayer.updateLighting(),this.smudgeLayer.updateLighting()}dispose(){this.mapRadiation.onChange.unsubscribe(this.handleRadChange),this.tileLayer.dispose(),this.debugLayer.dispose(),this.terrainLayer.dispose(),this.overlayLayer.dispose(),this.smudgeLayer.dispose(),this.shroudLayer?.dispose(),this.mapBounds.dispose(),this.mapSurface.dispose()}})}}}),System.register("engine/renderable/entity/map/MapShroudLayer",["game/Coords","engine/gfx/TextureUtils","engine/gfx/SpriteUtils","util/disposable/CompositeDisposable","engine/renderable/builder/ShpTextureAtlas","data/Palette","util/Color","game/map/MapShroud","engine/gfx/BufferGeometryUtils","engine/gfx/material/PaletteBasicMaterial","engine/Engine"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g}],execute:function(){Q=[[1,32],[4,33],[8,34],[2,35],[5,36],[12,37],[10,38],[3,39],[13,40],[14,41],[11,42],[7,43],[9,44],[6,45],[15,46]].reduce((g,P)=>(g[P[0]]=P[1],g),new Array(16).fill(void 0)),Y=[[24,16],[34,17],[50,18],[65,19],[97,20],[132,21],[152,22],[196,23],[18,24],[33,25],[68,26],[136,27],[26,28],[35,29],[69,30],[140,31]].reduce((g,P)=>(g[P[0]]=P[1],g),new Array(256).fill(void 0)),Z=[0,5,12,13,10,15,14,15,3,7,15,15,11,15,15,15],g("MapShroudLayer",class{constructor(g,P,I){this.shroud=g,this.imageFinder=P,this.camera=I,this.disposables=new U.CompositeDisposable,this.needsIncrementalUpdate=[],this.needsFullUpdate=!1,this.onShroudChange=g=>{"incremental"===g.type?this.needsIncrementalUpdate.push(...g.coords):this.needsFullUpdate=g.type},this.camera=I}get3DObject(){return this.target}create3DObject(){let g=this.get3DObject();g||(g=new THREE.Object3D,g.name="map_shroud_layer",g.matrixAutoUpdate=!1,this.target=g,this.createTileObjects(g),this.shroud.onChange.subscribe(this.onShroudChange),this.disposables.add(()=>this.shroud.onChange.unsubscribe(this.onShroudChange)))}setShroud(g){this.shroud.onChange.unsubscribe(this.onShroudChange),this.shroud=g,this.shroud.onChange.subscribe(this.onShroudChange),this.needsFullUpdate="full"}createTileObjects(g){var P=this.imageFinder.find($.Engine.shroudFileName.split(".")[0],!1);let I=(new G.ShpTextureAtlas).fromShpFile(P);this.disposables.add(I);let U=new V.Palette,z=[new W.Color(0,0,0),new W.Color(0,0,0)];for(let g=0;g<254;g++){var Q=Math.min(255,Math.floor(g/125*255));z.push(new W.Color(Q,Q,Q))}U.setColors(z),P=L.TextureUtils.textureFromPalette(U);let Y=[],Z=0;var X=this.shroud.getSize();for(let g=0;g<X.height;g++)for(let P=0;P<X.width;P++){var J={sx:P,sy:g},ee=this.getFrameNo(J);ee=this.createTileGeometry(J,I,ee);Y.push(ee),Z++}P=new q.PaletteBasicMaterial({map:I.getTexture(),palette:P,alphaTest:.01,flatShading:!0,transparent:!0,depthTest:!1,blending:THREE.MultiplyBlending});let te=K.BufferGeometryUtils.mergeBufferGeometries(Y);if(te.getAttribute("position").count!==_.SpriteUtils.VERTICES_PER_SPRITE*Z)throw new Error("Vertex count mismatch");this.uvAttribute=te.getAttribute("uv"),this.uvElemsPerPiece=this.uvAttribute.count*this.uvAttribute.itemSize/Z,this.uvLookup=new Float32Array(47*this.uvElemsPerPiece);for(let g=0;g<47;g++){let P=_.SpriteUtils.createSpriteGeometry(this.getTileGeometryOptions(I,g));this.uvLookup.set(P.getAttribute("uv").array,g*this.uvElemsPerPiece)}Y.forEach(g=>g.dispose());let re=new THREE.Mesh(te,P);re.renderOrder=999999,re.matrixAutoUpdate=!1,re.frustumCulled=!1,g.add(re),this.disposables.add(te,P)}createTileGeometry(g,P,L){var{rx:U,ry:G}=this.shroud.shroudCoordsToWorld(g),G=I.Coords.tile3dToWorld(U,G,0);let V=_.SpriteUtils.createSpriteGeometry(this.getTileGeometryOptions(P,L));return V.applyMatrix((new THREE.Matrix4).makeTranslation(G.x,G.y,G.z)),V}getTileGeometryOptions(g,P){return{texture:g.getTexture(),textureArea:g.getTextureArea(P),flat:!0,align:{x:0,y:-1},camera:this.camera,scale:I.Coords.ISO_WORLD_SCALE}}update(g){var P;this.needsFullUpdate&&("cover"===this.needsFullUpdate||"clear"===this.needsFullUpdate?this.toggleAllTiles("cover"===this.needsFullUpdate?z.ShroudType.Unexplored:z.ShroudType.Explored):(this.updateAllTiles(),this.needsIncrementalUpdate=[]),this.uvAttribute.needsUpdate=!0,this.needsFullUpdate=!1),this.needsIncrementalUpdate.length&&(P=this.extendToAdjacentTiles(this.needsIncrementalUpdate),this.updateTiles(P),this.uvAttribute.needsUpdate=!0,this.needsIncrementalUpdate.length=0)}extendToAdjacentTiles(g){let P=new Map;var I,L=this.shroud.getSize();for(I of g)for(let g=-1;g<=1;g++)for(let G=-1;G<=1;G++){var _=I.sx+g,U=I.sy+G;0<=_&&0<=U&&_<L.width&&U<L.height&&P.set(_+"_"+U,{sx:_,sy:U})}return[...P.values()]}updateTiles(g){var P,I=this.shroud.getSize();for(P of g){var L=P.sx+P.sy*I.width;this.updateTilePiece(L,this.getFrameNo(P))}}updateAllTiles(){var g=this.shroud.getSize();for(let L=0;L<g.height;L++)for(let _=0;_<g.width;_++){var P={sx:_,sy:L},I=P.sx+P.sy*g.width;this.updateTilePiece(I,this.getFrameNo(P))}}toggleAllTiles(g){var P=g===z.ShroudType.Unexplored?15:0,I=this.uvLookup.subarray(P*this.uvElemsPerPiece,(1+P)*this.uvElemsPerPiece);let L=this.uvAttribute.array;for(let g=0,_=(P=this.shroud.getSize()).width*P.height;g<_;g++)L.set(I,g*this.uvElemsPerPiece)}updateTilePiece(g,P){this.uvAttribute.array.set(this.uvLookup.subarray(P*this.uvElemsPerPiece,(P+1)*this.uvElemsPerPiece),g*this.uvElemsPerPiece)}getFrameNo(g){if(this.shroud.getShroudTypeByShroudCoords(g)===z.ShroudType.Unexplored)return 15;let P=0;this.hasShroudedNeighbour(g,0,-1)&&(P+=1),this.hasShroudedNeighbour(g,1,0)&&(P+=2),this.hasShroudedNeighbour(g,0,1)&&(P+=4),this.hasShroudedNeighbour(g,-1,0)&&(P+=8);let I=0;for(let P=-1;P<=1;P+=2)for(let L=-1;L<=1;L+=2)this.hasShroudedNeighbour(g,P,L)&&(I+=1<<P+1+(L+1>>1));if(0<I)if(0===P)P=Q[I];else{var L=I&~Z[P];if(0<L){if(void 0===(L=Y[L+(P<<4)]))throw new Error(`Missing mapped corner frame number for cornerValue "${I}",edgeFrameNo=`+P);P=L}}return P}hasShroudedNeighbour({sx:g,sy:P},I,L){return this.shroud.getShroudTypeByShroudCoords({sx:g+I,sy:P+L})===z.ShroudType.Unexplored}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/entity/map/MapSpriteBatchLayer",["game/Coords","engine/ImageFinder","engine/renderable/builder/BatchShpBuilder","engine/renderable/builder/ShpAggregator","engine/renderable/MapSpriteTranslation","engine/renderable/ShadowRenderable","util/typeGuard"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g}],execute:function(){g("MapSpriteBatchLayer",class{constructor(g,P,I,L,_,U,G,V,W){this.label=g,this.spriteUseDepth=I,this.theater=L,this.art=_,this.imageFinder=U,this.camera=G,this.lighting=V,this.shpAggregator=W,this.textureCache=new Map,this.batchShpSpecsByObject=new Map,this.batchShpBuilders=new Map,this.shadowBatchShpBuilders=[],this.batchedObjectRules=new Set(P),this.aggregatedImageData=this.createAggregatedShpFile(`agg_${g}.shp`)}get3DObject(){return this.target}create3DObject(){let g=this.get3DObject();g||(g=new THREE.Object3D,g.name=this.label,g.matrixAutoUpdate=!1,this.target=g)}createAggregatedShpFile(g){var P=[...this.batchedObjectRules.values()].map(g=>{var P=this.art.getObject(g.name,g.type);let I;try{I=this.imageFinder.findByObjectArt(P)}catch(g){if(g instanceof L.ImageFinder.MissingImageError)return;throw g}return U.ShpAggregator.getShpFrameInfo(I,P.hasShadow)}).filter(W.isNotNullOrUndefined);return this.shpAggregator.aggregate(P,g)}update(g){}updateLighting(){this.batchShpSpecsByObject.forEach((g,P)=>{g.main.lightMult?.copy(this.lighting.compute(P.art.lightingType,P.tile))}),[...this.batchShpBuilders.values()].flat().forEach(g=>g.updateLighting())}shouldBeBatched(g){return this.batchedObjectRules.has(g.rules)}getBatchKey(g){return g.art.paletteType+"_"+g.art.customPaletteName}addObject(g){var P=this.getBatchKey(g);let L=this.batchShpBuilders.get(P);L||(L=[],this.batchShpBuilders.set(P,L));let U,G=L.find(g=>!g.isFull());if(!G){if(!this.get3DObject())throw new Error("Not implemented");{var W=this.theater.getPalette(g.art.paletteType,g.art.customPaletteName);let P=new _.BatchShpBuilder(this.aggregatedImageData.file,W,this.camera,this.textureCache,void 0,void 0,void 0,I.Coords.ISO_WORLD_SCALE);L.push(P),this.get3DObject().add(P.build()),G=P}}if(W=this.buildBatchShpSpec(g,this.aggregatedImageData),G.add(W),g.art.hasShadow){let g=this.shadowBatchShpBuilders.find(g=>!g.isFull());if(!g){if(!this.get3DObject())throw new Error("Not implemented");{let P=new _.BatchShpBuilder(this.aggregatedImageData.file,V.ShadowRenderable.getOrCreateShadowPalette(),this.camera,this.textureCache,.5,!0,void 0,I.Coords.ISO_WORLD_SCALE);this.shadowBatchShpBuilders.push(P),this.get3DObject().add(P.build()),g=P}}U=this.buildShadowBatchShpSpec(W,this.aggregatedImageData),g.add(U)}this.batchShpSpecsByObject.set(g,{main:W,shadow:U})}buildBatchShpSpec(g,P){var I=g.getFoundation();let L=new G.MapSpriteTranslation(I.width,I.height),_=g.position.worldPosition.clone(),{spriteOffset:U,anchorPointWorld:V}=L.compute();_.x+=V.x,_.z+=V.y;var W=this.imageFinder.findByObjectArt(g.art);if(void 0===(I=P.imageIndexes.get(W)))throw new Error("SHP file not found in aggregated image data");return{shpFile:W,frameNo:I,depth:this.spriteUseDepth(g),flat:g.art.flat,position:_,offset:U.clone().add(g.art.getDrawOffset()),lightMult:this.lighting.compute(g.art.lightingType,g.tile)}}buildShadowBatchShpSpec(g,P){var I=P.imageIndexes.get(g.shpFile);if(void 0===I)throw new Error("SHP file not found in aggregated image data");return{...g,position:g.position.clone().add(new THREE.Vector3(0,.1,0)),flat:!0,frameNo:I+P.file.numImages/2,lightMult:void 0}}removeObject(g){const P=this.batchShpSpecsByObject.get(g);if(P){var I=this.getBatchKey(g);let L=this.batchShpBuilders.get(I),_=L?.find(g=>g.has(P.main));if(_){if(_.remove(P.main),_.isEmpty()&&1<L.length&&(this.get3DObject()?.remove(_.build()),_.dispose(),L?.splice(L.indexOf(_),1)),P.shadow){let g=this.shadowBatchShpBuilders.find(g=>g.has(P.shadow));g?.remove(P.shadow),g?.isEmpty()&&1<this.shadowBatchShpBuilders.length&&(this.get3DObject()?.remove(g.build()),g.dispose(),this.shadowBatchShpBuilders.splice(this.shadowBatchShpBuilders.indexOf(g),1))}this.batchShpSpecsByObject.delete(g)}}}hasObject(g){return this.batchShpSpecsByObject.has(g)}getObjectFrameCount(g){var P=this.batchShpSpecsByObject.get(g);if(!P)throw new Error(`Batch SHP spec for object "${g.name}" not found`);return P.main.shpFile.numImages*(P.shadow?.5:1)}setObjectFrame(g,P){const I=this.batchShpSpecsByObject.get(g);if(!I)throw new Error(`Batch SHP spec for object "${g.name}" not found`);if(!(P>=I.main.shpFile.numImages*(I.shadow?.5:1))){var L=this.aggregatedImageData.imageIndexes.get(I.main.shpFile);I.main.frameNo=L+P,I.shadow&&(I.shadow.frameNo=I.main.frameNo+this.aggregatedImageData.file.numImages/2),L=this.getBatchKey(g);let _=this.batchShpBuilders.get(L)?.find(g=>g.has(I.main));if(_?.update(I.main),I.shadow){let g=this.shadowBatchShpBuilders.find(g=>g.has(I.shadow));g?.update(I.shadow)}}}dispose(){[...this.batchShpBuilders.values(),...this.shadowBatchShpBuilders].flat().forEach(g=>g.dispose()),[...this.textureCache.values()].forEach(g=>g.dispose()),this.textureCache.clear()}})}}}),System.register("engine/renderable/entity/map/MapSurface",["game/Coords","game/theater/rampHeights","engine/gfx/BufferGeometryUtils","util/disposable/CompositeDisposable"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("MAGIC_OFFSET",.05),g("MapSurface",class{constructor(g,P){this.visible=!0,this.disposables=new U.CompositeDisposable,this.map=g,this.theater=P}get3DObject(){return this.target}create3DObject(){let g=this.get3DObject();g||(g=this.createObject(),g.name="map_surface_shadow",g.matrixAutoUpdate=!1,g.visible=this.visible,this.target=g)}update(){}setVisible(g){this.visible=g,this.target&&(this.target.visible=g)}createObject(){let g=[];this.map.tiles.forEach(P=>{var L=I.Coords.tile3dToWorld(P.rx,P.ry,P.z);let _=this.createRectGeometry(P.rampType);_.applyMatrix((new THREE.Matrix4).makeTranslation(L.x,L.y+.05,L.z)),g.push(_)});var P=_.BufferGeometryUtils.mergeBufferGeometries(g);let L=new THREE.ShadowMaterial;L.transparent=!0,L.opacity=.5;let U=new THREE.Mesh(P,L);return U.receiveShadow=!0,U.renderOrder=5,U.frustumCulled=!1,this.disposables.add(P,L),U}createRectGeometry(g){var P=I.Coords.getWorldTileSize(),_=L.rampHeights[g];let U=new THREE.BufferGeometry;return P=new Float32Array([0,I.Coords.tileHeightToWorld(_[0]),P,P,I.Coords.tileHeightToWorld(_[3]),P,0,I.Coords.tileHeightToWorld(_[1]),0,P,I.Coords.tileHeightToWorld(_[2]),0]),_=new Uint16Array([0,1,2,3,2,1]),U.addAttribute("position",new THREE.BufferAttribute(P,3)),U.setIndex(new THREE.BufferAttribute(_,1)),U}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/entity/map/MapTileLayer",["game/Coords","engine/gfx/TextureUtils","engine/gfx/drawable/TmpDrawable","engine/gfx/TextureAtlas","engine/gfx/SpriteUtils","engine/renderable/entity/Anim","engine/type/LightingType","util/disposable/CompositeDisposable","engine/gfx/BufferGeometryUtils","engine/gfx/material/PaletteBasicMaterial","util/math"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g}],execute:function(){g("MapTileLayer",class{constructor(g,P,I,L,_,U,G,V,W,K){this.theater=P,this.art=I,this.imageFinder=L,this.camera=_,this.debugFrame=U,this.gameSpeed=G,this.worldSound=V,this.lighting=W,this.useSpriteBatching=K,this.tileIndexes=new Map,this.tileAnimLightMultsByTile=new Map,this.disposables=new z.CompositeDisposable,this.theater=P,this.camera=_,this.allTiles=g.tiles.getAll()}get3DObject(){return this.target}create3DObject(){let g=this.get3DObject();g||(g=new THREE.Object3D,g.name="map_tile_layer",g.matrixAutoUpdate=!1,this.target=g,this.createTileObjects(g))}createTileObjects(g){let P=new Map,z=new Map;var Q,Y=this.theater.isoPalette,Z=L.TextureUtils.textureFromPalette(Y);let X=this.theater.tileSets;for(Q of this.allTiles){var J=Q.tileNum;let g=X.getTile(J);if(!g)return;var ee=g.getTmpFile(Q.subTile,$.getRandomInt);if(!ee||Q.subTile>=ee.images.length)return;var te=ee.images[Q.subTile];z.set(Q,te),(J=P.get(te))||(J=(new _.TmpDrawable).draw(te,ee.blockWidth,ee.blockHeight),P.set(te,J))}let re=new U.TextureAtlas,se=[];P.forEach(g=>{se.push(g)}),re.pack(se),this.disposables.add(re);let ae=[],ne=[];for(let g=0,L=this.allTiles.length;g<L;g++){var oe,le=this.allTiles[g];if(!(oe=z.get(le)))throw new Error(`Missing tmp image for tile rx,ry=${le.rx},`+le.ry);let L=0,_=0;oe.hasExtraData&&(L+=Math.max(0,oe.x-oe.extraX),_+=Math.max(0,oe.y-oe.extraY));var ce=I.Coords.tile3dToWorld(le.rx,le.ry,le.z),he=P.get(oe);let U=G.SpriteUtils.createSpriteGeometry({texture:re.getTexture(),textureArea:re.getImageRect(he),align:{x:0,y:-1},offset:{x:-L,y:-_},camera:this.camera,scale:I.Coords.ISO_WORLD_SCALE});U.applyMatrix((new THREE.Matrix4).makeTranslation(ce.x,ce.y,ce.z)),ae.push(U);var{x:oe,y:he,z:ce}=this.lighting.compute(W.LightingType.Full,le);ne.push(oe,he,ce),this.tileIndexes.set(le,g)}var ue=new q.PaletteBasicMaterial({map:re.getTexture(),palette:Z,alphaTest:.5,flatShading:!0,useVertexColorMult:!0});let de=K.BufferGeometryUtils.mergeBufferGeometries(ae);if((Z=de.getAttribute("position").count)!==G.SpriteUtils.VERTICES_PER_SPRITE*ne.length/3)throw new Error("Vertex count mismatch");Z=new Float32Array(4*Z),this.updateColorMultBuffer(ne,Z);var ge;Z=new THREE.BufferAttribute(Z,4);de.addAttribute("vertexColorMult",Z),this.colorMultAttribute=Z,ae.forEach(g=>g.dispose());let pe=new THREE.Mesh(de,ue);pe.matrixAutoUpdate=!1,pe.frustumCulled=!1,g.add(pe),this.disposables.add(de,ue);let me=[];for(ge of this.allTiles){var fe=ge.tileNum;let P=X.getTile(fe);if(!P)return;var ye=P.getAnimation();if(ye&&ge.subTile===ye.subTile){fe=this.lighting.compute(W.LightingType.Full,ge).addScalar(-1),this.tileAnimLightMultsByTile.set(ge,fe);let P=new V.Anim(ye.name,this.art.getAnimation(ye.name),{x:ye.offsetX,y:ye.offsetY+(I.Coords.ISO_TILE_SIZE+1)/2},this.imageFinder,this.theater,this.camera,this.debugFrame,this.gameSpeed,this.useSpriteBatching,fe,this.worldSound,Y);fe=I.Coords.tile3dToWorld(ge.rx,ge.ry,ge.z),P.setPosition(fe),P.create3DObject(),me.push(P),g.add(P.get3DObject()),this.disposables.add(P)}}this.anims=me}update(g){for(var P of this.anims)P.update(g)}updateLighting(g){if(g){for(var P of g){var I,L,_,U=this.tileIndexes.get(P);void 0!==U&&(({x:I,y:L,z:_}=this.lighting.compute(W.LightingType.Full,P)),this.updateColorMultBufferAtIndex(U,I,L,_,this.colorMultAttribute.array)),this.tileAnimLightMultsByTile.get(P)?.copy(this.lighting.compute(W.LightingType.Full,P))}this.colorMultAttribute.needsUpdate=!0}else{let g=[];for(var G of this.allTiles){var{x:V,y:z,z:G}=this.lighting.compute(W.LightingType.Full,G);g.push(V,z,G)}this.updateColorMultBuffer(g,this.colorMultAttribute.array),this.colorMultAttribute.needsUpdate=!0,this.tileAnimLightMultsByTile.forEach((g,P)=>{g.copy(this.lighting.compute(W.LightingType.Full,P))})}}updateColorMultBuffer(g,P){var I=G.SpriteUtils.VERTICES_PER_SPRITE,L=g.length/3;let _=0;for(let G=0;G<L;G++){var U=g[3*G],V=g[3*G+1],W=g[3*G+2];for(let g=0;g<I;g++)P[_++]=U,P[_++]=V,P[_++]=W,P[_++]=1}}updateColorMultBufferAtIndex(g,P,I,L,_){var U=G.SpriteUtils.VERTICES_PER_SPRITE;let V=g*U*4;for(let g=0;g<U;g++)_[V++]=P,_[V++]=I,_[V++]=L,_[V++]=1}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/entity/map/MapTileLayerDebug",["game/Coords","game/theater/rampHeights","engine/gfx/SpriteUtils","game/type/SpeedType","util/disposable/CompositeDisposable","engine/gfx/BufferGeometryUtils","engine/IsoCoords"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g}],execute:function(){g("MapTileLayerDebug",class f{constructor(g,P,I){this._textureTilesNo=20,this.visible=!0,this.needsLinesUpdate=!1,this.disposables=new G.CompositeDisposable,this.handleTileOccupationChanged=()=>this.needsLinesUpdate=!0,this.map=g,this.theater=P,this.camera=I}get3DObject(){return this.target}create3DObject(){let g=this.get3DObject();if(!g){if(g=new THREE.Object3D,g.name="map_tile_layer_debug",g.visible=this.visible,g.matrixAutoUpdate=!1,this.visible){if(!this.tileOverlay){let P=this.tileOverlay=this.createTileOverlay();P.matrixAutoUpdate=!1,P.frustumCulled=!1,g.add(P)}this.setupLines(g)}this.target=g}}update(){this.needsLinesUpdate&&this.visible&&(this.needsLinesUpdate=!1,this.destroyLines(),this.setupLines(this.target))}setVisible(g){if(g!==this.visible&&(this.visible=g,this.target))if(this.target.visible=g,this.visible){if(!this.tileOverlay){let g=this.tileOverlay=this.createTileOverlay();g.matrixAutoUpdate=!1,this.target.add(g)}this.setupLines(this.target)}else this.destroyLines()}setupLines(g){this.lines=new THREE.Object3D,this.lines.matrixAutoUpdate=!1,this.lines.add(this.createConnectivityLines(U.SpeedType.Foot,!1,65280));let P=this.createConnectivityLines(U.SpeedType.Float,!1,255);P.position.y=1,P.updateMatrix(),this.lines.add(P),g.add(this.lines),this.map.tileOccupation.onChange.subscribe(this.handleTileOccupationChanged)}destroyLines(){this.lines&&(this.target.remove(this.lines),this.lines=void 0,this.map.tileOccupation.onChange.unsubscribe(this.handleTileOccupationChanged))}createTileOverlay(){let g=[];this.map.tiles.forEach(P=>{var L=I.Coords.tile3dToWorld(P.rx,P.ry,P.z+1),U=W.IsoCoords.getScreenTileSize();let G=_.SpriteUtils.createSpriteGeometry({texture:this.getTileTexture(),textureArea:{x:P.z*U.width,y:2*P.rampType*U.height,width:U.width,height:2*U.height},align:{x:0,y:-1},camera:this.camera,scale:I.Coords.ISO_WORLD_SCALE});G.applyMatrix((new THREE.Matrix4).makeTranslation(L.x,L.y,L.z)),g.push(G)});var P=V.BufferGeometryUtils.mergeBufferGeometries(g),L=new THREE.MeshBasicMaterial({map:this.getTileTexture(),alphaTest:.5,transparent:!0,opacity:.7,flatShading:!0});return this.disposables.add(P,L),new THREE.Mesh(P,L)}getTileTexture(){let g=f.textureCache;if(!g){var P=W.IsoCoords.getScreenTileSize(),_=this._textureTilesNo;let q=document.createElement("canvas"),$=q.getContext("2d");if(!$)throw new Error("Could not acquire canvas 2d context");q.width=P.width*_,q.height=2*P.height*L.rampHeights.length;let Q=W.IsoCoords.tileToScreen(0,0);Q.x+=-P.width/2;var U=I.Coords.ISO_TILE_SIZE/2;for(let g=0;g<_;++g)for(let I=0;I<L.rampHeights.length;++I){var G=L.rampHeights[I],V=[[0,1],[0,0],[1,0],[1,1]];let _=16711680-(g<<11)-(g<<7);$.beginPath();var z=W.IsoCoords.tileToScreen.apply(this,V[0]);$.moveTo(-Q.x+z.x+g*P.width,-Q.y+z.y+(1-G[0])*U+2*I*P.height);for(let L=1;L<V.length;++L){var K=W.IsoCoords.tileToScreen.apply(this,V[L]);$.lineTo(-Q.x+K.x+g*P.width,-Q.y+K.y+(1-G[L])*U+2*I*P.height)}$.closePath(),$.lineWidth=1,$.fillStyle="#"+_.toString(16),$.fill(),$.strokeStyle="#"+(16777215-_).toString(16),$.stroke()}g=new THREE.Texture(q),g.minFilter=THREE.NearestFilter,g.magFilter=THREE.NearestFilter,g.needsUpdate=!0,f.textureCache=g}return g}createConnectivityLines(g,P,L){let _=this.map.terrain.computePassabilityGraph(g,P),U=new THREE.Geometry,G=new Set;_.forEachNode(g=>{let P=g;g.neighbors.forEach(g=>{var L=g,_=P.id+"->"+L.id;G.has(_)||(G.add(_),U.vertices.push(I.Coords.tile3dToWorld(P.data.tile.rx+.5,P.data.tile.ry+.5,P.data.tile.z+(P.data.onBridge?.tileElevation??0)),I.Coords.tile3dToWorld(L.data.tile.rx+.5,L.data.tile.ry+.5,L.data.tile.z+(L.data.onBridge?.tileElevation??0))))})});var V=new THREE.LineBasicMaterial({color:L,transparent:!0,depthTest:!1,depthWrite:!1});let W=new THREE.LineSegments(U,V);return W.matrixAutoUpdate=!1,this.disposables.add(U,V),W}onRemove(){this.lines&&this.destroyLines()}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/entity/map/MinimapModel",["game/map/MapShroud"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=new THREE.Color("rgb(173, 170, 132)"),_=new Map([["CAKRMW",new THREE.Color("rgb(107, 69, 49)")],["CAFNCW",new THREE.Color(16777215)],["CAFNCB",new THREE.Color(0)],["GASAND",new THREE.Color("rgb(82, 77, 57)")]]),U=new THREE.Color("rgb(90, 89, 82)"),G=new THREE.Color(0),V=new THREE.Color("rgb(173, 170, 132)"),W=new THREE.Color(0),g("MinimapModel",class{constructor(g,P,I,L,_,U){this.tiles=g,this.tileOccupation=P,this.shroud=I,this.localPlayer=L,this.alliances=_,this.paradropRules=U;var G=this.tiles.getMapSize();this.stride=G.width,this.tileColors=new Uint32Array(G.width*G.height),this.aboveShroudTiles=new Uint8Array(G.width*G.height),this.tileWithTechnos=new Uint8Array(G.width*G.height)}computeAllColors(){this.updateColors(this.tiles.getAll())}updateColors(g){for(var P of g){let g,K,q=-1;for(var I of this.tileOccupation.getObjectsOnTile(P)){var z;!((I.isTechno()||I.isOverlay()||I.isTerrain())&&!I.radarInvisible||I.isOverlay()&&I.isBridge()||I.isBuilding()&&!I.rules.invisibleInGame&&(!I.radarInvisible||I.rules.canBeOccupied&&I.owner.isCombatant()))||(z=4*Number(I.isTechno())+2*Number(I.isAircraft())+Number(I.name!==this.paradropRules.paradropPlane))>q&&(q=z,g=I)}if(g)if((g.isTechno()||g.isOverlay())&&g.rules.wall)K=_.get(g.name)??U;else if(g.isBuilding()&&g.isDestroyed&&g.rules.leaveRubble)K=G;else if(g.isTechno())if(g.cloakableTrait?.isCloaked()&&this.localPlayer&&!this.alliances.haveSharedIntel(this.localPlayer,g.owner))K=void 0;else{let P=(g.isInfantry()||g.isVehicle())&&g.disguiseTrait?.getDisguise();K=this.localPlayer&&P&&!this.alliances.haveSharedIntel(this.localPlayer,g.owner)&&!this.localPlayer.sharedDetectDisguiseTrait?.has(g)?P.owner?new THREE.Color(P.owner.color.asHex()):L:new THREE.Color(g.owner.color.asHex())}else if(g.isTerrain())K=L;else{if(!g.isOverlay())return;K=g.isTiberium()?V:W}K=K||this.tiles.getTileRadarColor(P),P=P.rx+P.ry*this.stride,this.tileColors[P]=K.getHex(),this.aboveShroudTiles[P]=g?.name===this.paradropRules.paradropPlane?1:0,this.tileWithTechnos[P]=g?.isTechno()?1:0}}getTileColor(g){var P=g.rx+g.ry*this.stride;if(this.shroud?.getShroudType(g)===I.ShroudType.Unexplored&&!this.aboveShroudTiles[P])return"#000000";let L=new THREE.Color(this.tileColors[P]);return this.shroud?.isFlagged(g,I.ShroudFlag.Darken)&&!this.tileWithTechnos[P]&&L.multiplyScalar(.35),"#"+L.getHexString()}})}}}),System.register("engine/renderable/entity/map/MinimapRenderer",["game/Coords"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("MinimapRenderer",class{constructor(g,P,I,L,_){this.map=g,this.minimapModel=P,this.borderColor=L,this.canvasRenderScale=_;var U=this.map.mapBounds.getRawLocalSize();this.dxySize={x:2*U.x,y:2*U.y+4,width:2*U.width,height:2*U.height+8},U=this.dxySize.height/this.dxySize.width,this.canvasSize=this.computeCanvasSize(I,U)}computeCanvasSize(g,P){var I=g.width,L=g.height;let _;return _=L/I<=P?{width:Math.floor(L/P),height:L}:{width:I,height:Math.floor(I*P)},_}renderFull(){if(this.canvas)this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvasRenderScale*this.canvasSize.width,this.canvasRenderScale*this.canvasSize.height);else{let g=this.canvas=document.createElement("canvas");g.width=this.canvasRenderScale*this.canvasSize.width,g.height=this.canvasRenderScale*this.canvasSize.height,(this.ctx=g.getContext("2d",{alpha:!1})).translate(.5,.5)}return this.renderTiles(this.map.tiles.getAll(),!0),this.canvas}renderIncremental(g){let P=new Set(g);for(var I of g){this.map.tiles.getAllNeighbourTiles(I).forEach(g=>P.add(g))}this.renderTiles(P)}renderTiles(g,P=!1){var L,_=this.canvasSize.width/this.dxySize.width/I.Coords.COS_ISO_CAMERA_BETA;const U=this.ctx;if(!U)throw new Error("Must do a full render before re-rendering any individual tiles.");for(L of(U.imageSmoothingEnabled=!1,U.save(),U.rotate(I.Coords.ISO_CAMERA_BETA),U.scale(_,_),g)){var G,V=this.minimapModel.getTileColor(L);!V||P&&"#000000"===V||(U.fillStyle=V,({x:G,y:V}=this.tileToLocalRxyOrigin(L)),U.fillRect(this.canvasRenderScale*G,this.canvasRenderScale*V,this.canvasRenderScale+.5,this.canvasRenderScale+.5))}U.restore(),U.strokeStyle=this.borderColor,U.lineWidth=this.canvasRenderScale,U.strokeRect(0,0,U.canvas.width-this.canvasRenderScale,U.canvas.height-this.canvasRenderScale)}tileToLocalRxyOrigin(g){var P=this.dxyToLocalRxy(this.dxySize.x,this.dxySize.y);return{x:g.rx-P.x,y:g.ry-this.map.mapBounds.getFullSize().width/2-P.y}}dxyToLocalRxy(g,P){return{x:(g+P)/2,y:(P-g)/2}}dxyToCanvas(g,P){var I=this.canvasSize.width/this.dxySize.width;return{x:(g-this.dxySize.x)*I,y:(P-this.dxySize.y)*I}}canvasToDxy(g,P){var I=this.canvasSize.width/this.dxySize.width;return{x:g/I+this.dxySize.x,y:P/I+this.dxySize.y}}})}}}),System.register("engine/renderable/entity/Overlay",["data/ShpFile","game/Coords","engine/renderable/WithPosition","engine/gfx/DebugUtils","engine/renderable/MapSpriteTranslation","engine/renderable/ShpRenderable","util/math","game/map/BridgeOverlayTypes","engine/type/ObjectType","game/gameobject/common/DeathType","engine/renderable/entity/BoxIntersectObject3D","engine/gfx/MathUtils","engine/renderable/entity/map/MapSurface","game/map/wallTypes"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g}],execute:function(){g("Overlay",class{constructor(g,P,I,L,_,U,G,V,W,z,K){this.gameObject=g,this.rules=P,this.art=I,this.imageFinder=L,this.palette=_,this.camera=U,this.lighting=G,this.debugFrame=V,this.bridgeImageCache=W,this.mapOverlayLayer=z,this.useSpriteBatching=K,this.isInvisible=!1,this.objectRules=g.rules,this.objectArt=g.art,this.label="overlay_"+this.objectRules.name,this.init()}init(){this.withPosition=new _.WithPosition,this.extraLight=new THREE.Vector3,this.updateLighting()}updateLighting(){var g=this.objectArt.lightingType;this.extraLight.copy(this.lighting.compute(g,this.gameObject.tile,this.gameObject.isHighBridge()?4:0)).addScalar(-1)}get3DObject(){return this.target}create3DObject(){let g=this.get3DObject();g||(g=new THREE.Object3D,g.name=this.label,g.userData.id=this.gameObject.id,this.target=g,g.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(g))}update(g){var P,I;this.isInvisible||(I=!!this.gameObject.healthTrait&&this.gameObject.healthTrait.health<=100*this.rules.audioVisual.conditionYellow,(P=1e5*this.gameObject.overlayId+10*this.gameObject.value+Number(I))!==this.lastOverlayHash&&(this.lastOverlayHash=P,I=this.computeFrame(I),this.mainRenderable?I<this.mainRenderable.frameCount&&this.mainRenderable.setFrame(I):this.mapOverlayLayer.setObjectFrame(this.gameObject,I)))}computeFrame(g){let P=this.gameObject,I=P.value;return P.isBridge()?0===I&&(I=W.getRandomInt(0,3)):P.wallTrait&&g&&(I+=(this.mainRenderable?this.mainRenderable.frameCount:this.mapOverlayLayer.getObjectFrameCount(this.gameObject))<Z.wallTypes.length?1:Z.wallTypes.length),I}setPosition(g){this.withPosition.setPosition(g.x,g.y,g.z)}getPosition(){return this.withPosition.getPosition()}getIntersectTarget(){return this.intersectTarget}getUiName(){return this.gameObject.getUiName()}createObjects(g){var P=this.gameObject.getFoundation();if(this.debugFrame.value&&(_=this.createWireframe(P,1),g.add(_)),this.objectRules.isRubble||this.gameObject.isBridgePlaceholder())this.isInvisible=!0;else{var I=this.gameObject.isBridge()||this.gameObject.isTiberium()||this.gameObject.rules.wall;if(this.mapOverlayLayer?.shouldBeBatched(this.gameObject)){if(this.mapOverlayLayer.addObject(this.gameObject),I){let I=new $.BoxIntersectObject3D(new THREE.Vector3(1,0,1).multiplyScalar(L.Coords.LEPTONS_PER_TILE));I.position.add(new THREE.Vector3(P.width/2,0,P.height/2).multiplyScalar(L.Coords.LEPTONS_PER_TILE)),I.matrixAutoUpdate=!1,I.updateMatrix(),g.add(I),this.intersectTarget=I}}else{let U=new THREE.Object3D;U.matrixAutoUpdate=!1;let V=new G.MapSpriteTranslation(P.width,P.height),{spriteOffset:W,anchorPointWorld:K}=V.compute();var _=W.clone().add(this.objectArt.getDrawOffset());let q;if(this.gameObject.isLowBridge()){P=z.BridgeOverlayTypes.getOverlayBridgeType(this.gameObject.overlayId);let g=this.bridgeImageCache.get(P);g||(g=this.buildVirtualBridgeFile(P),this.bridgeImageCache.set(P,g)),q=g}else q=this.imageFinder.findByObjectArt(this.objectArt);let $=this.mainRenderable=this.createMainObject(q,_);if($.create3DObject(),U.add($.get3DObject()),I&&$&&(this.intersectTarget=$.getShapeMesh()),_=L.Coords.getWorldTileSize(),U.position.x=K.x,U.position.z=K.y,I=this.gameObject.isXBridge(),this.gameObject.isBridge()&&(U.position.x+=_/2,U.position.z+=_/2,U.position.x+=I?0:_,U.position.z+=I?_:0),this.gameObject.isHighBridge()){U.position.x-=+L.Coords.ISO_WORLD_SCALE,U.position.z-=+L.Coords.ISO_WORLD_SCALE,U.position.x+=_+(I?.5*_:0),U.position.z+=_+(I?.5*_:0);let P=$.getShadowMesh();P&&(Q.MathUtils.translateTowardsCamera(P,this.camera,(Y.MAGIC_OFFSET+.05)*L.Coords.ISO_WORLD_SCALE),P.updateMatrix()),_=this.createBridgeShadowSurface(),g.add(_)}U.updateMatrix(),g.add(U)}}}buildVirtualBridgeFile(g){var P=g===z.OverlayBridgeType.Concrete?z.BridgeOverlayTypes.minLowBridgeConcreteId:z.BridgeOverlayTypes.minLowBridgeWoodId,L=g===z.OverlayBridgeType.Concrete?z.BridgeOverlayTypes.maxLowBridgeConcreteId:z.BridgeOverlayTypes.maxLowBridgeWoodId;let _=new I.ShpFile;_.filename="agg_"+this.gameObject.name+".shp";for(let g=P;g<=L;g++){var U=this.rules.getOverlay(this.rules.getOverlayName(g));U=this.art.getObject(U.name,K.ObjectType.Overlay);let P=this.imageFinder.findByObjectArt(U);_.width||(_.width=P.width,_.height=P.height),_.addImage(P.getImage(1))}return _}createBridgeShadowSurface(){var g=(P=this.gameObject.getFoundation()).width*L.Coords.getWorldTileSize(),P=P.height*L.Coords.getWorldTileSize();let I=new THREE.PlaneGeometry(g,P);I.applyMatrix((new THREE.Matrix4).makeTranslation(g/2,Y.MAGIC_OFFSET,P/2).multiply((new THREE.Matrix4).makeRotationX(-Math.PI/2)));let _=new THREE.ShadowMaterial;_.transparent=!0,_.opacity=.5;let U=new THREE.Mesh(I,_);return U.receiveShadow=!0,U.renderOrder=5,U}createWireframe(g,P){let I=U.DebugUtils.createWireframe(g,P);var _=this.gameObject.isBridge();return I.position.y+=_?L.Coords.tileHeightToWorld(-1):0,I}createMainObject(g,P){var I=this.objectRules.wall,L=this.gameObject.isHighBridge()?4:0;let _=V.ShpRenderable.factory(g,this.palette,this.camera,P,this.objectArt.hasShadow&&!this.gameObject.isLowBridge(),L,I);return _.setBatched(this.useSpriteBatching),this.useSpriteBatching&&_.setBatchPalettes([this.palette]),_.setFlat(this.objectArt.flat),_.setExtraLight(this.extraLight),_}onRemove(g){if(this.mapOverlayLayer?.hasObject(this.gameObject)&&this.mapOverlayLayer.removeObject(this.gameObject),this.gameObject.isDestroyed&&(this.gameObject.deathType===q.DeathType.Demolish||this.gameObject.isHighBridge())){var P=this.gameObject.getFoundation(),I=this.rules.audioVisual.bridgeExplosions;for(let U=0;U<P.width;U++)for(let G=0;G<P.height;G++){var _=I[W.getRandomInt(0,I.length-1)];g.createTransientAnim(_,g=>{g.setPosition(L.Coords.tile3dToWorld(U,G,0).add(this.withPosition.getPosition()))})}}}dispose(){this.mainRenderable?.dispose()}})}}}),System.register("engine/renderable/entity/PipOverlay",["engine/gfx/TextureAtlas","data/Bitmap","engine/gfx/SpriteUtils","game/Coords","engine/gfx/TextureUtils","game/gameobject/selection/SelectionLevel","game/type/PipColor","util/disposable/CompositeDisposable","engine/gfx/OverlayUtils","engine/renderable/fx/RallyPointFx","engine/renderable/entity/unit/FlyerHelperMode","game/gameobject/unit/ZoneType","engine/gfx/BufferGeometryUtils","engine/gfx/material/PaletteBasicMaterial","engine/gfx/batch/BatchedMesh","game/gameobject/unit/HealthLevel","engine/renderable/entity/unit/DebugLabel","engine/Engine","engine/EngineType","gui/screen/game/TooltipTextResolver"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){ce=g}],execute:function(){se={width:8,height:11},ae=1,ne={0:V.SelectionLevel.Hover,2:V.SelectionLevel.Selected,1:V.SelectionLevel.Hover,3:V.SelectionLevel.Hover,4:V.SelectionLevel.Selected,5:V.SelectionLevel.Selected},oe=(new Map).set(re.EngineType.RedAlert2,(new Map).set(J.HealthLevel.Green,15).set(J.HealthLevel.Yellow,16).set(J.HealthLevel.Red,17)).set(re.EngineType.YurisRevenge,(new Map).set(J.HealthLevel.Green,16).set(J.HealthLevel.Yellow,17).set(J.HealthLevel.Red,18)),g("PipOverlay",le=class A{static clearCaches(){A.atlasCache?.dispose(),A.atlasCache=void 0,A.atlasImageHandles.clear(),[...A.unitHealthTextures.values()].forEach(g=>g.dispose()),A.unitHealthTextures.clear(),A.unitHealthMaterials.forEach(g=>g.dispose()),A.unitHealthMaterials.clear(),[...A.controlGroupTextures.values()].forEach(g=>g.dispose()),A.controlGroupTextures.clear(),A.controlGroupMaterials.forEach(g=>g.dispose()),A.controlGroupMaterials.clear(),[...A.primaryFactoryTextures.values()].forEach(g=>g.dispose()),A.primaryFactoryTextures.clear(),A.primaryFactoryMaterials.forEach(g=>g.dispose()),A.primaryFactoryMaterials.clear()}constructor(g,P,I,L,_,U,G,V,W,K,q,$,Q,Y,Z,X,J,ee){this.paradropRules=g,this.audioVisualRules=P,this.gameObject=I,this.viewer=L,this.alliances=_,this.selectionModel=U,this.imageFinder=G,this.palette=V,this.camera=W,this.strings=K,this.flyerHelperOpt=q,this.hiddenObjectsOpt=$,this.debugTextEnabled=Q,this.persistentHoverTags=Y,this.animFactory=Z,this.useSpriteBatching=X,this.useMeshInstancing=J,this.mapRenderable=ee,this.lastPrimaryFactory=!1,this.invalidatedElements=[],this.disposables=new z.CompositeDisposable}create3DObject(){let g=this.rootObj;if(!g){var P;if(g=new THREE.Object3D,g.name="pip_overlay",g.matrixAutoUpdate=!1,A.atlasCache||(P=this.initTexture(),A.atlasCache=P,[...A.atlasImageHandles.keys()].forEach(g=>{var P=_.SpriteUtils.createSpriteGeometry(this.buildSpriteGeometry(g));A.geometries.set(g,P)}),A.material=new Z.PaletteBasicMaterial({map:A.atlasCache.getTexture(),palette:G.TextureUtils.textureFromPalette(this.palette),alphaTest:.5,flatShading:!0,transparent:!0,depthTest:!1})),this.gameObject.isBuilding()){var I;this.healthBar=this.createBuildingHealthBar(this.gameObject),g.add(this.healthBar),1<=this.gameObject.art.height&&(L=this.selectionBox=this.createBuildingSelectionBox(this.gameObject),g.add(L)),(I=this.createBuildingOccupationInfo(this.gameObject))&&(g.add(I),this.pipsSprite=I),this.lastPipsDataKey=this.gameObject.garrisonTrait?.units.length}else{var{healthBarWrapper:L,selectionBox:I}=this.createUnitHealthBar(this.gameObject);if(this.healthBar=L,this.selectionBox=I,g.add(this.healthBar),this.gameObject.art.isVoxel&&(this.gameObject.rules.consideredAircraft||this.gameObject.isAircraft())&&!this.gameObject.rules.missileSpawn){let P=this.animFactory(this.audioVisualRules.flyerHelper);this.flyHelper=P,P.create3DObject(),g.add(P.get3DObject())}if(this.gameObject.isUnit()){let g=this.animFactory(this.audioVisualRules.behind);g.setRenderOrder(999995),this.behindAnim=g}}if(this.gameObject.debugLabel&&this.debugTextEnabled.value){let P=new ee.DebugLabel(this.gameObject.debugLabel,this.gameObject.owner.color.asHex(),this.camera);this.debugLabel=P,P.create3DObject(),P.get3DObject().renderOrder=999999,g.add(P.get3DObject())}this.lastHealth=this.gameObject.healthTrait.health,this.lastOwner=this.gameObject.owner,this.rootObj=g}}onCreate(g){this.gameObject.isBuilding()&&this.gameObject.rallyTrait&&(this.rallyLine=new q.RallyPointFx(this.camera,new THREE.Vector3,new THREE.Vector3,new THREE.Color,999999),this.rallyLine.visible=!1,g.addEffect(this.rallyLine),this.disposables.add(()=>this.rallyLine.remove(),this.rallyLine))}initTexture(){A.pipBrdFile=this.imageFinder.find("pipbrd",!1),A.pipsFile=this.imageFinder.find("pips",!1),A.pips2File=this.imageFinder.find("pips2",!1);let g=[A.pipBrdFile,A.pipsFile,A.pips2File],P=[];g.forEach(g=>{for(let U=0;U<g.numImages;U++){var I=g.getImage(U),_=new L.IndexedBitmap(I.width,I.height,I.imageData);P.push(_),A.atlasImageHandles.set(I,{bitmap:_,shpFile:g})}});let _=new I.TextureAtlas;return _.pack(P),_}buildSpriteGeometry(g){if(!A.atlasCache)throw new Error("Must build texture atlas before geometry");let P=A.atlasCache;var{bitmap:I,shpFile:L}=A.atlasImageHandles.get(g);return{texture:P.getTexture(),textureArea:P.getImageRect(I),align:{x:1,y:-1},offset:{x:g.x-Math.floor(L.width/2),y:g.y-Math.floor(L.height/2)},camera:this.camera,scale:U.Coords.ISO_WORLD_SCALE}}createBuildingHealthBar(g){var P=g.art.foundation.height,I=g.healthTrait.health,L=4*U.Coords.ISO_WORLD_SCALE,_=Math.floor(P*U.Coords.getWorldTileSize()/L),G=Math.max(1,Math.floor(I/100*_));let V;V=I>100*this.audioVisualRules.conditionYellow?1:I>100*this.audioVisualRules.conditionRed?2:4,P=V+"_"+P+"_"+G;let W=A.buildingHealthGeoCache.get(P);if(!W){let g=[];var z=A.pipsFile.getImage(0),K=A.pipsFile.getImage(V);for(let P=0;P<_;P++){var q=P<G?K:z;let I=A.geometries.get(q).clone();q=L*P+L/2,I.applyMatrix((new THREE.Matrix4).makeTranslation(L,0,q)),g.push(I)}W=Y.BufferGeometryUtils.mergeBufferGeometries(g),A.buildingHealthGeoCache.set(P,W)}let $=this.useMeshInstancing?new X.BatchedMesh(W,A.material,X.BatchMode.Instancing):new THREE.Mesh(W,A.material);return $.matrixAutoUpdate=!1,$.renderOrder=999999,P=g.art.height||.5,$.position.y=U.Coords.tileHeightToWorld(P),$.updateMatrix(),$}createUnitHealthBar(g){var P=!g.isInfantry(),I=g.healthTrait.health,L=g.healthTrait.level;let V=A.unitHealthTextures.get(P);V||(V=this.createUnitHealthTexture(P),A.unitHealthTextures.set(P,V));var W=A.pipBrdFile.getImage(P?0:1),z=oe.get(te.Engine.getActiveEngine())?.get(L);if(void 0===z)throw new Error(`Unhandled health level "${L}"`);z=A.pipsFile.getImage(z),z=Math.floor((W.width-2)/z.width),z=(P?1:0)+"_"+(I=Math.max(1,Math.floor(I/100*z)));let K=A.unitHealthGeoCache.get(z);K||(K=_.SpriteUtils.createSpriteGeometry({texture:V,textureArea:{x:0,y:(I-1)*W.height,width:W.width,height:W.height},camera:this.camera,align:{x:0,y:0},scale:U.Coords.ISO_WORLD_SCALE}),A.unitHealthGeoCache.set(z,K));let q=A.unitHealthMaterials.get(P);q||(q=new Z.PaletteBasicMaterial({map:V,palette:G.TextureUtils.textureFromPalette(this.palette),alphaTest:.5,flatShading:!0,transparent:!0,depthTest:!1}),A.unitHealthMaterials.set(P,q));let $=this.useSpriteBatching?new X.BatchedMesh(K,q,X.BatchMode.Merging):new THREE.Mesh(K,q);$.matrixAutoUpdate=!1,$.renderOrder=999998,P=U.Coords.screenDistanceToWorld(Math.floor(W.width/2)+-1,0),$.applyMatrix((new THREE.Matrix4).makeTranslation(P.x,0,P.y)),$.updateMatrix(),P=A.geometries.get(W);let Q=this.useSpriteBatching?new X.BatchedMesh(P,A.material,X.BatchMode.Merging):new THREE.Mesh(P,A.material);Q.matrixAutoUpdate=!1,P=U.Coords.screenDistanceToWorld(Math.floor(A.pipBrdFile.getImage(0).width/2)+-1,0),Q.applyMatrix((new THREE.Matrix4).makeTranslation(P.x,0,P.y)),Q.updateMatrix(),Q.renderOrder=999997;let Y=new THREE.Object3D;return Y.matrixAutoUpdate=!1,Y.add(Q),Y.add($),W=U.Coords.screenDistanceToWorld(-Math.floor(W.width/2),0),Y.applyMatrix((new THREE.Matrix4).makeTranslation(W.x,U.Coords.tileHeightToWorld(2),W.y)),Y.updateMatrix(),{healthBarWrapper:Y,selectionBox:Q}}createUnitHealthTexture(g){var P=A.pipBrdFile.getImage(g?0:1);let I=oe.get(te.Engine.getActiveEngine());if(!I)throw new Error("Unhandled engine type "+re.EngineType[te.Engine.getActiveEngine()]);var _=A.pipsFile.getImage(I.values().next().value).width,U=Math.floor((P.width-2)/_);let G=new L.IndexedBitmap(P.width,P.height*U);for(let g=1;g<=U;++g){var V=g/U*100;let _;if(_=V>100*this.audioVisualRules.conditionYellow?J.HealthLevel.Green:V>100*this.audioVisualRules.conditionRed?J.HealthLevel.Yellow:J.HealthLevel.Red,void 0===(V=I.get(_)))throw new Error(`Unhandled health level "${_}"`);var W=A.pipsFile.getImage(V),z=new L.IndexedBitmap(W.width,W.height,W.imageData),K=(g-1)*P.height;for(let P=0;P<g;P++){var q=W.width*P;G.drawIndexedImage(z,q+1,K+1)}}let $=new THREE.DataTexture(G.data,G.width,G.height,THREE.AlphaFormat);return $.minFilter=THREE.NearestFilter,$.magFilter=THREE.NearestFilter,$.flipY=!0,$.needsUpdate=!0,$}createBuildingSelectionBox(g){let P=new THREE.Object3D;P.matrixAutoUpdate=!1;let I=g.art.foundation,L=U.Coords.getWorldTileSize();return[[0,0],[0,1],[1,1],[1,0]].forEach(([_,G],V)=>{let W=this.createBuildingSelectionCornerMesh();W.matrixAutoUpdate=!1,W.position.set(_*L*I.width,U.Coords.tileHeightToWorld(g.art.height),G*L*I.height),W.rotation.y=V*Math.PI/2,W.scale.set((V%2==0?I.width:I.height)/4*U.Coords.getWorldTileSize(),U.Coords.tileHeightToWorld(g.art.height/4),(V%2==0?I.height:I.width)/4*U.Coords.getWorldTileSize()),W.updateMatrix(),P.add(W)}),P}createBuildingSelectionCornerMesh(){var g=[0,0,0,1,0,0,0,0,0,0,-1,0,0,0,0,0,0,1],P=new Array(g.length).fill(1);let I=new THREE.BufferGeometry;return I.addAttribute("position",new THREE.BufferAttribute(new Float32Array(g),3)),I.addAttribute("color",new THREE.BufferAttribute(new Float32Array(P),3)),P=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors}),this.disposables.add(I,P),new THREE.LineSegments(I,P)}createBuildingOccupationInfo(g){if(g.garrisonTrait?.units.length&&!this.objectIsOpaqueToViewer()){var P=g.garrisonTrait.units.length,I=g.rules.maxNumberOccupants;let z=[];var L=4*U.Coords.ISO_WORLD_SCALE,_=A.pipsFile.getImage(6),G=A.pipsFile.getImage(7);for(let W=1;W<=I;W++){var V=W<=P?G:_;let I=A.geometries.get(V).clone();V=L*W+L/2,I.applyMatrix((new THREE.Matrix4).makeTranslation(V,0,g.art.foundation.height*U.Coords.getWorldTileSize())),z.push(I)}var W=Y.BufferGeometryUtils.mergeBufferGeometries(z);let K=this.useSpriteBatching?new X.BatchedMesh(W,A.material,X.BatchMode.Merging):new THREE.Mesh(W,A.material);return K.matrixAutoUpdate=!1,K.renderOrder=999999,K}}createPipsSprite(g,P,I=!1){if(!this.objectIsOpaqueToViewer()){let K=[];var L=te.Engine.getActiveEngine()===re.EngineType.YurisRevenge?13:12,_=te.Engine.getActiveEngine()===re.EngineType.YurisRevenge?14:13,G=A.pips2File.getImage(I?L:0).width,V=A.pips2File.getImage(I?_:0);for(let _=0;_<P;_++){let P;if(_<g.length){var z=g[_];let U=I?L:3;z===W.PipColor.Blue?U=5:z===W.PipColor.Red?U=4:z===W.PipColor.Yellow&&(U=2),P=A.pips2File.getImage(U)}else P=V;let q=A.geometries.get(P).clone();z=G*_+G/2,z=U.Coords.screenDistanceToWorld(-Math.floor(A.pipBrdFile.getImage(this.gameObject.isInfantry()?1:0).width/2)+z,Math.floor(V.height/2)+3),q.applyMatrix((new THREE.Matrix4).makeTranslation(z.x,0,z.y)),K.push(q)}_=Y.BufferGeometryUtils.mergeBufferGeometries(K);let q=this.useSpriteBatching?new X.BatchedMesh(_,A.material,X.BatchMode.Merging):new THREE.Mesh(_,A.material);return q.renderOrder=999996,q}}createControlGroupTexture(g){let P=document.createElement("canvas"),I=P.getContext("2d",{alpha:!1});var L=ae,_=se;P.width=10*(_.width+2*L),P.height=_.height+2*L,I.fillStyle="#000",I.fillRect(0,0,P.width,P.height),I.strokeStyle=g.asHexString(),I.fillStyle=g.asHexString(),I.font="bold 12px Arial, sans-serif";for(let g=0;g<10;g++){var U=(_.width+2*L)*g;I.strokeRect(.5+U,.5,_.width+2*L-1,P.height-1),I.fillText(String(g),U+L+.5,_.height)}let G=new THREE.Texture(P);return G.minFilter=THREE.NearestFilter,G.magFilter=THREE.NearestFilter,G.needsUpdate=!0,G}createControlGroupSprite(g){let P=this.gameObject.owner.color;A.controlGroupTextures.has(P.asHex())||(L=this.createControlGroupTexture(P),A.controlGroupTextures.set(P.asHex(),L));var I=A.controlGroupTextures.get(P.asHex()),L=_.SpriteUtils.createSpriteGeometry({texture:I,textureArea:{x:g*(se.width+2*ae),y:0,width:se.width+2*ae,height:se.height+2*ae},camera:this.camera,align:{x:1,y:-1},scale:U.Coords.ISO_WORLD_SCALE});let G=A.controlGroupMaterials.get(I);G||(G=new THREE.MeshBasicMaterial({map:I,alphaTest:.5,transparent:!0,depthTest:!1,flatShading:!0}),A.controlGroupMaterials.set(I,G));let V=this.useSpriteBatching?new X.BatchedMesh(L,G,X.BatchMode.Merging):new THREE.Mesh(L,G);return V.matrixAutoUpdate=!1,V.renderOrder=999996,V}createPrimaryFactoryTexture(g){var P=K.OverlayUtils.createTextBox(this.strings.get("TXT_PRIMARY"),{color:g.asHexString(),borderColor:g.asHexString(),backgroundColor:"#000",fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:12,fontWeight:"500",paddingTop:5,paddingBottom:5,paddingLeft:2,paddingRight:4});let I=new THREE.Texture(P);return I.minFilter=THREE.NearestFilter,I.magFilter=THREE.NearestFilter,I.needsUpdate=!0,I}createPrimaryFactorySprite(){if(!this.objectIsOpaqueToViewer()){let I=this.gameObject.owner.color;A.primaryFactoryTextures.has(I.asHex())||(P=this.createPrimaryFactoryTexture(I),A.primaryFactoryTextures.set(I.asHex(),P));var g=A.primaryFactoryTextures.get(I.asHex()),P=_.SpriteUtils.createSpriteGeometry({texture:g,camera:this.camera,align:{x:1,y:-1},offset:{x:-Math.floor(g.image.width/2),y:-Math.floor(g.image.height/2)},scale:U.Coords.ISO_WORLD_SCALE});let L=A.primaryFactoryMaterials.get(g);L||(L=new THREE.MeshBasicMaterial({map:g,alphaTest:.5,transparent:!0,depthTest:!1,flatShading:!0}),A.primaryFactoryMaterials.set(g,L));let G=this.useSpriteBatching?new X.BatchedMesh(P,L,X.BatchMode.Merging):new THREE.Mesh(P,L);return G.renderOrder=999999,G}}createVeteranIndicator(g){if(g.veteranLevel){var P=A.pipsFile.getImage(13+g.veteranLevel-1);P=A.geometries.get(P);let I=this.useSpriteBatching?new X.BatchedMesh(P,A.material,X.BatchMode.Merging):new THREE.Mesh(P,A.material);return I.matrixAutoUpdate=!1,I.renderOrder=999996,I.receiveShadow=!1,I}}get3DObject(){return this.rootObj}update(g){let P=this.gameObject;if(P.isDestroyed||P.isCrashing)this.rootObj.visible=!1;else{this.persistentHoverTags,P.healthTrait.health!==this.lastHealth&&(this.lastHealth=P.healthTrait.health,this.invalidatedElements[0]=!0);let L=this.selectionModel.getSelectionLevel();this.invalidatedElements[0]&&(L>=ne[0]||L>=ne[3])&&(this.invalidatedElements[0]=void 0,this.updateHealthBarSprite(L));var I=this.computePipsDataKey(P);if(this.lastPipsDataKey===I&&this.lastOwner===P.owner||(this.lastPipsDataKey=I,this.invalidatedElements[1]=!0),this.invalidatedElements[1]&&L>=ne[1]&&(this.invalidatedElements[1]=void 0,this.updatePipsSprite()),I=this.selectionModel.getControlGroupNumber(),this.lastControlGroup!==I&&(this.lastControlGroup=I,this.invalidatedElements[3]=!0),this.invalidatedElements[3]&&L>=ne[3]&&(this.invalidatedElements[3]=void 0,this.updateControlGroupSprite(I)),I=P.isBuilding()&&!!P.rules.factory&&P.owner.production?.getPrimaryFactory(P.rules.factory)===P,this.lastPrimaryFactory===I&&this.lastOwner===P.owner||(this.lastPrimaryFactory=I,this.invalidatedElements[4]=!0),this.invalidatedElements[4]&&L>=ne[4]&&(this.invalidatedElements[4]=void 0,this.updatePrimaryFactorySprite(I)),I=P.isBuilding()&&P.rallyTrait?.getRallyPoint()||void 0,this.lastRallyPoint===I&&this.lastOwner===P.owner||(this.lastRallyPoint=I,this.invalidatedElements[5]=!0),this.invalidatedElements[5]&&L>=ne[5]&&this.rallyLine&&(this.invalidatedElements[5]=void 0,this.updateRallyPointLine(I,this.rallyLine)),P.isBuilding()?(I=!P.autoRepairTrait.isDisabled(),this.lastRepairState!==I&&(this.lastRepairState=I,this.updateRepairWrenchSprite(I))):this.lastVeteranLevel!==P.veteranLevel&&(this.lastVeteranLevel=P.veteranLevel,this.updateVeteranIndicatorSprite(P)),this.updateFlyerHelper(L,g),this.updateBehindAnim(g),this.updateUnitNameTag(),this.updateDebugLabel(),void 0===this.lastSelectionLevel||this.lastSelectionLevel!==L){this.lastSelectionLevel=L,new Map([[0,this.healthBar],[2,this.selectionBox],[1,this.pipsSprite],[3,this.controlGroupSprite],[4,this.primaryFactorySprite],[5,this.rallyLine]]).forEach((g,P)=>{g&&(g.visible=L>=ne[P])})}this.lastOwner=P.owner,this.lastDebugTextEnabled=this.debugTextEnabled.value,this.repairWrench?.update(g)}}updateFlyerHelper(g,P){if(this.flyHelper&&this.gameObject.isUnit()){let L;switch(this.flyerHelperOpt.value){case $.FlyerHelperMode.Never:L=!1;break;case $.FlyerHelperMode.Always:L=!0;break;case $.FlyerHelperMode.Selected:L=g>=V.SelectionLevel.Selected;break;default:L=!1}L=L&&this.gameObject.zone===Q.ZoneType.Air;let _=this.flyHelper.get3DObject();var I;_.visible=L,L&&(this.flyHelper.update(P),(I=-U.Coords.tileHeightToWorld(this.gameObject.tileElevation))!==_.position.y&&(_.position.y=I,_.updateMatrix()))}}updateBehindAnim(g){this.behindAnim&&(this.hiddenObjectsOpt.value&&this.gameObject.isSpawned&&this.gameObject.tile.occluded&&this.gameObject.art.canBeHidden&&this.gameObject.zone!==Q.ZoneType.Air?(this.behindAnim?.update(g),this.behindAnim.get3DObject()?.parent||(this.behindAnim.create3DObject(),this.rootObj.add(this.behindAnim.get3DObject()),this.behindAnim.get3DObject().updateMatrix())):this.behindAnim.get3DObject()?.parent&&this.rootObj.remove(this.behindAnim.get3DObject()))}clearUnitNameTag(){this.unitNameTag&&(this.rootObj?.remove(this.unitNameTag.get3DObject()),this.unitNameTag.dispose(),this.unitNameTag=void 0),this.lastUnitNameTagKey=void 0}updateUnitNameTag(){if(this.rootObj){let I=this.persistentHoverTags?.value,L=this.viewer?.value,_=this.mapRenderable?.mapShroud,U=this.gameObject.owner,G=this.gameObject.isBuilding?.()??!1,V=(!!L&&(L===U||this.alliances.haveSharedIntel(L,U)||this.alliances.areAllied?.(L,U)),void 0!==_&&void 0!==L&&!!_.isShrouded?.(this.gameObject.tile,this.gameObject.tileElevation)),W=!!this.gameObject.cloakableTrait?.isCloaked?.(),z=!!this.gameObject.submergibleTrait?.isSubmerged?.(),K=!!this.gameObject.disguiseTrait?.getDisguise?.(),q=!L||this.alliances.haveSharedIntel(L,U),$=!L||this.alliances.haveSharedIntel(L,U)||!!L.sharedDetectDisguiseTrait?.has(this.gameObject);if(!I||!(!V&&(!W||q)&&(!z||q)&&(!K||$)))return void this.clearUnitNameTag();if(G){let P=ce.resolveUiNameText(this.gameObject.getUiName?.(),this.strings);if(P){var g=P+"|"+this.gameObject.owner.color.asHex();if(this.lastUnitNameTagKey===g&&this.unitNameTag)return;this.clearUnitNameTag();let I=new ee.DebugLabel(P,this.gameObject.owner.color.asHex(),this.camera);this.unitNameTag=I,I.create3DObject(),I.get3DObject().renderOrder=999999,this.rootObj.add(I.get3DObject()),this.rootObj.matrixWorldNeedsUpdate=!0,I.get3DObject().matrixWorldNeedsUpdate=!0,this.lastUnitNameTagKey=g}else this.clearUnitNameTag()}else{let g=ce.resolveUiNameText(this.gameObject.getUiName?.(),this.strings);if(!g)return void this.clearUnitNameTag();var P=g+"|"+this.gameObject.owner.color.asHex();if(this.lastUnitNameTagKey===P&&this.unitNameTag)return;this.clearUnitNameTag();let I=new ee.DebugLabel(g,this.gameObject.owner.color.asHex(),this.camera);this.unitNameTag=I,I.create3DObject(),I.get3DObject().renderOrder=999999,this.rootObj.add(I.get3DObject()),this.rootObj.matrixWorldNeedsUpdate=!0,I.get3DObject().matrixWorldNeedsUpdate=!0,this.lastUnitNameTagKey=P}}}updateDebugLabel(){if((this.gameObject.debugLabel!==this.lastDebugLabel||this.gameObject.owner!==this.lastOwner||this.debugTextEnabled.value!==this.lastDebugTextEnabled)&&(this.lastDebugLabel=this.gameObject.debugLabel,this.debugLabel&&(this.rootObj.remove(this.debugLabel.get3DObject()),this.debugLabel.dispose(),this.debugLabel=void 0),this.gameObject.debugLabel&&this.debugTextEnabled.value)){let g=new ee.DebugLabel(this.gameObject.debugLabel,this.gameObject.owner.color.asHex(),this.camera);this.debugLabel=g,g.create3DObject(),g.get3DObject().renderOrder=999999,this.rootObj.add(g.get3DObject())}}updateRepairWrenchSprite(g){this.repairWrench&&this.rootObj.remove(this.repairWrench.get3DObject()),g&&(this.repairWrench=this.createRepairWrench(),this.repairWrench&&(this.repairWrench.create3DObject(),this.rootObj.add(this.repairWrench.get3DObject())))}updateVeteranIndicatorSprite(g){var P;this.veteranIndicator&&this.rootObj.remove(this.veteranIndicator),this.veteranIndicator=this.createVeteranIndicator(g),this.veteranIndicator&&(this.rootObj.add(this.veteranIndicator),P=U.Coords.screenDistanceToWorld(Math.floor(A.pipBrdFile.getImage(g.isInfantry()?1:0).width/2)-Math.floor(A.pipsFile.getImage(13).width/2),0),this.veteranIndicator.position.x=P.x,this.veteranIndicator.position.y=0,this.veteranIndicator.position.z=P.y,this.veteranIndicator.updateMatrix())}updateRallyPointLine(g,P){P.visible=!1,g&&(this.objectIsOpaqueToViewer()||(P.sourcePos=this.gameObject.position.worldPosition,P.targetPos=U.Coords.tile3dToWorld(g.rx+.5,g.ry+.5,g.z),P.color=new THREE.Color(this.gameObject.owner.color.asHex()),P.needsUpdate=!0,P.visible=!0))}updatePrimaryFactorySprite(g){var P;this.primaryFactorySprite&&this.rootObj.remove(this.primaryFactorySprite),!g||(P=this.primaryFactorySprite=this.createPrimaryFactorySprite())&&this.rootObj.add(P)}updateControlGroupSprite(g){if(this.controlGroupSprite&&this.rootObj.remove(this.controlGroupSprite),void 0!==g){let I=this.controlGroupSprite=this.createControlGroupSprite(g),L=this.gameObject;var P;L.isBuilding()?(I.position.x=1,I.position.y=U.Coords.tileHeightToWorld(L.art.height-.5),I.position.z=U.Coords.getWorldTileSize()*L.art.foundation.height):L.isInfantry()?(P=U.Coords.screenDistanceToWorld(-(se.width+2*ae+A.pipBrdFile.getImage(1).width/2+1),-A.pipBrdFile.height/2),I.position.x=P.x,I.position.y=this.healthBar.position.y,I.position.z=P.y):(P=U.Coords.screenDistanceToWorld(-A.pipBrdFile.getImage(0).width/2,A.pipBrdFile.height/2),I.position.x=P.x,I.position.y=this.healthBar.position.y,I.position.z=P.y),I.updateMatrix(),this.rootObj.add(I)}}updatePipsSprite(){this.pipsSprite&&(this.rootObj.remove(this.pipsSprite),this.pipsSprite=void 0);let g,P=this.gameObject;if(P.isBuilding())g=this.createBuildingOccupationInfo(P);else if(P.isVehicle()){let _,U=[];var I,L;P.harvesterTrait&&0<P.rules.storage?(_=5,L=P.rules.storage,I=Math.floor(P.harvesterTrait.gems/L*_),L=Math.floor(P.harvesterTrait.ore/L*_),U.push(...new Array(I).fill(W.PipColor.Blue),...new Array(L).fill(W.PipColor.Yellow))):P.transportTrait&&0<P.rules.passengers?(_=P.rules.passengers,P.transportTrait.units.forEach(g=>{let P=0;g.isVehicle()&&(U.push(W.PipColor.Blue),P++),U.push(...new Array(g.rules.size-P).fill(g.isVehicle()?W.PipColor.Red:g.rules.pip))})):P.airSpawnTrait&&(U=new Array(P.airSpawnTrait.availableSpawns).fill(W.PipColor.Yellow),_=P.rules.spawnsNumber),_&&(g=this.createPipsSprite(U,_))}else P.isAircraft()&&P.ammo&&P.name!==this.paradropRules.paradropPlane&&!P.rules.missileSpawn&&(g=this.createPipsSprite(new Array(P.ammo).fill(W.PipColor.Green),P.ammo,!0));g&&(g.updateMatrix(),this.rootObj.add(g),this.pipsSprite=g)}computePipsDataKey(g){let P;return g.isBuilding()?P=g.garrisonTrait?.units.length:g.isVehicle()?g.harvesterTrait?P=g.harvesterTrait.ore+"_"+g.harvesterTrait.gems:g.transportTrait?P=g.transportTrait.units.length:g.airSpawnTrait&&(P=g.airSpawnTrait.availableSpawns):g.isAircraft()&&(P=g.ammo),P}updateHealthBarSprite(g){if(this.healthBar){if(this.rootObj.remove(this.healthBar),this.gameObject.isBuilding())this.healthBar=this.createBuildingHealthBar(this.gameObject);else{let{healthBarWrapper:P,selectionBox:I}=this.createUnitHealthBar(this.gameObject);this.healthBar=P,this.selectionBox=I,I.visible=g>=ne[2]}this.rootObj.add(this.healthBar)}}createRepairWrench(){let g=this.animFactory("WRENCH");return g.setRenderOrder(999998),g}objectIsOpaqueToViewer(){var g=this.viewer.value;return!(!g||g.isObserver||this.gameObject.owner===g||this.alliances.areAllied(this.gameObject.owner,g))}dispose(){this.disposables.dispose(),this.repairWrench?.dispose(),this.flyHelper?.dispose(),this.behindAnim?.dispose(),this.debugLabel?.dispose(),this.clearUnitNameTag(),this.animFactory=void 0}}),le.atlasImageHandles=new Map,le.geometries=new Map,le.buildingHealthGeoCache=new Map,le.unitHealthGeoCache=new Map,le.unitHealthTextures=new Map,le.unitHealthMaterials=new Map,le.controlGroupTextures=new Map,le.controlGroupMaterials=new Map,le.primaryFactoryTextures=new Map,le.primaryFactoryMaterials=new Map}}}),System.register("engine/renderable/entity/plugin/ChronoSparkleFxPlugin",["game/Coords"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("ChronoSparkleFxPlugin",class{constructor(g,P){this.gameObject=g,this.sparkleAnimName=P,this.objMoveTrait=g.isUnit()?g.moveTrait:void 0}onCreate(g){this.renderableManager=g}update(){if(!this.gameObject.isDestroyed&&!this.gameObject.isCrashing&&this.renderableManager){var g=this.objMoveTrait?.lastTeleportTick,P=g!==this.lastTeleport;let L=this.gameObject.warpedOutTrait.isActive();(L!==this.lastWarpedOut||P)&&(this.lastTeleport=g,(this.lastWarpedOut=L)||P?(this.chronoSparkleAnim?.endAnimationLoop(),this.chronoSparkleAnim=this.renderableManager.createTransientAnim(this.sparkleAnimName,g=>{g.extraOffset={x:0,y:I.Coords.ISO_TILE_SIZE/2},g.setPosition(this.gameObject.position.worldPosition.clone()),g.create3DObject(),g.getAnimProps().loopCount=L?-1:1})):L||this.chronoSparkleAnim?.endAnimationLoop())}}onRemove(){this.renderableManager=void 0,this.chronoSparkleAnim?.endAnimationLoop()}dispose(){}})}}}),System.register("engine/renderable/entity/plugin/DamageSmokePlugin",["engine/renderable/fx/DamageSmokeFx"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("DamageSmokePlugin",class{constructor(g,P,I,L,_){this.gameObject=g,this.art=P,this.theater=I,this.imageFinder=L,this.gameSpeed=_}onCreate(g){this.renderableManager=g}update(g){var P,L,_;this.renderableManager&&((_=this.gameObject.healthTrait.health<50)===this.lastDamaged||this.gameObject.isDestroyed||((this.lastDamaged=_)?this.smokeFx||(this.smokeStartTime=g,(P=this.art.getAnimation("SGRYSMK1"))&&(L=this.imageFinder.findByObjectArt(P),_=this.theater.getPalette(P.paletteType),this.smokeFx=new I.DamageSmokeFx(this.gameObject,P,L,_,this.gameSpeed),this.renderableManager.addEffect(this.smokeFx))):this.disposeSmokeFx()),this.smokeFx&&this.smokeStartTime&&g-this.smokeStartTime>=8e4/this.gameSpeed.value&&this.disposeSmokeFx())}disposeSmokeFx(){this.smokeFx&&(this.smokeFx.finishAndRemove(),this.smokeFx=void 0)}onRemove(g){this.renderableManager=void 0,this.disposeSmokeFx()}dispose(){this.disposeSmokeFx()}})}}}),System.register("engine/renderable/entity/plugin/HarvesterPlugin",["game/gameobject/trait/HarvesterTrait","game/Coords"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("HarvesterPlugin",class{constructor(g,P){this.gameObject=g,this.harvesterTrait=P}onCreate(g){this.renderableManager=g}update(g){if(this.gameObject.warpedOutTrait.isActive())return this.disposeHarvAnim(),void(this.lastHarvesterStatus=void 0);var P;!this.renderableManager||(P=this.harvesterTrait.status)!==this.lastHarvesterStatus&&(this.lastHarvesterStatus=P,this.disposeHarvAnim(),P===I.HarvesterStatus.Harvesting&&(this.harvestAnim=this.renderableManager.createTransientAnim("OREGATH",g=>{var P=this.gameObject.tile;g.setPosition(L.Coords.tile3dToWorld(P.rx+.5,P.ry+.5,P.z)),g.create3DObject();let I=g.getAnimProps();var _=Math.floor(g.getShpFile().numImages/8);P=(this.gameObject.direction-45+360)%360,P=Math.round(P/360*8)%8*_;I.loopStart=I.start=P,I.loopEnd=P+_-1,I.loopCount=-1})))}disposeHarvAnim(){this.harvestAnim?.remove(),this.harvestAnim?.dispose(),this.harvestAnim=void 0}onRemove(){this.disposeHarvAnim()}dispose(){this.disposeHarvAnim()}})}}}),System.register("engine/renderable/entity/plugin/InfantryDisguisePlugin",["engine/type/ObjectType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("InfantryDisguisePlugin",class{constructor(g,P,I,L,_,U,G){this.gameObject=g,this.disguiseTrait=P,this.localPlayer=I,this.alliances=L,this.renderable=_,this.art=U,this.gameSpeed=G,this.canSeeThroughDisguise=!1}onCreate(){}update(g){if(!this.gameObject.isDestroyed&&!this.gameObject.warpedOutTrait.isActive()){let L=this.disguiseTrait.getDisguise();var P;L!==this.lastDisguise&&(this.lastDisguise=L,this.disguisedAt=L?g:void 0);let _=this.localPlayer.value;L&&(this.canSeeThroughDisguise=!_||this.alliances.haveSharedIntel(_,this.gameObject.owner)||!!_.sharedDetectDisguiseTrait?.has(this.gameObject)),L&&this.canSeeThroughDisguise&&(L=_?.sharedDetectDisguiseTrait?.has(this.gameObject)?void 0:Math.floor((g-this.disguisedAt)*this.gameSpeed.value/1e3)%16<=3?L:void 0),this.lastRenderDisguise!==L&&(this.lastRenderDisguise=L,L?(P=this.art.getObject(L.rules.name,I.ObjectType.Infantry),this.renderable.setDisguise({objectArt:P,owner:L.owner})):this.renderable.setDisguise(void 0))}}onRemove(){}getUiNameOverride(){var g=this.gameObject.disguiseTrait?.getDisguise();if(g&&!this.canSeeThroughDisguise)return g.rules.uiName}dispose(){}})}}}),System.register("engine/renderable/entity/plugin/MindControlLinkPlugin",["engine/renderable/fx/MindControlLinkFx"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("MindControlLinkPlugin",class{constructor(g,P,I,L){this.source=g,this.selectionModel=P,this.alliances=I,this.viewer=L,this.links=new Map}onCreate(g){this.renderableManager=g}update(){if(!this.source.isDestroyed&&!this.source.isCrashing&&this.source.mindControllerTrait)if(!this.selectionModel.isSelected()||this.viewer.value&&!this.alliances.haveSharedIntel(this.source.owner,this.viewer.value))this.disposeLinks();else{let V=this.source.mindControllerTrait.getTargets();for(var[g,P]of this.links.entries())V.includes(g)||(P.removeAndDispose(),this.links.delete(g));var L,_=new THREE.Color(this.source.owner.color.asHex()),U=this.source.position.worldPosition.clone();for(L of V){var G=L.position.worldPosition.clone();let g=this.links.get(L);g||(g=new I.MindControlLinkFx(U,G,_,2),this.links.set(L,g),this.renderableManager?.addEffect(g)),g.updateEndpoints(U,G)}}}onRemove(){this.renderableManager=void 0,this.disposeLinks()}dispose(){this.disposeLinks()}disposeLinks(){this.links.forEach(g=>g.removeAndDispose()),this.links.clear()}})}}}),System.register("engine/renderable/entity/plugin/MoveSoundFxPlugin",["game/gameobject/unit/ZoneType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("MoveSoundFxPlugin",class{constructor(g,P,I){this.gameObject=g,this.moveSound=P,this.worldSound=I,this.lastMovingOrRotating=!1}onCreate(){}update(){var g;this.gameObject.isDestroyed||this.gameObject.isCrashing||(g=!this.gameObject.warpedOutTrait.isActive()&&!!(!this.gameObject.rules.balloonHover&&this.gameObject.rules.hoverAttack&&this.gameObject.zone===I.ZoneType.Air||this.gameObject.spinVelocity||!this.gameObject.moveTrait.isIdle()&&!this.gameObject.moveTrait.isWaiting()))!==this.lastMovingOrRotating&&((this.lastMovingOrRotating=g)?this.soundHandle&&this.soundHandle.isPlaying()||(this.soundHandle=this.worldSound.playEffect(this.moveSound,this.gameObject,this.gameObject.owner,.35)):this.soundHandle?.isLoop&&(this.soundHandle.stop(),this.soundHandle=void 0))}onRemove(){this.soundHandle?.stop()}dispose(){this.soundHandle?.stop()}})}}}),System.register("engine/renderable/entity/plugin/ObjectCloakPlugin",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("ObjectCloakPlugin",class{constructor(g,P,I,L){this.gameObject=g,this.localPlayer=P,this.alliances=I,this.renderable=L,this.lastCanSeeThroughCloak=!1}onCreate(){}update(g){var P=!!this.gameObject.cloakableTrait?.isCloaked()&&!this.gameObject.isDestroyed,I=P!==this.lastCloaked,L=P&&(!this.localPlayer.value||this.alliances.haveSharedIntel(this.localPlayer.value,this.gameObject.owner)),_=L!==this.lastCanSeeThroughCloak;(I||_)&&(this.lastCloaked=P,this.lastCanSeeThroughCloak=L,this.renderable.get3DObject().visible=!P||L)}onRemove(){}dispose(){}})}}}),System.register("engine/renderable/entity/plugin/ShipWakeTrailPlugin",["game/Coords","engine/renderable/fx/TrailerSmokeFx","game/gameobject/unit/ZoneType","game/type/LandType","game/type/LocomotorType"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){g("ShipWakeTrailPlugin",class{constructor(g,P,I,L,_,U){this.gameObject=g,this.rules=P,this.art=I,this.theater=L,this.imageFinder=_,this.gameSpeed=U,this.trailPos=new THREE.Vector3}onCreate(g){this.renderableManager=g}update(g){var P,V,W,z,K,q;this.renderableManager&&(this.trailPos.copy(this.gameObject.position.worldPosition),this.trailPos.y=I.Coords.tileHeightToWorld(this.gameObject.tile.z),this.gameObject.rules.locomotor===G.LocomotorType.Hover&&(W=this.rules.general.hover.height,this.trailPos.x-=W,this.trailPos.z-=W),P=(z=this.gameObject.moveTrait.isMoving())!==this.lastMoving,V=(K=this.gameObject.submergibleTrait?.isSubmerged())!==this.lastSubmerged,W=(q=this.gameObject.zone===_.ZoneType.Water&&this.gameObject.tile.landType===U.LandType.Water)!==this.lastInWater,(P||V||W)&&(this.lastMoving=z,this.lastSubmerged=K,this.lastInWater=q,z&&!K&&q?this.trailerFx?this.trailerFx.enable():(W=this.art.getAnimation(this.rules.audioVisual.wake))&&(z=this.imageFinder.findByObjectArt(W),K=this.theater.getPalette(W.paletteType),q=this.gameObject.art.spawnDelay,this.trailerFx=new L.TrailerSmokeFx(this.trailPos,q,W,z,K,this.gameSpeed),this.renderableManager.addEffect(this.trailerFx)):this.trailerFx?.disable()))}onRemove(g){this.renderableManager=void 0,this.trailerFx?.finishAndRemove()}dispose(){this.trailerFx?.finishAndRemove()}})}}}),System.register("engine/renderable/entity/plugin/TntFxPlugin",["engine/type/ObjectType","engine/sound/SoundKey"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("TntFxPlugin",class{constructor(g,P,I,L,_,U,G,V,W,z){this.gameObject=g,this.tntChargeTrait=P,this.frameDurationTicks=I,this.renderable=L,this.imageFinder=_,this.art=U,this.alliances=G,this.viewer=V,this.worldSound=W,this.animFactory=z,this.lastHasCharge=!1}onCreate(){this.animStepCount=Math.floor(this.imageFinder.findByObjectArt(this.art.getObject("BOMBCURS",I.ObjectType.Animation)).numImages/2)}update(g){if(this.gameObject.isDestroyed||this.gameObject.isCrashing)this.gameObject.rules.leaveRubble&&(this.disposeBombAnim(),this.soundHandle?.stop());else{var P=this.tntChargeTrait.hasCharge(),I=P!==this.lastHasCharge;let U;U=P?(_=1-this.tntChargeTrait.getTicksLeft()/this.tntChargeTrait.getInitialTicks(),Math.floor(2*_*(this.animStepCount-1))):0;var _=U!==this.lastStartFrame;if(this.bombAnim?.update(g),I||_)if(this.lastHasCharge=P,this.lastStartFrame=U,P){if(I&&(this.soundHandle?.stop(),this.soundHandle=this.worldSound?.playEffect(L.SoundKey.BombTickingSound,this.gameObject)),this.disposeBombAnim(),I=this.gameObject.tntChargeTrait.getChargeOwner(),!this.viewer.value||this.alliances.haveSharedIntel(I,this.viewer.value)){let g=this.bombAnim=this.animFactory("BOMBCURS");g.setRenderOrder(999995),g.create3DObject();let P=g.getAnimProps();P.loopCount=-1,P.start=P.loopStart=U,P.end=U+2-1,P.loopEnd=P.end,P.rate/=this.frameDurationTicks,this.renderable.get3DObject()?.add(g.get3DObject())}}else this.disposeBombAnim(),this.soundHandle?.stop()}}disposeBombAnim(){this.bombAnim?.get3DObject()&&this.renderable.get3DObject()?.remove(this.bombAnim.get3DObject()),this.bombAnim?.dispose()}onRemove(){this.disposeBombAnim(),this.soundHandle?.stop()}dispose(){this.disposeBombAnim(),this.soundHandle?.stop()}})}}}),System.register("engine/renderable/entity/plugin/TrailerSmokePlugin",["engine/renderable/fx/TrailerSmokeFx"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("TrailerSmokePlugin",class{constructor(g,P,I,L,_){this.gameObject=g,this.art=P,this.theater=I,this.imageFinder=L,this.gameSpeed=_}onCreate(g){this.initialPosition=this.gameObject.position.worldPosition.clone(),this.renderableManager=g}update(g){if(this.renderableManager&&!this.trailerFx&&!this.gameObject.position.worldPosition.equals(this.initialPosition)){if(this.gameObject.isAircraft()){let g;this.gameObject.rules.missileSpawn?g=this.art.getAnimation("V3TRAIL"):this.gameObject.isCrashing&&(g=this.art.getAnimation("SGRYSMK1")),g&&(L=this.imageFinder.findByObjectArt(g),_=this.theater.getPalette(g.paletteType),P=this.gameObject.art.spawnDelay,this.trailerFx=new I.TrailerSmokeFx(this.gameObject.position.worldPosition,P,g,L,_,this.gameSpeed),this.renderableManager.addEffect(this.trailerFx))}var P,L,_,U;!this.gameObject.isProjectile()&&!this.gameObject.isDebris()||(U=this.gameObject.isProjectile()?this.gameObject.art.trailer:this.gameObject.rules.trailerAnim)&&(P=this.art.getAnimation(U),L=this.imageFinder.findByObjectArt(P),_=this.theater.getPalette(P.paletteType),U=this.gameObject.isProjectile()?this.gameObject.art.spawnDelay:this.gameObject.rules.trailerSeparation,this.trailerFx=new I.TrailerSmokeFx(this.gameObject.position.worldPosition,U,P,L,_,this.gameSpeed),this.renderableManager.addEffect(this.trailerFx))}}onRemove(g){this.renderableManager=void 0,this.trailerFx?.finishAndRemove()}dispose(){this.trailerFx?.finishAndRemove()}})}}}),System.register("engine/renderable/entity/plugin/VehicleDisguisePlugin",["engine/renderable/MapSpriteTranslation","engine/renderable/ShpRenderable","engine/type/ObjectType"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("VehicleDisguisePlugin",class{constructor(g,P,I,L,_,U,G,V,W,z,K,q){this.gameObject=g,this.disguiseTrait=P,this.localPlayer=I,this.alliances=L,this.renderable=_,this.art=U,this.imageFinder=G,this.theater=V,this.camera=W,this.lighting=z,this.gameSpeed=K,this.useSpriteBatching=q,this.lastRenderDisguised=!1,this.canSeeThroughDisguise=!1}onCreate(){}update(g){if(!this.gameObject.isDestroyed&&!this.gameObject.warpedOutTrait.isActive()){let I=this.disguiseTrait.isDisguised();I!==this.lastDisguised&&(this.lastDisguised=I,this.disguisedAt=I?g:void 0);let L=this.localPlayer.value;if(I&&(this.canSeeThroughDisguise=!L||this.alliances.haveSharedIntel(L,this.gameObject.owner)||!!L.sharedDetectDisguiseTrait?.has(this.gameObject)),I&&this.canSeeThroughDisguise&&(I=!L?.sharedDetectDisguiseTrait?.has(this.gameObject)&&Math.floor((g-this.disguisedAt)*this.gameSpeed.value/1e3)%16<=3),this.lastRenderDisguised!==I&&(this.lastRenderDisguised=I,this.renderable.mainObj.visible=!I,this.renderable.posObj.visible=!I||this.canSeeThroughDisguise,this.disguiseObj&&(this.disguiseObj.visible=!1),I)){var P=this.disguiseTrait.getDisguise();if(P.rules.type!==_.ObjectType.Terrain)throw new Error("Unsupported disguise type "+_.ObjectType[P.rules.type]);P=this.art.getObject(P.rules.name,_.ObjectType.Terrain),this.disguiseObj||(this.disguiseObj=this.createDisguiseObj(P),this.renderable.get3DObject().add(this.disguiseObj)),this.disguiseObj.visible=!0,P=this.lighting.compute(P.lightingType,this.gameObject.tile,this.gameObject.tileElevation).addScalar(-1),this.disguiseRenderable.setExtraLight(P)}}}createDisguiseObj(g){let P=new THREE.Object3D;P.matrixAutoUpdate=!1;let _=new I.MapSpriteTranslation(1,1);var{spriteOffset:U,anchorPointWorld:G}=_.compute();P.position.x=G.x,P.position.z=G.y,P.updateMatrix();var V=this.imageFinder.findByObjectArt(g),G=this.theater.getPalette(g.paletteType,g.customPaletteName);let W=L.ShpRenderable.factory(V,G,this.camera,U,g.hasShadow);return W.setBatched(this.useSpriteBatching),this.useSpriteBatching&&W.setBatchPalettes([G]),W.setFrame(0),W.create3DObject(),P.add(W.get3DObject()),this.disguiseRenderable=W,P}updateLighting(){if(this.disguiseObj?.visible&&this.disguiseRenderable){var g=this.disguiseTrait.getDisguise();if(g){if(g.rules.type!==_.ObjectType.Terrain)throw new Error("Unsupported disguise type "+_.ObjectType[g.rules.type]);g=this.art.getObject(g.rules.name,_.ObjectType.Terrain),this.disguiseRenderable.setExtraLight(this.lighting.compute(g.lightingType,this.gameObject.tile,this.gameObject.tileElevation).addScalar(-1))}}}onRemove(){this.disguiseObj&&(this.renderable.get3DObject().remove(this.disguiseObj),this.disguiseObj=void 0)}getUiNameOverride(){if(this.gameObject.disguiseTrait?.hasTerrainDisguise()&&!this.canSeeThroughDisguise)return""}shouldDisableHighlight(){return!!this.gameObject.disguiseTrait?.hasTerrainDisguise()&&!this.canSeeThroughDisguise}dispose(){this.disguiseRenderable?.dispose()}})}}}),System.register("engine/renderable/entity/Projectile",["engine/renderable/WithPosition","engine/renderable/ShpRenderable","game/gameobject/Projectile","game/Coords","engine/renderable/fx/LaserFx","game/WeaponType","engine/renderable/fx/TeslaFx","game/GameSpeed","engine/renderable/fx/LineTrailFx","engine/renderable/fx/SparkFx","engine/renderable/fx/RadBeamFx","engine/renderable/entity/unit/BlobShadow","engine/gfx/lighting/NukeLightingFx","engine/gfx/batch/BatchedMesh","game/rules/ObjectRules","game/math/geometry","engine/type/PaletteType"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g}],execute:function(){g("Projectile",class S{constructor(g,P,L,_,U,G,V,W,z,K,q,$,Q,Y,Z){var X,J;this.gameObject=g,this.rules=P,this.imageFinder=L,this.voxels=_,this.voxelAnims=U,this.theater=G,this.palette=V,this.specialPalette=W,this.camera=z,this.gameSpeed=K,this.lighting=q,this.lightingDirector=$,this.vxlBuilderFactory=Q,this.useSpriteBatching=Y,this.useMeshInstancing=Z,this.plugins=[],this.objectArt=g.art,this.label="projectile_"+g.rules.name,this.withPosition=new I.WithPosition,this.extraLight=new THREE.Vector3,this.updateLighting(),this.gameObject.rules.firersPalette&&(X=(J=this.gameObject.fromObject)?.art.paletteType??ee.PaletteType.Unit,J=J?.art.customPaletteName,this.palette=this.theater.getPalette(X,J),this.gameObject.art.remapable&&(this.palette=this.palette.clone(),this.palette.remap(this.gameObject.fromPlayer.color))),this.gameObject.rules.firersPalette&&this.objectArt.remapable?this.paletteRemaps=[...this.rules.colors.values()].map(g=>this.palette.clone().remap(g)):this.paletteRemaps=[this.palette]}registerPlugin(g){this.plugins.push(g)}updateLighting(){this.plugins.forEach(g=>g.updateLighting?.()),this.objectArt.isVoxel?this.extraLight.setScalar(this.lighting.computeNoAmbient(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation)):this.extraLight.copy(this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation)).addScalar(-1)}getIntersectTarget(){}get3DObject(){return this.target}create3DObject(){let g=this.get3DObject();g||(g=new THREE.Object3D,g.name=this.label,this.target=g,g.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(g))}setPosition(g){this.withPosition.setPosition(g.x,g.y,g.z)}getPosition(){return this.withPosition.getPosition()}update(g,P){if(this.plugins.forEach(P=>P.update(g)),0<P&&!this.gameObject.isDestroyed){var I=this.gameObject.velocity.clone().multiplyScalar(P).add(this.gameObject.position.worldPosition);this.setPosition(I)}this.blobShadow?.update(g,P);var L=this.gameObject.direction;!this.vxlRotWrapper&&void 0!==this.lastDirection&&this.lastDirection===L||(this.shpRenderable&&2<this.shpRenderable.frameCount?(this.lastDirection=L,this.updateShapeFrame(L)):this.vxlRotWrapper?(I=J.quaternionFromVec3(this.gameObject.velocity.clone().negate()),this.vxlRotWrapper.rotation.setFromQuaternion(I,"YXZ"),this.gameObject.rules.vertical&&(this.vxlRotWrapper.rotation.y=THREE.Math.degToRad(180+L)),this.vxlRotWrapper.updateMatrix()):this.sonicWaveMesh&&(this.sonicWaveMesh.rotation.y=THREE.Math.degToRad(L),this.sonicWaveMesh.updateMatrix())),this.gameObject.state!==this.lastState&&(this.lastState=this.gameObject.state,this.gameObject.state===_.ProjectileState.Impact&&(this.target.visible=!1,this.renderableManager.createTransientAnim(this.gameObject.impactAnim,g=>{g.setPosition(this.withPosition.getPosition())}),this.gameObject.isNuke&&this.lightingDirector.addEffect(new Y.NukeLightingFx)))}updateShapeFrame(g){let P=0;this.objectArt.rotates&&(P=Math.round((g-45+360)%360/360*32)%32),this.shpRenderable.setFrame(P)}createObjects(g){if(this.gameObject.fromWeapon.rules.isSonic){S.sonicWaveGeometry??(S.sonicWaveGeometry=this.createSonicWaveGeometry()),S.sonicWaveMaterial??(S.sonicWaveMaterial=new THREE.MeshBasicMaterial({color:48340,blending:THREE.CustomBlending,blendEquation:THREE.AddEquation,blendSrc:THREE.DstColorFactor,blendDst:THREE.OneFactor,transparent:!0,opacity:.25,alphaTest:.01,depthTest:!1,depthWrite:!1}));let P=new(this.useMeshInstancing?Z.BatchedMesh:THREE.Mesh)(S.sonicWaveGeometry,S.sonicWaveMaterial);return P.rotation.order="YXZ",P.rotation.x=-Math.PI/2,P.rotation.y=THREE.Math.degToRad(this.gameObject.direction),P.updateMatrix(),P.matrixAutoUpdate=!1,g.add(P),void(this.sonicWaveMesh=P)}if(!this.gameObject.rules.inviso&&this.gameObject.rules.imageName!==X.ObjectRules.IMAGE_NONE){if(this.gameObject.art.isVoxel){var P=this.objectArt.imageName.toLowerCase(),I=P+".vxl",_=this.voxels.get(I);if(!_)throw new Error(`VXL missing for projectile ${this.gameObject.rules.name}. Vxl file ${I} not found. `);var U=this.objectArt.noHva?void 0:this.voxelAnims.get(P+".hva");let L=this.vxlBuilder=this.vxlBuilderFactory.create(_,U,this.paletteRemaps,this.palette);L.setExtraLight(this.extraLight),I=L.build();let G=this.vxlRotWrapper=new THREE.Object3D;G.rotation.order="YXZ",G.matrixAutoUpdate=!1,G.add(I),g.add(G)}else{P=this.imageFinder.findByObjectArt(this.objectArt),_=this.objectArt.getDrawOffset(),U=this.gameObject.rules.arcing,I=this.gameObject.rules.shadow&&!U&&1<P.numImages;let G=L.ShpRenderable.factory(P,this.palette,this.camera,_,I);G.setBatched(this.useSpriteBatching),this.useSpriteBatching&&G.setBatchPalettes(this.paletteRemaps),G.setExtraLight(this.extraLight),G.create3DObject(),this.shpRenderable=G,g.add(G.get3DObject()),U&&(this.blobShadow=new Q.BlobShadow(this.gameObject,1.5,this.useMeshInstancing),this.blobShadow.create3DObject(),g.add(this.blobShadow.get3DObject()))}this.gameObject.fromWeapon.type===V.WeaponType.DeathWeapon&&(g.visible=!1)}}createSonicWaveGeometry(){let g=new THREE.PlaneBufferGeometry(U.Coords.LEPTONS_PER_TILE,U.Coords.LEPTONS_PER_TILE/3,10,10),P=g.getAttribute("position");for(let g=0;g<P.count;g++)P.setY(g,P.getY(g)+Math.cos(P.getX(g)*Math.PI/U.Coords.LEPTONS_PER_TILE)*U.Coords.ISO_WORLD_SCALE);return g}onCreate(g){this.renderableManager=g,this.plugins.forEach(P=>P.onCreate(g));var P=this.gameObject.fromObject?.name===this.rules.general.prism.type&&this.gameObject.fromWeapon.type===V.WeaponType.Secondary;let I;I=this.gameObject.fromObject?this.gameObject.fromWeapon.type===V.WeaponType.Primary||this.gameObject.fromWeapon.type===V.WeaponType.DeathWeapon||P?this.gameObject.fromObject.art.primaryFirePixelOffset:this.gameObject.fromObject.art.secondaryFirePixelOffset:[];var L,_;P=this.gameObject.fromWeapon.rules;if(this.gameObject.fromWeapon.type!==V.WeaponType.DeathWeapon&&!P.limboLaunch){let P;(Q=this.gameObject.fromWeapon.rules.anim).length?P=1===Q.length?Q[0]:(Y=this.gameObject.direction,Q[Math.round((45-Y+360)%360/360*8)%8]):this.gameObject.fromWeapon.warhead.rules.nukeMaker&&(P=this.rules.audioVisual.nukeTakeOff),P&&g.createTransientAnim(P,g=>{g.setPosition(this.gameObject.position.worldPosition),I.length&&(g.extraOffset={x:I[0],y:-I[1]/2})})}if(P.isLaser){let L=this.gameObject.position.worldPosition.clone(),_=new THREE.Vector3;I.length&&(Z=U.Coords.screenDistanceToWorld(I[0],0),_.x=4*Z.x,_.z=4*Z.y,_.y=4*U.Coords.tileHeightToWorld(-I[1]/(U.Coords.ISO_TILE_SIZE/2)));let W=this.gameObject.target.getWorldCoords().clone();this.gameObject.fromObject?.name===this.rules.general.prism.type&&this.gameObject.fromWeapon.type===V.WeaponType.Secondary&&(_.y+=this.gameObject.fromObject.art.primaryFireFlh.vertical,W.add(_)),L.add(_);var Q=new THREE.Color(P.isHouseColor?this.gameObject.fromPlayer.color.asHex():16711680),Y=P.laserDuration/z.GameSpeed.BASE_TICKS_PER_SECOND/this.gameSpeed.value,Z=2*(1<this.gameObject.baseDamageMultiplier?2:1);Z=new G.LaserFx(this.camera,L,W,Q,Y,Z);g.addEffect(Z)}if(P.isElectricBolt){let I=this.gameObject.position.worldPosition.clone();this.gameObject.fromObject?.isBuilding()&&(I.y+=U.Coords.tileHeightToWorld(1)),Z=this.gameObject.target.getWorldCoords();let L=this.specialPalette;var X=new THREE.Color(L.getColorAsHex(P.isAlternateColor?5:10)),J=new THREE.Color(L.getColorAsHex(15)),ee=1/this.gameSpeed.value;X=new W.TeslaFx(I,Z,X,J,ee);g.addEffect(X)}P.isRadBeam&&(J=this.gameObject.position.worldPosition.clone(),ee=this.gameObject.target.getWorldCoords().clone(),X=this.gameObject.fromWeapon.warhead.rules.temporal?new THREE.Color(...this.rules.audioVisual.chronoBeamColor.map(g=>g/255)):new THREE.Color(...this.rules.radiation.radColor.map(g=>g/255)),L=1/this.gameSpeed.value,L=new $.RadBeamFx(this.camera,J,ee,X,L,1),g.addEffect(L)),this.objectArt.useLineTrail&&(L=(new THREE.Color).fromArray(this.objectArt.lineTrailColor.map(g=>g/255)),_=this.objectArt.lineTrailColorDecrement,_=new K.LineTrailFx(()=>this.target,L,_,this.gameSpeed,this.camera),g.addEffect(_),this.lineTrailFx=_),P.useSparkParticles&&(_=this.gameObject.position.worldPosition.clone(),P=20/z.GameSpeed.BASE_TICKS_PER_SECOND,P=new q.SparkFx(_,new THREE.Color(1,1,1),P,this.gameSpeed),g.addEffect(P))}onRemove(g){this.renderableManager=void 0,this.plugins.forEach(P=>P.onRemove(g)),this.gameObject.overshootTiles&&this.lineTrailFx?.stopTracking(),this.lineTrailFx?.requestFinishAndDispose()}dispose(){this.plugins.forEach(g=>g.dispose()),this.shpRenderable?.dispose(),this.vxlBuilder?.dispose(),this.blobShadow?.dispose()}})}}}),System.register("engine/renderable/entity/RenderableFactory",["engine/renderable/entity/Building","engine/renderable/entity/Vehicle","engine/renderable/entity/Terrain","engine/renderable/entity/Overlay","engine/renderable/entity/Smudge","engine/renderable/entity/building/AnimationType","engine/renderable/entity/Infantry","engine/renderable/entity/PipOverlay","engine/renderable/entity/Aircraft","engine/renderable/entity/TransientAnim","engine/renderable/entity/Projectile","engine/type/ObjectType","engine/renderable/entity/plugin/HarvesterPlugin","engine/renderable/entity/Anim","engine/renderable/entity/plugin/MoveSoundFxPlugin","engine/renderable/entity/plugin/VehicleDisguisePlugin","engine/renderable/entity/plugin/ChronoSparkleFxPlugin","engine/renderable/entity/plugin/TntFxPlugin","engine/renderable/entity/plugin/MindControlLinkPlugin","engine/renderable/entity/plugin/InfantryDisguisePlugin","engine/renderable/entity/building/PsychicDetectPlugin","engine/renderable/entity/plugin/TrailerSmokePlugin","engine/renderable/entity/plugin/DamageSmokePlugin","game/type/LocomotorType","engine/renderable/entity/plugin/ShipWakeTrailPlugin","engine/renderable/entity/plugin/ObjectCloakPlugin","engine/renderable/entity/Debris","engine/renderable/builder/ShpAggregator"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce,he,ue,de;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g},function(g){ce=g},function(g){he=g},function(g){ue=g},function(g){de=g}],execute:function(){g("RenderableFactory",class{constructor(g,P,I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe=!1,le=!1){this.localPlayer=g,this.unitSelection=P,this.alliances=I,this.rules=L,this.art=_,this.mapRenderable=U,this.imageFinder=G,this.palettes=V,this.voxels=W,this.voxelAnims=z,this.theater=K,this.camera=q,this.lighting=$,this.lightingDirector=Q,this.debugWireframes=Y,this.debugText=Z,this.persistentHoverTags=X,this.gameSpeed=J,this.worldSound=ee,this.strings=te,this.flyerHelperOpt=re,this.hiddenObjectsOpt=se,this.vxlBuilderFactory=ae,this.buildingImageDataCache=ne,this.useSpriteBatching=oe,this.useMeshInstancing=le,this.bridgeImageCache=new Map}createTransientAnim(g,P){var I=this.art.getObject(g,Q.ObjectType.Animation);return new q.TransientAnim(g,I,{x:0,y:0},this.imageFinder,this.theater,this.camera,this.debugWireframes,this.gameSpeed,this.useSpriteBatching,P,this.worldSound)}createAnim(g){var P=this.art.getObject(g,Q.ObjectType.Animation);return new Z.Anim(g,P,{x:0,y:0},this.imageFinder,this.theater,this.camera,this.debugWireframes,this.gameSpeed,this.useSpriteBatching,void 0,this.worldSound)}create(g){let P=this.theater.getPalette(g.art.paletteType,g.art.customPaletteName),q=[];if((g.isAircraft()||g.isProjectile()||g.isDebris())&&q.push(new ne.TrailerSmokePlugin(g,this.art,this.theater,this.imageFinder,this.gameSpeed)),g.isTechno()){P=P.clone();var Q=this.unitSelection.getOrCreateSelectionModel(g),Z=new z.PipOverlay(this.rules.general.paradrop,this.rules.audioVisual,g,this.localPlayer,this.alliances,Q,this.imageFinder,this.palettes.get("palette.pal"),this.camera,this.strings,this.flyerHelperOpt,this.hiddenObjectsOpt,this.debugText,this.persistentHoverTags,g=>this.createAnim(g),this.useSpriteBatching,this.useMeshInstancing,this.mapRenderable);let _;if(!g.isUnit()||(pe=g.rules.moveSound)&&this.worldSound&&q.push(new X.MoveSoundFxPlugin(g,pe,this.worldSound)),q.push(new ee.ChronoSparkleFxPlugin(g,this.rules.audioVisual.chronoSparkle1)),g.mindControllerTrait&&q.push(new re.MindControlLinkPlugin(g,Q,this.alliances,this.localPlayer)),g.isBuilding()){var ge=this.theater.animPalette,pe=this.theater.isoPalette;_=new I.Building(g,Q,this.rules,this.art,this.imageFinder,this.theater,this.voxels,this.voxelAnims,P,ge,pe,this.camera,this.lighting,this.debugWireframes,this.gameSpeed,this.vxlBuilderFactory,this.useSpriteBatching,new de.ShpAggregator,this.buildingImageDataCache,Z,this.worldSound,V.AnimationType.BUILDUP),g.psychicDetectorTrait&&q.push(new ae.PsychicDetectPlugin(g,g.psychicDetectorTrait,this.localPlayer,this.camera))}else if(g.isVehicle())_=new L.Vehicle(g,this.rules,this.art,this.imageFinder,this.theater,this.voxels,this.voxelAnims,P,this.camera,this.lighting,this.debugWireframes,this.gameSpeed,Q,this.vxlBuilderFactory,this.useSpriteBatching,Z,this.worldSound),g.rules.damageParticleSystems.length&&q.push(new oe.DamageSmokePlugin(g,this.art,this.theater,this.imageFinder,this.gameSpeed)),g.rules.locomotor!==le.LocomotorType.Ship&&g.rules.locomotor!==le.LocomotorType.Hover||q.push(new ce.ShipWakeTrailPlugin(g,this.rules,this.art,this.theater,this.imageFinder,this.gameSpeed)),g.harvesterTrait&&this.mapRenderable&&q.push(new Y.HarvesterPlugin(g,g.harvesterTrait)),g.disguiseTrait&&q.push(new J.VehicleDisguisePlugin(g,g.disguiseTrait,this.localPlayer,this.alliances,_,this.art,this.imageFinder,this.theater,this.camera,this.lighting,this.gameSpeed,this.useSpriteBatching));else if(g.isInfantry())_=new W.Infantry(g,this.rules,this.art,this.imageFinder,this.theater,P,this.camera,this.lighting,this.debugWireframes,this.gameSpeed,Q,this.useSpriteBatching,this.useMeshInstancing,Z,this.worldSound),g.disguiseTrait&&q.push(new se.InfantryDisguisePlugin(g,g.disguiseTrait,this.localPlayer,this.alliances,_,this.art,this.gameSpeed));else{if(!g.isAircraft())throw new Error("Unhandled game object type "+g.type);_=new K.Aircraft(g,this.rules,this.voxels,this.voxelAnims,P,this.camera,this.lighting,this.debugWireframes,this.gameSpeed,Q,this.vxlBuilderFactory,this.useSpriteBatching,Z)}return g.tntChargeTrait&&q.push(new te.TntFxPlugin(g,g.tntChargeTrait,this.rules.combatDamage.ivanIconFlickerRate,_,this.imageFinder,this.art,this.alliances,this.localPlayer,this.worldSound,g=>this.createAnim(g))),q.push(new he.ObjectCloakPlugin(g,this.localPlayer,this.alliances,_)),q.forEach(g=>_.registerPlugin(g)),_}if(g.isTerrain())return new _.Terrain(g,this.mapRenderable?.terrainLayer,this.imageFinder,P,this.camera,this.lighting,this.debugWireframes,this.gameSpeed,this.useSpriteBatching);if(g.isOverlay())return new U.Overlay(g,this.rules,this.art,this.imageFinder,P,this.camera,this.lighting,this.debugWireframes,this.bridgeImageCache,this.mapRenderable?.overlayLayer,this.useSpriteBatching);if(g.isProjectile()){let I=new $.Projectile(g,this.rules,this.imageFinder,this.voxels,this.voxelAnims,this.theater,P,this.palettes.get("palette.pal"),this.camera,this.gameSpeed,this.lighting,this.lightingDirector,this.vxlBuilderFactory,this.useSpriteBatching,this.useMeshInstancing);return q.forEach(g=>I.registerPlugin(g)),I}if(g.isSmudge())return new G.Smudge(g,this.imageFinder,P,this.camera,this.lighting,this.debugWireframes,this.mapRenderable?.smudgeLayer);if(g.isDebris()){let I=new ue.Debris(g,this.rules,this.imageFinder,this.voxels,this.voxelAnims,P,this.camera,this.lighting,this.gameSpeed,this.vxlBuilderFactory,this.useSpriteBatching);return q.forEach(g=>I.registerPlugin(g)),I}throw new Error("Not implemented")}})}}}),System.register("engine/renderable/entity/Smudge",["engine/renderable/builder/ShpBuilder","engine/renderable/WithPosition","engine/ImageFinder","engine/gfx/DebugUtils","engine/renderable/MapSpriteTranslation","game/Coords"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){g("Smudge",class{constructor(g,P,I,L,_,U,G){this.gameObject=g,this.imageFinder=P,this.palette=I,this.camera=L,this.lighting=_,this.debugFrame=U,this.mapSmudgeLayer=G,this.objectArt=g.art,this.label="smudge_"+g.name,this.init()}init(){this.withPosition=new L.WithPosition,this.extraLight=new THREE.Vector3,this.updateLighting()}updateLighting(){this.extraLight.copy(this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile)).addScalar(-1)}get3DObject(){return this.target}create3DObject(){let g=this.get3DObject();g||(g=new THREE.Object3D,g.name=this.label,this.target=g,g.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(g))}update(g){}setPosition(g){this.withPosition.setPosition(g.x,g.y,g.z)}getPosition(){return this.withPosition.getPosition()}createObjects(g){var P,L={width:1,height:1};let W=new THREE.Object3D;if(W.matrixAutoUpdate=!1,this.debugFrame.value&&(P=U.DebugUtils.createWireframe(L,0),g.add(P)),this.mapSmudgeLayer?.shouldBeBatched(this.gameObject))this.mapSmudgeLayer.addObject(this.gameObject);else{let U;try{U=this.imageFinder.findByObjectArt(this.objectArt)}catch(P){if(P instanceof _.ImageFinder.MissingImageError)return void console.warn(P.message);throw P}let z=new G.MapSpriteTranslation(L.width,L.height),{spriteOffset:K,anchorPointWorld:q}=z.compute();L=K.clone().add(this.objectArt.getDrawOffset());let $=this.builder=new I.ShpBuilder(U,this.palette,this.camera,V.Coords.ISO_WORLD_SCALE);$.setOffset(L),$.flat=this.objectArt.flat,$.setExtraLight(this.extraLight),L=$.build(),W.add(L),W.position.x=q.x,W.position.z=q.y,W.updateMatrix(),g.add(W)}}onRemove(){this.mapSmudgeLayer?.hasObject(this.gameObject)&&this.mapSmudgeLayer.removeObject(this.gameObject)}dispose(){this.builder?.dispose()}})}}}),System.register("engine/renderable/entity/TargetLines",["game/Coords","game/gameobject/task/system/TargetLinesConfig","game/gameobject/unit/ZoneType"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("TargetLines",class{constructor(g,P,L,_,U){this.currentPlayer=g,this.unitSelection=P,this.camera=L,this.debugPaths=_,this.enabled=U,this.unitPaths=new Map,this.unitLines=new Map,this.lineHeadGeometry=new THREE.PlaneGeometry(3*I.Coords.ISO_WORLD_SCALE,3*I.Coords.ISO_WORLD_SCALE)}create3DObject(){this.obj||(this.obj=new THREE.Object3D,this.obj.name="target_lines",this.obj.matrixAutoUpdate=!1,this.attackLineMaterial=new THREE.LineBasicMaterial({color:11337728,transparent:!0,depthTest:!1,depthWrite:!1}),this.moveLineMaterial=new THREE.LineBasicMaterial({color:43520,transparent:!0,depthTest:!1,depthWrite:!1}),this.attackLineHeadMaterial=new THREE.MeshBasicMaterial({color:11337728,transparent:!0,depthTest:!1,depthWrite:!1}),this.moveLineHeadMaterial=new THREE.MeshBasicMaterial({color:43520,transparent:!0,depthTest:!1,depthWrite:!1}))}get3DObject(){return this.obj}forceShow(){this.selectionHash=void 0}update(g){if(this.obj.visible=this.enabled.value,this.enabled.value){var P=this.unitSelection.getHash();if(void 0===this.selectionHash||this.selectionHash!==P)return this.selectionHash=P,this.hideAllLines(),this.unitPaths.clear(),this.disposeUnitLines(),void this.unitSelection.getSelectedUnits().forEach(P=>{!P.isUnit()||this.currentPlayer&&P.owner!==this.currentPlayer||(this.unitPaths.set(P,L.cloneConfig(P.unitOrderTrait.targetLinesConfig)),this.updateLines(P),P.zone!==_.ZoneType.Air&&!L.configHasTarget(P.unitOrderTrait.targetLinesConfig)||this.showLines(P,g))});{let P=!1;if(this.unitSelection.getSelectedUnits().forEach(I=>{if(I.isUnit()&&(!this.currentPlayer||I.owner===this.currentPlayer)){this.unitPaths.has(I)&&L.configsAreEqual(this.unitPaths.get(I),I.unitOrderTrait.targetLinesConfig)||I.unitOrderTrait.targetLinesConfig?.isRecalc||(this.unitPaths.set(I,L.cloneConfig(I.unitOrderTrait.targetLinesConfig)),P=!0,this.updateLines(I),L.configHasTarget(I.unitOrderTrait.targetLinesConfig)&&this.showLines(I,g));let G=this.unitLines.get(I),V=I.position.worldPosition;if(G){var _=!V.equals(G.srcLineHead.position),U=I.unitOrderTrait.targetLinesConfig?.target;let g=U?U.position.worldPosition:void 0;if(U=g&&!g.equals(G.destLineHead.position),_||U){let P=G.line.geometry;P.verticesNeedUpdate=!0,_&&(P.vertices[P.vertices.length-1].copy(V),G.srcLineHead.position.copy(V),G.srcLineHead.updateMatrix()),g&&U&&(P.vertices[0].copy(g),G.destLineHead.position.copy(g),G.destLineHead.updateMatrix())}}}}),P)return}void 0!==this.showStart&&1e3<=g-this.showStart&&this.hideAllLines()}}showLines(g,P){this.showStart=P,this.unitLines.get(g).root.visible=!0}hideAllLines(){this.showStart=void 0,this.unitLines.forEach(g=>g.root.visible=!1)}updateLines(g){let P=g.unitOrderTrait.targetLinesConfig;if(!P||!L.configHasTarget(P)){if(g.zone!==_.ZoneType.Air)return void(this.unitLines.has(g)&&(V=this.unitLines.get(g),this.obj?.remove(V.root),this.disposeLineObjects(V),this.unitLines.delete(g)));P={pathNodes:[{tile:g.tile,onBridge:void 0},{tile:g.tile,onBridge:void 0}]}}let U=new THREE.Geometry,G=P.pathNodes;G.length?(this.debugPaths.value||(G=[G[0],G[G.length-1]]),G.forEach(g=>{var P=I.Coords.tile3dToWorld(g.tile.rx+.5,g.tile.ry+.5,g.tile.z+(g.onBridge?.tileElevation??0));U.vertices.push(P)}),U.vertices[U.vertices.length-1].copy(g.position.worldPosition)):(W=P.target,U.vertices.push(W.position.worldPosition,g.position.worldPosition));var V=!!P.isAttack,W=V?this.attackLineMaterial:this.moveLineMaterial;let z=new THREE.Line(U,W);z.matrixAutoUpdate=!1;let K=this.createLineHead(V);K.position.copy(U.vertices[U.vertices.length-1]),K.matrixAutoUpdate=!1,K.updateMatrix();let q=this.createLineHead(V);q.position.copy(U.vertices[0]),q.matrixAutoUpdate=!1,q.updateMatrix(),z.renderOrder=K.renderOrder=q.renderOrder=1e6;let $=new THREE.Object3D;$.matrixAutoUpdate=!1,$.visible=!1,$.add(z),$.add(K),$.add(q),this.unitLines.has(g)&&(V=this.unitLines.get(g),this.obj?.remove(V.root),this.disposeLineObjects(V)),this.unitLines.set(g,{root:$,line:z,srcLineHead:K,destLineHead:q}),this.obj?.add($)}createLineHead(g){let P=new THREE.Mesh(this.lineHeadGeometry,g?this.attackLineHeadMaterial:this.moveLineHeadMaterial);var I=(new THREE.Quaternion).setFromEuler(this.camera.rotation);return P.setRotationFromQuaternion(I),P}disposeUnitLines(){[...this.unitLines.values()].forEach(g=>this.disposeLineObjects(g)),this.unitLines.clear()}disposeLineObjects(g){g.line.geometry.dispose()}dispose(){this.disposeUnitLines(),this.attackLineMaterial?.dispose(),this.attackLineHeadMaterial?.dispose(),this.moveLineMaterial?.dispose(),this.moveLineHeadMaterial?.dispose(),this.lineHeadGeometry.dispose()}})}}}),System.register("engine/renderable/entity/Terrain",["engine/renderable/WithPosition","engine/ImageFinder","engine/gfx/DebugUtils","engine/renderable/MapSpriteTranslation","engine/renderable/ShpRenderable","game/gameobject/trait/TiberiumTreeTrait","engine/animation/SimpleRunner","engine/AnimProps","engine/Animation","data/IniSection","engine/renderable/AlphaRenderable"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g}],execute:function(){g("Terrain",class{constructor(g,P,I,L,_,U,G,V,W){this.gameObject=g,this.terrainLayer=P,this.imageFinder=I,this.palette=L,this.camera=_,this.lighting=U,this.debugFrame=G,this.gameSpeed=V,this.useSpriteBatching=W,this.objectArt=g.art,this.label="terrain_"+g.rules.name,this.init()}init(){this.tiberiumTreeTrait=this.gameObject.traits.find(V.TiberiumTreeTrait),this.withPosition=new I.WithPosition,this.extraLight=new THREE.Vector3,this.updateLighting()}updateLighting(){this.extraLight.copy(this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile)).addScalar(-1)}get3DObject(){return this.target}create3DObject(){let g=this.get3DObject();g||(g=new THREE.Object3D,g.name=this.label,this.target=g,g.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(g))}setPosition(g){this.withPosition.setPosition(g.x,g.y,g.z)}getPosition(){return this.withPosition.getPosition()}update(g){var P;this.tiberiumTreeTrait&&((P=this.tiberiumTreeTrait.status)!==this.lastTiberiumSpawnStatus&&(this.lastTiberiumSpawnStatus=P)===V.SpawnStatus.Spawning&&this.animationRunner?.animation.reset(),this.animationRunner&&(this.animationRunner.tick(g),this.animationRunner.animation.getState()!==K.AnimationState.STOPPED?this.mainObj.setFrame(this.animationRunner.getCurrentFrame()):this.mainObj.setFrame(0)))}createObjects(g){var P={width:1,height:1};let I;this.debugFrame.value&&(Q=_.DebugUtils.createWireframe(P,2),g.add(Q));try{I=this.imageFinder.findByObjectArt(this.objectArt)}catch(V){if(V instanceof L.ImageFinder.MissingImageError)return void console.warn(V.message);throw V}var V=this.gameObject.rules.alphaImage;if(V){var Q=this.imageFinder.tryFind(V,!1);if(Q){let P=new $.AlphaRenderable(Q,this.camera,this.objectArt.getDrawOffset());P.create3DObject(),g.add(P.get3DObject())}else console.warn(`<${this.gameObject.name}>: Alpha image "${V}" not found`)}if(this.terrainLayer?.shouldBeBatched(this.gameObject))this.terrainLayer.addObject(this.gameObject);else{let L=new THREE.Object3D;L.matrixAutoUpdate=!1;let _=new U.MapSpriteTranslation(P.width,P.height),{spriteOffset:V,anchorPointWorld:$}=_.compute();L.position.x=$.x,L.position.z=$.y,L.updateMatrix(),P=V.clone().add(this.objectArt.getDrawOffset());let Q=G.ShpRenderable.factory(I,this.palette,this.camera,P,this.objectArt.hasShadow);if(Q.setBatched(this.useSpriteBatching),this.useSpriteBatching&&Q.setBatchPalettes([this.palette]),Q.setFrame(0),Q.setExtraLight(this.extraLight),Q.create3DObject(),L.add(Q.get3DObject()),this.mainObj=Q,this.tiberiumTreeTrait){let g=new q.IniSection("dummy");this.gameObject.rules.animationRate&&(g.set("Rate",""+60*this.gameObject.rules.animationRate),g.set("Shadow","yes")),P=new z.AnimProps(g,I);let L=new K.Animation(P,this.gameSpeed);this.animationRunner=new W.SimpleRunner,this.animationRunner.animation=L,L.stop()}g.add(L)}}onRemove(){this.terrainLayer?.hasObject(this.gameObject)&&this.terrainLayer.removeObject(this.gameObject)}dispose(){this.mainObj?.dispose()}})}}}),System.register("engine/renderable/entity/TransientAnim",["engine/renderable/entity/Anim"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.Anim{constructor(g,P,I,L,_,U,G,V,W,z,K){super(g,P,I,L,_,U,G,V,W,void 0,K),this.container=z}update(g){var P;!this.isAnimNotStarted()||(P=this.objectArt.report)&&this.worldSound?.playEffect(P,this.getPosition()),super.update(g),this.isAnimFinished()&&(this.remove(),this.dispose())}remove(){this.container.remove(this)}},g("TransientAnim",L)}}}),System.register("engine/renderable/entity/unit/BlobShadow",["game/Coords","game/gameobject/unit/ZoneType","game/gameobject/infantry/StanceType","engine/gfx/batch/BatchedMesh"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("BlobShadow",G=class r{constructor(g,P,I){this.gameObject=g,this.radius=P,this.useMeshInstancing=I}get3DObject(){return this.obj}create3DObject(){if(!this.obj){let g=r.geometries.get(this.radius);g||(g=new THREE.CircleBufferGeometry(this.radius*I.Coords.ISO_WORLD_SCALE),r.geometries.set(this.radius,g)),this.obj=new(this.useMeshInstancing?U.BatchedMesh:THREE.Mesh)(g,r.mat),this.obj.rotation.x=-Math.PI/2,this.obj.matrixAutoUpdate=!1}}update(g,P){let U=this.obj;var G,V,W=this.gameObject.zone===L.ZoneType.Air||this.gameObject.isInfantry()&&this.gameObject.stance===_.StanceType.Paradrop;(U.visible=W)&&(G=this.gameObject.tile.z,V=this.gameObject.tileElevation,W=!!this.gameObject.tile.onBridgeLandType,G===this.lastTileZ&&V===this.lastTileElevation&&W===this.lastBridgeBelow||(this.lastTileZ=G,this.lastTileElevation=V,this.lastBridgeBelow=W,W=this.gameObject.position.getBridgeBelow(),U.position.y=I.Coords.tileHeightToWorld(-V)+(W?I.Coords.tileHeightToWorld(W.tileElevation)+.01*I.Coords.ISO_WORLD_SCALE:0),U.updateMatrix()))}dispose(){}}),G.geometries=new Map,G.mat=new THREE.MeshBasicMaterial({color:0,transparent:!0,opacity:.5,alphaTest:0})}}}),System.register("engine/renderable/entity/unit/DebugLabel",["engine/gfx/SpriteUtils","engine/gfx/CanvasUtils","game/Coords"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("DebugLabel",class{constructor(g,P,I){this.text=g,this.color=P,this.camera=I}get3DObject(){return this.mesh}create3DObject(){if(!this.mesh){let P=new THREE.Color(this.color);var g=.5<.299*P.r+.587*P.g+.114*P.b?"black":"white";g=this.texture=this.createTexture(this.text,"#"+P.getHexString(),g);this.mesh=this.createMesh(g)}}createMesh(g){var P=I.SpriteUtils.createSpriteGeometry({texture:g,camera:this.camera,align:{x:0,y:-1},offset:{x:0,y:_.Coords.ISO_TILE_SIZE/4},scale:_.Coords.ISO_WORLD_SCALE}),L=new THREE.MeshBasicMaterial({map:g,side:THREE.DoubleSide,transparent:!0,depthTest:!1,flatShading:!0});let U=new THREE.Mesh(P,L);return U.matrixAutoUpdate=!1,U}createTexture(g,P,I){let _=document.createElement("canvas");_.width=_.height=0;let U=_.getContext("2d"),G=0;for(var V of g.split("\n"))G+=(V=L.CanvasUtils.drawText(U,V,0,G,{color:P,outlineColor:I,outlineWidth:2,fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:10,fontWeight:"400",paddingTop:3,paddingBottom:3,paddingLeft:3,paddingRight:3,autoEnlargeCanvas:!0})).height;var W=_.width,z=_.height;z=U.getImageData(0,0,W,z);_.width+=1,_.height+=1,U.putImageData(z,1,1);let K=new THREE.Texture(_);return K.minFilter=THREE.NearestFilter,K.magFilter=THREE.NearestFilter,K.needsUpdate=!0,K.flipY=!0,K}update(){}dispose(){this.texture?.dispose(),this.mesh?.material?.dispose(),this.mesh?.geometry.dispose()}})}}}),System.register("engine/renderable/entity/unit/ExtraLightHelper",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("ExtraLightHelper",class{static multiplyShp(g,P,I){g.copy(P).add(P.clone().addScalar(1).multiplyScalar(I))}static multiplyVxl(g,P,I,L){g.copy(P).addScalar(2*L*I)}})}}}),System.register("engine/renderable/entity/unit/FlyerHelperMode",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("FlyerHelperMode",I={}))[P.Always=0]="Always",P[P.Selected=1]="Selected",P[P.Never=2]="Never"}}}),System.register("engine/renderable/entity/unit/ModelQuality",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("ModelQuality",I={}))[P.Low=0]="Low",P[P.High=1]="High"}}}),System.register("engine/renderable/entity/unit/RotorHelper",["game/gameobject/unit/ZoneType","util/math"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("RotorHelper",class{static computeRotationStep(g,P,_){var U=g.zone===I.ZoneType.Air,G=g.rules.idleRate,V=U||!!_.idleSpeed||!!G;let W=_.speed??67;U||(_.idleSpeed?W=_.idleSpeed:G&&(W/=G));var z=Math.sign(W);U=Math.abs(THREE.Math.degToRad(W)),G=Math.abs(P);return z*L.clamp(G+.1*(V?1:G/U*-.5),0,U)}})}}}),System.register("engine/renderable/entity/unit/ShadowQuality",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("ShadowQuality",I={}))[P.Off=0]="Off",P[P.Low=1]="Low",P[P.Medium=2]="Medium",P[P.High=3]="High"}}}),System.register("engine/renderable/entity/Vehicle",["liang-barsky","game/gameobject/Vehicle","game/Coords","engine/renderable/WithPosition","engine/gfx/DebugUtils","engine/renderable/ShpRenderable","engine/ImageFinder","engine/renderable/MapSpriteTranslation","engine/Animation","engine/AnimProps","data/IniSection","engine/animation/SimpleRunner","util/math","engine/type/ObjectType","game/type/SpeedType","engine/renderable/entity/HighlightAnimRunner","game/gameobject/unit/VeteranLevel","game/gameobject/trait/HarvesterTrait","game/gameobject/common/DeathType","game/gameobject/unit/FacingUtil","game/gameobject/unit/ZoneType","engine/renderable/entity/InvulnerableAnimRunner","game/GameSpeed","engine/renderable/entity/BoxIntersectObject3D","engine/renderable/entity/unit/RotorHelper","engine/renderable/entity/unit/ExtraLightHelper","engine/renderable/DebugRenderable","engine/gfx/MathUtils"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce,he,ue,de,ge,pe;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g},function(g){ce=g},function(g){he=g},function(g){ue=g},function(g){de=g}],execute:function(){var P;ge=Math.PI/4,(P=pe=pe||{})[P.Grab=0]="Grab",P[P.Shake1=1]="Shake1",P[P.Shake2=2]="Shake2",g("Vehicle",class{constructor(g,P,I,L,_,G,V,W,z,K,q,$,Q,Y,Z,X,ee){this.gameObject=g,this.rules=P,this.imageFinder=L,this.voxels=G,this.voxelAnims=V,this.palette=W,this.camera=z,this.lighting=K,this.debugFrame=q,this.gameSpeed=$,this.selectionModel=Q,this.vxlBuilderFactory=Y,this.useSpriteBatching=Z,this.pipOverlay=X,this.worldSound=ee,this.rotorSpeeds=[],this.vxlBuilders=[],this.highlightAnimRunner=new J.HighlightAnimRunner(this.gameSpeed),this.invulnAnimRunner=new ne.InvulnerableAnimRunner(this.gameSpeed),this.plugins=[],this.objectRules=g.rules,this.objectArt=g.art,this.label="vehicle_"+this.objectRules.name,this.paletteRemaps=[...this.rules.colors.values()].map(g=>this.palette.clone().remap(g)),this.palette.remap(this.gameObject.owner.color),this.lastOwnerColor=this.gameObject.owner.color,this.updateBaseLight(),this.vxlExtraLight=(new THREE.Vector3).copy(this.baseVxlExtraLight),this.shpExtraLight=(new THREE.Vector3).copy(this.baseShpExtraLight),this.withPosition=new U.WithPosition}updateBaseLight(){this.baseShpExtraLight=this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation).addScalar(-1).addScalar(this.rules.audioVisual.extraUnitLight),this.baseVxlExtraLight=(new THREE.Vector3).addScalar(this.lighting.computeNoAmbient(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation)+this.rules.audioVisual.extraUnitLight)}registerPlugin(g){this.plugins.push(g)}updateLighting(){this.plugins.forEach(g=>g.updateLighting?.()),this.updateBaseLight(),this.vxlExtraLight.copy(this.baseVxlExtraLight),this.shpExtraLight.copy(this.baseShpExtraLight)}get3DObject(){return this.target}create3DObject(){let g=this.get3DObject();g||(g=new le.BoxIntersectObject3D(new THREE.Vector3(1,1/3,1).multiplyScalar(_.Coords.LEPTONS_PER_TILE)),g.name=this.label,g.userData.id=this.gameObject.id,this.target=g,g.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(g),this.vxlBuilders.forEach(g=>g.setExtraLight(this.vxlExtraLight)),this.shpRenderable?.setExtraLight(this.shpExtraLight),this.pipOverlay&&(this.pipOverlay.create3DObject(),this.posObj?.add(this.pipOverlay.get3DObject())))}updateClippingPlanes(g,P=!1){if(P||this.objectRules.naval&&!this.objectRules.underwater){var I=_.Coords.tileHeightToWorld(g);let P=[new THREE.Plane(new THREE.Vector3(0,1,0),-I)];this.vxlBuilders.forEach(g=>g.setClippingPlanes(P))}}getIntersectTarget(){return this.target}getUiName(){var g=this.plugins.reduce((g,P)=>P.getUiNameOverride?.()??g,void 0);return void 0!==g?g:this.gameObject.getUiName()}setPosition(g){this.withPosition.setPosition(g.x,g.y,g.z)}getPosition(){return this.withPosition.getPosition()}highlight(){this.plugins.some(g=>g.shouldDisableHighlight?.())||this.highlightAnimRunner.animation.getState()!==K.AnimationState.RUNNING&&this.highlightAnimRunner.animate(2)}update(g,P=0){this.plugins.forEach(P=>P.update(g)),this.pipOverlay?.update(g),this.gameObject.veteranLevel!==this.lastVeteranLevel&&(this.gameObject.veteranLevel===ee.VeteranLevel.Elite&&void 0!==this.lastVeteranLevel&&this.highlightAnimRunner.animate(30),this.lastVeteranLevel=this.gameObject.veteranLevel);var I=this.gameObject.tile.z+this.gameObject.tileElevation,L=void 0===this.lastElevation||this.lastElevation!==I;L&&(this.lastElevation=I,this.updateBaseLight(),this.updateClippingPlanes(this.gameObject.tile.z));var U=this.gameObject.invulnerableTrait.isActive(),G=U!==this.lastInvulnerable;this.lastInvulnerable=U;var V=this.highlightAnimRunner.shouldUpdate();V&&this.highlightAnimRunner.tick(g),U&&G&&this.invulnAnimRunner.animate(),this.invulnAnimRunner.shouldUpdate()&&this.invulnAnimRunner.tick(g);var W=this.gameObject.warpedOutTrait.isActive(),z=W!==this.lastWarpedOut;this.lastWarpedOut=W;var Y=this.gameObject.cloakableTrait?.isCloaked(),Z=Y!==this.lastCloaked;this.lastCloaked=Y;let X=this.gameObject.submergibleTrait?.isSubmerged();if(I=X!==this.lastSubmerged,this.lastSubmerged=X,z||Z||I){let g=W||Y||X?.5:1;this.shpRenderable?.setOpacity(g),this.shpRenderable?.setFlat(!!X),this.vxlBuilders.forEach(P=>{P.setOpacity(g),P.setShadow(!X)}),this.placeholder?.setOpacity(g)}if((L||G||U||V)&&(J=U?this.invulnAnimRunner.getValue():0,se=(V?this.highlightAnimRunner.getValue():0)||J,te=this.lighting.getAmbientIntensity(),he.ExtraLightHelper.multiplyVxl(this.vxlExtraLight,this.baseVxlExtraLight,te,se),he.ExtraLightHelper.multiplyShp(this.shpExtraLight,this.baseShpExtraLight,se)),this.gameObject.isDestroyed&&this.resolveObjectRemove){if(this.squidGrabAnim&&(this.posObj?.remove(this.squidGrabAnim.get3DObject()),this.squidGrabAnim.dispose(),this.squidGrabAnim=void 0),this.destroyStartTime||(this.destroyStartTime=g),this.isSinker()){(oe=1<=(ne=(g-this.destroyStartTime)/3e3))?this.mainObj.visible=!1:(this.objectRules.naval&&(this.mainObj.rotation.x=Math.PI/4*ne),this.mainObj.position.y=-16*_.Coords.ISO_WORLD_SCALE*ne,this.mainObj.position.z=8*_.Coords.ISO_WORLD_SCALE*ne,this.mainObj.updateMatrix());let P=!1;this.sinkWakeAnims.forEach(P=>P.update(g)),this.sinkWakeAnims.filter(g=>!g.isAnimFinished()).length||(this.sinkWakeAnims.forEach(g=>this.get3DObject().remove(g.get3DObject())),this.sinkWakeAnims.length=0,P=!0),oe&&P&&this.resolveObjectRemove()}}else if(!this.gameObject.warpedOutTrait.isActive()){let I=(Math.floor(this.gameObject.direction+this.gameObject.spinVelocity*P)+360)%360;var J=I!==this.lastDirection;J&&void 0!==this.lastDirection&&this.objectArt.isVoxel&&this.gameObject.zone===ae.ZoneType.Air&&(le=I-this.lastDirection,void 0!==this.lastDirectionDelta&&Math.abs(le)<2&&Math.abs(this.lastDirectionDelta)<2&&Math.sign(le)!==Math.sign(this.lastDirectionDelta)?I=this.lastDirection:this.lastDirectionDelta=le),this.lastDirection=I;var te=this.gameObject.owner.color;this.lastOwnerColor!==te&&(this.palette.remap(te),this.lastOwnerColor=te,this.vxlBuilders.forEach(g=>g.setPalette(this.palette)),this.shpRenderable?.setPalette(this.palette),this.placeholder?.setPalette(this.palette));var re,se=this.gameObject.isMoving||!this.objectArt.isVoxel&&!!this.gameObject.spinVelocity,ne=this.gameObject.isFiring,oe=void 0===this.lastMoving||this.lastMoving!==se,le=void 0===this.lastFiring||this.lastFiring!==ne;if(0<P&&(se||oe)){te=this.gameObject.moveTrait.velocity.clone().multiplyScalar(P).add(this.gameObject.position.worldPosition),this.setPosition(te)}let L;if((oe||le)&&(this.lastMoving=se,this.lastFiring=ne,this.objectArt.isVoxel||this.updateShapeAnimation(se,ne)),this.gameObject.rules.isChargeTurret){if(le&&ne){this.chargeTurretRunner=new Q.SimpleRunner;let g=new q.AnimProps(new $.IniSection("dummy"),this.gameObject.rules.turretCount);g.reverse=!0,g.rate=5;var ce=new K.Animation(g,this.gameSpeed);this.chargeTurretRunner.animation=ce}this.chargeTurretRunner?.tick(g);var ue=this.chargeTurretRunner?.getCurrentFrame()??0;L=ue!==this.currentTurretIdx,this.currentTurretIdx=ue,this.chargeTurretRunner?.animation.getState()===K.AnimationState.STOPPED&&(this.chargeTurretRunner=void 0)}else L=this.gameObject.turretNo!==this.currentTurretIdx,this.currentTurretIdx=this.gameObject.turretNo;this.objectArt.isVoxel?(this.updateVxlRotation(I,J),this.updateBodyVxl(),ce=(le=this.gameObject.rocking?.facing)!==this.lastRockingFacing,this.lastRockingFacing=le,!ce||void 0===le||0<(re=this.gameObject.rocking.factor)&&this.startRocking(le,re,g),re=(ue=!(!this.gameObject.parasiteableTrait?.isInfested()||!this.gameObject.parasiteableTrait.getParasite()?.rules.organic))!==this.lastSquidGrabbed,this.lastSquidGrabbed=ue,this.updateRocking(g,ue),this.gameObject.turretTrait&&1<this.objectRules.turretCount&&L&&this.updateActiveTurret(this.currentTurretIdx),this.updateSquidGrab(g,ue,re,J,I,le,ce)):this.shpAnimRunner&&(this.shpAnimRunner.tick(g),this.updateShapeFrame(I,se,ne))}}updateVxlRotation(g,P){var I,L=this.gameObject.tilterTrait?.tilt??{yaw:0,pitch:0};this.lastTilt&&L.pitch===this.lastTilt.pitch&&L.yaw===this.lastTilt.yaw&&!P||(this.lastTilt=L,this.tiltObj.rotation.y=THREE.Math.degToRad(L.yaw),this.tiltObj.rotation.x=THREE.Math.degToRad(L.pitch),this.tiltObj.updateMatrix(),this.dirWrapObj.rotation.y=THREE.Math.degToRad(g-L.yaw),this.dirWrapObj.updateMatrix()),this.turret&&(L=(I=Math.floor(this.gameObject.turretTrait.facing))!==this.lastTurretFacing,this.lastTurretFacing=I,(L||P)&&(I=THREE.Math.degToRad(I-g),this.turret.rotation.y=I,this.turret.updateMatrix(),this.barrel&&(this.barrel.rotation.y=I,this.barrel.updateMatrix()))),this.rotors&&this.rotors.forEach((g,P)=>{this.rotorSpeeds[P]=ce.RotorHelper.computeRotationStep(this.gameObject,this.rotorSpeeds[P]??0,this.objectArt.rotors[P]),this.rotorSpeeds[P]&&(g.rotateOnAxis(this.objectArt.rotors[P].axis,this.rotorSpeeds[P]),g.updateMatrix())})}startRocking(g,P,L){if(this.bodyVxlBuilder){this.rockingStartTime=L,this.rockingFactor=P;var _=this.bodyVxlBuilder.getLocalBoundingBox();let G=new THREE.Box2(new THREE.Vector2(_.min.x,_.min.y),new THREE.Vector2(_.max.x,_.max.y));var U=THREE.Math.degToRad(se.FacingUtil.toWorldDeg(g));_=new THREE.Vector2;let V=new THREE.Vector2(10,0).rotateAround(new THREE.Vector2,U).setLength(G.getSize(_).length()+1);_=V.toArray(),I.default([0,0],_,[G.min.x,G.min.y,G.max.x,G.max.y]),this.rockingPoint=new THREE.Vector3(_[0],0,_[1]),_=V.clone().rotateAround(new THREE.Vector2,-Math.PI/2).normalize(),this.rockingAxis=new THREE.Vector3(_.x,0,_.y)}}updateRocking(g,P){if(this.rockingStartTime){var I=g-this.rockingStartTime;let U=this.rockingFactor;P||(U*=1-Math.min(1,this.gameObject.rules.weight/5));var _=I||U?Math.min(1,I/(L.ROCKING_TICKS/oe.GameSpeed.BASE_TICKS_PER_SECOND*1e3)*this.gameSpeed.value/U):0;I=ge*U*(1-Math.pow(2*(_-.5),2));this.rockingTiltObj.position.set(0,0,0),this.rockingTiltObj.rotation.set(0,0,0),this.rockingTiltObj.scale.set(1,1,1),de.MathUtils.rotateObjectAboutPoint(this.rockingTiltObj,this.rockingPoint,this.rockingAxis,I),this.rockingTiltObj.updateMatrix(),1!==_&&0!==U||(this.rockingStartTime=void 0)}}updateSquidGrab(g,P,I,L,U,G,V){var W;if(I&&(this.squidGrabAnim&&(this.posObj?.remove(this.squidGrabAnim.get3DObject()),this.squidGrabAnim.dispose(),this.squidGrabAnim=void 0),P&&(this.squidGrabAnim=this.renderableManager.createAnim("SQDG",g=>{g.extraOffset={x:0,y:-_.Coords.ISO_TILE_SIZE/4},g.setExtraLight(this.shpExtraLight)},!0),this.squidGrabAnim.remapColor(this.gameObject.parasiteableTrait.getParasite().owner.color),this.squidGrabAnim.create3DObject(),this.posObj?.add(this.squidGrabAnim.get3DObject()))),P&&(L||I)&&this.updateSquidGrabAnim(this.squidGrabAnim.getAnimProps(),U,pe.Grab),P&&V&&G&&(W=0<G?pe.Shake1:pe.Shake2,this.updateSquidGrabAnim(this.squidGrabAnim.getAnimProps(),U,W),this.squidGrabAnim.reset()),P&&V&&!G){var z=this.rules.combatDamage.splashList;for(let g=0;g<3;g++){var K=z[Y.getRandomInt(0,z.length-1)];this.renderableManager.createTransientAnim(K,g=>{let P=this.withPosition.getPosition().clone();var I={x:Y.getRandomInt(-_.Coords.ISO_TILE_SIZE/2,_.Coords.ISO_TILE_SIZE/2)*_.Coords.ISO_WORLD_SCALE,y:Y.getRandomInt(-_.Coords.ISO_TILE_SIZE/2,_.Coords.ISO_TILE_SIZE/2)*_.Coords.ISO_WORLD_SCALE};g.setPosition(P.add(new THREE.Vector3(I.x,0,I.y)))})}}this.squidGrabAnim?.update(g)}updateShapeAnimation(g,P){if(this.shpAnimRunner){let L=this.shpAnimRunner.animation.props;var I;P?(L.loopEnd=this.objectArt.firingFrames-1,L.rate=q.AnimProps.defaultRate/2):g||this.objectRules.naval?(L.loopEnd=this.objectArt.walkFrames-1,I=this.objectRules.naval&&!g?this.objectRules.idleRate:this.objectRules.walkRate,L.rate=q.AnimProps.defaultRate/I):L.loopEnd=this.objectArt.standingFrames-1,this.shpAnimRunner.animation.rewind()}}updateShapeFrame(g,P,I){if(this.shpRenderable&&this.shpAnimRunner){let U;var L=this.objectArt.facings,_=Math.round((45-g+360)%360/360*L)%L;L=this.shpAnimRunner.animation.getCurrentFrame();U=I?this.objectArt.startFiringFrame+this.objectArt.firingFrames*_+L:P||this.objectRules.naval?this.objectArt.startWalkFrame+this.objectArt.walkFrames*_+L:this.objectArt.startStandFrame+this.objectArt.standingFrames*_+L,this.shpRenderable.setFrame(U)}}updateSquidGrabAnim(g,P,I){var _=Math.round((360-P)%360/360*8)%8;g.start=10*_+80*I,g.end=10*_+9+80*I,g.loopStart=g.start,g.loopEnd=g.end,g.loopCount=0,g.rate=10/(L.ROCKING_TICKS/oe.GameSpeed.BASE_TICKS_PER_SECOND/(this.rockingFactor??1))}createObjects(g){if(this.debugFrame.value){let P=G.DebugUtils.createWireframe({width:1,height:1},1);P.translateX(-_.Coords.getWorldTileSize()/2),P.translateZ(-_.Coords.getWorldTileSize()/2),g.add(P)}let P=this.tiltObj=new THREE.Object3D;P.matrixAutoUpdate=!1,P.rotation.order="YXZ";let I=this.dirWrapObj=new THREE.Object3D;I.matrixAutoUpdate=!1;var L=this.mainObj=this.createMainObject();let U=this.rockingTiltObj=new THREE.Object3D;U.matrixAutoUpdate=!1,U.rotation.order="YXZ",U.add(L),I.add(U),P.add(I);let V=this.posObj=new THREE.Object3D;V.matrixAutoUpdate=!1,V.add(P),g.add(V)}computeSpriteAnchorOffset(g){var P=this.objectArt.getDrawOffset();return{x:g.x+P.x,y:g.y+P.y}}createMainObject(){let g=new THREE.Object3D;if(g.matrixAutoUpdate=!1,this.objectArt.isVoxel){var P=!this.objectArt.noHva,I=this.objectArt.imageName.toLowerCase(),L=I+".vxl",_=this.voxels.get(L);if(_){var U=P?this.voxelAnims.get(I+".hva"):void 0;let L=this.bodyVxlBuilder=this.vxlBuilderFactory.create(_,U,this.paletteRemaps,this.palette);this.vxlBuilders.push(L),U=this.mainVxl=L.build(),g.add(U),this.objectArt.rotors&&(this.rotors=this.objectArt.rotors.map(g=>{var P=L.getSection(g.name);if(!P)throw new Error(`Vehicle "${this.objectRules.name}" VXL section "${g.name}" not found`);return P}))}else console.warn(`VXL missing for vehicle ${this.objectRules.name}. Vxl file ${L} not found. `),g.add(this.createPlaceholder());if(this.objectRules.spawns&&this.objectRules.noSpawnAlt){let L=I+"wo.vxl";if(Y=this.voxels.get(L)){var G=P?this.voxelAnims.get(L.replace(".vxl",".hva")):void 0;let I=this.vxlBuilderFactory.create(Y,G,this.paletteRemaps,this.palette);this.vxlBuilders.push(I);let _=this.noSpawnAltVxl=I.build();_.visible=!1,g.add(_)}else console.warn(`<${this.gameObject.name}>: Couldn't find noSpawnAlt image "${L}"`)}if(this.gameObject.harvesterTrait&&this.objectRules.unloadingClass){var Y,X=this.rules.hasObject(this.objectRules.unloadingClass,Z.ObjectType.Vehicle)?this.rules.getObject(this.objectRules.unloadingClass,Z.ObjectType.Vehicle).imageName.toLowerCase():void 0;if(Y=X?this.voxels.get(X+".vxl"):void 0){G=P?this.voxelAnims.get(X+".hva"):void 0;let I=this.vxlBuilderFactory.create(Y,G,this.paletteRemaps,this.palette);this.vxlBuilders.push(I);let L=this.harvesterAltVxl=I.build();L.visible=!1,g.add(L)}else console.warn(`<${this.gameObject.name}>: Couldn't find UnloadingClass image "${X}.vxl"`)}if(this.gameObject.turretTrait){let L=g;if(X=this.objectArt.turretOffset){let P=new THREE.Object3D;P.matrixAutoUpdate=!1,P.position.z=-X,P.updateMatrix(),g.add(P),L=P}let _,U=[];for(let g=0;g<this.objectRules.turretCount;++g){let L=I+`tur${g||""}.vxl`;var J=this.voxels.get(L);if(J){var ee=P?this.voxelAnims.get(L.replace(".vxl",".hva")):void 0;let I=this.vxlBuilderFactory.create(J,ee,this.paletteRemaps,this.palette);this.vxlBuilders.push(I);let _=I.build();_.visible=g===this.gameObject.turretNo,U.push(_)}else console.warn(`<${this.gameObject.name}>: Missing turret file "${L}"`),U.push(void 0)}this.currentTurretIdx=this.gameObject.turretNo,this.allTurrets=U,1<U.length?(_=this.turret=new THREE.Object3D,_.matrixAutoUpdate=!1,U.forEach(g=>g&&_.add(g))):_=this.turret=U[0],_&&L.add(_);let G=I+"barl.vxl";if(X=this.voxels.get(G)){var te=P?this.voxelAnims.get(G.replace(".vxl",".hva")):void 0;let g=this.vxlBuilderFactory.create(X,te,this.paletteRemaps,this.palette);this.vxlBuilders.push(g);var re=this.barrel=g.build();L.add(re)}}}else{let P=new z.MapSpriteTranslation(1,1);var{spriteOffset:te,anchorPointWorld:re}=P.compute();te=this.computeSpriteAnchorOffset(te);let L;try{L=this.imageFinder.findByObjectArt(this.objectArt)}catch(I){if(!(I instanceof W.ImageFinder.MissingImageError))throw I;console.warn(`<${this.gameObject.name}>: `+I.message)}if(L){let P=this.shpRenderable=V.ShpRenderable.factory(L,this.palette,this.camera,te,this.objectArt.hasShadow);P.setBatched(this.useSpriteBatching),this.useSpriteBatching&&P.setBatchPalettes(this.paletteRemaps),P.create3DObject(),g.add(P.get3DObject()),g.position.x=re.x,g.position.z=re.y,g.updateMatrix();let I=new q.AnimProps(new $.IniSection("dummy"),L);I.loopCount=-1,re=new K.Animation(I,this.gameSpeed),this.shpAnimRunner=new Q.SimpleRunner,this.shpAnimRunner.animation=re}else g.add(this.createPlaceholder())}return g}createPlaceholder(){return this.placeholder=new ue.DebugRenderable({width:.5,height:.5},this.objectArt.height,this.palette,{centerFoundation:!0}),this.placeholder.setBatched(this.useSpriteBatching),this.useSpriteBatching&&this.placeholder.setBatchPalettes(this.paletteRemaps),this.placeholder.create3DObject(),this.placeholder.get3DObject()}updateActiveTurret(g){this.allTurrets.forEach((P,I)=>{P&&(P.visible=I===g)})}updateBodyVxl(){var g=!!this.noSpawnAltVxl&&!this.gameObject.airSpawnTrait.availableSpawns,P=!!this.harvesterAltVxl&&!!this.gameObject.harvesterTrait&&[te.HarvesterStatus.PreparingToUnload,te.HarvesterStatus.Unloading].includes(this.gameObject.harvesterTrait.status);this.noSpawnAltVxl&&(this.noSpawnAltVxl.visible=g),this.harvesterAltVxl&&(this.harvesterAltVxl.visible=P),this.mainVxl&&(this.mainVxl.visible=!g&&!P)}isSinker(){return this.gameObject.zone===ae.ZoneType.Water&&this.gameObject.isSinker}onCreate(g){this.renderableManager=g,this.plugins.forEach(P=>P.onCreate(g)),this.objectRules.ambientSound&&(this.ambientSound=this.worldSound?.playEffect(this.objectRules.ambientSound,this.gameObject))}onRemove(g){if(this.renderableManager=void 0,this.plugins.forEach(P=>P.onRemove(g)),this.ambientSound?.stop(),this.gameObject.isDestroyed&&this.gameObject.isVehicle()&&this.get3DObject()){if(this.gameObject.deathType===re.DeathType.Temporal)return;if(this.gameObject.deathType===re.DeathType.None)return;if(this.gameObject.deathType===re.DeathType.Crush)return;if(!this.isSinker()||this.objectRules.underwater||this.gameObject.deathType!==re.DeathType.Sink&&this.objectRules.speedType===X.SpeedType.Hover){if(this.objectRules.underwater&&this.objectRules.organic)return;if(!this.objectRules.explosion.length)return;if(this.gameObject.explodes&&this.objectRules.deathWeapon)return;var P=(P=this.objectRules.explosion)[Y.getRandomInt(0,P.length-1)];return void g.createTransientAnim(P,g=>g.setPosition(this.withPosition.getPosition()))}if(this.isSinker()){var I=this.rules.audioVisual.wake;this.sinkWakeAnims=[];for(let P=0;P<5;P++){let P=g.createAnim(I,void 0,!0);var L={x:Y.getRandomInt(-15,15)*_.Coords.ISO_WORLD_SCALE,y:Y.getRandomInt(-15,15)*_.Coords.ISO_WORLD_SCALE};P.setPosition(new THREE.Vector3(L.x,0,L.y)),this.sinkWakeAnims.push(P),P.create3DObject(),this.get3DObject().add(P.get3DObject())}this.gameObject.rules.naval||this.updateClippingPlanes(this.gameObject.tile.z,!0)}return new Promise(g=>this.resolveObjectRemove=g)}}dispose(){this.plugins.forEach(g=>g.dispose()),this.pipOverlay?.dispose(),this.shpRenderable?.dispose(),this.vxlBuilders.forEach(g=>g.dispose()),this.sinkWakeAnims?.forEach(g=>g.dispose()),this.squidGrabAnim?.dispose(),this.placeholder?.dispose()}})}}}),System.register("engine/renderable/entity/WaypointLine",["three.meshline","game/Coords"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("WaypointLine",class{constructor(g,P){this.linePath=g,this.camera=P,this.lastColor=this.linePath.color,this.lastBgColor=this.linePath.bgColor,this.lineHeadMaterial=new THREE.PointsMaterial({size:6,sizeAttenuation:!1,color:g.color,depthTest:!1,depthWrite:!1,transparent:!0}),this.lineHeadBgMaterial=new THREE.PointsMaterial({size:8,sizeAttenuation:!1,color:g.bgColor,depthTest:!1,depthWrite:!1,transparent:!0})}get3DObject(){return this.wrapper}create3DObject(){if(!this.wrapper){this.wrapper=new THREE.Object3D,this.wrapper.name="waypoint_line";let g=this.meshLine=new I.MeshLine,P=this.linePath.vertices.filter(g=>g.enabled).map(g=>g.position);this.lastLineVertexCount=P.length,g.setGeometry(P.map(g=>[g.x,g.y,g.z]).flat()),this.fgLineMesh=new THREE.Mesh(g.geometry,this.createFgLineMaterial(new THREE.Color(this.linePath.color),this.computeLineLength(P))),this.fgLineMesh.renderOrder=1000002,this.wrapper.add(this.fgLineMesh),this.bgLineMesh=new THREE.Mesh(g.geometry,this.createBgLineMaterial(new THREE.Color(this.linePath.bgColor))),this.bgLineMesh.renderOrder=1000001,this.wrapper.add(this.bgLineMesh),this.lineHeadMeshes=this.createLineHeads(this.linePath.vertices.filter(g=>g.enabled&&g.lineHead).map(g=>g.position)),this.lineHeadMeshes.forEach(g=>this.wrapper.add(g))}}update(g){this.lastUpdateMillis||(this.lastUpdateMillis=g);let P=(g-this.lastUpdateMillis)/(1e3/120);this.lastUpdateMillis=g;var I=this.camera.top+"_"+this.camera.right;if(I!==this.cameraHash&&(this.cameraHash=I,[this.fgLineMesh,this.bgLineMesh].forEach(g=>{g.material.uniforms.resolution.value.copy(this.computeResolution(this.camera))})),this.linePath.verticesNeedUpdate){this.linePath.verticesNeedUpdate=!1;let g=this.linePath.vertices.filter(g=>g.enabled).map(g=>g.position);this.lastLineVertexCount!==g.length&&(this.lastLineVertexCount=g.length,this.meshLine.attributes=void 0),this.meshLine.setGeometry(g.map(g=>[g.x,g.y,g.z]).flat());let P=this.computeLineLength(g);[this.fgLineMesh].forEach(g=>{g.material.uniforms.dashArray.value=this.computeDashArray(P)}),this.updateLineHeads(this.linePath.vertices.filter(g=>g.enabled&&g.lineHead).map(g=>g.position))}this.linePath.color!==this.lastColor&&(this.lastColor=this.linePath.color,this.fgLineMesh.material.uniforms.color.value=new THREE.Color(this.linePath.color),this.lineHeadMaterial.color.set(this.linePath.color)),this.linePath.bgColor!==this.lastBgColor&&(this.lastBgColor=this.linePath.bgColor,this.bgLineMesh.material.uniforms.color.value=new THREE.Color(this.linePath.bgColor),this.lineHeadBgMaterial.color.set(this.linePath.bgColor)),[this.fgLineMesh].forEach(g=>{let I=g.material;I.uniforms.dashOffset.value-=I.uniforms.dashArray.value/50*P})}computeLineLength(g){let P=0;for(let I=1,L=g.length;I<L;I++)P+=g[I].distanceTo(g[I-1]);return P}createFgLineMaterial(g,P){return new I.MeshLineMaterial({color:g,lineWidth:2,resolution:this.computeResolution(this.camera),transparent:!0,sizeAttenuation:0,dashArray:this.computeDashArray(P),depthTest:!1})}createBgLineMaterial(g){return new I.MeshLineMaterial({color:g,lineWidth:4,resolution:this.computeResolution(this.camera),transparent:!0,sizeAttenuation:0,depthTest:!1})}computeDashArray(g){return Math.min(1,5/g)*L.Coords.ISO_WORLD_SCALE}computeResolution(g){var P=g.top,I=g.right/g.top,_=2*P/Math.cos(g.rotation.y);return new THREE.Vector2(_*I,_).multiplyScalar(P*Math.cos(this.camera.rotation.x)/L.Coords.ISO_WORLD_SCALE)}createLineHeads(g){let P=new THREE.BufferGeometry;P.addAttribute("position",new THREE.BufferAttribute(new Float32Array(g.map(g=>[g.x,g.y,g.z]).flat()),3));let I=new THREE.Points(P,this.lineHeadMaterial);I.renderOrder=1000004;let L=new THREE.Points(P,this.lineHeadBgMaterial);return L.renderOrder=1000003,[I,L]}updateLineHeads(g){var P=g.map(g=>[g.x,g.y,g.z]).flat();let I=this.lineHeadMeshes[0].geometry,L=I.getAttribute("position");if(L.array.length!==P.length)I.addAttribute("position",new THREE.BufferAttribute(new Float32Array(P),3));else{let g=L.array;for(let I=0,L=g.length;I<L;I++)g[I]=P[I];L.needsUpdate=!0}}dispose(){[this.fgLineMesh,this.bgLineMesh].forEach(g=>{g&&(g.geometry.dispose(),g.material.dispose())}),this.lineHeadMeshes?.forEach(g=>g.geometry.dispose()),this.lineHeadMaterial.dispose(),this.lineHeadBgMaterial.dispose()}})}}}),System.register("engine/renderable/entity/WaypointLines",["game/Coords","game/gameobject/task/system/TargetLinesConfig","util/array","engine/renderable/entity/WaypointLine"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){var P;(P=G=G||{})[P.Source=0]="Source",P[P.InitialTarget=1]="InitialTarget",P[P.Waypoint=2]="Waypoint",g("WaypointLines",class{constructor(g,P,I,L,_){this.unitSelection=g,this.currentPlayer=P,this.selectedPaths=I,this.paths=L,this.camera=_,this.lastPathWaypoints=new Map,this.sourceLinePaths=new Map,this.waypointLinePaths=new Map}create3DObject(){this.obj||(this.obj=new THREE.Object3D,this.obj.name="waypoint_lines",this.obj.matrixAutoUpdate=!1)}get3DObject(){return this.obj}update(g){var P=this.unitSelection.getHash(),I=void 0===this.selectionHash||this.selectionHash!==P;I&&(this.selectionHash=P);let L=!this.lastPaths||!_.equals(this.lastPaths,this.paths);if(L)this.lastPaths=[...this.paths];else for(var G of this.paths){var V=this.lastPathWaypoints.get(G);if(!V||!_.equals(G.waypoints,V)){L=!0,this.lastPathWaypoints.set(G,[...G.waypoints]);break}}if(I||L){let P=[],I=this.unitSelection.getSelectedUnits();1===I.length&&I[0].owner!==this.currentPlayer&&(I=[]),P=this.paths.length?[...new Set([...this.paths.map(g=>[...g.units]).flat(),...I])]:I,P=P.filter(g=>g.isSpawned),[...this.sourceLinePaths.values(),...this.waypointLinePaths.values()].forEach(g=>{let P=g.lineObj;P&&(this.obj.remove(P.get3DObject()),P.dispose())}),this.sourceLinePaths.clear(),this.waypointLinePaths.clear();for(let I of P)if(I.isUnit()){let P=this.createSourceLinePath(I,this.paths.find(g=>g.units.has(I)));this.sourceLinePaths.set(I,P),P.lineObj=new U.WaypointLine(P,this.camera),P.lineObj.create3DObject(),this.obj.add(P.lineObj.get3DObject()),P.lineObj.update(g)}for(var W of this.paths){let P=this.createWaypointLinePath(W,this.selectedPaths.includes(W));this.waypointLinePaths.set(W,P),P.lineObj=new U.WaypointLine(P,this.camera),P.lineObj.create3DObject(),this.obj.add(P.lineObj.get3DObject()),P.lineObj.update(g)}}else this.sourceLinePaths.forEach((P,I)=>{this.updateSourceLinePath(P,I,this.paths.find(g=>g.units.has(I))),P.lineObj.update(g)}),this.waypointLinePaths.forEach(P=>{this.updateWaypointLinePath(P),P.lineObj.update(g)})}createSourceLinePath(g,P){var I=!!g.unitOrderTrait.targetLinesConfig&&L.configHasTarget(g.unitOrderTrait.targetLinesConfig);let _=g.unitOrderTrait.waypointPath?P?.waypoints.find(P=>P.original===(g.unitOrderTrait.currentWaypoint??g.unitOrderTrait.waypointPath.waypoints[0])):P?.waypoints.find(g=>g.draft),U={vertices:[],verticesNeedUpdate:!1,color:10867711,bgColor:this.unitSelection.isSelected(g)?16777215:0};var V={type:G.Source,enabled:I||!!_,lineHead:!0,obj:g,position:g.position.worldPosition.clone()};I={type:G.InitialTarget,enabled:I&&(!g.unitOrderTrait.waypointPath||!g.unitOrderTrait.currentWaypoint),lineHead:!0,obj:g,position:I?this.computeInitialTargetPosition(g.unitOrderTrait.targetLinesConfig).clone():new THREE.Vector3};return U.vertices.push(V,I),_&&(I={type:G.Waypoint,enabled:!0,lineHead:!1,waypoint:_,position:_.target.getWorldCoords().clone()},U.vertices.push(I)),U}updateSourceLinePath(g,P,I){var _,U=P.unitOrderTrait.waypointPath?I?.waypoints.find(g=>g.original===(P.unitOrderTrait.currentWaypoint??P.unitOrderTrait.waypointPath.waypoints[0])):I?.waypoints.find(g=>g.draft),V=!!U,W=!!P.unitOrderTrait.targetLinesConfig&&L.configHasTarget(P.unitOrderTrait.targetLinesConfig);for(_ of g.vertices){let I,L;_.type===G.Source?(I=V||W,L=P.position.worldPosition):_.type===G.InitialTarget?(I=W&&(!P.unitOrderTrait.waypointPath||!P.unitOrderTrait.currentWaypoint),W&&(L=this.computeInitialTargetPosition(_.obj.unitOrderTrait.targetLinesConfig))):(I=V,U&&(_.waypoint=U),L=_.waypoint.target.getWorldCoords()),L&&!L.equals(_.position)&&(g.verticesNeedUpdate=!0,_.position.copy(L)),void 0!==I&&I!==_.enabled&&(g.verticesNeedUpdate=!0,_.enabled=I)}}createWaypointLinePath(g,P){return{vertices:g.waypoints.map(g=>({type:G.Waypoint,enabled:!0,lineHead:!0,waypoint:g,position:g.target.getWorldCoords().clone()})),verticesNeedUpdate:!1,color:10867711,bgColor:P?16777215:0}}updateWaypointLinePath(g){for(var P of g.vertices){let I=P.waypoint.target.getWorldCoords();I.equals(P.position)||(P.position.copy(I),g.verticesNeedUpdate=!0)}}computeInitialTargetPosition(g){if(g.pathNodes.length){var P=g.pathNodes[0];return I.Coords.tile3dToWorld(P.tile.rx+.5,P.tile.ry+.5,P.tile.z+(P.onBridge?.tileElevation??0))}if(g.target)return g.target.position.worldPosition;throw new Error("No target and no pathNodes found")}dispose(){this.sourceLinePaths.forEach(g=>g.lineObj?.dispose()),this.waypointLinePaths.forEach(g=>g.lineObj?.dispose())}})}}}),System.register("engine/renderable/fx/DamageSmokeFx",["engine/AnimProps","engine/gfx/ImageUtils"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=1e3,g("DamageSmokeFx",U=class c{static clearTextureCache(){this.textureCache.forEach(g=>g.dispose()),this.textureCache.clear()}constructor(g,P,I,L,_){this.gameObject=g,this.smokeArt=P,this.shpFile=I,this.palette=L,this.gameSpeed=_,this.lifetimeSeconds=Number.POSITIVE_INFINITY,this.finishRequested=!1}setContainer(g){this.container=g}create3DObject(){if(!this.particleGroup){let V=c.textureCache.get(this.shpFile);V||(U=L.ImageUtils.convertShpToCanvas(this.shpFile,this.palette,!0),V=new THREE.Texture(U),V.minFilter=THREE.NearestFilter,V.magFilter=THREE.NearestFilter,V.needsUpdate=!0,V.flipY=!1,c.textureCache.set(this.shpFile,V)),this.particleGroup=new SPE.Group({texture:{value:V,frames:new THREE.Vector2(this.shpFile.numImages,1),frameCount:this.shpFile.numImages,loop:1},maxParticleCount:1e3,hasPerspective:!1,transparent:!0,alphaTest:0,blending:THREE.NormalBlending}),this.particleGroup.mesh.name="fx_damage_smoke",this.particleGroup.mesh.frustumCulled=!1;var g=new I.AnimProps(this.smokeArt.art,this.shpFile),P=(G=(this.smokeArt.art.getBool("Normalized")?2:1)*g.rate)/10,U=this.particleMaxAge=2*this.shpFile.numImages/g.rate,G=(g=9*G,.05*G);g=this.particleEmitter=new SPE.Emitter({particleCount:_,maxAge:{value:U},activeMultiplier:P/(_/U),position:{value:this.computeEmitterPosition()},acceleration:{value:new THREE.Vector3(0,-G,0),spread:new THREE.Vector3(2,0,2)},velocity:{value:new THREE.Vector3(0,g,0),spread:new THREE.Vector3(.1*g,0,.1*g)},opacity:{value:.5},size:{value:Math.max(this.shpFile.height,this.shpFile.width)}});this.particleGroup.addEmitter(g)}}computeEmitterPosition(){return this.gameObject.position.worldPosition.clone().add(this.gameObject.rules.damageSmokeOffset)}get3DObject(){return this.particleGroup?.mesh}update(g){var P;this.particleEmitter.position.value=this.computeEmitterPosition(),this.lastUpdateMillis?(P=g-this.lastUpdateMillis,this.particleGroup.tick(P/1e3*this.gameSpeed.value)):(this.firstUpdateMillis=g,this.particleGroup.tick(0)),this.lastUpdateMillis=g,this.finishRequested&&(this.finishRequested=!1,this.particleEmitter.alive&&(P=(g-this.firstUpdateMillis)/1e3*this.gameSpeed.value,this.lifetimeSeconds=P+this.particleMaxAge,this.particleEmitter.disable())),this.timeLeft=Math.max(0,1-(g-this.firstUpdateMillis)/(1e3*this.lifetimeSeconds/this.gameSpeed.value)),this.timeLeft||(this.container.remove(this),this.dispose())}finishAndRemove(){this.finishRequested=!0}dispose(){this.particleGroup?.mesh.geometry.dispose(),this.particleGroup?.mesh.material.dispose()}}),U.textureCache=new Map}}}),System.register("engine/renderable/fx/DetectionLineFx",["three.meshline","game/Coords"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=new THREE.Color(16777215),g("DetectionLineFx",U=class i{constructor(g,P,I,L,_){this.camera=g,this.sourcePos=P,this.targetPos=I,this.color=L,this.renderOrder=_,this.needsUpdate=!1,this.cameraHash=this.camera.top+"_"+this.camera.right,this.computedColor=L,this.lineHeadMaterial=new THREE.MeshBasicMaterial({color:16777215,transparent:!0,depthTest:!1,depthWrite:!1})}setContainer(g){this.container=g}get3DObject(){return this.wrapper}create3DObject(){this.wrapper||(this.wrapper=new THREE.Object3D,this.wrapper.name="fx_detectionline",this.lineMesh=this.createLineMesh(),this.srcLineHead=this.createLineHead(),this.destLineHead=this.createLineHead(),this.wrapper.add(this.srcLineHead),this.wrapper.add(this.destLineHead),this.wrapper.add(this.lineMesh),this.needsUpdate=!0)}update(g){this.lastUpdateMillis||(this.lastUpdateMillis=g);var P=(g-this.lastUpdateMillis)/(1e3/120);this.lastUpdateMillis=g;var I=this.camera.top+"_"+this.camera.right;I!==this.cameraHash&&(this.cameraHash=I,this.lineMesh.material.uniforms.resolution.value.copy(this.computeResolution(this.camera)));let L=this.lineMesh.material;this.needsUpdate&&(this.needsUpdate=!1,this.lineMesh.geometry.dispose(),this.lineMesh.geometry=this.createLineGeometry(this.sourcePos,this.targetPos),I=this.sourcePos.distanceTo(this.targetPos),L.uniforms.dashArray.value=this.computeDashArray(I),this.srcLineHead.position.copy(this.sourcePos),this.destLineHead.position.copy(this.targetPos)),L.uniforms.dashOffset.value-=L.uniforms.dashArray.value/50*P,P=Math.sin(g%1e3/1e3*Math.PI);let U=this.computedColor.copy(this.color).lerp(_,P);this.lineMesh.material.uniforms.color.value=U.clone(),this.lineHeadMaterial.color.set(U)}createLineMesh(){let g=this.sourcePos.clone();var P=this.targetPos.clone();let I=new THREE.Mesh(this.createLineGeometry(g,P),this.createLineMaterial(this.color.clone(),g.distanceTo(P)));return I.renderOrder=this.renderOrder,I}createLineGeometry(g,P){let L=new THREE.Geometry;L.vertices.push(g,P);let _=new I.MeshLine;return _.setGeometry(L),_.geometry}createLineMaterial(g,P){return new I.MeshLineMaterial({color:g,lineWidth:1,resolution:this.computeResolution(this.camera),transparent:!0,sizeAttenuation:0,dashArray:this.computeDashArray(P),depthTest:!1})}createLineHead(){let g=new THREE.Mesh(i.lineHeadGeometry,this.lineHeadMaterial);var P=(new THREE.Quaternion).setFromEuler(this.camera.rotation);return g.setRotationFromQuaternion(P),g.renderOrder=this.renderOrder,g}computeDashArray(g){return Math.min(1,5/g)*L.Coords.ISO_WORLD_SCALE}computeResolution(g){var P=g.top,I=g.right/g.top,_=2*P/Math.cos(g.rotation.y);return new THREE.Vector2(_*I,_).multiplyScalar(P*Math.cos(this.camera.rotation.x)/L.Coords.ISO_WORLD_SCALE)}remove(){this.container.remove(this)}dispose(){this.wrapper&&(this.lineMesh.geometry.dispose(),this.lineMesh.material.dispose(),this.lineHeadMaterial.dispose())}}),U.lineHeadGeometry=new THREE.PlaneGeometry(3*L.Coords.ISO_WORLD_SCALE,3*L.Coords.ISO_WORLD_SCALE)}}}),System.register("engine/renderable/fx/Effect",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("engine/renderable/fx/handler/BeaconFxHandler",["game/event/EventType","util/disposable/CompositeDisposable","game/Coords","engine/sound/SoundKey"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("BeaconFxHandler",class{constructor(g,P,I,G,V){this.game=g,this.localPlayer=P,this.renderableManager=I,this.renderer=G,this.worldSound=V,this.disposables=new L.CompositeDisposable,this.beacons=new Map,this.handlePingEvent=g=>{var P=this.localPlayer.value;if((!P||P.isObserver||g.player===P||this.game.alliances.areAllied(g.player,P))&&this.canPingLocation(g.player,g.tile)){let I=this.beacons.get(g.player);I||(I=[],this.beacons.set(g.player,I));let L=I.find(P=>P.tile===g.tile);P=g.tile.onBridgeLandType?this.game.map.tileOccupation.getBridgeOnTile(g.tile):void 0;let G=_.Coords.tile3dToWorld(g.tile.rx+.5,g.tile.ry+.5,g.tile.z+(P?.tileElevation??0));this.worldSound.playEffect(U.SoundKey.PlaceBeaconSound,G,g.player),L?L.startTime=this.now:(P=this.renderableManager.createTransientAnim("PBEACON",P=>{P.setPosition(G),P.setRenderOrder(1e6),P.remapColor(g.player.color),P.create3DObject()}),I.push({tile:g.tile,anim:P,startTime:this.now}))}},this.handleFrame=g=>{for(var P of(this.now=g,this.beacons.values()))for(var I of P.slice())if(void 0===I.startTime)I.startTime=g;else if(g>I.startTime+7e3){if(I.anim.endAnimationLoop(),-1===(I=P.indexOf(I)))throw new Error("Beacon not found in array");P.splice(I,1)}}}init(){this.disposables.add(this.game.events.subscribe(I.EventType.PingLocation,this.handlePingEvent)),this.renderer.onFrame.subscribe(this.handleFrame),this.disposables.add(()=>this.renderer.onFrame.unsubscribe(this.handleFrame))}canPingLocation(g,P){let I=this.beacons.get(g)??[];var L=I.reduce((g,P)=>Math.max(g,P.startTime??0),0);return(I.length<3||I.some(g=>g.tile===P))&&(!this.now||this.now-L>=1e3/3)}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/fx/handler/ChronoFxHandler",["game/event/EventType","util/disposable/CompositeDisposable","game/Coords","game/gameobject/common/DeathType"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("ChronoFxHandler",class{constructor(g,P){this.game=g,this.renderableManager=P,this.disposables=new L.CompositeDisposable,this.handleObjectTeleport=g=>{if(g.isChronoshift){let P=g.target.position.getTileOffset().multiplyScalar(1/_.Coords.LEPTONS_PER_TILE);this.renderableManager.createTransientAnim(this.game.rules.audioVisual.warpOut,I=>{I.setPosition(_.Coords.tile3dToWorld(g.prevTile.rx+P.x,g.prevTile.ry+P.y,g.prevTile.z))}),this.renderableManager.createTransientAnim(this.game.rules.audioVisual.warpOut,I=>{var L=g.target.tile;I.setPosition(_.Coords.tile3dToWorld(L.rx+P.x,L.ry+P.y,L.z))})}},this.handleObjectDestroy=g=>{if(g.target.deathType===U.DeathType.Temporal){let P=g.target.isBuilding()?g.target.centerTile:g.target.tile,I=g.target.isBuilding()?new THREE.Vector2(.5,.5):g.target.position.getTileOffset().multiplyScalar(1/_.Coords.LEPTONS_PER_TILE);this.renderableManager.createTransientAnim(this.game.rules.audioVisual.warpAway,g=>{g.setPosition(_.Coords.tile3dToWorld(P.rx+I.x,P.ry+I.y,P.z))})}}}init(){this.disposables.add(this.game.events.subscribe(I.EventType.ObjectTeleport,this.handleObjectTeleport),this.game.events.subscribe(I.EventType.ObjectDestroy,this.handleObjectDestroy))}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/fx/handler/CrateFxHandler",["game/event/EventType","util/disposable/CompositeDisposable","game/Coords"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("CrateFxHandler",class{constructor(g,P){this.game=g,this.renderableManager=P,this.disposables=new L.CompositeDisposable}init(){this.disposables.add(this.game.events.subscribe(I.EventType.CratePickup,g=>{var P=g.target.animName;P&&this.renderableManager.createTransientAnim(P,P=>{P.setPosition(_.Coords.tile3dToWorld(g.tile.rx,g.tile.ry,g.tile.z+1)),P.setRenderOrder(1e6)})}))}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/fx/handler/ParasiteSparkFxHandler",["game/event/EventType","util/disposable/CompositeDisposable","game/Coords","game/GameSpeed","engine/renderable/fx/SparkFx"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){g("ParasiteSparkFxHandler",class{constructor(g,P){this.game=g,this.renderableManager=P,this.disposables=new L.CompositeDisposable,this.handleObjectDamaged=g=>{if((g.target.isVehicle()||g.target.isAircraft())&&g.attacker?.obj&&!g.attacker.obj.rules.organic&&g.target.parasiteableTrait?.getParasite()===g.attacker.obj&&0<g.target.healthTrait.health){let I=g.target.position.worldPosition.clone();I.y+=_.Coords.tileHeightToWorld(.5);var P=20/U.GameSpeed.BASE_TICKS_PER_SECOND;P=new G.SparkFx(I,new THREE.Color(1,1,1),P,this.game.speed);this.renderableManager.addEffect(P)}}}init(){this.disposables.add(this.game.events.subscribe(I.EventType.InflictDamage,this.handleObjectDamaged))}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/fx/handler/SuperWeaponFxHandler",["game/event/EventType","util/disposable/CompositeDisposable","util/math","engine/gfx/lighting/LightningStormFx","game/GameSpeed","game/type/SuperWeaponType","game/Coords"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g}],execute:function(){g("SuperWeaponFxHandler",class{constructor(g,P,I){this.game=g,this.renderableManager=P,this.lightingDirector=I,this.disposables=new L.CompositeDisposable}init(){this.disposables.add(this.game.events.subscribe(I.EventType.LightningStormCloud,g=>{var P=(P=this.game.rules.audioVisual.weatherConClouds)[_.getRandomInt(0,P.length-1)];P=this.renderableManager.createTransientAnim(P,P=>{P.setPosition(g.position)});this.lightingFx?.waitForCloudAnim(P)}),this.game.events.subscribe(I.EventType.LightningStormManifest,()=>{var g=this.lightingFx=new U.LightningStormFx(this.game.rules.general.lightningStorm.duration/G.GameSpeed.BASE_TICKS_PER_SECOND,this.game.map.getIonLighting());this.lightingDirector.addEffect(g)}),this.game.events.subscribe(I.EventType.SuperWeaponActivate,g=>{var P=g.target;if(P===V.SuperWeaponType.IronCurtain)this.renderableManager.createTransientAnim(this.game.rules.audioVisual.ironCurtainInvokeAnim,P=>{var I=W.Coords.tile3dToWorld(g.atTile.rx+.5,g.atTile.ry+.5,g.atTile.z);P.setPosition(I)});else if(P===V.SuperWeaponType.ChronoSphere){this.disposeChronoSphereAnim();var I=this.game.map.tileOccupation.getBridgeOnTile(g.atTile)?.tileElevation??0;let L=W.Coords.tile3dToWorld(g.atTile.rx+.5,g.atTile.ry+.5,g.atTile.z+I);P=g.atTile2,I=this.game.map.tileOccupation.getBridgeOnTile(P)?.tileElevation??0;let _=W.Coords.tile3dToWorld(P.rx+.5,P.ry+.5,P.z+I);this.renderableManager.createTransientAnim(this.game.rules.audioVisual.chronoBlast,g=>{g.setPosition(L)}),this.renderableManager.createTransientAnim(this.game.rules.audioVisual.chronoBlastDest,g=>{g.setPosition(_)})}}))}createChronoSphereAnim(g){this.chronoSphereAnim=this.renderableManager.createAnim(this.game.rules.audioVisual.chronoPlacement,P=>{var I=this.game.map.tileOccupation.getBridgeOnTile(g)?.tileElevation??0;I=W.Coords.tile3dToWorld(g.rx+.5,g.ry+.5,g.z+I);P.setPosition(I)})}disposeChronoSphereAnim(){let g=this.chronoSphereAnim;g&&(this.renderableManager.getRenderableContainer()?.remove(g),g.dispose())}dispose(){this.lightingFx=void 0,this.disposeChronoSphereAnim(),this.disposables.dispose()}})}}}),System.register("engine/renderable/fx/handler/TriggerActionFxHandler",["util/disposable/CompositeDisposable","game/Coords","game/event/EventType"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("TriggerActionFxHandler",class{constructor(g,P){this.game=g,this.renderableManager=P,this.disposables=new I.CompositeDisposable,this.handleEvent=g=>{switch(g.type){case _.EventType.TriggerAnim:{let I=g;var P=I.name;this.renderableManager.createTransientAnim(P,g=>{var P=L.Coords.tile3dToWorld(I.tile.rx+.5,I.tile.ry+.5,I.tile.z);g.setPosition(P)});break}}}}init(){this.disposables.add(this.game.events.subscribe(this.handleEvent))}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/fx/handler/WarheadDetonateFxHandler",["game/event/EventType","util/disposable/CompositeDisposable","game/Coords","util/math"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("WarheadDetonateFxHandler",class{constructor(g,P){this.game=g,this.renderableManager=P,this.disposables=new L.CompositeDisposable,this.handleWarheadDetonation=g=>{var P=g.explodeAnim;P&&this.renderableManager.createTransientAnim(P,P=>{let I=g.position.clone();var L;g.target.rules.bullets&&(L=_.Coords.getWorldTileSize()/8,I=new THREE.Vector3(U.getRandomInt(-L,L),0,U.getRandomInt(-L,L)).add(I)),P.setPosition(I)}),g.isLightningStrike&&(P=(P=this.game.rules.audioVisual.weatherConBolts)[U.getRandomInt(0,P.length-1)],this.renderableManager.createTransientAnim(P,P=>{P.setPosition(g.position)}))}}init(){this.disposables.add(this.game.events.subscribe(I.EventType.WarheadDetonate,this.handleWarheadDetonation))}dispose(){this.disposables.dispose()}})}}}),System.register("engine/renderable/fx/LaserFx",["three.meshline","game/Coords"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("LaserFx",class{constructor(g,P,I,L,_,U){this.camera=g,this.sourcePos=P,this.targetPos=I,this.color=L,this.durationSeconds=_,this.width=U}setContainer(g){this.container=g}get3DObject(){return this.lineMesh}create3DObject(){this.lineMesh||(this.lineMesh=this.createObject(),this.lineMesh.name="fx_laser")}update(g){this.firstUpdateMillis||(this.firstUpdateMillis=g),this.timeLeft=Math.max(0,1-(g-this.firstUpdateMillis)/(1e3*this.durationSeconds)),this.lineMesh.material.uniforms.opacity.value=+this.timeLeft,this.isFinished()&&(this.container.remove(this),this.dispose())}createObject(){var g=this.sourcePos.clone(),P=this.targetPos.clone();let _=new THREE.Geometry;_.vertices.push(g,P);let U=new I.MeshLine;U.setGeometry(_);var G=this.camera.top;g=this.camera.right/this.camera.top,g=(P=2*G/Math.cos(this.camera.rotation.y))*g,G=new I.MeshLineMaterial({color:this.color.clone(),lineWidth:this.width,resolution:new THREE.Vector2(g,P).multiplyScalar(G*Math.cos(this.camera.rotation.x)/L.Coords.ISO_WORLD_SCALE),transparent:!0,sizeAttenuation:0,blending:THREE.AdditiveBlending});return new THREE.Mesh(U.geometry,G)}isFinished(){return 0===this.timeLeft}dispose(){this.lineMesh&&(this.lineMesh.geometry.dispose(),this.lineMesh.material.dispose())}})}}}),System.register("engine/renderable/fx/LineTrailFx",["game/art/ObjectArt","game/Coords"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("LineTrailFx",class{constructor(g,P,I,L,_){this.lazyTarget=g,this.trailColor=P,this.trailDecrement=I,this.gameSpeed=L,this.camera=_,this.trailInitialized=!1}setContainer(g){this.container=g}get3DObject(){return this.placeholderObj}create3DObject(){this.placeholderObj||(this.placeholderObj=new THREE.Object3D,this.placeholderObj.name="fx_linetrail_placeholder")}update(g){var P;void 0!==this.timeLeft&&(P=this.prevUpdateMillis,this.prevUpdateMillis=g,P&&(this.timeLeft=Math.max(0,this.timeLeft-(g-P)/1e3))),this.trailInitialized||(this.trailInitialized=!0,(P=this.createTrail(this.trailColor,this.trailDecrement))?this.trail=P:this.timeLeft=0),this.trail&&(this.trail.advance(),this.lastTargetMatrix=this.trail.targetObject.matrixWorld),this.isFinished()&&(this.container.remove(this),this.dispose())}createTrail(g,P){var _=this.lazyTarget();if(_){let V=new THREE.TrailRenderer(this.container.get3DObject()),W=THREE.TrailRenderer.createBaseMaterial();W.uniforms.headColor.value.set(g.r,g.g,g.b,1),W.uniforms.tailColor.value.set(g.r,g.g,g.b,0);var U=Math.floor(3/this.gameSpeed.value*50/(P/I.ObjectArt.DEFAULT_LINE_TRAIL_DEC)),G=.8*L.Coords.ISO_WORLD_SCALE;let z=new THREE.PlaneGeometry(G,G);return G=(new THREE.Quaternion).setFromEuler(this.camera.rotation),z.applyMatrix((new THREE.Matrix4).makeRotationFromQuaternion(G)),V.initialize(W,U,!1,0,z.vertices,_),V.activate(),V}}isFinished(){return 0===this.timeLeft}requestFinishAndDispose(){this.timeLeft=.8/this.gameSpeed.value}stopTracking(){if(this.trail&&this.lastTargetMatrix){let g=new THREE.Object3D;g.updateMatrixWorld=()=>{},g.matrixWorld=this.lastTargetMatrix,this.trail.targetObject=g}}dispose(){this.trail?.deactivate(),this.trail?.material.dispose(),this.trail?.geometry.dispose()}})}}}),System.register("engine/renderable/fx/MindControlLinkFx",["game/Coords"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("MindControlLinkFx",class{constructor(g,P,I,L){this.sourcePos=g,this.targetPos=P,this.color=I,this.heightTiles=L,this.colorAnimProgress=0}setContainer(g){this.container=g}get3DObject(){return this.lineMesh}create3DObject(){this.lineMesh||(this.lineMesh=this.createObject(),this.lineMesh.name="fx_mclink")}updateEndpoints(g,P){var I=!g.equals(this.sourcePos)||!P.equals(this.targetPos);this.sourcePos=g,this.targetPos=P,I&&this.lineMesh&&(this.lineMesh.geometry.dispose(),this.lineMesh.geometry=this.createLineGeometry(this.sourcePos,this.targetPos,this.heightTiles,this.color,this.colorAnimProgress))}update(g){this.lastUpdate??(this.lastUpdate=g),this.colorAnimProgress+=(g-this.lastUpdate)/1e3,this.colorAnimProgress-=Math.floor(this.colorAnimProgress),this.lastUpdate=g,this.lineMesh.geometry.dispose(),this.lineMesh.geometry=this.createLineGeometry(this.sourcePos,this.targetPos,this.heightTiles,this.color,this.colorAnimProgress)}createObject(){var g=this.sourcePos,P=this.targetPos;g=this.createLineGeometry(g,P,this.heightTiles,this.color,this.colorAnimProgress),P=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,transparent:!0});let I=new THREE.Line(g,P);return I.renderOrder=1e6,I}createLineGeometry(g,P,L,_,U){var G=new THREE.Color(16777215),V=1.5*U,W=P.clone().sub(g).length()/I.Coords.LEPTONS_PER_TILE,z=Math.floor(15*W);let K=new Float32Array(3*z),q=new Float32Array(3*z),$=new THREE.Vector3;for(let U=0;U<=z;U++){var Q=U/z;$.lerpVectors(g,P,Q),$.y+=I.Coords.LEPTONS_PER_TILE/4+L*I.Coords.LEPTONS_PER_TILE*Math.sin(Q*Math.PI),K[3*U]=$.x,K[3*U+1]=$.y,K[3*U+2]=$.z;let W=_;Q<V&&V-.5<=Q&&(W=_.clone().lerp(G,(Q-(V-.5))/.5)),q[3*U]=W.r,q[3*U+1]=W.g,q[3*U+2]=W.b}let Y=new THREE.BufferGeometry;return Y.addAttribute("position",new THREE.BufferAttribute(K,3)),Y.addAttribute("color",new THREE.BufferAttribute(q,3)),Y}removeAndDispose(){this.container.remove(this),this.dispose()}dispose(){this.lineMesh&&(this.lineMesh.geometry.dispose(),this.lineMesh.material.dispose())}})}}}),System.register("engine/renderable/fx/RadBeamFx",["three.meshline","game/Coords","util/math"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("RadBeamFx",class{constructor(g,P,I,L,_,U){this.camera=g,this.sourcePos=P,this.targetPos=I,this.color=L,this.durationSeconds=_,this.width=U,this.amplitude=0}setContainer(g){this.container=g}get3DObject(){return this.lineMesh}create3DObject(){this.lineMesh||(this.lineMesh=this.createObject(),this.lineMesh.name="fx_radbeam")}update(g){this.firstUpdateMillis||(this.firstUpdateMillis=g),this.timeLeft=Math.max(0,1-(g-this.firstUpdateMillis)/(1e3*this.durationSeconds));var P=_.truncToDecimals(L.Coords.LEPTONS_PER_TILE/6*(1-this.timeLeft),1);P!==this.amplitude&&(this.amplitude=P,this.lineMesh.geometry.dispose(),this.lineMesh.geometry=this.createLineGeometry(this.sourcePos,this.targetPos,P)),this.isFinished()&&(this.container.remove(this),this.dispose())}createObject(){var g=this.sourcePos.clone(),P=this.targetPos.clone(),_=this.createLineGeometry(g,P,this.amplitude),U=this.camera.top;g=this.camera.right/this.camera.top,g=(P=2*U/Math.cos(this.camera.rotation.y))*g,U=new I.MeshLineMaterial({color:this.color.clone(),lineWidth:this.width,resolution:new THREE.Vector2(g,P).multiplyScalar(U*Math.cos(this.camera.rotation.x)/L.Coords.ISO_WORLD_SCALE),transparent:!0,sizeAttenuation:0});return new THREE.Mesh(_,U)}createLineGeometry(g,P,_){let U=[];var G=P.clone().sub(g).length()/L.Coords.LEPTONS_PER_TILE,V=15*G;let W=new THREE.Vector3;for(let I=0;I<=V;I++){var z=I/V;W.lerpVectors(g,P,z),W.y+=_*Math.sin(z*G*(L.Coords.LEPTONS_PER_TILE/Math.PI)),U.push(W.x,W.y,W.z)}let K=new I.MeshLine;return K.setGeometry(U),K.geometry}isFinished(){return 0===this.timeLeft}dispose(){this.lineMesh&&(this.lineMesh.geometry.dispose(),this.lineMesh.material.dispose())}})}}}),System.register("engine/renderable/fx/RallyPointFx",["three.meshline","game/Coords"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("RallyPointFx",class{constructor(g,P,I,L,_){this.camera=g,this.sourcePos=P,this.targetPos=I,this.color=L,this.renderOrder=_,this.needsUpdate=!1,this.visible=!0,this.cameraHash=this.camera.top+"_"+this.camera.right}setContainer(g){this.container=g}get3DObject(){return this.wrapper}create3DObject(){this.wrapper||(this.wrapper=new THREE.Object3D,this.wrapper.matrixAutoUpdate=!1,this.lineMesh=this.createLineMesh(),this.lineMesh.name="fx_rallypoint",this.lineMesh.matrixAutoUpdate=!1,this.shadowLineMesh=this.createLineShadowMesh(),this.shadowLineMesh.name="fx_rallypoint_shadow",this.shadowLineMesh.matrixAutoUpdate=!1,this.wrapper.add(this.lineMesh),this.wrapper.add(this.shadowLineMesh))}update(g){this.lastUpdateMillis||(this.lastUpdateMillis=g);let P=(g-this.lastUpdateMillis)/(1e3/120);this.lastUpdateMillis=g,this.wrapper.visible=this.visible;var I=this.camera.top+"_"+this.camera.right;if(I!==this.cameraHash&&(this.cameraHash=I,[this.lineMesh,this.shadowLineMesh].forEach(g=>{g.material.uniforms.resolution.value.copy(this.computeResolution(this.camera))})),this.needsUpdate){this.needsUpdate=!1,this.lineMesh.geometry=this.createLineGeometry(this.sourcePos,this.targetPos),this.shadowLineMesh.geometry=this.createShadowLineGeometry(this.sourcePos,this.targetPos),this.lineMesh.material.uniforms.color.value=this.color.clone();let g=this.sourcePos.distanceTo(this.targetPos);[this.lineMesh,this.shadowLineMesh].forEach(P=>{let I=P.material;I.uniforms.dashArray.value=this.computeDashArray(g),I.depthTest=void 0===this.renderOrder}),this.lineMesh.renderOrder=this.renderOrder??0,this.shadowLineMesh.renderOrder=void 0!==this.renderOrder?this.renderOrder-1:0}[this.lineMesh,this.shadowLineMesh].forEach(g=>{let I=g.material;I.uniforms.dashOffset.value-=I.uniforms.dashArray.value/50*P})}createLineMesh(){let g=this.sourcePos.clone();var P=this.targetPos.clone();let I=new THREE.Mesh(this.createLineGeometry(g,P),this.createLineMaterial(this.color.clone(),g.distanceTo(P)));return this.renderOrder&&(I.renderOrder=this.renderOrder),I}createLineShadowMesh(){let g=new THREE.Mesh(this.createShadowLineGeometry(this.sourcePos,this.targetPos),this.createLineMaterial(new THREE.Color(0),this.sourcePos.distanceTo(this.targetPos)));return this.renderOrder&&(g.renderOrder=this.renderOrder-1),g}createShadowLineGeometry(g,P){var I=new THREE.Vector3(+L.Coords.ISO_WORLD_SCALE,0,+L.Coords.ISO_WORLD_SCALE);return this.createLineGeometry(g.clone().add(I),P.clone().add(I))}createLineGeometry(g,P){let L=new THREE.Geometry;L.vertices.push(g,P);let _=new I.MeshLine;return _.setGeometry(L),_.geometry}createLineMaterial(g,P){return new I.MeshLineMaterial({color:g,lineWidth:2,resolution:this.computeResolution(this.camera),transparent:!0,sizeAttenuation:0,dashArray:this.computeDashArray(P),depthTest:void 0===this.renderOrder})}computeDashArray(g){return Math.min(1,5/g)*L.Coords.ISO_WORLD_SCALE}computeResolution(g){var P=g.top,I=g.right/g.top,_=2*P/Math.cos(g.rotation.y);return new THREE.Vector2(_*I,_).multiplyScalar(P*Math.cos(this.camera.rotation.x)/L.Coords.ISO_WORLD_SCALE)}remove(){this.container.remove(this)}dispose(){this.wrapper&&[this.lineMesh,this.shadowLineMesh].forEach(g=>{g&&(g.geometry.dispose(),g.material.dispose())})}})}}}),System.register("engine/renderable/fx/SparkFx",["game/Coords"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=100,g("SparkFx",class n{constructor(g,P,I,L){this.pos=g,this.color=P,this.spawnDurationSeconds=I,this.gameSpeed=L,this.totalDurationSeconds=I+1}setContainer(g){this.container=g}create3DObject(){var g;this.particleGroup||(n.sparkTex||(n.sparkTex=new THREE.DataTexture(new Uint8Array(4).fill(255),1,1,THREE.RGBAFormat),n.sparkTex.needsUpdate=!0),this.particleGroup=new SPE.Group({texture:{value:n.sparkTex},maxParticleCount:100}),this.particleGroup.mesh.name="fx_spark",this.particleGroup.mesh.frustumCulled=!1,g=this.particleEmitter=new SPE.Emitter({maxAge:{value:1},position:{value:this.pos,spread:new THREE.Vector3(10,0,10).multiplyScalar(I.Coords.ISO_WORLD_SCALE)},acceleration:{value:new THREE.Vector3(0,-50,0).multiplyScalar(I.Coords.ISO_WORLD_SCALE),spread:new THREE.Vector3(0,0,0)},velocity:{value:new THREE.Vector3(0,30,0).multiplyScalar(I.Coords.ISO_WORLD_SCALE),spread:new THREE.Vector3(40,5,40).multiplyScalar(I.Coords.ISO_WORLD_SCALE)},color:{value:[this.color]},opacity:{value:[1,.5]},size:{value:1},particleCount:L}),this.particleGroup.addEmitter(g))}get3DObject(){return this.particleGroup?.mesh}update(g){var P;this.lastUpdateMillis?(P=g-this.lastUpdateMillis,this.particleGroup.tick(P/1e3*this.gameSpeed.value)):(this.firstUpdateMillis=g,this.particleGroup.tick(0)),this.lastUpdateMillis=g,this.particleEmitter.alive&&g-this.firstUpdateMillis>=1e3*this.spawnDurationSeconds/this.gameSpeed.value&&this.particleEmitter.disable(),this.timeLeft=Math.max(0,1-(g-this.firstUpdateMillis)/(1e3*this.totalDurationSeconds/this.gameSpeed.value)),this.timeLeft||(this.container.remove(this),this.dispose())}dispose(){this.particleGroup?.mesh.geometry.dispose(),this.particleGroup?.mesh.material.dispose()}})}}}),System.register("engine/renderable/fx/TeslaFx",["game/Coords"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("TeslaFx",class{constructor(g,P,I,L,_){this.sourcePos=g,this.targetPos=P,this.primaryColor=I,this.secondaryColor=L,this.durationSeconds=_,this.bolts=[],this.boltMeshes=[]}setContainer(g){this.container=g}get3DObject(){return this.target}create3DObject(){if(!this.target){this.target=new THREE.Object3D,this.target.name="fx_tesla";var g=this.primaryColor.getHex();[g,g,this.secondaryColor.getHex()].forEach(g=>{try{var{mesh:P,bolt:I}=this.createBolt(g);this.boltMeshes.push(P),this.bolts.push(I),this.target.add(P)}catch(g){console.warn("Couldn't create lightning FX",[g])}})}}update(g){this.firstUpdateMillis||(this.firstUpdateMillis=g);let P=(g-this.firstUpdateMillis)/1e3;this.timeLeft=Math.max(0,1-P/this.durationSeconds);try{this.bolts.forEach(g=>g.update(P))}catch(g){console.warn("Couldn't update lightning FX",[g])}this.isFinished()&&(this.container.remove(this),this.dispose())}createBolt(g){var P=this.sourcePos.clone(),L=this.targetPos.clone();P=new THREE.LightningStrike({sourceOffset:P,destOffset:L,radius0:.3*I.Coords.ISO_WORLD_SCALE,radius1:.3*I.Coords.ISO_WORLD_SCALE,isEternal:!0,timeScale:2,propagationTimeFactor:.05,vanishingTimeFactor:.95,ramification:0,roughness:.85,straightness:.7}),L=new THREE.MeshBasicMaterial({color:g});return{mesh:new THREE.Mesh(P,L),bolt:P}}isFinished(){return 0===this.timeLeft}dispose(){this.boltMeshes.forEach(g=>{g.geometry.dispose(),g.material.dispose()})}})}}}),System.register("engine/renderable/fx/TrailerSmokeFx",["engine/AnimProps","engine/gfx/ImageUtils"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=1e3,g("TrailerSmokeFx",U=class o{static clearTextureCache(){this.textureCache.forEach(g=>g.dispose()),this.textureCache.clear()}constructor(g,P,I,L,_,U){this.pos=g,this.spawnDelayFrames=P,this.smokeArt=I,this.shpFile=L,this.palette=_,this.gameSpeed=U,this.lifetimeSeconds=Number.POSITIVE_INFINITY,this.finishRequested=!1,this.finishProcessed=!1}setContainer(g){this.container=g}create3DObject(){if(!this.particleGroup){let U=o.textureCache.get(this.shpFile);U||(P=L.ImageUtils.convertShpToCanvas(this.shpFile,this.palette,!0),U=new THREE.Texture(P),U.minFilter=THREE.NearestFilter,U.magFilter=THREE.NearestFilter,U.needsUpdate=!0,U.flipY=!0,o.textureCache.set(this.shpFile,U)),this.particleGroup=new SPE.Group({texture:{value:U,frames:new THREE.Vector2(this.shpFile.numImages,1),frameCount:this.shpFile.numImages,loop:1},maxParticleCount:1e3,hasPerspective:!1,transparent:!0,alphaTest:0,blending:THREE.NormalBlending}),this.particleGroup.mesh.name="fx_trailer_smoke",this.particleGroup.mesh.frustumCulled=!1;var g=new I.AnimProps(this.smokeArt.art,this.shpFile),P=(this.smokeArt.art.getBool("Normalized")?2:1)*g.rate/this.spawnDelayFrames;g=this.particleMaxAge=this.shpFile.numImages/g.rate,g=this.particleEmitter=new SPE.Emitter({particleCount:_,maxAge:{value:g},activeMultiplier:P/(_/g),position:{value:this.pos},acceleration:{value:new THREE.Vector3},velocity:{value:new THREE.Vector3},opacity:{value:this.smokeArt.translucent?[1,0]:1-this.smokeArt.translucency},size:{value:Math.max(this.shpFile.height,this.shpFile.width)}});this.particleGroup.addEmitter(g)}}get3DObject(){return this.particleGroup?.mesh}update(g){var P;this.particleEmitter.position.value=this.pos,this.lastUpdateMillis?(P=g-this.lastUpdateMillis,this.particleGroup.tick(P/1e3*this.gameSpeed.value)):(this.firstUpdateMillis=g,this.particleGroup.tick(0)),this.lastUpdateMillis=g,this.finishRequested&&(this.finishRequested=!1,this.finishProcessed||(this.finishProcessed=!0,P=(g-this.firstUpdateMillis)/1e3*this.gameSpeed.value,this.lifetimeSeconds=P+this.particleMaxAge),this.particleEmitter.alive&&this.particleEmitter.disable()),this.timeLeft=Math.max(0,1-(g-this.firstUpdateMillis)/(1e3*this.lifetimeSeconds/this.gameSpeed.value)),this.timeLeft||(this.container.remove(this),this.dispose())}finishAndRemove(){this.finishRequested=!0}disable(){this.particleEmitter.disable()}enable(){this.particleEmitter.enable()}dispose(){this.particleGroup?.mesh.geometry.dispose(),this.particleGroup?.mesh.material.dispose()}}),U.textureCache=new Map}}}),System.register("engine/renderable/MapSpriteTranslation",["game/Coords","engine/IsoCoords"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("MapSpriteTranslation",class{constructor(g,P){this.rx=g,this.ry=P}compute(){let g=I.Coords.tileToWorld(this.rx,this.ry);var P=L.IsoCoords.worldToScreen(g.x,g.y),_=L.IsoCoords.worldToScreen(0,0);let U=new THREE.Vector2(_.x-P.x,_.y-P.y);return 0!=(P=U.y-Math.floor(U.y))&&(U.y-=P,_=new THREE.Vector2(_.x-U.x,_.y-U.y),g=L.IsoCoords.screenToWorld(_.x,_.y)),{spriteOffset:U,anchorPointWorld:g}}})}}}),System.register("engine/renderable/RenderablePlugin",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("engine/renderable/ShadowRenderable",["data/Palette","engine/renderable/builder/ShpBuilder","game/Coords","engine/IsoCoords","engine/renderable/entity/map/MapSurface"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){g("ShadowRenderable",class l{static getOrCreateShadowPalette(){let g=l.shadowPalette;return g||(g=new I.Palette(new Array(768).fill(0)),l.shadowPalette=g),g}constructor(g,P,I,L=0){this.shpFile=g,this.camera=P,this.shadowHeightTileAdjust=L,this.baseFrameNo=0,this.frameOffset=0,this.visible=!0,this.useBatching=!1,this.drawOffset={...I}}setVisible(g){var P;this.visible=g,this.object3d&&(P=this.computeShadowFrameNo(this.baseFrameNo),this.object3d.visible=g&&this.frameHasShadowData(P))}setSize(g){this.shpSize=g,this.builder?.setSize(g)}setBatched(g){this.useBatching=g,this.builder?.setBatched(g)}setBaseFrame(g){var P;this.baseFrameNo=g,this.builder&&(P=this.computeShadowFrameNo(g),this.builder.setFrame(P),this.object3d.visible=this.visible&&this.frameHasShadowData(P))}setFrameOffset(g){this.frameOffset=g,this.builder&&this.builder.setFrameOffset(g)}computeShadowFrameNo(g){return g<this.shpFile.numImages?this.shpFile.numImages/2+g:1}create3DObject(){if(!this.object3d){var g=l.getOrCreateShadowPalette();let I=new L.ShpBuilder(this.shpFile,g,this.camera,_.Coords.ISO_WORLD_SCALE);this.shpSize&&I.setSize(this.shpSize),I.setFrameOffset(this.frameOffset),I.setBatched(this.useBatching),this.useBatching&&I.setBatchPalettes([g]),I.flat=!0;var P=this.computeShadowFrameNo(this.baseFrameNo);I.setFrame(P),this.shadowHeightTileAdjust&&(g=U.IsoCoords.tileHeightToScreen(this.shadowHeightTileAdjust),this.drawOffset.y+=-g),I.setOffset(this.drawOffset),I.setOpacity(.5);let V=I.build();this.shadowHeightTileAdjust&&(V.position.y+=_.Coords.tileHeightToWorld(-this.shadowHeightTileAdjust),V.updateMatrix()),V.visible=this.visible&&this.frameHasShadowData(P),V.position.y+=G.MAGIC_OFFSET/5,V.updateMatrix(),this.builder=I,this.object3d=V}}frameHasShadowData(g){return!!this.shpFile.getImage(this.frameOffset+g).imageData.length}get3DObject(){return this.object3d}update(g){}dispose(){this.builder?.dispose()}})}}}),System.register("engine/renderable/ShpRenderable",["engine/renderable/builder/ShpBuilder","engine/renderable/ShadowRenderable","game/Coords"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("ShpRenderable",class{static factory(g,P,U,G,V=!1,W=0,z=!1,K=0,q=!1){var $=V?new L.ShadowRenderable(g,U,G,W):void 0,Q=_.Coords.ISO_WORLD_SCALE;let Y,Z=new I.ShpBuilder(g,P,U,Q,z,K);return Z.setOffset(G),q&&(Y=new I.ShpBuilder(g,P,U,Q,z,K),Y.setOffset(G),Y.flat=!0),new this(Z,$,Y)}constructor(g,P,I){this.builder=g,this.shadowRenderable=P,this.zShapeFixBuilder=I}get3DObject(){return this.target}setBatched(g){this.builder.setBatched(g),this.zShapeFixBuilder?.setBatched(g),this.shadowRenderable?.setBatched(g)}setBatchPalettes(g){this.builder.setBatchPalettes(g),this.zShapeFixBuilder?.setBatchPalettes(g)}setSize(g){this.builder.setSize(g),this.zShapeFixBuilder?.setSize(g),this.shadowRenderable?.setSize(g)}getFlat(){return this.builder.flat}setFlat(g){this.builder.flat=g}setFrame(g){this.builder.getFrame()!==g&&(this.builder.setFrame(g),this.zShapeFixBuilder?.setFrame(g),this.shadowRenderable?.setBaseFrame(g))}setFrameOffset(g){this.builder.setFrameOffset(g),this.zShapeFixBuilder?.setFrameOffset(g),this.shadowRenderable?.setFrameOffset(g)}setPalette(g){this.builder.setPalette(g),this.zShapeFixBuilder?.setPalette(g)}setExtraLight(g){this.builder.setExtraLight(g),this.zShapeFixBuilder?.setExtraLight(g)}setOpacity(g){this.builder.setOpacity(g),this.zShapeFixBuilder?.setOpacity(g)}setForceTransparent(g){this.builder.setForceTransparent(g),this.zShapeFixBuilder?.setForceTransparent(g)}get frameCount(){return this.shadowRenderable?this.builder.frameCount/2:this.builder.frameCount}getShapeMesh(){return this.shapeMesh}getShadowMesh(){return this.shadowMesh}setShadowVisible(g){this.shadowRenderable?.setVisible(g)}create3DObject(){if(!this.target){var g,P=this.shapeMesh=this.builder.build();if(this.shadowRenderable||this.zShapeFixBuilder){let I=new THREE.Object3D;I.matrixAutoUpdate=!1,I.add(P),this.shadowRenderable&&(this.shadowRenderable.create3DObject(),g=this.shadowMesh=this.shadowRenderable.get3DObject(),I.add(g)),this.zShapeFixBuilder&&(g=this.zShapeFixBuilder.build(),I.add(g)),this.target=I}else this.target=P}}update(g){}dispose(){this.builder.dispose(),this.zShapeFixBuilder?.dispose(),this.shadowRenderable?.dispose()}})}}}),System.register("engine/renderable/WithPosition",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("WithPosition",class{constructor(){this.matrixUpdate=!1,this.position=new THREE.Vector3}setPosition(g,P,I){this.position.x=g,this.position.y=P,this.position.z=I,this.updatePosition()}getPosition(){return this.position}updatePosition(){if(this.target){let g=this.target.get3DObject();g&&(g.position.set(this.position.x,this.position.y,this.position.z),this.matrixUpdate&&(g.matrix.setPosition(g.position),g.matrixWorldNeedsUpdate=!0))}}applyTo(g){this.target=g,this.updatePosition()}})}}}),System.register("engine/renderable/WithVisibility",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("WithVisibility",class{constructor(){this.visible=!0}setVisible(g){this.visible=g,this.updateVisibility()}isVisible(){return this.visible}updateVisibility(){if(this.target){let g=this.target.get3DObject();g&&(g.visible=this.visible)}}applyTo(g){this.target=g,this.updateVisibility()}})}}}),System.register("engine/renderable/WorldScene",["util/geometry","engine/gfx/RenderableContainer","engine/renderable/CameraPan","engine/renderable/CameraZoom","engine/type/LightingType","game/Coords","util/event","engine/renderable/entity/unit/ShadowQuality","engine/gfx/batch/MeshBatchManager"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g}],execute:function(){q=new Map([[z.ShadowQuality.High,8],[z.ShadowQuality.Medium,4],[z.ShadowQuality.Low,2]]),$=class p extends L.RenderableContainer{get onBeforeCameraUpdate(){return this._onBeforeCameraUpdate.asEvent()}get onCameraUpdate(){return this._onCameraUpdate.asEvent()}static factory(g,P,I){let L=new THREE.Scene;L.matrixAutoUpdate=!1;var G=p.createCamera(g),V=new _.CameraPan(P),W=new U.CameraZoom(P);return new p(L,G,g,V,W,I)}static getCameraParams(g){var P=V.Coords.ISO_CAMERA_ALPHA,I=V.Coords.ISO_CAMERA_BETA,L=V.Coords.ISO_WORLD_SCALE;return{alpha:P,beta:I,d:g.height/2*V.Coords.COS_ISO_CAMERA_BETA*L,aspect:g.width/g.height,far:16e3*L}}static createCamera(g){var{alpha:P,beta:I,d:L,aspect:_,far:U}=this.getCameraParams(g);let G=new THREE.OrthographicCamera(-L*_,L*_,L,-L,0,U);return G.rotation.order="YXZ",G.rotation.y=+I,G.rotation.x=-P,G}constructor(g,P,I,L,_,U){super(g),this.scene=g,this.camera=P,this.viewport=I,this.cameraPan=L,this.cameraZoom=_,this.shadowQuality=U,this.initialized=!1,this.ambientLight=new THREE.AmbientLight(16777215,.8),this.directionalLight=new THREE.DirectionalLight(16777215,1),this._onBeforeCameraUpdate=new W.EventDispatcher,this._onCameraUpdate=new W.EventDispatcher}updateViewport(g){this.viewport=g;var{d:P,aspect:I}=p.getCameraParams(g);let L=this.camera;L.left=-P*I,L.right=P*I,L.top=P,L.bottom=-P,L.updateProjectionMatrix()}updateCamera(g,P){let I=this.camera;I.updateMatrix();var L=I.matrix.elements;let _=new THREE.Vector3;I.position.set(0,0,0),I.translateZ(16e3*V.Coords.ISO_WORLD_SCALE),_.set(L[0],L[1],L[2]),_.multiplyScalar(g.x*(I.right-I.left)/this.viewport.width/I.zoom),I.position.add(_),_.set(L[4],L[5],L[6]),_.multiplyScalar(-g.y*(I.top-I.bottom)/this.viewport.height/I.zoom),I.position.add(_),I.zoom=P,I.updateProjectionMatrix(),I.updateMatrixWorld(!1)}create3DObject(){if(super.create3DObject(),!this.initialized){this.initialized=!0,this.scene.position.x-=.1*V.Coords.ISO_WORLD_SCALE,this.scene.position.z-=.1*V.Coords.ISO_WORLD_SCALE,this.scene.updateMatrix();var g=new THREE.AxesHelper(V.Coords.LEPTONS_PER_TILE);this.scene.add(g),this.scene.add(this.ambientLight);let P=this.directionalLight;P.position.set(-87.012,204.338,195.409),this.lightFocusPoint&&(P.position.x+=this.lightFocusPoint.x,P.position.z+=this.lightFocusPoint.y,P.target.position.set(this.lightFocusPoint.x,0,this.lightFocusPoint.y),P.target.updateMatrixWorld(void 0)),this.updateShadowQuality(P,this.shadowQuality.value),this.shadowQualityListener=()=>this.updateShadowQuality(P,this.shadowQuality.value),this.shadowQuality.onChange.subscribe(this.shadowQualityListener),this.scene.add(P),this.scene.add(this.camera),g=this.meshBatchManager=new K.MeshBatchManager(this),this.add(g),this.scene.autoUpdate=!1}}updateShadowQuality(g,P){var I=P!==z.ShadowQuality.Off;if(g.castShadow=I){var L=V.Coords.ISO_WORLD_SCALE;I=3500*L;let _=g.shadow.camera;if(_.right=I,_.left=-I,_.top=I,_.bottom=-I,_.near=-4e3*L,_.far=3e3*L,!(L=q.get(P)))throw new Error(`Unsupported shadow quality "${P}"`);g.shadow.mapSize.width=1024*L,g.shadow.mapSize.height=1024*L}}setLightFocusPoint(g,P){this.lightFocusPoint={x:g,y:P}}applyLighting(g){var P=g.computeTint(G.LightingType.Ambient);this.ambientLight.color.setRGB(P.x,P.y,P.z),this.directionalLight.color.setRGB(P.x,P.y,P.z),P=g.getAmbientIntensity(),this.ambientLight.intensity=.8*P,this.directionalLight.intensity=P}update(g,P){super.update(g,P),this._onBeforeCameraUpdate.dispatch(this,g);var L=this.cameraZoom.getZoom(),_=this.cameraPan.getPan();I.pointEquals(_,this.lastCameraPan)&&this.lastCameraZoom===L||(this.updateCamera(_,L),this.lastCameraZoom=L,this.lastCameraPan=_),this._onCameraUpdate.dispatch(this,g),this.scene.updateMatrixWorld(!1),this.meshBatchManager.updateMeshes()}dispose(){this.shadowQualityListener&&(this.shadowQuality.onChange.unsubscribe(this.shadowQualityListener),this.shadowQualityListener=void 0),this.directionalLight.shadow.map?.dispose(),this.meshBatchManager&&(this.meshBatchManager.dispose(),this.remove(this.meshBatchManager),this.meshBatchManager=void 0),this.scene.remove(this.ambientLight),this.scene.remove(this.directionalLight)}},g("WorldScene",$)}}}),System.register("engine/RenderableManager",["engine/gfx/OctreeContainer"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("RenderableManager",class{constructor(g,P,I,L){this.world=g,this.worldScene=P,this.camera=I,this.renderableFactory=L,this.renderablesByGameObject=new Map,this.renderablesById=new Map,this.positionListeners=new Map,this.onCameraUpdate=()=>{this.container.cullChildren()},this.onWorldObjectSpawned=g=>{var P=g.isTechno()&&g.rules.isLightpost;let I=this.createRenderable(g,P?this.worldScene:this.container);I.onCreate&&I.onCreate(this),P=({tileChanged:P})=>this.onObjectPositionChanged(g,P),this.positionListeners.set(g,P),g.position.onPositionChange.subscribe(P)},this.onWorldObjectRemoved=g=>{g.position.onPositionChange.unsubscribe(this.positionListeners.get(g)),this.positionListeners.delete(g);let P=this.renderablesByGameObject.get(g);if(P.onRemove){let I=P.onRemove(this);I?I.then(()=>this.removeAndDisposeRenderable(P,g)).catch(g=>console.error(g)):this.removeAndDisposeRenderable(P,g)}else this.removeAndDisposeRenderable(P,g)}}init(){let g=this.container=I.OctreeContainer.factory(this.camera);g.autoCull=!1,this.worldScene.add(g),this.worldScene.onCameraUpdate.subscribe(this.onCameraUpdate),this.world.getAllObjects().forEach(g=>this.onWorldObjectSpawned(g)),this.world.onObjectSpawned.subscribe(this.onWorldObjectSpawned),this.world.onObjectRemoved.subscribe(this.onWorldObjectRemoved)}getRenderableById(g){return this.renderablesById.get(g)}getRenderableByGameObject(g){return this.renderablesByGameObject.get(g)}getRenderableContainer(){return this.container}onObjectPositionChanged(g,P){let I=this.renderablesByGameObject.get(g);I.setPosition(g.position.worldPosition),g.isTechno()&&g.rules.isLightpost||this.container.updateChild(I)}removeAndDisposeRenderable(g,P){(P.isTechno()&&P.rules.isLightpost?this.worldScene:this.container).remove(g),g.dispose?.(),this.renderablesByGameObject.delete(P),this.renderablesById.delete(P.id)}createTransientAnim(g,P){var I=this.renderableFactory.createTransientAnim(g,this.container);return P?.(I),this.container.add(I),I}createAnim(g,P,I=!1){var L=this.renderableFactory.createAnim(g);return P?.(L),I||this.container.add(L),L}addEffect(g){g.setContainer(this.worldScene),this.worldScene.add(g)}dispose(){this.worldScene.remove(this.container),this.container=void 0,this.worldScene.onCameraUpdate.unsubscribe(this.onCameraUpdate),this.world.onObjectSpawned.unsubscribe(this.onWorldObjectSpawned),this.world.onObjectRemoved.unsubscribe(this.onWorldObjectRemoved),this.onWorldObjectRemoved=void 0,this.onWorldObjectSpawned=void 0,this.positionListeners.forEach((g,P)=>P.position.onPositionChange.unsubscribe(g)),this.positionListeners.clear(),this.renderablesById.forEach(g=>g.dispose?.())}createRenderable(g,P){let I=this.renderableFactory.create(g);return I.setPosition(g.position.worldPosition),P.add(I),this.renderablesByGameObject.set(g,I),this.renderablesById.set(g.id,I),I}updateLighting(){for(var g of this.renderablesById.values())g.updateLighting()}})}}}),System.register("engine/ResourceCollection",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("engine/resourceConfigs",["engine/TheaterType"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){var P;(P=L||g("ResourceType",L={}))[P.IsoSnow=0]="IsoSnow",P[P.IsoTemp=1]="IsoTemp",P[P.IsoUrb=2]="IsoUrb",P[P.BuildGen=3]="BuildGen",P[P.TheaterSnow=4]="TheaterSnow",P[P.TheaterTemp=5]="TheaterTemp",P[P.TheaterUrb=6]="TheaterUrb",P[P.TheaterSnow2=7]="TheaterSnow2",P[P.TheaterTemp2=8]="TheaterTemp2",P[P.TheaterUrb2=9]="TheaterUrb2",P[P.Ui=10]="Ui",P[P.UiAlly=11]="UiAlly",P[P.UiSov=12]="UiSov",P[P.Anims=13]="Anims",P[P.Vxl=14]="Vxl",P[P.Cameo=15]="Cameo",P[P.Ini=16]="Ini",P[P.Strings=17]="Strings",P[P.EvaAlly=18]="EvaAlly",P[P.EvaSov=19]="EvaSov",P[P.Sounds=20]="Sounds",P[P.HalloweenMix=21]="HalloweenMix",P[P.XmasMix=22]="XmasMix",g("resourceConfigs",(new Map).set(L.IsoSnow,{id:"isoSnow",src:"isosnow.mix",type:"binary",sizeHint:28758698}).set(L.IsoTemp,{id:"isoTemp",src:"isotemp.mix",type:"binary",sizeHint:29171410}).set(L.IsoUrb,{id:"isoUrb",src:"isourb.mix",type:"binary",sizeHint:31811402}).set(L.BuildGen,{id:"buildGen",src:"build-gen.mix",type:"binary",sizeHint:27801690}).set(L.TheaterSnow,{id:"theater.snow",src:"snow.mix",type:"binary",sizeHint:18421274}).set(L.TheaterTemp,{id:"theater.temp",src:"temperat.mix",type:"binary",sizeHint:2728266}).set(L.TheaterUrb,{id:"theater.urb",src:"urban.mix",type:"binary",sizeHint:2726218}).set(L.TheaterSnow2,{id:"theater.snow2",src:"sno.mix",type:"binary",sizeHint:10898}).set(L.TheaterTemp2,{id:"theater.temp2",src:"tem.mix",type:"binary",sizeHint:10850}).set(L.TheaterUrb2,{id:"theater.urb2",src:"urb.mix",type:"binary",sizeHint:10850}).set(L.UiAlly,{id:"uially",src:"sidec01.mix",type:"binary",sizeHint:2099412}).set(L.UiSov,{id:"uisov",src:"sidec02.mix",type:"binary",sizeHint:2102564}).set(L.Anims,{id:"anims",src:"anims.mix",type:"binary",sizeHint:15867898}).set(L.Vxl,{id:"vxl",src:"vxl.mix",type:"binary",sizeHint:5271701}).set(L.Cameo,{id:"cameo",src:"cameo.mix",type:"binary",sizeHint:608120}).set(L.Ini,{id:"ini",src:"ini.mix",type:"binary",sizeHint:1000842}).set(L.Ui,{id:"ui",src:"ui.mix",type:"binary",sizeHint:4424093}).set(L.Strings,{id:"strings",src:"strings.mix",type:"binary",sizeHint:485818}).set(L.EvaAlly,{id:"evaally",src:"eva-ally.mix",type:"binary",sizeHint:1835436}).set(L.EvaSov,{id:"evasov",src:"eva-sov.mix",type:"binary",sizeHint:2021760}).set(L.Sounds,{id:"sounds",src:"sounds.mix",type:"binary",sizeHint:17684750}).set(L.HalloweenMix,{id:"halloweenmix",src:"expandspawn09.mix",type:"binary",sizeHint:20312}).set(L.XmasMix,{id:"xmasmix",src:"expandspawn10.mix",type:"binary",sizeHint:10318})),g("resourcesForPrefetch",[L.BuildGen,L.Sounds,L.Anims,L.Vxl,L.IsoUrb,L.TheaterUrb,L.TheaterUrb2,L.IsoTemp,L.TheaterTemp,L.TheaterTemp2,L.IsoSnow,L.TheaterSnow,L.TheaterSnow2]),g("theaterSpecificResources",new Map([[I.TheaterType.Snow,[L.TheaterSnow,L.TheaterSnow2,L.IsoSnow]],[I.TheaterType.Temperate,[L.TheaterTemp,L.TheaterTemp2,L.IsoTemp]],[I.TheaterType.Urban,[L.TheaterUrb,L.TheaterUrb2,L.IsoUrb]]]))}}}),System.register("engine/ResourceLoader",["@puzzl/core/lib/async/cancellation","network/HttpRequest","engine/resourceConfigs"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(P){g({DownloadError:(L=P).DownloadError})},function(g){_=g}],execute:function(){g("ResourceLoader",class{constructor(g){this.resourceBaseUrl=g,this.httpRequest=new L.HttpRequest}async prefetchResource(g,P){let L=this.getResourceUrl(g);const _=document.createElement("link");_.rel="prefetch",_.as="fetch",_.href=L,_.crossOrigin="anonymous",await new Promise((g,U)=>{P?.register(()=>{_.parentNode&&(document.head.removeChild(_),U(new I.OperationCanceledError(P)))}),"onload"in _&&(_.onload=()=>{document.head.removeChild(_),g()}),"onerror"in _&&(_.onerror=()=>{document.head.removeChild(_),U(new Error(`Couldn't prefetch URL "${L}"`))}),document.head.appendChild(_),"onload"in _||(document.head.removeChild(_),g())})}getResourceUrl(g){var P="object"==typeof g?g:_.resourceConfigs.get(g);if(!P)throw new Error("Missing resourceConfig for resType "+_.ResourceType[g]);return this.resourceBaseUrl+P.src}getResourceFileName(g){return this.getResourceUrl(g).split("?")[0].split("/").pop()}buildResourceManifest(g){return g.map(g=>{if("object"==typeof g)return g;if(!_.resourceConfigs.has(g))throw new Error("Missing resourceConfig for resType "+_.ResourceType[g]);return _.resourceConfigs.get(g)}).map(g=>({id:g.id,src:g.src.match(/^https?:\/\//)?g.src:this.resourceBaseUrl+g.src,type:g.type,sizeHint:g.sizeHint}))}async loadText(g,P,I){return await this.loadResource({src:g,type:"text"},P,I)}async loadBinary(g,P,I){return await this.loadResource({src:g,type:"binary"},P,I)}async loadJson(g,P,I){return await this.loadResource({src:g,type:"json"},P,I)}async loadResource(g,P,I){var L=await this.fetchResource(this.resourceBaseUrl+g.src,P,I);return this.httpRequest.parseResult(g.type,L)}async loadResources(g,P,I){let L=this.buildResourceManifest(g),_=new Map;var G,V=L.length;let W=0,z=L.reduce((g,{sizeHint:P})=>g+(P??0),0),K=0;for(G of L){var q=await this.fetchResource(G.src,P,{onProgress:g=>{K+=g,z&&I?.(Math.floor(100*Math.min(1,K/z)))}});_.set(G.id,q),W++,z||I?.(Math.floor(W/V*100))}return new U(_)}async fetchResource(g,P,I){return await this.httpRequest.fetchRaw(g,P,I)}}),g("LoaderResult",U=class{constructor(g){this.items=g}pop(g){let P;if("string"==typeof g)P=g;else{if(!_.resourceConfigs.has(g))throw new Error(`Missing resourceConfig for resource type "${_.ResourceType[g]}"`);if(P=_.resourceConfigs.get(g).id,!P)throw new Error("Undefined resourceId for resourceType "+g)}var I=this.items.get(P);if(!I)throw new Error(`Resource type "${g}" not found in result.`);return this.items.delete(P),I}})}}}),System.register("engine/sound/AudioLoop",["util/math"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("AudioLoop",class{constructor(g,P,I,L,_,U,G,V,W){this.audioContext=g,this.volume=P,this.pan=I,this.rate=L,this.delayMs=_,this.attack=U,this.decay=G,this.playBuffer=W,this.isLoop=!0,this.items=[],this.playing=!1,this.handleSoundEnded=()=>{this.playing&&(this.removeCompleted(),this.fill(this.buffers),this.remainingLoops||this.items.length||this.stop())},this.remainingLoops=V}setBuffers(g){this.buffers=g,this.playing&&(this.timePointer=Math.max(this.timePointer,this.audioContext.currentTime),this.fill(this.buffers))}start(g){if(this.playing)throw new Error("Already playing");this.timePointer=g,this.playing=!0,this.buffers&&this.fill(this.buffers)}isPlaying(){return this.playing}stop(){var g;this.playing&&(this.playing=!1,this.decay&&this.buffers?(this.removeCompleted(),this.items.length&&(g=this.items[0].startTime+this.items[0].duration,this.items.splice(1).forEach(g=>g.handle.stop()),this.queueBuffer(this.buffers[this.buffers.length-1],g))):(this.items.forEach(g=>g.handle.stop()),this.items.length=0))}setVolume(g){this.volume=g,this.items.forEach(P=>P.handle.setVolume(g))}setPan(g){this.pan=g,this.items.forEach(P=>P.handle.setPan(g))}add(g){this.items.push(g)}removeCompleted(){this.items=this.items.filter(g=>g.startTime+g.duration>=this.audioContext.currentTime)}fill(g){let P=this.items.length?this.timePointer-this.items[0].startTime:0;for(;P<.1||this.items.length<3;){if(!this.attack||void 0!==this.bufferPointer){if(this.remainingLoops<=0)break;this.remainingLoops--}this.attack?this.bufferPointer=void 0===this.bufferPointer?0:I.getRandomInt(1,g.length-1-(this.decay?1:0)):this.bufferPointer=I.getRandomInt(0,g.length-1);var L=g[this.bufferPointer];L=this.queueBuffer(L,this.timePointer);this.timePointer+=L,P+=L}}queueBuffer(g,P){var L=this.delayMs?I.getRandomInt(this.delayMs.min,this.delayMs.max)/1e3:0,_=P+L,U=g.duration/this.rate;let{handle:G,source:V}=this.playBuffer(g,_,this.volume,this.pan,this.rate);return V.addEventListener("ended",this.handleSoundEnded),this.add({startTime:_,duration:U,handle:G}),U+L}})}}}),System.register("engine/sound/AudioSequence",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("AudioSequence",class{constructor(g,P,I,L,_,U){this.audioContext=g,this.volume=P,this.pan=I,this.rate=L,this.delayMs=_,this.playBuffer=U,this.isLoop=!1,this.items=[],this.playing=!1,this.handleSoundEnded=()=>{this.playing&&(this.removeCompleted(),this.items.length||(this.playing=!1))}}setBuffers(g){this.buffers=g,this.playing&&(this.timePointer=Math.max(this.timePointer,this.audioContext.currentTime),this.fill(this.buffers))}start(g){if(this.playing)throw new Error("Already playing");this.timePointer=g,this.playing=!0,this.buffers&&this.fill(this.buffers)}isPlaying(){return this.playing}stop(){this.playing&&(this.playing=!1,this.items.forEach(g=>g.handle.stop()),this.items.length=0)}setVolume(g){this.volume=g,this.items.forEach(P=>P.handle.setVolume(g))}setPan(g){this.pan=g,this.items.forEach(P=>P.handle.setPan(g))}add(g){this.items.push(g)}removeCompleted(){this.items=this.items.filter(g=>g.startTime+g.duration>=this.audioContext.currentTime)}fill(g){let P=this.delayMs?this.delayMs/1e3:0;for(var I of g)I=this.queueBuffer(I,this.timePointer,P),this.timePointer+=I,P=0}queueBuffer(g,P,I){var L=P+I,_=g.duration/this.rate;let{handle:U,source:G}=this.playBuffer(g,L,this.volume,this.pan,this.rate);return G.addEventListener("ended",this.handleSoundEnded),this.add({startTime:L,duration:_,handle:U}),_+I}})}}}),System.register("engine/sound/AudioSystem",["engine/sound/ChannelType","util/disposable/CompositeDisposable","engine/sound/InternalPlaybackHandle","engine/sound/AudioLoop","engine/sound/AudioSequence"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){V="data:audio/mpeg;base64,/+MYxAAAAANIAUAAAASEEB/jwOFM/0MM/90b/+RhST//w4NFwOjf///PZu////9lns5GFDv//l9GlUIEEIAAAgIg8Ir/JGq3/+MYxDsLIj5QMYcoAP0dv9HIjUcH//yYSg+CIbkGP//8w0bLVjUP///3Z0x5QCAv/yLjwtGKTEFNRTMuOTeqqqqqqqqqqqqq/+MYxEkNmdJkUYc4AKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq",g("AudioSystem",class{constructor(g){this.mixer=g,this.channels=new Map,this.audioBufferCache=new Map,this.disposables=new L.CompositeDisposable,this.soundsPlaying=new Set,this.handleVolumeChange=(g,P)=>{this.getChannel(g).gain.value=P.isMuted(g)?0:P.getVolume(g)}}isInitialized(){return!!this.audioContext}isSuspended(){return"running"!==this.audioContext?.state}initialize(){this.isInitialized()||(this.audioContext=new AudioContext,this.mixer.onVolumeChange.subscribe(this.handleVolumeChange),this.disposables.add(()=>this.mixer.onVolumeChange.unsubscribe(this.handleVolumeChange)),this.createChannels(this.audioContext,this.mixer))}dispose(){this.disposables.dispose(),this.audioContext&&(this.audioContext.close(),this.soundsPlaying.clear())}createChannels(g,P){let L=Object.keys(I.ChannelType).map(Number).filter(g=>!Number.isNaN(g));L.forEach(I=>{let L=g.createGain();L.gain.value=P.getVolume(I),this.channels.set(I,L)});let _=this.getChannel(I.ChannelType.Master);L.forEach(P=>{let L=this.getChannel(P);var U;P===I.ChannelType.Master?L.connect(g.destination):P===I.ChannelType.Effect?(U=g.createDynamicsCompressor(),L.connect(U).connect(_)):L.connect(_)})}getChannel(g){if(!this.channels.has(g))throw new Error(`Sound channel "${g}" doesn't exist`);return this.channels.get(g)}setMuted(g){this.mixer.setMuted(I.ChannelType.Master,g)}playWavFile(g,P,I=1,L=0,_=0,U=1,G=!1){if(!this.isInitialized())throw new Error("Can't play audio file because audio system is not initialized");var V=this.audioContext.currentTime+_/1e3;return this.removeSuspendedSounds(),this.playWavFileAtTime(g,P,V,I,L,U,G)}removeSuspendedSounds(){this.isSuspended()&&this.soundsPlaying.forEach(g=>{try{g.stop()}catch(g){console.error(g)}})}playWavLoop(g,P,I=1,L=0,G,V=1,W=!1,z=!1,K=Number.POSITIVE_INFINITY){if(!this.isInitialized())throw new Error("Can't play audio sequence because audio system is not initialized");let q=this.audioContext;this.removeSuspendedSounds();let $=new U.AudioLoop(q,I,L,V,G,W,z,K,(g,I,L,U,G)=>{var V=new _.InternalPlaybackHandle;return{handle:V,source:this.playAudioBuffer(V,g,P,L,U,I,G,!1)}});return Promise.all(g.map(g=>this.decodeFile(g,q))).then(g=>{$.setBuffers(g)}).catch(g=>console.error(g)),$.start(q.currentTime),$}playWavSequence(g,P,I=1,L=0,U=0,V=1){if(!this.isInitialized())throw new Error("Can't play audio sequence because audio system is not initialized");let W=this.audioContext;this.removeSuspendedSounds();let z=new G.AudioSequence(W,I,L,V,U,(g,I,L,U,G)=>{var V=new _.InternalPlaybackHandle;return{handle:V,source:this.playAudioBuffer(V,g,P,L,U,I,G,!1)}});return Promise.all(g.map(g=>this.decodeFile(g,W))).then(g=>{z.setBuffers(g)}).catch(g=>console.error(g)),z.start(W.currentTime),z}async decodeFile(g,P){let I=this.audioBufferCache.get(g);var L;return I||(L=new Uint8Array(g.getData()).buffer,I=await P.decodeAudioData(L),100<=this.audioBufferCache.size&&this.audioBufferCache.delete(this.audioBufferCache.keys().next().value),this.audioBufferCache.set(g,I)),I}playWavFileAtTime(g,P,I,L=1,U=0,G=1,V=!1){if(!this.isInitialized())throw new Error("Can't play audio file because audio system is not initialized");let W=this.audioContext,z=new _.InternalPlaybackHandle;var K=this.audioBufferCache.get(g);if(K)this.playAudioBuffer(z,K,P,L,U,I,G,V);else{let _;try{var q=g.getData();_=new Uint8Array(q).buffer}catch(K){return console.error("Failed to decode wav file",K),z}(async()=>{var K=await W.decodeAudioData(_);100<=this.audioBufferCache.size&&this.audioBufferCache.delete(this.audioBufferCache.keys().next().value),this.audioBufferCache.set(g,K),z.stopRequested||this.playAudioBuffer(z,K,P,L,U,I,G,V)})().catch(g=>console.error(g))}return z}playAudioBuffer(g,P,I,L,_,U,G,V){let W=this.audioContext,z=W.createGain();z.gain.value=L;let K=W.createStereoPanner();K.pan.value=_;let q=W.createBufferSource();return q.buffer=P,q.playbackRate.value=G,q.loop=V,q.connect(K).connect(z).connect(this.getChannel(I)),g.setNodes(q,z,K),q.addEventListener("ended",()=>{this.soundsPlaying.delete(q),g.playing=!1}),this.soundsPlaying.add(q),q.start(U),q}async initMusicLoop(){if(!this.isInitialized())throw new Error("Can't initialize music loop because audio system is not initialized");this.musicState||this.initMusicNode()}async playMusicFile(g,P,I){if(!this.isInitialized())throw new Error("Can't play audio file because audio system is not initialized");this.removeSuspendedSounds(),this.stopMusic();let L=this.musicState??this.initMusicNode(),_=L.source.mediaElement;_.loop=P;let U=_.src=URL.createObjectURL(g.asFile());_.onended=_.onpause=()=>{URL.revokeObjectURL(U),_=void 0},I&&(L.onEnd=I,_.addEventListener("ended",L.onEnd,{once:!0})),await this.playOrResumeMusic()}initMusicNode(){let g=this.audioContext,P=g.createGain();P.gain.value=1;let L=g.createStereoPanner();L.pan.value=0;let _=document.createElement("audio");_.src=V,_.loop=!0;let U=g.createMediaElementSource(_);return this.musicState={source:U,playing:!1},U.addEventListener("ended",()=>{this.musicState.playing=!1}),U.connect(L).connect(P).connect(this.getChannel(I.ChannelType.Music)),this.musicState}async playOrResumeMusic(){if(this.musicState&&!this.musicState.playing){this.musicState.playing=!0;try{await(this.musicState.source.mediaElement.play()?.catch(g=>console.error(g)))}catch(g){console.error(g),this.musicState.playing=!1}}}stopMusic(){if(this.musicState?.playing)try{this.musicState.onEnd&&this.musicState.source.mediaElement.removeEventListener("ended",this.musicState.onEnd),this.musicState.source.mediaElement.pause(),this.musicState.source.mediaElement.src=V,this.musicState.playing=!1,this.musicState.onEnd=void 0}catch(g){console.error(g)}}})}}}),System.register("engine/sound/ChannelType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("ChannelType",I={}))[P.Master=0]="Master",P[P.Ui=1]="Ui",P[P.Ambient=2]="Ambient",P[P.Effect=3]="Effect",P[P.Voice=4]="Voice",P[P.Music=5]="Music",P[P.CreditTicks=6]="CreditTicks"}}}),System.register("engine/sound/Eva",["engine/sound/ChannelType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("Eva",class{constructor(g,P,L){this.evaSpecs=g,this.sound=P,this.renderer=L,this.evaWaitingList=[],this.lastEvaEventBySpec=new Map,this.handleFrame=g=>{var P,L;this.currentEvaPlaying?.isPlaying()?this.evaWaitingList=this.evaWaitingList.filter(g=>g.queue):(this.currentEvaPlaying=void 0,this.evaWaitingList.sort((g,P)=>P.priority-g.priority),this.evaWaitingList=this.evaWaitingList.filter(P=>5e3<=g-(this.lastEvaEventBySpec.get(P)||0)),this.evaWaitingList.length&&(P=this.evaWaitingList.shift(),(L=this.sound.getWavFile(P.sound))&&(this.currentEvaPlaying=this.sound.audioSystem.playWavFile(L,I.ChannelType.Voice),this.lastEvaEventBySpec.set(P,g),this.evaWaitingList.splice(1))))}}init(){this.renderer.onFrame.subscribe(this.handleFrame)}dispose(){this.renderer.onFrame.unsubscribe(this.handleFrame),this.currentEvaPlaying?.stop()}play(g,P=!1){let I=this.evaSpecs.getSpec(g);I?(P&&(I={...I,queue:!0}),this.evaWaitingList.push(I)):console.warn(`No EVA with name ${g} was found. Skipping.`)}})}}}),System.register("engine/sound/EvaSpecs",["game/SideType"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g}],execute:function(){var P;L=(new Map).set(I.SideType.GDI,"Allied").set(I.SideType.Nod,"Russian").set(I.SideType.ThirdSide,"Yuri"),(P=_||g("EvaPriority",_={}))[P.Low=0]="Low",P[P.Normal=1]="Normal",P[P.Important=2]="Important",P[P.Critical=3]="Critical",g("EvaSpecs",class{constructor(g){this.sideType=g,this.specs=new Map}readIni(g){let P=g.getSection("DialogList");if(!P)throw new Error("Missing eva.ini [DialogList] section");var U,G,V=new Set(P.entries.values()),W=L.get(this.sideType);if(!W)throw new Error(`Unhandled side type "${I.SideType[this.sideType]}"`);for(U of V)if(U){let P=g.getSection(U);P?(G={text:P.getString("Text"),sound:P.getString(W),priority:P.getEnum("Priority",_,_.Normal,!0),queue:"queue"===P.getString("Type").trim().toLowerCase()},this.specs.set(U,G)):console.warn(`Missing eva section [${U}]`)}return this}getSpec(g){return this.specs.get(g)}})}}}),System.register("engine/sound/InternalPlaybackHandle",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("InternalPlaybackHandle",class{constructor(){this.playing=!0,this.isLoop=!1,this.stopRequested=!1}setNodes(g,P,I){this.sourceNode=g,this.gainNode=P,this.panNode=I,this.stopRequested?this.stop():(this.volumeRequested&&(P.gain.value=this.volumeRequested),this.panRequested&&(I.pan.value=this.panRequested))}isPlaying(){return this.playing}stop(){try{this.sourceNode?this.sourceNode.stop():this.stopRequested=!0,this.playing=!1}catch(g){console.error(g)}}setVolume(g){this.gainNode?this.gainNode.gain.value=g:this.volumeRequested=g}setPan(g){this.panNode?this.panNode.pan.value=g:this.panRequested=g}})}}}),System.register("engine/sound/Mixer",["util/event"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("Mixer",class{constructor(){this.volumes=new Map,this.mutes=new Map,this._onVolumeChange=new I.EventDispatcher}get onVolumeChange(){return this._onVolumeChange.asEvent()}setVolume(g,P){this.getVolume(g)!==P&&(this.volumes.set(g,P),this._onVolumeChange.dispatch(this,g))}getVolume(g){return this.volumes.get(g)??1}setMuted(g,P){this.mutes.set(g,P),this._onVolumeChange.dispatch(this,g)}isMuted(g){return!!this.mutes.get(g)}serialize(){return[...this.volumes.entries()].map(([g,P])=>g+","+P).join(";")}unserialize(g){return this.volumes=new Map(g.split(";").map(g=>g.split(",").map(Number))),this}})}}}),System.register("engine/sound/Music",["util/math"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){var P;(P=L||g("MusicType",L={}))[P.Normal=0]="Normal",P[P.NormalShuffle=1]="NormalShuffle",P.Intro="INTRO",P.Score="SCORE",P.Loading="LOADING",P.Credits="CREDITS",P.Options="RA2Options",g("Music",class{constructor(g,P,I){this.audioSystem=g,this.audioFiles=P,this.musicSpecs=I,this.playlist=[],this.currentPlaylistIdx=-1,this.shuffle=!1,this.repeat=!1,this.playRequestId=0}unserializeOptions(g){var[P,I,L]=g.split(",");this.shuffle=Boolean(Number(P)),this.repeat=Boolean(Number(I)),this.initialRepeatName=L}serializeOptions(){return[Number(this.shuffle),Number(this.repeat),this.repeat&&-1!==this.currentPlaylistIdx?this.playlist[this.currentPlaylistIdx].name:void 0].join(",")}getShuffleMode(){return this.shuffle}getRepeatMode(){return this.repeat}getPlaylist(){return this.buildPlaylist(!1)}getCurrentPlaylistItem(){if(-1!==this.currentPlaylistIdx)return this.playlist[this.currentPlaylistIdx]}dispose(){this.stopPlaying()}getMusicSpec(g){var P=this.musicSpecs.getSpec(g);if(P)return P;console.warn(`Music "${g}" is not defined`)}async play(g){var P,I;if(this.currentMusicType===g)return;const _=++this.playRequestId;g===L.Normal||g===L.NormalShuffle?(P=this.shuffle||g===L.NormalShuffle,this.playlist=this.buildPlaylist(P),this.playlist.length&&(this.currentPlaylistIdx=0,!this.initialRepeatName||-1!==(I=this.playlist.findIndex(g=>g.name===this.initialRepeatName))&&(this.currentPlaylistIdx=I),await this.playSpec(this.playlist[this.currentPlaylistIdx],()=>this.advancePlaylist(_),_)&&_===this.playRequestId&&(this.currentMusicType=g))):(I=this.getMusicSpec(g))?await this.playSpec(I,void 0,_)&&_===this.playRequestId&&(this.currentMusicType=g):console.warn(`No music spec found for type "${g}"`)}stopPlaying(){this.playRequestId++,this.audioSystem.stopMusic(),this.currentMusicType=void 0}setShuffleMode(g){if(g!==this.shuffle){this.shuffle=g;let P=-1!==this.currentPlaylistIdx?this.playlist[this.currentPlaylistIdx]:void 0;this.playlist=this.buildPlaylist(this.shuffle),this.currentPlaylistIdx=P?this.playlist.findIndex(g=>g===P):-1}}setRepeatMode(g){this.repeat=g}async playSpec(g,P,I){var L=await this.getMp3File(g.sound);return!(!L||void 0!==I&&I!==this.playRequestId||(await this.audioSystem.playMusicFile(L,g.repeat,P),0))}async getMp3File(g){var P=g.toLowerCase()+".mp3";let I;try{I=await this.audioFiles.get(P)}catch(g){return void console.error("Failed to fetch audio file",g)}if(I)return I;console.warn(`Audio file "${P}" not found.`)}buildPlaylist(g){let P=this.musicSpecs.getAll().filter(g=>g.normal);return g&&(P=this.shufflePlaylist(P)),P}shufflePlaylist(g){let P=[];for(g=[...g];g.length;)P.push(...g.splice(I.getRandomInt(0,g.length-1),1));return P}async advancePlaylist(g){void 0!==g&&g!==this.playRequestId||this.playlist.length&&(this.currentPlaylistIdx=this.repeat?this.currentPlaylistIdx:(this.currentPlaylistIdx+1)%this.playlist.length,await this.playSpec(this.playlist[this.currentPlaylistIdx],()=>this.advancePlaylist(g),g))}async selectPlaylistItem(g){var P=this.playlist?.findIndex(P=>P===g);if(-1!==P){this.currentPlaylistIdx=P,this.stopPlaying();const g=this.playRequestId;await this.playSpec(this.playlist[this.currentPlaylistIdx],()=>this.advancePlaylist(g),g)}}})}}}),System.register("engine/sound/MusicSpecs",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("MusicSpecs",class{constructor(g){this.ini=g,this.specs=new Map,this.parse()}parse(){let g=this.ini.getSection("Themes");if(g){for(var P of g.entries.values())if(P){let g=this.ini.getSection(P);var I;g?(I={name:g.getString("Name"),sound:g.getString("Sound"),normal:g.getBool("Normal",!0),repeat:g.getBool("Repeat")},this.specs.set(P,I)):console.warn(`Music section [${P}] not found. Skipping.`)}}else console.warn("[Themes] section missing. Music will not be played.")}getSpec(g){return this.specs.get(g)}getAll(){return[...this.specs.values()]}})}}}),System.register("engine/sound/RemoteMusicProvider",["network/HttpRequest","data/Mp3File","@puzzl/core/lib/async/cancellation"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("RemoteMusicProvider",class{constructor(g,P=5e3){this.baseUrl=function a(g){return g?g.endsWith("/")?g:g+"/":void 0}(g),this.timeoutMs=Math.max(500,Number(P)||5e3),this.http=new I.HttpRequest,this.cache=new Map}async get(g){if(!this.baseUrl)return;let P=String(g||"");if(!P.length)return;P=P.toLowerCase();let I=this.cache.get(P);return I||(I=this.fetchMp3(P).catch(g=>{console.error("Failed to fetch remote music file",g)}).then(g=>(g||this.cache.delete(P),g)),this.cache.set(P,I)),await I}async fetchMp3(g){let P=this.baseUrl+encodeURIComponent(g),I=new _.CancellationTokenSource,U=setTimeout(()=>I.cancel(),this.timeoutMs);try{var G=await this.http.fetchRaw(P,I.token);let _=new File([G],g,{type:"audio/mp3"});return new L.Mp3File(_)}finally{clearTimeout(U)}}}),g("FallbackMusicProvider",class{constructor(g,P){this.primary=g,this.fallback=P}async get(g){return await(this.primary?.get(g))||await(this.fallback?.get(g))}})}}}),System.register("engine/sound/Sound",["engine/sound/ChannelType","engine/sound/SoundKey","engine/sound/SoundSpecs","util/math","util/typeGuard"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){g("Sound",class{constructor(g,P,_,U,G){this.audioSystem=g,this.audioFiles=P,this.soundSpecs=_,this.audioVisualRules=U,this.document=G,this.playbackHandles=new Map,this.handleClick=g=>{let P=g.target;P.matches("button, .menu-button:not(.disabled)")?this.play(L.SoundKey.GUIMainButtonSound,I.ChannelType.Ui):P.matches(".list-item")?this.play(L.SoundKey.GenericClick,I.ChannelType.Ui):P instanceof HTMLInputElement&&["checkbox","radio","range"].includes(P.type)&&!P.disabled?this.play(L.SoundKey.GUICheckboxSound,I.ChannelType.Ui):(P instanceof HTMLSelectElement&&!P.disabled||P.matches(".select:not(.disabled) *"))&&this.play(L.SoundKey.GUIComboOpenSound,I.ChannelType.Ui)}}initialize(){this.audioSystem.initialize(),this.document.addEventListener("click",this.handleClick)}dispose(){this.audioSystem.dispose(),this.document.removeEventListener("click",this.handleClick)}getSoundKey(g){let P;if("string"==typeof L.SoundKey[g]){if(P=this.audioVisualRules.ini.getString(L.SoundKey[g]),!P)return}else P=g;return P}getSoundSpec(g){var P=this.getSoundKey(g);if(P){var I=this.soundSpecs.getSpec(P);if(I)return I;console.warn(`Sound "${P}" is not defined`)}else console.warn(`No sound is defined for key "${L.SoundKey[g]}"`)}play(g,P){let I=this.getSoundSpec(g);if(I){var L=I.control.has(_.SoundControl.Loop)?I.loop||Number.POSITIVE_INFINITY:0;return this.playWithOptions(I,P,I.volume/100,0,I.limit,L)}}playWithOptions(g,P,I,L,V,W){if(g.sounds.length){this.cleanOldHandles();let Y=this.playbackHandles.get(g.name);if(Y||(Y=[],this.playbackHandles.set(g.name,Y)),V&&Y.length>=V){if(!g.control.has(_.SoundControl.Interrupt))return;Y.shift().stop()}var z=1+(g.fShift?U.getRandomInt(g.fShift.min,g.fShift.max)/100:0);let Z;var K=g.control.has(_.SoundControl.Attack),q=g.control.has(_.SoundControl.Decay);if(W&&(1<g.sounds.length||W!==Number.POSITIVE_INFINITY||g.delay)){var $=this.buildAttackDecaySequence(g,K,q,!0).map(g=>this.getWavFile(g)).filter(G.isNotNullOrUndefined);Z=this.audioSystem.playWavLoop($,P,I,L,g.delay,z,K,q,W)}else{let V=0;if(g.delay&&(V=U.getRandomInt(g.delay.min,g.delay.max)),K||q){var Q=this.buildAttackDecaySequence(g,K,q,!1).map(g=>this.getWavFile(g)).filter(G.isNotNullOrUndefined);Z=this.audioSystem.playWavSequence(Q,P,I,L,V,z)}else{let G;if(G=g.control.has(_.SoundControl.Random)?g.sounds[U.getRandomInt(0,g.sounds.length-1)]:g.sounds[0],!(Q=this.getWavFile(G)))return;Z=this.audioSystem.playWavFile(Q,P,I,L,V,z,0!==W)}}return Z&&Y.push(Z),Z}}buildAttackDecaySequence(g,P,I,L){var _=P?g.attack||1:0,G=I?g.decay||1:0,V=g.sounds.slice(_,g.sounds.length-G);let W=[];return 0<_&&(_=g.sounds[U.getRandomInt(0,_-1)],W.push(_)),L?W.push(...V):W.push(V[U.getRandomInt(0,V.length-1)]),0<G&&(G=g.sounds[U.getRandomInt(g.sounds.length-G,g.sounds.length-1)],W.push(G)),W}getWavFile(g){var P=g+".wav",I=this.audioFiles.get(P);if(I)return I;console.error(`Audio file "${P}" not found.`)}cleanOldHandles(){for(var[g,P]of this.playbackHandles)P=P.filter(g=>g.isPlaying()),this.playbackHandles.set(g,P)}})}}}),System.register("engine/sound/SoundKey",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("SoundKey",I={}))[P.CreateInfantrySound=0]="CreateInfantrySound",P[P.CreateUnitSound=1]="CreateUnitSound",P[P.CreateAircraftSound=2]="CreateAircraftSound",P[P.SpySatActivationSound=3]="SpySatActivationSound",P[P.SpySatDeactivationSound=4]="SpySatDeactivationSound",P[P.UpgradeVeteranSound=5]="UpgradeVeteranSound",P[P.UpgradeEliteSound=6]="UpgradeEliteSound",P[P.BaseUnderAttackSound=7]="BaseUnderAttackSound",P[P.BuildingGarrisonedSound=8]="BuildingGarrisonedSound",P[P.BuildingRepairedSound=9]="BuildingRepairedSound",P[P.CheerSound=10]="CheerSound",P[P.PlaceBeaconSound=11]="PlaceBeaconSound",P[P.StartPlanningModeSound=12]="StartPlanningModeSound",P[P.EndPlanningModeSound=13]="EndPlanningModeSound",P[P.AddPlanningModeCommandSound=14]="AddPlanningModeCommandSound",P[P.ExecutePlanSound=15]="ExecutePlanSound",P[P.CratePromoteSound=16]="CratePromoteSound",P[P.CrateMoneySound=17]="CrateMoneySound",P[P.CrateRevealSound=18]="CrateRevealSound",P[P.CrateFireSound=19]="CrateFireSound",P[P.CrateArmourSound=20]="CrateArmourSound",P[P.CrateSpeedSound=21]="CrateSpeedSound",P[P.CrateUnitSound=22]="CrateUnitSound",P[P.GUIMainButtonSound=23]="GUIMainButtonSound",P[P.GUIBuildSound=24]="GUIBuildSound",P[P.GUITabSound=25]="GUITabSound",P[P.GUIOpenSound=26]="GUIOpenSound",P[P.GUICloseSound=27]="GUICloseSound",P[P.GUIMoveOutSound=28]="GUIMoveOutSound",P[P.GUIMoveInSound=29]="GUIMoveInSound",P[P.GUIComboOpenSound=30]="GUIComboOpenSound",P[P.GUIComboCloseSound=31]="GUIComboCloseSound",P[P.GUICheckboxSound=32]="GUICheckboxSound",P[P.ScoreAnimSound=33]="ScoreAnimSound",P[P.SinkingSound=34]="SinkingSound",P[P.ImpactWaterSound=35]="ImpactWaterSound",P[P.ImpactLandSound=36]="ImpactLandSound",P[P.BombTickingSound=37]="BombTickingSound",P[P.ChronoInSound=38]="ChronoInSound",P[P.ChronoOutSound=39]="ChronoOutSound",P[P.BombAttachSound=40]="BombAttachSound",P[P.YuriMindControlSound=41]="YuriMindControlSound",P[P.DigSound=42]="DigSound",P[P.CloakSound=43]="CloakSound",P[P.SellSound=44]="SellSound",P[P.GameClosed=45]="GameClosed",P[P.IncomingMessage=46]="IncomingMessage",P[P.MessageCharTyped=47]="MessageCharTyped",P[P.SystemError=48]="SystemError",P[P.OptionsChanged=49]="OptionsChanged",P[P.GameForming=50]="GameForming",P[P.PlayerLeft=51]="PlayerLeft",P[P.PlayerJoined=52]="PlayerJoined",P[P.Construction=53]="Construction",P[P.BuildingDieSound=54]="BuildingDieSound",P[P.BuildingSlam=55]="BuildingSlam",P[P.RadarOn=56]="RadarOn",P[P.RadarOff=57]="RadarOff",P[P.MovieOn=58]="MovieOn",P[P.MovieOff=59]="MovieOff",P[P.ScoldSound=60]="ScoldSound",P[P.TeslaCharge=61]="TeslaCharge",P[P.TeslaZap=62]="TeslaZap",P[P.BuildingDamageSound=63]="BuildingDamageSound",P[P.ChuteSound=64]="ChuteSound",P[P.GenericClick=65]="GenericClick",P[P.GenericBeep=66]="GenericBeep",P[P.BuildingDrop=67]="BuildingDrop",P[P.StopSound=68]="StopSound",P[P.GuardSound=69]="GuardSound",P[P.ScatterSound=70]="ScatterSound",P[P.DeploySound=71]="DeploySound",P[P.StormSound=72]="StormSound",P[P.LightningSounds=73]="LightningSounds",P[P.ShellButtonSlideSound=74]="ShellButtonSlideSound",P[P.QuickMatchTimer=75]="QuickMatchTimer",P[P.PartyInvite=76]="PartyInvite",P[P.PartyFormed=77]="PartyFormed"}}}),System.register("engine/sound/SoundSpec",["engine/sound/SoundSpecs"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("SoundSpec",class{read(g,P){let L=g.getNumber("Range",P.range);var _;return-2===L&&(L=Number.POSITIVE_INFINITY),this.name=g.name,this.control=new Set(g.getEnumArray("Control",I.SoundControl,/\s+/,[],!0)),this.sounds=g.getArray("Sounds",/\s+/).map(g=>g.replace(/^\$/,"")),this.volume=g.has("Volume")?g.getNumber("Volume",P.volume):g.getNumber("volume",P.volume),this.delay=this.createMinMaxPair(g.getNumberArray("Delay",/\s+/,[])),this.priority=g.getEnum("Priority",I.SoundPriority,P.priority,!0),this.type=g.getEnumArray("Type",I.SoundType,/\s+/,P.type,!0),this.type.some(g=>[I.SoundType.Screen,I.SoundType.Local,I.SoundType.Global].includes(g))||(_=P.type.find(g=>[I.SoundType.Screen,I.SoundType.Local,I.SoundType.Global].includes(g)))&&this.type.push(_),this.fShift=this.createMinMaxPair(g.getNumberArray("FShift",/\s+/,[])),this.limit=g.getNumber("Limit",P.limit),this.loop=g.getNumber("Loop"),this.range=L,this.minVolume=g.getNumber("MinVolume",P.minVolume),this.vShift=this.createMinMaxPair(g.getNumberArray(g.has("Vshift")?"Vshift":"VShift",/\s+/,[])),this.attack=g.getNumber("Attack"),this.decay=g.getNumber("Decay"),this}createMinMaxPair(g){if(g.length){let[P,I]=g;return void 0===I&&(I=P),{min:P,max:I}}}})}}}),System.register("engine/sound/SoundSpecs",["engine/sound/SoundSpec"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g}],execute:function(){var P;(P=L||g("SoundType",L={}))[P.Global=0]="Global",P[P.Normal=1]="Normal",P[P.Screen=2]="Screen",P[P.Local=3]="Local",P[P.Player=4]="Player",P[P.Unshroud=5]="Unshroud",P[P.Shroud=6]="Shroud",(P=_||g("SoundPriority",_={}))[P.Lowest=0]="Lowest",P[P.Low=1]="Low",P[P.Normal=2]="Normal",P[P.High=3]="High",P[P.Critical=4]="Critical",(P=U||g("SoundControl",U={}))[P.All=0]="All",P[P.Loop=1]="Loop",P[P.Random=2]="Random",P[P.Predelay=3]="Predelay",P[P.Interrupt=4]="Interrupt",P[P.Attack=5]="Attack",P[P.Decay=6]="Decay",P[P.Ambient=7]="Ambient",g("SoundSpecs",class{constructor(g){this.ini=g,this.specs=new Map,this.parse()}parse(){let g=this.ini.getSection("Defaults");if(g){this.defaults={minVolume:g.getNumber("MinVolume"),range:g.getNumber("Range"),volume:g.getNumber("Volume"),limit:g.getNumber("Limit"),type:g.getEnumArray("Type",L,/\s+/,[],!0),priority:g.getEnum("Priority",_,_.Normal,!0)};let G=this.ini.getSection("SoundList");var P,U;if(G)for(P of new Set(G.entries.values()))P&&((U=this.ini.getSection(P))?this.specs.set(P,(new I.SoundSpec).read(U,this.defaults)):console.warn(`Missing sound section [${P}]`));else console.warn("Missing sound [SoundList] section. Sounds will not be played.")}else console.warn("Missing sound [Defaults] section. Sounds will not be played.")}getSpec(g){return this.specs.get(g)}getAll(){return[...this.specs.values()]}})}}}),System.register("engine/sound/WorldSound",["engine/sound/SoundKey","engine/sound/ChannelType","engine/sound/SoundSpecs","util/math","util/geometry","game/map/MapShroud","game/Coords","util/typeGuard"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g}],execute:function(){g("WorldSound",K=class m{constructor(g,P,I,L,_,U,V,W){this.sound=g,this.localPlayer=P,this.shroud=I,this.worldViewportHelper=L,this.mapTileIntersectHelper=_,this.world=U,this.worldScene=V,this.renderer=W,this.soundInstances=[],this.handleObjectRemoved=g=>{this.soundInstances.forEach(P=>{P.gameObject===g&&P.handle.stop()})},this.handleFrame=g=>{let P=!1;this.lastViewport&&G.rectEquals(this.worldScene.viewport,this.lastViewport)||(this.lastViewport=this.worldScene.viewport,P=!0),(!this.lastUpdate||200<=g-this.lastUpdate)&&(P=!0),P&&(this.update(),this.lastUpdate=g)},this.noShroudSpecs=m.noShroudKeys.map(g=>{var P=this.sound.getSoundSpec(g);if(P)return P;console.warn(`Sound key "${g}" doesn't have a corresponding sound.ini entry`)}).filter(z.isNotNullOrUndefined)}init(){this.renderer.onFrame.subscribe(this.handleFrame),this.world.onObjectRemoved.subscribe(this.handleObjectRemoved)}changeLocalPlayer(g,P){this.localPlayer=g,this.shroud=P}dispose(){this.renderer.onFrame.unsubscribe(this.handleFrame),this.world.onObjectRemoved.unsubscribe(this.handleObjectRemoved),this.soundInstances.forEach(g=>g.handle.stop())}update(){var g=this.mapTileIntersectHelper.getTileAtScreenPoint({x:this.worldScene.viewport.x+this.worldScene.viewport.width/2,y:this.worldScene.viewport.y+this.worldScene.viewport.height/2});if(g){this.tileAtViewportCenter=g,this.cleanOldInstances();let L=new Map;for(var P of this.soundInstances){var I=P.gameObject?.position.worldPosition??P.worldPos;let{volume:g,pan:_}=this.computeVolumeAndPan(P.spec,I,P.player,P.gain);0<g&&(I=L.get(P.spec)??0,P.loop&&I>=P.spec.limit?g=0:L.set(P.spec,I+1)),P.handle.setVolume(g),P.handle.setPan(_),P.volume=g}}else console.warn("No tile found at viewport center. Can't update local sound positions.")}cleanOldInstances(){this.soundInstances=this.soundInstances.filter(g=>g.handle.isPlaying())}playEffect(g,P,I,U=1,G){let V=this.sound.getSoundSpec(g);if(V&&(!V.type.includes(_.SoundType.Player)||I===this.localPlayer)){let g,q;P.position?(g=P.position.worldPosition,q=P):g=P;var W=V.control.has(_.SoundControl.Loop)||V.control.has(_.SoundControl.Ambient),z=W?V.loop||Number.POSITIVE_INFINITY:0;W&&void 0!==G&&(U=G);let{volume:$,pan:Q}=this.computeVolumeAndPan(V,g,I,U),Y=V.limit;if(W&&V.limit&&(Y=0,this.cleanOldInstances(),this.soundInstances.filter(g=>g.spec===V&&0<g.volume).length>=V.limit&&($=0)),W||$||!V.limit){var K=V.control.has(_.SoundControl.Ambient)||V.name.startsWith("_Amb_")?L.ChannelType.Ambient:L.ChannelType.Effect;return(z=this.sound.playWithOptions(V,K,$,Q,Y,z))&&this.soundInstances.push({spec:V,gameObject:q,worldPos:g,player:I,handle:z,gain:U,volume:$,loop:W}),z}}}computeVolumeAndPan(g,P,I,L=1){let G=g.volume/100,z=0;var K,q,$;return g.type.includes(_.SoundType.Global)&&I!==this.localPlayer&&(G=g.minVolume/100),G*=L,(g.type.includes(_.SoundType.Screen)||g.type.includes(_.SoundType.Global))&&(K=this.worldViewportHelper.distanceToViewportCenter(P),z=U.clamp(K.x/(this.worldScene.viewport.width/2),-1,1)),g.type.includes(_.SoundType.Screen)?(q=this.worldViewportHelper.distanceToViewport(P),$=(this.worldScene.viewport.height+this.worldScene.viewport.width)/2/3,G*=THREE.Math.lerp(1,0,Math.min(1,q/$))):g.type.includes(_.SoundType.Local)&&(this.tileAtViewportCenter?(q=new THREE.Vector2(P.x/W.Coords.LEPTONS_PER_TILE-this.tileAtViewportCenter.rx,P.z/W.Coords.LEPTONS_PER_TILE-this.tileAtViewportCenter.ry).length(),($=g.range*Math.SQRT2)<q?G=0:(g.vShift&&(G*=U.getRandomInt(g.vShift.min,g.vShift.max)/100),G*=1-Math.min(1,(q/$)**2))):G=0),this.noShroudSpecs.includes(g)&&!g.type.includes(_.SoundType.Global)&&this.shroud?.getShroudTypeByTileCoords(Math.floor(P.x/W.Coords.LEPTONS_PER_TILE),Math.floor(P.z/W.Coords.LEPTONS_PER_TILE),Math.floor(W.Coords.worldToTileHeight(P.y)))===V.ShroudType.Unexplored&&(G=0),{volume:G,pan:z}}}),K.noShroudKeys=[I.SoundKey.BuildingSlam,I.SoundKey.SellSound,I.SoundKey.BuildingGarrisonedSound,I.SoundKey.BuildingRepairedSound,I.SoundKey.SpySatActivationSound,I.SoundKey.SpySatDeactivationSound]}}}),System.register("engine/Theater",["game/theater/TileSets","engine/type/PaletteType"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("Theater",class{static factory(g,P,L,_,U){var G=U.get(L.isoPaletteName);if(!G)throw new Error(`Missing palette "${L.isoPaletteName}"`);var V=U.get(L.overlayPaletteName);if(!V)throw new Error(`Missing palette "${L.overlayPaletteName}"`);var W=U.get(L.unitPaletteName);if(!W)throw new Error(`Missing palette "${L.unitPaletteName}"`);var z=U.get("anim.pal");if(!z)throw new Error("Missing anim palette");var K=U.get(L.libPaletteName);if(!K)throw new Error("Missing lib palette "+L.libPaletteName);let q=new I.TileSets(P);return q.loadTileData(_,L.extension),new this(g,L,U,G,V,W,z,K,q)}constructor(g,P,I,L,_,U,G,V,W){this.type=g,this.settings=P,this.palettes=I,this.isoPalette=L,this.ovlPalette=_,this.unitPalette=U,this.animPalette=G,this.libPalette=V,this.tileSets=W}getPalette(g,P){switch(g){case L.PaletteType.Anim:return this.animPalette;case L.PaletteType.Overlay:return this.ovlPalette;case L.PaletteType.Unit:return this.unitPalette;case L.PaletteType.Custom:if("lib"===P)return this.libPalette;var I=this.palettes.get(P+".pal");if(!I)throw new Error(`Custom palette "${P}" not found`);return I;default:return L.PaletteType.Iso,this.isoPalette}}})}}}),System.register("engine/TheaterType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("TheaterType",I={}))[P.None=0]="None",P[P.Temperate=1]="Temperate",P[P.Urban=2]="Urban",P[P.Snow=4]="Snow",P[P.Lunar=8]="Lunar",P[P.Desert=16]="Desert",P[P.NewUrban=32]="NewUrban",P[P.All=63]="All"}}}),System.register("engine/type/LightingType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("LightingType",I={}))[P.None=0]="None",P[P.Global=1]="Global",P[P.Level=2]="Level",P[P.Ambient=3]="Ambient",P[P.Full=4]="Full",P[P.Default=5]="Default"}}}),System.register("engine/type/ObjectType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("ObjectType",I={}))[P.None=0]="None",P[P.Aircraft=1]="Aircraft",P[P.Building=2]="Building",P[P.Infantry=3]="Infantry",P[P.Overlay=4]="Overlay",P[P.Smudge=5]="Smudge",P[P.Terrain=6]="Terrain",P[P.Vehicle=7]="Vehicle",P[P.Animation=8]="Animation",P[P.Projectile=9]="Projectile",P[P.VoxelAnim=10]="VoxelAnim",P[P.Debris=11]="Debris"}}}),System.register("engine/type/PaletteType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("PaletteType",I={}))[P.None=0]="None",P[P.Iso=1]="Iso",P[P.Unit=2]="Unit",P[P.Overlay=3]="Overlay",P[P.Anim=4]="Anim",P[P.Custom=5]="Custom",P[P.Default=6]="Default"}}}),System.register("engine/type/PointerType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("PointerType",I={}))[P.Default=0]="Default",P[P.Mini=1]="Mini",P[P.Scroll=2]="Scroll",P[P.NoScroll=10]="NoScroll",P[P.Select=18]="Select",P[P.Move=31]="Move",P[P.NoMove=41]="NoMove",P[P.MoveMini=42]="MoveMini",P[P.NoActionMini=52]="NoActionMini",P[P.AttackRange=53]="AttackRange",P[P.AttackNoRange=58]="AttackNoRange",P[P.AttackMini=63]="AttackMini",P[P.Guard=68]="Guard",P[P.GuardMini=73]="GuardMini",P[P.Unknown1=78]="Unknown1",P[P.Unknown2=88]="Unknown2",P[P.Occupy=89]="Occupy",P[P.NoOccupy=99]="NoOccupy",P[P.OccupyMini=100]="OccupyMini",P[P.Deploy=110]="Deploy",P[P.NoDeploy=119]="NoDeploy",P[P.Unknown3=120]="Unknown3",P[P.Sell=129]="Sell",P[P.SellMini=139]="SellMini",P[P.NoSell=149]="NoSell",P[P.RepairMove=150]="RepairMove",P[P.SideRepair=170]="SideRepair",P[P.NoRepair=190]="NoRepair",P[P.Unknown4=191]="Unknown4",P[P.Unknown5=199]="Unknown5",P[P.Dynamite=204]="Dynamite",P[P.Unknown6=209]="Unknown6",P[P.Unknown7=214]="Unknown7",P[P.Unknown8=219]="Unknown8",P[P.Unknown9=224]="Unknown9",P[P.Unknown10=229]="Unknown10",P[P.Unknown11=234]="Unknown11",P[P.Unknwon12=239]="Unknwon12",P[P.Unknown13=249]="Unknown13",P[P.Para=259]="Para",P[P.Unknown14=269]="Unknown14",P[P.Storm=279]="Storm",P[P.EngineerDamage=299]="EngineerDamage",P[P.C4=309]="C4",P[P.Nuke=319]="Nuke",P[P.Unknown16=329]="Unknown16",P[P.Power=339]="Power",P[P.Unknown17=345]="Unknown17",P[P.Iron=346]="Iron",P[P.Unknown18=351]="Unknown18",P[P.Unknown19=356]="Unknown19",P[P.Chrono=357]="Chrono",P[P.DefuseBomb=369]="DefuseBomb",P[P.NoAction=384]="NoAction",P[P.Pan=385]="Pan",P[P.Unknown21=394]="Unknown21",P[P.AttackMove=404]="AttackMove",P[P.Unknown23=413]="Unknown23",P[P.Unknown24=422]="Unknown24",P[P.Unknown25=431]="Unknown25",P[P.Unknown26=432]="Unknown26",P[P.Unknown27=433]="Unknown27",P[P.Unknown28=434]="Unknown28",P[P.Beacon=435]="Beacon",P[P.ForceField=450]="ForceField",P[P.NoForceField=460]="NoForceField",P[P.Mutate=470]="Mutate",P[P.AirStrike=480]="AirStrike",P[P.Dominate=488]="Dominate",P[P.PsychicReveal=496]="PsychicReveal",P[P.SpyPlane=504]="SpyPlane",P[P.SpyPlaneMini=512]="SpyPlaneMini",P[P.NukeMini=513]="NukeMini",P[P.StormMini=514]="StormMini",P[P.PsychicRevealMini=515]="PsychicRevealMini",P[P.DominateMini=516]="DominateMini"}}}),System.register("engine/type/TerrainType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("TerrainType",I={}))[P.Default=0]="Default",P[P.Tunnel=5]="Tunnel",P[P.Railroad=6]="Railroad",P[P.Rock1=7]="Rock1",P[P.Rock2=8]="Rock2",P[P.Water=9]="Water",P[P.Shore=10]="Shore",P[P.Pavement=11]="Pavement",P[P.Dirt=12]="Dirt",P[P.Clear=13]="Clear",P[P.Rough=14]="Rough",P[P.Cliff=15]="Cliff"}}}),System.register("engine/type/TiberiumType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("TiberiumType",I={}))[P.Riparius=0]="Riparius",P[P.Cruentus=1]="Cruentus",P[P.Vinifera=2]="Vinifera",P[P.Aboreus=3]="Aboreus",P[P.Ore=0]="Ore",P[P.Gems=1]="Gems",P[P.Ore2=2]="Ore2",P[P.Ore3=3]="Ore3"}}}),System.register("engine/UiAnimationLoop",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("UiAnimationLoop",class{constructor(g){this.renderer=g,this.isStarted=!1,this.doBackgroundFrame=g=>{this.isStarted&&this.paused&&this.renderer.update(g)},this.doFrame=g=>{if(this.isStarted&&!this.paused){let P=this.renderer.getStats();P&&P.begin(),this.renderer.update(g),this.renderer.render(),P&&P.end(),this.rafId=requestAnimationFrame(this.doFrame)}},this.handleVisibilityChange=()=>{var g=document.hidden;this.paused!==g&&(this.paused=g,this.paused?(this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=void 0),this.backgroundIntervalId=setInterval(()=>{var g=performance.now();this.doBackgroundFrame(g)},1e3)):(this.backgroundIntervalId&&(clearInterval(this.backgroundIntervalId),this.backgroundIntervalId=void 0),this.rafId=requestAnimationFrame(this.doFrame)))}}start(){this.isStarted||(this.isStarted=!0,this.paused=!1,document.hidden?this.handleVisibilityChange():this.rafId=requestAnimationFrame(this.doFrame),document.addEventListener("visibilitychange",this.handleVisibilityChange))}stop(){this.isStarted&&(this.isStarted=!1,this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=void 0),this.backgroundIntervalId&&(clearInterval(this.backgroundIntervalId),this.backgroundIntervalId=void 0),document.removeEventListener("visibilitychange",this.handleVisibilityChange))}destroy(){this.stop(),this.renderer.flush()}})}}}),System.register("engine/util/EntityIntersectHelper",["util/geometry"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("EntityIntersectHelper",class{constructor(g,P,I,L,_,U){this.map=g,this.renderableManager=P,this.mapTileIntersectHelper=I,this.raycastHelper=L,this.scene=_,this.worldViewportHelper=U}getEntitiesAtScreenBox(g){let P=this.renderableManager.getRenderableContainer();if(!P)return[];let I=this.collectIntersectTargets(P.get3DObject()),L=new Set;return I.forEach(g=>L.add(this.renderableManager.getRenderableById(this.findRenderableId(g)))),[...L].filter(P=>this.worldViewportHelper.intersectsScreenBox(P.gameObject.position.worldPosition,g))}getEntityAtScreenPoint(g){var P=this.scene.viewport;if(I.rectContainsPoint(P,g)){let I=this.renderableManager.getRenderableContainer();if(I){var L=this.collectIntersectTargets(I.get3DObject());let _=this.raycastHelper.intersect(g,L,!1);if(_.length){let I=_.map(g=>({renderable:this.renderableManager.getRenderableById(this.findRenderableId(g.object)),point:g.point}));if(P=I.find(g=>g.renderable.gameObject.isUnit()),P)return P;if(L=I.find(g=>g.renderable.gameObject.isBuilding()&&g.renderable.getIntersectTarget?.()),!L)return I[0];if((P=this.mapTileIntersectHelper.getTileAtScreenPoint(g))&&(P=this.map.getObjectsOnTile(P).find(g=>{if(!g.isBuilding())return!1;let P=this.renderableManager.getRenderableByGameObject(g);return void 0!==P.getIntersectTarget?.()}),P))return{renderable:this.renderableManager.getRenderableByGameObject(P),point:L.point}}}}}collectIntersectTargets(g){let P=[];if(!g.visible)return P;if(void 0!==g.userData.id){let L=this.renderableManager.getRenderableById(g.userData.id);if(!L)throw new Error(`Entity not found (id = "${g.userData.id}")`);var I;L.gameObject.isDestroyed||L.gameObject.isCrashing||(I=L.getIntersectTarget?.(),Array.isArray(I)?P.push(...I):I&&P.push(I))}return g.children.forEach(g=>{g.visible&&P.push(...this.collectIntersectTargets(g))}),P}findRenderableId(g){let P;for(;P=g.userData.id,g=g.parent,void 0===P&&g.parent;);if(void 0===P)throw new Error("No attached renderable ID found for Object3D.");return P}})}}}),System.register("engine/util/MapPanningHelper",["engine/IsoCoords"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("MapPanningHelper",class{constructor(g){this.map=g}computeCameraPanFromTile(g,P){var L=this.map.tiles.getByMapCoords(g,P)??this.map.tiles.getPlaceholderTile(g,P);L=I.IsoCoords.tile3dToScreen(g+.5,P+.5,L.z);return this.computeCameraPanFromScreen(L)}computeCameraPanFromWorld(g){var P=I.IsoCoords.vecWorldToScreen(g);return this.computeCameraPanFromScreen(P)}computeCameraPanFromScreen(g){var P=this.getScreenPanOrigin();return{x:Math.floor(g.x-P.x),y:Math.floor(g.y-P.y)}}getScreenPanOrigin(){return I.IsoCoords.worldToScreen(0,0)}computeCameraPanLimits(g,P){var I=this.getScreenPanOrigin();return{x:Math.ceil(P.x-I.x+g.width/2),y:Math.ceil(P.y-I.y+g.height/2-1),width:P.width-g.width-1,height:P.height-g.height-1}}})}}}),System.register("engine/util/MapTileIntersectHelper",["util/geometry","game/Coords","engine/IsoCoords"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("MapTileIntersectHelper",class{constructor(g,P){this.map=g,this.scene=P}getTileAtScreenPoint(g){var P=this.scene.viewport;if(I.rectContainsPoint(P,g))return(P=this.intersectTilesByScreenPos(g)).length?P[0]:void 0}intersectTilesByScreenPos(g){var P=_.IsoCoords.worldToScreen(0,0),I=this.scene.cameraPan.getPan(),U=(P={x:g.x+P.x+I.x-this.scene.viewport.width/2,y:g.y+P.y+I.y-this.scene.viewport.height/2},I=_.IsoCoords.screenToWorld(P.x,P.y),new THREE.Vector2(I.x,I.y).multiplyScalar(1/L.Coords.LEPTONS_PER_TILE).floor());let G=this.map.tiles.getByMapCoords(U.x,U.y);var V;if(!G){for(let g=0;g<15&&(G=this.map.tiles.getByMapCoords(U.x+g,U.y+g),!G);g++);if(!G)return[]}let W=[];for(let g=0;g<15;g++)for(V of[{x:G.rx+g,y:G.ry+g},{x:G.rx+g+1,y:G.ry+g},{x:G.rx+g,y:G.ry+g+1}]){var z={x:V.x,y:V.y};(z=this.map.tiles.getByMapCoords(z.x,z.y))&&W.push(z)}let K=[],q=new THREE.Triangle;var $,Q=new THREE.Vector3(P.x,0,P.y);for($ of W){var Y=_.IsoCoords.tile3dToScreen($.rx,$.ry,$.z),Z=_.IsoCoords.tile3dToScreen($.rx,$.ry+1.1,$.z),X=_.IsoCoords.tile3dToScreen($.rx+1.1,$.ry,$.z),J=_.IsoCoords.tile3dToScreen($.rx+1.1,$.ry+1.1,$.z);q.b.x=Z.x,q.b.z=Z.y,q.c.x=X.x,q.c.z=X.y,q.a.x=Y.x,q.a.z=Y.y,Y=q.containsPoint(Q),q.a.x=J.x,q.a.z=J.y,J=q.containsPoint(Q),(Y||J)&&K.unshift($)}return K.length||(K=this.intersectTilesByScreenPos({x:g.x,y:g.y-_.IsoCoords.tileHeightToScreen(1)})),K}})}}}),System.register("engine/util/RaycastHelper",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("RaycastHelper",class{constructor(g){this.scene=g}intersect(g,P,I=!1){let L=new THREE.Raycaster;var _=this.normalizePointer(g,this.scene.viewport);return L.setFromCamera(_,this.scene.camera),L.intersectObjects(P,I)}normalizePointer(g,P){return{x:(g.x-P.x)/P.width*2-1,y:-(g.y-P.y)/P.height*2+1}}})}}}),System.register("engine/util/WorldViewportHelper",["engine/IsoCoords"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("WorldViewportHelper",class{constructor(g){this.scene=g}distanceToViewport(g){var P=this.scene.viewport;P=new THREE.Box2(new THREE.Vector2(P.x,P.y),new THREE.Vector2(P.x+P.width-1,P.x+P.height-1));return this.distanceToScreenBox(g,P)}distanceToScreenBox(g,P){var L=I.IsoCoords.vecWorldToScreen(g),_=I.IsoCoords.worldToScreen(0,0),U=this.scene.cameraPan.getPan();return P.distanceToPoint(new THREE.Vector2(L.x-_.x-U.x+this.scene.viewport.width/2,L.y-_.y-U.y+this.scene.viewport.height/2))}distanceToViewportCenter(g){var P=I.IsoCoords.vecWorldToScreen(g),L=I.IsoCoords.worldToScreen(0,0),_=this.scene.cameraPan.getPan(),U=this.scene.viewport;return new THREE.Vector2(P.x-L.x-_.x+this.scene.viewport.width/2,P.y-L.y-_.y+this.scene.viewport.height/2).sub(new THREE.Vector2(U.x+U.width/2,U.y+U.height/2))}intersectsScreenBox(g,P){return 0===this.distanceToScreenBox(g,P)}})}}}),System.register("ErrorHandler",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("ErrorHandler",class{constructor(g,P){this.messageBoxApi=g,this.strings=P}handle(g,P,I){this.isErrorState||(I?this.messageBoxApi.show(P,this.strings.get("GUI:Ok"),()=>{this.isErrorState=!1,I()}):this.messageBoxApi.show(P)),console.error("Handled error:",g),this.isErrorState=!0}})}}}),System.register("FullscreenParityPatch",["Application","gui/screen/game/GameScreen","gui/screen/replay/ReplayScreen","gui/screen/options/OptionsScreen","gui/screen/mainMenu/MainMenuRootScreen"],function(){"use strict";var g,P,I,L,_,U,G,V,W,z;function dispatchViewportClampMode(g){try{window.dispatchEvent(new CustomEvent("ra2web:viewportClampMode",{detail:{mode:g}}))}catch(g){}}function clearViewportResyncTimers(g){try{g._viewportResyncTimers?.forEach(g=>clearTimeout(g))}catch(g){}g._viewportResyncTimers=[]}function detachScreenChangeHandler(g){try{g._onScreenChangeHandler&&g._screenChangeRootController?.onScreenChange?.unsubscribe&&g._screenChangeRootController.onScreenChange.unsubscribe(g._onScreenChangeHandler)}catch(g){console.warn("Failed to detach onScreenChange handler",g)}finally{g._onScreenChangeHandler=void 0,g._screenChangeRootController=void 0}}return U="__ra2webFullscreenParityAppPatched",G="__ra2webFullscreenParityGamePatched",V="__ra2webFullscreenParityReplayPatched",W="__ra2webFullscreenParityOptionsPatched",z="__ra2webFullscreenParityMenuPatched",{setters:[function(P){g=P},function(g){P=g},function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){var K=g?.Application;if(K&&!K.prototype[U]){var q=K.prototype.main,$=K.prototype.initGui,Q=K.prototype.destroy,Y=K.prototype.updateViewportSize;K.prototype.requestViewportResync=function(){clearViewportResyncTimers(this);try{this._viewportResyncTimers.push(setTimeout(()=>this.updateViewportSize(this.fullScreen?.isFullScreen?.()??!1),60)),this._viewportResyncTimers.push(setTimeout(()=>this.updateViewportSize(this.fullScreen?.isFullScreen?.()??!1),220))}catch(g){}},K.prototype.applyStageScale=function(g,P){if(this.stageEl){var I=window.innerWidth,L=window.innerHeight;if(I>0&&L>0&&g>0&&P>0){var _=Math.min(I/g,L/P,1);_=Math.max(.1,_),this.stageEl.style.width=g+"px",this.stageEl.style.height=P+"px",this.stageEl.style.transform="scale("+_+") translate(-50%, -50%)"}}},K.prototype.updateViewportSize=function(g){if(!this.config?.viewport||!this.setViewportSize)return Y.call(this,g);var P,I;if(g?(P=window.innerWidth,I=window.innerHeight):(P=Math.min(window.innerWidth,this.config.viewport.width),I=Math.min(window.innerHeight,this.config.viewport.height)),P=Number(P)||0,I=Number(I)||0,P=Math.max(2,P-P%2),I=Math.max(2,I-I%2),"menu"===this.viewportClampMode)P=Math.max(800,P),I=Math.max(600,I);else if(g){var L=Number(this.runtimeVars?.fullScreenZoomOut?.value??1);L=Number.isFinite(L)?L:1,L=Math.max(1,Math.min(2,L)),P=Math.floor(P*L),I=Math.floor(I*L),P-=P%2,I-=I%2}this.applyStageScale(P,I),this.setViewportSize(P,I),this.splashScreen?.setSize(P,I)},K.prototype.main=async function(){this.viewportClampMode="menu",this._viewportResyncTimers=[],function ensureStage(g){if(!g.stageEl){var P=document.getElementById("ra2web-root");if(P){g.outerRootEl=P;var I=P.querySelector("#ra2web-stage");I||((I=document.createElement("div")).setAttribute("id","ra2web-stage"),P.appendChild(I)),I.style.position="fixed",I.style.left="50%",I.style.top="50%",I.style.transformOrigin="0 0",I.style.overflow="hidden",I.style.transform="scale(1) translate(-50%, -50%)",g.stageEl=I;var L=I;try{Object.defineProperty(g,"rootEl",{configurable:!0,enumerable:!0,get:function(){return L},set:function(g){L=g===P?I:g}}),g.rootEl=I}catch(P){g.rootEl=I}}}}(this);var g=await q.apply(this,arguments);return this._onViewportClampModeEvent||(this._onViewportClampModeEvent=g=>{var P=function toClampMode(g){return"menu"===g||"dynamic"===g?g:void 0}(g?.detail?.mode);P&&P!==this.viewportClampMode&&(this.viewportClampMode=P,this.updateViewportSize(this.fullScreen?.isFullScreen?.()??!1),this.requestViewportResync())},window.addEventListener("ra2web:viewportClampMode",this._onViewportClampModeEvent)),!this._onFullScreenResyncHandler&&this.fullScreen?.onChange?.subscribe&&(this._onFullScreenResyncHandler=()=>this.requestViewportResync(),this.fullScreen.onChange.subscribe(this._onFullScreenResyncHandler)),this.updateViewportSize(this.fullScreen?.isFullScreen?.()??!1),g},K.prototype.initGui=async function(){var g=await $.apply(this,arguments);detachScreenChangeHandler(this);try{var P=g?.getRootController?.();if(P?.onScreenChange?.subscribe){var onScreenChange=()=>{this.viewportClampMode="menu",this.updateViewportSize(this.fullScreen?.isFullScreen?.()??!1)};P.onScreenChange.subscribe(onScreenChange),this._onScreenChangeHandler=onScreenChange,this._screenChangeRootController=P}}catch(g){console.warn("Failed to attach onScreenChange handler",g)}return g},K.prototype.destroy=async function(){return detachScreenChangeHandler(this),this._onViewportClampModeEvent&&window.removeEventListener("ra2web:viewportClampMode",this._onViewportClampModeEvent),this._onViewportClampModeEvent=void 0,this._onFullScreenResyncHandler&&this.fullScreen?.onChange?.unsubscribe&&this.fullScreen.onChange.unsubscribe(this._onFullScreenResyncHandler),this._onFullScreenResyncHandler=void 0,clearViewportResyncTimers(this),await Q.apply(this,arguments)},K.prototype[U]=!0}var Z=P?.GameScreen;if(Z&&!Z.prototype[G]){var X=Z.prototype.onEnter,J=Z.prototype.onGameStart,ee=Z.prototype.handleGameLoadError;Z.prototype.onEnter=async function(){dispatchViewportClampMode("menu");try{return await X.apply(this,arguments)}catch(g){throw g}},Z.prototype.onGameStart=function(){return dispatchViewportClampMode("dynamic"),J.apply(this,arguments)},Z.prototype.handleGameLoadError=function(g){return ee.apply(this,arguments)},Z.prototype[G]=!0}var te=I?.ReplayScreen;if(te&&!te.prototype[V]){var re=te.prototype.onEnter,se=te.prototype.onGameStart;te.prototype.onEnter=async function(){return dispatchViewportClampMode("menu"),await re.apply(this,arguments)},te.prototype.onGameStart=function(){return dispatchViewportClampMode("dynamic"),se.apply(this,arguments)},te.prototype[V]=!0}var ae=L?.OptionsScreen;if(ae&&!ae.prototype[W]){var ne=ae.prototype.onEnter,oe=ae.prototype.onLeave;ae.prototype.onEnter=function(){return this.inGame&&dispatchViewportClampMode("menu"),ne.apply(this,arguments)},ae.prototype.onLeave=async function(){try{return await oe.apply(this,arguments)}finally{this.inGame&&dispatchViewportClampMode("dynamic")}},ae.prototype[W]=!0}var le=_?.MainMenuRootScreen;if(le&&!le.prototype[z]){var ce=le.prototype.onEnter,he=le.prototype.onLeave,ue=le.prototype.onViewportChange;le.prototype.onEnter=function(){return ce.apply(this,arguments)},le.prototype.onViewportChange=function(){if(this.mainMenu)return ue.apply(this,arguments);this.updatePrefetchProgressViewport?.()},le.prototype.onLeave=he,le.prototype[z]=!0}}}}),System.register("game/action/Action",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("Action",class{constructor(g){this.actionType=g}unserialize(g){}serialize(){return new Uint8Array}print(){return""}})}}}),System.register("game/action/ActionFactory",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("ActionFactory",class{constructor(){this.factories=new Map}registerFactory(g,P){this.factories.set(g,P)}create(g){let P=this.factories.get(g);if(!P)throw new Error("No factory registered for action type "+g);return P.create()}})}}}),System.register("game/action/ActionFactoryReg",["game/action/OrderActionContext","game/action/ActionType","game/action/factories/NoActionFactory","game/action/factories/PlaceBuildingActionFactory","game/action/factories/SellObjectActionFactory","game/action/factories/SelectUnitsActionFactory","game/action/factories/OrderUnitsActionFactory","game/action/factories/UpdateQueueActionFactory","game/action/factories/DropPlayerActionFactory","game/action/factories/ToggleRepairActionFactory","game/action/factories/ToggleAllianceFactory","game/action/factories/ActivateSuperWeaponActionFactory","game/action/factories/PingLocationActionFactory","game/action/factories/ObserveGameActionFactory","game/action/factories/ResignGameActionFactory","game/action/factories/DebugActionFactory"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g}],execute:function(){g("ActionFactoryReg",class{register(g,P,ee){var te=new I.OrderActionContext;g.registerFactory(L.ActionType.NoAction,new _.NoActionFactory),g.registerFactory(L.ActionType.PlaceBuilding,new U.PlaceBuildingActionFactory(P)),g.registerFactory(L.ActionType.SellObject,new G.SellObjectActionFactory(P)),g.registerFactory(L.ActionType.ToggleRepair,new q.ToggleRepairActionFactory(P)),g.registerFactory(L.ActionType.SelectUnits,new V.SelectUnitsActionFactory(P,te)),g.registerFactory(L.ActionType.OrderUnits,new W.OrderUnitsActionFactory(P,P.map,te)),g.registerFactory(L.ActionType.UpdateQueue,new z.UpdateQueueActionFactory(P)),g.registerFactory(L.ActionType.ToggleAlliance,new $.ToggleAllianceActionFactory(P)),g.registerFactory(L.ActionType.ActivateSuperWeapon,new Q.ActivateSuperWeaponActionFactory(P)),g.registerFactory(L.ActionType.PingLocation,new Y.PingLocationActionFactory(P)),g.registerFactory(L.ActionType.DropPlayer,new K.DropPlayerActionFactory(P,ee)),g.registerFactory(L.ActionType.ObserveGame,new Z.ObserveGameActionFactory(P)),g.registerFactory(L.ActionType.ResignGame,new X.ResignGameActionFactory(P,ee)),g.registerFactory(L.ActionType.DebugCommand,new J.DebugActionFactory(P))}})}}}),System.register("game/action/ActionQueue",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("ActionQueue",class{constructor(){this.actions=[]}push(...g){this.actions.push(...g)}getLast(){return this.actions[this.actions.length-1]}dequeueAll(){var g=[...this.actions];return this.actions.length=0,g}dequeueLast(){return this.actions.pop()}clear(){this.actions.length=0}})}}}),System.register("game/action/ActionType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("ActionType",I={}))[P.NoAction=0]="NoAction",P[P.DropPlayer=1]="DropPlayer",P[P.ObserveGame=2]="ObserveGame",P[P.ResignGame=3]="ResignGame",P[P.DebugCommand=4]="DebugCommand",P[P.PlaceBuilding=5]="PlaceBuilding",P[P.SellObject=6]="SellObject",P[P.ToggleRepair=7]="ToggleRepair",P[P.SelectUnits=8]="SelectUnits",P[P.OrderUnits=9]="OrderUnits",P[P.UpdateQueue=10]="UpdateQueue",P[P.ToggleAlliance=11]="ToggleAlliance",P[P.ActivateSuperWeapon=12]="ActivateSuperWeapon",P[P.PingLocation=13]="PingLocation"}}}),System.register("game/action/ActivateSuperWeaponAction",["data/DataStream","game/action/Action","game/action/ActionType","game/type/SuperWeaponType","game/trait/SuperWeaponsTrait"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){V=class extends L.Action{constructor(g){super(_.ActionType.ActivateSuperWeapon),this.game=g}unserialize(g){let P=new I.DataStream(g);this.superWeaponType=P.readUint8();var L=P.readUint8();this.tile={x:P.readUint16(),y:P.readUint16()},this.tile2=2<L?{x:P.readUint16(),y:P.readUint16()}:void 0}serialize(){let g=new I.DataStream(6+(this.tile2?4:0));return g.dynamicSize=!1,g.writeUint8(this.superWeaponType),g.writeUint8(this.tile2?4:2),g.writeUint16(this.tile.x),g.writeUint16(this.tile.y),this.tile2&&(g.writeUint16(this.tile2.x),g.writeUint16(this.tile2.y)),g.toUint8Array()}print(){return`Activate SuperW ${U.SuperWeaponType[this.superWeaponType]} at tile (${this.tile.x}, ${this.tile.y})`+(this.tile2?`, (${this.tile2.x}, ${this.tile2.y})`:"")}process(){var g,P=this.player,I=this.game.map.tiles.getByMapCoords(this.tile.x,this.tile.y);I?(g=this.tile2?this.game.map.tiles.getByMapCoords(this.tile2.x,this.tile2.y):void 0,this.game.traits.get(G.SuperWeaponsTrait).activateSuperWeapon(this.superWeaponType,P,this.game,I,g)):console.warn(`Tile ${this.tile.x},${this.tile.y} doesn't exist`)}},g("ActivateSuperWeaponAction",V)}}}),System.register("game/action/DebugAction",["data/DataStream","game/action/Action","game/action/ActionType"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){var P;(P=U||g("DebugCommandType",U={}))[P.SetGlobalDebugText=0]="SetGlobalDebugText",P[P.SetUnitDebugText=1]="SetUnitDebugText",g("DebugCommand",G=class{constructor(g,P){this.type=g,this.params=P}}),V=class extends L.Action{constructor(g){super(_.ActionType.DebugCommand),this.game=g}unserialize(g){let P=new I.DataStream(g);var L=P.readUint8();L===U.SetUnitDebugText?this.command=new G(L,{unitId:P.readUint32(),label:P.readCString()||void 0}):L===U.SetGlobalDebugText?this.command=new G(L,{text:P.readCString()}):console.warn(`Debug command ${L} not implemented`)}serialize(){let g=new I.DataStream;if(g.writeUint8(this.command.type),this.command.type===U.SetUnitDebugText){var P=this.command.params;g.writeUint32(P.unitId),g.writeCString(P.label||"")}else{if(this.command.type!==U.SetGlobalDebugText)throw new Error(`Debug command ${this.command.type} not implemented`);P=this.command.params,g.writeCString(P.text)}return g.toUint8Array()}process(){if(this.command.type===U.SetUnitDebugText){var{unitId:g,label:P}=this.command.params;if(this.game.getWorld().hasObjectId(g)){let I=this.game.getObjectById(g);I.isTechno()&&(I.debugLabel=P)}}else this.command.type===U.SetGlobalDebugText?(P=this.command.params.text,this.game.debugText.value=P):console.warn(`Debug command ${this.command.type} not implemented`)}},g("DebugAction",V)}}}),System.register("game/action/DropPlayerAction",["game/action/Action","game/action/ActionType","game/event/PlayerDroppedEvent"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class extends I.Action{constructor(g,P){super(L.ActionType.DropPlayer),this.game=g,this.localPlayerName=P}process(){if(this.localPlayerName!==this.player.name){let P=this.player;var g;P.defeated||(g=this.game.redistributeAllPlayerAssets(P),this.game.removeAllPlayerAssets(P),P.dropped=!0,this.game.events.dispatch(new _.PlayerDroppedEvent(P,g)))}}},g("DropPlayerAction",U)}}}),System.register("game/action/factories/ActivateSuperWeaponActionFactory",["game/action/ActivateSuperWeaponAction"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("ActivateSuperWeaponActionFactory",class{constructor(g){this.game=g}create(){return new I.ActivateSuperWeaponAction(this.game)}})}}}),System.register("game/action/factories/DebugActionFactory",["game/action/DebugAction"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("DebugActionFactory",class{constructor(g){this.game=g}create(){return new I.DebugAction(this.game)}})}}}),System.register("game/action/factories/DropPlayerActionFactory",["game/action/DropPlayerAction"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("DropPlayerActionFactory",class{constructor(g,P){this.game=g,this.localPlayerName=P}create(){return new I.DropPlayerAction(this.game,this.localPlayerName)}})}}}),System.register("game/action/factories/NoActionFactory",["game/action/NoAction"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("NoActionFactory",class{create(){return new I.NoAction}})}}}),System.register("game/action/factories/ObserveGameActionFactory",["game/action/ObserveGameAction"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("ObserveGameActionFactory",class{constructor(g){this.game=g}create(){return new I.ObserveGameAction(this.game)}})}}}),System.register("game/action/factories/OrderUnitsActionFactory",["game/action/OrderUnitsAction","game/order/OrderFactory"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("OrderUnitsActionFactory",class{constructor(g,P,I){this.game=g,this.map=P,this.orderActionContext=I}create(){return new I.OrderUnitsAction(this.game,this.map,this.orderActionContext,new L.OrderFactory(this.game,this.map))}})}}}),System.register("game/action/factories/PingLocationActionFactory",["game/action/PingLocationAction"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("PingLocationActionFactory",class{constructor(g){this.game=g}create(){return new I.PingLocationAction(this.game)}})}}}),System.register("game/action/factories/PlaceBuildingActionFactory",["game/action/PlaceBuildingAction"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("PlaceBuildingActionFactory",class{constructor(g){this.game=g}create(){return new I.PlaceBuildingAction(this.game)}})}}}),System.register("game/action/factories/ResignGameActionFactory",["game/action/ResignGameAction"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("ResignGameActionFactory",class{constructor(g,P){this.game=g,this.localPlayerName=P}create(){return new I.ResignGameAction(this.game,this.localPlayerName)}})}}}),System.register("game/action/factories/SelectUnitsActionFactory",["game/action/SelectUnitsAction"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("SelectUnitsActionFactory",class{constructor(g,P){this.game=g,this.orderActionContext=P}create(){return new I.SelectUnitsAction(this.game,this.orderActionContext)}})}}}),System.register("game/action/factories/SellObjectActionFactory",["game/action/SellObjectAction"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("SellObjectActionFactory",class{constructor(g){this.game=g}create(){return new I.SellObjectAction(this.game)}})}}}),System.register("game/action/factories/ToggleAllianceFactory",["game/action/ToggleAllianceAction"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("ToggleAllianceActionFactory",class{constructor(g){this.game=g}create(){return new I.ToggleAllianceAction(this.game)}})}}}),System.register("game/action/factories/ToggleRepairActionFactory",["game/action/ToggleRepairAction"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("ToggleRepairActionFactory",class{constructor(g){this.game=g}create(){return new I.ToggleRepairAction(this.game)}})}}}),System.register("game/action/factories/UpdateQueueActionFactory",["game/action/UpdateQueueAction"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("UpdateQueueActionFactory",class{constructor(g){this.game=g}create(){return new I.UpdateQueueAction(this.game)}})}}}),System.register("game/action/NoAction",["game/action/Action","game/action/ActionType"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends I.Action{constructor(){super(L.ActionType.NoAction)}process(){}},g("NoAction",_)}}}),System.register("game/action/ObserveGameAction",["game/action/Action","game/event/PlayerResignedEvent","game/action/ActionType","game/event/PlayerDefeatedEvent","game/event/RadarOnOffEvent"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){V=class extends I.Action{constructor(g){super(_.ActionType.ObserveGame),this.game=g}process(){let g=this.player;var P;this.game.removeAllPlayerAssets(g),!g.isCombatant()||g.defeated||g.isObserver||(g.resigned=!0,g.defeated=!0,g.isObserver=!0,this.game.events.dispatch(new L.PlayerResignedEvent(g)),this.game.events.dispatch(new U.PlayerDefeatedEvent(g)),this.game.mapShroudTrait.getPlayerShroud(g)?.revealAll(),P=g.radarTrait.isDisabled(),g.radarTrait.setDisabled(!1),P&&this.game.events.dispatch(new G.RadarOnOffEvent(g,!0)))}},g("ObserveGameAction",V)}}}),System.register("game/action/OrderActionContext",["game/gameobject/selection/UnitSelectionLite"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("OrderActionContext",class{constructor(){this.unitSelectionByPlayer=new Map}getOrCreateSelection(g){let P=this.unitSelectionByPlayer.get(g);return P||(P=new I.UnitSelectionLite(g),this.unitSelectionByPlayer.set(g,P)),P}})}}}),System.register("game/action/OrderUnitsAction",["data/DataStream","game/action/Action","game/order/OrderType","game/order/orderPriorities","game/order/MoveOrder","game/gameobject/unit/MovePositionHelper","game/order/DeployOrder","game/event/CheerEvent","game/event/DeployNotAllowedEvent","util/typeGuard","game/gameobject/unit/ScatterPositionHelper","game/action/ActionType"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g}],execute:function(){g("ORDER_UNIT_LIMIT",128),Y=class extends L.Action{constructor(g,P,I,L){super(Q.ActionType.OrderUnits),this.game=g,this.map=P,this.orderActionContext=I,this.orderFactory=L,this.queue=!1,this.isInvalid=!1}unserialize(g){let P=new I.DataStream(g);this.orderType=P.readUint8();var L=P.readUint8();if(0!==L){var _=P.readUint16(),U=P.readUint16();let g;if(this.queue=2<L&&Boolean(P.readUint8()),3<L){if(L=P.readUint32(),!this.game.getWorld().hasObjectId(L))return void(this.isInvalid=!0);g=this.game.getObjectById(L)}else g=void 0;(U=this.map.tiles.getByMapCoords(_,U))?this.target=this.game.createTarget(g,U):this.isInvalid=!0}}serialize(){let g=new I.DataStream(11);g.dynamicSize=!1,g.writeUint8(this.orderType);let P=0;g.writeUint8(P),this.target&&(g.writeUint16(this.target.tile.rx),g.writeUint16(this.target.tile.ry),P+=2,L=(this.target.obj||this.target.getBridge())?.id,!this.queue&&void 0===L||(g.writeUint8(Number(this.queue)),P+=1),void 0!==L&&(g.writeUint32(L),P+=1));var L=g.position;return 0<P&&(g.seek(1),g.writeUint8(P)),new Uint8Array(g.buffer,g.byteOffset,L)}print(){return this.isInvalid?"":_.OrderType[this.orderType]+" order "+(this.target?`[obj: ${(this.target.obj||this.target.getBridge())?.name||"<none>"}, tile: ${this.target.tile.rx},${this.target.tile.ry}]`+(this.queue?"(queue)":""):"")}process(){if(!this.isInvalid){let L=this.player;const U=this.game.mapShroudTrait.getPlayerShroud(L);if(U){const W=this.target?.obj;if(W){if(!this.game.map.tileOccupation.calculateTilesForGameObject(W.tile,W).find(g=>!U.isShrouded(g,W.tileElevation)))return}let K=this.validateOrders(L).slice(0,128),q=[],Q=[],Y=[],Z=[],X=[];if(K.forEach(g=>{(g instanceof G.MoveOrder?Q:g.orderType===_.OrderType.Scatter?Y:g.orderType===_.OrderType.DeploySelected?Z:g.orderType===_.OrderType.Cheer?X:q).push(g)}),Q.length&&this.target){var g=Q[0].isEnemyBuildingBlock(),P=Q[0].isFollowMove();if(g||P)Q.forEach(g=>q.push(g));else{let g=this.target.getBridge();var I=Q[0].forceMove;P=Q.map(g=>g.sourceObject);let L=new V.MovePositionHelper(this.map).findPositions(P,this.target.tile,g,I);Q.forEach(P=>{var I=L.get(P.sourceObject),_=!g||g.isHighBridge()?this.map.tileOccupation.getBridgeOnTile(I):g;I=this.game.createTarget(_,I);P.target=I,q.push(P)})}}if(Y.length){I=Y.map(g=>g.sourceObject).filter(g=>g.isInfantry()||g.isVehicle());let g=new $.ScatterPositionHelper(this.game).findPositions(I);Y.forEach(P=>{var I=g.get(P.sourceObject);I&&(I=this.game.createTarget(I.onBridge,I.tile),P.target=I,q.push(P))})}if(Z.length){let g=[];Z.forEach(P=>{((P.sourceObject.isInfantry()||P.sourceObject.isVehicle())&&P.sourceObject.deployerTrait?g:q).push(P)});let P=g.filter(g=>!g.sourceObject.deployerTrait.isDeployed());P.length?P.forEach(g=>q.push(g)):g.forEach(g=>q.push(g))}X.length&&(L.cheerCooldownTicks||(L.cheerCooldownTicks=this.game.rules.general.maximumCheerRate,q.push(...X),this.game.events.dispatch(new z.CheerEvent(L)))),q.forEach(g=>g.sourceObject.unitOrderTrait.addOrder(g,this.queue)),this.updateWaypointPaths(q)}}}validateOrders(g){let P=this.orderActionContext.getOrCreateSelection(g);var I,L=P.getSelectedUnits();let G=this.orderFactory.create(this.orderType,P);G.target=this.target;let V=[];for(I of L)if(!(I.owner!==g||I.rules.spawned||I.isDestroyed||I.isCrashing||I.isDisposed||I.warpedOutTrait.isActive()||(G.sourceObject=I,G instanceof W.DeployOrder&&G.isValid()&&!G.isAllowed()&&this.game.events.dispatch(new K.DeployNotAllowedEvent(I)),G.singleSelectionRequired&&1<L.length)))if(G.isValid()&&G.isAllowed()){let g=this.orderFactory.create(this.orderType,P);g.set(I,this.target),V.push(g)}else{let g=!1;for(var z of U.orderPriorities){let _=this.orderFactory.create(z,P);if(_.set(I,this.target),!(_.singleSelectionRequired&&1<L.length)&&_.targetOptional===!this.target&&_.isValid()&&_.isAllowed()){V.push(_),g=!0;break}}if(!g&&this.target&&this.orderType!==_.OrderType.Deploy){let g=this.orderFactory.create(_.OrderType.Move,P);g.set(I,this.target),g.isValid()&&g.isAllowed()&&V.push(g)}}return V}updateWaypointPaths(g){if(this.queue&&this.target){let L=g.map(g=>g.sourceObject);var P=[...new Set(L.map(g=>g.unitOrderTrait.waypointPath).filter(q.isNotNullOrUndefined))];if(P.length<=1){var I={orderType:this.orderType,target:this.target,terminal:g.some(g=>g.terminal),next:void 0};if(0===P.length){let g={units:L,waypoints:[I]};L.forEach(P=>{P.unitOrderTrait.waypointPath=g})}else{let g=P[0];g.waypoints[g.waypoints.length-1].next=I,g.waypoints.push(I)}}}}},g("OrderUnitsAction",Y)}}}),System.register("game/action/PingLocationAction",["game/action/Action","data/DataStream","game/action/ActionType","game/event/PingLocationEvent","game/event/RadarEvent","game/rules/general/RadarRules"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){W=class extends I.Action{constructor(g){super(_.ActionType.PingLocation),this.game=g}unserialize(g){let P=new L.DataStream(g);this.tile={x:P.readUint16(),y:P.readUint16()}}serialize(){let g=new L.DataStream(4);return g.writeUint16(this.tile.x),g.writeUint16(this.tile.y),g.toUint8Array()}print(){return`Ping location at tile (${this.tile.x}, ${this.tile.y})`}process(){var g=this.player,P=this.game.map.tiles.getByMapCoords(this.tile.x,this.tile.y);if(P)for(var I of(this.game.events.dispatch(new U.PingLocationEvent(P,g)),[g,...this.game.alliances.getAllies(g)]))this.game.events.dispatch(new G.RadarEvent(I,V.RadarEventType.GenericNonCombat,P));else console.warn(`Tile ${this.tile.x},${this.tile.y} doesn't exist`)}},g("PingLocationAction",W)}}}),System.register("game/action/PlaceBuildingAction",["game/action/Action","data/DataStream","game/event/BuildingPlaceEvent","game/player/production/ProductionQueue","game/rules/TechnoRules","game/gameobject/trait/FactoryTrait","game/action/ActionType","game/event/BuildingFailedPlaceEvent","game/trait/interface/NotifyPlaceBuilding","engine/type/ObjectType"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g}],execute:function(){$=class extends I.Action{constructor(g){super(W.ActionType.PlaceBuilding),this.game=g}unserialize(g){let P=new L.DataStream(g);this.buildingRules=this.game.rules.getTechnoByInternalId(P.readUint32(),q.ObjectType.Building),this.tile={x:P.readUint16(),y:P.readUint16()}}serialize(){let g=new L.DataStream(8);return g.writeUint32(this.buildingRules.index),g.writeUint16(this.tile.x),g.writeUint16(this.tile.y),g.toUint8Array()}print(){return`Place building ${this.buildingRules.name} at tile (${this.tile.x}, ${this.tile.y})`}process(){var g=this.game.map.tiles.getByMapCoords(this.tile.x,this.tile.y);if(g){var P=this.player;const I=this.tryPlaceBuilding(P,g);I?(this.game.traits.filter(K.NotifyPlaceBuilding).forEach(g=>{g[K.NotifyPlaceBuilding.onPlace](I,this.game)}),this.game.events.dispatch(new _.BuildingPlaceEvent(I))):this.game.events.dispatch(new z.BuildingFailedPlaceEvent(this.buildingRules.name,P,g))}else console.warn(`Tile ${this.tile.x},${this.tile.y} doesn't exist`)}tryPlaceBuilding(g,P){var I=this.buildingRules;if(g.production){let _=g.production.getQueueForObject(I);if(_.status===U.QueueStatus.Ready&&_.getFirst().rules===I){let U=this.game.getConstructionWorker(g);if(g.production.isAvailableForProduction(I)&&U.canPlaceAt(I.name,P,{normalizedTile:!0})){var L=U.placeAt(I.name,P,!0);g.addUnitsBuilt(I,1),_.shift(I,1);let W=g.production.getPrimaryFactory(G.FactoryType.BuildingType);return W&&(W.factoryTrait.status=V.FactoryStatus.Delivering),L[0]}}}}},g("PlaceBuildingAction",$)}}}),System.register("game/action/ResignGameAction",["game/action/Action","game/event/PlayerResignedEvent","game/action/ActionType"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class extends I.Action{constructor(g,P){super(_.ActionType.ResignGame),this.game=g,this.localPlayerName=P}process(){if(this.localPlayerName!==this.player.name){let P=this.player;var g=this.game.redistributeAllPlayerAssets(P);this.game.removeAllPlayerAssets(P),P.isCombatant()&&(P.resigned=!0,this.game.events.dispatch(new L.PlayerResignedEvent(P,g)))}}},g("ResignGameAction",U)}}}),System.register("game/action/SelectUnitsAction",["game/action/Action","game/action/ActionType","data/DataStream","game/action/OrderUnitsAction"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=class extends I.Action{get unitIds(){return this._unitIds}set unitIds(g){this._unitIds=g.slice(0,U.ORDER_UNIT_LIMIT)}constructor(g,P){super(L.ActionType.SelectUnits),this.game=g,this.orderActionContext=P}unserialize(g){let P=new _.DataStream(g);this.unitIds=new Array(g.byteLength/4);for(let I=0;I<g.byteLength/4;I++)this.unitIds[I]=P.readUint32()}serialize(){let g=new _.DataStream(4*this.unitIds.length);for(var P of(g.dynamicSize=!1,this.unitIds))g.writeUint32(P);return g.toUint8Array()}print(){return`Select unit(s) [${this.unitIds.join(",")}]`}process(){let g=this.player,P=[];for(var I of this.unitIds){let L=g.getOwnedObjectById(I);if(!L&&this.game.getWorld().hasObjectId(I)){let g=this.game.getWorld().getObjectById(I);g.isTechno()&&(L=g)}L&&P.push(L)}this.orderActionContext.getOrCreateSelection(g).update(P)}},g("SelectUnitsAction",G)}}}),System.register("game/action/SellObjectAction",["game/action/Action","data/DataStream","game/gameobject/Building","game/action/ActionType","game/gameobject/trait/DockableTrait"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){V=class extends I.Action{constructor(g){super(U.ActionType.SellObject),this.game=g}unserialize(g){this.objectId=new L.DataStream(g).readUint32()}serialize(){return new L.DataStream(4).writeUint32(this.objectId).toUint8Array()}print(){return"Sell object "+this.objectId}process(){var g=this.player;if(this.game.getWorld().hasObjectId(this.objectId)){let P=this.game.getObjectById(this.objectId);P.isTechno()&&g===P.owner&&P.isSpawned&&(P.isBuilding()?P.buildStatus===_.BuildStatus.Ready&&!P.warpedOutTrait.isActive():P.traits.find(G.DockableTrait)?.dock?.rules.unitSell)&&this.game.sellTrait.sell(P)}}},g("SellObjectAction",V)}}}),System.register("game/action/ToggleAllianceAction",["game/action/Action","game/Alliances","game/event/AllianceChangeEvent","game/trait/interface/NotifyAllianceChange","game/action/ActionType"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){V=class extends I.Action{constructor(g){super(G.ActionType.ToggleAlliance),this.game=g}unserialize(g){this.toPlayer=this.game.getPlayer(g[0]),this.toggle=Boolean(g[1])}serialize(){return new Uint8Array([this.game.getPlayerNumber(this.toPlayer),this.toggle?1:0])}print(){return`Toggle alliance ${this.toggle?"on":"off"} with `+this.toPlayer.name}process(){if((G=this.game.rules.mpDialogSettings).alliesAllowed&&G.allyChangeAllowed){var g,P=this.player,I=this.toPlayer,G=this.toggle;let V=P,W=I,z=this.game.alliances;if(!P.defeated&&z.canRequestAlliance(W)){let I=z.findByPlayers(V,W);I?I.status===L.AllianceStatus.Formed?G||(z.breakAlliance(V,W),this.game.onAllianceChange(I,V,!1)):I.status===L.AllianceStatus.Requested&&(I.players.first===W?G&&z.canFormAlliance(V,W)&&(z.acceptRequest(W,V),this.game.onAllianceChange(I,V,!0),1!==(P=this.game.getCombatants().filter(g=>g!==V&&!z.areAllied(V,g))).length||(g=z.findByPlayers(P[0],V))&&z.cancelRequest(g.players.first,g.players.second),1!==(g=this.game.getCombatants().filter(g=>g!==W&&!z.areAllied(W,g))).length||(g=z.findByPlayers(g[0],W))&&z.cancelRequest(g.players.first,g.players.second)):G||(z.cancelRequest(V,W),this.game.events.dispatch(new _.AllianceChangeEvent(I,_.AllianceEventType.Broken,V)),this.game.traits.filter(U.NotifyAllianceChange).forEach(g=>{g[U.NotifyAllianceChange.onChange](I,!1,this.game)}))):G&&z.canFormAlliance(V,W)&&(G=z.request(V,W))&&this.game.events.dispatch(new _.AllianceChangeEvent(G,_.AllianceEventType.Requested,V))}}}},g("ToggleAllianceAction",V)}}}),System.register("game/action/ToggleRepairAction",["game/action/Action","data/DataStream","game/gameobject/trait/AutoRepairTrait","game/event/BuildingRepairStartEvent","game/action/ActionType"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){V=class extends I.Action{constructor(g){super(G.ActionType.ToggleRepair),this.game=g}unserialize(g){this.buildingId=new L.DataStream(g).readUint32()}serialize(){return new L.DataStream(4).writeUint32(this.buildingId).toUint8Array()}print(){return"Toggle repair "+this.buildingId}process(){var g=this.player;if(this.game.getWorld().hasObjectId(this.buildingId)){let P=this.game.getObjectById(this.buildingId);if(P.isBuilding()&&g===P.owner&&!P.isDestroyed&&P.rules.repairable&&P.rules.clickRepairable&&100!==P.healthTrait.health){let g=P.traits.get(_.AutoRepairTrait);g.setDisabled(!g.isDisabled()),g.isDisabled()||this.game.events.dispatch(new U.BuildingRepairStartEvent(P))}}}},g("ToggleRepairAction",V)}}}),System.register("game/action/UpdateQueueAction",["game/action/Action","data/DataStream","game/player/production/ProductionQueue","engine/type/ObjectType","game/action/ActionType"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){var P;(P=V||g("UpdateType",V={}))[P.Add=0]="Add",P[P.Cancel=1]="Cancel",P[P.Pause=2]="Pause",P[P.Resume=3]="Resume",P[P.AddNext=4]="AddNext",W=class extends I.Action{constructor(g){super(G.ActionType.UpdateQueue),this.game=g}unserialize(g){let P=new L.DataStream(g);var I,_;this.queueType=P.readUint8(),this.updateType=P.readUint8(),this.updateType!==V.Add&&this.updateType!==V.Cancel&&this.updateType!==V.AddNext||(I=P.readUint32(),_=P.readUint8(),this.item=this.game.rules.getTechnoByInternalId(I,_),this.quantity=P.readUint16())}serialize(){let g=new L.DataStream(9);if(g.dynamicSize=!1,g.writeUint8(this.queueType),g.writeUint8(this.updateType),this.updateType===V.Add||this.updateType===V.Cancel||this.updateType===V.AddNext){if(void 0===this.quantity)throw new Error("Missing quantity");if(65535<this.quantity)throw new Error("Maximum quantity exceeded");g.writeUint32(this.item.index),g.writeUint8(this.item.type),g.writeUint16(this.quantity)}return new Uint8Array(g.buffer,g.byteOffset,g.position)}print(){return this.updateType===V.Resume?"Resume queue "+_.QueueType[this.queueType]:this.updateType===V.Add?`Add to queue ${this.item.name} x `+this.quantity:this.updateType===V.AddNext?`Add next in queue ${this.item.name} x `+this.quantity:this.updateType===V.Pause?`Put queue ${_.QueueType[this.queueType]} on hold.`:this.updateType===V.Cancel?`Cancel ${this.item.name} x `+this.quantity:"Unhandled queue update type "+this.updateType}process(){let g=this.player,P=this.item,I=g.production.getQueue(this.queueType);if(this.updateType===V.Resume)I.status===_.QueueStatus.OnHold&&(I.status=_.QueueStatus.Active);else if(this.updateType===V.Add||this.updateType===V.AddNext){let z=I.find(P);if(I.status===_.QueueStatus.Active||I.status===_.QueueStatus.Idle||I.status===_.QueueStatus.OnHold&&z[0]!==I.getFirst()||I.status===_.QueueStatus.Ready&&P.type!==U.ObjectType.Building){let _;var L=z.reduce((g,P)=>g+P.quantity,0);if(Number.isFinite(P.buildLimit)){let I;I=0<=P.buildLimit?g.getOwnedObjectsByType(P.type,!0).filter(g=>g.name===P.name).length:g.getLimitedUnitsBuilt(P.name),_=Math.max(0,Math.abs(P.buildLimit)-(I+L))}else _=Number.POSITIVE_INFINITY;_&&g.production.isAvailableForProduction(P)&&(G=Math.min(I.maxSize-I.currentSize,I.maxItemQuantity-L,_),0<(W=Math.min(this.quantity,G))&&(this.updateType===V.AddNext?I.insertAfterFirst(P,W,P.cost):I.push(P,W,P.cost)))}}else if(this.updateType===V.Cancel){if([_.QueueStatus.Ready,_.QueueStatus.OnHold,_.QueueStatus.Active].includes(I.status)){let L=I.find(P);var G,W;L.length&&(G=L.reduce((g,P)=>g+P.quantity,0),0<(W=Math.min(G,this.quantity))&&(I.pop(P,W),W===G&&(g.credits+=L[0].creditsSpent)))}}else this.updateType===V.Pause&&I.status===_.QueueStatus.Active&&(I.status=_.QueueStatus.OnHold)}},g("UpdateQueueAction",W)}}}),System.register("game/ai/Ai",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("Ai",class{constructor(g){this.ini=g}getIni(){return this.ini}})}}}),System.register("game/Alliances",["util/math"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g}],execute:function(){var P;L=class{constructor(g,P){this.first=g,this.second=P}has(g){return this.first===g||this.second===g}equals(g){return this.first===g.first&&this.second===g.second||this.first===g.second&&this.second===g.first}},(P=_||g("AllianceStatus",_={}))[P.Requested=0]="Requested",P[P.Formed=1]="Formed",g("Alliances",class{constructor(g){this.playerList=g,this.alliances=[]}findByPlayers(g,P){let I=new L(g,P);return this.alliances.find(g=>g.players.equals(I))}filterByPlayer(g){return this.alliances.filter(P=>P.players.first===g||P.players.second===g)}request(g,P){if(!this.canRequestAlliance(P))throw new Error(`Player ${P.name} is not a human combatant.`);if(this.canFormAlliance(g,P)){if(this.findByPlayers(g,P))throw new Error(`Can't request alliance because an alliance is already pending or formed between ${g.name} and ${P.name}.`);return this.setAlliance(g,P,_.Requested)}}cancelRequest(g,P){var I=this.findByPlayers(g,P);if(!I||I.status!==_.Requested)throw new Error(`There is no pending alliance request for player ${P.name} from player `+g.name);if(I.players.first!==g)throw new Error(`Can't cancel request initiated by the other player (${P.name})`);this.alliances.splice(this.alliances.indexOf(I),1)}acceptRequest(g,P){if(this.canFormAlliance(g,P)){let I=this.findByPlayers(g,P);if(!I||I.status!==_.Requested)throw new Error(`There is no pending alliance request for player ${P.name} from player `+g.name);if(I.players.first!==g)throw new Error("Can't accept own alliance request for player "+P.name);I.status=_.Formed}}setAlliance(g,P,I){if(!this.canFormAlliance(g,P))throw new Error(`Can't form alliance between players "${g.name}" and "${P.name}"`);var _;if(this.findByPlayers(g,P))throw new Error(`An alliance already exists between players ${g.name} and `+P.name);return _={players:new L(g,P),status:I},this.alliances.push(_),_}breakAlliance(g,P){var I=this.findByPlayers(g,P);if(!I||I.status!==_.Formed)throw new Error(`There is no alliance between player ${g.name} and player `+P.name);this.alliances.splice(this.alliances.indexOf(I),1)}areAllied(g,P){var I=this.findByPlayers(g,P);return!!I&&I.status===_.Formed}getAllies(g){return this.filterByPlayer(g).filter(g=>g.status===_.Formed).map(P=>P.players.first===g?P.players.second:P.players.first)}haveSharedIntel(g,P){return g.isObserver||P.isObserver||g===P||this.areAllied(g,P)}canRequestAlliance(g){return g.isCombatant()&&!g.isAi}canFormAlliance(g,P){let I=this.getHostilePlayers();if(0===I.filter(I=>I.has(g)&&!I.has(P)).length)return!1;if(0===I.filter(I=>I.has(P)&&!I.has(g)).length)return!1;let _=new L(g,P);return!!I.filter(g=>!g.equals(_)).length}getHostilePlayers(){var g,P=this.playerList.getCombatants();let I=[];for(let _=0;_<P.length;_++)for(let U=_+1;U<P.length;U++)this.getAllies(P[_]).includes(P[U])||(g=new L(P[_],P[U]),I.push(g));return I}getHash(){return I.fnv32a(this.alliances.map(g=>[this.playerList.getPlayerNumber(g.players.first),this.playerList.getPlayerNumber(g.players.second),g.status]).flat())}debugGetState(){return this.alliances.map(g=>({first:g.players.first,second:g.players.second,status:g.status}))}})}}}),System.register("game/api/ActionsApi",["game/action/ActionType","game/action/UpdateQueueAction","game/action/DebugAction"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q;return P&&P.id,{setters:[function(g){z=g},function(g){K=g},function(g){q=g}],execute:function(){g("ActionsApi",class{constructor(g,P,W,z,K){I.add(this),L.set(this,void 0),_.set(this,void 0),U.set(this,void 0),G.set(this,void 0),V.set(this,void 0),__classPrivateFieldSet(this,L,P,"f"),__classPrivateFieldSet(this,_,W,"f"),__classPrivateFieldSet(this,U,g,"f"),__classPrivateFieldSet(this,G,z,"f"),__classPrivateFieldSet(this,V,K,"f")}placeBuilding(g,P,L){__classPrivateFieldGet(this,I,"m",W).call(this,z.ActionType.PlaceBuilding,I=>{I.buildingRules=__classPrivateFieldGet(this,U,"f").rules.getBuilding(g),I.tile={x:P,y:L}})}sellObject(g){__classPrivateFieldGet(this,I,"m",W).call(this,z.ActionType.SellObject,P=>{P.objectId=g})}sellBuilding(g){this.sellObject(g)}toggleRepairWrench(g){__classPrivateFieldGet(this,I,"m",W).call(this,z.ActionType.ToggleRepair,P=>{P.buildingId=g})}toggleAlliance(g,P){__classPrivateFieldGet(this,I,"m",W).call(this,z.ActionType.ToggleAlliance,I=>{I.toPlayer=__classPrivateFieldGet(this,U,"f").getPlayerByName(g),I.toggle=P})}pauseProduction(g){__classPrivateFieldGet(this,I,"m",W).call(this,z.ActionType.UpdateQueue,P=>{P.queueType=g,P.updateType=K.UpdateType.Pause})}resumeProduction(g){__classPrivateFieldGet(this,I,"m",W).call(this,z.ActionType.UpdateQueue,P=>{P.queueType=g,P.updateType=K.UpdateType.Resume})}queueForProduction(g,P,L,_){let G=__classPrivateFieldGet(this,U,"f").rules.getObject(P,L);__classPrivateFieldGet(this,I,"m",W).call(this,z.ActionType.UpdateQueue,P=>{P.queueType=g,P.updateType=K.UpdateType.Add,P.item=G,P.quantity=_})}unqueueFromProduction(g,P,L,_){let G=__classPrivateFieldGet(this,U,"f").rules.getObject(P,L);__classPrivateFieldGet(this,I,"m",W).call(this,z.ActionType.UpdateQueue,P=>{P.queueType=g,P.updateType=K.UpdateType.Cancel,P.item=G,P.quantity=_})}activateSuperWeapon(g,P,L){__classPrivateFieldGet(this,I,"m",W).call(this,z.ActionType.ActivateSuperWeapon,I=>{I.superWeaponType=g,I.tile={x:P.rx,y:P.ry},I.tile2=L?{x:L.rx,y:L.ry}:void 0})}orderUnits(g,P,L,_,G){let V;if(__classPrivateFieldGet(this,I,"m",W).call(this,z.ActionType.SelectUnits,P=>{P.unitIds=g}),L){let g,P;if(_){g=void 0;var K=__classPrivateFieldGet(this,U,"f").map.tiles.getByMapCoords(L,_);if(!K)throw new Error(`No tile found at rx,ry=${L},`+_);P=K,G&&(g=__classPrivateFieldGet(this,U,"f").map.tileOccupation.getBridgeOnTile(K))}else{if(!__classPrivateFieldGet(this,U,"f").getWorld().hasObjectId(L))return;g=__classPrivateFieldGet(this,U,"f").getObjectById(L),P=g.tile}V=__classPrivateFieldGet(this,U,"f").createTarget(g,P)}__classPrivateFieldGet(this,I,"m",W).call(this,z.ActionType.OrderUnits,g=>{g.orderType=P,g.target=V})}sayAll(g){__classPrivateFieldGet(this,V,"f")?.sayAll(__classPrivateFieldGet(this,G,"f").name,g)}setGlobalDebugText(g){__classPrivateFieldGet(this,G,"f").getDebugMode()&&__classPrivateFieldGet(this,I,"m",W).call(this,z.ActionType.DebugCommand,P=>{P.command=new q.DebugCommand(q.DebugCommandType.SetGlobalDebugText,{text:g||""})})}setUnitDebugText(g,P){__classPrivateFieldGet(this,G,"f").getDebugMode()&&__classPrivateFieldGet(this,I,"m",W).call(this,z.ActionType.DebugCommand,I=>{I.command=new q.DebugCommand(q.DebugCommandType.SetUnitDebugText,{unitId:g,label:P})})}quitGame(){__classPrivateFieldGet(this,I,"m",W).call(this,z.ActionType.ResignGame)}}),L=new WeakMap,_=new WeakMap,U=new WeakMap,G=new WeakMap,V=new WeakMap,I=new WeakSet,W=function(g,P){let I=__classPrivateFieldGet(this,L,"f").create(g);I.player=__classPrivateFieldGet(this,U,"f").getPlayerByName(__classPrivateFieldGet(this,G,"f").name),P?.(I),__classPrivateFieldGet(this,_,"f").push(I)}}}}),System.register("game/api/ChatApi",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("game/api/EventsApi",["game/event/EventType"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){G=g}],execute:function(){var P;(P=V||g("ApiEventType",V={}))[P.ObjectOwnerChange=0]="ObjectOwnerChange",P[P.ObjectSpawn=1]="ObjectSpawn",P[P.ObjectUnspawn=2]="ObjectUnspawn",P[P.ObjectDestroy=3]="ObjectDestroy",g("EventsApi",class{constructor(g){I.add(this),L.set(this,void 0),_.set(this,[]),__classPrivateFieldSet(this,L,g,"f")}subscribe(g,P){let G,V;V="function"==typeof g?g:(G=g,P);var W=__classPrivateFieldGet(this,L,"f").subscribe(g=>{var P=__classPrivateFieldGet(this,I,"m",U).call(this,g);!P||void 0!==G&&G!==P.type||V(P)});return __classPrivateFieldGet(this,_,"f").push(W),W}dispose(){for(var g of __classPrivateFieldGet(this,_,"f"))g();__classPrivateFieldGet(this,_,"f").length=0}}),L=new WeakMap,_=new WeakMap,I=new WeakSet,U=function(g){switch(g.type){case G.EventType.ObjectOwnerChange:return{type:V.ObjectOwnerChange,prevOwnerName:g.prevOwner.name,newOwnerName:g.target.owner.name,target:g.target.id};case G.EventType.ObjectSpawn:return{type:V.ObjectSpawn,target:g.gameObject.id};case G.EventType.ObjectUnspawn:return{type:V.ObjectUnspawn,target:g.gameObject.id};case G.EventType.ObjectDestroy:{let P=g;return P.target.isProjectile()?void 0:{type:V.ObjectDestroy,target:P.target.id,attackerInfo:P.attackerInfo?{playerName:P.attackerInfo.player.name,objId:P.attackerInfo.obj?.id,weaponName:P.attackerInfo.weapon?.rules.name}:void 0}}default:return}}}}}),System.register("game/api/GameApi",["game/player/trait/PowerTrait","game/api/MapApi","engine/type/ObjectType","game/GameSpeed","game/api/RulesApi"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K;return P&&P.id,{setters:[function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g}],execute:function(){g("GameApi",class{get mapApi(){return this.map}get rulesApi(){return this.rules}constructor(g,P){I.add(this),L.set(this,void 0),_.set(this,void 0),__classPrivateFieldSet(this,L,g,"f"),__classPrivateFieldSet(this,_,P,"f"),this.map=new V.MapApi(g),this.rules=new K.RulesApi(g.rules)}isPlayerDefeated(g){return __classPrivateFieldGet(this,L,"f").getPlayerByName(g).defeated}areAlliedPlayers(g,P){var I=__classPrivateFieldGet(this,L,"f").getPlayerByName(g);if(!I)throw new Error(`Player "${g}" doesn't exist`);var _=__classPrivateFieldGet(this,L,"f").getPlayerByName(P);if(!_)throw new Error(`Player "${P}" doesn't exist`);return __classPrivateFieldGet(this,L,"f").alliances.areAllied(I,_)}canPlaceBuilding(g,P,I,_){var U=__classPrivateFieldGet(this,L,"f").getPlayerByName(g);if(!U)throw new Error(`Player "${g}" doesn't exist`);return(_=_??{}).ignoreAdjacent??(_.ignoreAdjacent=this.rules.getBuilding(P).constructionYard),__classPrivateFieldGet(this,L,"f").getConstructionWorker(U).canPlaceAt(P,I,{normalizedTile:!0,..._})}getBuildingPlacementData(g){var P=__classPrivateFieldGet(this,L,"f").art.getObject(g,W.ObjectType.Building);return{foundation:P.foundation,foundationCenter:P.foundationCenter}}getPlayers(){return __classPrivateFieldGet(this,L,"f").getNonNeutralPlayers().map(g=>g.name)}getPlayerData(g){let P=__classPrivateFieldGet(this,L,"f").getPlayerByName(g);if(!P)throw new Error(`Player "${g}" doesn't exist`);return{name:P.name,country:P.country,startLocation:this.map.getStartingLocations()[P.startLocation??0],isObserver:P.isObserver,isAi:P.isAi,isCombatant:P.isCombatant(),credits:P.credits,power:{total:P.powerTrait?.power??0,drain:P.powerTrait?.drain??0,isLowPower:P.powerTrait?.level===G.PowerLevel.Low},radarDisabled:!!P.radarTrait?.isDisabled()}}getAllTerrainObjects(){return __classPrivateFieldGet(this,L,"f").getWorld().getAllObjects().filter(g=>g.isTerrain()).map(g=>g.id)}getAllUnits(g=()=>!0){return __classPrivateFieldGet(this,L,"f").getWorld().getAllObjects().filter(P=>P.isTechno()&&g(P.rules)).map(g=>g.id)}getNeutralUnits(g=()=>!0){return __classPrivateFieldGet(this,L,"f").getCivilianPlayer().getOwnedObjects().filter(P=>g(P.rules)).map(g=>g.id)}getUnitsInArea(g){return __classPrivateFieldGet(this,L,"f").map.technosByTile.queryRange(g).map(g=>g.id)}getVisibleUnits(g,P,I=()=>!0){const _=__classPrivateFieldGet(this,L,"f").getPlayerByName(g);if(!_)throw new Error(`Player "${g}" doesn't exist`);if("self"===P)return _.getOwnedObjects().filter(g=>I(g.rules)).map(g=>g.id);let U;if("allied"===P)U=g=>g.owner===_||__classPrivateFieldGet(this,L,"f").alliances.areAllied(g.owner,_);else{if("hostile"!==P&&"enemy"!==P)throw new Error("Unexpected type "+P);{let g=__classPrivateFieldGet(this,L,"f").mapShroudTrait.getPlayerShroud(_);U=I=>__classPrivateFieldGet(this,L,"f").map.tileOccupation.calculateTilesForGameObject(I.tile,I).some(P=>!g?.isShrouded(P,I.tileElevation))&&I.owner!==_&&!__classPrivateFieldGet(this,L,"f").alliances.areAllied(I.owner,_)&&("enemy"!==P||I.owner.isCombatant())}}return __classPrivateFieldGet(this,L,"f").getWorld().getAllObjects().filter(g=>g.isTechno()&&!g.isDestroyed&&U(g)&&I(g.rules)).map(g=>g.id)}getGameObjectData(g){if(__classPrivateFieldGet(this,L,"f").getWorld().hasObjectId(g)){let P=__classPrivateFieldGet(this,L,"f").getObjectById(g);return{id:P.id,type:P.type,name:P.name,rules:P.rules,tile:P.tile,tileElevation:P.tileElevation,worldPosition:P.position.worldPosition.clone(),foundation:P.getFoundation(),hitPoints:P.healthTrait?.getHitPoints(),maxHitPoints:P.healthTrait?.maxHitPoints,owner:P.isTechno()?P.owner.name:void 0}}}getUnitData(g){var P=this.getGameObjectData(g);if(P){let _=__classPrivateFieldGet(this,L,"f").getObjectById(g);if(!_.isTechno())throw new Error(`Game object with id ${g} is not a Techno type`);return{...P,owner:_.owner.name,sight:_.sight,veteranLevel:_.veteranLevel,guardMode:_.guardMode,purchaseValue:_.purchaseValue,primaryWeapon:_.primaryWeapon?__classPrivateFieldGet(this,I,"m",U).call(this,_.primaryWeapon):void 0,secondaryWeapon:_.secondaryWeapon?__classPrivateFieldGet(this,I,"m",U).call(this,_.secondaryWeapon):void 0,deathWeapon:_.armedTrait?.deathWeapon?__classPrivateFieldGet(this,I,"m",U).call(this,_.armedTrait.deathWeapon):void 0,attackState:_.attackTrait?.attackState,direction:_.direction,onBridge:_.isInfantry()||_.isVehicle()?_.onBridge:void 0,zone:_.isUnit()?_.zone:void 0,buildStatus:_.isBuilding()?_.buildStatus:void 0,factory:_.isBuilding()&&_.factoryTrait?{deliveringUnit:_.factoryTrait.deliveringUnit?.id,status:_.factoryTrait.status}:void 0,rallyPoint:_.isBuilding()?_.rallyTrait?.getRallyPoint():void 0,isPoweredOn:_.isBuilding()&&_.poweredTrait?.isPoweredOn(),hasWrenchRepair:_.isBuilding()&&!_.autoRepairTrait.isDisabled(),turretFacing:_.isBuilding()||_.isVehicle()?_.turretTrait?.facing:void 0,turretNo:_.isVehicle()?_.turretNo:void 0,garrisonUnitCount:_.isBuilding()?_.garrisonTrait?.units.length:void 0,garrisonUnitsMax:_.isBuilding()?_.garrisonTrait?.maxOccupants:void 0,passengerSlotCount:_.isVehicle()?_.transportTrait?.getOccupiedCapacity():void 0,passengerSlotMax:_.isVehicle()?_.transportTrait?.getMaxCapacity():void 0,isIdle:!_.unitOrderTrait.hasTasks(),canMove:_.isUnit()?!_.moveTrait.isDisabled():void 0,velocity:_.isUnit()?_.moveTrait.velocity.clone():void 0,stance:_.isInfantry()?_.stance:void 0,harvestedOre:_.isVehicle()?_.harvesterTrait?.ore:void 0,harvestedGems:_.isVehicle()?_.harvesterTrait?.gems:void 0,ammo:_.isAircraft()?_.ammo:void 0,isWarpedOut:_.warpedOutTrait.isActive(),mindControlledBy:_.mindControllableTrait?.getController()?.id,tntTimer:_.tntChargeTrait?.getTicksLeft()}}}getAllSuperWeaponData(){return __classPrivateFieldGet(this,L,"f").getCombatants().map(g=>g.superWeaponsTrait.getAll().map(P=>({playerName:g.name,type:P.rules.type,status:P.status,timerSeconds:P.getTimerSeconds()}))).flat()}getGeneralRules(){return __classPrivateFieldGet(this,L,"f").rules.general}getRulesIni(){return __classPrivateFieldGet(this,L,"f").rules.getIni()}getArtIni(){return __classPrivateFieldGet(this,L,"f").art.getIni()}getAiIni(){return __classPrivateFieldGet(this,L,"f").ai.getIni()}generateRandomInt(g,P){if(__classPrivateFieldGet(this,_,"f"))return __classPrivateFieldGet(this,L,"f").generateRandomInt(g,P);var I=this.generateRandom();return Math.floor(I*(P-g+1))+g}generateRandom(){return __classPrivateFieldGet(this,_,"f")?__classPrivateFieldGet(this,L,"f").generateRandom():Math.random()}getTickRate(){return __classPrivateFieldGet(this,L,"f").speed.value*z.GameSpeed.BASE_TICKS_PER_SECOND}getBaseTickRate(){return z.GameSpeed.BASE_TICKS_PER_SECOND}getCurrentTick(){return __classPrivateFieldGet(this,L,"f").currentTick}getCurrentTime(){return __classPrivateFieldGet(this,L,"f").currentTime/1e3}}),L=new WeakMap,_=new WeakMap,I=new WeakSet,U=function(g){return{type:g.type,rules:g.rules,projectileRules:g.projectileRules,warheadRules:g.warhead.rules,minRange:g.minRange,maxRange:g.range,speed:g.speed,cooldownTicks:g.getCooldownTicks()}}}}}),System.register("game/api/index",["game/bot/Bot","game/api/EventsApi","game/math/GameMath","game/math/Box2","game/math/Vector2","game/math/Vector3","game/math/Euler","game/math/Quaternion","game/math/Matrix4","game/math/Spherical","game/math/Cylindrical","engine/TheaterType","engine/type/ObjectType","game/gameobject/Building","game/gameobject/infantry/StanceType","game/gameobject/unit/ZoneType","game/gameobject/trait/AttackTrait","game/gameobject/trait/FactoryTrait","game/gameobject/unit/VeteranLevel","game/order/OrderType","game/player/production/ProductionQueue","game/rules/GeneralRules","game/rules/general/RadarRules","game/type/SpeedType","game/WeaponType","game/rules/TechnoRules","data/map/tag/TagRepeatType","engine/type/TerrainType","game/gameobject/infantry/InfDeathType","game/gameobject/unit/VeteranAbility","game/SideType","game/type/ArmorType","game/type/LandTargeting","game/type/LandType","game/type/LocomotorType","game/type/MovementZone","game/type/NavalTargeting","game/type/PipColor","game/type/SuperWeaponType","game/SuperWeapon","game/type/VhpScan"],function(g,P){"use strict";return P&&P.id,{setters:[function(P){g({Bot:P.Bot})},function(P){g({ApiEventType:P.ApiEventType})},function(P){g({GameMath:P.GameMath})},function(P){g({Box2:P.Box2})},function(P){g({Vector2:P.Vector2})},function(P){g({Vector3:P.Vector3})},function(P){g({Euler:P.Euler})},function(P){g({Quaternion:P.Quaternion})},function(P){g({Matrix4:P.Matrix4})},function(P){g({Spherical:P.Spherical})},function(P){g({Cylindrical:P.Cylindrical})},function(P){g({TheaterType:P.TheaterType})},function(P){g({ObjectType:P.ObjectType})},function(P){g({BuildStatus:P.BuildStatus})},function(P){g({StanceType:P.StanceType})},function(P){g({ZoneType:P.ZoneType})},function(P){g({AttackState:P.AttackState})},function(P){g({FactoryStatus:P.FactoryStatus})},function(P){g({VeteranLevel:P.VeteranLevel})},function(P){g({OrderType:P.OrderType})},function(P){g({QueueType:P.QueueType}),g({QueueStatus:P.QueueStatus})},function(P){g({PrereqCategory:P.PrereqCategory})},function(P){g({RadarEventType:P.RadarEventType})},function(P){g({SpeedType:P.SpeedType})},function(P){g({WeaponType:P.WeaponType})},function(P){g({FactoryType:P.FactoryType}),g({BuildCat:P.BuildCat})},function(P){g({TagRepeatType:P.TagRepeatType})},function(P){g({TerrainType:P.TerrainType})},function(P){g({InfDeathType:P.InfDeathType})},function(P){g({VeteranAbility:P.VeteranAbility})},function(P){g({SideType:P.SideType})},function(P){g({ArmorType:P.ArmorType})},function(P){g({LandTargeting:P.LandTargeting})},function(P){g({LandType:P.LandType})},function(P){g({LocomotorType:P.LocomotorType})},function(P){g({MovementZone:P.MovementZone})},function(P){g({NavalTargeting:P.NavalTargeting})},function(P){g({PipColor:P.PipColor})},function(P){g({SuperWeaponType:P.SuperWeaponType})},function(P){g({SuperWeaponStatus:P.SuperWeaponStatus})},function(P){g({VhpScan:P.VhpScan})}],execute:function(){}}}),System.register("game/api/interface/BuildingPlacementData",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("game/api/interface/GameObjectData",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("game/api/interface/PathFinderOptions",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("game/api/interface/PathNode",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("game/api/interface/PlaceCheckOptions",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("game/api/interface/PlayerData",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("game/api/interface/PlayerStats",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("game/api/interface/ReachabilityMap",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("game/api/interface/SuperWeaponData",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("game/api/interface/TileResourceData",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("game/api/interface/UnitData",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("game/api/LoggerApi",["util/format","util/Logger"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){G=g},function(g){V=g}],execute:function(){g("LoggerApi",class{constructor(g,P){I.add(this),L.set(this,void 0),_.set(this,void 0),__classPrivateFieldSet(this,L,g,"f"),__classPrivateFieldSet(this,_,P,"f")}setDebugLevel(g){__classPrivateFieldGet(this,L,"f").setLevel(g?V.AppLogger.DEBUG:V.AppLogger.WARN)}debug(...g){__classPrivateFieldGet(this,L,"f").debug(__classPrivateFieldGet(this,I,"m",U).call(this),...g)}info(...g){__classPrivateFieldGet(this,L,"f").info(__classPrivateFieldGet(this,I,"m",U).call(this),...g)}log(...g){__classPrivateFieldGet(this,L,"f").log(__classPrivateFieldGet(this,I,"m",U).call(this),...g)}warn(...g){__classPrivateFieldGet(this,L,"f").warn(__classPrivateFieldGet(this,I,"m",U).call(this),...g)}error(...g){__classPrivateFieldGet(this,L,"f").error(__classPrivateFieldGet(this,I,"m",U).call(this),...g)}time(g){__classPrivateFieldGet(this,L,"f").time(g)}timeEnd(g){__classPrivateFieldGet(this,L,"f").timeEnd(g)}}),L=new WeakMap,_=new WeakMap,I=new WeakSet,U=function(){return"["+G.formatTimeDuration(Math.floor(__classPrivateFieldGet(this,_,"f").getCurrentTime()))+"]"}}}}),System.register("game/api/MapApi",["game/type/SpeedType","game/gameobject/trait/TiberiumTrait","engine/type/TiberiumType","game/math/Vector2"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g}],execute:function(){g("MapApi",class{constructor(g){I.add(this),L.set(this,void 0),_.set(this,void 0),__classPrivateFieldSet(this,L,g,"f"),__classPrivateFieldSet(this,_,g.map,"f")}getRealMapSize(){return __classPrivateFieldGet(this,_,"f").tiles.getMapSize()}getStartingLocations(){return __classPrivateFieldGet(this,_,"f").startingLocations.map(g=>new z.Vector2(g.x,g.y))}getTheaterType(){return __classPrivateFieldGet(this,_,"f").getTheaterType()}getTile(g,P){var I=__classPrivateFieldGet(this,_,"f").tiles.getByMapCoords(g,P);if(I&&__classPrivateFieldGet(this,_,"f").mapBounds.isWithinBounds(I))return I}getTilesInRect(g,P){return(P?__classPrivateFieldGet(this,_,"f").tiles.getInRectangle(g,P):__classPrivateFieldGet(this,_,"f").tiles.getInRectangle(g)).filter(g=>__classPrivateFieldGet(this,_,"f").mapBounds.isWithinBounds(g))}getObjectsOnTile(g){return __classPrivateFieldGet(this,_,"f").getObjectsOnTile(g).map(g=>g.id)}hasBridgeOnTile(g){return!!g.onBridgeLandType}hasHighBridgeOnTile(g){return!!__classPrivateFieldGet(this,_,"f").tileOccupation.getBridgeOnTile(g)?.isHighBridge()}isPassableTile(g,P,I,L){return L=L??P===G.SpeedType.Foot,0<__classPrivateFieldGet(this,_,"f").terrain.getPassableSpeed(g,P,L,I)}findPath(g,P,I,_,U){let G=__classPrivateFieldGet(this,L,"f").map.terrain.computePath(g,P,I.tile,I.onBridge,_.tile,_.onBridge,{bestEffort:U?.bestEffort,excludeTiles:U?.excludeNodes?g=>U.excludeNodes({tile:g.tile,onBridge:!!g.onBridge}):void 0,maxExpandedNodes:U?.maxExpandedNodes});return G.map(g=>({tile:g.tile,onBridge:!!g.onBridge}))}getReachabilityMap(g,P){let I=__classPrivateFieldGet(this,L,"f").map.terrain.getIslandIdMap(g,P);return{isReachable(g,P){var I=this.getRegionId(g),L=this.getRegionId(P);return void 0!==I&&I===L},getRegionId:g=>I.get(g.tile,g.onBridge)}}isVisibleTile(g,P,I=0){var _=__classPrivateFieldGet(this,L,"f").getPlayerByName(P);if(!_)throw new Error(`Player "${P}" doesn't exist`);return!__classPrivateFieldGet(this,L,"f").mapShroudTrait.getPlayerShroud(_)?.isShrouded(g,I)}getTileResourceData(g){var P=__classPrivateFieldGet(this,_,"f").getObjectsOnTile(g).find(g=>g.isOverlay()&&g.isTiberium()||g.isTerrain()&&g.rules.spawnsTiberium);return P?__classPrivateFieldGet(this,I,"m",U).call(this,P):void 0}getAllTilesResourceData(){var g;let P=[];for(g of __classPrivateFieldGet(this,L,"f").getWorld().getAllObjects()){var _=__classPrivateFieldGet(this,I,"m",U).call(this,g);_&&P.push(_)}return P}}),L=new WeakMap,_=new WeakMap,I=new WeakSet,U=function(g){let P;if(g.isOverlay()&&g.isTiberium()){let _=g.traits.get(V.TiberiumTrait);var I=_.getTiberiumType(),L=_.getBailCount();P={tile:g.tile,ore:I!==W.TiberiumType.Gems?L:0,gems:I===W.TiberiumType.Gems?L:0,spawnsOre:!1}}else g.isTerrain()&&g.rules.spawnsTiberium&&(P={tile:g.tile,ore:0,gems:0,spawnsOre:!0});return P}}}}),System.register("game/api/PlayerApi",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){g("PlayerApi",class{constructor(g,P,L,_){this.name=g,this.actions=L,this.production=_,I.set(this,void 0),__classPrivateFieldSet(this,I,P,"f")}getPlayerData(){return __classPrivateFieldGet(this,I,"f").getPlayerData(this.name)}isDefeated(){return __classPrivateFieldGet(this,I,"f").isPlayerDefeated(this.name)}isAlliedWith(g){return __classPrivateFieldGet(this,I,"f").areAlliedPlayers(this.name,g)}canPlaceBuilding(g,P){return __classPrivateFieldGet(this,I,"f").canPlaceBuilding(this.name,g,P)}getVisibleUnits(g,P=()=>!0){return __classPrivateFieldGet(this,I,"f").getVisibleUnits(this.name,g,P)}}),I=new WeakMap}}}),System.register("game/api/ProductionApi",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){g("ProductionApi",class{constructor(g){I.set(this,void 0),__classPrivateFieldSet(this,I,g,"f")}isAvailableForProduction(g){return __classPrivateFieldGet(this,I,"f").isAvailableForProduction(g)}getAvailableObjects(g){let P=__classPrivateFieldGet(this,I,"f").getAvailableObjects();return void 0!==g&&(P=P.filter(P=>this.getQueueTypeForObject(P)===g)),P}getQueueTypeForObject(g){return __classPrivateFieldGet(this,I,"f").getQueueTypeForObject(g)}getQueueData(g){let P=__classPrivateFieldGet(this,I,"f").getQueue(g);return{size:P.currentSize,maxSize:P.maxSize,status:P.status,type:P.type,items:P.getAll().map(g=>({rules:g.rules,quantity:g.quantity}))}}}),I=new WeakMap}}}),System.register("game/api/RulesApi",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){g("RulesApi",class{get allObjectRules(){return __classPrivateFieldGet(this,I,"f").allObjectRules}get buildingRules(){return __classPrivateFieldGet(this,I,"f").buildingRules}get infantryRules(){return __classPrivateFieldGet(this,I,"f").infantryRules}get vehicleRules(){return __classPrivateFieldGet(this,I,"f").vehicleRules}get aircraftRules(){return __classPrivateFieldGet(this,I,"f").aircraftRules}get terrainRules(){return __classPrivateFieldGet(this,I,"f").terrainRules}get overlayRules(){return __classPrivateFieldGet(this,I,"f").overlayRules}get countryRules(){return __classPrivateFieldGet(this,I,"f").countryRules}get general(){return __classPrivateFieldGet(this,I,"f").general}get ai(){return __classPrivateFieldGet(this,I,"f").ai}get crateRules(){return __classPrivateFieldGet(this,I,"f").crateRules}get combatDamage(){return __classPrivateFieldGet(this,I,"f").combatDamage}get radiation(){return __classPrivateFieldGet(this,I,"f").radiation}constructor(g){I.set(this,void 0),__classPrivateFieldSet(this,I,g,"f")}hasObject(g,P){return __classPrivateFieldGet(this,I,"f").hasObject(g,P)}getObject(g,P){return __classPrivateFieldGet(this,I,"f").getObject(g,P)}getBuilding(g){return __classPrivateFieldGet(this,I,"f").getBuilding(g)}getWeapon(g){return __classPrivateFieldGet(this,I,"f").getWeapon(g)}getWarhead(g){return __classPrivateFieldGet(this,I,"f").getWarhead(g)}getProjectile(g){return __classPrivateFieldGet(this,I,"f").getProjectile(g)}getOverlayName(g){return __classPrivateFieldGet(this,I,"f").getOverlayName(g)}getOverlayId(g){return __classPrivateFieldGet(this,I,"f").getOverlayId(g)}getOverlay(g){return __classPrivateFieldGet(this,I,"f").getOverlay(g)}getCountry(g){return __classPrivateFieldGet(this,I,"f").getCountry(g)}getMultiplayerCountries(){return __classPrivateFieldGet(this,I,"f").getMultiplayerCountries()}getIni(){return __classPrivateFieldGet(this,I,"f").getIni()}}),I=new WeakMap}}}),System.register("game/art/Art",["game/art/ObjectArt","engine/type/ObjectType","game/rules/ObjectRules","data/IniSection"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("Art",class{constructor(g,P,I,L){this.rules=g,this.artIni=P,this.mapFile=I,this.logger=L,this.objectArt=new Map,this.parse()}hasObject(g,P){return this.objectArt.get(P)?.has(g)}getObject(g,P){if(!g)throw new Error(`Must specify an art name for type "${L.ObjectType[P]}"`);var G=this.objectArt.get(P)?.get(g);return G||(this.logger?.debug(`Missing art for object "${g}"`),new I.ObjectArt(P,this.rules.hasObject(g,P)?this.rules.getObject(g,P):new _.ObjectRules(P,new U.IniSection(g)),new U.IniSection(g)))}getAnimation(g){return this.getObject(g,L.ObjectType.Animation)}getProjectile(g){var P=this.rules.getProjectile(g),L=P.imageName;let _=this.artIni.getSection(L);return _||(this.logger?.debug(`Image ${L} (Projectile: ${g}) has no section in art.ini`),_=new U.IniSection(L)),I.ObjectArt.factory(P.type,P,this.artIni,_)}getIni(){return this.artIni}parse(){this.rules.allObjectRules.forEach((g,P)=>{let _=new Map;this.objectArt.set(P,_),g.forEach(g=>{var P=this.artIni.getSection(g.imageName),U=this.artIni.getSection(g.name);(P=this.applyUnitMapOverrides(g,this.mapFile,U,P))?(P=I.ObjectArt.factory(g.type,g,this.artIni,P),_.set(g.name,P)):this.logger?.debug(`${L.ObjectType[g.type]} "${g.name}" has no art section "${g.imageName}"`)})}),[[L.ObjectType.Animation,this.rules.animationNames]].forEach(([g,P])=>{let G=new Map;this.objectArt.set(g,G),P.forEach(P=>{var V,W=this.artIni.getSection(P);W?(V=new _.ObjectRules(g,new U.IniSection(P)),W=new I.ObjectArt(g,V,W),G.set(P,W)):this.logger?.debug(L.ObjectType[g]+` "${P}" has no art section`)})})}applyUnitMapOverrides(g,P,I,_){if([L.ObjectType.Infantry,L.ObjectType.Vehicle,L.ObjectType.Aircraft].includes(g.type)&&P?.getSection(g.name)?.getString("Image")&&I){let P=I.clone();_?.entries.forEach((g,I)=>{P.set(I,g)}),_=P,this.logger?.debug(`${L.ObjectType[g.type]} "${g.name}": Using merged art sections ${g.name} and `+g.imageName)}return _}})}}}),System.register("game/art/FlhCoords",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("FlhCoords",class i{constructor(g){this.forward=0,this.lateral=0,this.vertical=0,g&&3===g.length&&this.fromArray(g)}fromArray(g){return this.forward=g[0],this.lateral=g[1],this.vertical=g[2],this}clone(){return new i([this.forward,this.lateral,this.vertical])}})}}}),System.register("game/art/ObjectArt",["engine/type/PaletteType","engine/type/ObjectType","game/Coords","game/art/SequenceReader","engine/type/LightingType","game/type/LandType","game/rules/OverlayRules","game/rules/TechnoRules","game/rules/TerrainRules","game/rules/ProjectileRules","game/art/FlhCoords","game/math/Vector2","game/math/Vector3"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g}],execute:function(){g("ObjectArt",Z=class m{static getDefaultPalette(g){switch(g){case L.ObjectType.Building:case L.ObjectType.Aircraft:case L.ObjectType.Infantry:case L.ObjectType.Vehicle:case L.ObjectType.Projectile:case L.ObjectType.VoxelAnim:return I.PaletteType.Unit;case L.ObjectType.Overlay:return I.PaletteType.Overlay;case L.ObjectType.Smudge:case L.ObjectType.Terrain:return I.PaletteType.Iso;default:return L.ObjectType.Animation,I.PaletteType.Anim}}static getDefaultLighting(g){switch(g){case L.ObjectType.Animation:return G.LightingType.None;case L.ObjectType.Aircraft:case L.ObjectType.Building:case L.ObjectType.Infantry:case L.ObjectType.Vehicle:return G.LightingType.Ambient;case L.ObjectType.Projectile:case L.ObjectType.VoxelAnim:return G.LightingType.Global;case L.ObjectType.Overlay:case L.ObjectType.Smudge:case L.ObjectType.Terrain:default:return G.LightingType.Full}}static getDefaultRemapability(g){switch(g){case L.ObjectType.Aircraft:case L.ObjectType.Building:case L.ObjectType.Infantry:case L.ObjectType.Vehicle:return!0;case L.ObjectType.Overlay:case L.ObjectType.Smudge:case L.ObjectType.Terrain:case L.ObjectType.Animation:case L.ObjectType.Projectile:case L.ObjectType.VoxelAnim:return!1;default:throw new Error("Unknown object type "+g)}}static getDefaultDrawOffset(g){switch(g){case L.ObjectType.Animation:case L.ObjectType.Building:case L.ObjectType.Vehicle:case L.ObjectType.Infantry:case L.ObjectType.Overlay:case L.ObjectType.Smudge:case L.ObjectType.Projectile:case L.ObjectType.VoxelAnim:return new Q.Vector2(0,0);case L.ObjectType.Terrain:case L.ObjectType.Aircraft:return new Q.Vector2(0,(_.Coords.ISO_TILE_SIZE+1)/2);default:throw new Error("Unknown object type "+g)}}static getDefaultShadow(g){switch(g){case L.ObjectType.Overlay:case L.ObjectType.Building:case L.ObjectType.Infantry:case L.ObjectType.Terrain:case L.ObjectType.Vehicle:case L.ObjectType.Aircraft:return!0;default:case L.ObjectType.Smudge:case L.ObjectType.Animation:case L.ObjectType.Projectile:case L.ObjectType.VoxelAnim:return!1}}static getDefaultHeight(g){switch(g){case L.ObjectType.Building:return 2;case L.ObjectType.Infantry:case L.ObjectType.Vehicle:case L.ObjectType.Aircraft:return 1;default:return 0}}static factory(g,P,I,_){let G=new this(g,P,_);var V;return g===L.ObjectType.Infantry&&(!(V=_.getString("Sequence"))||(V=I.getSection(V))&&(G.sequences=(new U.SequenceReader).readIni(V))),G}constructor(g,P,I){this.sequences=new Map,this.dockingOffsets=[],this.type=g,this.rules=P,this.art=I,this.init()}init(){this.image=[L.ObjectType.Infantry,L.ObjectType.Vehicle,L.ObjectType.Aircraft].includes(this.type)?"":this.art.getString("Image"),this.report=this.art.getString("Report")||void 0,this.readRotors(),this.noHva=this.art.getBool("NoHVA"),this.startSound=this.art.getString("StartSound")||void 0,this.readMuzzleFlash(),this.readPaletteAndLightingTypes(),this.readRemapability(),this.readFlatness(),this.readDockingOffsets();var g=this.art.getNumberArray("QueueingCell");this.queueingCell=g.length?new Q.Vector2(g[0],g[1]):void 0,this.demandLoad=this.art.getBool("DemandLoad");var P=this.art.getBool("UseLineTrail"),I=this.art.getNumberArray("LineTrailColor");g=this.art.getNumber("LineTrailColorDecrement",m.DEFAULT_LINE_TRAIL_DEC);P&&I.length?(this.useLineTrail=!0,this.lineTrailColor=I,this.lineTrailColorDecrement=g):this.useLineTrail=!1,this.crater=this.art.getBool("Crater"),this.forceBigCraters=this.art.getBool("ForceBigCraters"),this.scorch=this.art.getBool("Scorch"),this.height=this.art.getNumber("Height",m.getDefaultHeight(this.type)),this.isVoxel=this.art.getBool("Voxel"),this.occupyHeight=this.art.getNumber("OccupyHeight",this.height),this.type===L.ObjectType.Building?this.canHideThings=this.art.getBool("CanHideThings",!0):this.canHideThings=!1,this.canBeHidden=this.art.getBool("CanBeHidden",!0),this.addOccupy=this.readAddRemoveOccupy("AddOccupy"),this.removeOccupy=this.readAddRemoveOccupy("RemoveOccupy"),this.rotates=this.art.getBool("Rotates"),this.toOverlay=this.art.getString("ToOverlay")||void 0}get imageName(){return(this.image||this.rules.imageName)+(this.rules.alternateArcticArt?"A":"")}get cameo(){return(this.art.getString("Cameo")||m.MISSING_CAMEO).toLowerCase()}get altCameo(){return(this.art.getString("AltCameo")||this.cameo).toLowerCase()}get useTheaterExtension(){return this.art.getBool("Theater")}readPaletteAndLightingTypes(){this.paletteType=I.PaletteType.Default,this.lightingType=G.LightingType.Default,(this.rules instanceof W.OverlayRules?this.rules.noUseTileLandType:void 0)&&(this.paletteType=I.PaletteType.Iso,this.lightingType=G.LightingType.Full),this.art.getBool("TerrainPalette")||this.art.getBool("ShouldUseCellDrawer")?this.paletteType=I.PaletteType.Iso:this.art.getBool("AnimPalette")?(this.paletteType=I.PaletteType.Anim,this.lightingType=G.LightingType.None):this.art.getString("Palette")&&(this.paletteType=I.PaletteType.Custom,this.customPaletteName=this.art.getString("Palette")),this.art.getBool("AltPalette")&&(this.paletteType=I.PaletteType.Unit),(this.rules instanceof W.OverlayRules||this.rules instanceof z.TechnoRules)&&this.rules.wall&&(this.paletteType=I.PaletteType.Unit,this.lightingType=G.LightingType.Ambient),(this.rules instanceof K.TerrainRules||this.rules instanceof z.TechnoRules)&&this.rules.gate&&(this.paletteType=I.PaletteType.Unit),this.rules instanceof K.TerrainRules&&this.rules.spawnsTiberium&&(this.paletteType=I.PaletteType.Unit,this.lightingType=G.LightingType.None),this.rules instanceof W.OverlayRules&&(this.rules.isVeins&&(this.paletteType=I.PaletteType.Unit,this.lightingType=G.LightingType.None),this.rules.isVeinholeMonster&&(this.paletteType=I.PaletteType.Unit,this.lightingType=G.LightingType.None),this.rules.tiberium&&(this.lightingType=G.LightingType.None),this.rules.land===V.LandType.Railroad&&(this.paletteType=I.PaletteType.Iso,this.lightingType=G.LightingType.Full),this.rules.crate&&(this.paletteType=I.PaletteType.Iso,this.lightingType=G.LightingType.Full)),this.paletteType===I.PaletteType.Default&&(this.paletteType=m.getDefaultPalette(this.type)),this.lightingType===G.LightingType.Default&&(this.lightingType=m.getDefaultLighting(this.type))}readRemapability(){this.remapable=m.getDefaultRemapability(this.type),this.art.getBool("TerrainPalette")||this.art.getBool("AnimPalette")?this.remapable=!1:this.rules instanceof q.ProjectileRules&&this.rules.firersPalette&&(this.remapable=!0)}readFlatness(){let g=!1;this.type===L.ObjectType.Building||this.type===L.ObjectType.Animation?g=this.art.getBool("Flat"):this.type===L.ObjectType.Smudge&&(g=!0),this.rules instanceof W.OverlayRules&&(this.rules.wall||this.rules.crate||this.rules.isARock||(g=!0)),this.flat=g}readRotors(){var g=this.art.getArray("Rotors");if(g.length){let I=[];for(let L=0;L<g.length;++L){var P=this.art.getNumberArray(`Rotor${L+1}Axis`,void 0,[0,1,0]);P=new Y.Vector3(-P[2],-P[0],P[1]).normalize();I.push({name:g[L],axis:P,speed:this.art.getNumber(`Rotor${L+1}Rate`)||void 0,idleSpeed:this.art.getNumber(`Rotor${L+1}IdleRate`)||void 0})}I.length&&(this.rotors=I)}}readMuzzleFlash(){let g=0,P="MuzzleFlash"+g,I=[];for(;this.art.has(P);){var[L,_]=this.art.getNumberArray(P);I.push({x:L,y:_}),g++,P="MuzzleFlash"+g}this.muzzleFlash=I.length?I:void 0}readDockingOffsets(){if(this.type===L.ObjectType.Building){var g=this.rules.numberOfDocks;for(let L=0;L<g;L++){var[P,I,_]=this.art.getNumberArray("DockingOffset"+L,/,\s*/,[0,0,0]);this.dockingOffsets.push(new Y.Vector3(P,_,I))}}}readAddRemoveOccupy(g){let P=0,I=[];for(;;){var L=this.art.getNumberArray(g+ ++P);if(!L.length)break;I.push(new Q.Vector2(L[0],L[1]))}return I}get bibShape(){return this.art.getString("BibShape")}get foundation(){let g=this.art.getString("Foundation","1x1");var[P,I]=g.split(/x/i);return{width:parseInt(P,10),height:parseInt(I,10)}}get foundationCenter(){return new Q.Vector2(Math.floor(this.foundation.width/2-.5),Math.floor(this.foundation.height/2-.5))}getDrawOffset(){if(this.rules instanceof K.TerrainRules&&this.rules.spawnsTiberium)return new Q.Vector2(0,0);let g=m.getDefaultDrawOffset(this.type);return this.rules instanceof W.OverlayRules&&this.rules.isARock&&(g.y+=(_.Coords.ISO_TILE_SIZE+1)/2),g}get hasShadow(){return this.art.getBool("Shadow",m.getDefaultShadow(this.type))&&!this.rules.noShadow}get turretOffset(){return this.art.getNumber("TurretOffset")}get facings(){return this.art.getNumber("Facings",8)}get walkFrames(){return this.art.getNumber("WalkFrames")}get firingFrames(){return this.art.getNumber("FiringFrames")}get standingFrames(){return this.art.getNumber("StandingFrames",1)}get startWalkFrame(){return this.art.getNumber("StartWalkFrame",0)}get startStandFrame(){return this.art.getNumber("StartStandFrame",this.walkFrames*this.facings)}get startFiringFrame(){return this.art.getNumber("StartFiringFrame",(this.walkFrames+this.standingFrames)*this.facings)}get isFlamingGuy(){return this.art.getBool("IsFlamingGuy")}get runningFrames(){return this.art.getNumber("RunningFrames")}get crawls(){return this.art.getBool("Crawls",!0)}get primaryFireFlh(){return new $.FlhCoords(this.art.getNumberArray("PrimaryFireFLH"))}get elitePrimaryFireFlh(){var g=this.art.getNumberArray("ElitePrimaryFireFLH");return g.length?new $.FlhCoords(g):this.primaryFireFlh}get primaryFirePixelOffset(){return this.art.getNumberArray("PrimaryFirePixelOffset")}get secondaryFirePixelOffset(){return this.art.getNumberArray("SecondaryFirePixelOffset")}get secondaryFireFlh(){return new $.FlhCoords(this.art.getNumberArray("SecondaryFireFLH"))}get eliteSecondaryFireFlh(){var g=this.art.getNumberArray("EliteSecondaryFireFLH");return g.length?new $.FlhCoords(g):this.secondaryFireFlh}getSpecialWeaponFlh(g){return new $.FlhCoords(this.art.getNumberArray(`Weapon${g+1}FLH`))}get fireUp(){return this.art.getNumber("FireUp")||this.art.getNumber("DelayedFireDelay")}get isAnimDelayedFire(){return this.art.getBool("IsAnimDelayedFire")}get zShapePointMove(){return this.art.getNumberArray("ZShapePointMove")}get zAdjust(){return this.art.getNumber("ZAdjust")}get trailer(){return this.art.getString("Trailer")}get spawnDelay(){return this.art.getNumber("SpawnDelay",1)}get translucent(){return this.art.getBool("Translucent")}get translucency(){var g=(g=this.art.getNumber("Translucency",0))/25*25;return g/100}}),Z.DEFAULT_LINE_TRAIL_DEC=16,Z.MISSING_CAMEO="xxicon"}}}),System.register("game/art/RotorData",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("game/art/SequenceReader",["game/art/SequenceType"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=new Map([["E",5],["S",3],["W",1],["N",7]]),g("SequenceReader",class{readIni(g){let P=new Map;for(var[_,U]of g.entries)void 0!==(_=I.SequenceType[_])&&(U=U.split(","),U={type:_,startFrame:Number(U[0]),frameCount:Number(U[1]),facingMult:Number(U[2]),onlyFacing:U[3]?L.get(U[3]):void 0},P.set(_,U));return P}})}}}),System.register("game/art/SequenceType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("SequenceType",I={}))[P.Ready=0]="Ready",P[P.Guard=1]="Guard",P[P.Prone=2]="Prone",P[P.Walk=3]="Walk",P[P.FireUp=4]="FireUp",P[P.Down=5]="Down",P[P.Crawl=6]="Crawl",P[P.Up=7]="Up",P[P.FireProne=8]="FireProne",P[P.Idle1=9]="Idle1",P[P.Idle2=10]="Idle2",P[P.Die1=11]="Die1",P[P.Die2=12]="Die2",P[P.Hover=13]="Hover",P[P.Fly=14]="Fly",P[P.FireFly=15]="FireFly",P[P.Tumble=16]="Tumble",P[P.AirDeathStart=17]="AirDeathStart",P[P.AirDeathFalling=18]="AirDeathFalling",P[P.AirDeathFinish=19]="AirDeathFinish",P[P.Tread=20]="Tread",P[P.Swim=21]="Swim",P[P.WetAttack=22]="WetAttack",P[P.WetIdle1=23]="WetIdle1",P[P.WetIdle2=24]="WetIdle2",P[P.WetDie1=25]="WetDie1",P[P.WetDie2=26]="WetDie2",P[P.Deploy=27]="Deploy",P[P.Deployed=28]="Deployed",P[P.DeployedFire=29]="DeployedFire",P[P.DeployedIdle=30]="DeployedIdle",P[P.Undeploy=31]="Undeploy",P[P.Paradrop=32]="Paradrop",P[P.Cheer=33]="Cheer",P[P.Panic=34]="Panic"}}}),System.register("game/AttackerInfo",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("game/bot/Bot",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){g("Bot",class{get game(){return this.context?.game}get player(){return this.context?.player}get gameApi(){return this.context?.game}get actionsApi(){return this.context?.player.actions}get productionApi(){return this.context?.player.production}get logger(){return this.context?.logger}constructor(g,P){this.name=g,this.country=P,I.set(this,!1)}setContext(g){this.context=g,this.context.logger.setDebugLevel(__classPrivateFieldGet(this,I,"f"))}setGameApi(g){}setActionsApi(g){}setProductionApi(g){}setLogger(g){}setDebugMode(g){return __classPrivateFieldSet(this,I,g,"f"),this.context?.logger.setDebugLevel(g),this}getDebugMode(){return __classPrivateFieldGet(this,I,"f")}onGameInit(g){}onGameStart(g){}onGameTick(g){}onGameEvent(g,P){}}),I=new WeakMap}}}),System.register("game/bot/BotContext",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("BotContext",class{constructor(g,P,I){this.game=g,this.player=P,this.logger=I}})}}}),System.register("game/bot/BotFactory",["game/gameopts/GameOpts","game/bot/DummyBot"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("BotFactory",class{constructor(g){this.botsLib=g}create(g){if(!g.isAi)throw new Error(`Player "${g.name}" is not an AI`);switch(g.aiDifficulty){case I.AiDifficulty.Easy:return new L.DummyBot(g.name,g.country.name);case I.AiDifficulty.Medium:if(this.botsLib.SupalosaBot)return new this.botsLib.SupalosaBot(g.name,g.country.name);case I.AiDifficulty.MediumSea:if(this.botsLib.lib2?.SupalosaBot)return new this.botsLib.lib2.SupalosaBot(g.name,g.country.name);default:throw new Error(`Unsupported AI difficulty "${g.aiDifficulty}"`)}}})}}}),System.register("game/bot/BotsLib",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("game/bot/DummyBot",["game/bot/Bot","game/order/OrderType"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){var P;(P=_=_||{})[P.Initial=0]="Initial",P[P.Deployed=1]="Deployed",P[P.Attacking=2]="Attacking",P[P.Defeated=3]="Defeated",U=class extends I.Bot{constructor(){super(...arguments),this.botState=_.Initial}onGameStart(g){var P=g.getTickRate();this.tickRatio=Math.ceil(P/5),this.enemyPlayers=g.getPlayers().filter(P=>P!==this.name&&!g.areAlliedPlayers(this.name,P))}onGameTick(g){if(g.getCurrentTick()%this.tickRatio==0)switch(this.botState){case _.Initial:{const I=g.getGeneralRules().baseUnit;if(g.getVisibleUnits(this.name,"self",g=>g.constructionYard).length){this.botState=_.Deployed;break}var P=g.getVisibleUnits(this.name,"self",g=>I.includes(g.name));P.length&&this.actionsApi.orderUnits([P[0]],L.OrderType.DeploySelected);break}case _.Deployed:break;case _.Attacking:g.getVisibleUnits(this.name,"self",g=>g.isSelectableCombatant).length||(this.botState=_.Defeated,this.actionsApi.quitGame())}}},g("DummyBot",U)}}}),System.register("game/BotManager",["util/disposable/CompositeDisposable","util/Logger","game/action/ActionQueue","game/api/ActionsApi","game/api/EventsApi","game/api/GameApi","game/api/LoggerApi","game/api/ProductionApi","game/api/PlayerApi","game/bot/BotContext"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g}],execute:function(){g("BotManager",class{static factory(g,P,I,L){return new this(g,new _.ActionQueue,P,I,L)}constructor(g,P,L,_,U){this.actionFactory=g,this.actionQueue=P,this.botFactory=L,this.botDebugIndex=_,this.actionLogger=U,this.bots=new Map,this.disposables=new I.CompositeDisposable}init(g){this.gameApi=new V.GameApi(g,!0);let P=new G.EventsApi(g.events);var I,_;for(I of g.getCombatants().filter(g=>g.isAi))this.bots.set(I,this.botFactory.create(I));this.updateDebugBotIndex(this.botDebugIndex.value,g);let s=P=>this.updateDebugBotIndex(P,g);for(_ of(this.botDebugIndex.onChange.subscribe(s),this.disposables.add(()=>this.botDebugIndex.onChange.unsubscribe(s)),P.subscribe(g=>this.bots.forEach(P=>P.onGameEvent(g,this.gameApi))),this.disposables.add(P),this.bots.values())){var $=new K.PlayerApi(_.name,this.gameApi,new U.ActionsApi(g,this.actionFactory,this.actionQueue,_),new z.ProductionApi(g.getPlayerByName(_.name).production)),Q=new W.LoggerApi(L.AppLogger.get(_.name),this.gameApi);_.setGameApi(this.gameApi),_.setActionsApi($.actions),_.setProductionApi($.production),_.setLogger(Q),_.setContext?.(new q.BotContext(this.gameApi,$,Q)),_.onGameInit?.(this.gameApi)}}onGameStart(){if(!this.gameApi)throw new Error("Bot manager is not initialized");for(var g of this.bots.values())g.onGameStart(this.gameApi)}update(g){var P,I;for(P of this.actionQueue.dequeueAll()){P.process();var L=P.print();L&&this.actionLogger.debug(`(${P.player.name})@${g.currentTick}: `+L)}for(I of g.getCombatants().filter(g=>g.isAi))this.bots.get(I).onGameTick(this.gameApi)}updateDebugBotIndex(g,P){var I,L=0<g?P.getAiPlayerName(g):void 0;for(I of this.bots.values())I.setDebugMode(I.name===L)}dispose(){this.gameApi=void 0,this.bots.clear(),this.disposables.dispose()}})}}}),System.register("game/ConstructionWorker",["util/geometry","engine/type/ObjectType","game/type/SpeedType","game/gameobject/task/morph/PackBuildingTask","game/gameobject/task/system/CallbackTask","game/gameobject/task/system/TaskGroup","util/disposable/CompositeDisposable","game/event/EventType","game/gameobject/trait/interface/NotifyTick"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g}],execute:function(){g("ConstructionWorker",class{constructor(g,P,I,L,_){this.player=g,this.rules=P,this.art=I,this.map=L,this.game=_,this.adjacencyMaps=new Map,this.disposables=new W.CompositeDisposable;let a=({object:g})=>{g.isBuilding()&&this.adjacencyMaps.clear()};this.map.tileOccupation.onChange.subscribe(a),this.disposables.add(()=>this.map.tileOccupation.onChange.unsubscribe(a)),this.disposables.add(this.game.events.subscribe(z.EventType.AllianceChange,()=>this.adjacencyMaps.clear()),this.game.events.subscribe(z.EventType.ObjectOwnerChange,g=>{g.target.isBuilding()&&this.adjacencyMaps.clear()}),this.game.events.subscribe(z.EventType.ObjectDestroy,g=>{g.target.isBuilding()&&g.target.rules.leaveRubble&&this.adjacencyMaps.clear()}))}getAdjacentRect(g,P,I){return{x:g.rx-I,y:g.ry-I,width:P.width+2*I,height:P.height+2*I}}getAdjacencyMap(g){var P;let I=[];for(P of[...this.player.buildings,...this.game.gameOpts.buildOffAlly?this.game.alliances.getAllies(this.player).map(g=>[...g.buildings].filter(g=>g.rules.eligibileForAllyBuilding)).flat():[]])P.rules.baseNormal&&I.push(this.getAdjacentRect(P.tile,P.art.foundation,g));return I}meetsAdjacency(g,P){let L=this.adjacencyMaps.get(P);for(var _ of(L||(L=this.getAdjacencyMap(P),this.adjacencyMaps.set(P,L)),L))if(I.rectIntersect(g,_))return!0;return!1}getPlacementPreview(g,P,I={}){var{normalizedTile:_=!1,ignoreObjects:U,ignoreAdjacent:G=!1}=I,V=this.rules.getBuilding(g),W=this.art.getObject(g,L.ObjectType.Building);let z=[];var K=W.foundation,q=_?P:this.normalizePlacementTileCoords(W,P);let $=!0;W={x:q.rx,y:q.ry,width:K.width,height:K.height},G||this.meetsAdjacency(W,V.adjacent)||($=!1);for(let g=0;g<K.width;g++)for(let P=0;P<K.height;P++){var Q={x:q.rx+g,y:q.ry+P},Y=this.map.tiles.getByMapCoords(Q.x,Q.y);Y&&z.push({rx:Q.x,ry:Q.y,buildable:$&&this.isTileBuildable(Y,V,U)})}if(V.wall&&z[0].buildable){this.getWallConnectingTiles(q,V).forEach(g=>{z.push({rx:g.rx,ry:g.ry,buildable:!0})})}return z}canPlaceAt(g,P,I={}){var{normalizedTile:_=!1,ignoreObjects:U,ignoreAdjacent:G=!1}=I,V=this.rules.getBuilding(g),W=(K=this.art.getObject(g,L.ObjectType.Building)).foundation,z=_?P:this.normalizePlacementTileCoords(K,P),K={x:z.rx,y:z.ry,width:W.width,height:W.height};if(!G&&!this.meetsAdjacency(K,V.adjacent))return!1;for(let g=0;g<W.width;g++)for(let P=0;P<W.height;P++){var q={x:z.rx+g,y:z.ry+P};if(!(q=this.map.tiles.getByMapCoords(q.x,q.y))||!this.isTileBuildable(q,V,U))return!1}return!0}placeAt(g,P,I=!1){let L=[],_=this.rules.getBuilding(g),U=I?P:this.normalizePlacementTile(g,P);if(_.wall){let g=[[U,_]],P=this.getWallConnectingTiles(U,_);for(var G of(P.forEach(P=>{P!==U&&g.push([P,_])}),g))L.push(this.executePlacement(G[0],G[1]))}else{var V,W=this.executePlacement(U,_);for(V of(L.push(W),this.map.tileOccupation.calculateTilesForGameObject(U,W))){var z=this.map.getObjectsOnTile(V).find(g=>g.isSmudge());z&&this.game.unspawnObject(z)}}return L}normalizePlacementTileCoords(g,P){var I=g.foundationCenter;return{rx:P.rx-I.x,ry:P.ry-I.y}}normalizePlacementTile(g,P){var I=this.art.getObject(g,L.ObjectType.Building),_=this.normalizePlacementTileCoords(I,P);if(!(I=this.map.tiles.getByMapCoords(_.rx,_.ry)))throw new Error(`Can't build outside map (${_.rx}, ${_.ry})`);return I}unplace(g,P){g.unitOrderTrait.cancelAllTasks(),g.unitOrderTrait.addTasks(new V.TaskGroup(new U.PackBuildingTask(this.game),new G.CallbackTask(()=>{this.game.unspawnObject(g),P()})).setCancellable(!1)),g.unitOrderTrait[K.NotifyTick.onTick](g,this.game)}executePlacement(g,P){let I=this.game.createObject(L.ObjectType.Building,P.name);return this.game.changeObjectOwner(I,this.player),I.purchaseValue=this.game.sellTrait.computePurchaseValue(P,this.player),this.game.spawnObject(I,g),I}getWallConnectingTiles(g,P){var I,L=P.guardRange+1;let _=[];for(I of[[0,1],[0,-1],[1,0],[-1,0]]){let G=[];for(let V=0;V<L;++V){var U={x:g.rx+I[0]*V,y:g.ry+I[1]*V};if(!(U=this.map.tiles.getByMapCoords(U.x,U.y)))break;if(this.map.getObjectsOnTile(U).find(g=>g.isBuilding()&&g.name===P.name&&g.owner===this.player)){_=_.concat(G);break}if(!this.isTileBuildable(U,P))break;G.push(U)}}return _}isTileBuildable(g,P,I){return!!this.map.isWithinBounds(g)&&!this.game.mapShroudTrait.getPlayerShroud(this.player)?.isShrouded(g)&&!this.map.getGroundObjectsOnTile(g).some(g=>!(I?.includes(g)||g.isBuilding()&&g.rules.invisibleInGame||g.isSmudge()))&&(P.waterBound?0<this.rules.getLandRules(g.landType).getSpeedModifier(_.SpeedType.Float):0===g.rampType&&this.rules.getLandRules(g.landType).buildable)}dispose(){this.disposables.dispose()}})}}}),System.register("game/Coords",["game/math/GameMath","game/math/Vector2","game/math/Vector3"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("Coords",U=class n{static tileToWorld(g,P){return{x:g*n.LEPTONS_PER_TILE,y:P*n.LEPTONS_PER_TILE}}static vecWorldToGround(g){return new L.Vector2(g.x,g.z)}static vecGroundToWorld(g){return new _.Vector3(g.x,0,g.y)}static tileHeightToWorld(g){return g*(n.LEPTONS_PER_TILE/2)*n.zScale}static worldToTileHeight(g){return g/(n.LEPTONS_PER_TILE/2*n.zScale)}static tile3dToWorld(g,P,I){var L=n.tileToWorld(g,P),U=n.tileHeightToWorld(I);return new _.Vector3(L.x,U,L.y)}static screenDistanceToWorld(g,P){return{x:Math.floor((g+2*P)/2*n.ISO_WORLD_SCALE),y:Math.floor((2*P-g)/2*n.ISO_WORLD_SCALE)}}static getWorldTileSize(){return n.LEPTONS_PER_TILE}}),U.ISO_TILE_SIZE=30,U.LEPTONS_PER_TILE=256,U.ISO_WORLD_SCALE=U.LEPTONS_PER_TILE/U.ISO_TILE_SIZE,U.ISO_CAMERA_ALPHA=Math.PI/6,U.ISO_CAMERA_BETA=Math.PI/4,U.COS_ISO_CAMERA_BETA=I.GameMath.cos(U.ISO_CAMERA_BETA),U.zScale=U.COS_ISO_CAMERA_BETA/I.GameMath.cos(U.ISO_CAMERA_ALPHA)}}}),System.register("game/CountdownTimer",["game/event/TimerExpireEvent","game/GameSpeed"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("CountdownTimer",class{constructor(){this.ticks=0,this.running=!1}getSeconds(){return Math.floor(this.ticks/L.GameSpeed.BASE_TICKS_PER_SECOND)}setSeconds(g){this.ticks=Math.max(0,Math.floor(L.GameSpeed.BASE_TICKS_PER_SECOND*g))}addSeconds(g){this.ticks=Math.max(0,this.ticks+Math.floor(L.GameSpeed.BASE_TICKS_PER_SECOND*g))}start(){this.running=!0}stop(){this.running=!1}isRunning(){return this.running}update(g){this.running&&(0<this.ticks?this.ticks--:(this.running=!1,g.events.dispatch(new I.TimerExpireEvent(this))))}})}}}),System.register("game/Country",["engine/type/ObjectType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("Country",class{static factory(g,P){return new this(P.getCountry(g))}constructor(g){this.rules=g}get id(){return this.rules.id}get side(){return this.rules.side}get name(){return this.rules.name}isPlayable(){return this.rules.multiplay&&!this.rules.multiplayPassive}hasVeteranUnit(g,P){let L=[];switch(g){case I.ObjectType.Aircraft:L=this.rules.veteranAircraft;break;case I.ObjectType.Infantry:L=this.rules.veteranInfantry;break;case I.ObjectType.Vehicle:L=this.rules.veteranUnits;break;default:throw new Error(`Unsupported object type "${I.ObjectType[g]}"`)}return L.includes(P)}})}}}),System.register("game/event/AllianceChangeEvent",["game/event/EventType"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){var P;(P=L||g("AllianceEventType",L={}))[P.Requested=0]="Requested",P[P.Formed=1]="Formed",P[P.Broken=2]="Broken",g("AllianceChangeEvent",class{constructor(g,P,L){this.alliance=g,this.changeType=P,this.from=L,this.type=I.EventType.AllianceChange}})}}}),System.register("game/event/BridgeRepairEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("BridgeRepairEvent",class{constructor(g,P){this.source=g,this.tile=P,this.type=I.EventType.BridgeRepair}})}}}),System.register("game/event/BuildingCaptureEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("BuildingCaptureEvent",class{constructor(g){this.target=g,this.type=I.EventType.BuildingCapture}})}}}),System.register("game/event/BuildingEvacuateEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("BuildingEvacuateEvent",class{constructor(g,P){this.target=g,this.player=P,this.type=I.EventType.BuildingEvacuate}})}}}),System.register("game/event/BuildingFailedPlaceEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("BuildingFailedPlaceEvent",class{constructor(g,P,L){this.name=g,this.player=P,this.tile=L,this.type=I.EventType.BuildingFailedPlace}})}}}),System.register("game/event/BuildingGarrisonEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("BuildingGarrisonEvent",class{constructor(g){this.target=g,this.type=I.EventType.BuildingGarrison}})}}}),System.register("game/event/BuildingInfiltrationEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("BuildingInfiltrationEvent",class{constructor(g,P){this.target=g,this.source=P,this.type=I.EventType.BuildingInfiltration}})}}}),System.register("game/event/BuildingPlaceEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("BuildingPlaceEvent",class{constructor(g){this.target=g,this.type=I.EventType.BuildingPlace}})}}}),System.register("game/event/BuildingRepairFullEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("BuildingRepairFullEvent",class{constructor(g,P){this.target=g,this.source=P,this.type=I.EventType.BuildingRepairFull}})}}}),System.register("game/event/BuildingRepairStartEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("BuildingRepairStartEvent",class{constructor(g){this.target=g,this.type=I.EventType.BuildingRepairStart}})}}}),System.register("game/event/BuildStatusChangeEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("BuildStatusChangeEvent",class{constructor(g,P){this.target=g,this.status=P,this.type=I.EventType.BuildStatusChange}})}}}),System.register("game/event/CheerEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("CheerEvent",class{constructor(g){this.player=g,this.type=I.EventType.Cheer}})}}}),System.register("game/event/CratePickupEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("CratePickupEvent",class{constructor(g,P,L,_){this.target=g,this.player=P,this.source=L,this.tile=_,this.type=I.EventType.CratePickup}})}}}),System.register("game/event/DeployNotAllowedEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("DeployNotAllowedEvent",class{constructor(g){this.target=g,this.type=I.EventType.DeployNotAllowed}})}}}),System.register("game/event/EnterObjectEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("EnterObjectEvent",class{constructor(g,P){this.target=g,this.source=P,this.type=I.EventType.EnterObject}})}}}),System.register("game/event/EnterTileEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("EnterTileEvent",class{constructor(g,P){this.target=g,this.source=P,this.type=I.EventType.EnterTile}})}}}),System.register("game/event/EnterTransportEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("EnterTransportEvent",class{constructor(g){this.target=g,this.type=I.EventType.EnterTransport}})}}}),System.register("game/event/EventMap",["game/event/EventType"],function(g,P){"use strict";return P&&P.id,{setters:[function(g){}],execute:function(){}}}),System.register("game/event/EventType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("EventType",I={}))[P.Cheer=0]="Cheer",P[P.UnitDeployUndeploy=1]="UnitDeployUndeploy",P[P.WeaponFire=2]="WeaponFire",P[P.ObjectDestroy=3]="ObjectDestroy",P[P.ObjectSpawn=4]="ObjectSpawn",P[P.ObjectUnspawn=5]="ObjectUnspawn",P[P.ObjectMorph=6]="ObjectMorph",P[P.ObjectLiftOff=7]="ObjectLiftOff",P[P.ObjectLand=8]="ObjectLand",P[P.ObjectCrashing=9]="ObjectCrashing",P[P.ObjectDisguiseChange=10]="ObjectDisguiseChange",P[P.ObjectCloakChange=11]="ObjectCloakChange",P[P.ObjectAttacked=12]="ObjectAttacked",P[P.ShipSubmergeChange=13]="ShipSubmergeChange",P[P.BridgeRepair=14]="BridgeRepair",P[P.BuildStatusChange=15]="BuildStatusChange",P[P.BuildingPlace=16]="BuildingPlace",P[P.BuildingFailedPlace=17]="BuildingFailedPlace",P[P.ObjectSell=18]="ObjectSell",P[P.BuildingRepairFull=19]="BuildingRepairFull",P[P.BuildingCapture=20]="BuildingCapture",P[P.BuildingInfiltration=21]="BuildingInfiltration",P[P.BuildingGarrison=22]="BuildingGarrison",P[P.BuildingEvacuate=23]="BuildingEvacuate",P[P.BuildingRepairStart=24]="BuildingRepairStart",P[P.UnitRepairStart=25]="UnitRepairStart",P[P.UnitRepairFinish=26]="UnitRepairFinish",P[P.UnitRecycle=27]="UnitRecycle",P[P.InflictDamage=28]="InflictDamage",P[P.HealthChange=29]="HealthChange",P[P.WarheadDetonate=30]="WarheadDetonate",P[P.PlayerDefeated=31]="PlayerDefeated",P[P.PlayerResigned=32]="PlayerResigned",P[P.PlayerDropped=33]="PlayerDropped",P[P.DeployNotAllowed=34]="DeployNotAllowed",P[P.PowerChange=35]="PowerChange",P[P.PowerLow=36]="PowerLow",P[P.PowerRestore=37]="PowerRestore",P[P.RadarOnOff=38]="RadarOnOff",P[P.ObjectOwnerChange=39]="ObjectOwnerChange",P[P.RadarEvent=40]="RadarEvent",P[P.InsufficientFunds=41]="InsufficientFunds",P[P.RallyPointChange=42]="RallyPointChange",P[P.PrimaryFactoryChange=43]="PrimaryFactoryChange",P[P.FactoryProduceUnit=44]="FactoryProduceUnit",P[P.ObjectTeleport=45]="ObjectTeleport",P[P.AllianceChange=46]="AllianceChange",P[P.UnitPromote=47]="UnitPromote",P[P.EnterTransport=48]="EnterTransport",P[P.LeaveTransport=49]="LeaveTransport",P[P.EnterObject=50]="EnterObject",P[P.EnterTile=51]="EnterTile",P[P.SuperWeaponReady=52]="SuperWeaponReady",P[P.SuperWeaponActivate=53]="SuperWeaponActivate",P[P.LightningStormManifest=54]="LightningStormManifest",P[P.LightningStormCloud=55]="LightningStormCloud",P[P.CratePickup=56]="CratePickup",P[P.PingLocation=57]="PingLocation",P[P.StalemateDetect=58]="StalemateDetect",P[P.TriggerSoundFx=59]="TriggerSoundFx",P[P.TriggerStopSoundFx=60]="TriggerStopSoundFx",P[P.TriggerEva=61]="TriggerEva",P[P.TriggerAnim=62]="TriggerAnim",P[P.TriggerText=63]="TriggerText",P[P.TimerExpire=64]="TimerExpire"}}}),System.register("game/event/FactoryProduceUnitEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("FactoryProduceUnitEvent",class{constructor(g){this.target=g,this.type=I.EventType.FactoryProduceUnit}})}}}),System.register("game/event/GameEvent",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("game/event/HealthChangeEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("HealthChangeEvent",class{constructor(g,P,L){this.target=g,this.currentHealth=P,this.prevHealth=L,this.type=I.EventType.HealthChange}})}}}),System.register("game/event/InflictDamageEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("InflictDamageEvent",class{constructor(g,P,L,_,U){this.target=g,this.attacker=P,this.damageHitPoints=L,this.currentHealth=_,this.prevHealth=U,this.type=I.EventType.InflictDamage}})}}}),System.register("game/event/InsufficientFundsEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("InsufficientFundsEvent",class{constructor(g){this.target=g,this.type=I.EventType.InsufficientFunds}})}}}),System.register("game/event/LeaveTransportEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("LeaveTransportEvent",class{constructor(g){this.target=g,this.type=I.EventType.LeaveTransport}})}}}),System.register("game/event/LightningStormCloudEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("LightningStormCloudEvent",class{constructor(g){this.position=g,this.type=I.EventType.LightningStormCloud}})}}}),System.register("game/event/LightningStormManifestEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("LightningStormManifestEvent",class{constructor(g){this.target=g,this.type=I.EventType.LightningStormManifest}})}}}),System.register("game/event/ObjectAttackedEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("ObjectAttackedEvent",class{constructor(g,P,L){this.target=g,this.attacker=P,this.incidental=L,this.type=I.EventType.ObjectAttacked}})}}}),System.register("game/event/ObjectCloakChangeEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("ObjectCloakChangeEvent",class{constructor(g){this.target=g,this.type=I.EventType.ObjectCloakChange}})}}}),System.register("game/event/ObjectCrashingEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("ObjectCrashingEvent",class{constructor(g){this.gameObject=g,this.type=I.EventType.ObjectCrashing}})}}}),System.register("game/event/ObjectDestroyEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("ObjectDestroyEvent",class{constructor(g,P,L){this.target=g,this.attackerInfo=P,this.incidental=L,this.type=I.EventType.ObjectDestroy}})}}}),System.register("game/event/ObjectDisguiseChangeEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("ObjectDisguiseChangeEvent",class{constructor(g){this.target=g,this.type=I.EventType.ObjectDisguiseChange}})}}}),System.register("game/event/ObjectLandEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("ObjectLandEvent",class{constructor(g){this.gameObject=g,this.type=I.EventType.ObjectLand}})}}}),System.register("game/event/ObjectLiftOffEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("ObjectLiftOffEvent",class{constructor(g){this.gameObject=g,this.type=I.EventType.ObjectLiftOff}})}}}),System.register("game/event/ObjectMorphEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("ObjectMorphEvent",class{constructor(g,P){this.from=g,this.to=P,this.type=I.EventType.ObjectMorph}})}}}),System.register("game/event/ObjectOwnerChangeEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("ObjectOwnerChangeEvent",class{constructor(g,P){this.target=g,this.prevOwner=P,this.type=I.EventType.ObjectOwnerChange}})}}}),System.register("game/event/ObjectSellEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("ObjectSellEvent",class{constructor(g){this.target=g,this.type=I.EventType.ObjectSell}})}}}),System.register("game/event/ObjectSpawnEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("ObjectSpawnEvent",class{constructor(g){this.gameObject=g,this.type=I.EventType.ObjectSpawn}})}}}),System.register("game/event/ObjectTeleportEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("ObjectTeleportEvent",class{constructor(g,P,L){this.target=g,this.isChronoshift=P,this.prevTile=L,this.type=I.EventType.ObjectTeleport}})}}}),System.register("game/event/ObjectUnspawnEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("ObjectUnspawnEvent",class{constructor(g){this.gameObject=g,this.type=I.EventType.ObjectUnspawn}})}}}),System.register("game/event/PingLocationEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("PingLocationEvent",class{constructor(g,P){this.tile=g,this.player=P,this.type=I.EventType.PingLocation}})}}}),System.register("game/event/PlayerDefeatedEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("PlayerDefeatedEvent",class{constructor(g){this.target=g,this.type=I.EventType.PlayerDefeated}})}}}),System.register("game/event/PlayerDroppedEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("PlayerDroppedEvent",class{constructor(g,P){this.target=g,this.assetsRedistributed=P,this.type=I.EventType.PlayerDropped}})}}}),System.register("game/event/PlayerResignedEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("PlayerResignedEvent",class{constructor(g,P){this.target=g,this.assetsRedistributed=P,this.type=I.EventType.PlayerResigned}})}}}),System.register("game/event/PowerChangeEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("PowerChangeEvent",class{constructor(g,P,L){this.target=g,this.power=P,this.drain=L,this.type=I.EventType.PowerChange}})}}}),System.register("game/event/PowerLowEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("PowerLowEvent",class{constructor(g){this.target=g,this.type=I.EventType.PowerLow}})}}}),System.register("game/event/PowerRestoreEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("PowerRestoreEvent",class{constructor(g){this.target=g,this.type=I.EventType.PowerRestore}})}}}),System.register("game/event/PrimaryFactoryChangeEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("PrimaryFactoryChangeEvent",class{constructor(g){this.target=g,this.type=I.EventType.PrimaryFactoryChange}})}}}),System.register("game/event/RadarEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("RadarEvent",class{constructor(g,P,L){this.target=g,this.radarEventType=P,this.tile=L,this.type=I.EventType.RadarEvent}})}}}),System.register("game/event/RadarOnOffEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("RadarOnOffEvent",class{constructor(g,P){this.target=g,this.radarEnabled=P,this.type=I.EventType.RadarOnOff}})}}}),System.register("game/event/RallyPointChangeEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("RallyPointChangeEvent",class{constructor(g){this.target=g,this.type=I.EventType.RallyPointChange}})}}}),System.register("game/event/ShipSubmergeChangeEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("ShipSubmergeChangeEvent",class{constructor(g){this.target=g,this.type=I.EventType.ShipSubmergeChange}})}}}),System.register("game/event/StalemateDetectEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("StalemateDetectEvent",class{constructor(){this.type=I.EventType.StalemateDetect}})}}}),System.register("game/event/SuperWeaponActivateEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("SuperWeaponActivateEvent",class{constructor(g,P,L,_,U){this.target=g,this.owner=P,this.atTile=L,this.atTile2=_,this.noSfxWarning=U,this.type=I.EventType.SuperWeaponActivate}})}}}),System.register("game/event/SuperWeaponReadyEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("SuperWeaponReadyEvent",class{constructor(g){this.target=g,this.type=I.EventType.SuperWeaponReady}})}}}),System.register("game/event/TimerExpireEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("TimerExpireEvent",class{constructor(g){this.target=g,this.type=I.EventType.TimerExpire}})}}}),System.register("game/event/TriggerAnimEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("TriggerAnimEvent",class{constructor(g,P){this.name=g,this.tile=P,this.type=I.EventType.TriggerAnim}})}}}),System.register("game/event/TriggerEvaEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("TriggerEvaEvent",class{constructor(g){this.soundId=g,this.type=I.EventType.TriggerEva}})}}}),System.register("game/event/TriggerSoundFxEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("TriggerSoundFxEvent",class{constructor(g,P){this.soundId=g,this.tile=P,this.type=I.EventType.TriggerSoundFx}})}}}),System.register("game/event/TriggerStopSoundFxEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("TriggerStopSoundFxEvent",class{constructor(g){this.tile=g,this.type=I.EventType.TriggerStopSoundFx}})}}}),System.register("game/event/TriggerTextEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("TriggerTextEvent",class{constructor(g){this.label=g,this.type=I.EventType.TriggerText}})}}}),System.register("game/event/UnitDeployUndeployEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("UnitDeployUndeployEvent",class{constructor(g,P){this.unit=g,this.deployType=P,this.type=I.EventType.UnitDeployUndeploy}})}}}),System.register("game/event/UnitPromoteEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("UnitPromoteEvent",class{constructor(g){this.target=g,this.type=I.EventType.UnitPromote}})}}}),System.register("game/event/UnitRecycleEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("UnitRecycleEvent",class{constructor(g){this.target=g,this.type=I.EventType.UnitRecycle}})}}}),System.register("game/event/UnitRepairFinishEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("UnitRepairFinishEvent",class{constructor(g,P){this.target=g,this.from=P,this.type=I.EventType.UnitRepairFinish}})}}}),System.register("game/event/UnitRepairStartEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("UnitRepairStartEvent",class{constructor(g){this.target=g,this.type=I.EventType.UnitRepairStart}})}}}),System.register("game/event/WarheadDetonateEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("WarheadDetonateEvent",class{constructor(g,P,L,_){this.target=g,this.position=P,this.explodeAnim=L,this.isLightningStrike=_,this.type=I.EventType.WarheadDetonate}})}}}),System.register("game/event/WeaponFireEvent",["game/event/EventType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("WeaponFireEvent",class{constructor(g,P){this.weapon=g,this.gameObject=P,this.type=I.EventType.WeaponFire}})}}}),System.register("game/Game",["game/ConstructionWorker","game/gameopts/GameOpts","engine/type/ObjectType","util/event","game/map/OreSpread","game/gameobject/Infantry","game/Alliances","util/BoxedVar","game/StartingUnitsGenerator","game/map/tileFinder/CardinalTileFinder","game/type/SpeedType","game/Target","game/map/BridgeOverlayTypes","util/math","game/GameEventBus","game/event/ObjectDestroyEvent","game/event/PlayerDefeatedEvent","game/ini/GameModeType","game/Traits","game/trait/interface/NotifyTick","game/trait/interface/NotifyDestroy","game/trait/interface/NotifySpawn","game/trait/interface/NotifyUnspawn","game/trait/interface/NotifyOwnerChange","game/event/ObjectOwnerChangeEvent","game/event/ObjectUnspawnEvent","game/trait/interface/NotifyTargetDestroy","game/gameobject/unit/VeteranLevel","game/event/ObjectSpawnEvent","game/map/OreOverlayTypes","game/Weapon","game/GameSpeed","game/gameobject/common/DeathType","game/map/Bridges","game/SuperWeapon","game/event/AllianceChangeEvent","game/trait/interface/NotifyAllianceChange","game/gameopts/constants","game/gameobject/unit/ZoneType","game/Prng","game/trigger/TriggerManager","game/CountdownTimer","game/WeaponType","game/Warhead","game/trait/interface/NotifyObjectTraitAdd","game/event/RadarOnOffEvent","util/geometry"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be,Se,we,Ee,Ce,xe,Oe,Ae,Me,Re,Pe,Ie,ke;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g},function(g){ce=g},function(g){he=g},function(g){ue=g},function(g){de=g},function(g){ge=g},function(g){pe=g},function(g){me=g},function(g){fe=g},function(g){ye=g},function(g){Te=g},function(g){ve=g},function(g){be=g},function(g){Se=g},function(g){we=g},function(g){Ee=g},function(g){Ce=g},function(g){xe=g},function(g){Oe=g},function(g){Ae=g},function(g){Me=g},function(g){Re=g},function(g){Pe=g},function(g){Ie=g}],execute:function(){var P;(P=ke||g("GameStatus",ke={}))[P.NotStarted=0]="NotStarted",P[P.Started=1]="Started",P[P.Ended=2]="Ended",g("Game",class{get onEnd(){return this._onEnd.asEvent()}constructor(g,P,I,L,_,G,V,W,K,q,$,Q,Y,Z,J){this.updatableObjects=new Set,this.constructionWorkers=new Map,this.currentTick=0,this.currentTime=0,this.countdownTimer=new Oe.CountdownTimer,this._onEnd=new U.EventDispatcher,this.afterTickCallbacks=[],this.events=new X.GameEventBus,this.traits=new re.Traits,this.debugText=new z.BoxedVar(""),this.world=g,this.map=P,this.rules=I,this.art=L,this.ai=_,this.id=G,this.startTimestamp=V,this.prng=Ce.Prng.factory(G,V),this.gameOpts=W,this.gameModeType=K,this.playerList=q,this.unitSelection=$,this.alliances=Q,this.desiredSpeed=new z.BoxedVar(fe.GameSpeed.computeGameSpeed(W.gameSpeed)),this.speed=new z.BoxedVar(this.desiredSpeed.value),this.nextObjectId=Y,this.objectFactory=Z,this.botManager=J,this.triggers=new xe.TriggerManager}addPlayer(g){this.playerList.addPlayer(g),this.constructionWorkers.set(g,this.createConstructionWorker(g))}getPlayer(g){return this.playerList.getPlayerAt(g)}getPlayerByName(g){return this.playerList.getPlayerByName(g)}getAiPlayerName(g){let P;return P="number"==typeof g?g:this.gameOpts.aiPlayers.indexOf(g),`@@AI${P+1}@@`}getPlayerNumber(g){return this.playerList.getPlayerNumber(g)}getCombatants(){return this.playerList.getCombatants()}getCivilianPlayer(){return this.playerList.getCivilian()}getAllPlayers(){return this.playerList.getAll()}getNonNeutralPlayers(){return this.playerList.getNonNeutral()}areFriendly(g,P){return g.owner===P.owner||this.alliances.areAllied(g.owner,P.owner)}getWorld(){return this.world}createConstructionWorker(g){return new I.ConstructionWorker(g,this.rules,this.art,this.map,this)}getConstructionWorker(g){var P=this.constructionWorkers.get(g);if(!P)throw new Error(`No construction worker found for player "${g.name}"`);return P}getUnitSelection(){return this.unitSelection}init(g){this.localPlayer=g,this.createMapObjects(),this.createPlayerInitialUnits(),this.map.terrain.computeAllPassabilityGraphs(),this.mapShroudTrait.init(this),this.crateGeneratorTrait.init(this),this.playerList.getAll().forEach(g=>g.credits=this.gameOpts.credits),this.rules.mpDialogSettings.alliesAllowed&&this.createInitialTeams(),this.botManager.init(this),this.triggers.init(this)}start(){this.status=ke.Started,this.currentTick=0,this.currentTime=0,this.botManager.onGameStart()}createInitialTeams(){for(let _=0;_<this.gameOpts.maxSlots;_++){var g=[...this.gameOpts.humanPlayers,...this.gameOpts.aiPlayers].filter(g=>g?.teamId===_&&g.countryId!==we.OBS_COUNTRY_ID).map(g=>L.isHumanPlayerInfo(g)?g.name:this.getAiPlayerName(g));if(1<g.length)for(let L=0;L<g.length-1;L++)for(let _=L+1;_<g.length;_++){var P=this.getPlayerByName(g[L]),I=this.getPlayerByName(g[_]);I=this.alliances.setAlliance(P,I,W.AllianceStatus.Formed);this.onAllianceChange(I,P,!0)}}}createMapObjects(){var g=this.rules.general.harvesterUnit.every(g=>!Z.isBetween(this.rules.getObject(g,_.ObjectType.Vehicle).techLevel,0,this.rules.mpDialogSettings.techLevel)),P=this.map.getInitialMapObjects();this.createInitialMapTerrains(P.terrains,g),this.createInitialMapOverlays(P.overlays,g),this.createInitialMapSmudges(P.smudges),this.createInitialMapTechnos(P.technos)}createInitialMapTerrains(g,P){for(var I of g){var L,U,G=I.name;this.validateMapObjectRulesAndArt(G,_.ObjectType.Terrain)&&((L=this.map.tiles.getByMapCoords(I.rx,I.ry))?(U=this.rules.getObject(G,_.ObjectType.Terrain),P&&U.spawnsTiberium||(G=this.createObject(_.ObjectType.Terrain,G),this.spawnObject(G,L))):console.warn(`Invalid map object location (${I.rx},${I.ry})`,I))}}createInitialMapOverlays(g,P){let I=new Map,L=new Map;var U,V,W,z=this.map.bridges.findMapHighBridgeHeadTiles();let K=this.map.bridges.findBridgeSpecsForHeadTiles([...z]);for(U of g){var q=this.rules.getOverlayName(U.id);if(this.validateMapObjectRulesAndArt(q,_.ObjectType.Overlay)){let g=this.createObject(_.ObjectType.Overlay,q);g.overlayId=U.id,g.value=U.value;let V=U.rx,W=U.ry;if(g.isBridge()&&g.isHighBridge()){g.position.tileElevation=4;var $=K.find(g=>Ie.rectContainsPoint({x:g.start.rx,y:g.start.ry,...this.map.bridges.getBridgeSize(g)},{x:V,y:W}));if($){var{type:q,isXBridge:Q,isHigh:$}=$;if(!$){console.warn(`Expected high bridge but found low bridge overlay at location (${V},${W})`),g.dispose();continue}Q!==g.isXBridge()&&(Z=Y.BridgeOverlayTypes.calculateHighBridgeOverlayId(q,Q),g.overlayId!==Z&&(g.overlayId=Z,g.name=this.rules.getOverlayName(Z)))}V+=g.isXBridge()?0:-1,W+=g.isXBridge()?-1:0}var Z,Q;if(Q=this.map.tiles.getByMapCoords(V,W))if(g.rules.tiberium&&(void 0===(Z=pe.OreOverlayTypes.getOverlayTibType(U.id))||void 0!==(Z=G.OreSpread.calculateOverlayId(Z,Q))&&Z!==U.id&&(g.dispose(),g=this.createObject(_.ObjectType.Overlay,this.rules.getOverlayName(Z)),g.overlayId=Z,g.value=U.value)),Y.BridgeOverlayTypes.isLowBridge(U.id))Y.BridgeOverlayTypes.isBridgePlaceholder(U.id)||(I.set(Q,U.value),1===U.value?L.set(Q,g):g.dispose());else{if(g.isTiberium()&&this.map.getObjectsOnTile(Q).find(g=>g.isTerrain())){g.dispose();continue}P&&g.isTiberium()?g.dispose():this.spawnObject(g,Q)}else console.warn(`Invalid map object location (${V},${W})`,U),g.dispose()}}for([V,W]of L){var X=W.isXBridge(),J=this.map.tiles.getByMapCoords(V.rx+(X?0:-1),V.ry+(X?-1:0));X=this.map.tiles.getByMapCoords(V.rx+(X?0:1),V.ry+(X?1:0));J&&X&&(0===I.get(J)||2===I.get(X))?(W.value=0,this.spawnObject(W,J)):(W.dispose(),console.warn(`Invalid bridge segment @${V.rx},${V.ry}. Skipping.`))}var ee;z=[...L.keys()].filter(g=>this.map.bridges.getPieceAtTile(g)?.headType!==Te.BridgeHeadType.None);let te=[...this.map.bridges.findBridgeSpecsForHeadTiles([...z]),...K];for(ee of te)for(var re of this.map.bridges.findBridgePieces(ee))re.obj.bridgeTrait.bridgeSpec=ee;z=te.map(g=>this.map.bridges.findAllBridgeTiles(g)).flat();var se,ae=Y.BridgeOverlayTypes.bridgePlaceholderIds[0],ne=this.rules.getOverlayName(ae);for(se of z){let g=this.createObject(_.ObjectType.Overlay,ne);g.overlayId=ae,this.spawnObject(g,se)}}createInitialMapSmudges(g){for(var P of g){var I=P.name,L=this.map.tiles.getByMapCoords(P.rx,P.ry);L?(I=this.createObject(_.ObjectType.Smudge,I),this.spawnObject(I,L)):console.warn(`Invalid map object location (${P.rx},${P.ry})`,P)}}createInitialMapTechnos(g){let P=new Map(this.playerList.getAll().filter(g=>!!g.country).map(g=>[g.country.name,g])),I=this.map.getTags();for(let G of g){var L=G.name;if(this.validateMapObjectRulesAndArt(L,G.type)){var _=this.map.tiles.getByMapCoords(G.rx,G.ry);if(_){var U=P.get(G.owner);if(U){if(U.isNeutral){let g=this.createObject(G.type,L);G.tag&&(g.tag=I.find(g=>g.id===G.tag)),g.healthTrait.health=G.health/256*100;let P=!1;if(!g.healthTrait.health){if(!g.isBuilding()||!g.rules.leaveRubble){g.dispose();continue}P=!0}if(G.isInfantry()||G.isVehicle()||G.isAircraft()){g.direction=(-G.direction/256*360+360)%360,G.isInfantry()&&(g.position.subCell=G.subCell);let P=!1;G.onBridge&&(void 0===_.onBridgeLandType?console.warn(`Cannot place unit "${G.name}" on a bridge because no bridge was found at ${_.rx}, `+_.ry):P=!0),g.onBridge=P,g.zone=Ee.getZoneType(P?_.onBridgeLandType:_.landType),P&&(g.position.tileElevation+=this.map.tileOccupation.getBridgeOnTile(_)?.tileElevation??0),G.veterancy&&g.veteranTrait?.setRelativeXP(G.veterancy)}else g.poweredTrait?.setTurnedOn(G.poweredOn);this.changeObjectOwner(g,U),this.spawnObject(g,_),P&&this.destroyObject(g,void 0,!0)}}else console.warn(`Invalid owner "${G.owner}" for map object`,G)}else console.warn(`Invalid map object location (${G.rx},${G.ry})`,G)}}}validateMapObjectRulesAndArt(g,P){return this.rules.hasObject(g,P)?!!this.art.hasObject(g,P)||(console.warn(`Map object '${g}' has no art section. Skipping.`),!1):(console.warn(`Map object '${g}' has no rules section. Skipping.`),!1)}createPlayerInitialUnits(){let g=this.playerList.getCombatants().map(g=>g.country);var P=[...this.rules.infantryRules.values(),...this.rules.vehicleRules.values()].filter(P=>P.allowedToStartInMultiplayer&&!P.naval&&-1!==P.techLevel&&P.techLevel<=this.rules.mpDialogSettings.techLevel&&!this.rules.general.baseUnit.includes(P.name)&&g.some(g=>P.isAvailableTo(g)&&P.hasOwner(g)));for(let g of this.playerList.getCombatants()){var I=this.map.startingLocations[g.startLocation],L=this.map.tiles.getByMapCoords(I.x,I.y);if(!L)throw new Error(`Invalid player starting position (${I.x},${I.y})`);let Z=this.rules.general.baseUnit.find(P=>{let I=this.rules.getObject(P,_.ObjectType.Vehicle);return I.isAvailableTo(g.country)&&I.hasOwner(g.country)});if(!Z)throw new Error("No suitable MCV found for player country "+g.country?.name);I=this.rules.getObject(Z,_.ObjectType.Vehicle),I=this.createUnitForPlayer(I,g),this.spawnObject(I,L);let X=K.StartingUnitsGenerator.generate(this.gameOpts.unitCount,[...this.rules.vehicleRules.keys()],P,g.country);var U,G,W;this.gameModeType===te.GameModeType.Unholy&&X.push(...this.rules.general.baseUnit.filter(g=>g!==Z).map(g=>({name:g,type:_.ObjectType.Vehicle,count:1})));let J=[],ee=!1,re=new q.CardinalTileFinder(this.map.tiles,this.map.mapBounds,L,4,4,g=>!this.map.getGroundObjectsOnTile(g).find(g=>!(g.isSmudge()||g.isOverlay()&&g.isTiberium()))&&0<this.map.terrain.getPassableSpeed(g,$.SpeedType.Foot,!1,!1)),se=new Map,ae=0;for({name:U,type:G,count:W}of X){let P=W;for(;0<P;){let I;if(ee||(I=re.getNextTile(),I?J.push(I):ee=!0),ee&&J.length){var z=J[ae];let g=se.get(z);g||(g=new q.CardinalTileFinder(this.map.tiles,this.map.mapBounds,z,1,0,g=>!this.map.getGroundObjectsOnTile(g).find(g=>!(g.isSmudge()||g.isOverlay()&&g.isTiberium()))&&0<this.map.terrain.getPassableSpeed(g,$.SpeedType.Foot,!1,!1)),se.set(z,g)),ae=(ae+1)%J.length,I=g.getNextTile()}if(I){var Q,Y=this.rules.getObject(U,G);if(G===_.ObjectType.Vehicle)z=this.createUnitForPlayer(Y,g),this.applyInitialVeteran(z,g),this.spawnObject(z,I),P--;else{if(G!==_.ObjectType.Infantry)throw new Error("Should not reach this line");for(Q of V.Infantry.SUB_CELLS.slice(0,P)){let L=this.createUnitForPlayer(Y,g);L.position.subCell=Q,this.applyInitialVeteran(L,g),this.spawnObject(L,I),P--}}}else P--}}}}applyInitialVeteran(g,P){g.veteranTrait&&(this.rules.general.veteran.initialVeteran?g.veteranTrait.setVeteranLevel(de.VeteranLevel.Elite):P.country.hasVeteranUnit(g.type,g.name)&&g.veteranTrait.setVeteranLevel(de.VeteranLevel.Veteran))}createObject(g,P){return this.objectFactory.create(g,P,this.rules,this.art)}createUnitForPlayer(g,P){if(![_.ObjectType.Aircraft,_.ObjectType.Vehicle,_.ObjectType.Infantry].includes(g.type))throw new Error(`Attempted to create an invalid unit type "${g.type}"`);let I=this.createObject(g.type,g.name);return this.changeObjectOwner(I,P),I.purchaseValue=this.sellTrait.computePurchaseValue(I.rules,P),I}createProjectile(g,P,I,L,U){let G=this.createObject(_.ObjectType.Projectile,g);return G.fromWeapon=I,G.fromObject=P,G.fromPlayer=P.owner,G.target=L,G.isShrapnel=U,G}createLooseProjectile(g,P,I){var L=this.rules.getWeapon(g),U=L.projectile,G=this.rules.getProjectile(U),V=this.rules.getWarhead(L.warhead);V={minRange:0,projectileRules:G,range:Number.POSITIVE_INFINITY,rules:L,speed:me.Weapon.computeSpeed(L,G),type:Ae.WeaponType.Primary,warhead:new Me.Warhead(V)};let W=this.createObject(_.ObjectType.Projectile,U);return W.fromWeapon=V,W.fromObject=void 0,W.fromPlayer=P,W.target=I,W}createSuperWeapon(g,P,I=!1){var L=this.rules.getSuperWeapon(g);return new ve.SuperWeapon(g,L,P,I)}createTarget(g,P){return new Q.Target(g,P,this.map.tileOccupation)}isValidTarget(g){if(g){if(!g.isSpawned||g.isCrashing)return!1;if(!(g.rules.legalTarget||g.isBuilding()&&g.rules.hospital))return!1;if(g.isBuilding()&&g.rules.invisibleInGame)return!1}return!0}spawnObject(g,P){if(g.isTechno()&&g.limboData)throw new Error(`Object ${g.name}#${g.id} is in limbo. Use unlimboObject instead or clear limboData first`);this.doSpawnObject(g,P)}unspawnObject(g){g.isTechno()&&g.owner&&g.owner.removeOwnedObject(g),this.doUnspawnObject(g)}limboObject(g,P){g.limboData=P,this.doUnspawnObject(g)}unlimboObject(g,P,I=!1){var L=g.limboData;if(!L)throw new Error(`Object ${g.name}#${g.id} has no limboData attached`);g.limboData=void 0,this.doSpawnObject(g,P);let _=this.getUnitSelection();L.selected&&!I&&_.addToSelection(g),void 0!==L.controlGroup&&_.addUnitsToGroup(L.controlGroup,[g],!1)}doSpawnObject(g,P){var I,L;g.position.tile=P,g.isBuilding()&&(L=g.art.foundationCenter,I=P.rx+L.x,L=P.ry+L.y,g.centerTile=this.map.tiles.getByMapCoords(I,L)??this.map.tiles.getPlaceholderTile(I,L)),this.world.spawnObject(g),(g.cachedTraits.tick.length||g.isProjectile()||g.isDebris()||g.isTechno())&&this.updatableObjects.add(g),g.isTechno()&&this.map.technosByTile.add(g),g.isProjectile()||g.isDebris()||this.map.tileOccupation.occupyTileRange(P,g),g.art.canHideThings&&this.map.tileOcclusion.addOccluder(g),g.onSpawn(this),this.traits.filter(ne.NotifySpawn).forEach(P=>{P[ne.NotifySpawn.onSpawn](g,this)}),this.events.dispatch(new ge.ObjectSpawnEvent(g))}doUnspawnObject(g){var P=g.tile;g.isProjectile()||g.isDebris()||this.map.tileOccupation.unoccupyTileRange(P,g),g.art.canHideThings&&this.map.tileOcclusion.removeOccluder(g),g.isTechno()&&(this.unitSelection.cleanupUnit(g),this.map.technosByTile.remove(g)),this.world.removeObject(g),this.updatableObjects.delete(g),g.onUnspawn(this),this.traits.filter(oe.NotifyUnspawn).forEach(P=>{P[oe.NotifyUnspawn.onUnspawn](g,this)}),this.events.dispatch(new he.ObjectUnspawnEvent(g))}destroyObject(g,P,I=!1,L=!1){if(g.isDestroyed)throw new Error(`Object with ID "${g.id}" is already destroyed`);if(g.isTechno()){let I=g.mindControllableTrait?.getOriginalOwner()??g.owner;!P||g.isBuilding()&&!I.isCombatant()||(P.player.addUnitsKilled(g.type,1),P.player===I||this.alliances.areAllied(P.player,I)||(P.player.score+=g.rules.points)),I.isNeutral||I.addUnitsLost(g.type,1)}if(g.isDestroyed=!0,g.healthTrait&&(g.healthTrait.health=0),g.onDestroy(this,P,I),this.traits.filter(ae.NotifyDestroy).forEach(I=>{I[ae.NotifyDestroy.onDestroy](g,this,P)}),P?.obj?.traits.filter(ue.NotifyTargetDestroy).forEach(I=>{I[ue.NotifyTargetDestroy.onDestroy](P.obj,g,P.weapon,this)}),this.events.dispatch(new J.ObjectDestroyEvent(g,P,L)),g.isBuilding()&&g.rules.leaveRubble&&g.deathType!==ye.DeathType.Temporal){g.owner.removeOwnedObject(g),this.unitSelection.cleanupUnit(g);var _=this.map.tileOccupation.calculateTilesForGameObject(g.tile,g);this.map.terrain.invalidateTiles(_),g.art.canHideThings&&this.map.tileOcclusion.removeOccluder(g),this.updatableObjects.delete(g),g.onUnspawn(this),this.traits.filter(oe.NotifyUnspawn).forEach(P=>{P[oe.NotifyUnspawn.onUnspawn](g,this)}),this.events.dispatch(new he.ObjectUnspawnEvent(g))}else if(g.isSpawned)this.unspawnObject(g);else if(g.isTechno()&&g.owner){if(!g.limboData)throw new Error(`Object with ID "${g.id}" should be in limbo but has no limboData`);g.owner.removeOwnedObject(g)}g.dispose()}getObjectById(g){return this.world.getObjectById(g)}changeObjectOwner(g,P){const I=g.owner;I&&I.removeOwnedObject(g),P.addOwnedObject(g),I&&I!==P&&(this.traits.filter(le.NotifyOwnerChange).forEach(P=>{P[le.NotifyOwnerChange.onChange](g,I,this)}),g.onOwnerChange(I,this),this.events.dispatch(new ce.ObjectOwnerChangeEvent(g,I)),I===this.localPlayer&&g.owner!==this.localPlayer&&(this.unitSelection.removeFromSelection([g]),this.unitSelection.removeUnitsFromGroup([g])))}addObjectTrait(g,P){g.addTrait(P),this.traits.filter(Re.NotifyObjectTraitAdd).forEach(I=>{I[Re.NotifyObjectTraitAdd.onAdd](g,P,this)})}onAllianceChange(g,P,I){this.events.dispatch(new be.AllianceChangeEvent(g,I?be.AllianceEventType.Formed:be.AllianceEventType.Broken,P)),this.traits.filter(Se.NotifyAllianceChange).forEach(P=>{P[Se.NotifyAllianceChange.onChange](g,I,this)})}update(){if(this.status!==ke.NotStarted){for(var g of(this.botManager.update(this),this.status!==ke.Ended&&(void 0===this.lastGameEndCheck||1e3<=this.currentTime-this.lastGameEndCheck)&&(this.checkGameEndConditions(),this.lastGameEndCheck=this.currentTime),[...this.updatableObjects]))g.isSpawned&&g.update(this);if(this.playerList.getCombatants().forEach(g=>g.cheerCooldownTicks=Math.max(0,g.cheerCooldownTicks-1)),this.traits.filter(se.NotifyTick).forEach(g=>{g[se.NotifyTick.onTick](this)}),this.localPlayer&&!this.localPlayer.isObserver&&!this.localPlayer.defeated){var P=this.unitSelection.getSelectedUnits();if(1===P.length){let g=P[0];if(g.isTechno()&&g.owner!==this.localPlayer){let P=this.mapShroudTrait.getPlayerShroud(this.localPlayer);this.map.tileOccupation.calculateTilesForGameObject(g.tile,g).find(I=>!P.isShrouded(I,g.tileElevation))||(this.unitSelection.deselectAll(),this.unitSelection.cleanupUnit(g))}}}for(var I of this.afterTickCallbacks)I();this.afterTickCallbacks.length=0,this.triggers.update(this),this.countdownTimer.update(this),this.currentTick++,this.currentTime+=1e3/fe.GameSpeed.BASE_TICKS_PER_SECOND}}afterTick(g){this.afterTickCallbacks.push(g)}checkGameEndConditions(){this.updateDefeatedPlayers(this.playerList.getCombatants()),(this.localPlayer?.defeated&&!this.localPlayer.isObserver||!this.alliances.getHostilePlayers().length&&1<this.gameOpts.humanPlayers.length+this.gameOpts.aiPlayers.filter(g=>!!g).length)&&this.end()}end(){this.status!==ke.Ended&&(this.status=ke.Ended,this._onEnd.dispatch(this,void 0))}updateDefeatedPlayers(g){let P=this.stalemateDetectTrait?.isStale()&&0===this.stalemateDetectTrait.getCountdownTicks(),I=this.gameOpts.shortGame;g.forEach(g=>{let L;if(P)L=!0;else{let P;P=I?(P=[...g.getOwnedObjectsByType(_.ObjectType.Building,!0)].some(g=>!g.rules.insignificant),P||g.getOwnedObjects(!0).some(g=>this.rules.general.baseUnit.includes(g.name))):g.getOwnedObjects(!0).some(g=>!g.rules.insignificant&&!g.limboData?.inTransport),L=!P}var U;L&&(g.defeated=!0,(U=this.alliances.getHostilePlayers().some(g=>!g.first.isAi||!g.second.isAi))&&(g.isObserver=!0),this.removeAllPlayerAssets(g),this.events.dispatch(new ee.PlayerDefeatedEvent(g)),U&&(this.mapShroudTrait.getPlayerShroud(g)?.revealAll(),U=g.radarTrait.isDisabled(),g.radarTrait.setDisabled(!1),U&&this.events.dispatch(new Pe.RadarOnOffEvent(g,!0))))})}removeAllPlayerAssets(g){g.getOwnedObjects().forEach(g=>{g.isDestroyed||(g.isBuilding()&&g.rules.returnable&&g.rules.needsEngineer&&!g.garrisonTrait?this.changeObjectOwner(g,this.getCivilianPlayer()):g.isBuilding()&&g.wallTrait||this.destroyObject(g,void 0,!0))}),g.getOwnedObjects(!0).forEach(g=>{g.isDestroyed||(g.limboData?.inTransport||g.isBuilding()&&g.wallTrait?this.changeObjectOwner(g,this.getCivilianPlayer()):this.destroyObject(g,void 0,!0))})}isAssetRedistributionEnabled(){return this.rules.mpDialogSettings.mustAlly&&!this.rules.mpDialogSettings.allyChangeAllowed}redistributeAllPlayerAssets(g){if(g.isObserver)return!1;if(!this.isAssetRedistributionEnabled())return!1;let P=this.alliances.getAllies(g).filter(g=>!g.isAi&&!g.defeated);if(0<P.length){var I,L=[...P].sort((g,P)=>P.score-g.score)[0];for(I of g.getOwnedObjects(!0))this.changeObjectOwner(I,L);var _,U=Math.floor(g.credits/P.length),G=g.credits%P.length;for(_ of P)_.credits+=U;return P[0].credits+=G,!0}return!1}generateRandomInt(g,P){return this.prng.generateRandomInt(g,P)}generateRandom(){return this.prng.generateRandom()}getHash(){return Z.fnv32a([...new Uint8Array(new Float64Array([this.prng.getLastRandom()]).buffer),this.nextObjectId.value,...this.world.getAllObjects().map(g=>g.getHash()),...this.playerList.getAll().map(g=>g.getHash()),this.alliances.getHash(),...this.traits.getAll().map(g=>g.getHash?.()??0)])}debugGetState(){return{currentTick:this.currentTick,lastRandom:this.prng.getLastRandom(),nextObjectId:this.nextObjectId.value,objects:this.world.getAllObjects().map(g=>g.debugGetState()),players:this.playerList.getAll().map(g=>g.debugGetState()),alliances:this.alliances.debugGetState(),traits:this.traits.getAll().reduce((g,P)=>{var I=P.debugGetState?.();return void 0!==I&&(g[P.constructor.name]=I),g},{})}}dispose(){this.world.getAllObjects().forEach(g=>g.dispose()),this.playerList.getAll().forEach(g=>g.dispose()),this.constructionWorkers.forEach(g=>g.dispose()),this.botManager.dispose(),this.triggers.dispose(),this.map.dispose(),this.traits.dispose()}})}}}),System.register("game/GameEventBus",["util/event"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("GameEventBus",class{constructor(){this.dispatcher=new I.EventDispatcher,this.dispatchersByType=new Map}dispatch(g){this.dispatcher.dispatch(void 0,g),this.dispatchersByType.get(g.type)?.dispatch(void 0,g)}subscribe(g,P){let I,L;return L="function"==typeof g?g:(I=g,P),void 0===I?(this.dispatcher.subscribe(L),()=>this.unsubscribe(L)):this.subscribeType(I,L)}unsubscribe(g,P){let I,L;L="function"==typeof g?g:(I=g,P),void 0===I?this.dispatcher.unsubscribe(L):this.unsubscribeType(I,L)}subscribeType(g,P){let L=this.dispatchersByType.get(g);return L||(L=new I.EventDispatcher,this.dispatchersByType.set(g,L)),L.subscribe(P),()=>this.unsubscribeType(g,P)}unsubscribeType(g,P){this.dispatchersByType.get(g)?.unsubscribe(P)}})}}}),System.register("game/GameFactory",["game/rules/Rules","game/art/Art","data/IniFile","game/Country","game/gameobject/ObjectFactory","game/World","game/GameMap","game/gameopts/GameOpts","game/gameopts/constants","util/typeGuard","game/Alliances","game/PlayerList","game/gameobject/selection/UnitSelection","util/BoxedVar","game/player/PlayerFactory","game/trait/PowerTrait","game/trait/SellTrait","game/trait/RadarTrait","game/trait/ProductionTrait","game/trait/MapShroudTrait","game/Game","game/trait/MapRadiationTrait","game/action/ActionFactory","game/action/ActionFactoryReg","game/trait/SuperWeaponsTrait","game/trait/SharedDetectDisguiseTrait","game/trait/SharedDetectCloakTrait","game/trait/CrateGeneratorTrait","game/trait/StalemateDetectTrait","game/gameopts/GameOptSanitizer","game/gameopts/GameOptRandomGen","game/trait/MapLightingTrait","game/Prng","game/ai/Ai","game/bot/BotFactory","game/BotManager"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g},function(g){ce=g},function(g){he=g},function(g){ue=g},function(g){de=g},function(g){ge=g},function(g){pe=g},function(g){me=g},function(g){fe=g},function(g){ye=g},function(g){Te=g},function(g){ve=g},function(g){be=g}],execute:function(){g("GameFactory",class{static create(g,P,Se,we,Ee,Ce,xe,Oe,Ae,Me,Re,Pe,Ie,ke,Be,Ne,Le){let je=Se.clone().mergeWith(Ce);for(var De of xe)je.mergeWith(De);je.mergeWith(g);var Fe=we.clone().mergeWith(g.artOverrides??new _.IniFile);let _e=new I.Rules(je,ke);var Ue=new L.Art(_e,Fe,g,ke),He=new Te.Ai(Ee);_e.applySpecialFlags(g.specialFlags),pe.GameOptSanitizer.sanitize(Me,_e);let Ge=new I.Rules(Se),Ve=Ge.getMultiplayerCountries(),We=[...Ge.getMultiplayerColors().values()],ze=ye.Prng.factory(Oe,Ae),Ke=new W.GameMap(g,P,_e,ze.generateRandomInt.bind(ze));var qe=new V.World,$e=Re.getById(Me.gameMode).type,Qe=new Q.PlayerList,Ye=new $.Alliances(Qe),Ze=new Y.UnitSelection,Xe=new Z.BoxedVar(1),Je=new G.ObjectFactory(Ke.tiles,Ke.tileOccupation,Ke.bridges,Xe),et=new oe.ActionFactory;Fe=new ve.BotFactory(Ie),Fe=be.BotManager.factory(et,Fe,Ne,Le);let tt=new ae.Game(qe,Ke,_e,Ue,He,Oe,Ae,Me,$e,Qe,Ze,Ye,Xe,Je,Fe);(new le.ActionFactoryReg).register(et,tt,void 0),tt.traits.add(new J.PowerTrait),tt.sellTrait=new ee.SellTrait(tt,_e.general),tt.traits.add(tt.sellTrait),tt.traits.add(new te.RadarTrait);let it=new re.ProductionTrait(_e,Be);tt.traits.add(it),tt.mapShroudTrait=new se.MapShroudTrait(Ke,Ye),tt.traits.add(tt.mapShroudTrait),tt.mapRadiationTrait=new ne.MapRadiationTrait(Ke),tt.traits.add(tt.mapRadiationTrait),tt.mapLightingTrait=new fe.MapLightingTrait(_e.audioVisual,Ke.getLighting()),tt.traits.add(tt.mapLightingTrait),tt.traits.add(new ce.SuperWeaponsTrait),tt.traits.add(new he.SharedDetectDisguiseTrait),tt.traits.add(new ue.SharedDetectCloakTrait),tt.crateGeneratorTrait=new de.CrateGeneratorTrait(Me.cratesAppear),tt.traits.add(tt.crateGeneratorTrait),Pe||(tt.stalemateDetectTrait=new ge.StalemateDetectTrait,tt.traits.add(tt.stalemateDetectTrait));let rt=new X.PlayerFactory(_e,Me,it.getAvailableObjects()),st=me.GameOptRandomGen.factory(Oe,Ae),at=st.generateColors(Me),nt=st.generateCountries(Me,Ge),ot=st.generateStartLocations(Me,Ke.startingLocations);return[...Me.humanPlayers,...Me.aiPlayers].filter(q.isNotNullOrUndefined).forEach(g=>{let P,I,L;if(z.isHumanPlayerInfo(g)?(P=g.name,I=!1):(P=tt.getAiPlayerName(g),I=!0,L=g.difficulty),g.countryId!==K.OBS_COUNTRY_ID){var _=nt.get(g)??g.countryId,G=at.get(g)??g.colorId,V=ot.get(g)??g.startPos;if(_===K.RANDOM_COUNTRY_ID)throw new Error("Random country should have been resolved by now");if(G===K.RANDOM_COLOR_ID)throw new Error("Random color should have been resolved by now");if(V===K.RANDOM_START_POS)throw new Error("Random start location should have been resolved by now");_=Ve[_].name,_=U.Country.factory(_,_e),G=We[G],tt.addPlayer(rt.createCombatant(P,_,V,G,I,L))}else tt.addPlayer(rt.createObserver(P,_e))}),tt.addPlayer(rt.createNeutral(_e,"@@NEUTRAL@@")),tt}})}}}),System.register("game/GameMap",["game/map/TileCollection","game/map/TileOccupation","game/map/Terrain","game/map/MapBounds","game/map/Bridges","util/QuadTree","game/map/TileOcclusion","game/theater/AutoLat","engine/TheaterType","game/math/Vector2","game/math/Box2"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g}],execute:function(){g("GameMap",class{get startingLocations(){return this.mapFile.startingLocations}constructor(g,P,Q,Y){this.mapFile=g,this.tiles=new I.TileCollection(this.mapFile.tiles,P,Q.general,Y),this.mapBounds=(new U.MapBounds).fromMapFile(this.mapFile,this.tiles),this.tileOccupation=new L.TileOccupation(this.tiles),this.tileOcclusion=new W.TileOcclusion(this.tiles),this.terrain=new _.Terrain(this.tiles,this.mapFile.theaterType,this.mapBounds,this.tileOccupation,Q),this.bridges=new G.Bridges(P,this.tiles,this.tileOccupation,this.mapBounds,Q);let Z=this.mapFile.tags;for(let g of this.mapFile.cellTags){let P=this.tiles.getByMapCoords(g.coords.x,g.coords.y);P&&(P.tag=Z.find(P=>P.id===g.tagId))}var X=this.tiles.getMapSize(),J=Math.max(X.width,X.height)/5;this.technosByTile=new V.QuadTree(new $.Box2(new q.Vector2(0,0),new q.Vector2(X.width,X.height)),{getKey:g=>{var P=g.isBuilding()?g.centerTile:g.tile;return new q.Vector2(P.rx,P.ry)},maxDepth:this.computeQuadDepth(J),splitThreshold:10,joinThreshold:5}),this.mapFile.theaterType!==K.TheaterType.Snow&&z.AutoLat.calculate(this.tiles,P)}computeQuadDepth(g){if(g<=1)return 1;let P=0;for(;1<=g/2;)g/=2,P++;return P+(1<g?1:0)}getLighting(){return this.mapFile.lighting}getIonLighting(){return this.mapFile.ionLighting}getTheaterType(){return this.mapFile.theaterType}getTags(){return this.mapFile.tags}getTriggers(){return this.mapFile.triggers}getCellTags(){return this.mapFile.cellTags}getVariables(){return this.mapFile.variables}getWaypoint(g){return this.mapFile.waypoints.find(P=>P.number===g)}getTileAtWaypoint(g){var P=this.getWaypoint(g);if(P&&(P=this.tiles.getByMapCoords(P.rx,P.ry)))return P}isWithinBounds(g){return this.mapBounds.isWithinBounds(g)}clampWithinBounds(g){var P=this.mapBounds.clampWithinBounds(g);let I=this.tiles.getByDisplayCoords(P.dx,P.dy);if(I&&this.mapBounds.isWithinBounds(I)){let g=I,P=I.z;for(;0<=P&&g&&this.mapBounds.isWithinBounds(g);)I=g,g=this.tiles.getByDisplayCoords(g.dx,g.dy+2),P-=2}else{let g=0;for(;!I||!this.mapBounds.isWithinBounds(I);){if(30<g)throw new Error("Exceeded max elevation while trying to clamp tile to map bounds");I=this.tiles.getByDisplayCoords(P.dx,P.dy+g),g+=2}}return I}isWithinHardBounds(g){return this.mapBounds.isWithinHardBounds(g)}getInitialMapObjects(){return{terrains:this.mapFile.terrains,overlays:this.mapFile.overlays,smudges:this.mapFile.smudges,technos:[...this.mapFile.structures,...this.mapFile.infantries,...this.mapFile.vehicles,...this.mapFile.aircrafts]}}getObjectsOnTile(g){return this.tileOccupation.getObjectsOnTile(g)}getGroundObjectsOnTile(g){return this.tileOccupation.getGroundObjectsOnTile(g)}getTileZone(g,P=!1){return this.tileOccupation.getTileZone(g,P)}dispose(){this.terrain.dispose(),this.bridges.dispose()}})}}}),System.register("game/gameobject/Aircraft",["engine/type/ObjectType","game/gameobject/trait/MoveTrait","game/gameobject/unit/ZoneType","game/gameobject/trait/DockableTrait","game/gameobject/Techno","game/gameobject/trait/ParasiteableTrait","game/gameobject/trait/CrashableTrait","game/gameobject/trait/AirportBoundTrait","game/gameobject/trait/SpawnLinkTrait","game/gameobject/trait/MissileSpawnTrait","game/gameobject/unit/CrateBonuses","game/gameobject/trait/UnlandableTrait"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g}],execute:function(){Y=class extends G.Techno{get direction(){return this.yaw}set direction(g){this.yaw=g}get isMoving(){return this.moveTrait.isMoving()}static factory(g,P,I,_,G){let $=new this(g,P,I);return $.rules.airportBound&&$.rules.dock.length&&($.airportBoundTrait=new z.AirportBoundTrait($.rules.dock),$.traits.add($.airportBoundTrait)),$.rules.missileSpawn||($.crashableTrait=new W.CrashableTrait($),$.traits.add($.crashableTrait)),$.rules.spawned&&($.rules.missileSpawn?($.missileSpawnTrait=new q.MissileSpawnTrait,$.traits.add($.missileSpawnTrait)):($.spawnLinkTrait=new K.SpawnLinkTrait,$.traits.add($.spawnLinkTrait))),$.moveTrait=new L.MoveTrait($,G),$.traits.add($.moveTrait),P.dock.length&&$.traits.add(new U.DockableTrait),P.landable&&g!==_.general.paradrop.paradropPlane||$.traits.add(new Q.UnlandableTrait),P.parasiteable&&($.parasiteableTrait=new V.ParasiteableTrait($),$.traits.add($.parasiteableTrait)),$}constructor(g,P,L){super(I.ObjectType.Aircraft,g,P,L),this.pitch=0,this.yaw=0,this.roll=0,this.onBridge=!1,this.zone=_.ZoneType.Ground,this.crateBonuses=new $.CrateBonuses}isUnit(){return!0}isAircraft(){return!0}},g("Aircraft",Y)}}}),System.register("game/gameobject/Building",["engine/type/ObjectType","game/gameobject/trait/GarrisonTrait","game/gameobject/trait/TurretTrait","game/rules/TechnoRules","game/event/BuildStatusChangeEvent","game/gameobject/trait/PoweredTrait","game/gameobject/trait/FactoryTrait","game/gameobject/trait/DockTrait","game/gameobject/trait/FreeUnitTrait","game/gameobject/Techno","game/gameobject/trait/CrewedTrait","game/gameobject/trait/CabHutTrait","game/gameobject/trait/OilDerrickTrait","game/gameobject/trait/WallTrait","game/Coords","game/gameobject/trait/OverpoweredTrait","game/gameobject/trait/UnitRepairTrait","game/gameobject/trait/RallyTrait","game/gameobject/trait/C4ChargeTrait","game/gameobject/trait/HelipadTrait","game/gameobject/trait/UnitReloadTrait","game/gameobject/task/WaitForBuildUpTask","game/gameobject/trait/SuperWeaponTrait","game/gameobject/trait/GapGeneratorTrait","game/gameobject/trait/PsychicDetectorTrait","game/gameobject/trait/HospitalTrait","game/math/Vector2","game/gameobject/trait/DelayedKillTrait","game/gameobject/trait/interface/NotifyBuildStatus"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce,he,ue,de,ge,pe,me;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g},function(g){ce=g},function(g){he=g},function(g){ue=g},function(g){de=g},function(g){ge=g}],execute:function(){var P;(P=pe||g("BuildStatus",pe={}))[P.BuildUp=0]="BuildUp",P[P.Ready=1]="Ready",P[P.BuildDown=2]="BuildDown",me=class extends q.Techno{get buildStatus(){return this._buildStatus}static factory(g,P,I,G,q,X){let ne=new this(g,P,G);return P.canBeOccupied&&(ne.garrisonTrait=new L.GarrisonTrait(ne,I.audioVisual.conditionRed,P.maxNumberOccupants),ne.traits.add(ne.garrisonTrait)),P.canC4&&!P.wall&&(ne.c4ChargeTrait=new re.C4ChargeTrait,ne.traits.add(ne.c4ChargeTrait)),P.eligibleForDelayKill&&(ne.delayedKillTrait=new de.DelayedKillTrait,ne.traits.add(ne.delayedKillTrait)),P.bridgeRepairHut&&(ne.cabHutTrait=new Q.CabHutTrait(ne,X),ne.traits.add(ne.cabHutTrait)),P.crewed&&(ne.crewedTrait=new $.CrewedTrait,ne.traits.add(ne.crewedTrait)),P.turret&&(ne.turretTrait=new _.TurretTrait,ne.traits.add(ne.turretTrait)),P.overpowerable&&(ne.overpoweredTrait=new J.OverpoweredTrait(ne),ne.traits.add(ne.overpoweredTrait)),(P.powered&&0!==P.power||P.needsEngineer)&&(ne.poweredTrait=new V.PoweredTrait(ne),ne.traits.add(ne.poweredTrait)),(P.factory||P.cloning)&&(ne.factoryTrait=new W.FactoryTrait(P.cloning?U.FactoryType.InfantryType:P.factory,P.cloning),ne.traits.add(ne.factoryTrait)),P.superWeapon&&(ne.superWeaponTrait=new oe.SuperWeaponTrait(P.superWeapon),ne.traits.add(ne.superWeaponTrait)),P.numberOfDocks&&(ne.dockTrait=new z.DockTrait(ne,q,P.numberOfDocks,G.dockingOffsets),ne.traits.add(ne.dockTrait),P.helipad&&(ne.helipadTrait=new se.HelipadTrait,ne.traits.add(ne.helipadTrait)),(P.unitRepair||P.unitReload)&&(ne.unitRepairTrait=new ee.UnitRepairTrait,ne.traits.add(ne.unitRepairTrait)),P.unitReload&&(ne.unitReloadTrait=new ae.UnitReloadTrait,ne.traits.add(ne.unitReloadTrait))),P.hospital&&(ne.hospitalTrait=new he.HospitalTrait,ne.traits.add(ne.hospitalTrait)),(P.factory||P.cloning||P.numberOfDocks)&&(ne.rallyTrait=new te.RallyTrait,ne.traits.add(ne.rallyTrait)),P.freeUnit&&ne.traits.add(new K.FreeUnitTrait),P.produceCashStartup&&ne.traits.add(new Y.OilDerrickTrait),P.wall&&(ne.wallTrait=new Z.WallTrait,ne.traits.add(ne.wallTrait)),P.gapGenerator&&(ne.gapGeneratorTrait=new le.GapGeneratorTrait(P.gapRadiusInCells),ne.traits.add(ne.gapGeneratorTrait)),P.psychicDetectionRadius&&(ne.psychicDetectorTrait=new ce.PsychicDetectorTrait(P.psychicDetectionRadius),ne.traits.add(ne.psychicDetectorTrait)),ne}constructor(g,P,L){super(I.ObjectType.Building,g,P,L),this.showWeaponRange=!1,this.direction=0,this._buildStatus=pe.BuildUp,this.lastBuildStatus=this.buildStatus}isBuilding(){return!0}getFoundation(){return this.art.foundation}getFoundationCenterOffset(){var g=this.getFoundation();return new ue.Vector2(g.width/2*X.Coords.LEPTONS_PER_TILE,g.height/2*X.Coords.LEPTONS_PER_TILE)}update(g){this.buildStatus!==pe.BuildUp||this.unitOrderTrait.hasTasks()||this.unitOrderTrait.addTask(new ne.WaitForBuildUpTask(g.rules.general.buildupTime,g)),this.attackTrait?.setDisabled(this.buildStatus!==pe.Ready||!!this.poweredTrait&&!this.poweredTrait.isPoweredOn()),super.update(g)}setBuildStatus(g,P){this._buildStatus=g;let I=this.lastBuildStatus;this.buildStatus!==I&&(this.lastBuildStatus=this.buildStatus,this.traits.filter(ge.NotifyBuildStatus).forEach(g=>{g[ge.NotifyBuildStatus.onStatusChange](I,this,P)}),P.events.dispatch(new G.BuildStatusChangeEvent(this,this.buildStatus)))}},g("Building",me)}}}),System.register("game/gameobject/common/AnimTerrainEffect",["engine/type/ObjectType","game/map/TileCollection","game/type/LandType","game/gameobject/trait/TiberiumTrait"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("AnimTerrainEffect",class{destroyOre(g,P,L){if(P.landType===_.LandType.Tiberium&&(L.art.hasObject(g,I.ObjectType.Animation)?L.art.getAnimation(g):void 0)?.crater){let I=L.map.getObjectsOnTile(P).find(g=>g.isOverlay()&&g.isTiberium());if(I){var G=Math.ceil(U.TiberiumTrait.maxBails/2);G=g.startsWith("S_CLSN")?G:L.generateRandomInt(1,G);let P=I.traits.get(U.TiberiumTrait);P.removeBails(G),P.getBailCount()||L.unspawnObject(I)}}}spawnSmudges(g,P,U){if(P.landType===_.LandType.Clear&&0===P.rampType&&U.map.mapBounds.isWithinBounds(P)&&!U.map.getObjectsOnTile(P).find(g=>!g.isUnit())){var G=U.art.hasObject(g,I.ObjectType.Animation)?U.art.getAnimation(g):void 0;if(G?.crater){let g=G?.forceBigCraters?2:1,_=G?.scorch,V=[L.TileDirection.Bottom,L.TileDirection.BottomLeft,L.TileDirection.BottomRight].every(g=>U.map.tiles.getNeighbourTile(P,g));G=[...U.rules.smudgeRules.values()].filter(P=>(P.crater&&P.width===g&&P.height===g||_&&P.burn)&&!((1<P.width||1<P.height)&&!V)),G.length&&(G=G[U.generateRandomInt(0,G.length-1)].name,G=U.createObject(I.ObjectType.Smudge,G),U.spawnObject(G,P))}}}})}}}),System.register("game/gameobject/common/DeathType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("DeathType",I={}))[P.None=0]="None",P[P.Normal=1]="Normal",P[P.Demolish=2]="Demolish",P[P.Crush=3]="Crush",P[P.Temporal=4]="Temporal",P[P.Sink=5]="Sink"}}}),System.register("game/gameobject/Debris",["game/gameobject/GameObject","engine/type/ObjectType","game/gameobject/unit/ZoneType","game/Warhead","game/gameobject/unit/FacingUtil","game/gameobject/common/AnimTerrainEffect","game/gameobject/unit/CollisionHelper","game/gameobject/unit/CollisionType","game/math/Vector3","util/math","game/SpecialWarheadType"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g}],execute:function(){Q=class extends I.GameObject{static factory(g,P,I,L){return new this(g,P,I,L)}constructor(g,P,I,U){super(L.ObjectType.Debris,g,P,I),this.age=0,this.direction=0,this.rotationAxis=new K.Vector3,this.angularVelocity=0,this.zone=_.ZoneType.Air,this.velocity=new K.Vector3,this.collisionHelper=new W.CollisionHelper(U)}onSpawn(g){super.onSpawn(g),this.direction=g.generateRandomInt(0,359),this.xySpeed=q.lerp(0,this.rules.maxXYVel,g.generateRandom()),this.zSpeed=q.lerp(this.rules.minZVel,this.rules.maxZVel||1.5*this.rules.minZVel,g.generateRandom()),this.rotationAxis.set(g.generateRandom(),g.generateRandom(),g.generateRandom()).normalize(),this.angularVelocity=q.lerp(this.rules.minAngularVelocity,this.rules.maxAngularVelocity,g.generateRandom())}update(g){if(super.update(g),this.age++,this.rules.duration&&this.age>this.rules.duration)return this.velocity.set(0,0,0),void this.detonate(g);--this.zSpeed;var P=G.FacingUtil.toMapCoords(this.direction).setLength(this.xySpeed);let I=new K.Vector3(P.x,this.zSpeed,P.y);var L=this.position.clone();P=I.clone().add(this.position.worldPosition);if(g.map.isWithinHardBounds(P)){this.position.moveByLeptons3(I);let U=!1;var{type:P,target:L}=this.collisionHelper.checkCollisions(this.position,L,{cliffs:!0,ground:!0,shore:!1,walls:!0,units:!1});if(P&&(!([z.CollisionType.Ground,z.CollisionType.OnBridge].includes(P)&&0<this.rules.elasticity&&g.map.getTileZone(this.tile)!==_.ZoneType.Water)||Math.abs(this.zSpeed)<1?U=!0:(this.zSpeed=-this.zSpeed*this.rules.elasticity,this.velocity.y=-this.velocity.y*this.rules.elasticity,this.rotationAxis.negate())),U){if(this.velocity.set(0,0,0),L&&P===z.CollisionType.Wall){let g=L.position.worldPosition;this.position.moveByLeptons3(g.clone().sub(this.position.worldPosition))}this.detonate(g,P)}else this.velocity.copy(I)}else g.unspawnObject(this)}detonate(g,P=z.CollisionType.None){var I,L=this.rules.warhead?g.rules.getWarhead(this.rules.warhead):void 0,G=this.zone=this.collisionHelper.computeDetonationZone(this.tile,this.tileElevation,P);let W;G===_.ZoneType.Water?W=(I=g.rules.combatDamage.splashList)[0]:(I=this.rules.expireAnim)&&g.rules.animationNames.has(I)&&(W=I),this.explodeAnim=W;let K=new V.AnimTerrainEffect;if(W&&K.spawnSmudges(W,this.tile,g),g.destroyObject(this),L){new U.Warhead(L).detonate(g,this.rules.damage,this.tile,this.tileElevation,this.position.worldPosition,G,P,g.createTarget(void 0,this.tile),void 0,$.SpecialWarheadType.None,void 0,this.rules.damageRadius||void 0,!0)}}},g("Debris",Q)}}}),System.register("game/gameobject/GameObject",["engine/type/ObjectType","game/Traits","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyDestroy","util/math","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyUnspawn","game/gameobject/trait/interface/NotifyAttack","game/gameobject/common/DeathType"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g}],execute:function(){g("GameObject",class{get tile(){return this.position.tile}get tileElevation(){return this.position.tileElevation}constructor(g,P,I,_){this.traits=new L.Traits,this.cachedTraits={tick:[]},this.isCrashing=!1,this.isDestroyed=!1,this.deathType=q.DeathType.Normal,this.isDisposed=!1,this.isSpawned=!1,this.type=g,this.name=P,this.rules=I,this.art=_}getFoundation(){return{width:1,height:1}}isSmudge(){return this.type===I.ObjectType.Smudge}isOverlay(){return this.type===I.ObjectType.Overlay}isTerrain(){return this.type===I.ObjectType.Terrain}isProjectile(){return this.type===I.ObjectType.Projectile}isDebris(){return this.type===I.ObjectType.Debris}isBuilding(){return!1}isInfantry(){return!1}isVehicle(){return!1}isAircraft(){return!1}isUnit(){return!1}isTechno(){return!1}update(g){for(var P of this.cachedTraits.tick)P[_.NotifyTick.onTick](this,g)}onSpawn(g){this.isSpawned=!0,this.traits.filter(W.NotifySpawn).forEach(P=>{P[W.NotifySpawn.onSpawn](this,g)})}onUnspawn(g){this.isSpawned=!1,this.traits.filter(z.NotifyUnspawn).forEach(P=>{P[z.NotifyUnspawn.onUnspawn](this,g)})}onDestroy(g,P,I){this.traits.filter(U.NotifyDestroy).forEach(L=>{L[U.NotifyDestroy.onDestroy](this,g,P,I)})}onOwnerChange(g,P){this.traits.filter(V.NotifyOwnerChange).forEach(I=>{I[V.NotifyOwnerChange.onChange](this,g,P)})}onAttack(g,P){this.traits.filter(K.NotifyAttack).forEach(I=>{I[K.NotifyAttack.onAttack](this,P,g)})}addTrait(g){this.traits.add(g),g[_.NotifyTick.onTick]&&this.cachedTraits.tick.push(g)}getUiName(){return this.rules.uiName}getHash(){var g=this.position.worldPosition;return G.fnv32a([this.id,...new Uint8Array(new Float64Array([g.x,g.y,g.z]).buffer),...this.traits.getAll().map(g=>g.getHash?.()??0)])}debugGetState(){return{id:this.id,position:this.position.worldPosition.toArray(),traits:this.traits.getAll().reduce((g,P)=>{var I=P.debugGetState?.();return void 0!==I&&(g[P.constructor.name]=I),g},{})}}dispose(){this.isDisposed=!0,this.traits.dispose(),this.cachedTraits.tick.length=0}})}}}),System.register("game/gameobject/Infantry",["engine/type/ObjectType","game/gameobject/unit/ZoneType","game/gameobject/infantry/StanceType","game/gameobject/infantry/InfDeathType","game/gameobject/trait/MoveTrait","game/gameobject/trait/SuppressionTrait","game/gameobject/Techno","game/gameobject/trait/IdleActionTrait","game/gameobject/trait/CrashableTrait","game/gameobject/trait/AgentTrait","game/gameobject/unit/CrateBonuses"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g}],execute:function(){Q=class extends W.Techno{get isMoving(){return this.moveTrait.isMoving()}static factory(g,P,I,L){let _=new this(g,P,I);return _.moveTrait=new G.MoveTrait(_,L),_.traits.add(_.moveTrait),_.rules.crashable&&(_.crashableTrait=new K.CrashableTrait(_),_.traits.add(_.crashableTrait)),_.rules.fearless||(_.suppressionTrait=new V.SuppressionTrait,_.traits.add(_.suppressionTrait)),_.rules.agent&&(_.agentTrait=new q.AgentTrait,_.traits.add(_.agentTrait)),_.idleActionTrait=new z.IdleActionTrait,_.traits.add(_.idleActionTrait),_}constructor(g,P,G){super(I.ObjectType.Infantry,g,P,G),this.direction=0,this.onBridge=!1,this.zone=L.ZoneType.Ground,this._stance=_.StanceType.None,this.isFiring=!1,this.isPanicked=!1,this.infDeathType=U.InfDeathType.Gunfire,this.crateBonuses=new $.CrateBonuses}get stance(){return this._stance===_.StanceType.None&&this.suppressionTrait?.isSuppressed()?_.StanceType.Prone:this._stance}set stance(g){this._stance=g,this.moveTrait.setDisabled([_.StanceType.Deployed,_.StanceType.Cheer].includes(g)),this.attackTrait?.setDisabled([_.StanceType.Paradrop,_.StanceType.Cheer].includes(g))}isUnit(){return!0}isInfantry(){return!0}},g("Infantry",Q),Q.SUB_CELLS=[2,4,3]}}}),System.register("game/gameobject/infantry/InfDeathType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("InfDeathType",I={}))[P.None=0]="None",P[P.Gunfire=1]="Gunfire",P[P.Explode=2]="Explode",P[P.ExplodeAlt=3]="ExplodeAlt",P[P.Fire=4]="Fire",P[P.Electro=5]="Electro",P[P.HeadExplode=6]="HeadExplode",P[P.Nuke=7]="Nuke"}}}),System.register("game/gameobject/infantry/sequenceMap",["game/gameobject/unit/ZoneType","game/art/SequenceType","game/gameobject/infantry/StanceType","game/gameobject/infantry/InfDeathType"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("getFireSequenceBy",G=(g,P=_.StanceType.None)=>P===_.StanceType.Deployed?L.SequenceType.DeployedFire:g===I.ZoneType.Water?L.SequenceType.WetAttack:g===I.ZoneType.Air?L.SequenceType.FireFly:P===_.StanceType.Prone?L.SequenceType.FireProne:L.SequenceType.FireUp),g("getMoveSequenceBy",V=(g,P,U)=>g===I.ZoneType.Air?L.SequenceType.Fly:g===I.ZoneType.Water?L.SequenceType.Swim:P===_.StanceType.Prone?L.SequenceType.Crawl:U?L.SequenceType.Panic:L.SequenceType.Walk),g("getIdleSequenceBy",(g,P=_.StanceType.None)=>P===_.StanceType.Deployed?[L.SequenceType.DeployedIdle]:g===I.ZoneType.Water?[L.SequenceType.WetIdle1,L.SequenceType.WetIdle2]:g!==I.ZoneType.Air?[L.SequenceType.Idle1,L.SequenceType.Idle2]:void 0),g("getStillSequenceBy",W=(g,P=_.StanceType.None)=>P===_.StanceType.Deployed?L.SequenceType.Deployed:g===I.ZoneType.Water?L.SequenceType.Tread:g===I.ZoneType.Air?L.SequenceType.Hover:P===_.StanceType.Prone?L.SequenceType.Prone:P===_.StanceType.Guard?L.SequenceType.Guard:P===_.StanceType.Paradrop?L.SequenceType.Paradrop:L.SequenceType.Ready),g("getStanceTransitionSequenceBy",(g,P)=>g===_.StanceType.Prone?L.SequenceType.Up:P===_.StanceType.Prone?L.SequenceType.Down:g===_.StanceType.Deployed?L.SequenceType.Undeploy:P===_.StanceType.Deployed?L.SequenceType.Deploy:P===_.StanceType.Cheer?L.SequenceType.Cheer:void 0),g("getCrashingSequences",g=>{let P=[...g.art.sequences.keys()];var I=[L.SequenceType.AirDeathStart,L.SequenceType.AirDeathFalling].filter(g=>P.includes(g));if(I.length)return I}),g("getDeathSequence",(g,P)=>{var _=g.zone,G=g.rules.isHuman;let V,W=[...g.art.sequences.keys()];return g.isCrashing?V=[L.SequenceType.AirDeathFinish]:_===I.ZoneType.Air?V=[L.SequenceType.Tumble]:_===I.ZoneType.Water?![U.InfDeathType.Gunfire,U.InfDeathType.Explode].includes(P)&&G||(V=[L.SequenceType.WetDie1,L.SequenceType.WetDie2]):P!==U.InfDeathType.Gunfire&&G?P===U.InfDeathType.Explode&&(V=[L.SequenceType.Die2]):V=[L.SequenceType.Die1],V&&(V=V.filter(g=>W.includes(g)),V.length||(V=void 0)),V}),g("getDeathAnim",(g,P)=>P===U.InfDeathType.ExplodeAlt?g.audioVisual.infantryExplode:P===U.InfDeathType.Fire?g.audioVisual.flamingInfantry:P===U.InfDeathType.Electro?[...g.animationNames][1]:P===U.InfDeathType.HeadExplode?g.audioVisual.infantryHeadPop:P===U.InfDeathType.Nuke?g.audioVisual.infantryNuked:void 0),g("findSequence",(g,P,L,U,z,K)=>{var n=g=>-1!==K.indexOf(g);let q;return U&&(q=G(g,P),n(q)||(q=G(g),n(q)||(q=void 0))),void 0===q&&L&&(q=V(g,P,z),n(q)||(q=V(g,_.StanceType.None,z),n(q)||(q=void 0))),void 0===q&&(q=W(g,P),n(q)||(q=W(g),n(q)||(q=W(I.ZoneType.Ground)))),q})}}}),System.register("game/gameobject/infantry/StanceType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("StanceType",I={}))[P.None=0]="None",P[P.Guard=1]="Guard",P[P.Prone=2]="Prone",P[P.Deployed=3]="Deployed",P[P.Paradrop=4]="Paradrop",P[P.Cheer=5]="Cheer"}}}),System.register("game/gameobject/locomotor/ChronoLocomotor",["game/math/Vector2","game/math/Vector3"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("ChronoLocomotor",class{constructor(g){this.game=g,this.ignoresTerrain=!0,this.distanceToWaypoint=new I.Vector2}onNewWaypoint(g,P){}tick(g,P,I,_){if(_)return{distance:new L.Vector3,done:!0};this.distanceToWaypoint.copy(P).sub(g.position.getMapPosition());var U,G=this.game.rules.general;return G.chronoTrigger&&(G=(U=this.distanceToWaypoint.length())<G.chronoRangeMinimum?G.chronoMinimumDelay:U/G.chronoDistanceFactor,g.warpedOutTrait.setTimed(G,!1,this.game)),{distance:new L.Vector3(this.distanceToWaypoint.x,0,this.distanceToWaypoint.y),done:!0,isTeleport:!0}}})}}}),System.register("game/gameobject/locomotor/DriveLocomotor",["game/gameobject/unit/FacingUtil","game/gameobject/task/TurnTask","game/Coords","game/math/geometry","game/math/Vector2","game/math/Vector3","game/math/CurvePath","game/math/LineCurve","game/math/QuadraticBezierCurve","util/math"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g}],execute:function(){var P;(P=$=$||{})[P.None=0]="None",P[P.Start=1]="Start",P[P.Normal=2]="Normal",P[P.End=3]="End",P[P.Single=4]="Single",g("DriveLocomotor",class{constructor(g){this.game=g,this.hasMomentum=!1,this.moveOnCurve=!1,this.currentSpeed=0,this.distanceTravelled=0,this.carryOverDistance=0,this.currentWaypointType=$.None}selectNextWaypoint(g,P){if(this.currentWaypointType=this.currentWaypointType&&this.currentWaypointType!==$.End?$.Normal:$.Start,this.initialPosition=g.position.getMapPosition(),this.currentWaypointType!==$.Start?g.moveTrait.speedPenalty=0:this.currentSpeed=0,1<P.length){var L=P[P.length-1],V=P[P.length-2],q=new G.Vector2(L.tile.rx-g.tile.rx,L.tile.ry-g.tile.ry),Q=Math.abs(U.angleDegFromVec2(q)-U.angleDegFromVec2(new G.Vector2(V.tile.rx-L.tile.rx,V.tile.ry-L.tile.ry)));if(!Math.abs(I.FacingUtil.fromMapCoords(q)-g.direction)&&0<Q&&Q<90&&this.hasMomentum){this.moveOnCurve=!0,this.currentWaypointType=2===P.length?this.currentWaypointType===$.Start?$.Single:$.End:$.Normal;let g=this.initialPosition;q=new G.Vector2(L.tile.rx+.5,L.tile.ry+.5).multiplyScalar(_.Coords.LEPTONS_PER_TILE);let I=new G.Vector2(V.tile.rx+.5,V.tile.ry+.5).multiplyScalar(_.Coords.LEPTONS_PER_TILE);return Q=g.clone().lerp(q,.5),L=I.clone().lerp(q,.5),this.steerCurve=new W.CurvePath,this.steerCurve.add(new z.LineCurve(g,Q)),this.steerCurve.add(new K.QuadraticBezierCurve(Q,q,L)),this.steerCurve.add(new z.LineCurve(L,I)),this.lastPosition=g,V}}else this.currentWaypointType=this.currentWaypointType===$.Start?$.Single:$.End;return this.hasMomentum=!0,this.moveOnCurve=!1,P[P.length-1]}onNewWaypoint(g,P,_){let U=(new G.Vector2).copy(P).sub(this.initialPosition);this.distanceTravelled=0,this.totalDistanceToTravel=this.moveOnCurve?this.steerCurve.getLength():U.length();var V=I.FacingUtil.fromMapCoords(U);if(V!==g.direction&&(this.pointTurretToTarget(g,_),!this.moveOnCurve))return g.moveTrait.velocity.set(0,0,0),[new L.TurnTask(V)]}tick(g,P,L){this.pointTurretToTarget(g,L);let U=this.currentSpeed;U=g.rules.accelerates?($=this.distanceTravelled/this.totalDistanceToTravel,this.currentSpeed=this.applyAcceleration(g,U,g.moveTrait.baseSpeed,$)):this.currentSpeed=g.moveTrait.baseSpeed,1<U&&(U=Math.floor(U));let W=this.game.map.terrain.getPassableSpeed(g.tile,g.rules.speedType,g.isInfantry(),g.onBridge,void 0,!0);W?g.moveTrait.lastTileSpeed=W:W=g.moveTrait.lastTileSpeed||1,U*=W,1<U&&(U=Math.floor(U)),this.carryOverDistance&&(U=this.carryOverDistance);var z=g.position.getMapPosition();let K;if(this.moveOnCurve){var q=this.steerCurve.getLength(),$=Math.min(this.distanceTravelled+U,q);this.carryOverDistance=Math.max(0,this.distanceTravelled+U-q),this.distanceTravelled=$;let P=this.steerCurve.getPointAt(this.distanceTravelled/q),L=this.steerCurve.getTangentAt(this.distanceTravelled/q);$=L.clone().setLength(U),g.moveTrait.velocity.set($.x,0,$.y);q=g.rules.rot;var{facing:$,delta:q}=I.FacingUtil.tick(g.direction,I.FacingUtil.fromMapCoords(L),q);g.direction=$,g.spinVelocity=q,q=this.lastPosition,this.lastPosition=P.clone(),K=P.sub(q)}else{let I=(new G.Vector2).copy(P).sub(z);z=Math.min(I.length(),U),K=I.clone().setLength(z);let L=K.clone();this.carryOverDistance&&L.add(_.Coords.vecWorldToGround(g.moveTrait.velocity)),g.moveTrait.velocity.set(L.x,0,L.y),this.distanceTravelled+=z,this.carryOverDistance=Math.max(0,U-I.length())}return{distance:new V.Vector3(K.x,0,K.y),done:!K.length()||!!this.carryOverDistance}}pointTurretToTarget(g,P){if(g.turretTrait){g.attackTrait?.currentTarget?.obj&&(P=g.attackTrait.currentTarget.obj.position.getMapPosition());var L=g.position.getMapPosition();let _=(new G.Vector2).copy(P).sub(L);_.length()&&(L=I.FacingUtil.fromMapCoords(_),g.turretTrait.desiredFacing=L)}}applyAcceleration(g,P,I,L){return this.currentWaypointType===$.Single?I/2:this.currentWaypointType!==$.End?Math.min(P+g.rules.accelerationFactor*I,I):(this.moveOnCurve&&this.currentWaypointType===$.End&&(L=L<=.5?0:2*(L-.5)),q.lerp(1,I,1-L))}})}}}),System.register("game/gameobject/locomotor/FootLocomotor",["game/gameobject/unit/FacingUtil","game/gameobject/infantry/StanceType","game/math/Vector2","game/math/Vector3"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("FootLocomotor",class{constructor(g){this.game=g,this.currentMoveDirection=new _.Vector2,this.distanceToWaypoint=new _.Vector2,this.endPauseFrames=0}onNewWaypoint(g,P){this.currentMoveDirection.copy(P).sub(g.position.getMapPosition());var L=I.FacingUtil.fromMapCoords(this.currentMoveDirection);L!==g.direction&&(g.direction=L),this.endPauseFrames=1}onWaypointUpdate(g,P){this.onNewWaypoint(g,P)}tick(g,P,I){let _=g.moveTrait.baseSpeed;_=Math.floor(_),g.stance===L.StanceType.Prone&&(_*=g.art.crawls?.5:2),g.isPanicked&&(_*=2);let G=this.game.map.terrain.getPassableSpeed(g.tile,g.rules.speedType,g.isInfantry(),g.onBridge,void 0,!0);G?g.moveTrait.lastTileSpeed=G:G=g.moveTrait.lastTileSpeed||1,_*=G,_=Math.floor(_),this.distanceToWaypoint.copy(P).sub(g.position.getMapPosition());let V=this.distanceToWaypoint.clone().setLength(_);(V.length()||P.equals(I))&&g.moveTrait.velocity.set(V.x,0,V.y);var W=Math.min(this.distanceToWaypoint.length(),_),z=!W&&0<this.endPauseFrames--;return this.distanceToWaypoint.setLength(W),{distance:new U.Vector3(this.distanceToWaypoint.x,0,this.distanceToWaypoint.y),done:!this.distanceToWaypoint.length()&&!z}}})}}}),System.register("game/gameobject/locomotor/HoverLocomotor",["game/Coords","game/gameobject/unit/FacingUtil","game/GameSpeed","game/math/geometry","game/math/Vector2","game/math/Vector3"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){var P;(P=W=W||{})[P.None=0]="None",P[P.Start=1]="Start",P[P.Normal=2]="Normal",P[P.End=3]="End",P[P.Single=4]="Single",g("HoverLocomotor",class{constructor(g){this.hoverRules=g,this.currentSpeed=0,this.distanceTravelled=0,this.carryOverDistance=0,this.currentWaypointType=W.None,this.nextWaypointDir=new G.Vector2}selectNextWaypoint(g,P){var I,L;return this.currentWaypointType=this.currentWaypointType&&this.currentWaypointType!==W.End?W.Normal:W.Start,this.initialPosition=g.position.getMapPosition(),this.currentWaypointType===W.Start&&(this.currentSpeed=0),P.length<=1?(this.currentWaypointType=this.currentWaypointType===W.Start?W.Single:W.End,(L=P[P.length-1])&&this.nextWaypointDir.set(L.tile.rx-g.tile.rx,L.tile.ry-g.tile.ry)):(I=P[P.length-1],L=P[P.length-2],this.nextWaypointDir.set(L.tile.rx-I.tile.rx,L.tile.ry-I.tile.ry)),P[P.length-1]}onNewWaypoint(g,P,I){let L=(new G.Vector2).copy(P).sub(this.initialPosition);this.distanceTravelled=0,this.totalDistanceToTravel=L.length();var U=this.maxSpeed=g.moveTrait.baseSpeed,V=60*this.hoverRules.acceleration*_.GameSpeed.BASE_TICKS_PER_SECOND;this.acceleration=U/V,V=60*this.hoverRules.brake*_.GameSpeed.BASE_TICKS_PER_SECOND,this.deceleration=U/V}tick(g,P){var _=g.position.getMapPosition();let G=P.clone().sub(_);var z=G.length();_=this.maxSpeed;this.currentWaypointType===W.Single?this.currentSpeed=_/2:this.currentWaypointType===W.End?(K=this.computeBrakeDistance(this.currentSpeed,this.deceleration),this.totalDistanceToTravel-this.distanceTravelled<=K&&(this.currentSpeed=Math.max(1,this.currentSpeed-this.deceleration))):this.currentSpeed=Math.min(this.currentSpeed+this.acceleration,_);var K=L.FacingUtil.fromMapCoords(G);_=L.FacingUtil.fromMapCoords(this.nextWaypointDir);let q=K,$=g.rules.rot;this.currentWaypointType===W.Normal&&K!==_&&(K=(Q=U.angleDegBetweenVec2(this.nextWaypointDir,L.FacingUtil.toMapCoords(g.direction)))/$,K=Math.max(this.currentSpeed*K,this.totalDistanceToTravel),this.totalDistanceToTravel-this.distanceTravelled<=K&&(q=_,$=Q/((this.totalDistanceToTravel-this.distanceTravelled)/this.currentSpeed)));var Q=L.FacingUtil.tick(g.direction,q,$).facing;g.direction=Q;let Y=this.currentSpeed;this.carryOverDistance&&(Y=this.carryOverDistance),Q=Math.min(Y,z);let Z=G.clone().setLength(Q),X=Z.clone();return this.carryOverDistance&&X.add(I.Coords.vecWorldToGround(g.moveTrait.velocity)),g.moveTrait.velocity.set(X.x,0,X.y),this.distanceTravelled+=Q,this.carryOverDistance=Math.max(0,Y-z),{distance:new V.Vector3(Z.x,0,Z.y),done:!Z.length()||!!this.carryOverDistance}}computeBrakeDistance(g,P){var I=g/P;return Math.max(0,g*I-P*I*I/2)}})}}}),System.register("game/gameobject/locomotor/JumpjetLocomotor",["game/Coords","game/gameobject/unit/FacingUtil","game/gameobject/unit/TargetUtil","util/geometry","game/gameobject/unit/ZoneType","game/event/ObjectLiftOffEvent","game/event/ObjectLandEvent","game/type/SpeedType","game/gameobject/infantry/StanceType","game/math/Vector2","game/math/Vector3"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g}],execute:function(){g("JumpjetLocomotor",class{static tickStationary(g,P){if(g.zone===G.ZoneType.Air){var L=g.tile.onBridgeLandType?P.map.tileOccupation.getBridgeOnTile(g.tile):void 0,_=!g.rules.balloonHover&&(!g.unitOrderTrait.getCurrentTask()?.preventLanding||!g.rules.hoverAttack)&&(P.map.getGroundObjectsOnTile(g.tile).find(P=>P.isBuilding()&&P.dockTrait?.isDocked(g))||P.map.getTileZone(g.tile)!==G.ZoneType.Water&&0<P.map.terrain.getPassableSpeed(g.tile,z.SpeedType.Foot,!0,!!g.tile.onBridgeLandType)&&0===P.map.terrain.findObstacles({tile:g.tile,onBridge:L},g).length);let Q;Q=_?(U=g.tile.z+(L?.tileElevation??0),I.Coords.tileHeightToWorld(U)):(V=g.tile.z+P.map.getGroundObjectsOnTile(g.tile).filter(g=>!(g.isInfantry()&&g.stance===K.StanceType.Paradrop)).reduce((g,P)=>Math.max(g,P.tileElevation+P.art.height),0),I.Coords.tileHeightToWorld(V)+g.rules.jumpjetHeight);var U,V,q=g.position.worldPosition.y;Q!==q?(U=g.rules.jumpjetClimb,V=Math.abs(Q-q),U=Math.sign(Q-q)*Math.min(U,V),V=g.tileElevation,g.position.moveByLeptons3(new $.Vector3(0,U,0)),g.moveTrait.handleElevationChange(V,P)):_&&(g.zone=G.ZoneType.Ground,g.onBridge=!!L,P.events.dispatch(new W.ObjectLandEvent(g)),(L=P.map.tileOccupation.getGroundObjectsOnTile(g.tile).find(g=>g.isOverlay()&&g.rules.crate))&&P.crateGeneratorTrait.pickupCrate(g,L,P))}}static tickCrash(g,P,I){var L=2*g.rules.jumpjetCrash;return g.direction=(g.direction-6+360)%360,new $.Vector3(0,-L,0)}constructor(g){this.game=g,this.allowOutOfBounds=!0,this.currentMoveDir=new q.Vector2,this.currentHorizSpeed=0}onNewWaypoint(g,P,I){this.currentMoveDir=L.FacingUtil.toMapCoords(g.direction),this.cancelDestLeptons=void 0}tick(g,P,W,z){if(g.zone!==G.ZoneType.Air&&(g.onBridge=!1,g.zone=G.ZoneType.Air,this.game.events.dispatch(new V.ObjectLiftOffEvent(g))),z){if(!this.cancelDestLeptons){let P=g.tile;this.game.map.isWithinBounds(P)||(P=this.game.map.clampWithinBounds(P)),this.cancelDestLeptons=this.computeCancelDest(P,W)}W=this.cancelDestLeptons}var q=g.position.getMapPosition();let Q=W.clone().sub(q);var Y=this.findTilesToCheckForBlockers(g.tile,q,this.currentMoveDir,Q.length()).map(g=>g.z+this.game.map.getGroundObjectsOnTile(g).filter(g=>!(g.isDestroyed||g.isInfantry()&&g.stance===K.StanceType.Paradrop)).reduce((g,P)=>Math.max(g,P.tileElevation+P.art.height),0)).reduce((g,P)=>Math.max(g,P),0);let Z=0;(void 0===this.lastClearZ||2<Y-this.lastClearZ)&&(Z=4);var X,J=I.Coords.tileHeightToWorld(Y),ee=I.Coords.tileHeightToWorld(Y+Z),te=g.position.worldPosition.y,re=L.FacingUtil.fromMapCoords(Q),se=Q.length()<g.rules.jumpjetSpeed;let ae=0;J<=te&&!se&&(({facing:he,delta:X}=L.FacingUtil.tick(g.direction,re,g.rules.jumpjetTurnRate)),ae=X,g.direction=he,this.currentMoveDir.copy(L.FacingUtil.toMapCoords(g.direction))),g.isVehicle()&&(g.spinVelocity=ae);let ne,oe=!1,le=0,ce=0;var he=g.rules.jumpjetClimb;let ue;te<ee?(le=Math.min(he,ee-te),ne=!1,this.currentHorizSpeed=0):(this.lastClearZ=Y,ne=!0,(Y=J+g.rules.jumpjetHeight)!==te&&(J=Math.abs(Y-te),le=Math.sign(Y-te)*Math.min(he,J),ne=J<=he),he=this.currentHorizSpeed,this.currentHorizSpeed=Math.min(this.currentHorizSpeed+2,g.rules.jumpjetSpeed),oe=re===g.direction?(ce=Math.min(he,Q.length()),he>=Q.length()):((q=he||ae?_.TargetUtil.computeTurnCircle(q,this.currentMoveDir,Math.sign(ae)*g.rules.jumpjetTurnRate,he):void 0)&&U.circleContainsPoint(q,W)?(ce=0,this.currentHorizSpeed=0):ce=he,!1)),ue=se?(oe=!0,Q):this.currentMoveDir.clone().setLength(ce);let de=new $.Vector3(ue.x,le,ue.y);return se=de.clone(),g.moveTrait.velocity.copy(se),{distance:de,done:oe&&ne}}findTilesToCheckForBlockers(g,P,L,_){var U=L.clone().setLength(Math.min(_,I.Coords.LEPTONS_PER_TILE)).add(P).multiplyScalar(1/I.Coords.LEPTONS_PER_TILE).floor(),G=this.game.map.tiles.getByMapCoords(U.x,U.y);if(!G||G===g)return[g];U=Math.sign(G.rx-g.rx),G=Math.sign(G.ry-g.ry);let V,W=[g];return U&&(V=this.game.map.tiles.getByMapCoords(g.rx+U,g.ry),V&&W.push(V)),G&&(V=this.game.map.tiles.getByMapCoords(g.rx,g.ry+G),V&&W.push(V)),U&&G&&(V=this.game.map.tiles.getByMapCoords(g.rx+U,g.ry+G),V&&W.push(V)),W}computeCancelDest(g,P){var L=P.clone().multiplyScalar(1/I.Coords.LEPTONS_PER_TILE).floor().multiplyScalar(I.Coords.LEPTONS_PER_TILE);L=P.clone().sub(L);return new q.Vector2(g.rx,g.ry).multiplyScalar(I.Coords.LEPTONS_PER_TILE).add(L)}})}}}),System.register("game/gameobject/locomotor/Locomotor",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("game/gameobject/locomotor/LocomotorFactory",["game/type/LocomotorType","game/gameobject/locomotor/ChronoLocomotor","game/gameobject/locomotor/DriveLocomotor","game/gameobject/locomotor/FootLocomotor","game/gameobject/locomotor/HoverLocomotor","game/gameobject/locomotor/JumpjetLocomotor","game/gameobject/locomotor/MissileLocomotor","game/gameobject/locomotor/WingedLocomotor"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g}],execute:function(){g("LocomotorFactory",class{constructor(g){this.game=g}create(g){var P=g.rules.locomotor;switch(P){case I.LocomotorType.Infantry:return new U.FootLocomotor(this.game);case I.LocomotorType.Jumpjet:return new V.JumpjetLocomotor(this.game);case I.LocomotorType.Vehicle:case I.LocomotorType.Ship:return new _.DriveLocomotor(this.game);case I.LocomotorType.Chrono:return g.isVehicle()&&g.harvesterTrait&&g.rules.teleporter?new _.DriveLocomotor(this.game):new L.ChronoLocomotor(this.game);case I.LocomotorType.Aircraft:return new z.WingedLocomotor(this.game);case I.LocomotorType.Missile:return new W.MissileLocomotor(this.game,this.game.rules.general.getMissileRules(g.name));case I.LocomotorType.Hover:return new G.HoverLocomotor(this.game.rules.general.hover);default:throw new Error("Unhandled locomotor type "+P)}}})}}}),System.register("game/gameobject/locomotor/MissileLocomotor",["game/Coords","game/gameobject/unit/ZoneType","game/event/ObjectLiftOffEvent","game/math/geometry","game/gameobject/unit/FacingUtil","game/math/Vector3","game/math/Vector2","game/math/CubicBezierCurve3","game/math/GameMath"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g}],execute:function(){var P;(P=q=q||{})[P.Boost=0]="Boost",P[P.Midcourse=1]="Midcourse",P[P.Terminal=2]="Terminal",g("MissileLocomotor",class{constructor(g,P){this.game=g,this.missileRules=P,this.flightPhase=q.Boost}selectNextWaypoint(g,P){var L=P[P.length-1],_=this.game.map.tileOccupation.getBridgeOnTile(L.tile);_=L.tile.z+(_?.tileElevation??0);return this.targetPosition=I.Coords.tile3dToWorld(L.tile.rx+.5,L.tile.ry+.5,_),this.cruiseAltitude=I.Coords.tileHeightToWorld(_)+this.missileRules.altitude,L}onNewWaypoint(g,P,I){}tick(g,P,$){let Q,Y=g.position.worldPosition.clone(),Z=this.targetPosition.clone().sub(Y);var X;g.zone!==L.ZoneType.Air&&(g.onBridge=!1,g.zone=L.ZoneType.Air,this.game.events.dispatch(new _.ObjectLiftOffEvent(g))),Q=this.currentVelocity?(X=g.rules.speed,Math.min(this.currentVelocity.length()+this.missileRules.acceleration,X)):(ne=this.missileRules.acceleration,this.missileRules.lazyCurve?this.currentVelocity=new V.Vector3(Z.x,0,Z.z):this.currentVelocity=I.Coords.vecGroundToWorld(G.FacingUtil.toMapCoords(g.direction)),U.rotateVec3Towards(this.currentVelocity,new V.Vector3(this.currentVelocity.x,1e8,this.currentVelocity.z),g.pitch),ne),this.currentVelocity.setLength(Q);let J=!1;switch(this.flightPhase){case q.Boost:if(!(g.position.worldPosition.y>=this.cruiseAltitude)){J=!1;break}this.flightPhase=q.Midcourse;case q.Midcourse:var ee,te=new W.Vector2(Z.x,Z.z).length();if(!this.missileRules.lazyCurve){U.rotateVec3Towards(this.currentVelocity,new V.Vector3(this.currentVelocity.x,0,this.currentVelocity.z),g.rules.rot),this.currentVelocity.y<1&&(ee=this.currentVelocity.length(),this.currentVelocity.y=0,this.currentVelocity.setLength(ee)),U.rotateVec3Towards(this.currentVelocity,new V.Vector3(Z.x,this.currentVelocity.y,Z.z),g.rules.rot),g.direction=G.FacingUtil.fromMapCoords(I.Coords.vecWorldToGround(this.currentVelocity)),g.pitch=Math.sign(this.currentVelocity.y)*U.angleDegBetweenVec3(this.currentVelocity,new V.Vector3(this.currentVelocity.x,0,this.currentVelocity.z)),te/(Y.y-this.targetPosition.y)<1&&(this.flightPhase=q.Terminal);break}this.flightPhase=q.Terminal;var re=Y.clone().add(this.currentVelocity.clone().setLength(te/3/K.GameMath.cos(U.degToRad(g.pitch)))),se=this.targetPosition.clone().lerp(Y,.15).setY(re.y);this.descentCurve=new z.CubicBezierCurve3(Y,re,se,this.targetPosition);case q.Terminal:if(re=this.missileRules.bodyLength,this.missileRules.lazyCurve){var ae=this.descentCurve.getLength();this.descentTravelled??(this.descentTravelled=0),this.descentTravelled+=Math.min(Q,ae-re-this.descentTravelled),se=this.descentTravelled/ae;let P=this.descentCurve.getPointAt(se),I=this.descentCurve.getTangentAt(se);this.currentVelocity.copy(P.sub(Y)),se=I.clone().setY(0),g.pitch=Math.sign(I.y-se.y)*U.angleDegBetweenVec3(se,I),J=1<=(this.descentTravelled+re)/ae}else U.rotateVec3Towards(this.currentVelocity,Z,g.rules.rot),g.direction=G.FacingUtil.fromMapCoords(I.Coords.vecWorldToGround(this.currentVelocity)),g.pitch=Math.sign(this.currentVelocity.y)*U.angleDegBetweenVec3(this.currentVelocity,new V.Vector3(this.currentVelocity.x,0,this.currentVelocity.z)),((ae=Z.length()-re)<Q||ae<1)&&(this.currentVelocity.copy(Z.clone().addScalar(-re)),J=!0);break;default:throw new Error(`Unhandled flight phase "${this.flightPhase}"`)}var ne=Y.clone().add(this.currentVelocity);return this.game.map.isWithinHardBounds(ne)?(g.moveTrait.velocity.copy(this.currentVelocity),{distance:this.currentVelocity,done:J}):(this.game.destroyObject(g),{done:!0,distance:new V.Vector3})}})}}}),System.register("game/gameobject/locomotor/WingedLocomotor",["game/Coords","game/gameobject/unit/FacingUtil","game/gameobject/unit/TargetUtil","util/geometry","game/gameobject/unit/ZoneType","game/event/ObjectLiftOffEvent","game/event/ObjectLandEvent","game/type/SpeedType","game/gameobject/task/MoveToDockTask","game/gameobject/trait/interface/NotifyTick","game/math/Vector2","game/math/Vector3","util/math","game/math/GameMath"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g}],execute:function(){var P;(P=X=X||{})[P.None=0]="None",P[P.CircleStrafe=1]="CircleStrafe",P[P.HoverStrafe=2]="HoverStrafe",g("WingedLocomotor",class{static tickStationary(g,P){if(g.zone===G.ZoneType.Air){var _=g.tile.onBridgeLandType?P.map.tileOccupation.getBridgeOnTile(g.tile):void 0;let Z,X=g.rules.landable&&!g.unitOrderTrait.getCurrentTask()?.preventLanding,J=g.spawnLinkTrait?.getParent();if(X&&J?X=!((!J.isUnit()||!J.onBridge)&&_||J.tile!==g.tile):X&&!g.airportBoundTrait&&(X=P.map.getTileZone(g.tile)!==G.ZoneType.Water&&0<P.map.terrain.getPassableSpeed(g.tile,z.SpeedType.Foot,!0,!!g.tile.onBridgeLandType)&&0===P.map.terrain.findObstacles({tile:g.tile,onBridge:_},g).length),X){let G=g.airportBoundTrait?.preferredAirport?.dockTrait;var U=G?.isDocked(g)||G?.hasReservedDockForUnit(g);if(!g.airportBoundTrait||U){var V=U?0:270;if(g.direction!==V)return void(g.direction=L.FacingUtil.tick(g.direction,V,g.rules.rot).facing)}if(g.airportBoundTrait){let I=g.airportBoundTrait.preferredAirport;if(!I?.dockTrait?.isDocked(g))return I?.dockTrait?.getAvailableDockCount()||(I=g.airportBoundTrait.findAvailableAirport(g),g.airportBoundTrait.preferredAirport=I,I&&(V=I.dockTrait.getFirstAvailableDockNumber(),I.dockTrait.reserveDockAt(g,V))),void(I?(g.unitOrderTrait.addTask(new K.MoveToDockTask(P,I)),g.unitOrderTrait[q.NotifyTick.onTick](g,P)):g.crashableTrait.crash(void 0))}let W;W=J?J.tile.z+J.tileElevation:g.tile.z+(_?.tileElevation??0),Z=I.Coords.tileHeightToWorld(W)}else{var $=g.tile.z+(_?.tileElevation??0),Y=g.rules.flightLevel??P.rules.general.flightLevel;Z=I.Coords.tileHeightToWorld($)+Y}Z!==($=g.position.worldPosition.y)?(Y=Math.abs(Z-$),$=Math.sign(Z-$)*Math.min(30,Y),Y=g.tileElevation,g.position.moveByLeptons3(new Q.Vector3(0,$,0)),g.moveTrait.handleElevationChange(Y,P)):X&&(g.zone=G.ZoneType.Ground,J?J.airSpawnTrait.storeAircraft(g,P):g.onBridge=!!_,P.events.dispatch(new W.ObjectLandEvent(g)),(_=P.map.tileOccupation.getGroundObjectsOnTile(g.tile).find(g=>g.isOverlay()&&g.rules.crate))&&P.crateGeneratorTrait.pickupCrate(g,_,P))}}static tickCrash(g,P,L){L.rollDelta??(L.rollDelta=P.generateRandomInt(-15,15)),L.pitchDelta??(L.pitchDelta=P.generateRandomInt(0,15)),g.roll+=L.rollDelta,g.pitch+=L.pitchDelta;var _=I.Coords.vecWorldToGround(g.moveTrait.velocity);return new Q.Vector3(_.x,-30,_.y)}constructor(g){this.game=g,this.allowOutOfBounds=!0,this.lastDestLeptons=new $.Vector2,this.currentMoveDir=new $.Vector2,this.currentHorizSpeed=0,this.maneuverType=X.None,this.deceleratingToTurn=!1}onNewWaypoint(g,P,L){this.currentHorizSpeed=I.Coords.vecWorldToGround(g.moveTrait.velocity).length(),this.cancelDestLeptons=void 0}tick(g,P,W,z){if(z){if(!this.cancelDestLeptons){let P=g.tile;this.game.map.isWithinBounds(P)||(P=this.game.map.clampWithinBounds(P)),this.cancelDestLeptons=this.computeCancelDest(P,W)}W=this.cancelDestLeptons}var K=g.position.getMapPosition();let q=W.clone().sub(K);var $=q.length();this.lastDestLeptons.equals(W)||(this.lastDestLeptons.copy(W),z?this.maneuverType=X.HoverStrafe:g.zone===G.ZoneType.Air&&this.currentHorizSpeed<5?this.maneuverType=$>I.Coords.LEPTONS_PER_TILE?X.CircleStrafe:X.HoverStrafe:this.maneuverType=X.None,this.deceleratingToTurn=!1),g.zone!==G.ZoneType.Air&&(g.onBridge=!1,g.zone=G.ZoneType.Air,this.game.events.dispatch(new V.ObjectLiftOffEvent(g)));var J=g.tile.onBridgeLandType?this.game.map.tileOccupation.getBridgeOnTile(g.tile):void 0,ee=g.tile.z+(J?.tileElevation??0),te=g.rules.flightLevel??this.game.rules.general.flightLevel,re=I.Coords.tileHeightToWorld(ee)+te,se=(J=g.position.worldPosition.y,L.FacingUtil.fromMapCoords(q));let ae;switch(g.direction===se&&this.maneuverType===X.None&&$<=I.Coords.LEPTONS_PER_TILE?this.maneuverType=X.HoverStrafe:g.direction===se&&this.maneuverType===X.CircleStrafe&&(this.maneuverType=X.None),this.maneuverType){case X.HoverStrafe:if(g.attackTrait?.currentTarget){let P=I.Coords.vecWorldToGround(g.attackTrait.currentTarget.getWorldCoords());ae=L.FacingUtil.fromMapCoords(P.sub(K))}else ae=g.airportBoundTrait?.preferredAirport?.dockTrait?.hasReservedDockForUnit(g)?0:270;break;case X.CircleStrafe:case X.None:ae=se;break;default:throw new Error('Unknown maneuver type "'+this.maneuverType)}var{facing:ne,delta:oe}=L.FacingUtil.tick(g.direction,ae,g.rules.rot);let le;switch(g.direction=ne,g.roll=Math.sign(oe)*g.rules.pitchAngle,this.maneuverType){case X.HoverStrafe:le=se;break;case X.CircleStrafe:le=(ne-90*Math.sign(oe)+360)%360;break;case X.None:le=ne;break;default:throw new Error('Unknown maneuver type "'+this.maneuverType)}void 0===this.thrustFacing&&(this.thrustFacing=le);ee=5<this.currentHorizSpeed?g.rules.rot:Number.POSITIVE_INFINITY;var{facing:te,delta:ee}=L.FacingUtil.tick(this.thrustFacing,le,ee);this.thrustFacing=te,this.currentMoveDir.copy(L.FacingUtil.toMapCoords(this.thrustFacing));let ce=!1,he=0,ue=0,de=!0;re!==J&&(pe=Math.abs(re-J),he=Math.sign(re-J)*Math.min(30,pe),de=pe<=30);let ge=g.rules.speed;$<=I.Coords.LEPTONS_PER_TILE&&this.maneuverType!==X.CircleStrafe&&(ge=Y.lerp(1,ge/2,Z.GameMath.sqrt($/I.Coords.LEPTONS_PER_TILE))),this.deceleratingToTurn?this.currentHorizSpeed=Math.max(0,this.currentHorizSpeed-2):this.currentHorizSpeed=Math.min(this.currentHorizSpeed+2,ge);var pe=this.currentHorizSpeed;let me;this.deceleratingToTurn=!1,ce=ee?(ee=pe||ee?_.TargetUtil.computeTurnCircle(K,this.currentMoveDir,Math.sign(ee)*g.rules.rot,pe):void 0,0!==pe&&!U.circleContainsPoint(ee,W)||(this.maneuverType===X.HoverStrafe||$>I.Coords.LEPTONS_PER_TILE?this.deceleratingToTurn=!0:this.maneuverType===X.None&&(this.maneuverType=X.HoverStrafe)),ue=pe,!1):(ue=Math.min(pe,$),$<=pe),me=$<1?(ce=!0,q):ce?q:this.currentMoveDir.clone().setLength(ue);let fe=new Q.Vector3(me.x,he,me.y);return $=fe.clone(),g.moveTrait.velocity.copy($),{distance:fe,done:ce&&de}}computeCancelDest(g,P){var L=P.clone().multiplyScalar(1/I.Coords.LEPTONS_PER_TILE).floor().multiplyScalar(I.Coords.LEPTONS_PER_TILE);L=P.clone().sub(L);return new $.Vector2(g.rx,g.ry).multiplyScalar(I.Coords.LEPTONS_PER_TILE).add(L)}})}}}),System.register("game/gameobject/ObjectFactory",["engine/type/ObjectType","game/gameobject/Building","game/gameobject/Terrain","game/gameobject/Overlay","game/gameobject/Smudge","game/gameobject/Infantry","game/gameobject/Vehicle","game/gameobject/Aircraft","game/art/ObjectArt","data/IniSection","game/gameobject/trait/UnitOrderTrait","game/gameobject/ObjectPosition","game/gameobject/trait/AttackTrait","game/gameobject/Projectile","game/gameobject/trait/DeployerTrait","game/gameobject/trait/HealthTrait","game/gameobject/trait/BridgeTrait","game/map/BridgeOverlayTypes","game/map/OreOverlayTypes","game/gameobject/trait/TiberiumTrait","game/gameobject/trait/TiberiumTreeTrait","game/gameobject/trait/AutoRepairTrait","game/gameobject/trait/VeteranTrait","game/gameobject/trait/ArmedTrait","game/gameobject/trait/SelfHealingTrait","game/gameobject/trait/AmmoTrait","game/gameobject/trait/DisguiseTrait","game/gameobject/trait/InvulnerableTrait","game/gameobject/trait/WarpedOutTrait","game/gameobject/trait/TntChargeTrait","game/gameobject/trait/MindControllableTrait","game/gameobject/trait/MindControllerTrait","game/gameobject/trait/TemporalTrait","game/gameobject/trait/CloakableTrait","game/gameobject/trait/AirSpawnTrait","game/gameobject/trait/SpawnDebrisTrait","game/gameobject/Debris","game/rules/DebrisRules","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/SensorsTrait"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be,Se,we,Ee,Ce;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g},function(g){ce=g},function(g){he=g},function(g){ue=g},function(g){de=g},function(g){ge=g},function(g){pe=g},function(g){me=g},function(g){fe=g},function(g){ye=g},function(g){Te=g},function(g){ve=g},function(g){be=g},function(g){Se=g},function(g){we=g},function(g){Ee=g},function(g){Ce=g}],execute:function(){g("ObjectFactory",class{constructor(g,P,I,L){this.tiles=g,this.tileOccupation=P,this.bridges=I,this.nextObjectId=L}create(g,P,xe,Oe){let Ae,Me,Re;switch(g===I.ObjectType.Debris?Ae=xe.hasObject(P,I.ObjectType.VoxelAnim)?(Me=Oe.getObject(P,I.ObjectType.VoxelAnim),xe.getObject(P,I.ObjectType.VoxelAnim)):(Me=Oe.getAnimation(P),new we.DebrisRules(I.ObjectType.Debris,Oe.getIni().getOrCreateSection(P))):Me=g===I.ObjectType.Projectile?(Ae=xe.getProjectile(P),Ae.inviso?new K.ObjectArt(I.ObjectType.Projectile,Ae,new q.IniSection(P)):Oe.getProjectile(P)):(Ae=xe.getObject(P,g),Oe.getObject(P,g)),g){case I.ObjectType.Building:Re=L.Building.factory(P,Ae,xe,Me,this.tiles,this.bridges);break;case I.ObjectType.Infantry:Re=V.Infantry.factory(P,Ae,Me,this.tileOccupation);break;case I.ObjectType.Vehicle:Re=W.Vehicle.factory(P,Ae,Me,xe,this.tileOccupation);break;case I.ObjectType.Aircraft:Re=z.Aircraft.factory(P,Ae,Me,xe,this.tileOccupation);break;case I.ObjectType.Terrain:Re=_.Terrain.factory(P,Ae,Me);break;case I.ObjectType.Overlay:Re=U.Overlay.factory(P,Ae,Me);break;case I.ObjectType.Smudge:Re=G.Smudge.factory(P,Ae,Me);break;case I.ObjectType.Projectile:Re=Z.Projectile.factory(P,Ae,Me,this.tileOccupation);break;case I.ObjectType.Debris:Re=Se.Debris.factory(P,Ae,Me,this.tileOccupation);break;default:throw new Error("Not implemented")}var Pe;if(Re.id=this.nextObjectId.value++,Re.position=new Q.ObjectPosition(this.tiles,this.tileOccupation),Re.isUnit()?Re.position.subCell=0:Re.isBuilding()&&Re.position.setCenterOffset(Re.getFoundationCenterOffset()),Re.isTechno()&&((Re.rules.primary||Re.rules.secondary||Re.rules.weaponCount||Re.rules.explodes)&&(Re.armedTrait=new le.ArmedTrait(Re,xe),Re.traits.add(Re.armedTrait)),-1!==Re.rules.ammo&&(Pe=Re.rules.initialAmmo,Re.ammoTrait=new he.AmmoTrait(Re.rules.ammo,-1!==Pe?Pe:void 0),Re.traits.add(Re.ammoTrait)),Re.unitOrderTrait=new $.UnitOrderTrait(Re),Re.traits.addToFront(Re.unitOrderTrait),(Re.primaryWeapon||Re.secondaryWeapon)&&(Re.attackTrait=new Y.AttackTrait(this.tiles,this.tileOccupation),Re.traits.add(Re.attackTrait)),(Re.isInfantry()||Re.isVehicle())&&Re.rules.deployer&&(Re.deployerTrait=new X.DeployerTrait(Re),Re.traits.add(Re.deployerTrait)),(Re.isInfantry()||Re.isVehicle())&&Re.rules.canDisguise&&(Re.disguiseTrait=new ue.DisguiseTrait,Re.traits.add(Re.disguiseTrait)),Re.rules.cloakable&&(Re.cloakableTrait=new Te.CloakableTrait(Re,xe.general.cloakDelay),Re.traits.add(Re.cloakableTrait)),Re.rules.sensors&&(Re.sensorsTrait=new Ce.SensorsTrait,Re.traits.add(Re.sensorsTrait)),Re.autoRepairTrait=new ne.AutoRepairTrait(!Re.isBuilding()),Re.traits.add(Re.autoRepairTrait),Re.rules.trainable&&(Re.veteranTrait=new oe.VeteranTrait(Re,xe.general.veteran),Re.traits.add(Re.veteranTrait)),Re.rules.selfHealing&&Re.traits.add(new ce.SelfHealingTrait),Re.invulnerableTrait=new de.InvulnerableTrait,Re.traits.add(Re.invulnerableTrait),Re.warpedOutTrait=new ge.WarpedOutTrait(Re),Re.traits.add(Re.warpedOutTrait),Re.temporalTrait=new ye.TemporalTrait(Re),Re.traits.add(Re.temporalTrait),Re.rules.bombable&&!Re.art.toOverlay&&(Re.tntChargeTrait=new pe.TntChargeTrait,Re.traits.add(Re.tntChargeTrait)),Re.rules.immuneToPsionics||Re.isBuilding()||(Re.mindControllableTrait=new me.MindControllableTrait(Re),Re.traits.add(Re.mindControllableTrait)),[Re.primaryWeapon,Re.secondaryWeapon].some(g=>g?.warhead.rules.mindControl)&&(Re.mindControllerTrait=new fe.MindControllerTrait(Re),Re.traits.add(Re.mindControllerTrait)),Re.rules.spawns&&(Re.airSpawnTrait=new ve.AirSpawnTrait,Re.traits.add(Re.airSpawnTrait)),Re.rules.maxDebris&&Re.traits.add(new be.SpawnDebrisTrait)),Re.isTechno()||Re.isOverlay()||Re.isTerrain()){var Ie=Re.isOverlay()&&te.BridgeOverlayTypes.isBridge(xe.getOverlayId(Re.name));let g=Re.rules.strength;!g&&Re.isTerrain()&&(g=xe.general.treeStrength),Ie&&(g=xe.combatDamage.bridgeStrength),(g||Re.isTechno())&&(Re.healthTrait=new J.HealthTrait(g,Re,xe.audioVisual.conditionYellow,xe.audioVisual.conditionRed),Re.traits.add(Re.healthTrait)),Re.isOverlay()&&Ie&&(Re.bridgeTrait=new ee.BridgeTrait(this.bridges),Re.traits.add(Re.bridgeTrait),te.BridgeOverlayTypes.getOverlayBridgeType(xe.getOverlayId(Re.name))===te.OverlayBridgeType.Concrete&&Re.traits.add(new be.SpawnDebrisTrait))}return!Re.isOverlay()||void 0!==(Ie=re.OreOverlayTypes.getOverlayTibType(xe.getOverlayId(Re.name)))&&(Ie=xe.getTiberium(Ie),Re.traits.add(new se.TiberiumTrait(Re,Ie))),Re.isTerrain()&&Re.rules.spawnsTiberium&&Re.traits.add(new ae.TiberiumTreeTrait(Re.rules)),Re.cachedTraits.tick.push(...Re.traits.filter(Ee.NotifyTick)),Re}})}}}),System.register("game/gameobject/ObjectPosition",["game/Coords","util/event","game/theater/rampHeights","game/math/Vector3","game/math/Vector2","util/math"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){g("ObjectPosition",class l{get onPositionChange(){return this._onPositionChange.asEvent()}get worldPosition(){return this._worldPosition}get tile(){return this._tile}set tile(g){var P=!!this._tile&&g!==this._tile;(this._tile=g)&&(this.updateWorldPosition(g,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:P}))}get tileElevation(){return void 0===this._tileElevation?(void 0===this._computedTileElevation&&(this._computedTileElevation=this.computeTileElevationFromWorldPos()),this._computedTileElevation):this._tileElevation}set tileElevation(g){this._absoluteElevation=void 0,this._tileElevation=g,this._tile&&(this.updateWorldPosition(this._tile,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:!1}))}get subCell(){if(!this._tileOffset.x&&!this._tileOffset.y)return 0;var g=Math.sign(this._tileOffset.x/I.Coords.LEPTONS_PER_TILE-.5),P=Math.sign(this._tileOffset.y/I.Coords.LEPTONS_PER_TILE-.5);return g&&P?P+1+(g+1)/2+1:0}set subCell(g){this._tileOffset=this.computeSubCellOffset(g),this.desiredSubCell=g,this._tile&&(this.updateWorldPosition(this._tile,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:!1}))}constructor(g,P){this.tiles=g,this.tileOccupation=P,this._worldPosition=new U.Vector3,this._tileOffset=new G.Vector2,this._centerOffset=new G.Vector2,this.desiredSubCell=0,this._tileElevation=0,this._onPositionChange=new L.EventDispatcher}getTileOffset(){return this._tileOffset.clone()}setTileOffset(g){this._tileOffset.copy(g),this._tile&&(this.updateWorldPosition(this._tile,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:!1}))}setCenterOffset(g){this._centerOffset.copy(g),this._tile&&(this.updateWorldPosition(this._tile,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:!1}))}getMapPosition(){if(this._tile)return new G.Vector2(this._tile.rx*I.Coords.LEPTONS_PER_TILE+this._tileOffset.x+this._centerOffset.x,this._tile.ry*I.Coords.LEPTONS_PER_TILE+this._tileOffset.y+this._centerOffset.y)}getBridgeBelow(){return this._tile?.onBridgeLandType?this.tileOccupation.getBridgeOnTile(this._tile):void 0}moveToTileCell(g,P=0){if(!this._tile)throw new Error("Tile is not set");var I=g!==this._tile;this._tile=g,this._tileOffset=this.computeSubCellOffset(P),this.desiredSubCell=P,this.updateWorldPosition(g,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:I})}moveToTileCoords(g,P,L=!1){var _=Math.floor(g),U=Math.floor(P),G=!this._tile||this._tile.rx!==_||this._tile.ry!==U;if(G){let g=this.tiles.getByMapCoords(_,U);if(!g){if(!L)throw new RangeError(`Attempted move to a non-existent tile: [${_},${U}]`);g=this.tiles.getPlaceholderTile(_,U)}this._tile=g}this._tileOffset.set((g-_)*I.Coords.LEPTONS_PER_TILE,(P-U)*I.Coords.LEPTONS_PER_TILE),this.updateWorldPosition(this._tile,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:G})}moveToLeptons(g,P=!1){this.moveToTileCoords(g.x/I.Coords.LEPTONS_PER_TILE,g.y/I.Coords.LEPTONS_PER_TILE,P)}moveByLeptons(g,P,L=!1){if(!this._tile)throw new Error("Tile is not set");this.moveToTileCoords(this._tile.rx+(this._tileOffset.x+g)/I.Coords.LEPTONS_PER_TILE,this._tile.ry+(this._tileOffset.y+P)/I.Coords.LEPTONS_PER_TILE,L)}moveByLeptons3(g,P=!1){var I=this._worldPosition.y;this.moveByLeptons(g.x,g.z,P),this.setAbsoluteElevationWorld(I+g.y)}setAbsoluteElevationWorld(g){this._absoluteElevation=g,this._tileElevation=void 0,this._tile&&(this.updateWorldPosition(this._tile,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:!1}))}computeSubCellOffset(g){let P={width:0,height:0};var L;g&&(L=(g-1)%2*2-1,_=2*Math.floor((g-1)/2)-1,P={width:L*I.Coords.LEPTONS_PER_TILE/4,height:_*I.Coords.LEPTONS_PER_TILE/4});var _=I.Coords.LEPTONS_PER_TILE/2;return new G.Vector2(_+P.width,_+P.height)}interpolateRampHeight(g,P,I){var L=_.rampHeights[I],U=L[1],G=L[0];return U*(1-g)*(1-P)+L[2]*g*(1-P)+G*(1-g)*P+L[3]*g*P}updateWorldPosition(g,P){var L=P.x+this._centerOffset.x,_=P.y+this._centerOffset.y,U=L/I.Coords.LEPTONS_PER_TILE,G=_/I.Coords.LEPTONS_PER_TILE;let V;if(void 0!==this._tileElevation){let P=0;0!==g.rampType&&(P=this.interpolateRampHeight(U,G,g.rampType)),V=I.Coords.tileHeightToWorld(g.z+P+this._tileElevation)}else V=this._absoluteElevation;this._worldPosition.set(g.rx*I.Coords.LEPTONS_PER_TILE+L,V,g.ry*I.Coords.LEPTONS_PER_TILE+_),void 0===this._tileElevation&&(this._computedTileElevation=this.computeTileElevationFromWorldPos())}computeTileElevationFromWorldPos(){if(!this._tile)return 0;var g=V.roundToDecimals(I.Coords.worldToTileHeight(this._worldPosition.y),14),P=(this._tileOffset.x+this._centerOffset.x)/I.Coords.LEPTONS_PER_TILE,L=(this._tileOffset.y+this._centerOffset.y)/I.Coords.LEPTONS_PER_TILE;let _=0;return 0!==this._tile.rampType&&(_=this.interpolateRampHeight(P,L,this._tile.rampType)),g-this._tile.z-_}clone(){let g=new l(this.tiles,this.tileOccupation);return g._worldPosition=this._worldPosition.clone(),g._tile=this._tile,g._tileOffset=this._tileOffset.clone(),g._centerOffset=this._centerOffset.clone(),g._tileElevation=this._tileElevation,g._absoluteElevation=this._absoluteElevation,g._computedTileElevation=this._computedTileElevation,g}})}}}),System.register("game/gameobject/Overlay",["engine/type/ObjectType","game/gameobject/GameObject","game/map/BridgeOverlayTypes","game/map/OreOverlayTypes","game/gameobject/trait/WallTrait","game/type/LandType"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){W=class extends L.GameObject{static factory(g,P,I){let L=new this(g,P,I);return P.wall&&(L.wallTrait=new G.WallTrait,L.traits.add(L.wallTrait)),L}constructor(g,P,L){super(I.ObjectType.Overlay,g,P,L),this.radarInvisible=this.rules.radarInvisible}isTiberium(){return void 0!==U.OreOverlayTypes.getOverlayTibType(this.overlayId)}isBridge(){return _.BridgeOverlayTypes.isBridge(this.overlayId)}isXBridge(){return _.BridgeOverlayTypes.isXBridge(this.overlayId)}isHighBridge(){return _.BridgeOverlayTypes.isHighBridge(this.overlayId)}isLowBridge(){return _.BridgeOverlayTypes.isLowBridge(this.overlayId)}isBridgePlaceholder(){return _.BridgeOverlayTypes.isBridgePlaceholder(this.overlayId)}getFoundation(){let g={width:1,height:1};return this.isBridge()&&(this.isXBridge()?g.height+=2:g.width+=2),g}getLandType(){return this.rules.wall?V.LandType.Wall:this.isTiberium()?V.LandType.Tiberium:this.isBridge()&&this.isHighBridge()?V.LandType.Road:this.rules.land}},g("Overlay",W)}}}),System.register("game/gameobject/Projectile",["game/gameobject/GameObject","engine/type/ObjectType","game/Weapon","game/WeaponType","game/gameobject/unit/FacingUtil","game/Coords","game/gameobject/unit/ZoneType","game/map/TileOccupation","game/map/tileFinder/RadialTileFinder","game/gameobject/unit/RangeHelper","game/gameobject/unit/TargetUtil","game/math/geometry","game/map/tileFinder/RandomTileFinder","util/math","game/type/MovementZone","game/gameobject/infantry/StanceType","game/gameobject/unit/MovePositionHelper","game/GameSpeed","game/gameobject/unit/VeteranLevel","game/gameobject/task/ScatterTask","game/Warhead","game/rules/ObjectRules","game/gameobject/unit/CollisionHelper","game/gameobject/unit/CollisionType","game/math/Vector2","game/math/Vector3","game/SpecialWarheadType"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce,he,ue,de,ge;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g},function(g){ce=g},function(g){he=g},function(g){ue=g}],execute:function(){var P;(P=de||g("ProjectileState",de={}))[P.Travel=0]="Travel",P[P.Impact=1]="Impact",P[P.Detonation=2]="Detonation",ge=class extends I.GameObject{get fromObject(){return this._fromObject}set fromObject(g){(this._fromObject=g)&&g.veteranTrait&&!g.isDestroyed&&(this.veteranDamageMult=g.veteranTrait.getVeteranDamageMultiplier())}get rot(){return this.fromWeapon.rules.isSonic?ne.ObjectRules.iniRotToDegsPerTick(this.iniRot):this.rules.rot}get iniRot(){return this.fromWeapon.rules.isSonic?10:this.rules.iniRot}static factory(g,P,I,L){return new this(g,P,I,L)}constructor(g,P,I,_){super(L.ObjectType.Projectile,g,P,I),this.tileOccupation=_,this.state=de.Travel,this.detonationTimer=0,this.collisionType=le.CollisionType.None,this.direction=0,this.zone=W.ZoneType.Air,this.isShrapnel=!1,this.isNuke=!1,this.baseDamageMultiplier=1,this.veteranDamageMult=1,this.snapToTarget=!1,this.targetLockLost=!1,this.limboTravelTicks=0,this.homingTravelDistance=0,this.homingTravelTicks=0,this.velocity=new he.Vector3,this.sonicVisitedObjects=new Map,this.collisionHelper=new oe.CollisionHelper(_)}onSpawn(g){var P;if(super.onSpawn(g),this.initialSelfPosition=this.position.worldPosition.clone(),!this.target.obj||this.fromWeapon.type===U.WeaponType.DeathWeapon||this.fromWeapon.rules.limboLaunch||!this.isHoming()&&this.fromWeapon.speed===Number.POSITIVE_INFINITY||this.rules.inaccurate||this.rules.arcing||this.rules.flakScatter||0<(P=this.computeBaseDamage(g))&&(P=this.fromWeapon.warhead.computeDamage(P,this.target.obj,g),this.target.obj.healthTrait?.projectDamage(P)),g.afterTick(()=>{var P=new q.RangeHelper(this.tileOccupation).distance2(this.target.getWorldCoords(),this)/V.Coords.LEPTONS_PER_TILE;this.initialTileDistToTarget=P,this.maxSpeed=this.computeMaxSpeed(this.fromWeapon.speed,P,g.rules.audioVisual.gravity)}),this.isHoming()){if(1===this.iniRot&&(this.homingMoveDir=this.target.getWorldCoords().clone().sub(this.position.worldPosition)),this.fromObject?.isAircraft()&&this.rules.isAntiGround&&!this.rules.isAntiAir){let P=this.target.obj;!P?.isVehicle()||P.isDestroyed||P.veteranLevel!==re.VeteranLevel.Elite||P.unitOrderTrait.hasTasks()||P.unitOrderTrait.addTask(new se.ScatterTask(g))}}else if(this.rules.vertical){let g=this.position.clone();g.tileElevation=this.fromWeapon.warhead.rules.nukeMaker?V.Coords.worldToTileHeight(this.fromWeapon.projectileRules.detonationAltitude):0,this.aimPoint=g.worldPosition.clone()}else{let P=this.target.getWorldCoords().clone();g.afterTick(()=>{var I=this.target.getWorldCoords().clone().sub(P).length()>V.Coords.LEPTONS_PER_TILE;let L=I?P:this.target.obj?.isUnit()&&this.target.obj.moveTrait.velocity.length()&&isFinite(this.maxSpeed)?this.computeAimPointVersusMovingTarget(this.target.obj,this.maxSpeed,this.position.worldPosition,g.map):this.target.getWorldCoords().clone();this.aimPoint=L,this.snapToTarget=!I&&isFinite(this.maxSpeed)&&!this.fromWeapon.warhead.rules.sonic,(this.rules.inaccurate||this.rules.flakScatter)&&(this.adjustAimForBallisticScatter(g,L),this.snapToTarget=!1),!I&&this.rules.arcing&&(this.rules.inaccurate?(this.overshootTiles=this.calculateInaccurateBallisticOvershoot(g),this.snapToTarget=!1):this.target.obj?.isVehicle()&&this.target.obj.moveTrait.isMoving()&&(this.overshootTiles=this.calculateBallisticOvershootVsMoving(g,this.target.obj),this.overshootTiles&&(this.snapToTarget=!1))),L.clone().sub(this.position.worldPosition).length()<this.fromWeapon.speed&&this.update(g)})}}adjustAimForBallisticScatter(g,P){let I,L=g.rules.combatDamage.ballisticScatter;I=this.rules.flakScatter?(this.rules.inviso&&(L*=2),g.generateRandom()*L):L/2+g.generateRandom()*(L/2);let _=I*V.Coords.LEPTONS_PER_TILE;this.rules.flakScatter&&(_*=(G=P.clone().sub(this.initialSelfPosition).length())/(this.fromWeapon.range*V.Coords.LEPTONS_PER_TILE));var U=Q.rotateVec2(new ce.Vector2(_,0),g.generateRandomInt(0,360)),G=V.Coords.vecWorldToGround(P).add(U).multiplyScalar(1/V.Coords.LEPTONS_PER_TILE).floor();g.map.tiles.getByMapCoords(G.x,G.y)&&P.add(new he.Vector3(U.x,0,U.y))}calculateBallisticOvershootVsMoving(g,P){let I=this.target.getWorldCoords().clone().sub(this.initialSelfPosition);var L=V.Coords.vecWorldToGround(I),_=V.Coords.vecWorldToGround(P.moveTrait.velocity);_=(_=(90<(L=Q.angleDegBetweenVec2(L,_))?180-L:L)/90)*(L=I.length()/V.Coords.LEPTONS_PER_TILE)/5;return g.generateRandom()<=_?2*Math.min(1,L/5):0}calculateInaccurateBallisticOvershoot(g){return g.generateRandom()<=.5?2:0}update(g){if(void 0!==this.maxSpeed)if(super.update(g),this.state!==de.Impact){var P=this.velocity.clone(),I=this.position.clone();if(this.velocity.set(0,0,0),this.fromWeapon.rules.limboLaunch){if(!this.fromObject)throw new Error("Limbo launch projectile must be fired from a unit");if(this.fromObject.isDestroyed)return void g.destroyObject(this)}var L=this.updateSpeed(this.maxSpeed);this.speed=L;let ue=this.target.getWorldCoords();if(this.lastTargetLockPosition&&(this.targetLockLost||ue.clone().sub(this.lastTargetLockPosition).length()>=V.Coords.LEPTONS_PER_TILE)?(ue=this.lastTargetLockPosition,this.targetLockLost=!0):this.lastTargetLockPosition=ue.clone(),this.isHoming()){if(this.target.obj?.isUnit()&&(this.target.obj.isDestroyed||this.target.obj.isCrashing||!this.target.obj.isSpawned)&&(this.fromWeapon.rules.limboLaunch||this.homingTravelDistance>=2*V.Coords.LEPTONS_PER_TILE))return void this.detonate(g);if(this.homingMoveDir||(U=G.FacingUtil.toMapCoords(this.direction),this.homingMoveDir=new he.Vector3(U.x,0,U.y),this.fromObject?.isAircraft()&&(this.homingMoveDir.y=-9999999,this.homingMoveDir.normalize())),this.fromWeapon.rules.limboLaunch){if(!this.targetLockLost){if(10<this.limboTravelTicks)return this.position.moveToLeptons(this.target.obj.position.getMapPosition()),this.position.tileElevation=this.target.obj.position.tileElevation,void this.detonate(g);this.limboTravelTicks++}}else if(!this.isInHomingRange(ue,g))return void this.detonate(g);let P=new q.RangeHelper(this.tileOccupation);var _=Math.floor(P.distance2(ue,this)/V.Coords.LEPTONS_PER_TILE),U=2<_&&1<this.iniRot;let Y=ue.clone().sub(this.position.worldPosition),J=0;this.homingTravelTicks<this.rules.courseLockDuration||(U?(Q.rotateVec3Towards(this.homingMoveDir,new he.Vector3(Y.x,this.homingMoveDir.y,Y.z),this.rot),this.rules.level||(_=Z.clamp(Math.floor(this.initialTileDistToTarget)-1,0,2)+Z.clamp(_-2,0,3),W=this.tileOccupation.getBridgeOnTile(this.tile)?.tileElevation??0,(W=_-(this.position.tileElevation-W))&&(z=.25+6/this.iniRot*.1,J=V.Coords.tileHeightToWorld(Math.sign(W)*Math.min(Math.abs(W),z))))):Q.rotateVec3Towards(this.homingMoveDir,Y,this.rot)),this.direction=G.FacingUtil.fromMapCoords(new ce.Vector2(this.homingMoveDir.x,this.homingMoveDir.z));var W=Y.length(),z=Math.min(W,L);this.homingTravelDistance+=z,this.homingTravelTicks++;let ee,te=!1,re=le.CollisionType.None;if(W>=V.Coords.LEPTONS_PER_TILE/4){let P=this.homingMoveDir.clone().setLength(z);J&&(P.y+=J),z===L&&this.velocity.copy(P);var K=P.clone().add(this.position.worldPosition);if(g.map.mapBounds.isWithinHardBounds(K)?this.position.moveByLeptons3(P):te=!0,re=($=this.checkObstacles(I,g)).type,ee=$.target,re)te=!0;else{W<(X=ue.clone().sub(this.position.worldPosition).length())&&X<2*V.Coords.LEPTONS_PER_TILE&&(te=!0)}}else g.map.isWithinHardBounds(ue)&&this.position.moveByLeptons3(Y),te=!0;if(te){if(ee&&re===le.CollisionType.Wall){let g=ee.position.worldPosition;this.position.moveByLeptons3(g.clone().sub(this.position.worldPosition))}this.collisionType=re,this.detonate(g,re)}}else{let _=this.aimPoint.clone().sub(this.position.worldPosition);if(this.rules.vertical||(this.direction=G.FacingUtil.fromMapCoords(new ce.Vector2(_.x,_.z))),this.rules.arcing&&(_.y=0),K=Math.min(_.length(),L),_.setLength(K),this.rules.arcing){let P=V.Coords.vecWorldToGround(this.position.worldPosition.clone().sub(this.initialSelfPosition).add(_));var $=this.aimPoint.clone().sub(this.initialSelfPosition),Y=P.length(),X=(W=V.Coords.vecWorldToGround($).length(),$.y);$=g.rules.audioVisual.gravity;W&&(_.y=(X/W*L+$/2*W/L)*Y/L-$*(Y/L)*(Y/L)/2+this.initialSelfPosition.y-this.position.worldPosition.y)}let U=!1;Y=_.clone().add(this.position.worldPosition),g.map.isWithinHardBounds(Y)?this.position.moveByLeptons3(_):U=!0;let z,q=le.CollisionType.None;if(1<=K?(K!==L&&!this.overshootTiles||this.velocity.copy(_),q=(I=this.checkObstacles(I,g)).type,z=I.target,(q||K<L)&&(U=!0)):U=!0,U){if(q){if(z&&q===le.CollisionType.Wall){let g=z.isBuilding()?V.Coords.tile3dToWorld(z.tile.rx+.5,z.tile.ry+.5,z.tile.z):z.position.worldPosition;this.position.moveByLeptons3(g.clone().sub(this.position.worldPosition))}}else if(this.overshootTiles){var J=V.Coords.vecWorldToGround(P).setLength(this.overshootTiles*V.Coords.LEPTONS_PER_TILE);if(Q.rotateVec2(J,g.generateRandomInt(-45,45)),Y=V.Coords.vecGroundToWorld(J).add(this.position.worldPosition),!g.map.isWithinHardBounds(Y))return void g.unspawnObject(this);this.position.moveByLeptons(J.x,J.y)}else if(this.snapToTarget&&!this.targetLockLost){if(!g.map.isWithinHardBounds(ue))return void g.unspawnObject(this);this.position.moveByLeptons3(ue.clone().sub(this.position.worldPosition))}this.collisionType=q,this.isNuke?(this.state=de.Impact,this.detonationTimer=2.5*te.GameSpeed.BASE_TICKS_PER_SECOND):this.detonate(g,q)}}let ge=this.fromWeapon.warhead;if(ge.rules.sonic){J=11/30*V.Coords.LEPTONS_PER_TILE,J=this.position.worldPosition.clone().add(this.velocity.clone().setLength(J)),J=V.Coords.vecWorldToGround(J).multiplyScalar(1/V.Coords.LEPTONS_PER_TILE).floor();var ee,re,se=g.map.tiles.getByMapCoords(J.x,J.y);if(se&&se!==this.fromObject?.tile){var ae,ne=g.map.getTileZone(se);for(ae of g.map.getGroundObjectsOnTile(se))if((!ae.isUnit()||!ae.onBridge)&&(!ae.isTechno()||!ae.rules.typeImmune||ae.owner!==this.fromPlayer||ae.name!==this.fromObject?.name)&&(!ae.isAircraft()||!ae.rules.spawned)&&ge.canDamage(ae,se,ne)){let g=this.sonicVisitedObjects.get(ae)??new Set;g.add(se),this.sonicVisitedObjects.set(ae,g)}}for([ee,re]of this.sonicVisitedObjects)for(var oe of re)g.map.tileOccupation.isTileOccupiedBy(oe,ee)&&ee.isSpawned&&(oe=this.fromWeapon.rules.ambientDamage*this.veteranDamageMult*this.baseDamageMultiplier,oe=ge.computeDamage(oe,ee,g),ge.inflictDamage(oe,ee,{player:this.fromPlayer,weapon:this.fromWeapon,obj:this.fromObject},g,ee!==this.target.obj))}}else 0<this.detonationTimer?this.detonationTimer--:this.detonate(g,this.collisionType)}isHoming(){return!!this.rot&&!this.rules.arcing}isInHomingRange(g,P){let I=!0,L=this.target.obj;if(L?.isUnit()&&this.fromObject){let G=new q.RangeHelper(this.tileOccupation);var _,U=G.computeWeaponRangeVsTarget(this.fromObject,L,this.fromWeapon,P.rules).range;this.fromWeapon.rules.limboLaunch?I=G.isInRange3(this.initialSelfPosition,g,0,U+.5):(_=L.moveTrait.velocity.length())&&(this.fromObject.rules.movementZone===X.MovementZone.Fly?5<this.speed/_&&(I=G.isInRange2(this.initialSelfPosition,this.position.worldPosition,0,U)):isFinite(this.fromWeapon.speed)&&3.5<this.fromWeapon.speed/L.rules.speed&&(I=G.isInRange3(this.initialSelfPosition,this.position.worldPosition,0,U)))}return I}updateSpeed(g){let P;return P=this.isHoming()||this.rules.vertical?void 0===this.speed?Math.min(g,this.rules.acceleration):Math.min(g,this.speed+this.rules.acceleration):g,P}computeMaxSpeed(g,P,I){let L=g;return this.rules.arcing&&(L*=(1+I/6)/2,L*=(P=Math.floor(P))<=8?1:1+P/8*.5),this.fromWeapon.warhead.rules.sonic&&(L=Math.ceil(P*V.Coords.LEPTONS_PER_TILE/21)),L}checkObstacles(g,P){return this.fromWeapon.rules.limboLaunch?{type:le.CollisionType.None}:this.collisionHelper.checkCollisions(this.position,g,{cliffs:this.rules.subjectToCliffs,ground:this.isHoming(),shore:this.rules.level,walls:this.rules.subjectToWalls,units:!this.rules.inaccurate&&(g=>this.fromPlayer!==g&&!P.alliances.areAllied(this.fromPlayer,g))})}computeBaseDamage(g){var P=this.fromWeapon,I=P.warhead;let L=P.rules.damage;P.type===U.WeaponType.DeathWeapon&&I.rules.ivanBomb&&(L=g.rules.combatDamage.ivanDamage);let _=L*this.baseDamageMultiplier;return P.type===U.WeaponType.DeathWeapon&&this.fromObject&&(_*=this.fromObject.rules.deathWeaponDamageModifier),_*=this.veteranDamageMult,_}detonate(g,P=le.CollisionType.None){var I=this.fromWeapon;let L=I.warhead;var G,V=this.zone=this.collisionHelper.computeDetonationZone(this.tile,this.tileElevation,P);let W=this.tile;I.type===U.WeaponType.DeathWeapon&&L.rules.ivanBomb&&(L=new ae.Warhead(g.rules.getWarhead(g.rules.combatDamage.ivanWarhead)));let $=this.computeBaseDamage(g);g.destroyObject(this),this.state=de.Detonation;let Q=this.target.obj,Z=!1;if(L.rules.parasite&&Q?.isUnit()&&W===Q.tile&&L.canDamage(Q,W,V))if(Q.isInfantry())$=Number.POSITIVE_INFINITY;else if(Q.parasiteableTrait&&this.fromObject?.isUnit()){if(!(this.fromWeapon instanceof _.Weapon))throw new Error("Projectile with parasite warhead must have a weapon reference");Q.parasiteableTrait.infest(this.fromObject,this.fromWeapon),Z=!0}let te=!0;if(Z&&(te=!1),L.rules.sonic&&(te=!1),L.rules.ivanBomb&&(te=!1,!Q?.isTechno()||!Q.tntChargeTrait||Q.tntChargeTrait.hasCharge()||Q.isDestroyed||Q.warpedOutTrait.isInvulnerable()||(G=g.rules.combatDamage.ivanTimedDelay,Q.tntChargeTrait.setCharge(G,g.currentTick,{player:this.fromPlayer,obj:this.fromObject}))),L.rules.bombDisarm&&(te=!1,Q?.isTechno()&&Q.tntChargeTrait?.hasCharge()&&!Q.isDestroyed&&Q.tntChargeTrait.removeCharge()),L.rules.mindControl&&(te=!1,this.fromObject&&!this.fromObject.isDestroyed&&Q?.isTechno()&&Q.mindControllableTrait&&!Q.mindControllableTrait?.isActive()&&!g.areFriendly(Q,this.fromObject)&&L.canDamage(Q,W,V)&&!Q.invulnerableTrait.isActive()&&this.fromObject.mindControllerTrait.control(Q,g)),L.rules.temporal&&(te=!1,this.fromObject&&!this.fromObject.isDestroyed&&Q?.isTechno()&&L.canDamage(Q,W,V)&&!Q.invulnerableTrait.isActive()&&(L.inflictDamage(0,Q,{player:this.fromPlayer,weapon:I,obj:this.fromObject},g),this.fromObject.temporalTrait.updateTarget(Q,I,g))),L.rules.makesDisguise&&(te=!1,this.fromObject&&!this.fromObject.isDestroyed&&(this.fromObject.isInfantry()||this.fromObject.isVehicle())&&Q?.isUnit()&&Q.type===this.fromObject.type&&this.fromObject.disguiseTrait?.disguiseAs(Q,this.fromObject,g)),L.rules.electricAssault&&(this.fromObject?.isUnit()&&!this.fromObject.isDestroyed&&Q?.isBuilding()&&!Q.isDestroyed&&Q.overpoweredTrait&&Q.owner===this.fromPlayer&&Q.overpoweredTrait.chargeFrom(this.fromObject),te=!1),te&&L.detonate(g,$,W,this.tileElevation,this.position.worldPosition,V,P,this.target,{player:this.fromPlayer,weapon:I,obj:this.fromObject},this.isShrapnel?ue.SpecialWarheadType.Shrapnel:ue.SpecialWarheadType.None,this.impactAnim),L.rules.nukeMaker){let P;P=this.fromObject?(re=_.Weapon.factory(_.Weapon.NUKE_PAYLOAD_NAME,U.WeaponType.Primary,this.fromObject,g.rules),g.createProjectile(re.projectileRules.name,this.fromObject,re,this.target,!1)):g.createLooseProjectile(_.Weapon.NUKE_PAYLOAD_NAME,this.fromPlayer,this.target),P.isNuke=!0,P.impactAnim="NUKEBALL";var re=this.target.tile;P.position.moveToTileCoords(re.rx+.5,re.ry+.5),P.position.tileElevation=this.position.tileElevation,g.spawnObject(P,re)}if(this.rules.shrapnelCount&&this.rules.shrapnelWeapon&&((this.target.obj?!this.target.obj.isBuilding():g.map.getGroundObjectsOnTile(this.target.tile).some(g=>g.isTerrain()||g.isTechno())&&!I.projectileRules.isAntiAir)||this.isShrapnel)){let P=g.rules.getWeapon(this.rules.shrapnelWeapon);var se,ne=g.rules.getProjectile(P.projectile);let I=this.rules.shrapnelCount,L=new q.RangeHelper(g.map.tileOccupation),_=new K.RadialTileFinder(g.map.tiles,g.map.mapBounds,W,{width:1,height:1},1,P.range,g=>L.isInTileRange(W,g,P.minimumRange,P.range)),U=new Set;for(;0<Math.floor(I);){var oe,ce=_.getNextTile();if(!ce)break;for(oe of g.map.tileOccupation.getObjectsOnTileByLayer(ce,ne.isAntiAir?z.LayerType.Air:z.LayerType.Ground).filter(P=>g.isValidTarget(P)&&(P.isTerrain()||P.isTechno()&&P.owner!==this.fromPlayer&&!g.alliances.areAllied(P.owner,this.fromPlayer)&&!(P.isInfantry()&&P.stance===J.StanceType.Paradrop))))if(!U.has(oe)&&(U.add(oe),I=Math.max(0,I-1-(oe.isTechno()?.5:0)),Math.floor(I)<=0))break}for(se of U){var he=g.createTarget(se.isTerrain()?void 0:se,se.tile);this.createShrapnel(g,he,P.name)}I=Math.floor(I);let G=new Y.RandomTileFinder(g.map.tiles,g.map.mapBounds,W,P.range,g,g=>L.isInTileRange(W,g,P.minimumRange,P.range));for(let L=0;L<I;L++){var ge=G.getNextTile();if(!ge)break;ge=g.createTarget(void 0,ge),this.createShrapnel(g,ge,P.name)}}if(I.rules.limboLaunch&&!Z&&this.fromObject?.isUnit()){let P,_,U=this.fromObject;if(L.rules.parasite&&(this.target.obj.isVehicle()||this.target.obj?.isAircraft())&&this.target.obj.parasiteableTrait&&(this.target.obj.parasiteableTrait.beingBoarded=!1),I=U.rules.movementZone===X.MovementZone.Fly)P=W,_=!1;else{let I=this.target.obj.isUnit()&&this.target.obj.tile.onBridgeLandType&&!this.target.obj.onBridge?void 0:g.map.tileOccupation.getBridgeOnTile(W),L=new ee.MovePositionHelper(g.map),G=new K.RadialTileFinder(g.map.tiles,g.map.mapBounds,W,{width:1,height:1},0,1,P=>{var _=g.map.tileOccupation.getBridgeOnTile(P);return 0<g.map.terrain.getPassableSpeed(P,U.rules.speedType,U.isInfantry(),!!_)&&L.isEligibleTile(P,_,I,W)&&(P===W||!g.map.terrain.findObstacles({tile:P,onBridge:I},U).length)});P=G.getNextTile(),_=!!P?.onBridgeLandType}P?(!I&&this.target.obj.isUnit()&&(U.onBridge=_,U.position.tileElevation=_?g.map.tileOccupation.getBridgeOnTile(P)?.tileElevation??0:0),g.unlimboObject(U,P),U.isInfantry()&&(U.position.subCell=this.target.obj.position.subCell),U.direction=this.direction):U.owner.removeOwnedObject(U)}}createShrapnel(g,P,I){let L=g.createLooseProjectile(I,this.fromPlayer,P);L.isShrapnel=!0,L.veteranDamageMult=this.veteranDamageMult,L.position.moveToLeptons(this.position.getMapPosition()),L.position.tileElevation=this.position.tileElevation,g.spawnObject(L,L.position.tile)}computeAimPointVersusMovingTarget(g,P,I,L){let _=g.position.worldPosition,U=_.clone();var G=P,z=g.moveTrait.velocity.length();if(G<3*z)return _.clone();let K=$.TargetUtil.computeInterceptPoint(I,G,_,g.moveTrait.velocity);if(K.length()){let P=K.clone().sub(_);if(G=P.length(),G=z?Math.ceil(G/z):0,K=_.clone().add(P.setLength(G*z)),L.isWithinHardBounds(K))if(g.zone!==W.ZoneType.Air){K.multiplyScalar(1/V.Coords.LEPTONS_PER_TILE);let P=g.position.clone();P.moveToTileCoords(K.x,K.z),U=P.worldPosition}else U=K;else U=_}return U.clone()}},g("Projectile",ge)}}}),System.register("game/gameobject/selection/SelectionLevel",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("SelectionLevel",I={}))[P.None=0]="None",P[P.Hover=1]="Hover",P[P.Selected=2]="Selected",P[P.SelectedHover=3]="SelectedHover"}}}),System.register("game/gameobject/selection/SelectionList",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("game/gameobject/selection/SelectionModel",["game/gameobject/selection/SelectionLevel"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("SelectionModel",class{constructor(g){this.selectionLevel=I.SelectionLevel.None,g.isBuilding()&&g.rules.wall?this.maxSelectionLevel=I.SelectionLevel.None:this.maxSelectionLevel=g.rules.selectable?I.SelectionLevel.Selected|I.SelectionLevel.Hover:I.SelectionLevel.Hover}getSelectionLevel(){return this.selectionLevel}setSelectionLevel(g){this.selectionLevel=Math.min(this.maxSelectionLevel,g)}setHover(g){this.setSelectionLevel(g?this.selectionLevel|I.SelectionLevel.Hover:this.selectionLevel&~I.SelectionLevel.Hover)}setSelected(g){this.setSelectionLevel(g?this.selectionLevel|I.SelectionLevel.Selected:this.selectionLevel&~I.SelectionLevel.Selected)}isHovered(){return this.selectionLevel>>I.SelectionLevel.Hover&1}isSelected(){return this.selectionLevel>=I.SelectionLevel.Selected}getControlGroupNumber(){return this.controlGroupNumber}setControlGroupNumber(g){this.controlGroupNumber=g}})}}}),System.register("game/gameobject/selection/UnitSelection",["game/gameobject/selection/SelectionModel","util/math"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("UnitSelection",class{constructor(){this.selectedUnits=new Set,this.selectionModelsByUnit=new Map,this.groups=new Map,this.hashNeedsUpdate=!0}getOrCreateSelectionModel(g){let P=this.selectionModelsByUnit.get(g);return P||(P=new I.SelectionModel(g),this.selectionModelsByUnit.set(g,P)),P}deselectAll(){this.selectedUnits.forEach(g=>this.selectionModelsByUnit.get(g)?.setSelected(!1)),this.selectedUnits.clear(),this.hashNeedsUpdate=!0}addToSelection(g){this.selectedUnits.add(g),this.getOrCreateSelectionModel(g).setSelected(!0),this.hashNeedsUpdate=!0}removeFromSelection(g){g.forEach(g=>{this.selectedUnits.delete(g),this.getOrCreateSelectionModel(g).setSelected(!1)}),this.hashNeedsUpdate=!0}getSelectedUnits(){return[...this.selectedUnits].filter(g=>!g.isDestroyed&&!g.isCrashing&&!g.isDisposed&&g.isSpawned)}isSelected(g){return this.selectedUnits.has(g)}cleanupUnit(g){this.selectionModelsByUnit.delete(g),this.selectedUnits.delete(g),this.removeUnitsFromGroup([g]),this.hashNeedsUpdate=!0}updateHash(){this.hash=L.fnv32a([...this.selectedUnits].map(g=>g.id))}getHash(){return this.hashNeedsUpdate&&(this.updateHash(),this.hashNeedsUpdate=!1),this.hash}createGroup(g){this.addUnitsToGroup(g,this.getSelectedUnits())}addUnitsToGroup(g,P,I=!0){this.removeUnitsFromGroup(P);let L=this.groups.get(g);for(var _ of(L||(L=new Set,this.groups.set(g,L)),I&&([...L.values()].forEach(g=>this.selectionModelsByUnit.get(g)?.setControlGroupNumber(void 0)),L.clear()),P))L.add(_),this.getOrCreateSelectionModel(_).setControlGroupNumber(g)}addGroupToSelection(g){if(this.groups.has(g))for(var P of[...this.groups.get(g)])this.addToSelection(P)}selectGroup(g){this.deselectAll(),this.addGroupToSelection(g)}getGroupUnits(g){return[...this.groups.get(g)??[]]}removeUnitsFromGroup(g){for(var P of this.groups.values())for(var I of g)P.delete(I),this.selectionModelsByUnit.get(I)?.setControlGroupNumber(void 0)}})}}}),System.register("game/gameobject/selection/UnitSelectionLite",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("UnitSelectionLite",class{constructor(g){this.player=g,this.selectedUnits=new Set}update(g){var P,I=[...g].reverse().find(g=>g.owner!==this.player);for(P of(I&&(g=[I]),this.selectedUnits.clear(),g))P.rules.selectable&&this.selectedUnits.add(P)}getSelectedUnits(){return[...this.selectedUnits].map(g=>g.isDisposed&&g.replacedBy?g.replacedBy:g).filter(g=>!g.isDestroyed&&!g.isCrashing)}isSelected(g){return this.selectedUnits.has(g)}})}}}),System.register("game/gameobject/Smudge",["engine/type/ObjectType","game/gameobject/GameObject"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.GameObject{static factory(g,P,I){return new this(g,P,I)}constructor(g,P,L){super(I.ObjectType.Smudge,g,P,L)}getFoundation(){return{width:this.rules.width,height:this.rules.height}}},g("Smudge",_)}}}),System.register("game/gameobject/task/AttackTask",["game/gameobject/task/system/Task","game/gameobject/unit/RangeHelper","game/gameobject/task/system/WaitMinutesTask","game/WeaponType","game/gameobject/task/move/MoveInWeaponRangeTask","game/gameobject/unit/FacingUtil","game/gameobject/task/TurnTask","game/gameobject/task/system/WaitTicksTask","game/gameobject/trait/AttackTrait","game/gameobject/GameObject","game/gameobject/unit/LosHelper","game/gameobject/trait/MoveTrait","game/GameSpeed","game/Coords","engine/type/ObjectType","game/map/tileFinder/RadialTileFinder","game/gameobject/unit/MovePositionHelper","game/gameobject/unit/ZoneType","game/type/MovementZone","game/gameobject/task/system/TaskStatus","game/gameobject/task/move/MoveTask","game/math/Vector3","game/math/Vector2"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g}],execute:function(){le=4*11.25,ce=class o extends I.Task{constructor(g,P,I,_={}){super(),this.game=g,this.target=P,this.weapon=I,this.options=_,this.moveExecuted=!1,this.moveAttempts=0,this.rangeCheckCooldown=0,this.lastInRangeTargetPosition=new ne.Vector3,this.lastInRangeSelfPosition=new ne.Vector3,this.initialIndirectTarget=!1,this.forceDropTarget=!1,this.rangeHelper=new L.RangeHelper(g.map.tileOccupation),this.losHelper=new $.LosHelper(g.map.tiles,g.map.tileOccupation),this.targetLinesConfig={pathNodes:[]},this.updateTargetLines(this.target,!0)}duplicate(){return new o(this.game,this.target,this.weapon,this.options)}getWeapon(){return this.weapon}setWeapon(g){this.weapon=g}setForceAttack(g){this.options.force=g}requestTargetUpdate(g){this.target.equals(g)||(this.needsTargetUpdate=g)}onTargetChange(g){let P=g.attackTrait,I=this.target;P.currentTarget=I,this.lastValidTargetPosition=I.obj?{tile:I.tile,onBridge:I.getBridge()}:void 0,this.initialTargetOwner=I.obj?.isTechno()?I.obj.owner:void 0,this.initialIndirectTarget=!I.obj&&this.game.map.tileOccupation.getObjectsOnTile(I.tile).some(g=>g.isOverlay()&&!g.isBridgePlaceholder()||g.isTerrain()),this.updateTargetLines(I,!0)}updateTargetLines(g,P){this.targetLinesConfig.target=g.obj,this.targetLinesConfig.pathNodes=g.obj?[]:[{tile:g.tile,onBridge:g.getBridge()}],this.targetLinesConfig.isAttack=P}onStart(g){if(!g.attackTrait)throw new Error(`Object ${g.name} has no attack trait`);if(0!==g.ammo){let L=this.game.map.tileOccupation;var P,I;g.attackTrait.attackState=K.AttackState.CheckRange,this.onTargetChange(g),this.initialSelfPosition={tile:g.tile,onBridge:g.isUnit()&&g.onBridge?L.getBridgeOnTile(g.tile):void 0},this.weapon.rules.limboLaunch&&g.isUnit()&&!this.target.obj&&(this.forceDropTarget=!0,({reachable:P,fallback:I}=this.findReachableMeleePosition(this.target.tile,!!this.target.getBridge(),{width:1,height:1},g)),!P&&I&&(this.lastValidTargetPosition=I,this.updateTargetLines(this.game.createTarget(I.onBridge,I.tile),!1))),this.weapon.rules.limboLaunch&&this.target.obj?.isTechno()&&g.isUnit()&&!this.rangeHelper.isInWeaponRange(g,this.target.obj,this.weapon,this.game.rules)&&(({reachable:P,fallback:I}=this.findReachableMeleePosition(this.target.obj.tile,this.target.obj.isUnit()&&this.target.obj.onBridge,this.target.obj.getFoundation(),g)),P||(1<(g.unitOrderTrait.waypointPath?.waypoints?.length??0)?this.cancel():(this.forceDropTarget=!0,I&&(this.lastValidTargetPosition=I,this.updateTargetLines(this.game.createTarget(I.onBridge,I.tile),!1))))),this.rangeHelper.isInWeaponRange(g,this.target.obj??this.target.tile,this.weapon,this.game.rules)&&g.isUnit()&&g.rules.movementZone===re.MovementZone.Fly&&g.zone!==te.ZoneType.Air&&(g.rules.hoverAttack||g.isAircraft())&&this.children.push(new ae.MoveTask(this.game,g.tile,!1).setCancellable(!1))}else this.cancel()}findReachableMeleePosition(g,P,I,L){let _,U=this.game.map,G=U.tileOccupation,V=P?G.getBridgeOnTile(g):void 0,W=new ee.MovePositionHelper(U),z=L.rules.movementZone===re.MovementZone.Fly,c=(P,I)=>z||0<U.terrain.getPassableSpeed(P,L.rules.speedType,L.isInfantry(),!!I)&&W.isEligibleTile(P,I,V,g)&&!U.terrain.findObstacles({tile:P,onBridge:I},L).length,K=new J.RadialTileFinder(U.tiles,U.mapBounds,g,I,1,Math.ceil(this.weapon.rules.range),P=>{let I=!1;var U;return c(P,void 0)&&(_=_??{tile:P,onBridge:void 0},I=!0),void 0!==P.onBridgeLandType&&(U=G.getBridgeOnTile(P),c(P,U)&&(_=_??{tile:P,onBridge:U},I=!0)),!!I&&this.rangeHelper.isInWeaponRange(L,g,this.weapon,this.game.rules,P)});return{reachable:K.getNextTile(),fallback:_}}onEnd(g){g.isVehicle()&&g.turretTrait&&(g.turretTrait.desiredFacing=g.direction),g.attackTrait.attackState=K.AttackState.Idle,g.attackTrait.currentTarget=void 0;var P=this.game.rules.general.prism.type;g.isBuilding()&&g.name===P&&this.weapon.type!==U.WeaponType.Secondary&&this.countSupportBeamsAndFireDownTowers(g,P),this.weapon.rules.limboLaunch&&g.attackTrait.expirePassiveScanCooldown(),(g.isInfantry()||g.isVehicle())&&(g.isFiring=!1),this.weapon.hasBurstsLeft()&&this.weapon.resetBursts()}forceCancel(g){if(g.rules.movementZone!==re.MovementZone.Fly)return!1;if(!this.cancellable||this.children.some(g=>!g.cancellable))return!1;if(this.status===se.TaskStatus.Running||this.status===se.TaskStatus.Cancelling){if(this.children.filter(g=>g instanceof ae.MoveTask).some(P=>!P.forceCancel(g)))return!1;this.onEnd(g),(g.isInfantry()||g.isVehicle())&&(g.isFiring=!1)}return this.status=se.TaskStatus.Cancelled,!0}onTick(g){let P=g.attackTrait;(g.isInfantry()||g.isVehicle())&&P.attackState!==K.AttackState.Firing&&(g.isFiring=!1);let I=this.target.obj,L=this.children.find(g=>g instanceof G.MoveInWeaponRangeTask);if(this.isCancelling()&&P.attackState!==K.AttackState.FireUp)return!g.airSpawnTrait?.isLaunchingMissiles()&&(L?.cancel(),!0);let $=!1;if(P.attackState===K.AttackState.FireUp){if(P.isDisabled())return!0;P.attackState=K.AttackState.Firing,$=!0}if(P.attackState===K.AttackState.Firing){if(this.initialIndirectTarget&&!this.game.map.getObjectsOnTile(this.target.tile).find(g=>g.isOverlay()&&!g.isBridgePlaceholder()||g.isTerrain()))return this.cancel(),this.onTick(g);if($){var X=this.target.obj||this.target.tile;if(!this.game.isValidTarget(this.target.obj)||this.shouldDropTarget(this.target.obj)||!this.weapon.targeting.canTarget(this.target.obj,this.target.tile,this.game,!!this.options.force,!!this.options.passive)||!this.rangeHelper.isInWeaponRange(g,X,this.weapon,this.game.rules)||!this.losHelper.hasLineOfSight(g,X,this.weapon))return P.attackState=K.AttackState.CheckRange,this.onTick(g)}if(this.weapon.rules.limboLaunch){if((I?.isVehicle()||I?.isAircraft())&&I.parasiteableTrait?.isInfested())return!0;if(g.rules.movementZone!==re.MovementZone.Fly&&I?.isUnit()&&I.zone===te.ZoneType.Air)return!0}if(this.target.tile.onBridgeLandType&&g.tile.onBridgeLandType&&g.isUnit()&&(this.game.map.tileOccupation.getBridgeOnTile(this.target.tile)?.isHighBridge()||this.game.map.tileOccupation.getBridgeOnTile(g.tile)?.isHighBridge())&&(I?I.isUnit()&&(I.zone===te.ZoneType.Air||I.onBridge):this.target.isBridge())!==(g.zone===te.ZoneType.Air||g.onBridge))return!0;let _=1;if(X=this.game.rules.general.prism.type,g.isBuilding()&&g.name===X&&this.weapon.type!==U.WeaponType.Secondary&&(_=1+(X=this.countSupportBeamsAndFireDownTowers(g,X))*this.game.rules.general.prism.supportModifier),this.weapon.rules.spawner&&(g.isVehicle()||g.isAircraft())&&g.parasiteableTrait?.isParalyzed())return!0;if(0===g.ammo)return g.isAircraft()&&(g.rules.fighter||g.rules.spawned)&&L?.cancel(),!0;let G=!1;if(this.weapon.rules.limboLaunch){let I=L;if(!I){let L=g.unitOrderTrait.getCurrentTask();if(L&&L!==this&&P.getOpportunityFireTask()===this){if(!(L instanceof ae.MoveTask))return L.cancel(),!1;I=L}}if(I){if(!I.forceCancel(g))return!1;g.moveTrait.lastTargetOffset=void 0,g.moveTrait.lastVelocity=void 0}G=!0}return this.weapon.fire(this.target,this.game,_),!!G||(!!this.weapon.rules.fireOnce||!(!this.options.passive||!g.rules.distributedFire)||(P.attackState=K.AttackState.JustFired,!1))}if(P.attackState===K.AttackState.JustFired)return P.attackState=K.AttackState.PrepareToFire,this.onTick(g);this.needsTargetUpdate&&(this.target=this.needsTargetUpdate,I=this.target.obj,this.needsTargetUpdate=void 0,this.onTargetChange(g),I||L?.retarget(this.target.tile,!!this.target.getBridge())),I?.isTechno()&&I.replacedBy&&(ee=this.game.createTarget(I.replacedBy,I.replacedBy.tile),this.target=ee,I=I.replacedBy,this.onTargetChange(g));let J=this.game.isValidTarget(I)&&!this.shouldDropTarget(I);if(J){let L=this.weapon.targeting.canTarget(I,this.target.tile,this.game,!!this.options.force,!!this.options.passive);if(!L||!g.armedTrait.isEquippedWithWeapon(this.weapon)){var ee=P.selectWeaponVersus(g,this.target,this.game,this.options.force,this.options.passive);if(ee){if(this.setWeapon(ee),P.attackState!==K.AttackState.CheckRange)return P.attackState=K.AttackState.CheckRange,this.onTick(g);L=!0}else L=!1}J=L}if(J&&(se=this.lastTargetTpCheck,I?.isUnit()&&se&&I.moveTrait.lastTeleportTick>=se?(J=!1,this.rangeCheckCooldown=0):this.lastTargetTpCheck=this.game.currentTick),J&&I&&(this.lastValidTargetPosition={tile:I.tile,onBridge:this.target.getBridge()}),J||(this.targetLinesConfig.isAttack=!1),P.attackState===K.AttackState.CheckRange){if(0<this.rangeCheckCooldown)return this.rangeCheckCooldown--,!1;let U=this.target.obj?J?this.target.obj:this.lastValidTargetPosition.tile:this.target.tile;var se=this.target.obj?J?this.target.obj.isBuilding()?this.target.obj.centerTile:this.target.obj.tile:this.lastValidTargetPosition.tile:this.target.tile;if(!this.rangeHelper.isInWeaponRange(g,U,this.weapon,this.game.rules)||!this.losHelper.hasLineOfSight(g,U,this.weapon)||g.isUnit()&&g.rules.balloonHover&&!g.rules.hoverAttack&&!L&&g.tile!==se&&!this.options.holdGround||g.isAircraft()&&this.weapon.projectileRules.iniRot<=1&&!L){if(g.isUnit()&&!this.options.holdGround&&this.game.map.isWithinBounds(se)){if(L){if(L.target!==this.target.obj||J)if(J&&this.target.obj&&this.rangeHelper.tileDistance(this.target.obj,this.lastSelfMoveTargetTile)>this.weapon.range)L.retarget(this.target.obj,!!this.target.getBridge()),this.lastSelfTileBeforeMove=g.tile,this.lastSelfMoveTargetTile=this.target.obj?.tile??this.target.tile;else{if(void 0!==this.options.leashTiles&&this.rangeHelper.tileDistance(this.initialSelfPosition.tile,g.tile)>this.options.leashTiles)return L.cancel(),!0;var ce=U instanceof q.GameObject&&U.isUnit()?U.moveTrait.baseSpeed:0,he=Math.ceil((this.rangeHelper.tileDistance(g,U)-(this.weapon.range+1))/((g.moveTrait.baseSpeed+ce)/Z.Coords.LEPTONS_PER_TILE));0<he&&(this.rangeCheckCooldown=Math.min(Y.GameSpeed.BASE_TICKS_PER_SECOND,he))}else{let g;g=void 0!==this.options.leashTiles?this.game.createTarget(this.initialSelfPosition.onBridge,this.initialSelfPosition.tile):this.game.createTarget(this.lastValidTargetPosition.onBridge,this.lastValidTargetPosition.tile),P.currentTarget=g,L.retarget(g.tile,g.isBridge()),this.updateTargetLines(g,!1)}return!1}return!(g.moveTrait&&!g.moveTrait.isDisabled())||(!!this.isCancelling()||(g.tile===this.lastSelfTileBeforeMove||this.moveExecuted&&g.moveTrait.lastMoveResult===Q.MoveResult.Fail?this.moveAttempts++:this.moveAttempts=0,!!(this.weapon.rules.limboLaunch&&g.defaultToGuardArea&&I&&this.moveExecuted&&g.moveTrait.lastMoveResult===Q.MoveResult.Fail&&this.rangeHelper.isInRange(g,I,0,g.armedTrait.computeGuardScanRange(this.weapon),!0))||(this.moveAttempts>3||(0<this.moveAttempts&&this.children.push(new _.WaitMinutesTask(1/60)),ce=U,he=I&&!J?this.lastValidTargetPosition.onBridge:this.target.getBridge(),L=new G.MoveInWeaponRangeTask(this.game,ce,!!he,this.weapon),L.blocking=!1,this.children.push(L),this.moveExecuted=!0,this.lastSelfTileBeforeMove=g.tile,this.lastSelfMoveTargetTile=ce instanceof q.GameObject?ce.tile:ce,this.onTick(g)))))}return!0}if(this.moveExecuted=!1,this.moveAttempts=0,L&&(g.rules.balloonHover&&!g.rules.hoverAttack||g.rules.fighter||g.rules.spawned||g.rules.movementZone===re.MovementZone.Fly&&!this.rangeHelper.isInRange2(g,this.target.obj??this.target.tile,this.weapon.minRange,this.weapon.range-1)||L.cancel()),L&&(g.isInfantry()||this.weapon.rules.spawner))return!1;if(L?.children.some(g=>!g.cancellable)&&this.weapon.rules.limboLaunch)return!1;if(L&&L.shouldAirStrafe(g)&&this.target.obj?.isUnit()&&this.target.obj.moveTrait.isMoving()&&1<this.weapon.range&&!this.rangeHelper.isInRange2(g,this.target.obj,this.weapon.minRange,this.weapon.range-1))return!1;P.attackState=K.AttackState.PrepareToFire}if(P.attackState!==K.AttackState.PrepareToFire)return!1;if(!J||P.isDisabled())return L?.cancel(),!0;if(he=this.target.getWorldCoords(),ce=g.position.worldPosition,!(this.lastInRangeTargetPosition.length()&&this.lastInRangeTargetPosition.equals(he)&&this.lastInRangeSelfPosition.length()&&this.lastInRangeSelfPosition.equals(ce)))return this.lastInRangeTargetPosition.copy(he),this.lastInRangeSelfPosition.copy(ce),P.attackState=K.AttackState.CheckRange,this.onTick(g);if(!(this.weapon.rules.omniFire||g.rules.omniFire&&g.rules.fighter)){ce=(new ne.Vector3).copy(he).sub(ce);var ue=V.FacingUtil.fromMapCoords(new oe.Vector2(ce.x,ce.z));ce=this.weapon.projectileRules.rot?le:11.25;if((g.isVehicle()||g.isBuilding())&&g.turretTrait){if(g.turretTrait.desiredFacing=ue,Math.abs(ue-g.turretTrait.facing)>=ce)return!1}else if(Math.abs(ue-g.direction)>=ce){if(g.isAircraft())return g.direction=V.FacingUtil.tick(g.direction,ue,g.rules.rot).facing,!1;if(L)return!1;if(this.options.disallowTurning)return!0;if(g.isVehicle())return this.children.push(new W.TurnTask(ue)),!1;g.direction=ue}}return this.losHelper.hasLineOfSight(g,this.target.obj||this.target.tile,this.weapon)?!P.isOnCooldown(g)&&((!this.weapon.warhead.rules.temporal||g.temporalTrait.getTarget()!==this.target.obj)&&(this.weapon.rules.suicide&&this.weapon.type!==U.WeaponType.DeathWeapon?(this.game.destroyObject(g,{player:g.owner,obj:g,weapon:this.weapon}),!0):(ue=this.game.rules.general.prism.type,g.isBuilding()&&g.name===ue&&this.weapon.type!==U.WeaponType.Secondary&&this.fireUpPrismSupportTowers(g,ue),(g.isInfantry()||g.isVehicle())&&(g.isFiring=!0),g.art.fireUp?(g.isInfantry()&&g.suppressionTrait?.isSuppressed()||this.children.push(new z.WaitTicksTask(g.art.fireUp).setCancellable(!1)),P.attackState=K.AttackState.FireUp,!1):(P.attackState=K.AttackState.Firing,this.onTick(g))))):(P.attackState=K.AttackState.CheckRange,this.onTick(g))}shouldDropTarget(g){return this.forceDropTarget||g?.isTechno()&&(this.weapon.rules.limboLaunch&&((g.isVehicle()||g.isAircraft())&&g.parasiteableTrait?.isInfested()||g.invulnerableTrait.isActive())||g.warpedOutTrait.isInvulnerable()&&!this.weapon.warhead.rules.temporal||this.initialTargetOwner!==g.owner)}fireUpPrismSupportTowers(g,P){var I;for(I of g.owner.getOwnedObjectsByType(X.ObjectType.Building).filter(g=>g.name===P&&g.secondaryWeapon&&!g.unitOrderTrait.hasTasks()&&g.attackTrait&&!g.attackTrait.isDisabled()&&!g.attackTrait.isOnCooldown(g)).filter(P=>this.rangeHelper.isInWeaponRange(P,g,P.secondaryWeapon,this.game.rules)).slice(0,this.game.rules.general.prism.supportMax))I.unitOrderTrait.addTask(I.attackTrait.createAttackTask(this.game,g,g.centerTile,I.secondaryWeapon,{passive:!0}))}countSupportBeamsAndFireDownTowers(g,P){var I,L=g.owner.getOwnedObjectsByType(X.ObjectType.Building).filter(I=>I.name===P&&I.attackTrait?.currentTarget?.obj===g);for(I of L)I.unitOrderTrait.getCurrentTask()?.cancel();return Math.min(this.game.rules.general.prism.supportMax,L.length)}getTargetLinesConfig(){return this.targetLinesConfig}},g("AttackTask",ce)}}}),System.register("game/gameobject/task/CaptureBuildingTask",["game/gameobject/Building","game/event/BuildingCaptureEvent","game/Warhead","game/gameobject/unit/CollisionType","game/gameobject/unit/ZoneType","game/gameobject/task/EnterBuildingTask","game/SpecialWarheadType"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g}],execute:function(){z=class extends V.EnterBuildingTask{isAllowed(g){return g.rules.engineer&&this.target.rules.capturable&&!this.target.isDestroyed&&this.target.buildStatus!==I.BuildStatus.BuildDown&&!this.game.areFriendly(g,this.target)}onEnter(g){if(this.game.unspawnObject(g),this.game.gameOpts.multiEngineer){var P=this.game.rules.general;if((!this.target.rules.needsEngineer||!P.engineerAlwaysCaptureTech)&&this.target.healthTrait.health>100*P.engineerCaptureLevel){var I=Math.floor(P.engineerDamage*this.target.healthTrait.maxHitPoints);P=Math.floor((1-Math.floor(1/P.engineerDamage)*P.engineerDamage)*this.target.healthTrait.maxHitPoints);if(0<(I=Math.min(I,this.target.healthTrait.getHitPoints()-P))){return P=this.game.rules.combatDamage.c4Warhead,void new _.Warhead(this.game.rules.getWarhead(P)).detonate(this.game,I,this.target.tile,0,this.target.position.worldPosition,G.ZoneType.Ground,U.CollisionType.None,this.game.createTarget(this.target,this.target.tile),{player:g.owner,obj:g,weapon:void 0},W.SpecialWarheadType.None,void 0,0)}}}g.owner.buildingsCaptured++,this.game.changeObjectOwner(this.target,g.owner),this.game.events.dispatch(new L.BuildingCaptureEvent(this.target))}},g("CaptureBuildingTask",z)}}}),System.register("game/gameobject/task/CheerTask",["game/gameobject/task/system/Task","game/art/SequenceType","game/gameobject/infantry/StanceType","game/gameobject/task/system/WaitMinutesTask"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=class extends I.Task{constructor(){super(),this.executed=!1,this.cancellable=!1}onTick(g){return this.executed?(g.stance=_.StanceType.None,!0):!g.isInfantry()||!g.art.sequences.has(L.SequenceType.Cheer)||g.stance!==_.StanceType.None&&g.stance!==_.StanceType.Guard||(g.stance=_.StanceType.Cheer,this.children.push(new U.WaitMinutesTask(1/60).setCancellable(!1)),!(this.executed=!0))}},g("CheerTask",G)}}}),System.register("game/gameobject/task/EnterBuildingTask",["game/gameobject/task/system/Task","game/gameobject/task/move/MoveOutsideTask","game/gameobject/task/move/MoveInsideTask","game/event/EnterObjectEvent"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=class extends I.Task{constructor(g,P){super(),this.game=g,this.target=P,this.aborted=!1,this.movePerformed=!1,this.preventOpportunityFire=!1}onTick(g){return!(!(this.isCancelling()&&!this.movePerformed||this.aborted||g.moveTrait.isDisabled())&&(this.movePerformed&&this.children.length?(g.tile===this.lastOutsideTile||this.game.map.tileOccupation.isTileOccupiedBy(g.tile,this.target)||(this.lastOutsideTile=g.tile),1):this.game.map.tileOccupation.isTileOccupiedBy(g.tile,this.target)?!this.isAllowed(g)||this.isCancelling()?(this.children.push(new L.MoveOutsideTask(this.game,this.target,this.lastOutsideTile)),this.aborted=!0):(this.game.events.dispatch(new U.EnterObjectEvent(this.target,g)),!1===this.onEnter(g)&&(this.children.push(new L.MoveOutsideTask(this.game,this.target,this.lastOutsideTile)),this.aborted=!0)):!this.movePerformed&&(this.children.push(new _.MoveInsideTask(this.game,this.target).setBlocking(!1)),this.movePerformed=!0,this.preventOpportunityFire=!0)))}getTargetLinesConfig(g){return{target:this.target,pathNodes:[]}}},g("EnterBuildingTask",G)}}}),System.register("game/gameobject/task/EnterHospitalTask",["game/gameobject/task/system/Task","game/gameobject/task/move/MoveOutsideTask","game/gameobject/task/move/MoveInsideTask","game/type/MovementZone","game/gameobject/unit/MovePositionHelper","game/map/tileFinder/RadialTileFinder","game/gameobject/task/move/MoveTask","game/gameobject/task/system/CallbackTask","game/gameobject/trait/MoveTrait","game/event/EnterObjectEvent"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g}],execute:function(){var P;(P=$=$||{})[P.MoveToQueueingTile=0]="MoveToQueueingTile",P[P.WaitForTurn=1]="WaitForTurn",P[P.MoveToTarget=2]="MoveToTarget",P[P.EnterTarget=3]="EnterTarget",P[P.ClearTarget=4]="ClearTarget",Q=class extends I.Task{constructor(g,P){super(),this.game=g,this.target=P,this.movePerformed=!1}isAllowed(g){return g.rules.movementZone!==U.MovementZone.Fly&&g.healthTrait.health<100&&this.target.hospitalTrait&&!this.target.isDestroyed&&!this.target.warpedOutTrait.isActive()&&this.game.areFriendly(g,this.target)&&(!this.target.ammoTrait||0<this.target.ammoTrait.ammo)}onStart(g){if(!this.target.hospitalTrait)throw new Error(`Target ${this.target.name} is not a valid hospital`);0<this.target.hospitalTrait.addToHealQueue(g)?this.state=$.MoveToQueueingTile:this.state=$.MoveToTarget}onEnd(g){!this.target.isDestroyed&&g.isSpawned&&this.target.hospitalTrait.removeFromHealQueue(g)}onTick(g){if(this.isCancelling()&&this.state!==$.EnterTarget||this.state===$.ClearTarget||g.moveTrait.isDisabled())return!0;if(this.state===$.MoveToQueueingTile){let I=new G.MovePositionHelper(this.game.map);var P=new V.RadialTileFinder(this.game.map.tiles,this.game.map.mapBounds,this.target.tile,this.target.getFoundation(),1,1,P=>0<this.game.map.terrain.getPassableSpeed(P,g.rules.speedType,g.isInfantry(),!1)&&I.isEligibleTile(P,void 0,void 0,this.target.tile)).getNextTile();return!P||(this.children.push(new W.MoveTask(this.game,P,!1,{closeEnoughTiles:5})),this.children.push(new z.CallbackTask(()=>{[K.MoveResult.Success,K.MoveResult.CloseEnough].includes(g.moveTrait.lastMoveResult)||this.cancel()})),this.state=$.WaitForTurn,this.queueingTile=P,!1)}if(this.state===$.WaitForTurn){if(!this.target.hospitalTrait.unitIsFirstInHealQueue(g))return!1;this.queueingTile=void 0,this.state=$.MoveToTarget}if(this.state===$.MoveToTarget){if(this.movePerformed&&this.children.length)return g.tile===this.lastOutsideTile||this.game.map.tileOccupation.isTileOccupiedBy(g.tile,this.target)||(this.lastOutsideTile=g.tile),!1;if(!this.isAllowed(g))return!0;if(!this.game.map.tileOccupation.isTileOccupiedBy(g.tile,this.target))return!(!this.movePerformed&&(this.children.push(new _.MoveInsideTask(this.game,this.target).setBlocking(!1)),this.movePerformed=!0));this.state=$.EnterTarget}return this.state===$.EnterTarget&&(!this.isAllowed(g)||this.isCancelling()?(this.children.push(new L.MoveOutsideTask(this.game,this.target,this.lastOutsideTile)),this.state=$.ClearTarget,!1):(this.game.limboObject(g,{selected:!1,controlGroup:this.game.getUnitSelection().getOrCreateSelectionModel(g).getControlGroupNumber()}),this.target.hospitalTrait.startHealing(g),this.game.events.dispatch(new q.EnterObjectEvent(this.target,g)),!0))}getTargetLinesConfig(g){return{target:this.queueingTile?void 0:this.target,pathNodes:this.queueingTile?[{tile:this.queueingTile,onBridge:void 0}]:[]}}},g("EnterHospitalTask",Q)}}}),System.register("game/gameobject/task/EnterRecyclerTask",["game/gameobject/Building","game/type/LocomotorType","game/type/MovementZone","game/event/UnitRecycleEvent","game/gameobject/task/EnterBuildingTask"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){V=class extends G.EnterBuildingTask{isAllowed(g){return g.rules.movementZone!==_.MovementZone.Fly&&g.rules.locomotor!==L.LocomotorType.Chrono&&!g.rules.engineer&&0<this.game.sellTrait.computeRefundValue(g)&&(g.isInfantry()&&this.target.rules.cloning||this.target.rules.grinding)&&!this.target.isDestroyed&&this.target.buildStatus===I.BuildStatus.Ready&&g.owner===this.target.owner}onEnter(g){this.game.sellTrait.sell(g),this.game.events.dispatch(new U.UnitRecycleEvent(g))}},g("EnterRecyclerTask",V)}}}),System.register("game/gameobject/task/EnterTransportTask",["game/gameobject/task/system/Task","game/gameobject/task/move/MoveOutsideTask","game/gameobject/task/move/MoveInsideTask","game/event/EnterTransportEvent","game/gameobject/unit/ZoneType","game/gameobject/trait/MoveTrait","game/map/tileFinder/RadialTileFinder","game/gameobject/unit/MovePositionHelper","game/gameobject/task/move/MoveTask","game/gameobject/task/system/CallbackTask","game/event/EnterObjectEvent"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g}],execute:function(){var P;(P=Q=Q||{})[P.MoveToQueueingTile=0]="MoveToQueueingTile",P[P.WaitForTurn=1]="WaitForTurn",P[P.MoveToTransport=2]="MoveToTransport",P[P.EnterTransport=3]="EnterTransport",P[P.ClearTransport=4]="ClearTransport",Y=class extends I.Task{constructor(g,P){super(),this.game=g,this.target=P,this.movePerformed=!1,this.preventOpportunityFire=!1}isAllowed(g){return!this.target.isDestroyed&&!this.target.isCrashing&&this.game.areFriendly(this.target,g)&&g.zone!==G.ZoneType.Air&&this.target.zone!==G.ZoneType.Air&&this.target.transportTrait.unitFitsInside(g)&&this.target.moveTrait.moveState===V.MoveState.Idle&&!this.target.warpedOutTrait.isActive()&&!g.mindControllableTrait?.isActive()&&!g.mindControllerTrait?.isActive()}onStart(g){if(!this.target.transportTrait)throw new Error(`Unit ${this.target.name} is not a valid transport`);this.initialTargetTile=this.target.tile,0<this.target.transportTrait.addToLoadQueue(g)?this.state=Q.MoveToQueueingTile:this.state=Q.MoveToTransport}onEnd(g){this.target.isDestroyed||this.target.transportTrait?.removeFromLoadQueue(g)}onTick(g){if(this.isCancelling()&&this.state!==Q.EnterTransport||this.state===Q.ClearTransport||g.moveTrait.isDisabled())return!0;if(this.target.tile!==this.initialTargetTile||this.target.moveTrait.moveState!==V.MoveState.Idle)return!0;if(this.state===Q.MoveToQueueingTile){let I,L=new z.MovePositionHelper(this.game.map),_=this.target.onBridge?this.game.map.tileOccupation.getBridgeOnTile(this.target.tile):void 0;var P=new W.RadialTileFinder(this.game.map.tiles,this.game.map.mapBounds,this.target.tile,this.target.getFoundation(),1,1,P=>{let U=[this.game.map.tileOccupation.getBridgeOnTile(P)];for(var G of(U[0]&&U.push(void 0),U))if(0<this.game.map.terrain.getPassableSpeed(P,g.rules.speedType,g.isInfantry(),!!G)&&L.isEligibleTile(P,G,_,this.target.tile))return I=G,!0;return!1}).getNextTile();return!P||(this.children.push(new K.MoveTask(this.game,P,!!I,{closeEnoughTiles:5})),this.children.push(new q.CallbackTask(()=>{[V.MoveResult.Success,V.MoveResult.CloseEnough].includes(g.moveTrait.lastMoveResult)||this.cancel()})),this.queueingNode={tile:P,onBridge:I},this.state=Q.WaitForTurn,!1)}if(this.state===Q.WaitForTurn){if(!this.target.transportTrait.unitIsFirstInLoadQueue(g))return!1;this.queueingNode=void 0,this.state=Q.MoveToTransport}if(this.state===Q.MoveToTransport){if(!this.isAllowed(g))return!0;if(!this.game.map.tileOccupation.isTileOccupiedBy(g.tile,this.target))return!(!this.movePerformed&&(this.children.push(new _.MoveInsideTask(this.game,this.target)),this.movePerformed=!0,this.preventOpportunityFire=!0));this.state=Q.EnterTransport}return this.state===Q.EnterTransport&&(!this.isAllowed(g)||this.isCancelling()?(this.children.push(new L.MoveOutsideTask(this.game,this.target)),this.state=Q.ClearTransport,!1):(this.game.limboObject(g,{selected:!1,controlGroup:this.game.getUnitSelection().getOrCreateSelectionModel(g).getControlGroupNumber(),inTransport:!0}),this.game.events.dispatch(new U.EnterTransportEvent(this.target)),this.game.events.dispatch(new $.EnterObjectEvent(this.target,g)),this.target.transportTrait.units.push(g),!0))}getTargetLinesConfig(g){return{target:this.queueingNode?void 0:this.target,pathNodes:this.queueingNode?[this.queueingNode]:[]}}},g("EnterTransportTask",Y)}}}),System.register("game/gameobject/task/EvacuateTransportTask",["game/event/LeaveTransportEvent","game/gameobject/unit/FacingUtil","game/gameobject/unit/MovePositionHelper","game/gameobject/task/move/MoveTask","game/gameobject/task/ScatterTask","game/gameobject/task/system/Task","game/gameobject/task/TurnTask","game/gameobject/task/system/WaitMinutesTask","game/gameobject/unit/ZoneType","game/gameobject/task/system/CallbackTask"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g}],execute:function(){var P;(P=$=$||{})[P.None=0]="None",P[P.OnlyPassengers=1]="OnlyPassengers",P[P.All=2]="All",Q=class extends V.Task{constructor(g,P){super(),this.game=g,this.soft=P,this.evacState=$.None,this.evacTries=0,this.turnPerformed=!1,this.preventLanding=!1}forceEvac(){this.evacState=$.All}onStart(g){if(!g.transportTrait)throw new Error(`Object "${g.name}" is not a valid transport`);var P=g.transportTrait;0<P.units.length&&(this.evacState=this.evacState!==$.OnlyPassengers&&1!==P.units.length||!g.rules.gunner?$.OnlyPassengers:$.All)}onTick(g){if(this.isCancelling()||this.evacState===$.None)return!0;if(g.zone===K.ZoneType.Air)return this.children.push(new q.CallbackTask(()=>g.zone!==K.ZoneType.Air)),!1;let P=g.transportTrait.units;if(!P.length||g.rules.gunner&&1===P.length&&this.evacState!==$.All)return!0;var I=P[P.length-1],L=this.findValidEvacTarget(g,I);if(L&&!this.turnPerformed){this.turnPerformed=!0;var _=(L.dir+180)%360;if(g.direction!==_)return this.children.push(new W.TurnTask(_)),!1}return this.evacuateUnit(I,g,L)?(P.pop(),this.children.push(new z.WaitMinutesTask(1/60)),!1):!(++this.evacTries<=3&&(this.children.push(new z.WaitMinutesTask(.05)),1))}evacuateUnit(g,P,L){if(!L)return!this.soft&&(g.position.tile=P.tile,g.position.tileElevation=P.tileElevation,g.onBridge=P.onBridge,g.zone=P.zone,this.game.destroyObject(g,{player:g.owner}),!0);var{spawnNode:_,moveNode:V}=L;return g.position.tileElevation=_.onBridge?.tileElevation??0,g.onBridge=!!_.onBridge,g.zone=this.game.map.getTileZone(_.tile,!_.onBridge),this.game.unlimboObject(g,_.tile),g.unitOrderTrait.unmarkNextQueuedOrder(),V?g.unitOrderTrait.addTask(new U.MoveTask(this.game,V.tile,!!V.onBridge)):g.unitOrderTrait.addTask(new G.ScatterTask(this.game)),this.game.events.dispatch(new I.LeaveTransportEvent(P)),!0}findValidEvacTarget(g,P){let I=this.game.map,U=new _.MovePositionHelper(I);var G,V,W,z,K,q=g.onBridge?I.tileOccupation.getBridgeOnTile(g.tile):void 0,$=(g.direction+180)%360;let Q;for(let _=0;_<=180;_+=45)for(G of _&&_<180?[$+_,$-_]:[$+_]){var Y=L.FacingUtil.toMapCoords(G);let _,$=g.tile,te=q;for(let L=1;L<=2;L++){if(2===L){if(!_)break;$=_.tile,te=_.onBridge}var Z,X=g.tile.rx+Math.sign(Y.x)*L,J=g.tile.ry+Math.sign(Y.y)*L,ee=I.tiles.getByMapCoords(X,J);if(!ee||!I.mapBounds.isWithinBounds(ee))break;let q=[I.tileOccupation.getBridgeOnTile(ee)];for(Z of(q[0]&&q.push(void 0),q))if(V=ee,W=Z,z=te,K=$,0<I.terrain.getPassableSpeed(V,P.rules.speedType,P.isInfantry(),!!W)&&U.isEligibleTile(V,W,z,K)&&!I.terrain.findObstacles({tile:V,onBridge:W},P).length){if(1!==L)return{spawnNode:_,moveNode:{tile:ee,onBridge:Z},dir:G};_={tile:ee,onBridge:Z},Q={spawnNode:_,moveNode:void 0,dir:G}}}}if(Q)return Q}},g("EvacuateTransportTask",Q)}}}),System.register("game/gameobject/task/GarrisonBuildingTask",["game/event/BuildingGarrisonEvent","game/gameobject/task/EnterBuildingTask"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.EnterBuildingTask{isAllowed(g){return!this.target.isDestroyed&&!!this.target.garrisonTrait?.canBeOccupied()&&this.target.garrisonTrait.units.length<this.target.garrisonTrait.maxOccupants&&!(this.target.garrisonTrait.units.length&&this.target.garrisonTrait.units[0].owner!==g.owner)&&!g.mindControllableTrait?.isActive()}onEnter(g){this.game.limboObject(g,{selected:!1,controlGroup:this.game.getUnitSelection().getOrCreateSelectionModel(g).getControlGroupNumber()});let P=this.target.garrisonTrait;P.units.length||(g.owner.buildingsCaptured++,this.game.changeObjectOwner(this.target,g.owner),this.game.events.dispatch(new I.BuildingGarrisonEvent(this.target))),P.units.push(g)}},g("GarrisonBuildingTask",_)}}}),System.register("game/gameobject/task/harvester/GatherOreTask",["game/gameobject/task/system/Task","game/map/tileFinder/RadialTileFinder","game/gameobject/trait/HarvesterTrait","game/type/LandType","game/gameobject/task/move/MoveTask","game/gameobject/trait/TiberiumTrait","game/gameobject/task/system/WaitMinutesTask","game/gameobject/task/harvester/ReturnOreTask","game/gameobject/unit/RangeHelper","game/gameobject/task/system/CallbackTask","game/gameobject/trait/MoveTrait","game/type/MovementZone"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g}],execute:function(){Y=[[8,5,6],[3,0,2],[7,4,1]],Z=class extends I.Task{constructor(g,P,I=!1){super(),this.game=g,this.initialTarget=P,this.explicitOrder=I,this.forceMoveTried=!1,this.useChildTargetLines=!0,this.preventOpportunityFire=!1,this.rangeHelper=new K.RangeHelper(g.map.tileOccupation),this.scanNearRadius=g.rules.ai.tiberiumNearScan,this.scanFarRadius=g.rules.ai.tiberiumFarScan}onStart(g){if(!g.isVehicle()||!g.harvesterTrait)throw new Error(`Unit ${g.name} is not a harvester.`);g.harvesterTrait.status=_.HarvesterStatus.MovingToOreSite,g.harvesterTrait.lastGatherExplicit=this.explicitOrder}onEnd(g){g.harvesterTrait.status!==_.HarvesterStatus.LookingForOreSite&&(g.harvesterTrait.status=_.HarvesterStatus.Idle)}onTick(g){if(this.isCancelling())return!0;let P=g.harvesterTrait;if(P.status===_.HarvesterStatus.MovingToOreSite){var I=this.target;if(this.target=this.findClosestReachableOreSite(g,this.target||this.initialTarget?.landType!==U.LandType.Tiberium?P.lastOreSite??g.tile:this.initialTarget,!0),P.lastOreSite=this.target,!this.target){P.status=_.HarvesterStatus.LookingForOreSite;let I=this.getRefineryOnTile(g.tile);if(I&&1===g.unitOrderTrait.getTasks().length){let P=g.rules.movementZone===Q.MovementZone.Fly;var z=new L.RadialTileFinder(this.game.map.tiles,this.game.map.mapBounds,I.tile,I.getFoundation(),1,5,I=>P||0<this.game.map.terrain.getPassableSpeed(I,g.rules.speedType,g.isInfantry(),!1)&&Math.abs(I.z-g.tile.z)<2&&!this.game.map.terrain.findObstacles({tile:I,onBridge:void 0},g).length).getNextTile();z&&g.unitOrderTrait.addTasks(new G.MoveTask(this.game,z,!1),new q.CallbackTask(()=>{[$.MoveResult.Success,$.MoveResult.CloseEnough,$.MoveResult.Cancel].includes(g.moveTrait.lastMoveResult)||this.children.push(new W.WaitMinutesTask(1/60))}))}return!0}if(z=this.game.rules.general.closeEnough,I=I&&this.rangeHelper.tileDistance(g.tile,this.target)<=z,!(g.tile===this.target||g.tile.landType===U.LandType.Tiberium&&I)){if(g.tile!==this.target&&I&&g.tile.landType!==U.LandType.Tiberium)if(I=this.findClosestReachableOreSite(g,g.tile,!1,!0))this.target=I,P.lastOreSite=this.target;else{if(!this.forceMoveTried)return this.forceMoveTried=!0,this.children.push(new G.MoveTask(this.game,this.target,!1,{closeEnoughTiles:0,strictCloseEnough:!0})),!1;if(this.forceMoveTried=!1,!P.isEmpty())return this.returnOreIfPossible(g),!0;if(!(I=this.findClosestReachableOreSite(g,g.tile,!0,!0)))return P.status=_.HarvesterStatus.LookingForOreSite,!0;this.target=I,P.lastOreSite=this.target}return this.children.push(new G.MoveTask(this.game,this.target,!1,{closeEnoughTiles:z}),new q.CallbackTask(()=>{[$.MoveResult.Success,$.MoveResult.CloseEnough,$.MoveResult.Cancel].includes(g.moveTrait.lastMoveResult)||this.children.push(new W.WaitMinutesTask(5/60))})),!1}this.target=g.tile,P.lastOreSite=this.target,P.status=_.HarvesterStatus.Harvesting,this.forceMoveTried=!1}if(P.status!==_.HarvesterStatus.Harvesting)return!1;{if(P.isFull())return this.returnOreIfPossible(g),!0;let I=this.game.map.getObjectsOnTile(g.tile).find(g=>g.isOverlay()&&g.isTiberium());if(!I)return this.findClosestReachableOreSite(g,g.tile,!1)||P.isEmpty()?(P.status=_.HarvesterStatus.MovingToOreSite,this.onTick(g)):(this.returnOreIfPossible(g),!0);let L=I.traits.get(V.TiberiumTrait);return z=L.collectBail(),L.getBailCount()||this.game.unspawnObject(I),void 0===z||P.addBails(z,1),![...g.owner.buildings].some(g=>g.rules.refinery)&&!this.explicitOrder||(this.children.push(new W.WaitMinutesTask(1/60)),!1)}}findClosestReachableOreSite(g,P,I,_=!1){let G=g.rules.movementZone===Q.MovementZone.Fly;var W=g.rules.speedType,z=g.isInfantry();let K=!G&&this.game.map.terrain.getPassableSpeed(g.tile,W,z,g.onBridge)?this.game.map.terrain.getIslandIdMap(W,z):void 0,q=K?.get(g.tile,g.onBridge);var $;W=P=>P.landType===U.LandType.Tiberium&&K?.get(P,!1)===q&&(!_||G||!this.game.map.terrain.findObstacles({tile:P,onBridge:void 0},g).length);if(W(P))return P;let Z=1;if(!I){let g=new L.RadialTileFinder(this.game.map.tiles,this.game.map.mapBounds,P,{width:1,height:1},Z,Z,W),I=[];for(;$=g.getNextTile();)I.push($);if(I.length){let g=I.map(g=>{let P=this.game.map.getObjectsOnTile(g).find(g=>g.isOverlay()&&g.isTiberium());if(!P)throw new Error(`Ore should exist on tile ${g.rx},${g.ry} b/c of landType`);var I=P.traits.get(V.TiberiumTrait);return{tile:g,ore:P,tibTrait:I}});return g.sort((g,I)=>1e5*(I.tibTrait.rules.value-g.tibTrait.rules.value)+1e3*(I.ore.value-g.ore.value)+(Y[1+I.tile.ry-P.ry][1+I.tile.rx-P.rx]-Y[1+g.tile.ry-P.ry][1+g.tile.rx-P.rx])),g[0].tile}Z=2}return z=I?this.scanFarRadius:this.scanNearRadius,new L.RadialTileFinder(this.game.map.tiles,this.game.map.mapBounds,P,{width:1,height:1},Z,z,W).getNextTile()}getRefineryOnTile(g){return this.game.map.getObjectsOnTile(g).find(g=>g.isBuilding()&&g.rules.refinery)}returnOreIfPossible(g){1===g.unitOrderTrait.getTasks().length&&g.unitOrderTrait.addTask(new z.ReturnOreTask(this.game))}getTargetLinesConfig(g){return{pathNodes:this.initialTarget?[{tile:this.initialTarget,onBridge:void 0}]:[]}}},g("GatherOreTask",Z)}}}),System.register("game/gameobject/task/harvester/ReturnOreTask",["game/gameobject/task/system/Task","game/gameobject/unit/RangeHelper","game/map/tileFinder/RadialTileFinder","game/gameobject/task/move/MoveTask","game/gameobject/task/TurnTask","game/gameobject/task/system/WaitMinutesTask","game/gameobject/trait/HarvesterTrait","game/gameobject/task/harvester/TeleportMoveToRefineryTask","game/gameobject/task/harvester/GatherOreTask","game/gameobject/task/system/CallbackTask","game/gameobject/trait/MoveTrait","game/gameobject/unit/ZoneType","game/math/Vector2"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g}],execute:function(){Z=class extends I.Task{constructor(g,P,I=!1,_=!1){super(),this.game=g,this.forceTarget=P,this.resetLastOreSite=I,this.explicitOrder=_,this.useChildTargetLines=!0,this.preventOpportunityFire=!1,this.rangeHelper=new L.RangeHelper(g.map.tileOccupation)}onStart(g){if(!g.isVehicle()||!g.harvesterTrait)throw new Error(`Unit ${g.name} is not a harvester.`);g.harvesterTrait.status=W.HarvesterStatus.MovingToRefinery,this.resetLastOreSite&&(g.harvesterTrait.lastOreSite=void 0)}onEnd(g){this.target?.isSpawned&&(this.target.dockTrait.undockUnit(g),this.target.dockTrait.unreserveDockForUnit(g)),g.harvesterTrait.status!==W.HarvesterStatus.LookingForRefinery&&(g.harvesterTrait.status=W.HarvesterStatus.Idle)}onTick(g){if(this.isCancelling())return!0;let P=g.harvesterTrait;if(P.status===W.HarvesterStatus.LookingForRefinery)return!0;if(P.status===W.HarvesterStatus.MovingToRefinery){if(!this.target||!this.isValidTargetRefinery(this.target,g)||g.tile!==this.findRefineryDockingTile(this.target)){if(!(_=this.forceTarget??this.findClosestReachableRefinery(g)))return P.status=W.HarvesterStatus.LookingForRefinery,!0;this.target&&this.target!==_&&this.target.dockTrait.hasReservedDockForUnit(g)&&this.target.dockTrait.unreserveDockForUnit(g),this.target=_}let L=this.target.dockTrait.getFirstAvailableDockNumber(),G=!1;void 0===L&&(L=this.target.dockTrait.getFirstEmptyDockNumber(),void 0!==L&&(G=!this.target.dockTrait.hasReservedDockForUnit(g)));let K=this.findRefineryDockingTile(this.target);var I=this.rangeHelper.tileDistance(g,K);if(void 0===L||G||I>this.game.rules.general.harvesterTooFarDistance&&!this.explicitOrder)return!(Q=this.findReachableQueueingTile(g))||(g.tile!==Q&&this.children.push(g.rules.teleporter?new z.TeleportMoveToRefineryTask(this.game,K,Q,()=>this.chronoMinerCanTeleport(g,K,this.target)):new U.MoveTask(this.game,Q,!1),new q.CallbackTask(()=>{g.moveTrait.lastMoveResult===$.MoveResult.Fail?P.status=W.HarvesterStatus.LookingForRefinery:g.moveTrait.lastMoveResult===$.MoveResult.CloseEnough?this.children.push(new V.WaitMinutesTask(5/60)):g.moveTrait.lastMoveResult===$.MoveResult.Success&&this.children.push(new V.WaitMinutesTask(2/60))})),!1);if(this.target.dockTrait.hasReservedDockForUnit(g)||this.target.dockTrait.reserveDockAt(g,L),void 0===this.reservedDockNumber&&(this.reservedDockNumber=this.target.dockTrait.getReservedDockForUnit(g)),g.tile!==K)return this.children.push(g.rules.teleporter?new z.TeleportMoveToRefineryTask(this.game,K,void 0,()=>this.chronoMinerCanTeleport(g,K,this.target)):new U.MoveTask(this.game,K,!1,{closeEnoughTiles:0,strictCloseEnough:!0}),new q.CallbackTask(()=>{g.moveTrait.lastMoveResult===$.MoveResult.Fail&&(P.status=W.HarvesterStatus.LookingForRefinery)})),!1;P.status=W.HarvesterStatus.Docking}if(!this.isValidTargetRefinery(this.target,g))return P.status=W.HarvesterStatus.MovingToRefinery,this.forceTarget=void 0,this.onTick(g);if(P.status===W.HarvesterStatus.Docking){if(270!==g.direction)return this.children.push(new G.TurnTask(270)),!1;this.target.dockTrait.dockUnitAt(g,this.reservedDockNumber),this.reservedDockNumber=void 0,P.status=W.HarvesterStatus.PreparingToUnload}if(P.status===W.HarvesterStatus.PreparingToUnload)return this.preventOpportunityFire=!0,this.children.push(new V.WaitMinutesTask(2/60)),P.status=W.HarvesterStatus.Unloading,!1;if(P.status!==W.HarvesterStatus.Unloading)return!1;var L=P.getBails().reduce((g,[P,I])=>g+I*this.game.rules.getTiberium(P).value,0),_=L,Q=(I=[...this.target.owner.buildings].filter(g=>g.rules.orePurifier&&(!g.poweredTrait||!this.target.owner.powerTrait?.isLowPower())).length,this.game.rules.general.purifierBonus);return _+=I*Math.floor(L*Q),this.target.owner.credits+=_,this.target.owner.creditsGained+=_,P.empty(),1===g.unitOrderTrait.getTasks().length&&g.unitOrderTrait.addTask(new K.GatherOreTask(this.game)),!0}isValidTargetRefinery(g,P){return g.isSpawned&&this.game.areFriendly(g,P)&&!g.warpedOutTrait.isActive()}findClosestReachableRefinery(g){let P=this.rangeHelper;var I=g.zone===Q.ZoneType.Air,L=g.rules.speedType,_=g.isInfantry();let U=!I&&this.game.map.terrain.getPassableSpeed(g.tile,L,_,g.onBridge)?this.game.map.terrain.getIslandIdMap(L,_):void 0,G=[...g.owner.buildings].filter(P=>P.rules.refinery&&P.dockTrait&&!P.warpedOutTrait.isActive()&&(P=>g.rules.teleporter||U?.get(P,!1)===U?.get(g.tile,g.onBridge))(this.findRefineryDockingTile(P))).sort((I,L)=>P.distance2(g,I)-P.distance2(g,L));return L=G[0],_=G.find(g=>0<g.dockTrait.getAvailableDockCount()),!_||L&&P.tileDistance(g,_.centerTile)-P.tileDistance(g,L.centerTile)>this.game.rules.general.harvesterTooFarDistance?L:_}findReachableQueueingTile(g){if(this.target.art.queueingCell){var P=new Y.Vector2(this.target.tile.rx,this.target.tile.ry).add(this.target.art.queueingCell);if((P=this.game.map.tiles.getByMapCoords(P.x,P.y))&&this.isValidQueueingTile(P,g))return P}return new _.RadialTileFinder(this.game.map.tiles,this.game.map.mapBounds,this.target.tile,this.target.getFoundation(),1,1,P=>this.isValidQueueingTile(P,g)).getNextTile()}isValidQueueingTile(g,P){var I=P.zone===Q.ZoneType.Air,L=P.rules.speedType,_=P.isInfantry();let U=!I&&this.game.map.terrain.getPassableSpeed(P.tile,L,_,P.onBridge)?this.game.map.terrain.getIslandIdMap(L,_):void 0;return I||U?.get(g,!1)===U?.get(P.tile,P.onBridge)&&Math.abs(g.z-this.target.tile.z)<2&&!g.onBridgeLandType}findRefineryDockingTile(g){var P={x:g.tile.rx+g.getFoundation().width-1,y:g.tile.ry+Math.floor(g.getFoundation().height/2)};return this.game.map.tiles.getByMapCoords(P.x,P.y)}chronoMinerCanTeleport(g,P,I){var L=this.rangeHelper.tileDistance(g,P);return!(!this.forceTarget&&L>this.game.rules.general.chronoHarvTooFarDistance||L<=1||!this.isValidTargetRefinery(I,g)||0===I.dockTrait.getAvailableDockCount()&&!I.dockTrait.hasReservedDockForUnit(g))}},g("ReturnOreTask",Z)}}}),System.register("game/gameobject/task/harvester/TeleportMoveToRefineryTask",["game/gameobject/task/move/MoveTask","game/type/LocomotorType","game/gameobject/trait/MoveTrait","game/gameobject/unit/ZoneType"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=class extends I.MoveTask{constructor(g,P,I,L){super(g,I??P,!1,{closeEnoughTiles:I?void 0:0,strictCloseEnough:!I}),this.teleportTile=P,this.teleportCondition=L}onStart(g){if(super.onStart(g),!g.harvesterTrait||g.rules.locomotor!==L.LocomotorType.Chrono)throw new Error(`Vehicle ${g.name} is not a chrono miner`)}onTick(g){return!g.moveTrait.isDisabled()&&(!(this.isCancelling()||g.moveTrait.moveState!==_.MoveState.ReachedNextWaypoint||g.tile===this.teleportTile||!this.tryTeleportToRefinery(g))||!0===super.onTick(g)&&(this.isCancelling()||g.tile===this.teleportTile||this.tryTeleportToRefinery(g),!0))}tryTeleportToRefinery(g){return!(this.teleportCondition&&!1===this.teleportCondition(g,this.teleportTile)||this.game.map.terrain.findObstacles({tile:this.teleportTile,onBridge:void 0},g).length||(g.moveTrait.teleportUnitToTile(this.teleportTile,void 0,!0,!0,this.game),g.zone===U.ZoneType.Air&&(g.zone=U.ZoneType.Ground,g.position.tileElevation=0),0))}},g("TeleportMoveToRefineryTask",G)}}}),System.register("game/gameobject/task/InfiltrateBuildingTask",["game/event/BuildingInfiltrationEvent","game/gameobject/task/EnterBuildingTask"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.EnterBuildingTask{isAllowed(g){return g.rules.infiltrate&&this.target.rules.spyable&&!this.target.isDestroyed&&!this.game.areFriendly(g,this.target)}onEnter(g){this.game.unspawnObject(g),g.agentTrait?.infiltrate(g,this.target,this.game),this.game.events.dispatch(new I.BuildingInfiltrationEvent(this.target,g))}},g("InfiltrateBuildingTask",_)}}}),System.register("game/gameobject/task/morph/DeployIntoTask",["game/gameobject/task/morph/MorphIntoTask","engine/type/ObjectType"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends I.MorphIntoTask{onStart(g){var P=g.rules.deploysInto;if(!P)throw new Error(`Object type "${g.name}" doesn't deploy into anything`);this.morphInto=this.game.rules.getObject(P,L.ObjectType.Building),super.onStart(g)}onTick(g){return!!this.isCancelling()||super.onTick(g)}},g("DeployIntoTask",_)}}}),System.register("game/gameobject/task/morph/MorphIntoTask",["game/gameobject/task/system/Task","engine/type/ObjectType","game/gameobject/Building","game/gameobject/task/move/MoveTask","game/event/ObjectMorphEvent","game/gameobject/task/TurnTask","game/gameobject/task/morph/PackBuildingTask"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g}],execute:function(){z=class extends I.Task{constructor(g){super(),this.game=g}onStart(g){if(!this.morphInto)throw new Error("morphInto not set");g.isBuilding()&&g.buildStatus!==_.BuildStatus.BuildDown&&this.morphInto.type!==L.ObjectType.Building&&this.children.push(new W.PackBuildingTask(this.game)),g.isVehicle()&&this.morphInto.type===L.ObjectType.Building&&this.children.push(new V.TurnTask(180))}onTick(g){if(!this.morphInto)throw new Error("morphInto not set");let P=this.game.getUnitSelection();var I=P.isSelected(g),_=P.getOrCreateSelectionModel(g).getControlGroupNumber();let V;if(this.morphInto.type===L.ObjectType.Building){if(g.isVehicle()&&g.parasiteableTrait?.isInfested()&&!g.parasiteableTrait.beingBoarded)return!0;var W=g.tile;let P=this.game.getConstructionWorker(g.owner);if(!P.canPlaceAt(this.morphInto.name,W,{ignoreAdjacent:!0,ignoreObjects:[g]}))return!0;this.game.unspawnObject(g),g.dispose(),[V]=P.placeAt(this.morphInto.name,W),V.healthTrait.health=g.healthTrait.health}else{let P=g.unitOrderTrait.getTasks().filter(g=>g instanceof U.MoveTask);this.game.unspawnObject(g),g.dispose(),V=this.game.createUnitForPlayer(this.morphInto,g.owner),V.direction=180,V.healthTrait.health=g.healthTrait.health,W=g.art.foundationCenter,this.game.spawnObject(V,this.game.map.tiles.getByMapCoords(g.tile.rx+W.x,g.tile.ry+W.y)),P.forEach(g=>V.unitOrderTrait.addTask(g))}return V.purchaseValue=g.purchaseValue,g.replacedBy=V,I&&P.addToSelection(V),void 0!==_&&P.addUnitsToGroup(_,[V],!1),this.game.events.dispatch(new G.ObjectMorphEvent(g,V)),!0}},g("MorphIntoTask",z)}}}),System.register("game/gameobject/task/morph/PackBuildingTask",["game/gameobject/task/system/Task","game/gameobject/Building","game/gameobject/task/system/WaitMinutesTask"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class extends I.Task{constructor(g){super(),this.game=g}onTick(g){return!(g.buildStatus!==L.BuildStatus.BuildDown&&(g.setBuildStatus(L.BuildStatus.BuildDown,this.game),!g.rules.wall)&&(this.children.push(new _.WaitMinutesTask(this.game.rules.general.buildupTime)),1))}},g("PackBuildingTask",U)}}}),System.register("game/gameobject/task/morph/UndeployIntoTask",["game/gameobject/task/morph/MorphIntoTask","engine/type/ObjectType"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends I.MorphIntoTask{onStart(g){var P=g.rules.undeploysInto;if(!P)throw new Error(`Object type "${g.name}" doesn't undeploy into anything`);this.morphInto=this.game.rules.getObject(P,L.ObjectType.Vehicle),super.onStart(g)}},g("UndeployIntoTask",_)}}}),System.register("game/gameobject/task/move/AttackMoveTargetTask",["game/gameobject/task/AttackTask","game/gameobject/trait/MoveTrait"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class r extends I.AttackTask{constructor(g,P,I){if(super(g,P,I),this.isAttackMove=!0,this.attackPerformed=!1,this.passedFirstWaypoint=!1,this.internalTargetUpdateRequested=!1,this.scanCooldownTicks=0,!P.obj?.isTechno())throw new Error("Target must be a techno object");this.initialTarget=P,this.initialWeapon=I,this.requestedTarget=P}duplicate(){return new r(this.game,this.initialTarget,this.initialWeapon)}requestTargetUpdate(g){this.internalTargetUpdateRequested?(this.requestedTarget=g,this.internalTargetUpdateRequested=!1):(this.requestedTarget===this.initialTarget?this.requestedTarget=g:this.attackPerformed=!0,this.initialTarget=g),super.requestTargetUpdate(g)}onTargetChange(g){super.onTargetChange(g);var P=g.attackTrait.currentTarget;P&&P.obj!==this.initialTarget.obj&&P.obj!==this.requestedTarget.obj&&(this.requestedTarget===this.initialTarget&&(this.requestedTarget=P),this.initialTarget=P)}onTick(g){if(g.moveTrait.moveState===L.MoveState.Moving&&(this.passedFirstWaypoint=!0),this.scanCooldownTicks=Math.max(0,this.scanCooldownTicks-1),g.attackTrait&&!g.attackTrait.isDisabled()&&!this.isCancelling()&&(this.requestedTarget===this.initialTarget||this.attackPerformed)){if(!(g.moveTrait.isIdle()||g.tile===this.lastScanTile&&this.scanCooldownTicks)){this.lastScanTile=g.tile,this.scanCooldownTicks=this.game.rules.general.normalTargetingDelay;let L=g.attackTrait.selectDefaultWeapon(g);if(L&&(this.passedFirstWaypoint||!L.getCooldownTicks())){var P=g.attackTrait.scanForTarget(g,L,this.game);if(P.target){let{target:g,weapon:L}=P;if(!L.getCooldownTicks()){this.options.holdGround=!0,this.options.passive=!0,this.setWeapon(L);var I=this.game.createTarget(g,g.tile);return this.internalTargetUpdateRequested=!0,this.requestTargetUpdate(I),this.attackPerformed=!1}}}}if(this.attackPerformed){if(!g.isSpawned){if(!this.forceCancel(g))throw new Error("Force cancel failed");return!0}this.attackPerformed=!1,this.passedFirstWaypoint=!1,this.options.holdGround=!1,this.options.passive=!1,this.setWeapon(this.initialWeapon),this.internalTargetUpdateRequested=!0,this.requestTargetUpdate(this.initialTarget)}}return(I=super.onTick(g))&&this.requestedTarget!==this.initialTarget?(this.attackPerformed=!0,this.isCancelling()||g.attackTrait.isDisabled()):I}},g("AttackMoveTargetTask",_)}}}),System.register("game/gameobject/task/move/AttackMoveTask",["game/gameobject/task/move/MoveTask","game/gameobject/trait/MoveTrait","game/type/MovementZone"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class r extends I.MoveTask{constructor(){super(...arguments),this.isAttackMove=!0,this.attackPerformed=!1,this.passedFirstWaypoint=!1}duplicate(){return new r(this.game,this.targetTile,this.toBridge,this.options)}onTick(g){if(g.moveTrait.moveState===L.MoveState.Moving&&(this.passedFirstWaypoint=!0),g.moveTrait.moveState===L.MoveState.ReachedNextWaypoint&&g.attackTrait&&!g.attackTrait.isDisabled()&&(g.rules.movementZone!==_.MovementZone.Fly||!g.rules.balloonHover)&&(!g.ammoTrait||g.ammoTrait.ammo||!g.rules.manualReload)&&!this.isCancelling()){let I=g.attackTrait.selectDefaultWeapon(g);if(I&&(this.passedFirstWaypoint||I&&!I.getCooldownTicks())){var P=g.attackTrait.scanForTarget(g,I,this.game);if(P.target){let{target:I,weapon:_}=P;if(!_.getCooldownTicks())return P=g.attackTrait.createAttackTask(this.game,I,I.tile,_,{holdGround:!0,passive:!0}),this.children.push(P),this.useChildTargetLines=!0,this.attackPerformed=!0,g.moveTrait.velocity.set(0,0,0),g.moveTrait.currentWaypoint=void 0,g.moveTrait.collisionState=L.CollisionState.Waiting,!1}}if(this.attackPerformed){if(!g.isSpawned){if(!this.forceCancel(g))throw new Error("Force cancel failed");return!0}this.attackPerformed=!1,this.passedFirstWaypoint=!1,this.useChildTargetLines=!1,g.moveTrait.collisionState=L.CollisionState.Resolved,this.updateTarget(this.targetTile,this.toBridge)}}return super.onTick(g)}},g("AttackMoveTask",U)}}}),System.register("game/gameobject/task/move/ExitFactoryTask",["game/gameobject/task/move/MoveTask","game/gameobject/trait/MoveTrait","game/rules/TechnoRules","game/gameobject/task/ScatterTask","game/gameobject/task/AttackTask","game/gameobject/task/move/AttackMoveTargetTask","game/gameobject/task/move/AttackMoveTask"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g}],execute:function(){z=class extends I.MoveTask{constructor(g,P,I,L){super(g,I,!1,{ignoredBlockers:[P],closeEnoughTiles:0,strictCloseEnough:!0,forceWaitOnPathBlocked:P.factoryTrait?.type!==_.FactoryType.InfantryType}),this.factory=P,this.rallyPoint=L,this.preventOpportunityFire=!0,this.rampBlockersPushed=!1,this.cancellable=!1}onStart(g){super.onStart(g),this.factory.factoryTrait?.type===_.FactoryType.UnitType&&(this.checkRampTiles=this.game.map.tileOccupation.calculateTilesForGameObject(this.factory.tile,this.factory).filter(P=>0<this.game.map.terrain.getPassableSpeed(P,g.rules.speedType,g.isInfantry(),!1)))}canStopAtTile(g,P,I){return!this.game.map.tileOccupation.isTileOccupiedBy(P,this.factory)&&super.canStopAtTile(g,P,I)}onTick(g){if(this.checkRampTiles){for(var P of this.checkRampTiles){var _,z;for(_ of this.game.map.tileOccupation.getGroundObjectsOnTile(P))if(_.isUnit()){if(this.rampBlockersPushed)return!1;let g=new U.ScatterTask(this.game,void 0,{excludedTiles:this.checkRampTiles});g.setCancellable(!1);let P=_.unitOrderTrait.getCurrentTask();P?P.constructor!==I.MoveTask&&P.constructor!==G.AttackTask&&P.constructor!==W.AttackMoveTask&&P.constructor!==V.AttackMoveTargetTask||(z=P.duplicate(),P.cancel(),_.unitOrderTrait.addTaskNext(z),_.unitOrderTrait.addTaskNext(g)):_.unitOrderTrait.addTask(g)}}if(!this.rampBlockersPushed)return!(this.rampBlockersPushed=!0);this.checkRampTiles=void 0}return g.moveTrait.moveState===L.MoveState.ReachedNextWaypoint&&this.options?.ignoredBlockers&&!this.game.map.terrain.isBlockerObject(this.factory,g.tile,!1,g.rules.speedType,g.isInfantry())&&(this.options.ignoredBlockers=void 0,this.preventOpportunityFire=!1,this.rallyPoint&&(this.updateTarget(this.rallyPoint.tile,!!this.rallyPoint.onBridge),this.cancellable=!0,this.options.closeEnoughTiles=this.game.rules.general.closeEnough,this.options.strictCloseEnough=!1,this.options.forceWaitOnPathBlocked=!1)),super.onTick(g)}},g("ExitFactoryTask",z)}}}),System.register("game/gameobject/task/move/MoveAsideTask",["game/gameobject/task/system/Task","game/gameobject/unit/MovePositionHelper","game/gameobject/task/system/WaitTicksTask","game/gameobject/trait/MoveTrait","game/gameobject/task/move/MoveTask","game/math/geometry","game/type/MovementZone","game/gameobject/infantry/StanceType"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g}],execute:function(){K=class m extends I.Task{constructor(g,P){super(),this.game=g,this.fromDirection=P,this.resolved=!1,this.chainPushIssued=!1}onEnd(g){g.moveTrait.collisionState=U.CollisionState.Resolved}onTick(g){if(this.timeoutTicks=void 0===this.timeoutTicks?0:this.timeoutTicks+1,40<this.timeoutTicks||this.resolved||this.isCancelling())return!0;let P=this.game.map,I=new L.MovePositionHelper(P);var K=g.onBridge?P.tileOccupation.getBridgeOnTile(g.tile):void 0;let q,$;for(let L=0;L<360;L+=45)if((0!==L||this.chainPushIssued)&&180!==L){var Q=V.rotateVec2(this.fromDirection.clone(),L).round();if((Q=P.tiles.getByMapCoords(g.tile.rx+Math.sign(Q.x),g.tile.ry+Math.sign(Q.y)))&&P.mapBounds.isWithinBounds(Q)&&($=P.tileOccupation.getBridgeOnTile(Q),g.rules.movementZone===W.MovementZone.Fly||!P.terrain.findObstacles({tile:Q,onBridge:$},g).length&&I.isEligibleTile(Q,$,K,g.tile))){q=Q;break}}if(q)return this.resolved=!0,g.isInfantry()&&g.deployerTrait&&g.deployerTrait.isDeployed()&&g.deployerTrait.setDeployed(!1),!!g.moveTrait.isDisabled()||(this.children.push(new G.MoveTask(this.game,q,!!$,{closeEnoughTiles:0,strictCloseEnough:!0})),!1);{if(this.chainPushIssued)return this.children.push(new _.WaitTicksTask(5)),!1;let I=P.tiles.getByMapCoords(g.tile.rx+Math.sign(this.fromDirection.x),g.tile.ry+Math.sign(this.fromDirection.y));if(!I||!P.mapBounds.isWithinBounds(I))return!0;$=P.tileOccupation.getBridgeOnTile(I);let L=P.tileOccupation.getGroundObjectsOnTile(I).filter(P=>P.isUnit()&&P.owner===g.owner&&P.tile===I&&P.onBridge===!!$&&!(P.isInfantry()&&P.stance===z.StanceType.Paradrop)&&!(P.isAircraft()&&P.missileSpawnTrait));return L.find(g=>g.moveTrait.collisionState===U.CollisionState.Waiting||g.unitOrderTrait.hasTasks())?(this.children.push(new _.WaitTicksTask(5)),g.moveTrait.collisionState=U.CollisionState.Waiting,g.moveTrait.moveState=U.MoveState.PlanMove,!1):(L.forEach(g=>{g.unitOrderTrait.addTask(new m(this.game,this.fromDirection))}),this.children.push(new _.WaitTicksTask(1)),g.moveTrait.collisionState=U.CollisionState.Waiting,g.moveTrait.moveState=U.MoveState.PlanMove,!(this.chainPushIssued=!0))}}},g("MoveAsideTask",K)}}}),System.register("game/gameobject/task/move/MoveInsideTask",["game/gameobject/task/move/MoveTask"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class r extends I.MoveTask{static chooseTargetFoundationTile(g,P){if(g.isBuilding()){let I=g.centerTile;return P.map.mapBounds.isWithinBounds(I)||(I=P.map.tileOccupation.calculateTilesForGameObject(g.tile,g).find(g=>P.map.mapBounds.isWithinBounds(g))??g.tile),I}return g.tile}constructor(g,P){super(g,r.chooseTargetFoundationTile(P,g),!1,{ignoredBlockers:[P],closeEnoughTiles:0}),this.target=P}hasReachedDestination(g){return super.hasReachedDestination(g)||this.canStopAtTile(g,g.tile,g.onBridge)}canStopAtTile(g,P,I){var L=this.game.map.tileOccupation.isTileOccupiedBy(P,this.target);return!(this.isCancelling()&&L||!this.isCancelling()&&!L)}isCloseEnoughToDest(g,P,I){return this.game.map.tileOccupation.isTileOccupiedBy(P,this.target)}},g("MoveInsideTask",L)}}}),System.register("game/gameobject/task/move/MoveInWeaponRangeTask",["game/gameobject/task/move/MoveTask","game/gameobject/GameObject","game/gameobject/unit/RangeHelper","game/Coords","game/gameobject/unit/LosHelper","game/map/tileFinder/RadialTileFinder","game/type/MovementZone","game/gameobject/unit/ZoneType","game/gameobject/trait/MoveTrait","game/map/tileFinder/RandomTileFinder","game/type/LocomotorType","util/bresenham","game/gameobject/unit/FacingUtil","game/math/Vector2"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g}],execute:function(){g("STRAFE_CLOSE_ENOUGH",2),X=class extends I.MoveTask{constructor(g,P,I,U){super(g,P instanceof L.GameObject?P.isBuilding()?P.centerTile:P.tile:P,I,{pathFinderIgnoredBlockers:P instanceof L.GameObject&&0<U.range?[P]:void 0}),this.target=P,this.weapon=U,this.recalcMinRange=!0,this.cancelRequested=!1,this.bomberInitialLock=!1,this.rangeHelper=new _.RangeHelper(g.map.tileOccupation),this.losHelper=new G.LosHelper(g.map.tiles,g.map.tileOccupation)}onStart(g){let P=this.target,I=this.game.map;if(P instanceof L.GameObject&&P.isBuilding()&&g.rules.movementZone!==W.MovementZone.Fly){let U=P.tile;var _=P instanceof L.GameObject?P.getFoundation():{width:1,height:1};_=new V.RadialTileFinder(I.tiles,I.mapBounds,U,_,1,5,P=>0<I.terrain.getPassableSpeed(P,g.rules.speedType,g.isInfantry(),!1)&&Math.abs(P.z-U.z)<2).getNextTile();_&&this.rangeHelper.tileDistance(P,_)>Math.SQRT2&&this.updateTarget(_,!1)}this.bomberInitialLock=this.isCloseEnoughToDest(g,g.tile),super.onStart(g)}cancel(){this.bomberManeuverTile?this.cancelRequested=!0:super.cancel()}shouldAirStrafe(g){return g.rules.movementZone===W.MovementZone.Fly&&g.rules.locomotor===$.LocomotorType.Aircraft&&g.rules.fighter&&1<this.weapon.projectileRules.iniRot}isBombingRun(g){return g.rules.movementZone===W.MovementZone.Fly&&g.rules.locomotor===$.LocomotorType.Aircraft&&this.weapon.projectileRules.iniRot<=1}isAirStrafeCloseEnough(g){return this.rangeHelper.tileDistance(g,this.targetTile)<Math.min(this.weapon.range,2)}bomberCanReturn(g){return!this.bomberManeuverTile||this.rangeHelper.tileDistance(g,this.bomberManeuverTile)<=1}findStrafeDestination(g,P){return new q.RandomTileFinder(this.game.map.tiles,this.game.map.mapBounds,P,this.weapon.range,this.game,I=>this.rangeHelper.isInWeaponRange(g,P,this.weapon,this.game.rules,I)).getNextTile()}hasReachedDestination(g){return super.hasReachedDestination(g)||this.canStopAtTile(g,g.tile,g.onBridge)}canStopAtTile(g,P,I){if(g.zone!==z.ZoneType.Air&&this.target instanceof L.GameObject&&this.game.map.tileOccupation.isTileOccupiedBy(P,this.target)&&(!this.target.isUnit()||this.target.tile===P&&this.target.moveTrait.moveState!==K.MoveState.Moving&&this.target.position.subCell===g.position.subCell))return!1;if(g.zone!==z.ZoneType.Air){if(!super.canStopAtTile(g,P,I))return!1}else if(this.game.map.tileOccupation.getAirObjectsOnTile(P).filter(P=>P.isUnit()&&P.moveTrait.moveState!==K.MoveState.Moving&&P!==g).length)return!1;return!(this.isBombingRun(g)&&!this.bomberCanReturn(P))&&(!!this.isCancelling()||this.isCloseEnoughToDest(g,P))}isCloseEnoughToDest(g,P){if(g.rules.balloonHover&&!g.rules.hoverAttack)return this.rangeHelper.isInTileRange(P,this.target,0,0);if(this.weapon.rules.cellRangefinding||!g.isInfantry())return this.rangeHelper.isInWeaponRange(g,this.target,this.weapon,this.game.rules,P)&&this.losHelper.hasLineOfSight(P,this.target,this.weapon);var I=g.zone===z.ZoneType.Air?g.position.computeSubCellOffset(g.position.desiredSubCell):g.position.getTileOffset(),{minRange:L,range:_}=this.rangeHelper.computeWeaponRangeVsTarget(P,this.target,this.weapon,this.game.rules);I=U.Coords.tile3dToWorld(P.rx+I.x/U.Coords.LEPTONS_PER_TILE,P.ry+I.y/U.Coords.LEPTONS_PER_TILE,P.z+g.position.tileElevation);return(g.isUnit()&&g.rules.movementZone===W.MovementZone.Fly?this.rangeHelper.isInRange2(I,this.target,L,_):this.rangeHelper.isInRange3(I,this.target,L,_))&&this.losHelper.hasLineOfSight(P,this.target,this.weapon)}findRelocationTile(g,P,I){if(I.rules.movementZone!==W.MovementZone.Fly)return super.findRelocationTile(g,P,I);var L=this.game.map;return new q.RandomTileFinder(L.tiles,L.mapBounds,g,1,this.game,g=>this.isCancelling()||this.isCloseEnoughToDest(I,g)).getNextTile()}retarget(g,P){var I=g instanceof L.GameObject?g.isBuilding()?g.centerTile:g.tile:g;this.bomberManeuverTile?this.bomberQueuedTargetTile=I:(this.updateTarget(I,P),this.recalcMinRange=!0),this.target=g,this.options?.ignoredBlockers&&(this.options.ignoredBlockers=g instanceof L.GameObject?[g]:void 0),this.options??(this.options={}),this.options.pathFinderIgnoredBlockers=g instanceof L.GameObject?[g]:void 0}onTick(g){if(this.recalcMinRange){this.recalcMinRange=!1;var P=this.findMinRangeRelocationTile(g,this.targetTile);if(P!==this.targetTile){if(!P)return this.cancel(),!1;this.updateTarget(P,!!P.onBridgeLandType)}}if(this.shouldAirStrafe(g)&&!this.isCancelling()&&(this.updateTarget(this.target instanceof L.GameObject?this.target.isBuilding()?this.target.centerTile:this.target.tile:this.target,!1),!this.isAirStrafeCloseEnough(g)||(I=this.findStrafeDestination(g,this.targetTile))&&this.updateTarget(I,!1)),this.isBombingRun(g)&&!this.isCancelling()&&(!g.ammo||this.weapon.getBurstsFired()||this.bomberInitialLock)&&!this.bomberManeuverTile){this.bomberInitialLock=!1;let P=g.position.getMapPosition();var I=this.target instanceof L.GameObject?this.target.isBuilding()?this.target.centerTile:this.target.tile:this.target;let _=new Z.Vector2(I.rx+.5,I.ry+.5).clone().multiplyScalar(U.Coords.LEPTONS_PER_TILE).sub(P),G=_.length();if(G||(_.copy(Y.FacingUtil.toMapCoords(g.direction)),G=Number.EPSILON),I=P.clone().add(_.setLength(G+7*U.Coords.LEPTONS_PER_TILE)).multiplyScalar(1/U.Coords.LEPTONS_PER_TILE).floor(),!(I=Q.bresenham(I.x,I.y,g.tile.rx,g.tile.ry)).length)throw new Error("Bresenham returned no tiles");I=I[0],this.bomberManeuverTile=this.game.map.tiles.getByMapCoords(I.x,I.y)??this.game.map.tiles.getPlaceholderTile(I.x,I.y),this.options.allowOutOfBoundsTarget=!0,this.updateTarget(this.bomberManeuverTile,!1)}return this.bomberManeuverTile&&this.bomberCanReturn(g.tile)&&(this.bomberManeuverTile=void 0,this.bomberQueuedTargetTile&&(this.updateTarget(this.bomberQueuedTargetTile,!1),this.recalcMinRange=!0,this.bomberQueuedTargetTile=void 0)),this.cancelRequested&&(this.bomberManeuverTile||(this.cancelRequested=!1,this.cancel())),!!(this.isBombingRun(g)&&this.isCancelling()&&this.forceCancel(g))||super.onTick(g)}forceCancel(g){return!this.bomberManeuverTile&&super.forceCancel(g)}findMinRangeRelocationTile(g,P){var{minRange:I,range:L}=this.rangeHelper.computeWeaponRangeVsTarget(g,this.target,this.weapon,this.game.rules);return g.rules.locomotor===$.LocomotorType.Chrono?this.rangeHelper.isInRange(g,this.target,L-1,L,this.weapon.rules.cellRangefinding)?P:this.findTileInRange(g,P,L-1,2*L)??P:this.rangeHelper.isInRange(g,this.target,I,Number.POSITIVE_INFINITY,this.weapon.rules.cellRangefinding)?P:this.findTileInRange(g,P,2*I,L-I)}findTileInRange(g,P,I,L){let _=this.game.map;var U,G=new Z.Vector2(g.tile.rx-P.rx,g.tile.ry-P.ry).setLength(I).floor().add(new Z.Vector2(P.rx,P.ry));let W;for(U of Q.bresenham(G.x,G.y,P.rx,P.ry))if(W=_.tiles.getByMapCoords(U.x,U.y),W)break;if(W){return new V.RadialTileFinder(_.tiles,_.mapBounds,W,{width:1,height:1},0,L,P=>this.rangeHelper.isInWeaponRange(g,this.target,this.weapon,this.game.rules,P)&&this.losHelper.hasLineOfSight(P,this.target,this.weapon)&&0<_.terrain.getPassableSpeed(P,g.rules.speedType,g.isInfantry(),!!P.onBridgeLandType)&&!_.terrain.findObstacles({tile:P,onBridge:!!P.onBridgeLandType},g).length).getNextTile()}}},g("MoveInWeaponRangeTask",X)}}}),System.register("game/gameobject/task/move/MoveOutsideTask",["game/gameobject/task/move/MoveTask"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.MoveTask{constructor(g,P,I){super(g,I??P.tile,!1,{ignoredBlockers:[P]}),this.target=P,this.cancellable=!1}canStopAtTile(g,P,I){return!this.game.map.tileOccupation.isTileOccupiedBy(P,this.target)&&super.canStopAtTile(g,P,I)}},g("MoveOutsideTask",L)}}}),System.register("game/gameobject/task/move/MoveTargetTask",["game/gameobject/task/move/MoveTask","game/gameobject/trait/MoveTrait"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends I.MoveTask{constructor(g,P){super(g,P.tile,P.onBridge,{forceMove:!0,pathFinderIgnoredBlockers:[P]}),this.target=P,this.tilesSinceTargetUpdate=0}onTick(g){if(!(this.isCancelling()||g.moveTrait.moveState!==L.MoveState.ReachedNextWaypoint||this.target.tile===this.targetTile&&this.target.onBridge===this.toBridge&&this.target.moveTrait.isIdle())){let I=!1;var P;(g.tile===this.targetTile&&this.target.tile!==this.targetTile||10<this.tilesSinceTargetUpdate++)&&(I=!0),I&&(this.tilesSinceTargetUpdate=0,(P=this.target.moveTrait.currentWaypoint)?this.updateTarget(P.tile,!!P.onBridge):this.updateTarget(this.target.tile,this.target.onBridge))}return super.onTick(g)}forceCancel(g){return super.forceCancel(g)}getTargetLinesConfig(g){return{target:this.target,pathNodes:[]}}},g("MoveTargetTask",_)}}}),System.register("game/gameobject/task/move/MoveTask",["game/gameobject/task/system/Task","game/gameobject/Infantry","game/type/MovementZone","util/array","game/type/SpeedType","game/gameobject/trait/MoveTrait","game/gameobject/task/system/WaitTicksTask","game/gameobject/task/move/MoveAsideTask","game/gameobject/unit/MovePositionHelper","game/map/tileFinder/RadialTileFinder","game/gameobject/unit/RangeHelper","util/Logger","game/Coords","game/gameobject/task/system/TaskStatus","game/gameobject/unit/ZoneType","game/gameobject/locomotor/LocomotorFactory","game/map/tileFinder/RandomTileFinder","game/event/ObjectTeleportEvent","game/gameobject/trait/interface/NotifyTeleport","game/type/PowerupType","game/gameobject/task/ScatterTask","game/gameobject/unit/VeteranAbility","game/math/Vector2","game/type/LocomotorType"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g}],execute:function(){ce=class l extends I.Task{constructor(g,P,I,L){super(),this.game=g,this.targetTile=P,this.toBridge=I,this.options=L,this.preventOpportunityFire=!1,this.logger=Q.AppLogger.get("move"),this.destinationLeptons=new oe.Vector2,this.currentWaypointLeptons=new oe.Vector2,this.needsPathUpdate=!1,this.allObstaclesAreBlockers=!1,this.blockedPathNodes=[],this.unreachableTargets=[],this.pushTried=!1,this.cancelProcessed=!1,this.cancelRepositionPending=!1,this.targetLinesConfig={pathNodes:[]}}duplicate(){return new l(this.game,this.targetTile,this.toBridge,this.options)}setForceMove(g){g?(this.options??(this.options={}),this.options.forceMove=!0):this.options?.forceMove&&(this.options.forceMove=void 0)}onStart(g){if(g.moveTrait.currentWaypoint)throw new Error("Nested move tasks are not supported");void 0===g.moveTrait.locomotor&&(g.moveTrait.locomotor=new J.LocomotorFactory(this.game).create(g)),g.moveTrait.lastTargetOffset?this.targetOffset=g.moveTrait.lastTargetOffset:this.targetOffset=this.computeTargetOffset(g),g.moveTrait.lastVelocity&&(g.moveTrait.velocity=g.moveTrait.lastVelocity),this.path||(this.groundPathPlan?(this.groundPathPlan.path[this.groundPathPlan.path.length-1].tile===g.tile?this.path=this.applyGroundPathPlan(this.groundPathPlan):this.computePath(g,g.moveTrait.locomotor),this.groundPathPlan=void 0):this.computePath(g,g.moveTrait.locomotor),this.targetLinesConfig.isRecalc=!1),this.updateDestination(this.path,this.targetOffset),g.moveTrait.moveState=V.MoveState.ReachedNextWaypoint,g.moveTrait.lastMoveResult=void 0,g.moveTrait.lastTargetOffset=void 0,g.moveTrait.lastVelocity=void 0}computeTargetOffset(g){return this.options?.targetOffset??(g.isInfantry()?g.position.getTileOffset():g.position.computeSubCellOffset(0))}computePath(g,P,I=!1){let L;if(this.options?.allowOutOfBoundsTarget||this.game.map.mapBounds.isWithinBounds(this.targetTile))if(g.rules.movementZone===_.MovementZone.Fly)L=this.computeAirPath(g);else if(P.ignoresTerrain)L=this.computeDirectJumpPath(g);else{var U=this.computeGroundPath(g);if(I&&!U.path.length)return!1;L=this.applyGroundPathPlan(U)}else L=[];return g.rules.movementZone===_.MovementZone.Fly?(this.targetLinesConfig.pathNodes=L.map(({tile:g,onBridge:P})=>({tile:g,onBridge:P})),L.length&&(this.targetLinesConfig.pathNodes[0].onBridge=this.toBridge?this.game.map.tileOccupation.getBridgeOnTile(this.targetTile):void 0)):this.targetLinesConfig.pathNodes=L,this.path=L,!0}computeAirPath(g){return[{tile:this.targetTile,onBridge:void 0},{tile:g.tile,onBridge:void 0}]}computeDirectJumpPath(g){let P=this.game.map;var I=g.onBridge?P.tileOccupation.getBridgeOnTile(g.tile):void 0;let L=this.targetTile,_=this.toBridge?P.tileOccupation.getBridgeOnTile(this.targetTile):void 0,U=this.options?.ignoredBlockers;var G=new q.RadialTileFinder(P.tiles,P.mapBounds,L,{width:1,height:1},0,5,I=>0<P.terrain.getPassableSpeed(I,g.rules.speedType,g.isInfantry(),!!I.onBridgeLandType,U)&&!P.terrain.findObstacles({tile:I,onBridge:!!I.onBridgeLandType},g).find(g=>!U?.includes(g.obj))).getNextTile();return G?(G!==L&&(L=G,_=P.tileOccupation.getBridgeOnTile(L)),[{tile:L,onBridge:_},{tile:g.tile,onBridge:I}]):[]}computeGroundPath(g){let P=g.tile,I=g.onBridge?this.game.map.tileOccupation.getBridgeOnTile(P):void 0;g.moveTrait.moveState===V.MoveState.Moving&&g.moveTrait.currentWaypoint&&(P=g.moveTrait.currentWaypoint.tile,I=g.moveTrait.currentWaypoint.onBridge);let L={path:[],ignoredBlockers:[],blockedPathNodes:[]};const _=this.game.map.getObjectsOnTile(P).find(g=>g.isBuilding());if(_&&!this.game.map.terrain.getPassableSpeed(P,g.rules.speedType,g.isInfantry(),!1)){var U=this.options?.ignoredBlockers?.includes(_);if(U||L.ignoredBlockers.push(_),!U&&_.dockTrait){let g=new Set(_.dockTrait?.getAllDockTiles());this.game.map.tileOccupation.calculateTilesForGameObject(_.tile,_).filter(P=>!g.has(P)).forEach(g=>L.blockedPathNodes.push({node:{tile:g,onBridge:void 0},obj:_}))}}var G=this.game.map.getGroundObjectsOnTile(this.targetTile).find(P=>(P.isInfantry()||P.isVehicle())&&P.disguiseTrait?.hasTerrainDisguise()&&!(this.game.alliances.haveSharedIntel(g.owner,P.owner)||P.owner.sharedDetectDisguiseTrait?.has(g)));G&&(U=this.toBridge?this.game.map.tileOccupation.getBridgeOnTile(this.targetTile):void 0,L.blockedPathNodes.push({node:{tile:this.targetTile,onBridge:U},obj:G}));let W=[...new Set([...this.options?.ignoredBlockers??[],...L.ignoredBlockers])],z=[...this.blockedPathNodes,...L.blockedPathNodes];return G=this.game.map.terrain.computePath(g.rules.speedType,g.isInfantry(),P,!!I,this.targetTile,this.toBridge,{maxExpandedNodes:this.allObstaclesAreBlockers?Math.min(300,this.options?.maxExpandedPathNodes??Number.POSITIVE_INFINITY):this.options?.maxExpandedPathNodes,bestEffort:!this.options?.strictCloseEnough,ignoredBlockers:[...new Set([...W,...this.options?.pathFinderIgnoredBlockers??[]])],excludeTiles:this.allObstaclesAreBlockers||z.length?P=>this.nodeIsBlockedForPathfinding(P,g,W,z):void 0}),L.path=G,L}nodeIsBlockedForPathfinding(g,P,I,L){return this.allObstaclesAreBlockers?!!this.game.map.terrain.findObstacles(g,P).find(g=>!I?.includes(g.obj)):!!L.find(({node:P})=>P.tile===g.tile&&P.onBridge===g.onBridge)}applyGroundPathPlan(g){var P;return this.blockedPathNodes=this.blockedPathNodes.filter(g=>g.obj.isSpawned&&g.node.tile===g.obj.tile),g.ignoredBlockers.length&&(this.options??(this.options={}),(P=this.options).ignoredBlockers??(P.ignoredBlockers=[]),this.options.ignoredBlockers.push(...g.ignoredBlockers)),this.blockedPathNodes.push(...g.blockedPathNodes),g.path}updateDestination(g,P){var I=g.length?g[0].tile:this.targetTile;this.destinationLeptons.set(I.rx*Y.Coords.LEPTONS_PER_TILE,I.ry*Y.Coords.LEPTONS_PER_TILE).add(P)}canStopAtTile(g,P,I){if(g.zone===X.ZoneType.Air){if((!g.isAircraft()||!g.airportBoundTrait)&&!g.rules.spawned&&(!this.options?.forceMove||!g.rules.balloonHover||g.rules.hoverAttack)&&(!this.game.map.terrain.getPassableSpeed(P,G.SpeedType.Amphibious,!1,I)||this.game.map.getObjectsOnTile(P).filter(I=>I.isBuilding()&&!I.isDestroyed&&!I.dockTrait?.hasReservedDockForUnit(g)&&!g.rules.dock.includes(I.name)||I.isUnit()&&I.tile===P&&I.moveTrait.moveState!==V.MoveState.Moving&&I!==g).length))return!1}else if(g.isInfantry()){let L=this.game.map.getGroundObjectsOnTile(P).filter(L=>L.isInfantry()&&L.tile===P&&L.onBridge===I&&L.moveTrait.moveState!==V.MoveState.Moving&&L!==g);if(2<L.length||L.find(P=>P.position.subCell===g.position.subCell))return!1}return!(g.zone!==X.ZoneType.Air&&g.rules.tooBigToFitUnderBridge&&!I&&P.onBridgeLandType&&this.game.map.tileOccupation.getBridgeOnTile(P)?.isHighBridge()||!this.isCancelling()&&this.options?.strictCloseEnough&&void 0!==this.options?.closeEnoughTiles&&!this.isCloseEnoughToDest(g,P,this.options.closeEnoughTiles))}isCloseEnoughToDest(g,P,I){if(void 0===I)return!0;return!(new $.RangeHelper(this.game.map.tileOccupation).tileDistance(this.targetTile,P)>I)}hasReachedDestination(g){return!this.path.length}updateTarget(g,P,I=!1){this.needsPathUpdate=!0,this.targetChangeRequested={tile:g,toBridge:P,onlyIfPathExists:I}}onEnd(g){g.moveTrait.collisionState=V.CollisionState.Resolved,g.moveTrait.currentWaypoint=void 0,this.targetOffset.equals(this.computeTargetOffset(g))||(g.moveTrait.lastTargetOffset=this.targetOffset)}forceCancel(g){return!(!this.cancellable||this.children.some(g=>!g.cancellable)||!this.options?.allowOutOfBoundsTarget&&!this.game.map.isWithinBounds(g.tile)||(this.status!==Z.TaskStatus.Running&&this.status!==Z.TaskStatus.Cancelling||(g.moveTrait.unreservePathNodes(),g.moveTrait.lastMoveResult=V.MoveResult.Cancel,this.onEnd(g),g.moveTrait.lastTargetOffset=this.targetOffset,g.moveTrait.lastVelocity=g.moveTrait.velocity.clone()),this.status=Z.TaskStatus.Cancelled,0))}onTick(g){if(g.moveTrait.isDisabled()&&g.moveTrait.moveState===V.MoveState.ReachedNextWaypoint)return!!this.isCancelling()&&(g.moveTrait.lastMoveResult=V.MoveResult.Cancel,!0);var P;this.needsPathUpdate&&(g.moveTrait.moveState===V.MoveState.PlanMove&&(this.inPlanningForTicks=void 0,g.moveTrait.currentWaypoint=void 0,g.moveTrait.collisionState=V.CollisionState.Resolved,g.moveTrait.moveState=V.MoveState.ReachedNextWaypoint,g.moveTrait.velocity.set(0,0,0)),P=this.targetTile,L=this.toBridge,this.targetChangeRequested&&(this.targetTile=this.targetChangeRequested.tile,this.toBridge=this.targetChangeRequested.toBridge),this.computePath(g,g.moveTrait.locomotor,this.targetChangeRequested?.onlyIfPathExists)?(this.path.length||this.unreachableTargets.push({tile:this.targetTile,toBridge:this.toBridge}),this.updateDestination(this.path,this.targetOffset),this.allObstaclesAreBlockers=!1):(this.targetTile=P,this.toBridge=L,this.targetLinesConfig.pathNodes=[...this.targetLinesConfig.pathNodes]),this.targetLinesConfig.isRecalc=!this.targetChangeRequested,this.targetChangeRequested=void 0,this.needsPathUpdate=!1);let I=this.game.map;if(g.moveTrait.moveState===V.MoveState.ReachedNextWaypoint){g.moveTrait.unreservePathNodes();var L=this.path.findIndex(P=>P===g.moveTrait.currentWaypoint);if(-1!==L?this.path.splice(L):this.path.pop(),g.moveTrait.currentWaypoint=void 0,this.isCancelling()?!this.cancelProcessed:this.hasReachedDestination(g)){var K=!this.isCancelling()&&!this.isCloseEnoughToDest(g,g.tile,this.options?.closeEnoughTiles);if(!K&&this.canStopAtTile(g,g.tile,g.onBridge))return g.moveTrait.lastMoveResult=this.isCancelling()?V.MoveResult.Cancel:V.MoveResult.Success,!0;{if(this.unreachableTargets.length>5)return g.moveTrait.lastMoveResult=V.MoveResult.Fail,this.log(g,"bail_max_unreachable_dest"),!0;let P=g.tile,_=g.onBridge?I.tileOccupation.getBridgeOnTile(P):void 0;return K&&(P=this.targetTile,_=this.toBridge?I.tileOccupation.getBridgeOnTile(P):void 0),(L=this.findRelocationTile(P,_,g))?(K=!_||_.isHighBridge()?I.tileOccupation.getBridgeOnTile(L):void 0,this.updateTarget(L,!!K),this.isCancelling()&&(this.cancelProcessed=!0,this.cancelRepositionPending=!0),!1):(g.moveTrait.lastMoveResult=K?V.MoveResult.Fail:V.MoveResult.CloseEnough,this.log(g,"bail_no_free_dest"),!0)}}if(this.cancelProcessed&&!this.path.length)return g.moveTrait.lastMoveResult=V.MoveResult.Cancel,!0;this.cancelProcessed=!1,g.moveTrait.moveState=V.MoveState.PlanMove;let P=g.moveTrait.locomotor;if(g.moveTrait.currentWaypoint=P.selectNextWaypoint?P.selectNextWaypoint(g,this.path):this.path[this.path.length-1],this.currentWaypointLeptons.set(g.moveTrait.currentWaypoint.tile.rx,g.moveTrait.currentWaypoint.tile.ry).multiplyScalar(Y.Coords.LEPTONS_PER_TILE).add(this.targetOffset),K=P.onNewWaypoint(g,this.currentWaypointLeptons,this.destinationLeptons))return this.children.push(...K),!1}if(g.moveTrait.moveState===V.MoveState.PlanMove){if(this.isCancelling()&&!this.cancelRepositionPending)return g.moveTrait.currentWaypoint=void 0,g.moveTrait.moveState=V.MoveState.ReachedNextWaypoint,this.onTick(g);if(this.inPlanningForTicks=void 0===this.inPlanningForTicks?0:this.inPlanningForTicks+1,this.inPlanningForTicks>200)return this.needsPathUpdate=!0,this.allObstaclesAreBlockers=!0,g.moveTrait.velocity.set(0,0,0),this.log(g,"repath_plan_timeout"),!1;if(g.rules.movementZone!==_.MovementZone.Fly&&!g.moveTrait.locomotor.ignoresTerrain){let P=this.path.slice(this.path.indexOf(g.moveTrait.currentWaypoint)).reverse();var q,$,Q,Z,J=g.moveTrait.velocity.length();for(q of P)q.onBridge?.isDestroyed&&(q.onBridge=void 0);for($ of P){if(!I.terrain.getPassableSpeed($.tile,g.rules.speedType,g.isInfantry(),!!$.onBridge,this.options?.ignoredBlockers))return this.options?.stopOnBlocker&&I.terrain.findObstacles($,g).some(g=>g.obj===this.options.stopOnBlocker)?(g.moveTrait.lastMoveResult=V.MoveResult.CloseEnough,!0):(this.needsPathUpdate=!0,g.moveTrait.currentWaypoint=void 0,g.moveTrait.moveState=V.MoveState.ReachedNextWaypoint,this.onTick(g));if(!$.onBridge){var ee=I.getGroundObjectsOnTile($.tile).find(g=>g.isOverlay()&&g.rules.crate);if(ee&&this.game.crateGeneratorTrait.peekInsideCrate(ee)===se.PowerupType.Unit&&(this.game.crateGeneratorTrait.pickupCrate(g,ee,this.game),ee=this.game.map.getGroundObjectsOnTile($.tile).find(g=>g.isUnit()&&!g.onBridge),ee))return this.needsPathUpdate=!0,this.blockedPathNodes.push({node:$,obj:ee}),g.moveTrait.currentWaypoint=void 0,g.moveTrait.moveState=V.MoveState.ReachedNextWaypoint,this.onTick(g)}for(Q of I.terrain.findObstacles($,g).filter(g=>!this.options?.ignoredBlockers?.includes(g.obj))){if(Q.static)return this.needsPathUpdate=!0,g.moveTrait.currentWaypoint=void 0,g.moveTrait.moveState=V.MoveState.ReachedNextWaypoint,this.onTick(g);if(Q.obj.rules.crushable){if([G.SpeedType.Track,G.SpeedType.Hover].includes(g.rules.speedType)&&g.crusher&&(!Q.obj.isTechno()||!this.game.areFriendly(Q.obj,g)))continue;if(!Q.obj.isTechno())return this.needsPathUpdate=!0,g.moveTrait.currentWaypoint=void 0,g.moveTrait.moveState=V.MoveState.ReachedNextWaypoint,this.onTick(g)}if(Q.obj.isTerrain()){if(!g.isInfantry())throw new Error(`Obstacle ${Q.obj.name} should be a blocker for non infantry`);var le=this.findFreeSubCell(g,$);return void 0!==le?this.relocateToSubCell(g,le):(this.needsPathUpdate=!0,this.blockedPathNodes.push({node:$,obj:Q.obj}),g.moveTrait.currentWaypoint=void 0,g.moveTrait.moveState=V.MoveState.ReachedNextWaypoint),this.onTick(g)}if(!Q.obj.isTechno())throw new Error("Unexpected obstacle of type "+Q.obj.type);const L=Q.obj;var ce=L.isUnit()?L.moveTrait.velocity.length():0;if(!L.isAircraft()||L.zone!==X.ZoneType.Ground||!this.options?.ignoredBlockers?.some(g=>g.isBuilding()&&g.dockTrait?.isDocked(L))){if(1===P.length&&L.isUnit()&&ce&&J&&J<=ce&&g.direction===L.direction&&L.tile===$.tile&&L.moveTrait.currentWaypoint?.tile!==$.tile)break;if(L.isBuilding()||L.moveTrait.moveState===V.MoveState.Idle||L.moveTrait.collisionState!==V.CollisionState.Resolved){if(!J&&g.moveTrait.collisionState!==V.CollisionState.Resolved&&L.isUnit()&&L.moveTrait.collisionState!==V.CollisionState.Resolved)return this.inPlanningForTicks+1>200&&(this.needsPathUpdate=!0,this.allObstaclesAreBlockers=!0,this.log(g,"repath_waited_too_long_blocker "+L.id),g.moveTrait.velocity.set(0,0,0)),!1;{if(L.isInfantry()&&g.isInfantry()&&L.moveTrait.collisionState===V.CollisionState.Resolved){var he=this.findFreeSubCell(g,$);if(void 0!==he)return this.relocateToSubCell(g,he),this.onTick(g)}if(le=U.findIndexReverse(this.path.slice(0,this.path.indexOf($)),P=>!I.terrain.findObstacles(P,g).filter(g=>!this.options?.ignoredBlockers?.includes(g.obj)).length),-1===le){if(this.canStopAtTile(g,g.tile,g.onBridge)&&this.isCloseEnoughToDest(g,g.tile,this.options?.closeEnoughTiles))return g.moveTrait.lastMoveResult=V.MoveResult.CloseEnough,this.log(g,"bail_waypoints_blocked_close_enough"),!0;if(!(0===this.options?.closeEnoughTiles||Math.abs(g.tile.rx-this.targetTile.rx)<=1&&Math.abs(g.tile.ry-this.targetTile.ry)<=1))return this.needsPathUpdate=!0,this.blockedPathNodes.push(...this.path.slice(0,this.path.indexOf($)+1).map(P=>({node:P,obj:I.terrain.findObstacles(P,g)[0].obj}))),g.moveTrait.velocity.set(0,0,0),this.log(g,"repath_waypoints_blocked_too_far"),!1}let _;return _=-1!==le?(he=this.path[le],I.terrain.computePath(g.rules.speedType,g.isInfantry(),g.tile,g.onBridge,he.tile,!!he.onBridge,{maxExpandedNodes:15,bestEffort:!1,excludeTiles:P=>!!I.terrain.findObstacles(P,g).filter(g=>!this.options?.ignoredBlockers?.includes(g.obj)).length,ignoredBlockers:this.options?.ignoredBlockers})):[],_.length||L.owner!==g.owner||1!==P.length?_.length?(this.path.splice(le,this.path.length,..._),g.moveTrait.currentWaypoint=void 0,g.moveTrait.moveState=V.MoveState.ReachedNextWaypoint,this.onTick(g)):((ue=this.selectWeaponVsObstacle(g,L))?(this.children.push(g.attackTrait.createAttackTask(this.game,L,L.tile,ue,{passive:!0,holdGround:!0})),g.moveTrait.velocity.set(0,0,0)):this.options?.forceWaitOnPathBlocked?(this.children.push(new W.WaitTicksTask(40)),this.inPlanningForTicks=0,g.moveTrait.velocity.set(0,0,0),g.moveTrait.collisionState=V.CollisionState.Waiting):(this.needsPathUpdate=!0,this.blockedPathNodes.push({node:$,obj:L}),L.isBuilding()&&(this.allObstaclesAreBlockers=!0),this.log(g,"repath_unavoidable_blocker "+L.id),g.moveTrait.velocity.set(0,0,0)),!1):(ue=L.unitOrderTrait.hasTasks(),this.pushTried||L.isBuilding()||L.moveTrait.collisionState===V.CollisionState.Waiting||ue||L.isAircraft()&&L.missileSpawnTrait?(!this.options?.forceWaitOnPathBlocked&&(L.isBuilding()||ue&&L.moveTrait.moveState===V.MoveState.Idle||this.inPlanningForTicks+40>200)?(this.needsPathUpdate=!0,this.allObstaclesAreBlockers=!0,this.log(g,"repath_blocker_busy_wait_timeout "+L.id),g.moveTrait.velocity.set(0,0,0)):(this.children.push(new W.WaitTicksTask(40)),this.options?.forceWaitOnPathBlocked?this.inPlanningForTicks=0:this.inPlanningForTicks+=40,g.moveTrait.velocity.set(0,0,0),g.moveTrait.collisionState=V.CollisionState.Waiting),!1):(ue=new oe.Vector2(L.tile.rx-g.tile.rx,L.tile.ry-g.tile.ry),this.pushTried=!0,L.unitOrderTrait.addTask(new z.MoveAsideTask(this.game,ue)),this.children.push(new W.WaitTicksTask(1)),g.moveTrait.velocity.set(0,0,0),g.moveTrait.collisionState=V.CollisionState.Waiting,this.log(g,"push "+L.id),!1))}}if(L.isInfantry()&&g.isInfantry()){var ue=this.findFreeSubCell(g,$);if(void 0!==ue)return this.relocateToSubCell(g,ue),this.onTick(g)}if(!J)return this.inPlanningForTicks>40&&(g.moveTrait.collisionState=V.CollisionState.Waiting),!1;if(180===Math.abs(g.direction-L.direction))return g.moveTrait.velocity.set(0,0,0),g.moveTrait.collisionState=V.CollisionState.Waiting,!1;if(Math.abs(g.direction-L.direction)<=45&&1.5*ce<J){if(5<=(ce=this.path.indexOf($))){let P=U.findIndexReverse(this.path.slice(0,ce-5),P=>!I.terrain.findObstacles(P,g).length);if(-1!==P&&(ce=this.path[P],ce=I.terrain.computePath(g.rules.speedType,g.isInfantry(),g.tile,g.onBridge,ce.tile,!!ce.onBridge,{maxExpandedNodes:15,bestEffort:!1,excludeTiles:L=>!!I.terrain.findObstacles(L,g).length||this.path.findIndex(g=>g.tile===L.tile&&g.onBridge===L.onBridge)>P}),ce.length))return this.path.splice(P,this.path.length,...ce),g.moveTrait.currentWaypoint=void 0,g.moveTrait.moveState=V.MoveState.ReachedNextWaypoint,this.onTick(g)}return g.moveTrait.collisionState=V.CollisionState.Waiting,g.moveTrait.velocity.set(0,0,0),!1}return g.moveTrait.velocity.set(0,0,0),g.moveTrait.collisionState=V.CollisionState.Waiting,!1}}}if(g.rules.speedType===G.SpeedType.Track&&J)if(0<(ge=this.path.indexOf(g.moveTrait.currentWaypoint))){let P=this.path[ge-1];for(Z of I.getGroundObjectsOnTile(P.tile).filter(I=>I.isUnit()&&I.onBridge===!!P.onBridge&&I.rules.crushable&&I.veteranTrait?.hasVeteranAbility(ne.VeteranAbility.SCATTER)&&!this.game.areFriendly(I,g)))Z.unitOrderTrait.hasTasks()||Z.unitOrderTrait.addTask(new ae.ScatterTask(this.game))}g.moveTrait.reservedPathNodes.length||(g.moveTrait.reservedPathNodes.push(...P),P.forEach(P=>{I.tileOccupation.occupySingleTile(P.tile,g)}))}g.moveTrait.moveState=V.MoveState.Moving,this.inPlanningForTicks=void 0,this.unreachableTargets.length=0,this.pushTried=!1,g.moveTrait.collisionState===V.CollisionState.Waiting&&(g.moveTrait.collisionState=V.CollisionState.Resolved)}if(g.moveTrait.moveState===V.MoveState.Moving){let P=g.moveTrait.locomotor,{distance:I,done:L,isTeleport:_}=P.tick(g,this.currentWaypointLeptons,this.destinationLeptons,(this.isCancelling()||!this.path.length)&&!this.cancelRepositionPending);if(_&&g.traits.filter(re.NotifyTeleport).forEach(P=>{P[re.NotifyTeleport.onBeforeTeleport](g,this.game,!0,!0)}),I.length()&&(K=g.tile,ge=P.allowOutOfBounds,I.y?(de=g.tileElevation,g.position.moveByLeptons3(I,ge),g.moveTrait.handleElevationChange(de,this.game)):g.position.moveByLeptons(I.x,I.z,ge),g.tile!==K)){var de=g.onBridge?this.game.map.tileOccupation.getBridgeOnTile(K):void 0,ge=U.findReverse(this.path,P=>P.tile===g.tile);let P=ge?ge.onBridge:de||g.moveTrait.currentWaypoint.onBridge?this.game.map.tileOccupation.getBridgeOnTile(g.tile):void 0;if(P?.isDestroyed&&(P=void 0),g.moveTrait.handleTileChange(K,P,!1,this.game,_),_&&(g.moveTrait.lastTeleportTick=this.game.currentTick,this.game.events.dispatch(new te.ObjectTeleportEvent(g,!0,K))),g.isDestroyed)return!0}if(L)return g.moveTrait.moveState=V.MoveState.ReachedNextWaypoint,this.onTick(g)}return!1}selectWeaponVsObstacle(g,P){let I;if(!this.game.areFriendly(P,g)&&g.attackTrait&&!g.attackTrait.isDisabled()&&g.attackTrait.isIdle()&&(I=g.attackTrait.selectWeaponVersus(g,P,this.game,!1,!0))&&I.name!==g.armedTrait?.deathWeapon?.name&&(!I.rules.limboLaunch||!I.warhead.rules.parasite)&&!I.warhead.rules.mindControl)return I}findRelocationTile(g,P,I){let L,U=this.game.map;if(I.rules.movementZone===_.MovementZone.Fly){var t=g=>!U.tileOccupation.getGroundObjectsOnTile(g).some(g=>g.isBuilding()&&!g.isDestroyed||g.isTerrain()||g.isOverlay()&&g.rules.isARock)&&(I.rules.locomotor!==le.LocomotorType.Jumpjet||0<this.game.map.terrain.getPassableSpeed(g,G.SpeedType.Amphibious,I.isInfantry(),!!g.onBridgeLandType));if(L=new ee.RandomTileFinder(U.tiles,U.mapBounds,g,1,this.game,t).getNextTile(),!L){L=new q.RadialTileFinder(U.tiles,U.mapBounds,g,I.getFoundation(),2,15,t).getNextTile()}}else{let _=!this.options?.ignoredBlockers?.length&&U.terrain.getPassableSpeed(I.tile,I.rules.speedType,I.isInfantry(),I.onBridge)?this.game.map.terrain.getIslandIdMap(I.rules.speedType,I.isInfantry()):void 0,G=_?.get(I.tile,I.onBridge),V=new K.MovePositionHelper(U),W=new q.RadialTileFinder(U.tiles,U.mapBounds,g,{width:1,height:1},0,5,L=>{let W=!P||P.isHighBridge()?U.tileOccupation.getBridgeOnTile(L):void 0;return!this.unreachableTargets.find(g=>g.tile===L&&g.toBridge===!!W)&&(I.zone===X.ZoneType.Air||_?.get(L,!!W)===G&&!U.terrain.findObstacles({tile:L,onBridge:W},I).length&&V.isEligibleTile(L,W,P,g))&&this.canStopAtTile(I,L,!!W)});L=W.getNextTile()}return L}findFreeSubCell(g,P){let I=this.game.map.getGroundObjectsOnTile(P.tile);var _=I.filter(I=>I.isInfantry()&&I.onBridge===!!P.onBridge&&I!==g).map(g=>g.position.desiredSubCell),U=I.filter(g=>g.isTerrain()).map(g=>g.rules.getOccupiedSubCells(this.game.map.getTheaterType())).flat();let G=[..._,...U];return L.Infantry.SUB_CELLS.find(g=>-1===G.indexOf(g))}relocateToSubCell(g,P){g.position.desiredSubCell=P;var I=g.position.computeSubCellOffset(P);this.targetOffset=I,this.currentWaypointLeptons.set(g.moveTrait.currentWaypoint.tile.rx,g.moveTrait.currentWaypoint.tile.ry).multiplyScalar(Y.Coords.LEPTONS_PER_TILE).add(this.targetOffset),this.updateDestination(this.path,this.targetOffset),g.moveTrait.locomotor.onWaypointUpdate?.(g,this.currentWaypointLeptons,this.destinationLeptons)}getTargetLinesConfig(g){var P,I;return this.path||(P=new J.LocomotorFactory(this.game).create(g),(this.options?.allowOutOfBoundsTarget||this.game.map.mapBounds.isWithinBounds(this.targetTile))&&g.rules.movementZone!==_.MovementZone.Fly&&!P.ignoresTerrain&&g.unitOrderTrait.getCurrentTask()?.isCancelling()?this.groundPathPlan||(I=this.computeGroundPath(g),this.targetLinesConfig.pathNodes=I.path,I.path.length&&(this.groundPathPlan=I)):((I=g.moveTrait).locomotor??(I.locomotor=P),this.computePath(g,g.moveTrait.locomotor)),this.targetLinesConfig.isRecalc=!1),this.targetLinesConfig}log(g,P){this.logger.debug(`<${g.id}>: `+P)}},g("MoveTask",ce)}}}),System.register("game/gameobject/task/move/MoveToBlockTask",["game/gameobject/trait/MoveTrait","game/gameobject/task/system/Task","game/gameobject/task/move/MoveTask"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class extends L.Task{constructor(g,P){super(),this.game=g,this.target=P,this.preventOpportunityFire=!1,this.useChildTargetLines=!0,this.attackPerformed=!1}onStart(g){this.children.push(new _.MoveTask(this.game,this.target.centerTile,!1,{closeEnoughTiles:1,pathFinderIgnoredBlockers:[this.target],stopOnBlocker:this.target}))}onTick(g){if(this.attackPerformed||this.isCancelling()||!g.attackTrait||g.attackTrait.isDisabled())return!0;if(g.moveTrait.lastMoveResult!==I.MoveResult.CloseEnough)return!0;var P=g.attackTrait.selectWeaponVersus(g,this.target,this.game,!0);return!(P&&(this.children.push(g.attackTrait.createAttackTask(this.game,this.target,this.target.tile,P,{force:!0})),this.attackPerformed=!0))}},g("MoveToBlockTask",U)}}}),System.register("game/gameobject/task/MoveToDockTask",["game/gameobject/task/system/Task","game/map/tileFinder/RadialTileFinder","game/gameobject/task/move/MoveTask","game/gameobject/task/system/WaitMinutesTask","game/gameobject/task/system/CallbackTask","game/gameobject/trait/MoveTrait","game/type/MovementZone","game/gameobject/trait/interface/NotifyTick","game/Coords","game/math/Vector2"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g}],execute:function(){var P;(P=$=$||{})[P.Idle=0]="Idle",P[P.MoveToQueueingTile=1]="MoveToQueueingTile",P[P.WaitForTurn=2]="WaitForTurn",P[P.MoveToDock=3]="MoveToDock",P[P.Docking=4]="Docking",P[P.Docked=5]="Docked",Q=class extends I.Task{constructor(g,P){super(),this.game=g,this.target=P,this.useChildTargetLines=!0,this.preventOpportunityFire=!1,this.dockingStatus=$.Idle}onStart(g){if(!this.target.dockTrait)throw new Error(`Target object "${this.target.name}" is not a valid dock`);var P;this.target.dockTrait.hasReservedDockForUnit(g)?this.dockingStatus=$.MoveToDock:void 0!==(P=this.target.dockTrait.getFirstAvailableDockNumber())?(this.target.dockTrait.reserveDockAt(g,P),this.dockingStatus=$.MoveToDock):this.target.helipadTrait?this.cancel():this.dockingStatus=$.MoveToQueueingTile}onEnd(g){this.dockingStatus!==$.Docked&&this.target.isSpawned&&(this.target.dockTrait.undockUnit(g),this.target.dockTrait.unreserveDockForUnit(g)),this.dockingStatus=$.Idle}onTick(g){if(this.isCancelling())return!0;if(!this.isValidTarget(this.target,g))return!0;if(this.dockingStatus===$.MoveToQueueingTile){var P=this.findReachableQueueingTile(g);if(!P)return!0;if(g.tile!==P)return this.children.push(new _.MoveTask(this.game,P,!1,{closeEnoughTiles:5}),new G.CallbackTask(()=>{g.moveTrait.lastMoveResult===V.MoveResult.Fail?this.cancel():g.moveTrait.lastMoveResult===V.MoveResult.CloseEnough&&(this.game.map.tileOccupation.isTileOccupiedBy(g.tile,this.target)||(this.dockingStatus=$.WaitForTurn))})),!1;this.dockingStatus=$.WaitForTurn}if(this.dockingStatus===$.WaitForTurn){if(void 0===(L=this.target.dockTrait.getFirstAvailableDockNumber()))return this.children.push(new U.WaitMinutesTask(1/60)),!1;this.target.dockTrait.reserveDockAt(g,L),this.dockingStatus=$.MoveToDock}if(this.dockingStatus===$.MoveToDock){var I=this.target.dockTrait.getReservedDockForUnit(g),L=this.target.dockTrait.getDockTile(I);I=K.Coords.vecWorldToGround(this.target.dockTrait.getDockOffset(I)).add(this.target.position.getMapPosition()).sub(new q.Vector2(L.rx,L.ry).multiplyScalar(K.Coords.LEPTONS_PER_TILE));if(g.tile!==L)return this.children.push(new _.MoveTask(this.game,L,!1,{targetOffset:g.isAircraft()?I:void 0,closeEnoughTiles:0,strictCloseEnough:!0}),new G.CallbackTask(()=>{g.moveTrait.lastMoveResult===V.MoveResult.Fail&&this.cancel()})),this.game.afterTick(()=>g.unitOrderTrait[z.NotifyTick.onTick](g,this.game)),!1;this.dockingStatus=$.Docking}return this.dockingStatus===$.Docking&&(I=this.target.dockTrait.getReservedDockForUnit(g),this.target.dockTrait.unreserveDockForUnit(g),this.target.dockTrait.dockUnitAt(g,I),g.isAircraft()&&g.airportBoundTrait&&this.target.helipadTrait&&(g.airportBoundTrait.preferredAirport=this.target),this.dockingStatus=$.Docked,!0)}isValidTarget(g,P){return g.isSpawned&&this.game.areFriendly(g,P)}findReachableQueueingTile(g){var P=this.target.getFoundation();P=new q.Vector2(this.target.tile.rx+P.width,this.target.tile.ry+P.height);return(P=this.game.map.tiles.getByMapCoords(P.x,P.y))&&this.isValidQueueingTile(P,g)?P:new L.RadialTileFinder(this.game.map.tiles,this.game.map.mapBounds,this.target.tile,this.target.getFoundation(),1,1,P=>this.isValidQueueingTile(P,g)).getNextTile()}isValidQueueingTile(g,P){var I=P.rules.movementZone===W.MovementZone.Fly,L=P.rules.speedType,_=P.isInfantry();let U=!I&&this.game.map.terrain.getPassableSpeed(P.tile,L,_,P.onBridge)?this.game.map.terrain.getIslandIdMap(L,_):void 0;return(I||U?.get(g,!1)===U?.get(P.tile,P.onBridge)&&Math.abs(g.z-this.target.tile.z)<2&&!g.onBridgeLandType&&!this.game.map.terrain.findObstacles({tile:g,onBridge:void 0},P).length)&&!this.game.map.tileOccupation.isTileOccupiedBy(g,this.target)}},g("MoveToDockTask",Q)}}}),System.register("game/gameobject/task/ParadropTask",["game/Coords","game/math/Vector3","game/gameobject/infantry/InfDeathType","game/gameobject/infantry/StanceType","game/gameobject/task/system/Task"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){V=class extends G.Task{constructor(g){super(),this.game=g}onTick(g){var P=Math.abs(this.game.rules.general.parachuteMaxFallRate),G=g.tile.onBridgeLandType?this.game.map.tileOccupation.getBridgeOnTile(g.tile).tileElevation:0,V=I.Coords.tileHeightToWorld(G),W=g.tileElevation,z=I.Coords.tileHeightToWorld(W);return V<Math.max(V,z-P)?(g.position.moveByLeptons3(new L.Vector3(0,-P,0)),g.moveTrait.handleElevationChange(W,this.game),!1):(g.position.tileElevation=G,g.stance=U.StanceType.None,this.game.map.terrain.getPassableSpeed(g.tile,g.rules.speedType,g.isInfantry(),g.onBridge)||(g.infDeathType=_.InfDeathType.None,this.game.destroyObject(g,void 0,!0)),!0)}},g("ParadropTask",V)}}}),System.register("game/gameobject/task/PlantC4Task",["game/GameSpeed","game/event/EnterObjectEvent","game/gameobject/task/EnterBuildingTask"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class extends _.EnterBuildingTask{isAllowed(g){return!this.target.isDestroyed&&!this.target.invulnerableTrait.isActive()}onEnter(g){var P=Math.floor(60*this.game.rules.combatDamage.c4Delay*I.GameSpeed.BASE_TICKS_PER_SECOND);return this.target.c4ChargeTrait.setCharge(P,{player:g.owner,obj:g}),this.game.events.dispatch(new L.EnterObjectEvent(this.target,g)),!1}getTargetLinesConfig(g){return{target:this.target,pathNodes:[],isAttack:!0}}},g("PlantC4Task",U)}}}),System.register("game/gameobject/task/RepairBuildingTask",["game/event/BuildingRepairFullEvent","game/event/BridgeRepairEvent","game/gameobject/task/EnterBuildingTask"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class extends _.EnterBuildingTask{isAllowed(g){return this.target.cabHutTrait?this.target.cabHutTrait.canRepairBridge():g.rules.engineer&&!this.target.isDestroyed&&this.target.rules.repairable&&this.target.healthTrait.health<100&&(!this.target.owner.isCombatant()&&!!this.target.garrisonTrait||this.game.areFriendly(g,this.target))}onEnter(g){this.game.unspawnObject(g),this.target.cabHutTrait?(this.target.cabHutTrait.repairBridge(this.game,g.owner),this.game.events.dispatch(new L.BridgeRepairEvent(g.owner,this.target.centerTile))):(this.target.healthTrait.healToFull(g,this.game),this.game.events.dispatch(new I.BuildingRepairFullEvent(this.target,g.owner)))}},g("RepairBuildingTask",U)}}}),System.register("game/gameobject/task/ScatterTask",["game/gameobject/task/move/MoveTask","game/gameobject/task/system/Task","game/gameobject/unit/ScatterPositionHelper","game/type/MovementZone"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=class extends L.Task{constructor(g,P,I){super(),this.game=g,this.target=P,this.options=I}onStart(g){if(!g.moveTrait.isDisabled()&&g.rules.movementZone!==U.MovementZone.Fly){let L,U;if(this.target)({tile:L,toBridge:U}=this.target);else{var P=new _.ScatterPositionHelper(this.game).findPositions([g],this.options).get(g);if(!P)return;L=P.tile,U=!!P.onBridge}this.children.push(new I.MoveTask(this.game,L,U,{closeEnoughTiles:0,ignoredBlockers:this.options?.ignoredBlockers}))}}onTick(g){return!0}},g("ScatterTask",G)}}}),System.register("game/gameobject/task/system/CallbackTask",["game/gameobject/task/system/Task"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.Task{constructor(g){super(),this.cb=g}onTick(g){return this.cb(g),!0}},g("CallbackTask",L)}}}),System.register("game/gameobject/task/system/TargetLinesConfig",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("cloneConfig",g=>g?{...g}:void 0),g("configsAreEqual",(g,P)=>!g&&!P||g?.isAttack===P?.isAttack&&g?.pathNodes===P?.pathNodes&&g?.target===P?.target),g("configHasTarget",g=>!(!g?.pathNodes.length&&!g?.target))}}}),System.register("game/gameobject/task/system/Task",["game/gameobject/task/system/TaskStatus"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("Task",class{constructor(){this.status=I.TaskStatus.NotStarted,this.children=[],this.cancellable=!0,this.useChildTargetLines=!1,this.blocking=!0,this.waitingForChildrenToFinish=!1,this.preventOpportunityFire=!0,this.preventLanding=!0,this.isAttackMove=!1}isRunning(){return this.status===I.TaskStatus.Running}isCancelling(){return this.status===I.TaskStatus.Cancelling}setCancellable(g){return this.cancellable=g,this}setBlocking(g){return this.blocking=g,this}onStart(g){}onEnd(g){}cancel(){if(this.cancellable)if(this.status===I.TaskStatus.Running)this.status=I.TaskStatus.Cancelling,this.children.length&&this.children.forEach(g=>g.cancel());else if(this.status===I.TaskStatus.NotStarted&&(this.status=I.TaskStatus.Cancelled,this.children.length))throw new Error("Should't have any children before starting a task")}getTargetLinesConfig(g){}})}}}),System.register("game/gameobject/task/system/TaskGroup",["game/gameobject/task/system/Task"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.Task{constructor(...g){super(),this.children.push(...g)}onTick(g){return!0}},g("TaskGroup",L)}}}),System.register("game/gameobject/task/system/TaskRunner",["game/gameobject/task/system/TaskStatus"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("TaskRunner",class{tick(g,P){this.tickChildren(g,P)}startTask(g,P){if(g.status!==I.TaskStatus.NotStarted)throw new Error("Attempted to start a task with status "+g.status);g.status=I.TaskStatus.Running,g.onStart(P)}tickTask(g,P){let L=this.tickChildren(g.children,P);var _=g.children.find(g=>g.blocking);if(!L&&_)return!1;if(!P.isSpawned)return!1;if(g.status===I.TaskStatus.NotStarted)throw new Error("Attempted tick on a non-started task");if(g.isRunning()||g.isCancelling()){var U=g.isCancelling(),G=!!g.waitingForChildrenToFinish||g.onTick(P);return g.children.length&&!_&&G&&(L=g.children.every(g=>g.status===I.TaskStatus.Cancelled||g.status===I.TaskStatus.Finished),g.waitingForChildrenToFinish=!L),(G=G&&L)&&(g.onEnd(P),g.status=U?I.TaskStatus.Cancelled:I.TaskStatus.Finished),G}return!0}tickChildren(g,P){let L=!0;if(g.length){let U,G=new Set;for(;P.isSpawned&&(U=g.find(g=>!G.has(g)));){let V;if(U.status===I.TaskStatus.NotStarted&&this.startTask(U,P),U.status===I.TaskStatus.Running||U.status===I.TaskStatus.Cancelling)V=!0===this.tickTask(U,P);else{if(U.status!==I.TaskStatus.Cancelled)throw new Error("Unhandled task status "+I.TaskStatus[U.status]);V=!0}if(V){var _=g.indexOf(U);-1!==_&&g.splice(_,1)}else{if(L=!1,U.blocking)break;G.add(U)}}}return L}})}}}),System.register("game/gameobject/task/system/TaskStatus",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("TaskStatus",I={}))[P.NotStarted=0]="NotStarted",P[P.Running=1]="Running",P[P.Finished=2]="Finished",P[P.Cancelling=3]="Cancelling",P[P.Cancelled=4]="Cancelled"}}}),System.register("game/gameobject/task/system/WaitMinutesTask",["game/gameobject/task/system/WaitTicksTask","game/GameSpeed"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends I.WaitTicksTask{constructor(g){super(Math.floor(L.GameSpeed.BASE_TICKS_PER_SECOND*g*60))}},g("WaitMinutesTask",_)}}}),System.register("game/gameobject/task/system/WaitTicksTask",["game/gameobject/task/system/Task"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.Task{constructor(g){super(),this.ticks=g}onTick(){return!(!this.isCancelling()&&0<this.ticks--)}},g("WaitTicksTask",L)}}}),System.register("game/gameobject/task/TurnTask",["game/gameobject/task/system/Task","game/gameobject/unit/FacingUtil"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends I.Task{constructor(g){super(),this.direction=g,this.cancellable=!1}onTick(g){if(g.direction===this.direction)return!(g.spinVelocity=0);var P=g.rules.rot,{facing:I,delta:P}=L.FacingUtil.tick(g.direction,this.direction,P);return g.direction=I,g.spinVelocity=P,!1}},g("TurnTask",_)}}}),System.register("game/gameobject/task/WaitForBuildUpTask",["game/gameobject/Building","game/gameobject/task/system/CallbackTask","game/gameobject/task/system/TaskGroup","game/gameobject/task/system/WaitMinutesTask"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=class extends _.TaskGroup{constructor(g,P){super(new U.WaitMinutesTask(g),new L.CallbackTask(g=>g.setBuildStatus(I.BuildStatus.Ready,P))),this.cancellable=!1}},g("WaitForBuildUpTask",G)}}}),System.register("game/gameobject/Techno",["game/gameobject/GameObject","game/rules/TechnoRules","game/gameobject/unit/VeteranLevel","game/gameobject/trait/interface/NotifyTick"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=class extends I.GameObject{get primaryWeapon(){return this.armedTrait?.primaryWeapon}get secondaryWeapon(){return this.armedTrait?.secondaryWeapon}get ammo(){return this.ammoTrait?.ammo}get sight(){return Math.min(L.TechnoRules.MAX_SIGHT,this.rules.sight*(this.veteranTrait?.getVeteranSightMultiplier()??1))}get veteranLevel(){return this.veteranTrait?.veteranLevel??_.VeteranLevel.None}constructor(g,P,I,L){super(g,P,I,L),this.explodes=this.rules.explodes,this.radarInvisible=this.rules.radarInvisible,this.c4=this.rules.c4,this.crusher=this.rules.crusher,this.defaultToGuardArea=this.rules.defaultToGuardArea,this.guardMode=this.rules.defaultToGuardArea,this.purchaseValue=this.rules.cost}resetGuardModeToIdle(){this.guardMode=this.defaultToGuardArea,this.guardArea=void 0}update(g){if(this.warpedOutTrait.isActive())for(var P of this.cachedTraits.tick)P.ticksWhenWarpedOut&&P[U.NotifyTick.onTick](this,g);else super.update(g)}isTechno(){return!0}},g("Techno",G)}}}),System.register("game/gameobject/Terrain",["engine/type/ObjectType","game/gameobject/GameObject"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.GameObject{static factory(g,P,I){return new this(g,P,I)}constructor(g,P,L){super(I.ObjectType.Terrain,g,P,L),this.radarInvisible=this.rules.radarInvisible}},g("Terrain",_)}}}),System.register("game/gameobject/trait/AgentTrait",["game/rules/TechnoRules","util/math"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("AgentTrait",class{infiltrate(g,P,_){var U,G;P.rules.radar&&![...P.owner.buildings].some(g=>g.rules.spySat)&&_.mapShroudTrait.resetShroud(P.owner,_),0<P.rules.power&&(U=_.rules.general.spyPowerBlackout,P.owner.powerTrait?.setBlackoutFor(U,_)),P.superWeaponTrait&&P.superWeaponTrait.getSuperWeapon(P)?.resetTimer(),0<P.rules.storage&&(G=L.clamp(_.rules.general.spyMoneyStealPercent,0,1),G=Math.floor(P.owner.credits*G),P.owner.credits-=G,g.owner.credits+=G),!_.rules.ai.buildTech.includes(P.name)||void 0!==(G=P.rules.aiBasePlanningSide)&&g.owner.production.addStolenTech(G),P.factoryTrait&&[I.FactoryType.InfantryType,I.FactoryType.UnitType].includes(P.factoryTrait.type)&&g.owner.production?.addVeteranType(P.factoryTrait.type)}})}}}),System.register("game/gameobject/trait/AirportBoundTrait",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("AirportBoundTrait",class{constructor(g){this.airportNames=g}findAvailableAirport(g){return[...g.owner.buildings].find(g=>g.dockTrait&&this.airportNames.includes(g.name)&&0<g.dockTrait.getAvailableDockCount())}})}}}),System.register("game/gameobject/trait/AirSpawnTrait",["game/Coords","engine/type/ObjectType","game/Warhead","game/gameobject/unit/CollisionType","game/gameobject/task/move/MoveTask","game/gameobject/task/system/CallbackTask","game/gameobject/task/system/TaskGroup","game/gameobject/unit/FacingUtil","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyTeleport","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyUnspawn","game/gameobject/trait/interface/NotifyWarpChange","game/gameobject/unit/ZoneType"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g}],execute:function(){ee=class{constructor(){this.spawns=[],this.storage=[],this.missileLaunches=[],this.nextRegenTicks=[]}get availableSpawns(){return this.storage.length}debugSetStorage(g,P){this.storage.length=P,this.storage.fill(g,0,P)}isLaunchingMissiles(){return 0<this.missileLaunches.length}[$.NotifySpawn.onSpawn](g,P){var I=P.rules.getObject(g.rules.spawns,L.ObjectType.Aircraft);for(let L=0;L<g.rules.spawnsNumber;L++)this.pushNewSpawn(I,P,g)}[Z.NotifyUnspawn.onUnspawn](g,P){this.destroySpawns(g,P)}[K.NotifyDestroy.onDestroy](g,P,I,L){this.destroySpawns(g,P,I,L)}pushNewSpawn(g,P,I){let L=P.createUnitForPlayer(g,I.owner);L.limboData={selected:!1,controlGroup:void 0},g.missileSpawn&&(L.pitch=90*P.rules.general.getMissileRules(g.name).pitchInitial),this.spawns.push(L),this.storage.push(L)}destroySpawns(g,P,I,L){for(var _ of this.spawns)_.isDestroyed||(_.isSpawned&&!_.rules.missileSpawn&&_.crashableTrait?_.crashableTrait.crash(I):(_.isSpawned||(_.armedTrait&&(_.armedTrait.deathWeapon=void 0),_.position.tileElevation=g.position.tileElevation,_.zone=g.isUnit()?g.zone:J.ZoneType.Ground,_.onBridge=!!g.isUnit()&&g.onBridge,_.position.tile=g.tile),P.destroyObject(_,I,L)));this.spawns.length=0,this.storage.length=0,this.missileLaunches.length=0}[Y.NotifyTick.onTick](g,P){var _;if(this.spawns=this.spawns.filter(g=>!g.isDestroyed),this.missileLaunches=this.missileLaunches.filter(g=>!g.missile.isDestroyed),this.spawns.length<g.rules.spawnsNumber){var K=g.rules.spawnsNumber-this.spawns.length,q=P.rules.getObject(g.rules.spawns,L.ObjectType.Aircraft);for(let I=0;I<K;I++)q.missileSpawn&&I&&void 0===this.nextRegenTicks[I]?this.nextRegenTicks[I]=this.nextRegenTicks[0]:((_=this.nextRegenTicks)[I]??(_[I]=g.rules.spawnRegenRate),0<this.nextRegenTicks[I]&&this.nextRegenTicks[I]--),this.nextRegenTicks[I]<=0&&this.pushNewSpawn(q,P,g);this.nextRegenTicks=this.nextRegenTicks.filter(g=>0<g)}if(this.storage.length){if(this.nextReloadTicks??(this.nextReloadTicks=g.rules.spawnReloadRate),0<this.nextReloadTicks&&this.nextReloadTicks--,this.nextReloadTicks<=0){for(var $ of this.storage)$.ammoTrait&&$.ammoTrait.ammo<$.ammoTrait.maxAmmo&&$.ammoTrait.ammo++;this.nextReloadTicks=g.rules.spawnReloadRate}}else this.nextReloadTicks=void 0;for(let L of this.missileLaunches.slice()){var Q=P.rules.general.getMissileRules(L.missile.name);if(L.pauseFrames??(L.pauseFrames=Q.pauseFrames),0<L.pauseFrames&&L.pauseFrames--,L.pauseFrames<=0){var Y=90*Q.pitchFinal;Q=90*(Q.pitchFinal-Q.pitchInitial)/Q.tiltFrames;let _=L.missile;if(_.pitch<Y)_.pitch=Math.min(Y,_.pitch+Q);else{if(_.unitOrderTrait.addTask(new W.TaskGroup(new G.MoveTask(P,L.targetTile,!!L.targetBridge),new V.CallbackTask(()=>{var G,V;_.isDestroyed||(P.unspawnObject(_),_.dispose(),V=I.Coords.vecGroundToWorld(z.FacingUtil.toMapCoords(_.direction).multiplyScalar(1)),G=L.targetWorldPos.clone().add(V),V=P.map.getTileZone(L.targetTile),L.warhead.detonate(P,L.damage,L.targetTile,L.targetBridge?.tileElevation??0,G,V,L.targetBridge?U.CollisionType.OnBridge:U.CollisionType.None,L.target,{player:_.owner,obj:g,weapon:void 0}))})).setCancellable(!1)),-1===(Q=this.spawns.indexOf(_)))throw new Error("Missile not found in spawns list");this.spawns.splice(Q,1),this.missileLaunches.splice(this.missileLaunches.indexOf(L),1)}}}}[q.NotifyOwnerChange.onChange](g,P,I){for(var L of this.spawns)L.isDestroyed||I.changeObjectOwner(L,g.owner)}[X.NotifyWarpChange.onChange](g,P,I){I&&this.removeMissileLaunches(P)}[Q.NotifyTeleport.onBeforeTeleport](g,P,I,L){L||this.removeMissileLaunches(P)}removeMissileLaunches(g){if(this.missileLaunches.length){for(var P of this.missileLaunches){if(g.unspawnObject(P.missile),P.missile.dispose(),-1===(P=this.spawns.indexOf(P.missile)))throw new Error("Missile not found in spawns list");this.spawns.splice(P,1)}this.missileLaunches.length=0}}prepareLaunch(g,P,I){if(this.storage.length){let G=this.storage[0];if(!G.ammo)return;if(this.storage.shift(),G.missileSpawnTrait){let V,W;var L=g.veteranTrait?.isElite(),U=I.rules;if(g.rules.spawns===U.general.v3Rocket.type)V=L?U.combatDamage.v3EliteWarhead:U.combatDamage.v3Warhead,W=L?U.general.v3Rocket.eliteDamage:U.general.v3Rocket.damage;else{if(g.rules.spawns!==U.general.dMisl.type)throw new Error(`Unhandled missile type "${g.rules.spawns}"`);V=L?U.combatDamage.dMislEliteWarhead:U.combatDamage.dMislWarhead,W=L?U.general.dMisl.eliteDamage:U.general.dMisl.damage}U=new _.Warhead(I.rules.getWarhead(V)),G.missileSpawnTrait.setDamage(W).setWarhead(U).setLauncher(g),this.missileLaunches.push({missile:G,targetTile:(P.obj?.isUnit()?P.obj:P).tile,targetBridge:P.getBridge(),targetWorldPos:P.getWorldCoords().clone(),target:P,warhead:U,damage:W,pauseFrames:void 0})}else{if(!G.spawnLinkTrait)throw new Error(`Aircraft "${G.name}" must have Spawned=yes to be launchable`);G.spawnLinkTrait.setParent(g)}return G}}storeAircraft(g,P){if(!this.spawns.includes(g))throw new Error(`Object "${g.name}#${g.id}" not found in list of linked spawns`);if(g.limboData)throw new Error(`Object "${g.name}#${g.id}" is already in limbo`);P.limboObject(g,{selected:!1,controlGroup:void 0}),this.storage.push(g)}},g("AirSpawnTrait",ee)}}}),System.register("game/gameobject/trait/AmmoTrait",["util/math"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("AmmoTrait",class{constructor(g,P=g){this.maxAmmo=g,this.ammo=P}get ammo(){return this._ammo}set ammo(g){this._ammo=I.clamp(g,0,this.maxAmmo)}isFull(){return this.ammo===this.maxAmmo}})}}}),System.register("game/gameobject/trait/ArmedTrait",["game/Weapon","game/WeaponType","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/unit/VeteranLevel","util/typeGuard"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){W=class{constructor(g,P){this.gameObject=g,this.rules=P,this.specialWeaponIndex=0;var I=g.veteranLevel===G.VeteranLevel.Elite;g.rules.weaponCount?(this.selectSpecialWeapon(0,I),this.guardWeaponRangeOverride=this.primaryWeapon?.range):this.selectStandardWeapons(I)}selectStandardWeapons(g=!1){var P=this.gameObject,_=g&&P.rules.elitePrimary||P.rules.primary;_?(G=g?P.art.elitePrimaryFireFlh:P.art.primaryFireFlh,this.primaryWeapon=I.Weapon.factory(_,L.WeaponType.Primary,P,this.rules,G)):this.primaryWeapon=void 0;var U,G=g&&P.rules.eliteSecondary||P.rules.secondary;G?(U=g?P.art.eliteSecondaryFireFlh:P.art.secondaryFireFlh,this.secondaryWeapon=I.Weapon.factory(G,L.WeaponType.Secondary,P,this.rules,U)):this.secondaryWeapon=void 0,(P.explodes||P.crashableTrait)&&(U=P.rules.deathWeapon||!!P.crashableTrait&&this.secondaryWeapon?.rules.name||this.primaryWeapon?.rules.name||this.rules.combatDamage.deathWeapon,this.deathWeapon=I.Weapon.factory(U,L.WeaponType.DeathWeapon,P,this.rules))}selectSpecialWeapon(g,P=!1){let _=this.gameObject;var U=_.rules.weaponCount;if(U<1)throw new Error(`Object "${_.name}" doesn't support special weapons`);if(U-1<g)throw new RangeError(`Weapon index ${g} out of bounds (max ${U}) for object `+_.name);var G=P&&_.rules.getEliteWeaponAtIndex(g)||_.rules.getWeaponAtIndex(g);if(!G)throw new Error(`Missing weapon at index ${g} for object "${_.name}"`);U=_.art.getSpecialWeaponFlh(g),this.primaryWeapon=I.Weapon.factory(G,L.WeaponType.Primary,_,this.rules,U),this.secondaryWeapon=void 0,this.specialWeaponIndex=g,this.deathWeapon=this.primaryWeapon.rules.suicide?I.Weapon.factory(_.rules.deathWeapon||this.primaryWeapon.name,L.WeaponType.DeathWeapon,_,this.rules):void 0}toggleEliteWeapons(g){this.gameObject.rules.weaponCount?this.selectSpecialWeapon(this.specialWeaponIndex,g):this.selectStandardWeapons(g)}getSpecialWeaponIndex(){return this.specialWeaponIndex}computeGuardScanRange(g){var P=this.guardWeaponRangeOverride??[this.primaryWeapon,this.secondaryWeapon].filter(P=>P===g||P?.rules.neverUse).reduce((g,P)=>Math.max(g,P.range),0);P=Math.max(P,this.gameObject.rules.guardRange);return Math.min(15,2*P-1)}getDeployFireWeapon(){if(this.gameObject.rules.deployFire)return this.gameObject.rules.deployFireWeapon===L.WeaponType.Primary?this.primaryWeapon:this.secondaryWeapon}isEquippedWithWeapon(g){return[this.primaryWeapon,this.secondaryWeapon].includes(g)}getWeapons(){return[this.primaryWeapon,this.secondaryWeapon].filter(V.isNotNullOrUndefined)}[_.NotifyTick.onTick](){this.primaryWeapon&&this.primaryWeapon.tick(),this.secondaryWeapon&&this.secondaryWeapon.tick()}[U.NotifyDestroy.onDestroy](g,P,I){!this.deathWeapon||I?.weapon?.warhead.rules.temporal||g.crashableTrait&&!g.isCrashing||I?.obj?.isVehicle()&&I.weapon?.rules.suicide&&I.obj.transportTrait?.units.find(P=>P===g)||this.deathWeapon.fire(P.createTarget(g,g.tile),P)}dispose(){this.gameObject=void 0,this.primaryWeapon=void 0,this.secondaryWeapon=void 0,this.deathWeapon=void 0}},g("ArmedTrait",W)}}}),System.register("game/gameobject/trait/AttackTrait",["util/typeGuard","game/type/ArmorType","game/gameobject/unit/ZoneType","game/gameobject/task/AttackTask","game/SideType","game/gameobject/trait/interface/NotifyTick","game/gameobject/unit/RangeHelper","game/gameobject/trait/interface/NotifyDamage","game/gameobject/task/system/TaskRunner","game/Target","game/gameobject/task/move/MoveTask","game/gameobject/task/system/CallbackTask","game/gameobject/trait/MoveTrait","game/type/MovementZone","game/Coords","game/gameobject/trait/interface/NotifyTeleport","game/type/VhpScan","game/gameobject/unit/LosHelper","game/math/Vector2","game/math/Box2"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g}],execute:function(){var P;(P=ae||g("AttackState",ae={}))[P.Idle=0]="Idle",P[P.CheckRange=1]="CheckRange",P[P.PrepareToFire=2]="PrepareToFire",P[P.FireUp=3]="FireUp",P[P.Firing=4]="Firing",P[P.JustFired=5]="JustFired",ne=class{constructor(g,P){this.disabled=!1,this.attackState=ae.Idle,this.passiveScanCooldownTicks=0,this.taskRunner=new K.TaskRunner,this.distributedFireHistory=new Map,this.rangeHelper=new W.RangeHelper(P),this.losHelper=new te.LosHelper(g,P)}isIdle(){return this.attackState===ae.Idle}isDisabled(){return this.disabled}setDisabled(g){this.disabled=g}isOnCooldown(g){let P=[g.primaryWeapon,g.secondaryWeapon],I=g.armedTrait?.getDeployFireWeapon();return I?.rules.areaFire&&!I.rules.fireOnce&&(P=P.filter(g=>g!==I)),P.some(g=>0<(g?.getCooldownTicks()??0))}expirePassiveScanCooldown(){this.passiveScanCooldownTicks=0}increasePassiveScanCooldown(g){this.passiveScanCooldownTicks+=g}cancelOpportunityFire(){this.opportunityFireTask?.cancel()}getOpportunityFireTask(){return this.opportunityFireTask}selectDefaultWeapon(g){let P;if((g.isInfantry()||g.isVehicle())&&g.rules.deployFire){let I=g.armedTrait?.getDeployFireWeapon();P=g.deployerTrait?.isDeployed()?I&&!I.rules.areaFire?I:void 0:[g.primaryWeapon,g.secondaryWeapon].find(g=>g!==I)}else P=g.isBuilding()&&g.garrisonTrait?g.garrisonTrait.isOccupied()?g.owner.country.side===G.SideType.GDI?g.primaryWeapon:g.secondaryWeapon??g.primaryWeapon:void 0:g.isBuilding()&&g.overpoweredTrait?g.overpoweredTrait.getWeapon():g.primaryWeapon;return P}selectWeaponVersus(g,P,I,L=!1,_=!1){var U=P.tile;const G=P instanceof q.Target?P.obj:P;var V=this.getAvailableWeapons(g,_,G?.isOverlay()||L&&!G);return this.selectWeaponFromList(g,G,U,V,I,L,_,!1)}selectWeaponFromList(g,P,I,L,U,G,V,W){if((!P?.isInfantry()&&!P?.isVehicle()||!P.disguiseTrait||this.canAttackThroughDisguise(g,P,P.disguiseTrait,U,G,V,W))&&(P?.isBuilding()&&P.overpoweredTrait&&P.owner===g.owner&&L.find(g=>g.warhead.rules.electricAssault)&&(L=L.filter(g=>g.warhead.rules.electricAssault)),!(V&&P?.isAircraft()&&P.missileSpawnTrait&&P.zone!==_.ZoneType.Air))){var z=P?.isTechno()?P.rules.armor:void 0;for(const g of L)if(g.targeting.canTarget(P,I,U,G,V)&&(void 0===z||this.checkArmor(g.warhead.rules,z,V)))return g}}getAvailableWeapons(g,P,I){let L;var _;return L=(g.isInfantry()||g.isVehicle())&&g.rules.deployFire&&g.armedTrait?(_=g.armedTrait.getDeployFireWeapon(),[g.deployerTrait?.isDeployed()?_.rules.areaFire?void 0:_:_===g.secondaryWeapon?g.primaryWeapon:g.secondaryWeapon]):g.isBuilding()&&g.garrisonTrait?g.garrisonTrait.isOccupied()?[g.owner.country.side===G.SideType.GDI?g.primaryWeapon:g.secondaryWeapon??g.primaryWeapon]:[]:g.isBuilding()&&g.overpoweredTrait?[g.overpoweredTrait.getWeapon()]:I||P?[g.primaryWeapon,!I&&P&&g.secondaryWeapon?g.secondaryWeapon:void 0]:[g.primaryWeapon,g.secondaryWeapon],L.filter(g=>g&&!g.rules.neverUse)}canAttackThroughDisguise(g,P,I,L,_,U,G){if(!_&&I.hasTerrainDisguise()&&!L.areFriendly(g,P)&&!g.owner.sharedDetectDisguiseTrait?.has(P))return!1;if(U){if(G&&P.moveTrait.isIdle()&&!g.rules.detectDisguise&&!g.owner.sharedDetectDisguiseTrait?.has(P)&&!L.areFriendly(P,g))return!1;var V=I.getDisguise();if(V?.owner&&!g.rules.detectDisguise&&!g.owner.sharedDetectDisguiseTrait?.has(P)&&(V.owner===g.owner||L.alliances.areAllied(g.owner,V.owner)))return!1}return!0}checkArmor(g,P,I){var _=g.ivanBomb||g.bombDisarm||g.nukeMaker?1:g.verses.get(P);return void 0===_?(console.warn(`Unhandled ArmorType ${L.ArmorType[P]} in warhead ${g.name} verses`),!1):!(100*_<=(I?1:0))}createAttackTask(g,P,I,L,_){return new U.AttackTask(g,g.createTarget(P,I),L,_)}[V.NotifyTick.onTick](g,P){if(!this.isDisabled()){if(this.opportunityFireTask&&(!g.unitOrderTrait.hasTasks()||g.isUnit()&&!g.unitOrderTrait.getTasks()[0].preventOpportunityFire||(g.unitOrderTrait.getTasks()[0]instanceof U.AttackTask?this.opportunityFireTask=void 0:this.opportunityFireTask.cancel()),this.opportunityFireTask&&(G=[this.opportunityFireTask],this.taskRunner.tick(G,g),G.length||(this.opportunityFireTask=void 0))),!this.opportunityFireTask&&this.retaliateTarget){var I=this.retaliateTarget;let L;this.retaliateTarget=void 0,!g.unitOrderTrait.hasTasks()&&P.isValidTarget(I)&&(L=this.selectWeaponVersus(g,I,P,!1))&&g.unitOrderTrait.addTask(this.createAttackTask(P,I,I.tile,L,{holdGround:g.rules.movementZone===Z.MovementZone.Fly}))}if(!this.opportunityFireTask&&this.shouldPassiveAcquire(g))if(0<this.passiveScanCooldownTicks)this.passiveScanCooldownTicks--;else{this.passiveScanCooldownTicks=g.guardMode?P.rules.general.guardAreaTargetingDelay:P.rules.general.normalTargetingDelay;let U=this.selectDefaultWeapon(g);var L,_,G=g.unitOrderTrait.hasTasks();let W,z,K;!G&&g.guardMode&&U&&g.owner.isCombatant()&&(W=g.armedTrait?.computeGuardScanRange(U),z=g.guardArea?.tile,K=50);let q=!1;!U||(I=this.scanForTarget(g,U,P,W,z)).target&&(({target:L,weapon:_}=I),L=this.createAttackTask(P,L,L.tile,_,{holdGround:G||!g.guardMode,disallowTurning:G,leashTiles:K,passive:!0}),G?this.opportunityFireTask=L:g.unitOrderTrait.addTask(L),q=!0,G||!g.guardMode||g.guardArea||(g.guardArea={tile:g.tile,onBridge:!!g.isUnit()&&g.onBridge}),q&&!G&&g.unitOrderTrait[V.NotifyTick.onTick](g,P)),q||G||!g.secondaryWeapon?.warhead.rules.electricAssault||(U=g.secondaryWeapon,(_=this.scanForTarget(g,U,P,void 0,void 0,!0)).target&&(({target:L,weapon:_}=_),_=this.createAttackTask(P,L,L.tile,_,{passive:!0}),g.unitOrderTrait.addTask(_),q=!0)),!q&&!G&&g.guardArea&&g.isUnit()&&g.moveTrait&&!g.moveTrait.isDisabled()&&g.guardArea.tile!==g.tile&&g.unitOrderTrait.addTasks(new $.MoveTask(P,g.guardArea.tile,g.guardArea.onBridge),new Q.CallbackTask(()=>{[Y.MoveResult.Success,Y.MoveResult.CloseEnough].includes(g.moveTrait.lastMoveResult)||g.resetGuardModeToIdle(),g.guardArea=void 0}))}}}[z.NotifyDamage.onDamage](g,P,I,L){this.isDisabled()||!this.retaliateTarget&&!this.opportunityFireTask&&L&&L.obj&&L.weapon&&this.shouldRetaliate(g,P,I,L.obj,L.weapon.warhead)&&(this.retaliateTarget=L.obj)}[J.NotifyTeleport.onBeforeTeleport](g,P,I,L){L||(this.attackState=ae.Idle,this.currentTarget=void 0,this.retaliateTarget=void 0,this.opportunityFireTask=void 0)}shouldPassiveAcquire(g){if(!g.owner.isCombatant()&&g.rules.needsEngineer||!g.rules.canPassiveAquire||!g.primaryWeapon||g.ammoTrait&&!g.ammoTrait.ammo&&g.rules.manualReload)return!1;if(g.mindControllerTrait?.isAtCapacity())return!1;var P=g.rules.opportunityFire||g.rules.balloonHover&&g.unitOrderTrait.getCurrentTask()?.isAttackMove;if(g.isUnit()&&P){if(g.unitOrderTrait.hasTasks()&&g.unitOrderTrait.getTasks()[0].preventOpportunityFire)return!1}else if(g.unitOrderTrait.hasTasks())return!1;return!0}shouldRetaliate(g,P,I,L,_){if(I<1||P.areFriendly(g,L)||!g.rules.canRetaliate||!g.primaryWeapon||g.ammoTrait&&!g.ammoTrait.ammo&&g.rules.manualReload||_.rules.temporal||L.rules.missileSpawn||g.unitOrderTrait.hasTasks()||!P.isValidTarget(L)||(L.isInfantry()||L.isVehicle())&&L.disguiseTrait&&!g.rules.detectDisguise||g.mindControllerTrait?.isAtCapacity())return!1;var U=this.selectWeaponVersus(g,L,P,!1);return!(!U||(g.isBuilding()||L.isBuilding()?this.rangeHelper.tileDistance(g,L):this.rangeHelper.distance2(g,L)/X.Coords.LEPTONS_PER_TILE)>Math.max(U.range,g.sight))}scanForTarget(g,P,I,L,_,U=!1){let G={},V=Number.NEGATIVE_INFINITY;var W=this.getAvailableWeapons(g,!0,!1),z=L??(g.rules.guardRange||P.range)+1+3+I.rules.elevationModel.bonusCap+(P.projectileRules.isAntiAir?g.rules.airRangeBonus:0);for(const P of this.scanTechnosAround(g,z,I)){var K,q=this.selectWeaponFromList(g,P,P.tile,W,I,!1,!0,!0);q&&this.canPassiveAcquire(P,I)&&I.isValidTarget(P)&&(L?this.rangeHelper.isInRange(g,P,q.minRange,L,q.rules.cellRangefinding)&&(!_||this.rangeHelper.isInRange2(_,P,0,L)):this.rangeHelper.isInWeaponRange(g,P,q,I.rules))&&(U||this.losHelper.hasLineOfSight(g,P,q))&&(K=this.rangeHelper.distance3(g,P)/X.Coords.LEPTONS_PER_TILE,(K=this.computeThreat(P,g,q,K,I.rules.general.threat))>V&&(G={target:P,weapon:q},V=K))}return G.target&&g.rules.distributedFire&&this.updateDistributedFireHistory(G),G}scanTechnosAround(g,P,I){var L=g.getFoundation();const _=new re.Vector2(g.tile.rx,g.tile.ry),U=new re.Vector2(g.tile.rx+L.width-1,g.tile.ry+L.height-1);return _.addScalar(-P),U.addScalar(P),L=new se.Box2(_,U),I.map.technosByTile.queryRange(L)}canPassiveAcquire(g,P){return!g.owner.isNeutral&&!g.rules.civilian&&(!g.rules.insignificant||g.isBuilding()&&g.garrisonTrait?.isOccupied())&&(1<g.rules.threatPosed||g.isBuilding()&&g.garrisonTrait?.isOccupied()||0<g.rules.specialThreatValue&&!g.isBuilding()||g.rules.harvester||g.name===P.rules.general.paradrop.paradropPlane)}computeThreat(g,P,L,_,U){var G;let V=[g.primaryWeapon,g.secondaryWeapon].filter(I.isNotNullOrUndefined).map(g=>g.warhead.rules.verses.get(P.rules.armor)??0).reduce((g,P)=>Math.max(g,P),0)*U.targetEffectivenessCoefficientDefault;return g.attackTrait?.currentTarget?.obj===P&&(V*=-1),V+=g.rules.specialThreatValue*U.targetSpecialThreatCoefficientDefault,V+=(L.warhead.rules.verses.get(g.rules.armor)??0)*U.myEffectivenessCoefficientDefault,V+=g.healthTrait.health/100*U.targetStrengthCoefficientDefault,V+=_*U.targetDistanceCoefficientDefault,V+=1e5,P.rules.vhpScan!==ee.VhpScan.None&&(G=g.healthTrait.getProjectedHitPoints(),P.rules.vhpScan===ee.VhpScan.Strong?G<=0&&(V=Number.NEGATIVE_INFINITY):P.rules.vhpScan===ee.VhpScan.Normal&&(G<=0?V/=2:G<=g.healthTrait.maxHitPoints/2&&(V*=2))),P.rules.distributedFire&&(V-=1e6*(this.distributedFireHistory.get(g)??0)),V}updateDistributedFireHistory(g){if(50!==this.distributedFireHistory.get(g.target)){for(var[P,I]of this.distributedFireHistory)--I<=0?this.distributedFireHistory.delete(P):this.distributedFireHistory.set(P,I);this.distributedFireHistory.set(g.target,50)}}dispose(){this.distributedFireHistory.clear()}},g("AttackTrait",ne)}}}),System.register("game/gameobject/trait/AutoRepairTrait",["game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyOwnerChange","game/GameSpeed"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class{constructor(g=!1){this.freeRepair=g,this.disabled=!0,this.cooldownTicks=0,this.healLeftover=0}isDisabled(){return this.disabled}setDisabled(g){this.disabled=g}[I.NotifyTick.onTick](g,P){if(!this.isDisabled())if(100===g.healthTrait.health&&this.setDisabled(!0),this.cooldownTicks<=0){var I=P.rules.general.repair,L=g.isInfantry()?I.iRepairRate:g.isBuilding()?I.repairRate:I.uRepairRate;this.cooldownTicks+=_.GameSpeed.BASE_TICKS_PER_SECOND*L*60;var U=g.isInfantry()?I.iRepairStep:I.repairStep;let G;(L=this.freeRepair?0:I.repairPercent)?(I=L*g.purchaseValue/g.healthTrait.maxHitPoints,(L=Math.min(g.owner.credits,Math.max(1,Math.floor(I*U))))?(G=I?L/I:U,g.owner.credits-=L):(G=0,this.setDisabled(!0))):G=U,G&&(G+=this.healLeftover,G=Math.min(g.healthTrait.maxHitPoints-g.healthTrait.getHitPoints(),G),G&&(U=Math.floor(G),this.healLeftover=G-U,U&&g.healthTrait.healBy(U,g,P)))}else this.cooldownTicks--}[L.NotifyOwnerChange.onChange](){this.setDisabled(!0)}},g("AutoRepairTrait",U)}}}),System.register("game/gameobject/trait/BridgeTrait",["game/gameobject/trait/interface/NotifyDamage","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/infantry/InfDeathType","game/type/LandType","game/gameobject/unit/ZoneType","game/gameobject/infantry/StanceType"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g}],execute:function(){z=class u{constructor(g){this.bridges=g,this.needsImageUpdate=!1,this.dominoHandled=!1}[I.NotifyDamage.onDamage](){this.needsImageUpdate=!0}[L.NotifyTick.onTick](g){this.needsImageUpdate&&(this.needsImageUpdate=!1,this.bridges.handlePieceHealthChange(this.bridges.getPieceAtTile(g.tile)))}[_.NotifyDestroy.onDestroy](g,P,I){var L=this.bridges.getPieceAtTile(g.tile);this.dominoHandled||this.bridges.findDominoPieces(L).filter(g=>!g.obj.isDestroyed).forEach(g=>{g.obj.traits.get(u).dominoHandled=!0,P.destroyObject(g.obj,I)}),P.map.tileOccupation.calculateTilesForGameObject(g.tile,g).forEach(L=>{let _=G.getLandType(L.terrainType),z=P.rules.getLandRules(_);P.map.getGroundObjectsOnTile(L).forEach(L=>{if(L.isUnit()&&(L.onBridge||L.moveTrait.reservedPathNodes.some(P=>P.onBridge===g))&&!L.isDestroyed)if(g.isLowBridge()&&0<z.getSpeedModifier(L.rules.speedType)||L.isInfantry()&&L.stance===W.StanceType.Paradrop){for(var G of(L.onBridge&&(L.onBridge=!1,L.zone=V.getZoneType(_)),L.moveTrait.reservedPathNodes))G.onBridge===g&&(G.onBridge=void 0);L.moveTrait.currentWaypoint?.onBridge===g&&(L.moveTrait.currentWaypoint.onBridge=void 0)}else L.isInfantry()&&(L.infDeathType=U.InfDeathType.None),P.destroyObject(L,I,!0)})})}},g("BridgeTrait",z)}}}),System.register("game/gameobject/trait/C4ChargeTrait",["game/gameobject/common/DeathType","game/gameobject/unit/Timer","game/gameobject/trait/interface/NotifyTick"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class{constructor(){this.timer=new L.Timer}hasCharge(){return this.timer.isActive()}setCharge(g,P){this.hasCharge()||(this.timer.setActiveFor(g),this.attackerInfo=P)}[_.NotifyTick.onTick](g,P){this.timer.isActive()&&!0===this.timer.tick(P.currentTick)&&(g.invulnerableTrait.isActive()||(g.isBuilding()&&g.cabHutTrait?g.cabHutTrait.demolishBridge(P,this.attackerInfo):(g.deathType=I.DeathType.Demolish,P.destroyObject(g,this.attackerInfo,!0))))}},g("C4ChargeTrait",U)}}}),System.register("game/gameobject/trait/CabHutTrait",["engine/type/ObjectType","game/map/BridgeOverlayTypes","game/gameobject/task/ScatterTask","game/gameobject/unit/ZoneType","game/gameobject/common/DeathType"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){g("CabHutTrait",class{constructor(g,P){this.gameObject=g,this.bridges=P,this.checkedClosestBridge=!1}canRepairBridge(){var g=this.findClosestBridgeBounds();return g?this.bridges.canBeRepaired(g):(console.warn(`No bridge associated with hut at ${this.gameObject.tile.rx}, ${this.gameObject.tile.ry}.`),!1)}repairBridge(g,P){var _=this.findClosestBridgeBounds();if(!_)throw new Error("No bridge bounds found");var U=this.bridges.findDestroyedPieceTiles(_),G=_.start.rx!==_.end.rx;let V;V=_.isHigh?L.BridgeOverlayTypes.calculateHighBridgeOverlayId(_.type,G):L.BridgeOverlayTypes.calculateLowBridgeOverlayId(_.type,G);var W,z,K=g.rules.getOverlayName(V);for(W of U){let L=g.createObject(I.ObjectType.Overlay,K);L.overlayId=V,L.value=0,L.position.tileElevation=_.isHigh?4:0,g.spawnObject(L,W),this.updateUnitsUnderBridgePiece(W,_,g,P)}for(z of this.bridges.findBridgePieces(_))z.obj.bridgeTrait.bridgeSpec=_}updateUnitsUnderBridgePiece(g,P,I,L){var G;for(let V of this.bridges.getPieceTiles(this.bridges.getPieceAtTile(g)))if(P.isHigh){I.map.getGroundObjectsOnTile(V).filter(g=>g.tile===V&&g.isUnit()&&!g.unitOrderTrait.hasTasks()&&g.rules.tooBigToFitUnderBridge).forEach(g=>g.unitOrderTrait.addTask(new _.ScatterTask(I)))}else for(G of I.map.getGroundObjectsOnTile(V))G.isUnit()&&(I.map.terrain.getPassableSpeed(V,G.rules.speedType,G.isInfantry(),!0)?(G.zone=U.ZoneType.Ground,G.onBridge=!0):G.isDestroyed||I.destroyObject(G,{player:L}))}demolishBridge(g,P){var I=this.getBridgePieces();if(I)for(var L of I)L.obj.isLowBridge()&&g.map.getTileZone(L.obj.tile,!0)!==U.ZoneType.Water||L.obj.isDestroyed||(L.obj.deathType=G.DeathType.Demolish,g.destroyObject(L.obj,P,!0))}getBridgePieces(){var g=this.findClosestBridgeBounds();if(g)return this.bridges.findBridgePieces(g)}findClosestBridgeBounds(){return this.checkedClosestBridge||(this.checkedClosestBridge=!0,this.closestBridge=this.bridges.findClosestBridgeSpec(this.gameObject.tile)),this.closestBridge}dispose(){this.gameObject=void 0}})}}}),System.register("game/gameobject/trait/CloakableTrait",["game/event/ObjectCloakChangeEvent","game/GameSpeed","game/gameobject/trait/interface/NotifyDamage","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyTick"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){V=class{constructor(g,P){this.gameObject=g,this.cloakDelayMinutes=P,this.isActive=!1,this.resetCloakCooldown()}isCloaked(){return this.isActive}uncloak(g){var P=this.isActive;this.resetCloakCooldown(),P&&(this.isActive=!1,g.events.dispatch(new I.ObjectCloakChangeEvent(this.gameObject)))}resetCloakCooldown(){this.cooldownTicks=Math.floor(60*this.cloakDelayMinutes*L.GameSpeed.BASE_TICKS_PER_SECOND)}[U.NotifySpawn.onSpawn](g,P){this.resetCloakCooldown()}[G.NotifyTick.onTick](g,P){0<this.cooldownTicks&&this.cooldownTicks--,!(this.cooldownTicks<=0)||this.isActive||g.isVehicle()&&g.submergibleTrait&&!g.submergibleTrait.isSubmerged()||g.temporalTrait.getTarget()||(this.isActive=!0,P.events.dispatch(new I.ObjectCloakChangeEvent(this.gameObject)))}[_.NotifyDamage.onDamage](g,P){this.uncloak(P)}dispose(){this.gameObject=void 0}},g("CloakableTrait",V)}}}),System.register("game/gameobject/trait/CrashableTrait",["game/event/ObjectCrashingEvent","game/type/LocomotorType","game/gameobject/trait/interface/NotifyTick","game/gameobject/locomotor/JumpjetLocomotor","game/gameobject/locomotor/WingedLocomotor","game/gameobject/trait/interface/NotifyCrash"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){W=class{constructor(g){this.gameObject=g,this.crashingEvtSent=!1,this.crashState={}}[_.NotifyTick.onTick](g,P){if(g.isCrashing){if(this.crashingEvtSent||(this.crashingEvtSent=!0,g.traits.filter(V.NotifyCrash).forEach(I=>I[V.NotifyCrash.onCrash](g,P)),P.events.dispatch(new I.ObjectCrashingEvent(g))),g.rules.locomotor!==L.LocomotorType.Jumpjet&&g.rules.locomotor!==L.LocomotorType.Aircraft)throw new Error("Crashing logic not implemented for locomotor "+L.LocomotorType[g.rules.locomotor]);{let I;if(g.rules.locomotor===L.LocomotorType.Jumpjet)I=U.JumpjetLocomotor.tickCrash(g,P,this.crashState);else{if(g.rules.locomotor!==L.LocomotorType.Aircraft)throw new Error(`Unhandled locomotor type "${g.rules.locomotor}"`);if(!g.isAircraft())throw new Error(`Obj "${g.name}#${g.id} is not an aircraft`);I=G.WingedLocomotor.tickCrash(g,P,this.crashState)}let V=!1;var _,W,z=I.clone().add(g.position.worldPosition);P.map.isWithinHardBounds(z)?(W=g.tile,_=g.tileElevation,g.position.moveByLeptons3(I),g.tile!==W&&g.moveTrait.handleTileChange(W,void 0,!1,P),W=(z=g.tile.onBridgeLandType?P.map.tileOccupation.getBridgeOnTile(g.tile):void 0)?.tileElevation??0,g.position.tileElevation=Math.max(g.position.tileElevation,W),g.position.tileElevation===W&&(g.zone=P.map.getTileZone(g.tile),g.onBridge=!!z,V=!0),g.tileElevation!==_&&g.moveTrait.handleElevationChange(_,P)):V=!0,V&&P.destroyObject(g,this.attackerInfo)}}}crash(g){this.attackerInfo=g,this.gameObject.isCrashing=!0,this.gameObject.cachedTraits.tick.length=0,this.gameObject.cachedTraits.tick=[this]}dispose(){this.gameObject=void 0}},g("CrashableTrait",W)}}}),System.register("game/gameobject/trait/CrewedTrait",["game/gameobject/trait/interface/NotifySell","game/gameobject/trait/interface/NotifyDestroy","game/SideType","engine/type/ObjectType","game/gameobject/task/ScatterTask","game/gameobject/Infantry","game/gameobject/unit/VeteranLevel"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g}],execute:function(){z=class{[I.NotifySell.onSell](g,P){this.spawnSurvivors(g,P)}[L.NotifyDestroy.onDestroy](g,P,I,L){L||I?.obj===g&&I.weapon?.rules.suicide||g.isVehicle()&&g.moveTrait.isMoving()||g.crashableTrait||this.spawnSurvivors(g,P)}spawnSurvivors(g,P){var I=P.rules.general.crew,L=g.owner.country.side;let z,K;if(L===_.SideType.GDI)z=I.alliedSurvivorDivisor,K=I.alliedCrew;else if(L===_.SideType.Nod)z=I.sovietSurvivorDivisor,K=I.sovietCrew;else{if(L!==_.SideType.ThirdSide)return;z=I.thirdSurvivorDivisor,K=I.thirdCrew}let q=P.sellTrait.computeRefundValue(g)/z;q=0<q&&q<1?1:Math.floor(q),q=g.isVehicle()?Math.min(1,q):Math.min(5,q);let $=[];for(let g=0;g<q;g++)$.push(K);if(0<$.length){g.rules.constructionYard&&($[$.length-1]=P.rules.general.engineer);var Q,Y=P.map.tiles.getInRectangle(g.tile,g.getFoundation()).filter(g=>P.map.isWithinBounds(g));let I=[...Y];for(Q of $){var Z=P.rules.getObject(Q,U.ObjectType.Infantry);if(P.map.terrain.getPassableSpeed(g.tile,Z.speedType,!0,!g.isBuilding()&&g.onBridge,void 0,!0)){let L=P.createUnitForPlayer(Z,g.owner),_=I.length?I.splice(P.generateRandomInt(0,I.length-1),1)[0]:void 0;_=_||Y[P.generateRandomInt(0,Y.length-1)],L.isInfantry()&&(L.position.subCell=V.Infantry.SUB_CELLS[0]),L.veteranTrait&&g.owner.canProduceVeteran(L.rules)&&L.veteranTrait.setVeteranLevel(W.VeteranLevel.Veteran),P.spawnObject(L,_),g.isBuilding()&&L.unitOrderTrait.addTask(new G.ScatterTask(P,void 0,{ignoredBlockers:g.isDestroyed?void 0:[g]}))}}}}},g("CrewedTrait",z)}}}),System.register("game/gameobject/trait/DelayedKillTrait",["game/gameobject/unit/Timer","game/gameobject/trait/interface/NotifyTick"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class{constructor(){this.timer=new I.Timer}isActive(){return this.timer.isActive()}activate(g,P){this.isActive()||(this.timer.setActiveFor(g),this.attackerInfo=P)}[L.NotifyTick.onTick](g,P){this.timer.isActive()&&!0===this.timer.tick(P.currentTick)&&(g.invulnerableTrait.isActive()||g.isBuilding()&&g.cabHutTrait||P.destroyObject(g,this.attackerInfo,!0,!0))}},g("DelayedKillTrait",_)}}}),System.register("game/gameobject/trait/DeployerTrait",["game/gameobject/infantry/StanceType","game/gameobject/trait/interface/NotifyTick"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){var P;(P=_=_||{})[P.None=0]="None",P[P.PreparingToFire=1]="PreparingToFire",P[P.FiringUp=2]="FiringUp",P[P.Firing=3]="Firing",U=class{constructor(g){this.gameObject=g,this.deployed=!1,this.deployFireDelay=0,this.deployFireState=_.None,this.fireUpDelay=0,this.deployFireCount=0}isDeployed(){return this.deployed}setDeployed(g){var P=this.deployed;if((this.deployed=g)!==P){let L=this.gameObject;L.isInfantry()&&(L.stance=g?I.StanceType.Deployed:I.StanceType.None),g?(this.deployFireState=_.PreparingToFire,P=this.gameObject.armedTrait?.getDeployFireWeapon(),this.deployWeapon=P?.rules.areaFire?P:void 0,this.deployFireDelay=15+((P===L.primaryWeapon?L.secondaryWeapon:L.primaryWeapon)?.getCooldownTicks()??0),this.deployFireCount=0,this.undeployDelay=this.gameObject.rules.undeployDelay||void 0):(this.deployFireState===_.FiringUp&&(L.isFiring=!1),this.deployFireState=_.None,this.deployWeapon=void 0)}}toggleDeployed(){this.setDeployed(!this.isDeployed())}[L.NotifyTick.onTick](g,P){if(void 0!==this.undeployDelay&&(0<this.undeployDelay&&this.undeployDelay--,this.undeployDelay<=0&&[_.None,_.PreparingToFire].includes(this.deployFireState)))return this.undeployDelay=void 0,void this.setDeployed(!1);if(this.deployWeapon&&this.deployFireState!==_.None){if(this.deployFireState===_.PreparingToFire){if(0<this.deployFireDelay--||0===g.ammo)return;if(0<this.computeDeployFireCooldown(this.deployWeapon,P))return;this.fireUpDelay=Math.max(1,g.art.fireUp),this.deployFireState=_.FiringUp}if(this.deployFireState===_.FiringUp){if(g.isFiring=!0,0<this.fireUpDelay--)return;this.deployFireState=_.Firing}var I;this.deployFireState===_.Firing&&(g.isFiring=!1,I=g.onBridge?P.map.tileOccupation.getBridgeOnTile(g.tile):void 0,this.deployWeapon.fire(P.createTarget(I,g.tile),P),this.deployFireCount++,(this.deployWeapon===g.primaryWeapon?g.secondaryWeapon:g.primaryWeapon)?.resetCooldown(),this.deployWeapon.rules.fireOnce?(this.deployFireState=_.None,this.deployWeapon=void 0):this.deployFireState=_.PreparingToFire)}}computeDeployFireCooldown(g,P){if(g.rules.radLevel&&g.rules.areaFire){var I=this.gameObject.tile,L=P.mapRadiationTrait.getRadSiteLevel(I);if(!L)return 0;I=P.rules.radiation;let _=Math.max(0,L*I.radDurationMultiple-I.radLevelDelay);return 1===this.deployFireCount&&(I=I.radDurationMultiple*g.rules.radLevel,_=Math.max(0,_-Math.floor(.25*I))),_}return g.getCooldownTicks()}getHash(){return this.deployed?1:0}debugGetState(){return{deployed:this.deployed}}dispose(){this.gameObject=void 0}},g("DeployerTrait",U)}}}),System.register("game/gameobject/trait/DisguiseTrait",["engine/type/ObjectType","game/event/ObjectDisguiseChangeEvent","game/SideType","game/gameobject/trait/AttackTrait","game/gameobject/trait/interface/NotifyDamage","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/MoveTrait"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g}],execute:function(){K=class{constructor(){this.isActive=!1,this.cooldownTicks=0}isDisguised(){return this.isActive}getDisguise(){return this.isActive?this.disguisedAs:void 0}hasTerrainDisguise(){return this.getDisguise()?.rules.type===I.ObjectType.Terrain}disguiseAs(g,P,I){this.disguisedAs={rules:g.rules,owner:g.owner},this.isActive=!0,I.events.dispatch(new L.ObjectDisguiseChangeEvent(P))}revealDisguise(g,P){this.cooldownTicks=P.rules.general.infantryBlinkDisguiseTime,this.isActive=!1,P.events.dispatch(new L.ObjectDisguiseChangeEvent(g))}[V.NotifySpawn.onSpawn](g,P){var L;!this.disguisedAs&&g.rules.permaDisguise&&g.isInfantry()&&g.owner.country&&(L=this.getDefaultInfantryDisguise(g.owner.country.side,P.rules.general))&&(L=P.rules.getObject(L,I.ObjectType.Infantry),this.disguisedAs={rules:L,owner:g.owner},this.isActive=!0)}getDefaultInfantryDisguise(g,P){switch(g){case _.SideType.GDI:return P.alliedDisguise;case _.SideType.Nod:return P.sovietDisguise;case _.SideType.ThirdSide:return P.thirdDisguise;default:return}}[W.NotifyTick.onTick](g,P){g.rules.permaDisguise||(g.attackTrait?.attackState===U.AttackState.JustFired||g.moveTrait.moveState!==z.MoveState.Idle?this.revealDisguise(g,P):0<this.cooldownTicks?this.cooldownTicks--:!this.isActive&&g.rules.disguiseWhenStill&&(this.isActive=!0,this.disguisedAs={rules:this.selectRandomMirageDisguise(P),owner:void 0},P.events.dispatch(new L.ObjectDisguiseChangeEvent(g))))}[G.NotifyDamage.onDamage](g,P){this.revealDisguise(g,P)}selectRandomMirageDisguise(g){var P=g.rules.general.defaultMirageDisguises;if(!P.length)throw new Error("No default mirage disguises are defined");return P=P[g.generateRandomInt(0,P.length-1)],g.rules.getObject(P,I.ObjectType.Terrain)}},g("DisguiseTrait",K)}}}),System.register("game/gameobject/trait/DockableTrait",["game/gameobject/trait/interface/NotifyUnspawn","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifyTeleport"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class{[I.NotifyUnspawn.onUnspawn](g){this.undock(g),this.reservedDock?.dockTrait.unreserveDockForUnit(g)}[L.NotifyOwnerChange.onChange](g){g.owner!==this.dock?.owner&&this.undock(g),g.owner!==this.reservedDock?.owner&&this.reservedDock?.dockTrait.unreserveDockForUnit(g)}[_.NotifyTeleport.onBeforeTeleport](g,P,I,L){L||this.undock(g)}undock(g){this.dock&&!this.dock.isDisposed&&this.dock.dockTrait.undockUnit(g)}dispose(){this.dock=void 0,this.reservedDock=void 0}},g("DockableTrait",U)}}}),System.register("game/gameobject/trait/DockTrait",["game/gameobject/trait/interface/NotifyDestroy","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifySell","game/gameobject/trait/DockableTrait","game/Coords","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifySpawn","util/typeGuard","game/gameobject/task/MoveToDockTask","game/gameobject/task/move/MoveTask","game/gameobject/task/system/CallbackTask","game/gameobject/task/system/TaskGroup","game/gameobject/trait/interface/NotifyUnspawn"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g}],execute:function(){Z=class{constructor(g,P,I,L){this.building=g,this.tiles=P,this.numberOfDocks=I,this.dockingOffsets=L,this.ticksWhenWarpedOut=!0,this.unitsByDockNumber=new Array(I).fill(void 0),this.reservedDocks=new Array(I).fill(void 0)}[W.NotifySpawn.onSpawn](){this.dockTiles=[];for(let P=0;P<this.numberOfDocks;P++){var g=this.findDockTile(P);if(!g)throw new Error(`Docking tile ${P} not found for object "${this.building.name}"`);this.dockTiles[P]=g}}[Y.NotifyUnspawn.onUnspawn](){for(let g=0;g<this.numberOfDocks;g++)this.unreserveDockAt(g)}[V.NotifyTick.onTick](){for(let P=0;P<this.numberOfDocks;P++){var g=this.unitsByDockNumber[P];g&&g.tile!==this.getDockTile(P)&&this.undockUnit(g)}}[I.NotifyDestroy.onDestroy](g,P,I,L){var _=(g.rules.unitRepair||g.helipadTrait)&&!g.rules.naval&&!I?.weapon?.warhead.rules.temporal;if(_)for(var U of this.unitsByDockNumber)U&&!U.isDestroyed&&(_?P.destroyObject(U,I,L):this.undockUnit(U))}[_.NotifySell.onSell](g,P){if(g.helipadTrait&&this.hasDockedUnits()){var I,L,_;let U=[],G=0;for(I of[...g.owner.buildings].filter(P=>P.helipadTrait&&(P.dockTrait?.getAvailableDockCount()??!1)&&P!==g)){let g=I.dockTrait?.getAvailableDockCount()??0;for(;0<g&&G<this.unitsByDockNumber.length;)U.push(I),g--,G++;if(G===this.unitsByDockNumber.length)break}for(L of(G=0,this.unitsByDockNumber))L&&((_=U[G])?L.unitOrderTrait.addTask(new K.MoveToDockTask(P,_)):L.unitOrderTrait.addTask(new Q.TaskGroup(new q.MoveTask(P,L.tile,!1),new $.CallbackTask(I=>{I.crashableTrait?I.crashableTrait.crash({player:g.owner}):P.destroyObject(I,{player:g.owner})})).setCancellable(!1))),G++}else{var U,G=g.rules.unitRepair&&!g.rules.naval;for(U of this.unitsByDockNumber)U&&(G?P.sellTrait.sell(U):this.undockUnit(U))}}[L.NotifyOwnerChange.onChange](g,P,I){for(var L of this.unitsByDockNumber)L&&I.changeObjectOwner(L,g.owner)}getFirstAvailableDockNumber(){if(!this.building?.warpedOutTrait.isActive()){var g=this.unitsByDockNumber.findIndex((g,P)=>!g&&!this.reservedDocks[P]);if(-1!==g)return g}}getAvailableDockCount(){return this.building?.warpedOutTrait.isActive()?0:this.unitsByDockNumber.filter((g,P)=>!g&&!this.reservedDocks[P]).length}getFirstEmptyDockNumber(){if(!this.building?.warpedOutTrait.isActive()){var g=this.unitsByDockNumber.findIndex(g=>!g);if(-1!==g)return g}}getDockOffset(g){if(g>this.numberOfDocks-1)throw new RangeError(`Index ${g} exceeds available docks (${this.numberOfDocks})`);return this.dockingOffsets[g]}getDockTile(g){if(g>this.numberOfDocks-1)throw new RangeError(`Index ${g} exceeds available docks (${this.numberOfDocks})`);return this.dockTiles[g]}getDockNumberByTile(g){var P=this.dockTiles.indexOf(g);if(-1!==P)return P}getAllDockTiles(){return[...this.dockTiles]}findDockTile(g){if(g>this.numberOfDocks-1)throw new RangeError(`Index ${g} exceeds available docks (${this.numberOfDocks})`);var P=this.building.position.getMapPosition(),I=this.getDockOffset(g);return this.tiles.getByMapCoords(Math.floor((P.x+I.x)/G.Coords.LEPTONS_PER_TILE),Math.floor((P.y+I.z)/G.Coords.LEPTONS_PER_TILE))}isValidUnitForDock(g){return(this.building.unitRepairTrait&&g.isVehicle()&&!this.building.helipadTrait&&(!g.rules.consideredAircraft||g.rules.landable)||g.rules.dock.includes(this.building.name)&&!(g.isAircraft()&&!this.building.helipadTrait))&&this.building.rules.naval===g.rules.naval}dockUnitAt(g,P){if(P>this.numberOfDocks-1)throw new RangeError(`Index ${P} exceeds available docks (${this.numberOfDocks})`);if(this.unitsByDockNumber[P])throw new Error("Another unit is already docked at dock #"+P);let I=g.traits.find(U.DockableTrait);if(!I)throw new Error(`Unit "${g.name}" cannot be docked to `+this.building.name);this.unitsByDockNumber[P]=g,I.dock=this.building}undockUnitAt(g){if(g>this.numberOfDocks-1)throw new RangeError(`Index ${g} exceeds available docks (${this.numberOfDocks})`);let P=this.unitsByDockNumber[g];P&&(this.unitsByDockNumber[g]=void 0,P.traits.get(U.DockableTrait).dock=void 0)}undockUnit(g){var P=this.unitsByDockNumber.indexOf(g);-1!==P&&this.undockUnitAt(P)}isDocked(g){return this.unitsByDockNumber.includes(g)}hasDockedUnits(){return!!this.unitsByDockNumber.find(g=>g)}getDockedUnits(){return this.unitsByDockNumber.filter(z.isNotNullOrUndefined)}reserveDockAt(g,P){if(P>this.numberOfDocks-1)throw new RangeError(`Index ${P} exceeds available docks (${this.numberOfDocks})`);if(this.reservedDocks[P])throw new Error(`Dock #${P} is already reserved by `+this.reservedDocks[P].name);(this.reservedDocks[P]=g).traits.get(U.DockableTrait).reservedDock?.dockTrait.unreserveDockForUnit(g),g.traits.get(U.DockableTrait).reservedDock=this.building}unreserveDockAt(g){if(g>this.numberOfDocks-1)throw new RangeError(`Index ${g} exceeds available docks (${this.numberOfDocks})`);let P=this.reservedDocks[g];P&&(this.reservedDocks[g]=void 0,P.traits.get(U.DockableTrait).reservedDock=void 0)}unreserveDockForUnit(g){var P=this.reservedDocks.indexOf(g);-1!==P&&this.unreserveDockAt(P)}hasReservedDockForUnit(g){return!!this.reservedDocks.includes(g)}hasReservedDockAt(g){return!!this.reservedDocks[g]}getReservedDockForUnit(g){var P=this.reservedDocks.indexOf(g);if(-1!==P)return P}dispose(){this.building=void 0}},g("DockTrait",Z)}}}),System.register("game/gameobject/trait/FactoryTrait",["game/gameobject/Building","game/gameobject/trait/interface/NotifyTick","game/player/production/ProductionQueue","game/rules/TechnoRules","game/gameobject/task/move/ExitFactoryTask","engine/type/TerrainType","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/MoveTrait","game/map/tileFinder/CardinalTileFinder","game/gameobject/trait/DockTrait","game/event/FactoryProduceUnitEvent","game/gameobject/Infantry","game/map/TileOccupation","game/gameobject/task/move/MoveTask","game/map/tileFinder/RadialTileFinder","game/gameobject/trait/interface/NotifyWarpChange","game/gameobject/unit/VeteranLevel","game/trait/interface/NotifyProduceUnit","game/math/Vector2","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/unit/ZoneType","game/gameobject/task/system/WaitMinutesTask","game/gameobject/task/system/CallbackTask","game/gameobject/task/system/TaskGroup","game/gameobject/common/DeathType"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce,he,ue,de;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g},function(g){ce=g},function(g){he=g}],execute:function(){var P;(P=ue||g("FactoryStatus",ue={}))[P.Idle=0]="Idle",P[P.Delivering=1]="Delivering",de=class{constructor(g,P=!1){this.type=g,this.isCloningVats=P,this.status=ue.Idle}[W.NotifySpawn.onSpawn](g,P){this.resetRallyPoint(g,P)}resetRallyPoint(g,P){var I;[U.FactoryType.BuildingType,U.FactoryType.AircraftType].includes(this.type)||(I=this.computeDefaultRallyPoint(g,this.type,P.map),g.rallyTrait?.changeRallyPoint(I,g,P))}[J.NotifyWarpChange.onChange](g,P,I){if(g.owner.production){let P=[];for(var L of(P=this.type===U.FactoryType.BuildingType?[_.QueueType.Structures,_.QueueType.Armory]:[g.owner.production.getQueueTypeForFactory(this.type)],P))g.owner.production.getQueue(L).notifyUpdated()}}[se.NotifyOwnerChange.onChange](g,P,I){this.status===ue.Delivering&&g.rules.deployTime&&this.deliveringUnit&&!this.deliveringUnit.isDestroyed&&this.unitIsInsideFactory(this.deliveringUnit,g,I)&&I.changeObjectOwner(this.deliveringUnit,g.owner)}[ae.NotifyDestroy.onDestroy](g,P,I,L){this.status===ue.Delivering&&g.rules.deployTime&&this.deliveringUnit&&!this.deliveringUnit.isDestroyed&&g.deathType!==he.DeathType.Temporal&&this.unitIsInsideFactory(this.deliveringUnit,g,P)&&P.destroyObject(this.deliveringUnit,I,L)}[L.NotifyTick.onTick](g,P){if(this.status===ue.Delivering){if(!this.deliveringUnit||this.deliveringUnit.isDestroyed){if(this.buildingProductionTicks=this.buildingProductionTicks??1,0<this.buildingProductionTicks--)return;this.buildingProductionTicks=void 0}else if(!this.unitHasClearedFactory(this.deliveringUnit,g,P))return;return this.status=ue.Idle,void(this.deliveringUnit=void 0)}if(g.owner.production&&!g.warpedOutTrait.isActive()){let G=g.owner.production.getPrimaryFactory(this.type);if((G?.warpedOutTrait.isActive()||G===g||G?.factoryTrait?.deliveringUnit&&G.factoryTrait.type===U.FactoryType.UnitType)&&this.type!==U.FactoryType.BuildingType){let G=g.owner.production.getQueueForFactory(this.type);if(G&&G.status===_.QueueStatus.Ready){let V=G.getFirst();if(this.type===U.FactoryType.AircraftType){let L=this.produceAircraftAt(g,V,P);var I;if(!L)for(I of[...g.owner.buildings].filter(g=>g.factoryTrait?.type===U.FactoryType.AircraftType&&g.helipadTrait)){if(L)break;L=this.produceAircraftAt(I,V,P)}if(!L)return}else{var L;if(this.produceGroundUnitAt(g,V,P),!this.isCloningVats&&this.type===U.FactoryType.InfantryType)for(L of[...g.owner.buildings].filter(g=>g.factoryTrait&&g.rules.cloning))L.factoryTrait.status===ue.Idle&&L.factoryTrait.produceGroundUnitAt(L,V,P)}g.owner.addUnitsBuilt(V.rules,1),V.creditsSpent=0,V.progress=0,G.shift(V.rules,1),G.currentSize&&(G.status=_.QueueStatus.Active)}}}}unitIsInsideFactory(g,P,I){return I.map.tileOccupation.isTileOccupiedBy(g.tile,P)&&g.zone!==ne.ZoneType.Air}unitHasClearedFactory(g,P,I){return!I.map.tileOccupation.isTileOccupiedBy(g.tile,P)||g.rules.consideredAircraft&&g.position.tileElevation>=P.art.height}produceGroundUnitAt(g,P,L){let _=L.createUnitForPlayer(P.rules,g.owner);P.rules.trainable&&g.owner.canProduceVeteran(_.rules)&&_.veteranTrait?.setVeteranLevel(ee.VeteranLevel.Veteran),_.isInfantry()&&(_.position.subCell=Q.Infantry.SUB_CELLS[0]);let V,W=this.computeInternalRallyPoint(g,this.type,g.rallyTrait.getRallyPoint(),L.map);var K;let q;if(this.type!==U.FactoryType.UnitType&&(W=g.rallyTrait.findRallyPointforUnit(_,W,L.map,!1,g.tile.z)),V=this.type===U.FactoryType.NavalUnitType?W:(K=this.computeExitCoords(g,this.type),L.map.tiles.getByMapCoords(Math.floor(K.rx),Math.floor(K.ry))),_.rules.consideredAircraft&&(W=V),g.rallyTrait.getRallyPoint()!==W&&(q=g.rallyTrait.findRallyNodeForUnit(_,L.map)),_.isInfantry()){let g=L.map.tileOccupation.getObjectsOnTileByLayer(q?.tile??W,_.rules.consideredAircraft?Y.LayerType.Air:Y.LayerType.Ground).filter(g=>g.isInfantry()&&g.moveTrait.moveState!==z.MoveState.Moving).map(g=>g.position.subCell);_.position.subCell=Q.Infantry.SUB_CELLS.find(P=>!g.includes(P))??Q.Infantry.SUB_CELLS[0]}function l(){var P;_.rules.consideredAircraft?(P=q??{tile:W,onBridge:void 0},_.unitOrderTrait.addTaskNext(new Z.MoveTask(L,P.tile,!!P.onBridge,{closeEnoughTiles:L.rules.general.closeEnough}))):_.unitOrderTrait.addTaskNext(new G.ExitFactoryTask(L,g,W,q))}_.direction=270,L.spawnObject(_,V),L.traits.filter(te.NotifyProduceUnit).forEach(g=>{g[te.NotifyProduceUnit.onProduce](_,L)}),L.events.dispatch(new $.FactoryProduceUnitEvent(_)),g.rules.deployTime?_.unitOrderTrait.addTask(new ce.TaskGroup(new oe.WaitMinutesTask(g.rules.deployTime),new le.CallbackTask(()=>{g.isSpawned&&g.buildStatus!==I.BuildStatus.BuildDown&&l()})).setCancellable(!1)):l(),this.status=ue.Delivering,this.deliveringUnit=_}produceAircraftAt(g,P,I){let L=g.traits.find(q.DockTrait);if(!L)return!1;var _=L.getFirstAvailableDockNumber();if(void 0===_)return!1;let U=I.createUnitForPlayer(P.rules,g.owner);P.rules.trainable&&g.owner.canProduceVeteran(U.rules)&&U.veteranTrait?.setVeteranLevel(ee.VeteranLevel.Veteran);var G=L.getDockOffset(_);return U.position.moveToLeptons(g.position.getMapPosition()),U.position.moveByLeptons3(G),I.spawnObject(U,U.position.tile),L.dockUnitAt(U,_),U.isAircraft()&&U.airportBoundTrait&&(U.airportBoundTrait.preferredAirport=g),I.traits.filter(te.NotifyProduceUnit).forEach(g=>{g[te.NotifyProduceUnit.onProduce](U,I)}),I.events.dispatch(new $.FactoryProduceUnitEvent(U)),!0}computeExitCoords(g,P){if(P===U.FactoryType.InfantryType)return this.computeBarracksDefaultExitCoords(g);if(P===U.FactoryType.UnitType)return this.computeWarFactoryExitCoords(g);throw new Error("Unsupported factory type "+U.FactoryType[P])}computeInternalRallyPoint(g,P,I,L){let _,G;if(P===U.FactoryType.NavalUnitType)G=this.computeNavalInternalRallyPoint(g,I,L);else{if(P===U.FactoryType.InfantryType)_=this.computeBarracksInternalRallyCoords(g);else{if(P!==U.FactoryType.UnitType)throw new Error("Unsupported factory type "+U.FactoryType[P]);_=this.computeWarFactoryInternalRallyCoords(g)}G=L.tiles.getByMapCoords(_.rx,_.ry)}return G??this.findTileAdjacentToBuilding(g,L)}computeDefaultRallyPoint(g,P,I){let L,_;if(P===U.FactoryType.NavalUnitType)_=this.computeNavalDefaultRallyPoint(g,I);else{if(P===U.FactoryType.InfantryType)L=this.computeBarracksInternalRallyCoords(g);else{if(P!==U.FactoryType.UnitType)throw new Error("Unsupported factory type "+U.FactoryType[P]);L=this.computeWarFactoryDefaultRallyCoords(g)}_=I.tiles.getByMapCoords(L.rx,L.ry)}return _??this.findTileAdjacentToBuilding(g,I)}findTileAdjacentToBuilding(g,P){return new X.RadialTileFinder(P.tiles,P.mapBounds,g.tile,g.getFoundation(),1,1,()=>!0).getNextTile()}computeBarracksDefaultExitCoords(g){var P=g.getFoundation();let I,L;return P.width<=2||P.height<=2?(I=P.width-1,L=P.height-1,g.rules.gdiBarracks&&2<P.width&&(I=Math.floor(P.width/2))):(I=0,L=P.height-1),{rx:g.tile.rx+I,ry:g.tile.ry+L}}computeBarracksInternalRallyCoords(g){var P=g.getFoundation();let{rx:I,ry:L}=this.computeBarracksDefaultExitCoords(g);return!(P.width<=2||P.height<=2)||g.rules.gdiBarracks?L+=1:g.rules.nodBarracks&&(I+=P.width<=2?1:0,L+=P.height<=2?1:0),{rx:I,ry:L}}computeWarFactoryExitCoords(g){var P=g.getFoundation();return{rx:g.tile.rx+Math.floor(P.width/2),ry:g.tile.ry+Math.floor(P.height/2)}}computeWarFactoryInternalRallyCoords(g){var P=g.getFoundation();return{rx:g.tile.rx+P.width-1,ry:g.tile.ry+Math.floor(P.height/2)}}computeWarFactoryDefaultRallyCoords(g){var P=g.getFoundation();return{rx:g.tile.rx+P.width,ry:g.tile.ry+Math.floor(P.height/2)}}computeNavalDefaultRallyPoint(g,P){let I=new K.CardinalTileFinder(P.tiles,P.mapBounds,g.centerTile,5,5,g=>g.terrainType===V.TerrainType.Water&&!P.getObjectsOnTile(g).find(g=>g.isBuilding()||g.isOverlay()&&g.isBridge()));return I.diagonal=!1,I.getNextTile()??P.tiles.getByMapCoords(g.tile.rx+g.getFoundation().width,g.tile.ry+g.getFoundation().height)}computeNavalInternalRallyPoint(g,P,I){var L=new re.Vector2(P.rx,P.ry).sub(new re.Vector2(g.centerTile.rx,g.centerTile.ry));return I.tiles.getByMapCoords(g.centerTile.rx+Math.sign(L.x)*(Math.floor(g.getFoundation().width/2)+1),g.centerTile.ry+Math.sign(L.y)*(Math.floor(g.getFoundation().height/2)+1))}},g("FactoryTrait",de)}}}),System.register("game/gameobject/trait/FreeUnitTrait",["game/gameobject/trait/interface/NotifyBuildStatus","game/gameobject/Building","engine/type/ObjectType","game/map/tileFinder/RadialBackFirstTileFinder"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=class{[I.NotifyBuildStatus.onStatusChange](g,P,I){if(P.buildStatus===L.BuildStatus.Ready&&g===L.BuildStatus.BuildUp&&!P.owner.isNeutral){let g;if(I.rules.hasObject(P.rules.freeUnit,_.ObjectType.Vehicle))g=I.rules.getObject(P.rules.freeUnit,_.ObjectType.Vehicle);else{if(!I.rules.hasObject(P.rules.freeUnit,_.ObjectType.Infantry))return void console.warn(`Free unit "${P.rules.freeUnit}" is not a vehicle or infantry type.`);g=I.rules.getObject(P.rules.freeUnit,_.ObjectType.Infantry)}let L,V=I.createUnitForPlayer(g,P.owner);var G=new U.RadialBackFirstTileFinder(I.map.tiles,I.map.mapBounds,P.tile,P.getFoundation(),1,1,g=>{var _=0<I.map.terrain.getPassableSpeed(g,V.rules.speedType,V.isInfantry(),!1)&&Math.abs(g.z-P.tile.z)<2&&!I.map.terrain.findObstacles({tile:g,onBridge:void 0},V).length;return!L&&_&&(L=g),_&&!I.map.getObjectsOnTile(g).find(g=>g.isOverlay())}).getNextTile()??L;if(!G)return P.owner.removeOwnedObject(V),V.dispose(),void(P.owner.credits+=V.purchaseValue);I.spawnObject(V,G)}}},g("FreeUnitTrait",G)}}}),System.register("game/gameobject/trait/GapGeneratorTrait",["game/GameSpeed","game/map/MapShroud","game/math/Box2","game/math/Vector2","game/rules/TechnoRules","game/gameobject/unit/RangeHelper","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyUnspawn","game/gameobject/trait/interface/NotifyWarpChange"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g}],execute:function(){Q=class{constructor(g){this.radiusTiles=g,this.refreshTicks=0}[K.NotifyTick.onTick](g,P){0<this.refreshTicks&&this.refreshTicks--,this.refreshTicks<=0&&this.update(g,P)}[z.NotifySpawn.onSpawn](g,P){this.markGapTilesForFriendlies(g,g.owner,P,!0)}[q.NotifyUnspawn.onUnspawn](g,P){this.markGapTilesForFriendlies(g,g.owner,P,!1),this.update(g,P)}[W.NotifyOwnerChange.onChange](g,P,I){this.markGapTilesForFriendlies(g,P,I,!1),this.markGapTilesForFriendlies(g,g.owner,I,!0),this.update(g,I)}[$.NotifyWarpChange.onChange](g,P,I){this.markGapTilesForFriendlies(g,g.owner,P,!I),I&&this.update(g,P)}markGapTilesForFriendlies(g,P,I,_){let U,G=[P,...I.alliances.getAllies(P)];for(var W of G){let P=I.mapShroudTrait.getPlayerShroud(W);if(P&&(P.toggleFlagsAround(g.tile,this.radiusTiles,L.ShroudFlag.Darken,_),!_)){if(!U){let P=new V.RangeHelper(I.map.tileOccupation);U=G.map(g=>[...g.buildings]).flat().filter(I=>I.gapGeneratorTrait&&I!==g&&P.tileDistance(I,g)<=I.gapGeneratorTrait.radiusTiles+this.radiusTiles)}for(var z of U)P.toggleFlagsAround(z.tile,z.gapGeneratorTrait.radiusTiles,L.ShroudFlag.Darken,!0)}}}update(g,P){let L;this.refreshTicks=5*I.GameSpeed.BASE_TICKS_PER_SECOND;var V,W,z,K,q=g.owner.buildings.has(g)&&g.poweredTrait?.isPoweredOn();for(V of P.getCombatants())if(V!==g.owner&&!P.alliances.areAllied(g.owner,V)){let I=P.mapShroudTrait.getPlayerShroud(V);if(I)if(q)for(K of(I.unrevealAround(g.tile,this.radiusTiles),L||(z=this.radiusTiles+G.TechnoRules.MAX_SIGHT,W=new U.Vector2(g.tile.rx,g.tile.ry).addScalar(-z),z=new U.Vector2(g.tile.rx,g.tile.ry).addScalar(z),L=P.map.technosByTile.queryRange(new _.Box2(W,z))),L))K.owner===V||P.alliances.areAllied(K.owner,V)?I.revealFrom(K):K.rules.revealToAll&&I.revealObject(K);else[...V.buildings].some(g=>g.rules.spySat)&&I.revealAround(g.tile,this.radiusTiles)}}},g("GapGeneratorTrait",Q)}}}),System.register("game/gameobject/trait/GarrisonTrait",["game/gameobject/trait/interface/NotifyDestroy","game/map/tileFinder/RadialTileFinder","game/gameobject/trait/interface/NotifyDamage","util/math","game/event/BuildingEvacuateEvent","game/gameobject/task/ScatterTask"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){W=class{constructor(g,P,I){this.building=g,this.evacThreshold=P,this.maxOccupants=I,this.units=[]}isOccupied(){return!!this.units.length}canBeOccupied(){return this.building.healthTrait.health>100*this.evacThreshold}[_.NotifyDamage.onDamage](g,P){g.healthTrait.health<=100*this.evacThreshold&&this.evacuate(P)}[I.NotifyDestroy.onDestroy](g,P,I,L){if(L){for(var _ of this.units)_.deathType=g.deathType,P.destroyObject(_,I,!0);this.units=[]}else this.evacuate(P)}getHash(){return U.fnv32a(this.units.map(g=>g.getHash()))}debugGetState(){return{units:this.units.map(g=>g.debugGetState())}}dispose(){this.building=void 0}evacuate(g,P=!1){let I=this.building,_=this.units;if(_.length){let $=new Map;for(var U of _)$.set(U.rules.speedType,($.get(U.rules.speedType)||[]).concat(U));for(let[U,G]of $){var W,z=new L.RadialTileFinder(g.map.tiles,g.map.mapBounds,I.tile,I.art.foundation,1,1,P=>0<g.map.terrain.getPassableSpeed(P,U,!0,!1)&&Math.abs(P.z-I.tile.z)<2&&!g.map.terrain.findObstacles({tile:P,onBridge:void 0},G[0]).length).getNextTile();for(W of G){var K=_.indexOf(W);z?(_.splice(K,1),g.unlimboObject(W,z),W.onBridge=g.map.tileOccupation.getBridgeOnTile(z)?.isLowBridge()??!1,W.position.tileElevation=0,W.unitOrderTrait.addTask(new V.ScatterTask(g))):P||(g.destroyObject(W,{player:W.owner}),_.splice(K,1))}}var q=I.owner;_.length||I.isDestroyed||g.changeObjectOwner(I,g.getCivilianPlayer()),g.events.dispatch(new G.BuildingEvacuateEvent(I,q))}}},g("GarrisonTrait",W)}}}),System.register("game/gameobject/trait/GunnerTrait",["game/gameobject/unit/VeteranLevel","game/gameobject/trait/interface/NotifyTick"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class{[L.NotifyTick.onTick](g){var P,L;!!g.transportTrait.units.length!==this.lastHadGunner&&(this.lastHadGunner=!!g.transportTrait.units.length,L=P=g.transportTrait.units[0]?.rules.ifvMode??0,(P=g.rules.turretIndexesByIfvMode.get(P)??0)<g.rules.turretCount&&(g.turretNo=P,g.armedTrait?.selectSpecialWeapon(L,g.veteranLevel===I.VeteranLevel.Elite)))}getUiNameForIfvMode(g,P){switch(g){case 0:return"tip:rocket";case 1:return"tip:repair";case 2:case 4:case 5:return"tip:machinegun";default:return P?"name:"+P.toLowerCase():void 0}}},g("GunnerTrait",_)}}}),System.register("game/gameobject/trait/HarvesterTrait",["game/gameobject/trait/interface/NotifyTick","game/gameobject/task/harvester/ReturnOreTask","game/gameobject/task/harvester/GatherOreTask","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyOwnerChange","game/GameSpeed","game/gameobject/trait/interface/NotifyTeleport","game/gameobject/trait/interface/NotifyOrder","game/order/OrderType","game/type/LandType","engine/type/TiberiumType"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g}],execute:function(){var P;(P=Q||g("HarvesterStatus",Q={}))[P.Idle=0]="Idle",P[P.LookingForOreSite=1]="LookingForOreSite",P[P.MovingToOreSite=2]="MovingToOreSite",P[P.Harvesting=3]="Harvesting",P[P.LookingForRefinery=4]="LookingForRefinery",P[P.MovingToRefinery=5]="MovingToRefinery",P[P.Docking=6]="Docking",P[P.PreparingToUnload=7]="PreparingToUnload",P[P.Unloading=8]="Unloading",Y=class{get ore(){return this._ore}get gems(){return this._gems}constructor(g){this.storage=g,this._ore=0,this._gems=0,this.bails=new Map,this.status=Q.Idle,this.lastGatherExplicit=!1,this.autoGatherOnNextIdle=!1,this.ticksSinceLastRefineryCheck=0,this.ticksSinceLastOreCheck=0}addBails(g,P){this.bails.set(g,(this.bails.get(g)??0)+P),g===$.TiberiumType.Gems?this._gems+=P:this._ore+=P}getBails(){return[...this.bails.entries()]}[U.NotifySpawn.onSpawn](g,P){g.owner.isCombatant()&&(P.afterTick(()=>{g.unitOrderTrait.addTask(new _.GatherOreTask(P))}),g.attackTrait?.increasePassiveScanCooldown(1))}[G.NotifyOwnerChange.onChange](g,P,I){(!P.isCombatant()&&g.owner.isCombatant()||I.alliances.areAllied(g.owner,P))&&I.afterTick(()=>{g.unitOrderTrait.addTask(new _.GatherOreTask(I))})}[I.NotifyTick.onTick](g,P){this.status===Q.LookingForRefinery?this.ticksSinceLastRefineryCheck++>5*V.GameSpeed.BASE_TICKS_PER_SECOND&&(this.ticksSinceLastRefineryCheck=0,g.unitOrderTrait.hasTasks()?this.ticksSinceLastRefineryCheck=-25*V.GameSpeed.BASE_TICKS_PER_SECOND:[...g.owner.buildings].some(g=>g.rules.refinery)||this.lastGatherExplicit?g.unitOrderTrait.addTask(new L.ReturnOreTask(P)):this.status=Q.Idle):this.status===Q.LookingForOreSite?this.ticksSinceLastOreCheck++>20*V.GameSpeed.BASE_TICKS_PER_SECOND&&(this.ticksSinceLastOreCheck=0,g.unitOrderTrait.hasTasks()||g.unitOrderTrait.addTask(new _.GatherOreTask(P))):this.status===Q.Idle&&this.autoGatherOnNextIdle&&g.unitOrderTrait.isIdle()&&g.tile.landType===q.LandType.Tiberium&&(this.autoGatherOnNextIdle=!1,g.unitOrderTrait.addTask(new _.GatherOreTask(P,g.tile,!0)))}[W.NotifyTeleport.onBeforeTeleport](g,P,I,U){!U&&g.owner.isCombatant()&&(this.status=Q.Idle,this.lastOreSite=void 0,I&&g.rules.teleporter&&P.afterTick(()=>{g.unitOrderTrait.addTask(new(this.isFull()?L.ReturnOreTask:_.GatherOreTask)(P))}))}[z.NotifyOrder.onPush](g,P){this.autoGatherOnNextIdle=[K.OrderType.AttackMove,K.OrderType.Move,K.OrderType.ForceMove,K.OrderType.Scatter].includes(P),[Q.LookingForRefinery,Q.LookingForOreSite].includes(this.status)&&(this.status=Q.Idle)}isFull(){return this.ore+this.gems>=this.storage}isEmpty(){return!this.ore&&!this.gems}empty(){this.bails.clear(),this._ore=this._gems=0}getHash(){return 100*this.ore+this.gems}debugGetState(){return{ore:this.ore,gems:this.gems}}},g("HarvesterTrait",Y)}}}),System.register("game/gameobject/trait/HealthTrait",["util/math","game/gameobject/trait/interface/NotifyDamage","game/trait/interface/NotifyHealthChange","game/event/InflictDamageEvent","game/gameobject/trait/interface/NotifyHealthChange","game/gameobject/trait/interface/NotifyHeal","game/gameobject/unit/HealthLevel","game/gameobject/trait/interface/NotifyTick","game/event/HealthChangeEvent"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g}],execute:function(){q=class{get health(){return this._computedHealth}set health(g){this.setHitPoints(0<g?Math.max(1,Math.floor(g*this.maxHitPoints/100)):0),this.projectedHitPoints=this.hitPoints}get level(){return this.health>100*this.conditionYellow?W.HealthLevel.Green:this.health>100*this.conditionRed?W.HealthLevel.Yellow:W.HealthLevel.Red}constructor(g,P,I,L){this.maxHitPoints=g,this.gameObject=P,this.conditionYellow=I,this.conditionRed=L,this.setHitPoints(g),this.projectedHitPoints=this.hitPoints}setHitPoints(g){if(g!==Math.floor(g))throw new Error(`Value ${g} is not an integer`);this.hitPoints=I.clamp(g,0,this.maxHitPoints),this._computedHealth=this.hitPoints/this.maxHitPoints*100}getHitPoints(){return this.hitPoints}getProjectedHitPoints(){return this.projectedHitPoints}inflictDamage(g,P,I){var _=this.hitPoints,G=this.health;this.applyHitPoints(_-g,I),_!==this.hitPoints&&0<g&&(this.gameObject.traits.filter(L.NotifyDamage).forEach(_=>{_[L.NotifyDamage.onDamage](this.gameObject,I,g,P)}),I.events.dispatch(new U.InflictDamageEvent(this.gameObject,P,g,this.health,G)))}healBy(g,P,I){if(g<0)throw new Error("Can't heal by negative value "+g);if(this.hitPoints<this.maxHitPoints){var L=this.hitPoints;this.applyHitPoints(this.hitPoints+g,I),this.projectedHitPoints=this.hitPoints;let _=this.hitPoints-L;this.gameObject.traits.filter(V.NotifyHeal).forEach(g=>{g[V.NotifyHeal.onHeal]?.(this.gameObject,I,_,P)})}}healToFull(g,P){if(this.hitPoints<this.maxHitPoints){var I=this.hitPoints;this.applyHitPoints(this.maxHitPoints,P),this.projectedHitPoints=this.hitPoints;let L=this.hitPoints-I;this.gameObject.traits.filter(V.NotifyHeal).forEach(I=>{I[V.NotifyHeal.onHeal]?.(this.gameObject,P,L,g)})}}applyHitPoints(g,P){let I=this.health;this.setHitPoints(g),I!==this.health&&(P.traits.filter(_.NotifyHealthChange).forEach(g=>{g[_.NotifyHealthChange.onChange](this.gameObject,P,I)}),this.gameObject.traits.filter(G.NotifyHealthChange).forEach(g=>{g[G.NotifyHealthChange.onChange](this.gameObject,P,I)}),P.events.dispatch(new K.HealthChangeEvent(this.gameObject,this.health,I)))}projectDamage(g){if(g<0)throw new Error("Projected damage must be positive");this.projectedHitPoints=Math.max(-30,this.projectedHitPoints-g)}[z.NotifyTick.onTick](g,P){P.currentTick%4==0&&(this.projectedHitPoints=Math.min(this.projectedHitPoints+1,this.hitPoints))}getHash(){return this.hitPoints}debugGetState(){return{hitPoints:this.hitPoints}}dispose(){this.gameObject=void 0}},g("HealthTrait",q)}}}),System.register("game/gameobject/trait/HelipadTrait",["engine/type/ObjectType","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifyUnspawn"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class{[L.NotifyOwnerChange.onChange](g,P,I){this.checkAircraftsForPlayer(P,I)}[_.NotifyUnspawn.onUnspawn](g,P){this.checkAircraftsForPlayer(g.owner,P)}checkAircraftsForPlayer(g,P){let L=P.rules.general.padAircraft;var _;for(_ of g.getOwnedObjectsByType(I.ObjectType.Aircraft).filter(g=>L.includes(g.name)))_.airportBoundTrait&&(_.airportBoundTrait.preferredAirport=void 0)}},g("HelipadTrait",U)}}}),System.register("game/gameobject/trait/HospitalTrait",["engine/type/ObjectType","game/event/UnitRepairFinishEvent","game/GameSpeed","game/map/tileFinder/RadialTileFinder","game/gameobject/task/ScatterTask","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/trait/interface/NotifyTick"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g}],execute:function(){z=class{constructor(){this.healQueue=[]}addToHealQueue(g){return this.healQueue.push(g),this.healQueue.length-1}unitIsFirstInHealQueue(g){return this.healQueue[0]===g}removeFromHealQueue(g){var P=this.healQueue.indexOf(g);-1!==P&&this.healQueue.splice(P,1)}startHealing(g){if(this.unit)throw new Error(`Already busy healing unit ${I.ObjectType[this.unit.type]}#${this.unit.id}}`);this.unit=g,this.healTicks=5*_.GameSpeed.BASE_TICKS_PER_SECOND}[W.NotifyTick.onTick](g,P){var I;this.healQueue=this.healQueue.filter(g=>!g.isDestroyed&&!g.isCrashing),this.unit&&void 0!==this.healTicks&&(0<this.healTicks&&this.healTicks--,this.healTicks<=0&&(this.healTicks=void 0,this.removeFromHealQueue(this.unit),this.unit.healthTrait.healToFull(g,P),g.ammoTrait&&g.ammoTrait.ammo--,this.evacuate(this.unit,g,P),I=this.unit,this.unit=void 0,P.events.dispatch(new L.UnitRepairFinishEvent(I,g))))}[V.NotifyDestroy.onDestroy](g,P,I){this.unit&&(this.unit.deathType=g.deathType,P.destroyObject(this.unit,I,!0),this.unit=void 0)}evacuate(g,P,I){let L;var _={x:P.tile.rx,y:P.tile.ry+P.art.foundation.height};(_=I.map.tiles.getByMapCoords(_.x,_.y))&&I.map.isWithinBounds(_)&&this.canEvacuateTo(_,g,P,I)&&(L=_),L=L||new U.RadialTileFinder(I.map.tiles,I.map.mapBounds,P.tile,P.art.foundation,1,1,L=>this.canEvacuateTo(L,g,P,I)).getNextTile(),L?(I.unlimboObject(g,L),g.unitOrderTrait.addTask(new G.ScatterTask(I))):I.destroyObject(g,{player:g.owner})}canEvacuateTo(g,P,I,L){return 0<L.map.terrain.getPassableSpeed(g,P.rules.speedType,P.isInfantry(),!1)&&Math.abs(g.z-I.tile.z)<2&&!L.map.terrain.findObstacles({tile:g,onBridge:void 0},P).length}},g("HospitalTrait",z)}}}),System.register("game/gameobject/trait/HoverBobTrait",["game/GameSpeed","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifySpawn","game/Coords","game/gameobject/trait/interface/NotifyTileChange","game/math/GameMath"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){W=class{constructor(){this.prevHoverBobLeptons=0,this.spawnTick=0}[_.NotifySpawn.onSpawn](g,P){this.setBaseElevation(g,P),this.spawnTick=P.currentTick}[G.NotifyTileChange.onTileChange](g,P,I,L){L&&(this.prevHoverBobLeptons=0,this.setBaseElevation(g,P))}setBaseElevation(g,P){g.position.tileElevation=(g.onBridge?P.map.tileOccupation.getBridgeOnTile(g.tile)?.tileElevation??0:0)+U.Coords.worldToTileHeight(P.rules.general.hover.height)}[L.NotifyTick.onTick](g,P){var I=this.computeHoverBobLeptons(P.currentTick,P.rules.general.hover),L=I-this.prevHoverBobLeptons;this.prevHoverBobLeptons=I,I=U.Coords.tileHeightToWorld(g.position.tileElevation),g.position.tileElevation=U.Coords.worldToTileHeight(I+L)}computeHoverBobLeptons(g,P){var L=(g-this.spawnTick)/I.GameSpeed.BASE_TICKS_PER_SECOND/(60*P.bob);return.1*P.height*V.GameMath.sin(2*L*Math.PI)}},g("HoverBobTrait",W)}}}),System.register("game/gameobject/trait/IdleActionTrait",["game/gameobject/trait/interface/NotifyTick","game/gameobject/task/ScatterTask","game/GameSpeed"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class{constructor(){this.cooldownTicks=Number.POSITIVE_INFINITY,this._actionDueThisTick=!1}[I.NotifyTick.onTick](g,P){this._actionDueThisTick=!1;var I=!g.unitOrderTrait.hasTasks();I&&!this.idle?this.resetCooldown(P):I?0===this.cooldownTicks?(this.doIdleAction(g,P),this.resetCooldown(P)):this.cooldownTicks--:this.cooldownTicks=Number.POSITIVE_INFINITY,this.idle=I}doIdleAction(g,P){if(g.isInfantry()){if(g.rules.fraidycat&&g.owner.isNeutral&&.5<P.generateRandom())return void g.unitOrderTrait.addTask(new L.ScatterTask(P,void 0,{noSlopes:!0}));this._actionDueThisTick=!0}}actionDueThisTick(){return this._actionDueThisTick}resetCooldown(g){var P=g.rules.audioVisual.idleActionFrequency,I=g.generateRandom()*P*.5;I=Math.max(0,P-I);this.cooldownTicks=Math.floor(I*_.GameSpeed.BASE_TICKS_PER_SECOND)}},g("IdleActionTrait",U)}}}),System.register("game/gameobject/trait/interface/NotifyAttack",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifyAttack",I={})).onAttack=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifyBuildStatus",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifyBuildStatus",I={})).onStatusChange=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifyCrash",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifyCrash",I={})).onCrash=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifyDamage",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifyDamage",I={})).onDamage=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifyDestroy",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifyDestroy",I={})).onDestroy=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifyHeal",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifyHeal",I={})).onHeal=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifyHealthChange",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifyHealthChange",I={})).onChange=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifyOrder",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifyOrder",I={})).onPush=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifyOwnerChange",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifyOwnerChange",I={})).onChange=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifySell",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifySell",I={})).onSell=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifySpawn",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifySpawn",I={})).onSpawn=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifyTeleport",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifyTeleport",I={})).onBeforeTeleport=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifyTick",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifyTick",I={})).onTick=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifyTileChange",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifyTileChange",I={})).onTileChange=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifyUnspawn",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifyUnspawn",I={})).onUnspawn=Symbol()}}}),System.register("game/gameobject/trait/interface/NotifyWarpChange",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifyWarpChange",I={})).onChange=Symbol()}}}),System.register("game/gameobject/trait/InvulnerableTrait",["game/gameobject/unit/Timer","game/gameobject/trait/interface/NotifyTick"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class{constructor(){this.timer=new I.Timer}isActive(){return this.timer.isActive()}setActiveFor(g,P){this.timer.setActiveFor(g,P)}[L.NotifyTick.onTick](g,P){this.timer.tick(P.currentTick)}},g("InvulnerableTrait",_)}}}),System.register("game/gameobject/trait/MindControllableTrait",["game/gameobject/trait/interface/NotifyUnspawn"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class{constructor(g){this.gameObject=g}getOriginalOwner(){return this.prevOwner}isActive(){return!!this.controller}getController(){return this.controller}controlBy(g,P){if(this.controller)throw new Error(`Object "${this.gameObject?.name}" is already mind controlled by "${g.name}"`);this.controller=g,this.prevOwner=this.gameObject.owner,P.changeObjectOwner(this.gameObject,g.owner)}restore(g){if(this.prevOwner){let P=this.prevOwner;this.prevOwner.defeated&&(P=g.getCivilianPlayer()),g.changeObjectOwner(this.gameObject,P),this.prevOwner=void 0,this.controller=void 0}}[I.NotifyUnspawn.onUnspawn](g,P){this.controller&&(this.controller.mindControllerTrait.cleanTarget(g),!g.isDestroyed&&g.limboData&&this.restore(P))}dispose(){this.gameObject=void 0}},g("MindControllableTrait",L)}}}),System.register("game/gameobject/trait/MindControllerTrait",["game/gameobject/trait/interface/NotifyUnspawn"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class{constructor(g,P=1){this.gameObject=g,this.maxCapacity=P,this.targets=[]}isActive(){return 0<this.targets.length}isAtCapacity(){return this.targets.length===this.maxCapacity}getTargets(){return this.targets}control(g,P){if(!this.gameObject)throw new Error("Trait already disposed");if(!g.mindControllableTrait)throw new Error(`Target "${g.name}" cannot be mind controlled`);if(g.isDisposed)throw new Error(`Target "${g.name}" is disposed`);for(g.mindControllableTrait.controlBy(this.gameObject,P),this.targets.push(g);this.targets.length>this.maxCapacity;){this.targets.shift().mindControllableTrait.restore(P)}}cleanTarget(g){var P=this.targets.indexOf(g);-1!==P&&this.targets.splice(P,1)}[I.NotifyUnspawn.onUnspawn](g,P){for(var I of this.targets)I.mindControllableTrait.restore(P);this.targets.length=0}dispose(){this.gameObject=void 0}},g("MindControllerTrait",L)}}}),System.register("game/gameobject/trait/MissileSpawnTrait",["game/gameobject/unit/CollisionType","game/gameobject/trait/interface/NotifyDestroy"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class{setWarhead(g){return this.warhead=g,this}setDamage(g){return this.damage=g,this}setLauncher(g){return this.launcher=g,this}[L.NotifyDestroy.onDestroy](g,P){this.warhead&&this.damage&&this.launcher&&this.warhead.detonate(P,this.damage,g.tile,g.tileElevation,g.position.worldPosition,g.zone,I.CollisionType.None,P.createTarget(void 0,g.tile),{player:g.owner,obj:this.launcher,weapon:void 0})}dispose(){this.launcher=void 0}},g("MissileSpawnTrait",_)}}}),System.register("game/gameobject/trait/MoveTrait",["game/gameobject/task/move/MoveTask","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/unit/ZoneType","game/gameobject/infantry/InfDeathType","game/event/ObjectTeleportEvent","game/gameobject/common/DeathType","game/gameobject/trait/interface/NotifyTeleport","game/type/LocomotorType","game/gameobject/locomotor/JumpjetLocomotor","game/type/SpeedType","game/gameobject/locomotor/WingedLocomotor","game/gameobject/infantry/StanceType","game/trait/interface/NotifyTileChange","game/gameobject/trait/interface/NotifyTileChange","game/event/EnterTileEvent","game/math/Vector3","game/trait/interface/NotifyElevationChange"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g}],execute:function(){var P;(P=re||g("MoveState",re={}))[P.Idle=0]="Idle",P[P.ReachedNextWaypoint=1]="ReachedNextWaypoint",P[P.PlanMove=2]="PlanMove",P[P.Moving=3]="Moving",(P=se||g("MoveResult",se={}))[P.Success=0]="Success",P[P.Cancel=1]="Cancel",P[P.CloseEnough=2]="CloseEnough",P[P.Fail=3]="Fail",(P=ae||g("CollisionState",ae={}))[P.Waiting=0]="Waiting",P[P.Resolved=1]="Resolved",ne=g=>g instanceof I.MoveTask||g.children[0]&&ne(g.children[0]),oe=class{get baseSpeed(){return this.gameObject.rules.speed*(this.gameObject.veteranTrait?.getVeteranSpeedMultiplier()??1)*this.gameObject.crateBonuses.speed*(this.gameObject.isVehicle()&&this.gameObject.healthTrait.health<=50&&this.gameObject.rules.locomotor!==K.LocomotorType.Hover?.75:1)*(1-this.speedPenalty)}constructor(g,P){this.gameObject=g,this.tileOccupation=P,this.disabled=!1,this.speedPenalty=0,this.velocity=new ee.Vector3,this.reservedPathNodes=[],this.moveState=re.Idle,this.collisionState=ae.Resolved}isDisabled(){return this.disabled}setDisabled(g){this.disabled=g}isMoving(){return this.moveState===re.Moving}isIdle(){return this.moveState===re.Idle}isWaiting(){return this.collisionState===ae.Waiting}[L.NotifyTick.onTick](g,P){var I;this.moveState!==re.Idle&&this.collisionState===ae.Resolved&&((I=g.unitOrderTrait.getCurrentTask())&&ne(I)||(this.velocity.set(0,0,0),this.moveState=re.Idle,this.locomotor=void 0,!I&&!g.attackTrait?.currentTarget&&g.isVehicle()&&g.turretTrait&&(g.turretTrait.desiredFacing=g.direction))),this.moveState===re.Idle&&(g.rules.locomotor===K.LocomotorType.Jumpjet?q.JumpjetLocomotor.tickStationary(g,P):g.isAircraft()&&g.rules.locomotor===K.LocomotorType.Aircraft&&Q.WingedLocomotor.tickStationary(g,P))}[_.NotifyDestroy.onDestroy](g,P){this.unreservePathNodes()}teleportUnitToTile(g,P,I,L,_){let U=this.gameObject;var G=U.tile;U.traits.filter(z.NotifyTeleport).forEach(g=>{g[z.NotifyTeleport.onBeforeTeleport](U,_,I,L)}),U.position.tileElevation=U.tileElevation,U.position.tile=g,U.position.subCell=U.position.desiredSubCell,this.handleTileChange(G,P,!0,_,!0),L||(this.unreservePathNodes(),this.speedPenalty=0,this.velocity.set(0,0,0),this.moveState=re.Idle,this.collisionState=ae.Resolved,this.locomotor=void 0,this.currentWaypoint=void 0,this.lastTargetOffset=void 0,this.lastVelocity=void 0,this.lastMoveResult=se.Cancel,U.isVehicle()&&(U.spinVelocity=0,U.turretTrait&&(U.turretTrait.desiredFacing=U.direction))),this.lastTeleportTick=_.currentTick,_.events.dispatch(new V.ObjectTeleportEvent(U,I,G))}handleTileChange(g,P,I,L,_=!1){const V=this.gameObject;if(L.map.tileOccupation.unoccupyTileRange(g,V),L.map.tileOccupation.occupyTileRange(V.tile,V),L.map.technosByTile.updateObject(V),V.zone!==U.ZoneType.Air){var z=V.onBridge?L.map.tileOccupation.getBridgeOnTile(g):void 0,K=V.onBridge?g.onBridgeLandType:g.landType,q=P?V.tile.onBridgeLandType:V.tile.landType;K!==q&&(0<L.rules.getLandRules(q).getSpeedModifier(V.rules.speedType)||V.rules.speedType===$.SpeedType.Amphibious||_)&&(V.zone=U.getZoneType(q)),P!==z&&(V.position.tileElevation+=-(z?.tileElevation??0)+(P?.tileElevation??0),V.onBridge=!!P);var Q;z=V.moveTrait.reservedPathNodes.findIndex(g=>g.tile===V.tile);if(-1!==z&&V.moveTrait.reservedPathNodes.splice(z,1),V.crusher)for(Q of L.map.getGroundObjectsOnTile(V.tile).filter(g=>(!g.isUnit()||g.onBridge===V.onBridge)&&g.rules.crushable&&!(g.isInfantry()&&g.stance===Y.StanceType.Paradrop)&&(!(g.isTechno()&&!I)||!L.areFriendly(g,V))))Q.isDestroyed||(Q.isInfantry()&&(Q.infDeathType=G.InfDeathType.None),V.isVehicle()&&Q.isOverlay()&&Q.rules.wall&&V.applyRocking(0,.5),Q.deathType=W.DeathType.Crush,L.destroyObject(Q,{player:V.owner,obj:V}));V.onBridge||(z=L.map.tileOccupation.getGroundObjectsOnTile(V.tile).find(g=>g.isOverlay()&&g.rules.crate))&&L.crateGeneratorTrait.pickupCrate(V,z,L)}L.traits.filter(Z.NotifyTileChange).forEach(P=>{P[Z.NotifyTileChange.onTileChange](V,L,g,_)}),V.traits.filter(X.NotifyTileChange).forEach(P=>{P[X.NotifyTileChange.onTileChange](V,L,g,_)}),L.events.dispatch(new J.EnterTileEvent(V.tile,V))}handleElevationChange(g,P){P.traits.filter(te.NotifyElevationChange).forEach(I=>{I[te.NotifyElevationChange.onElevationChange](this.gameObject,P,g)})}unreservePathNodes(){this.reservedPathNodes.forEach(g=>{g.tile!==this.gameObject.tile&&this.tileOccupation.unoccupySingleTile(g.tile,this.gameObject)}),this.reservedPathNodes.length=0}dispose(){this.gameObject=void 0}},g("MoveTrait",oe)}}}),System.register("game/gameobject/trait/OilDerrickTrait",["game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifySpawn"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class{constructor(){this.isActive=!1,this.produceCashCooldown=0}[_.NotifySpawn.onSpawn](g){g.owner.isNeutral||(this.isActive=!0)}[I.NotifyOwnerChange.onChange](g,P){P.isNeutral&&!g.owner.isNeutral&&(g.owner.credits=Math.max(0,g.owner.credits+g.rules.produceCashStartup),0<g.rules.produceCashStartup&&(g.owner.creditsGained+=g.rules.produceCashStartup),this.isActive=!0,this.produceCashCooldown=g.rules.produceCashDelay)}[L.NotifyTick.onTick](g){this.isActive&&(this.produceCashCooldown--,this.produceCashCooldown<=0&&(this.produceCashCooldown=g.rules.produceCashDelay,g.owner.credits=Math.max(0,g.owner.credits+g.rules.produceCashAmount),0<g.rules.produceCashAmount&&(g.owner.creditsGained+=g.rules.produceCashAmount)))}},g("OilDerrickTrait",U)}}}),System.register("game/gameobject/trait/OverpoweredTrait",["game/gameobject/task/AttackTask","game/gameobject/trait/interface/NotifyTick"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class{constructor(g){this.obj=g,this.chargers=new Set}isOverpowered(){let g=1;return this.obj?.poweredTrait?.isPoweredOn(!0)||(g+=2),this.chargers.size>=g}hasChargersToPowerOn(){return 2<=this.chargers.size}chargeFrom(g){this.chargers.add(g),this.swapAttackTaskWeapon()}[L.NotifyTick.onTick](g){if(0<this.chargers.size){let P=!1;this.chargers.forEach(I=>{(I.isDestroyed||I.isCrashing||I.owner!==g.owner||I.attackTrait?.currentTarget?.obj!==g)&&(this.chargers.delete(I),P=!0)}),P&&this.swapAttackTaskWeapon()}}swapAttackTaskWeapon(){let g=this.obj?.unitOrderTrait.getCurrentTask();var P;g instanceof I.AttackTask&&((P=this.getWeapon())?g.setWeapon(P):g.cancel())}getWeapon(){return this.isOverpowered()?this.obj?.secondaryWeapon:this.obj?.primaryWeapon}dispose(){this.obj=void 0,this.chargers.clear()}},g("OverpoweredTrait",_)}}}),System.register("game/gameobject/trait/ParasiteableTrait",["game/gameobject/common/DeathType","game/gameobject/unit/ZoneType","game/gameobject/Vehicle","game/gameobject/trait/interface/NotifyAttack","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/trait/interface/NotifyHeal","game/gameobject/trait/interface/NotifyDamage","game/gameobject/trait/interface/NotifyTeleport","game/gameobject/trait/interface/NotifyTick","game/gameobject/task/system/WaitMinutesTask","game/GameSpeed","game/map/tileFinder/RadialTileFinder","game/gameobject/task/AttackTask"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g}],execute:function(){Z=()=>_.ROCKING_TICKS+2,X=class{constructor(g){this.gameObject=g,this.beingBoarded=!1}infest(g,P){this.beingBoarded=!1,this.parasite=g,this.parasiteWeapon=P,g.rules.organic?this.damageTickCooldown=Z():this.damageTickCooldown=0,this.lastAttacker=void 0,this.lastExternalBaseDamage=void 0,this.lastExternalDamageTick=void 0,P.warhead.rules.paralyzes&&this.gameObject.moveTrait.setDisabled(!0)}isInfested(){return!(!this.parasite||this.parasite.isDestroyed)||this.beingBoarded}isParalyzed(){return!!this.parasiteWeapon?.warhead.rules.paralyzes}uninfest(){this.parasite&&(this.parasiteWeapon.warhead.rules.paralyzes&&this.gameObject.moveTrait.setDisabled(!1),this.parasite=void 0,this.parasiteWeapon=void 0)}getParasite(){return this.parasite}[K.NotifyTick.onTick](g,P){if(this.parasite)if(this.parasite.isDestroyed)this.uninfest();else if(0<this.damageTickCooldown)this.damageTickCooldown--;else{let I=this.parasiteWeapon;this.damageTickCooldown=this.parasite.rules.organic?Z():I.getCooldownTicks();let _=I.rules.damage;this.parasite.veteranTrait&&(_*=this.parasite.veteranTrait.getVeteranDamageMultiplier());let U=I.warhead.computeDamage(_,g,P);this.canBeCulled(g,this.parasite,I,P)&&(U=g.healthTrait.getHitPoints()),I.warhead.inflictDamage(U,g,{player:this.parasite.owner,obj:this.parasite,weapon:I},P),g.isCrashing?(this.parasiteWeapon.expireCooldown(),this.evictOrDestroyParasite(g,P)):!g.isDestroyed&&g.isVehicle()&&g.zone!==L.ZoneType.Air&&I.warhead.rules.rocker&&g.applyRocking(90*(.5<=P.generateRandom()?1:-1),1)}}canBeCulled(g,P,I,L){if(!I.warhead.rules.culling)return!1;var _=L.rules.audioVisual;_=P.veteranTrait?.isElite()?_.conditionYellow:_.conditionRed;return g.healthTrait.health<=100*_}[V.NotifyHeal.onHeal](g,P,L,_){var U;!this.parasite||this.parasite.isDestroyed||_===g||g.isAircraft()&&_?.rules.unitReload||(!this.parasite.rules.organic||_?.rules.unitRepair?(this.parasite.deathType=I.DeathType.None,P.destroyObject(this.parasite,_?{player:_.owner,obj:_}:void 0),this.uninfest()):(U=this.parasite,this.evictOrDestroyParasite(g,P),this.stunParasite(U,P)))}[W.NotifyDamage.onDamage](g,P,I,L){L?.obj!==this.parasite&&(this.lastAttacker=L,this.lastExternalBaseDamage=L?.weapon?.rules.damage??I,this.lastExternalDamageTick=P.currentTick)}[U.NotifyAttack.onAttack](g,P,I){if(this.parasite&&!this.parasite.isDestroyed&&P?.weapon?.warhead.rules.sonic){var L,_=this.parasite;this.evictOrDestroyParasite(g,I),this.stunParasite(_,I);let U=P.weapon.warhead;U.canDamage(_,_.tile,_.zone)&&(L=U.computeDamage(P.weapon.rules.damage,_,I),U.inflictDamage(L,_,P,I));let G=P.obj?.unitOrderTrait.getCurrentTask();G instanceof Y.AttackTask&&G.getWeapon().warhead.rules.sonic&&G.cancel()}}[G.NotifyDestroy.onDestroy](g,P,L,_){this.parasite&&!this.parasite.isDestroyed&&(_||this.shouldSupressParasite(P,this.parasite)?(this.parasite.deathType=I.DeathType.None,P.destroyObject(this.parasite,L,_),this.uninfest()):(this.parasiteWeapon.expireCooldown(),this.evictOrDestroyParasite(g,P)))}shouldSupressParasite(g,P){return!P.invulnerableTrait.isActive()&&this.lastExternalBaseDamage&&this.lastExternalBaseDamage>P.rules.suppressionThreshold&&g.currentTick-this.lastExternalDamageTick<2*(this.lastExternalBaseDamage-P.rules.suppressionThreshold)}[z.NotifyTeleport.onBeforeTeleport](g,P,L,_){var U;L&&_&&this.parasite&&!this.parasite.isDestroyed&&(this.shouldSupressParasite(P,this.parasite)?(this.parasite.deathType=I.DeathType.None,P.destroyObject(this.parasite,this.lastAttacker),this.uninfest()):(this.parasiteWeapon.expireCooldown(),U=this.parasite,this.evictOrDestroyParasite(g,P,!0),U.isDestroyed||this.stunParasite(U,P)))}stunParasite(g,P){g.unitOrderTrait.addTaskToFront(new q.WaitMinutesTask(10/60).setCancellable(!1)),g.isVehicle()&&g.submergibleTrait&&(g.submergibleTrait.emerge(g,P),g.cloakableTrait?.uncloak(P),g.submergibleTrait.setCooldown(10*$.GameSpeed.BASE_TICKS_PER_SECOND))}evictOrDestroyParasite(g,P,L=!1){if(this.parasite&&!this.parasite.isDestroyed){if(P.map.terrain.getPassableSpeed(g.tile,this.parasite.rules.speedType,this.parasite.isInfantry(),g.onBridge)||P.map.getObjectsOnTile(g.tile).find(g=>g.isBuilding())){let U=g.tile,G=g.onBridge;if(!L&&!g.isDestroyed||this.parasite.rules.organic){var _=new Q.RadialTileFinder(P.map.tiles,P.map.mapBounds,U,{width:1,height:1},1,1,g=>0<P.map.terrain.getPassableSpeed(g,this.parasite.rules.speedType,this.parasite.isInfantry(),G)&&!P.map.terrain.findObstacles({tile:g,onBridge:G},this.parasite).length).getNextTile();if(!_)return this.parasite.deathType=I.DeathType.None,P.destroyObject(this.parasite,{player:g.owner,obj:g}),void this.uninfest();U=_}this.parasite.onBridge=G,this.parasite.position.subCell=this.parasite.isInfantry()?g.position.subCell:0,this.parasite.zone=P.map.getTileZone(U,!G),this.parasite.position.tileElevation=G?P.map.tileOccupation.getBridgeOnTile(U).tileElevation:0,this.parasite.resetGuardModeToIdle(),P.unlimboObject(this.parasite,U,!0)}else this.parasite.deathType=I.DeathType.None,P.destroyObject(this.parasite,{player:g.owner,obj:g});this.uninfest()}}destroyParasite(g,P){this.parasite&&(this.parasite.deathType=I.DeathType.None,P.destroyObject(this.parasite,g),this.uninfest())}dispose(){this.gameObject=void 0}},g("ParasiteableTrait",X)}}}),System.register("game/gameobject/trait/PoweredTrait",["game/player/trait/PowerTrait"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("PoweredTrait",class{constructor(g){this.obj=g,this.turnedOn=!0}setTurnedOn(g){this.turnedOn=g}isCharged(){return!!this.obj.isBuilding()&&!!this.obj.overpoweredTrait?.hasChargersToPowerOn()}isPoweredOn(g=!1){return!(!this.obj||!this.turnedOn||(g||!this.isCharged())&&(!this.obj.rules.power&&this.obj.rules.needsEngineer?this.obj.owner.isNeutral:!this.obj.owner.powerTrait||this.obj.owner.powerTrait?.level===I.PowerLevel.Low))}dispose(){this.obj=void 0}})}}}),System.register("game/gameobject/trait/PsychicDetectorTrait",["game/Coords","game/GameSpeed","game/gameobject/unit/RangeHelper","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyWarpChange"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){V=L.GameSpeed.BASE_TICKS_PER_SECOND,W=class{constructor(g){this.radiusTiles=g,this.detectionLines=[],this.nextScan=V}[U.NotifyTick.onTick](g,P){g.owner.powerTrait?.isLowPower()?this.disable():(0<this.nextScan&&this.nextScan--,this.nextScan<=0&&(this.nextScan=V,this.detectionLines=this.scan(g,P)))}[G.NotifyWarpChange.onChange](g,P,I){I&&this.disable()}disable(){this.detectionLines.length&&(this.detectionLines=[],this.nextScan=0)}scan(g,P){var L=P.getCombatants().filter(I=>I!==g.owner&&!P.alliances.areAllied(I,g.owner));let U=[],G=new _.RangeHelper(P.map.tileOccupation);var V,W,z,l=P=>G.distance2(P,g)/I.Coords.LEPTONS_PER_TILE<=this.radiusTiles;for(V of L)for(var K of V.getOwnedObjects())K.attackTrait?.currentTarget?l((W=K.attackTrait.currentTarget).obj??W.tile)&&U.push({source:K,target:W}):K.isUnit()&&K.unitOrderTrait.targetLinesConfig&&((z=K.unitOrderTrait.targetLinesConfig).target?l(z.target)&&(W=P.createTarget(z.target,z.target.tile),U.push({source:K,target:W})):(z=z.pathNodes[0])&&l(z.tile)&&(z=P.createTarget(z.onBridge,z.tile),U.push({source:K,target:z})));return U}},g("PsychicDetectorTrait",W)}}}),System.register("game/gameobject/trait/RallyTrait",["engine/type/TerrainType","game/map/tileFinder/RadialTileFinder","game/rules/TechnoRules","game/type/MovementZone","game/type/SpeedType"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){g("RallyTrait",class{getRallyPoint(){return this.rallyPoint}changeRallyPoint(g,P,I){var L=this.findValidRallyPoint(P,g,I.map);L&&(this.rallyPoint=L)}findValidRallyPoint(g,P,U){let V=new L.RadialTileFinder(U.tiles,U.mapBounds,P,{width:1,height:1},0,20,P=>(g.rules.naval||P.terrainType!==I.TerrainType.Water)&&!U.tileOccupation.isTileOccupiedBy(P,g)),W=V.getNextTile();if(!W&&g.factoryTrait?.type===_.FactoryType.NavalUnitType){var{width:z,height:K}=g.getFoundation();for(let P=0;P<z;P++)for(let I=0;I<K;I++){var q=U.tiles.getByMapCoords(g.tile.rx+P,g.tile.ry+I);if(!q)break;if(0<U.terrain.getPassableSpeed(q,G.SpeedType.Float,!1,!1)){W=q;break}}}return W}findRallyNodeForUnit(g,P){if(this.rallyPoint){var I=this.findRallyPointforUnit(g,this.rallyPoint,P,!0);return{tile:I,onBridge:g.rules.naval?void 0:P.tileOccupation.getBridgeOnTile(I)}}}findRallyPointforUnit(g,P,I,_,G){let V=g.rules.naval?void 0:I.tileOccupation.getBridgeOnTile(P),W=g.rules.movementZone===U.MovementZone.Fly,z=new L.RadialTileFinder(I.tiles,I.mapBounds,P,{width:1,height:1},0,5,P=>{var L=!V||V.isHighBridge()?I.tileOccupation.getBridgeOnTile(P):void 0;return!(W?[]:I.terrain.findObstacles({tile:P,onBridge:L},g)).length&&(void 0===G||Math.abs(G-(P.z+(L?.tileElevation??0)))<4)&&(!_||!I.getObjectsOnTile(P).find(g=>g.isBuilding()&&!g.isDestroyed))&&(W||0<I.terrain.getPassableSpeed(P,g.rules.speedType,g.isInfantry(),!!L))});return z.getNextTile()??P}})}}}),System.register("game/gameobject/trait/SelfHealingTrait",["game/gameobject/trait/interface/NotifyTick","game/GameSpeed"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class{constructor(){this.cooldownTicks=0}[I.NotifyTick.onTick](g,P){100!==g.healthTrait.health&&(this.cooldownTicks<=0?(this.cooldownTicks+=L.GameSpeed.BASE_TICKS_PER_SECOND*P.rules.general.repair.repairRate*60,g.healthTrait.healBy(1,g,P)):this.cooldownTicks--)}},g("SelfHealingTrait",_)}}}),System.register("game/gameobject/trait/SensorsTrait",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("SensorsTrait",class{})}}}),System.register("game/gameobject/trait/SpawnDebrisTrait",["engine/type/ObjectType","game/gameobject/common/DeathType","game/gameobject/trait/interface/NotifyCrash","game/gameobject/trait/interface/NotifyDestroy"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=class{[_.NotifyCrash.onCrash](g,P){this.handleDestroy(g,P)}[U.NotifyDestroy.onDestroy](g,P,I){I?.weapon?.warhead.rules.temporal||g.isCrashing||g.deathType!==L.DeathType.Sink&&g.isSpawned&&this.handleDestroy(g,P)}handleDestroy(g,P){var I,L;(g.isVehicle()||g.isBuilding()||g.isOverlay())&&(I=g.isOverlay()?0:g.rules.minDebris,L=g.isOverlay()?P.rules.general.bridgeVoxelMax:g.rules.maxDebris,0<(L=P.generateRandomInt(I,L))&&this.spawnDebris(g,P,L))}spawnDebris(g,P,L){let _=g.position.getMapPosition();if(P.map.isWithinHardBounds(_)){let U=g.isOverlay()?[]:g.isVehicle()?g.rules.debrisTypes:g.rules.debrisAnims;U.length||(U=P.rules.audioVisual.metallicDebris),U=U.filter(g=>P.rules.hasObject(g,I.ObjectType.VoxelAnim)||P.art.hasObject(g,I.ObjectType.Animation)),new Array(L).fill(0).map(()=>U[P.generateRandomInt(0,U.length-1)]).map(g=>P.createObject(I.ObjectType.Debris,g)).forEach(I=>{I.position.moveToLeptons(_),I.position.tileElevation=g.position.tileElevation,P.spawnObject(I,I.position.tile)})}}},g("SpawnDebrisTrait",G)}}}),System.register("game/gameobject/trait/SpawnLinkTrait",["game/gameobject/task/AttackTask","game/gameobject/task/move/MoveTask","game/gameobject/unit/RangeHelper","game/gameobject/trait/AttackTrait","game/gameobject/trait/interface/NotifyTick"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){V=class{setParent(g){this.parent=g}getParent(){return this.parent}[G.NotifyTick.onTick](g,P){if(this.parent&&g.attackTrait&&g.primaryWeapon){let V=this.parent.attackTrait?.currentTarget,W=g.unitOrderTrait.getCurrentTask(),z=new _.RangeHelper(P.map.tileOccupation);var G=this.parent.armedTrait?.getWeapons().find(g=>g.rules.spawner);g.ammo&&!(V&&g.attackTrait.currentTarget?V.equals(g.attackTrait.currentTarget):V===g.attackTrait.currentTarget||!V&&this.parent.isUnit()&&(this.parent.unitOrderTrait.getCurrentTask()instanceof L.MoveTask||this.parent.unitOrderTrait.getCurrentTask()instanceof I.AttackTask))&&(!V||G&&z.isInWeaponRange(this.parent,V.obj??V.tile,G,P.rules))?V&&g.primaryWeapon.targeting.canTarget(V.obj,V.tile,P,!0,!1)?!W||W instanceof L.MoveTask?(g.unitOrderTrait.cancelAllTasks(),g.unitOrderTrait.addTask(g.attackTrait.createAttackTask(P,V.obj,V.tile,g.primaryWeapon,{force:!0}))):g.attackTrait.attackState!==U.AttackState.Idle&&W.requestTargetUpdate(V):W?W instanceof L.MoveTask||W.cancel():this.tryMoveToParent(g,this.parent,P):this.tryMoveToParent(g,this.parent,P)}}tryMoveToParent(g,P,I){if(g.tile!==P.tile){let _=g.unitOrderTrait.getCurrentTask();_?_ instanceof L.MoveTask&&_.updateTarget(P.tile,!!P.isUnit()&&P.onBridge):g.unitOrderTrait.addTask(new L.MoveTask(I,P.tile,!!P.isUnit()&&P.onBridge,{closeEnoughTiles:0,strictCloseEnough:!0}))}}},g("SpawnLinkTrait",V)}}}),System.register("game/gameobject/trait/SubmergibleTrait",["game/event/ShipSubmergeChangeEvent","game/GameSpeed","game/gameobject/trait/AttackTrait","game/gameobject/trait/interface/NotifyDamage","game/gameobject/trait/interface/NotifyTick"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){V=class{constructor(){this.isActive=!1}isSubmerged(){return this.isActive}setCooldown(g){this.cooldownTicks=g}[G.NotifyTick.onTick](g,P){this.isActive||g.parasiteableTrait?.isInfested()||(g.attackTrait&&g.attackTrait.attackState!==_.AttackState.Idle&&!g.moveTrait.isMoving()?this.cooldownTicks=Math.max(this.cooldownTicks??0,5*L.GameSpeed.BASE_TICKS_PER_SECOND):this.cooldownTicks??(this.cooldownTicks=Math.floor(60*P.rules.general.cloakDelay*L.GameSpeed.BASE_TICKS_PER_SECOND)),0<this.cooldownTicks&&this.cooldownTicks--,this.cooldownTicks<=0&&(this.isActive=!0,P.events.dispatch(new I.ShipSubmergeChangeEvent(g))))}[U.NotifyDamage.onDamage](g,P){this.emerge(g,P)}emerge(g,P){this.isActive&&(this.isActive=!1,this.cooldownTicks=void 0,P.events.dispatch(new I.ShipSubmergeChangeEvent(g)))}},g("SubmergibleTrait",V)}}}),System.register("game/gameobject/trait/SuperWeaponTrait",["engine/type/ObjectType","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyUnspawn"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=class{constructor(g){this.name=g}getSuperWeapon(g){return g.owner.superWeaponsTrait?.get(this.name)}[_.NotifySpawn.onSpawn](g,P){this.addSuperWeaponToPlayerIfNeeded(g.owner,P)}[U.NotifyUnspawn.onUnspawn](g,P){this.removeSuperWeaponFromPlayerIfNeeded(g.owner)}[L.NotifyOwnerChange.onChange](g,P,I){this.removeSuperWeaponFromPlayerIfNeeded(P),this.addSuperWeaponToPlayerIfNeeded(g.owner,I)}addSuperWeaponToPlayerIfNeeded(g,P){if(g.superWeaponsTrait&&!g.superWeaponsTrait.has(this.name)){let I=P.createSuperWeapon(this.name,g);g.superWeaponsTrait.add(I),I.rules.isPowered&&g.powerTrait?.isLowPower()&&I.pauseTimer()}}removeSuperWeaponFromPlayerIfNeeded(g){let P=g.superWeaponsTrait;var L;P&&(g.getOwnedObjectsByType(I.ObjectType.Building).some(g=>g.superWeaponTrait?.name===this.name)||(L=P.get(this.name))&&!L.isGift&&P.remove(this.name))}},g("SuperWeaponTrait",G)}}}),System.register("game/gameobject/trait/SuppressionTrait",["game/gameobject/trait/interface/NotifyTick"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class{constructor(){this.suppressionTicks=0,this.enabled=!0}disable(){this.enabled=!1}isSuppressed(){return this.enabled&&0<this.suppressionTicks}suppress(){this.enabled&&(this.suppressionTicks=30)}[I.NotifyTick.onTick](){0<this.suppressionTicks&&this.suppressionTicks--}},g("SuppressionTrait",L)}}}),System.register("game/gameobject/trait/TemporalTrait",["game/gameobject/common/DeathType","game/gameobject/task/AttackTask","game/gameobject/task/move/MoveTask","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/trait/interface/NotifyTick"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){V=class{constructor(g){this.gameObject=g,this.ticksWhenWarpedOut=!0,this.attackers=new Set}[G.NotifyTick.onTick](g,P){if(g.attackTrait&&(g.attackTrait.currentTarget&&!g.warpedOutTrait.isActive()||this.releaseCurrentTarget(P)),void 0!==this.eraseTicks)for(var L of this.attackers){var _=L.temporalTrait.currentWeapon;if(!_)throw new Error(`Attacker "${L.name}" is no longer targeting "${g.name}"`);var U=_.rules.damage;if(this.eraseTicks-=U,this.eraseTicks<=0){g.deathType=I.DeathType.Temporal,P.destroyObject(g,{player:L.owner,obj:L,weapon:_},!0),this.eraseTicks=void 0;break}}}getTarget(){return this.currentTarget}updateTarget(g,P,I){if(this.currentTarget!==g){this.releaseCurrentTarget(I),this.currentTarget=g,this.currentWeapon=P;var U=g.temporalTrait.attackers.size;if(g.temporalTrait.attackers.add(this.gameObject),!U){g.warpedOutTrait.setActive(!0,!0,I);let P=g.unitOrderTrait.getCurrentTask();(P&&P instanceof L.AttackTask||P instanceof _.MoveTask)&&P.cancel(),g.temporalTrait.eraseTicks=10*g.healthTrait.maxHitPoints}}}releaseCurrentTarget(g){if(this.currentTarget){if(!this.currentTarget.isDisposed){let P=this.currentTarget.temporalTrait.attackers;P.delete(this.gameObject),P.size||(this.currentTarget.warpedOutTrait.expire(g),this.currentTarget.temporalTrait.eraseTicks=void 0)}this.currentTarget=void 0,this.currentWeapon=void 0}}[U.NotifyDestroy.onDestroy](g,P){this.releaseCurrentTarget(P)}dispose(){this.gameObject=void 0,this.attackers.clear()}},g("TemporalTrait",V)}}}),System.register("game/gameobject/trait/TiberiumTrait",["game/type/LandType"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("TiberiumTrait",L=class r{static canBePlacedOn(g,P){return[I.LandType.Clear,I.LandType.Road,I.LandType.Rough].includes(g.landType)&&!P.getGroundObjectsOnTile(g).find(g=>!g.isSmudge()&&!g.isUnit())}constructor(g,P){this.gameObject=g,this.rules=P}getTiberiumType(){return this.rules.type}collectBail(){var g=this.getBailCount();if(g<=0)throw new Error("Attempted to collect an ore bail, but there are none left");return this.gameObject.value--,1<g?this.getTiberiumType():void 0}spawnBails(g){this.gameObject.value=Math.min(r.maxBails,this.gameObject.value+g)}removeBails(g){this.gameObject.value=Math.max(-1,this.gameObject.value-g)}getBailCount(){return this.gameObject.value+1}dispose(){this.gameObject=void 0}}),L.maxBails=11}}}),System.register("game/gameobject/trait/TiberiumTreeTrait",["game/gameobject/trait/interface/NotifyTick","game/map/tileFinder/RadialTileFinder","game/type/LandType","engine/type/ObjectType","game/map/OreSpread","engine/type/TiberiumType","game/gameobject/trait/TiberiumTrait"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g}],execute:function(){var P;(P=z||g("SpawnStatus",z={}))[P.Idle=0]="Idle",P[P.Spawning=1]="Spawning",K=class{constructor(g){this.rules=g,this.ticksSinceLastSpawn=0,this.cooldownTicks=Math.floor(1/this.rules.animationProbability),this.status=z.Idle}[I.NotifyTick.onTick](g,P){this.status=z.Idle,this.ticksSinceLastSpawn++>this.cooldownTicks&&(this.ticksSinceLastSpawn=0,this.status=z.Spawning,this.spawnTiberium(g.tile,P))}spawnTiberium(g,P){for(let q=1;q<=2;q++){let $=new L.RadialTileFinder(P.map.tiles,P.map.mapBounds,g,{width:1,height:1},q,q,g=>W.TiberiumTrait.canBePlacedOn(g,P.map));var I=$.getNextTile();if(I){var z=G.OreSpread.calculateOverlayId(V.TiberiumType.Ore,I);if(void 0===z)throw new Error("Expected an overlayId");let g=P.createObject(U.ObjectType.Overlay,P.rules.getOverlayName(z));return g.overlayId=z,g.value=3,void P.spawnObject(g,I)}let Q;for($=new L.RadialTileFinder(P.map.tiles,P.map.mapBounds,g,{width:1,height:1},q,q,g=>g.landType===_.LandType.Tiberium);!Q;){var K=$.getNextTile();if(!K)break;Q=P.map.getObjectsOnTile(K).find(g=>g.isOverlay()&&g.isTiberium()&&g.traits.get(W.TiberiumTrait).getBailCount()+1<=W.TiberiumTrait.maxBails)}if(Q)return void Q.traits.get(W.TiberiumTrait).spawnBails(1)}}},g("TiberiumTreeTrait",K)}}}),System.register("game/gameobject/trait/TilterTrait",["game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyTileChange"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class{constructor(){this.tilt={pitch:0,yaw:0}}[I.NotifySpawn.onSpawn](g){this.tilt=this.computeTilt(g.tile.rampType)}[L.NotifyTileChange.onTileChange](g){this.tilt=this.computeTilt(g.tile.rampType)}computeTilt(g){let P,I;return 0===g||17<=g?P=I=0:I=g<=4?(P=25,-90*g):(P=25,225-(g-1)%4*90),{pitch:P,yaw:I}}},g("TilterTrait",_)}}}),System.register("game/gameobject/trait/TntChargeTrait",["game/Coords","game/Warhead","game/gameobject/common/DeathType","game/gameobject/unit/CollisionType","game/gameobject/unit/Timer","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/trait/interface/NotifyTick","game/SpecialWarheadType"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g}],execute:function(){K=class{constructor(){this.timer=new G.Timer}hasCharge(){return this.timer.isActive()}setCharge(g,P,I){this.hasCharge()||(this.timer.setActiveFor(g,P),this.attackerInfo=I)}getChargeOwner(){return this.attackerInfo?.player}removeCharge(){this.timer.reset()}getTicksLeft(){return this.timer.getTicksLeft()}getInitialTicks(){return this.timer.getInitialTicks()}[W.NotifyTick.onTick](g,P){this.timer.isActive()&&!0===this.timer.tick(P.currentTick)&&(g.isBuilding()&&g.cabHutTrait&&g.cabHutTrait.demolishBridge(P,this.attackerInfo),this.detonateIvanWarhead(P,g))}[V.NotifyDestroy.onDestroy](g,P,I){!this.timer.isActive()||I?.weapon?.warhead.rules.ivanBomb||[_.DeathType.None,_.DeathType.Temporal,_.DeathType.Sink].includes(g.deathType)||(this.timer.reset(),this.detonateIvanWarhead(P,g))}detonateIvanWarhead(g,P){var _=g.rules.combatDamage.ivanDamage;let G=new L.Warhead(g.rules.getWarhead(g.rules.combatDamage.ivanWarhead));var V=P.tile,W=P.tileElevation,K=P.isUnit()?P.zone:g.map.getTileZone(V),q=!!P.isUnit()&&P.onBridge;G.detonate(g,_,V,W,P.isBuilding()?I.Coords.tile3dToWorld(V.rx+.5,V.ry+.5,V.z+W):P.position.worldPosition,K,q?U.CollisionType.OnBridge:U.CollisionType.None,g.createTarget(P,V),{...this.attackerInfo,weapon:void 0},z.SpecialWarheadType.TntCharge)}},g("TntChargeTrait",K)}}}),System.register("game/gameobject/trait/TransportTrait",["util/math","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/task/ScatterTask","game/event/LeaveTransportEvent","game/gameobject/trait/interface/NotifyTick","game/gameobject/unit/ZoneType","game/gameobject/common/DeathType"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g}],execute:function(){z=class{constructor(g){this.obj=g,this.units=[],this.loadQueue=[]}unitFitsInside(g){return g.rules.size<=this.obj.rules.sizeLimit&&g.rules.size<=this.getAvailableCapacity()}getOccupiedCapacity(){return this.units.reduce((g,P)=>g+P.rules.size,0)}getMaxCapacity(){return this.obj.rules.passengers}getAvailableCapacity(){return this.getMaxCapacity()-this.getOccupiedCapacity()}addToLoadQueue(g){return this.loadQueue.push(g),this.loadQueue.length-1}unitIsFirstInLoadQueue(g){return this.loadQueue[0]===g}removeFromLoadQueue(g){var P=this.loadQueue.indexOf(g);-1!==P&&this.loadQueue.splice(P,1)}[G.NotifyTick.onTick](g,P){this.loadQueue=this.loadQueue.filter(g=>!g.isDestroyed&&!g.isCrashing)}[L.NotifyDestroy.onDestroy](g,P,I,L){var _=!!g.armedTrait?.deathWeapon,U=I?.weapon?.warhead.rules.parasite;if(L||_||g.zone===V.ZoneType.Air||U)for(var G of this.units)_&&G.armedTrait&&(G.armedTrait.deathWeapon=void 0),G.position.tileElevation=g.position.tileElevation,G.zone=g.zone,G.onBridge=g.onBridge,G.position.tile=g.tile,G.deathType=g.deathType,P.destroyObject(G,I,!0);else this.spawnSurvivors(P);this.units=[]}spawnSurvivors(g){var P=this.obj;if(this.units.length){for(var I of this.units)if(0<g.map.terrain.getPassableSpeed(P.tile,I.rules.speedType,I.isInfantry(),P.onBridge)){I.owner.addOwnedObject(I),I.position.tileElevation=P.onBridge?g.map.tileOccupation.getBridgeOnTile(P.tile).tileElevation:0,I.onBridge=P.onBridge,I.zone=g.map.getTileZone(P.tile,!P.onBridge),g.unlimboObject(I,P.tile),I.unitOrderTrait.addTask(new _.ScatterTask(g));const L=g.getUnitSelection();L.isSelected(P)&&L.addToSelection(I)}else I.position.tileElevation=P.position.tileElevation,I.zone=P.zone,I.onBridge=P.onBridge,I.position.tile=P.tile,I.zone===V.ZoneType.Water&&(I.deathType=W.DeathType.Sink),I.armedTrait?.deathWeapon&&(I.armedTrait.deathWeapon=void 0),g.destroyObject(I,{player:I.owner});g.events.dispatch(new U.LeaveTransportEvent(P))}}getHash(){return I.fnv32a(this.units.map(g=>g.getHash()))}debugGetState(){return this.units.map(g=>g.debugGetState())}dispose(){this.obj=void 0}},g("TransportTrait",z)}}}),System.register("game/gameobject/trait/TurretTrait",["game/gameobject/unit/FacingUtil","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifySpawn"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class{constructor(){this.facing=0,this.desiredFacing=0}isRotating(){return this.facing!==this.desiredFacing}[_.NotifySpawn.onSpawn](g){g.isUnit()&&(this.facing=this.desiredFacing=g.direction)}[L.NotifyTick.onTick](g){var P;this.desiredFacing!==this.facing&&(P=g.rules.rot,this.facing=I.FacingUtil.tick(this.facing,this.desiredFacing,P||Number.POSITIVE_INFINITY).facing)}},g("TurretTrait",U)}}}),System.register("game/gameobject/trait/UnitOrderTrait",["game/gameobject/task/system/TaskRunner","game/gameobject/task/system/TaskStatus","game/gameobject/trait/interface/NotifyTick","game/gameobject/task/system/WaitTicksTask","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/task/system/CallbackTask","game/gameobject/trait/interface/NotifyTeleport","game/gameobject/trait/interface/NotifyOrder"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g}],execute:function(){K=class{constructor(g){this.gameObject=g,this.orders=[],this.queuedOrders=new Set,this.tasks=[],this.taskRunner=new I.TaskRunner}[_.NotifyTick.onTick](g,P){if(g.isSpawned){var I=this.hasTasks(),L=this.tasks.find(g=>!g.isCancelling());if(I&&this.taskRunner.tick(this.tasks,g),g.isSpawned){var _,G=this.orders.length;if(G&&(!I||!L)){let P,L=!1;for(;P=this.orders[0];){if(P.isValid()&&P.isAllowed()&&((_=P.process())&&(this.queuedOrders.has(P)&&(this.tasks.push(new U.WaitTicksTask(5)),this.tasks.push(new V.CallbackTask(()=>{g.resetGuardModeToIdle()}))),this.tasks.push(..._),I||this.taskRunner.tick(this.tasks,g)),L=!0),this.orders.shift(),this.queuedOrders.delete(P),!g.isSpawned)return;if(this.waypointPath&&(this.currentWaypoint?(this.cleanupWaypoint(this.currentWaypoint,this.waypointPath),this.currentWaypoint=this.currentWaypoint?.next):this.currentWaypoint=this.waypointPath.waypoints[0],this.currentWaypoint||this.cleanupWaypointPath()),L)break}}!G&&!I&&this.waypointPath&&this.currentWaypoint&&(this.cleanupWaypoint(this.currentWaypoint,this.waypointPath),this.cleanupWaypointPath());let P=L;for(;P?.useChildTargetLines;){var W=P.children.find(g=>!g.isCancelling());if(!W)break;P=W}this.targetLinesTask!==P&&(this.targetLinesTask=P,this.targetLinesConfig=P?.getTargetLinesConfig(this.gameObject))}}}[G.NotifyOwnerChange.onChange](){this.clearOrders(),this.cancelAllTasks()}[W.NotifyTeleport.onBeforeTeleport](g,P,I,L){I&&!L&&(this.clearOrders(),this.tasks.length=0)}addOrder(g,P=!1){!1!==g.onAdd(this.tasks,P)?(P||(this.clearOrders(),this.tasks=this.tasks.filter(g=>g.status!==L.TaskStatus.NotStarted),this.tasks.forEach(g=>g.cancel())),this.orders.push(g),P&&this.queuedOrders.add(g),this.gameObject.traits.filter(z.NotifyOrder).forEach(P=>{P[z.NotifyOrder.onPush](this.gameObject,g.orderType)})):this.targetLinesTask=void 0}clearOrders(){this.orders.length=0,this.queuedOrders.clear(),this.currentWaypoint&&this.waypointPath&&this.cleanupWaypoint(this.currentWaypoint,this.waypointPath),this.cleanupWaypointPath(),this.gameObject.resetGuardModeToIdle()}unmarkNextQueuedOrder(){this.orders.length&&this.queuedOrders.delete(this.orders[0])}hasTasks(){return!!this.tasks.length}isIdle(){return!this.orders.length&&!this.tasks.length}getCurrentTask(){return this.tasks[0]}cancelAllTasks(){this.tasks.forEach(g=>g.cancel())}addTask(g){this.tasks.push(g)}addTasks(...g){g.forEach(g=>this.addTask(g))}addTaskToFront(g){this.tasks.unshift(g)}addTaskNext(g){this.tasks.splice(1,0,g)}getTasks(){return[...this.tasks]}dispose(){this.clearOrders(),this.tasks.length=0,this.gameObject=void 0}cleanupWaypointPath(){this.waypointPath&&(this.waypointPath.units.splice(this.waypointPath.units.indexOf(this.gameObject),1),this.waypointPath.units.length||(this.waypointPath.waypoints.forEach(g=>g.next=void 0),this.waypointPath.waypoints.length=0),this.waypointPath=void 0),this.currentWaypoint=void 0}cleanupWaypoint(g,P){if(!P.units.find(P=>P!==this.gameObject&&(P.unitOrderTrait.currentWaypoint??P.unitOrderTrait.waypointPath?.waypoints[0])===g)&&!P.waypoints.find(P=>P.next===g)){var I=P.waypoints.indexOf(g);if(-1===I)throw new Error("Given waypoint not found in waypoint path");P.waypoints.splice(I,1)}}},g("UnitOrderTrait",K)}}}),System.register("game/gameobject/trait/UnitReloadTrait",["game/GameSpeed","game/gameobject/unit/ZoneType","game/gameobject/trait/interface/NotifyTick"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class{[_.NotifyTick.onTick](g,P){if(g.dockTrait&&g.dockTrait.hasDockedUnits()&&!g.dockTrait.getDockedUnits().every(g=>!this.canReloadUnit(g)))if(void 0===this.cooldownTicks&&(this.cooldownTicks=I.GameSpeed.BASE_TICKS_PER_SECOND*P.rules.general.repair.reloadRate*60),this.cooldownTicks<=0){this.cooldownTicks=I.GameSpeed.BASE_TICKS_PER_SECOND*P.rules.general.repair.reloadRate*60;let _=g.dockTrait.getDockedUnits();var L;for(L of 0===_[0].ammo?_.slice(0,1):_)this.canReloadUnit(L)&&L.ammoTrait.ammo++}else this.cooldownTicks--}canReloadUnit(g){return!(!g.ammoTrait||!g.rules.manualReload||g.ammoTrait.isFull()||g.zone===L.ZoneType.Air)}},g("UnitReloadTrait",U)}}}),System.register("game/gameobject/trait/UnitRepairTrait",["game/event/UnitRepairFinishEvent","game/event/UnitRepairStartEvent","game/GameSpeed","game/math/Vector2","game/gameobject/task/move/MoveTask","game/gameobject/unit/ZoneType","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyTick"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g}],execute:function(){var P;(P=K||g("RepairStatus",K={}))[P.Idle=0]="Idle",P[P.Repairing=1]="Repairing",q=class{constructor(){this.status=K.Idle,this.cooldownTicks=0,this.lastRepairTickSuccessful=!1}[W.NotifySpawn.onSpawn](g,P){this.resetRallyPoint(g,P)}resetRallyPoint(g,P){var I;g.factoryTrait||(I=this.computeDefaultRallyPoint(g,P.map),g.rallyTrait.changeRallyPoint(I,g,P))}[z.NotifyTick.onTick](g,P){if(g.dockTrait&&(!g.rules.needsEngineer||!g.owner.isNeutral))if(!g.dockTrait.hasDockedUnits()||g.dockTrait.getDockedUnits().some(g=>g.zone===V.ZoneType.Air)||g.poweredTrait&&!g.poweredTrait.isPoweredOn())this.status=K.Idle;else if(this.cooldownTicks<=0){var U,W,z=P.rules.general.repair;z=g.rules.unitReload?z.reloadRate:z.uRepairRate;this.cooldownTicks+=_.GameSpeed.BASE_TICKS_PER_SECOND*z*60;let q=!1;for(U of g.dockTrait.getDockedUnits())U.zone!==V.ZoneType.Air&&(U.healthTrait.health<100&&P.areFriendly(U,g)?(this.tickRepair(U,P,g)&&(q=!0),!q||this.status!==K.Idle&&this.lastRepairTickSuccessful||g.helipadTrait||P.events.dispatch(new L.UnitRepairStartEvent(U))):((W=g.rallyTrait.findRallyNodeForUnit(U,P.map))&&(g.dockTrait.undockUnit(U),U.unitOrderTrait.addTask(new G.MoveTask(P,W.tile,!!W.onBridge,{closeEnoughTiles:P.rules.general.closeEnough}))),g.helipadTrait||P.events.dispatch(new I.UnitRepairFinishEvent(U,g))));this.lastRepairTickSuccessful=q,this.status=q?K.Repairing:K.Idle}else this.cooldownTicks--}tickRepair(g,P,I){var L=P.rules.general.repair,_=Math.floor(L.repairStep),U=L.repairPercent;let G;if(U){if(L=U*g.purchaseValue/g.healthTrait.maxHitPoints,U=Math.min(g.owner.credits,Math.max(1,Math.floor(L*_))),G=L&&U?Math.floor(U/L):_,!U)return!1;g.owner.credits-=U}else G=_;return G=Math.min(G,g.healthTrait.maxHitPoints-g.healthTrait.getHitPoints()),!!G&&(g.healthTrait.healBy(G,I,P),!0)}computeDefaultRallyPoint(g,P){var I=g.getFoundation();I=new U.Vector2(g.tile.rx,g.tile.ry+I.height);return P.tiles.getByMapCoords(I.x,I.y)??g.tile}},g("UnitRepairTrait",q)}}}),System.register("game/gameobject/trait/UnlandableTrait",["game/math/Vector2","util/bresenham","util/typeGuard","game/gameobject/task/move/MoveTask","game/gameobject/task/system/CallbackTask","game/gameobject/task/system/TaskGroup","game/gameobject/trait/interface/NotifyTick"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g}],execute:function(){z=class{constructor(){this.enabled=!0}setEnabled(g){this.enabled=g}[W.NotifyTick.onTick](g,P){var I;this.enabled&&(g.owner.isNeutral||g.name===P.rules.general.paradrop.paradropPlane)&&g.unitOrderTrait.isIdle()&&(I=this.chooseExitTile(g.tile,P),g.unitOrderTrait.addTask(new V.TaskGroup(new U.MoveTask(P,I,!1,{allowOutOfBoundsTarget:!0}),new G.CallbackTask(g=>P.unspawnObject(g))).setCancellable(!1)))}chooseExitTile(g,P){var U=P.map.tiles.getMapSize(),G=.5<P.generateRandom()?new I.Vector2(Math.floor(U.width/2),0):new I.Vector2(0,Math.floor(U.height/2));U=new I.Vector2(g.rx,g.ry),G=L.bresenham(U.x,U.y,G.x,G.y).map(g=>P.map.tiles.getByMapCoords(g.x,g.y)).filter(_.isNotNullOrUndefined);if(!G.length)throw new Error("No valid exit tile found");return G[G.length-1]}},g("UnlandableTrait",z)}}}),System.register("game/gameobject/trait/VeteranTrait",["game/gameobject/unit/VeteranLevel","game/trait/interface/NotifyTargetDestroy","game/event/UnitPromoteEvent","game/gameobject/unit/VeteranAbility","game/gameobject/trait/SelfHealingTrait","game/gameobject/trait/CloakableTrait","game/gameobject/trait/ArmedTrait","game/gameobject/trait/SensorsTrait"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g}],execute:function(){K=class{constructor(g,P){this.gameObject=g,this.veteranRules=P,this.veteranLevel=I.VeteranLevel.None,this.xp=0,this.promotionThresh=g.rules.cost*P.veteranRatio+1}[L.NotifyTargetDestroy.onDestroy](g,P,I,L){g.isDestroyed&&!g.isCrashing||P.isTechno()&&(P.rules.dontScore||P.rules.insignificant||(I&&(I.warhead.rules.temporal||I.warhead.rules.parasite&&g.rules.organic)||!L.areFriendly(g,P))&&(this.veteranLevel>=this.veteranRules.veteranCap||this.gainXP(P.rules.cost*(P.veteranLevel+1))&&this.handlePromotion(g,L)))}setRelativeXP(g){this.gainXP(Math.floor(g*this.promotionThresh))}gainXP(g){if(this.xp+=g,this.xp>=this.promotionThresh){var P=Math.min(this.veteranLevel+Math.floor(this.xp/this.promotionThresh),this.veteranRules.veteranCap),I=P-this.veteranLevel;if(I)return this.xp-=I*this.promotionThresh,this.setVeteranLevel(P),!0}return!1}promote(g,P){var I=Math.min(this.veteranLevel+g,this.veteranRules.veteranCap);I-this.veteranLevel&&(this.setVeteranLevel(I),this.handlePromotion(this.gameObject,P))}isMaxLevel(){return this.veteranLevel===this.veteranRules.veteranCap}isElite(){return this.veteranLevel===I.VeteranLevel.Elite}setVeteranLevel(g){this.veteranLevel=g,this.veteranLevel===I.VeteranLevel.Elite&&this.gameObject.armedTrait?.toggleEliteWeapons(!0)}handlePromotion(g,P){this.hasVeteranAbility(U.VeteranAbility.SELF_HEAL)&&(g.traits.find(G.SelfHealingTrait)||P.addObjectTrait(g,new G.SelfHealingTrait)),this.hasVeteranAbility(U.VeteranAbility.CLOAK)&&(g.cloakableTrait||(g.cloakableTrait=new V.CloakableTrait(g,P.rules.general.cloakDelay),P.addObjectTrait(g,g.cloakableTrait))),this.hasVeteranAbility(U.VeteranAbility.EXPLODES)&&(g.explodes||(g.explodes=!0,g.armedTrait||(g.armedTrait=new W.ArmedTrait(g,P.rules),P.addObjectTrait(g,g.armedTrait)))),this.hasVeteranAbility(U.VeteranAbility.RADAR_INVISIBLE)&&(g.radarInvisible||(g.radarInvisible=!0)),this.hasVeteranAbility(U.VeteranAbility.SENSORS)&&(g.sensorsTrait||(g.sensorsTrait=new z.SensorsTrait,P.addObjectTrait(g,g.sensorsTrait))),g.isInfantry()&&this.hasVeteranAbility(U.VeteranAbility.FEARLESS)&&g.suppressionTrait?.disable(),this.hasVeteranAbility(U.VeteranAbility.C4)&&(g.c4||(g.c4=!0)),this.hasVeteranAbility(U.VeteranAbility.GUARD_AREA)&&(g.defaultToGuardArea||(g.defaultToGuardArea=!0,g.unitOrderTrait.isIdle()&&g.resetGuardModeToIdle())),this.hasVeteranAbility(U.VeteranAbility.CRUSHER)&&(g.crusher||(g.crusher=!0)),P.events.dispatch(new _.UnitPromoteEvent(g))}getVeteranSightMultiplier(){return this.getVeteranAbilityMultiplier(U.VeteranAbility.SIGHT)}getVeteranSpeedMultiplier(){return this.getVeteranAbilityMultiplier(U.VeteranAbility.FASTER)}getVeteranArmorMultiplier(){return this.getVeteranAbilityMultiplier(U.VeteranAbility.STRONGER)}getVeteranDamageMultiplier(){return this.getVeteranAbilityMultiplier(U.VeteranAbility.FIREPOWER)}getVeteranRofMultiplier(){return this.getVeteranAbilityMultiplier(U.VeteranAbility.ROF)}hasVeteranAbility(g){return this.veteranLevel===I.VeteranLevel.Veteran&&this.gameObject.rules.veteranAbilities.has(g)||this.veteranLevel>=I.VeteranLevel.Elite&&this.gameObject.rules.eliteAbilities.has(g)}getVeteranAbilityMultiplier(g){let P=1;return(this.veteranLevel===I.VeteranLevel.Veteran&&this.gameObject.rules.veteranAbilities.has(g)||this.veteranLevel>=I.VeteranLevel.Elite&&this.gameObject.rules.eliteAbilities.has(g))&&(P=this.getVeteranRulesMultiplier(g)),P}getVeteranRulesMultiplier(g){switch(g){case U.VeteranAbility.FASTER:return this.veteranRules.veteranSpeed;case U.VeteranAbility.STRONGER:return this.veteranRules.veteranArmor;case U.VeteranAbility.FIREPOWER:return this.veteranRules.veteranCombat;case U.VeteranAbility.ROF:return this.veteranRules.veteranROF;case U.VeteranAbility.SIGHT:return this.veteranRules.veteranSight;default:throw new Error("Unhandled VeteranAbility "+g)}}dispose(){this.gameObject=void 0}},g("VeteranTrait",K)}}}),System.register("game/gameobject/trait/WallTrait",["game/gameobject/trait/interface/NotifyDamage","game/type/LandType","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyUnspawn","game/map/tileFinder/CardinalTileFinder","game/map/wallTypes"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){W=class{constructor(){this.linkedDamageHandled=!1,this.wallType=0}[_.NotifySpawn.onSpawn](g,P){g.isBuilding()?this.connectWall(g,P.map):this.wallType=g.value}[U.NotifyUnspawn.onUnspawn](g,P){this.updateAdjacentWalls(g,P.map)}[I.NotifyDamage.onDamage](g,P,I,_){if(!this.linkedDamageHandled){var U=Math.floor(I/2);if(U)for(var G of P.map.tiles.getAllNeighbourTiles(g.tile))if(G.landType===L.LandType.Wall){let g=P.map.getObjectsOnTile(G).find(g=>(g.isBuilding()||g.isOverlay())&&g.wallTrait);g.wallTrait.linkedDamageHandled=!0,g.healthTrait.inflictDamage(U,_,P),g.wallTrait.linkedDamageHandled=!1,g.healthTrait.health||P.destroyObject(g,_)}}}updateAdjacentWalls(g,P){let I=new G.CardinalTileFinder(P.tiles,P.mapBounds,g.tile,1,1);for(I.diagonal=!1;L=I.getNextTile();){var L=P.getObjectsOnTile(L).find(P=>(P.isBuilding()||P.isOverlay())&&P.name===g.rules.name);L&&this.connectWall(L,P)}}connectWall(g,P){let I=this.getAdjacentWallData(g.tile,g.name,P);this.updateWallType(g,I.map(g=>g.direction)),I.forEach(g=>{let I=this.getAdjacentWallData(g.tile,g.wall.name,P);this.updateWallType(g.wall,I.map(g=>g.direction))})}updateWallType(g,P){let I=[0,0,0,0];for(var L of P)0===L[0]&&-1===L[1]&&(I[0]=1),1===L[0]&&0===L[1]&&(I[1]=1),0===L[0]&&1===L[1]&&(I[2]=1),-1===L[0]&&0===L[1]&&(I[3]=1);var _=this.findWallType(I);g.wallTrait.wallType=_,g.isOverlay()&&(g.value=_)}findWallType(g){for(let I=0;I<V.wallTypes.length;++I){var P=V.wallTypes[I];if(P[0]===g[0]&&P[1]===g[1]&&P[2]===g[2]&&P[3]===g[3])return I}return console.warn("Invalid wall directions",g),0}getAdjacentWallData(g,P,I){var L;let _=[];for(L of[[0,1],[0,-1],[1,0],[-1,0]]){var U={x:g.rx+L[0],y:g.ry+L[1]},G=I.tiles.getByMapCoords(U.x,U.y);G&&(U=I.getObjectsOnTile(G).find(g=>(g.isBuilding()||g.isOverlay())&&g.name===P))&&_.push({direction:L,tile:G,wall:U})}return _}},g("WallTrait",W)}}}),System.register("game/gameobject/trait/WarpedOutTrait",["game/gameobject/trait/interface/NotifyWarpChange","game/trait/interface/NotifyWarpChange","game/gameobject/trait/interface/NotifyTick"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class{constructor(g){this.gameObject=g,this.ticksWhenWarpedOut=!0,this.remainingTicks=0,this.invulnerable=!1}isActive(){return 0<this.remainingTicks}setActive(g,P,I){this.remainingTicks=g?Number.POSITIVE_INFINITY:0,this.invulnerable=P,this.notifyChange(g,I)}setTimed(g,P,I){this.remainingTicks=g,this.invulnerable=P,this.notifyChange(!0,I)}debugSetActive(g){this.remainingTicks=g?Number.POSITIVE_INFINITY:0}notifyChange(g,P){P.traits.filter(L.NotifyWarpChange).forEach(I=>{I[L.NotifyWarpChange.onChange](this.gameObject,P,g)}),this.gameObject.traits.filter(I.NotifyWarpChange).forEach(L=>{L[I.NotifyWarpChange.onChange](this.gameObject,P,g)})}expire(g){this.remainingTicks=0,this.notifyChange(!1,g)}isInvulnerable(){return this.isActive()&&this.invulnerable}[_.NotifyTick.onTick](g,P){0<this.remainingTicks&&(this.remainingTicks--,this.remainingTicks<=0&&this.notifyChange(!1,P))}dispose(){this.gameObject=void 0}},g("WarpedOutTrait",U)}}}),System.register("game/gameobject/Unit",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("game/gameobject/unit/CollisionHelper",["engine/type/TerrainType","game/type/LandType","game/gameobject/unit/CollisionType","game/gameobject/unit/ZoneType"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("CollisionHelper",class{constructor(g){this.tileOccupation=g}checkCollisions(g,P,I){var G,V=g.tile;let W,z,K;for(G of this.tileOccupation.getObjectsOnTile(V))G.isOverlay()&&G.isBridge()&&(W=G),G.isOverlay()&&G.wallTrait&&(K=G),G.isTechno()&&!G.isDestroyed&&(z=G);if(I.walls){if(g.tileElevation<=2&&V.landType===L.LandType.Wall)return{type:_.CollisionType.Wall,target:K};if(I.units&&z?.tile===V&&(!z.isUnit()||z.zone===U.ZoneType.Ground)&&g.tileElevation<=1.1&&I.units(z.owner))return{type:_.CollisionType.Wall,target:z}}if(I.shore&&V.landType!==L.LandType.Water)return{type:_.CollisionType.Shore};if(I.ground&&g.tileElevation<0)return{type:_.CollisionType.Ground};var q=g.tileElevation+V.z,$=P.tileElevation+P.tile.z;if(W?.isHighBridge()){var Q=W.tile.z+W.tileElevation;if(Q<$&&q<=Q||$<Q&&Q-1<=q)return $<Q?{type:_.CollisionType.UnderBridge,target:W}:{type:_.CollisionType.OnBridge,target:W}}else if(W?.isLowBridge()&&I.shore)return{type:_.CollisionType.UnderBridge,target:W};return I.cliffs&&(V=V.z-P.tile.z,g.tileElevation<0&&4<=V)?{type:_.CollisionType.Cliff}:{type:_.CollisionType.None}}computeDetonationZone(g,P,L){let G=this.tileOccupation.getBridgeOnTile(g);return L===_.CollisionType.None&&P>1.5+(G?.tileElevation??0)?U.ZoneType.Air:G&&1.5<P||g.terrainType!==I.TerrainType.Water||G?.isLowBridge()?U.ZoneType.Ground:U.ZoneType.Water}})}}}),System.register("game/gameobject/unit/CollisionType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("CollisionType",I={}))[P.None=0]="None",P[P.Ground=1]="Ground",P[P.Wall=2]="Wall",P[P.Cliff=3]="Cliff",P[P.OnBridge=4]="OnBridge",P[P.UnderBridge=5]="UnderBridge",P[P.Shore=6]="Shore"}}}),System.register("game/gameobject/unit/CrateBonuses",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("CrateBonuses",class{constructor(){this.firepower=1,this.armor=1,this.speed=1}})}}}),System.register("game/gameobject/unit/FacingUtil",["game/math/Vector2","game/math/geometry"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("FacingUtil",class s{static tick(g,P,I){if(g===P)return{facing:g,delta:0};var L=(g-P+360)%360,_=(P-g+360)%360;return Math.min(L,_)<I?{facing:P,delta:0}:{facing:(g+(L=(_<=L?1:-1)*I)+360)%360,delta:L}}static fromMapCoords(g){return(-L.angleDegFromVec2(g)-90+720)%360}static toMapCoords(g){return L.rotateVec2(new I.Vector2(1e3,0),s.toWorldDeg(g)).round().normalize()}static toWorldDeg(g){return-(g+90)}})}}}),System.register("game/gameobject/unit/HealthLevel",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("HealthLevel",I={}))[P.Green=0]="Green",P[P.Yellow=1]="Yellow",P[P.Red=2]="Red"}}}),System.register("game/gameobject/unit/LosHelper",["util/bresenham","game/type/LandType"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=g=>void 0!==g.position,g("LosHelper",class{constructor(g,P){this.tiles=g,this.tileOccupation=P}hasLineOfSight(g,P,U){var G=U.warhead.rules.wall||!U.projectileRules.subjectToWalls,V=U.projectileRules.subjectToCliffs,W=U.rules.spawner;let z=0,K=!1;if(!G||V||W){var q,$,Q=_(g)?g.tile:g,Y=_(P)?P.isBuilding()?P.centerTile:P.tile:P;let U=Q.z;for({x:q,y:$}of(V&&_(g)&&g.isUnit()&&g.onBridge&&(U+=this.tileOccupation.getBridgeOnTile(Q)?.tileElevation??0),I.bresenham(Q.rx,Q.ry,Y.rx,Y.ry))){var Z=this.tiles.getByMapCoords(q,$);if(!Z)return!1;if(!G&&Z.landType===L.LandType.Wall)return!1;if(V)if(Z.landType===L.LandType.Cliff){if(Z.z>U)return!1;K=!0}else{if(Z.z>U&&K)return!1;K=!1}if(W&&z<2&&this.tileOccupation.getBridgeOnTile(Z)?.isHighBridge())return!1;z++}}return!0}})}}}),System.register("game/gameobject/unit/MovePositionHelper",["game/map/tileFinder/RadialTileFinder","game/type/MovementZone","game/type/SpeedType","game/type/LocomotorType"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("MovePositionHelper",class{constructor(g){this.map=g}findPositions(g,P,U,G){let V=new Map,W=this.clusterObjects(g);if(!W.length)throw new Error("We should have found at least one cluster");let z=W.reduce((g,P)=>P.objects.size>g.objects.size?P:g,W[0]);W.splice(W.indexOf(z),1);let K=[],q=this.findCenterTile([...z.objects]);z.objects.forEach(g=>{var I=this.map.tiles.getByMapCoords(P.rx+g.tile.rx-q.rx,P.ry+g.tile.ry-q.ry),W=I?.onBridgeLandType?this.map.tileOccupation.getBridgeOnTile(I):void 0;if(!this.shouldStackObject(g)&&I&&this.map.mapBounds.isWithinBounds(I)&&this.tileHasRoom(I,g,V.get(I))&&(g.rules.movementZone===L.MovementZone.Fly?g.rules.airportBound||G&&g.rules.balloonHover&&!g.rules.hoverAttack||this.map.terrain.getPassableSpeed(I,_.SpeedType.Amphibious,!1,!!W):this.isEligibleTile(I,W,U,P))){let P=V.get(I);void 0===P&&(P=[],V.set(I,P)),P.push(g)}else K.push(g)}),W.forEach(g=>K.push(...g.objects));let $=new I.RadialTileFinder(this.map.tiles,this.map.mapBounds,P,{width:1,height:1},0,5,()=>!0),Q=$.getNextTile();for(;K.length&&Q;){var Y=K[0],Z=this.map.tileOccupation.getBridgeOnTile(Q);if(this.tileHasRoom(Q,Y,V.get(Q))&&(Y.rules.movementZone===L.MovementZone.Fly?Y.rules.airportBound||this.map.terrain.getPassableSpeed(Q,_.SpeedType.Amphibious,!1,!!Z):this.isEligibleTile(Q,Z,U,P))){let g=V.get(Q);void 0===g&&(g=[],V.set(Q,g)),g.push(K.shift())}else Q=$.getNextTile()}let X=new Map;if(V.forEach((g,P)=>{g.forEach(g=>X.set(g,P))}),K.forEach(g=>X.set(g,P)),X.size!==g.length)throw new Error("We should have computed a number of positions equal to the number of input objects");return X}shouldStackObject(g){return g.isBuilding()||g.isUnit()&&g.moveTrait.isMoving()&&g.rules.movementZone===L.MovementZone.Fly&&g.rules.locomotor===U.LocomotorType.Jumpjet}tileHasRoom(g,P,I){if(P.isBuilding())return!!P.rules.undeploysInto||!this.map.tileOccupation.getGroundObjectsOnTile(g).some(g=>g.isTerrain()||g.isTechno()||g.isOverlay()&&g.wallTrait);if(!I)return!0;if(this.shouldStackObject(P))return I.length<3;if(P.isInfantry()){if(I.find(g=>!g.isInfantry()))return!1;var _=P.rules.movementZone===L.MovementZone.Fly?1:3;return!(I.filter(g=>g.isInfantry()).length>=_)}return!I.length}isEligibleTile(g,P,I,L){return I?.isHighBridge()||P?.isHighBridge()?g.z+(P?.tileElevation??0)===L.z+(I?.tileElevation??0):!(!I&&!P)||Math.abs(g.z-L.z)<2}clusterObjects(g){let P=new Map;g.forEach(g=>{var I=g.tile.rx+"_"+g.tile.ry;P.set(I,[...P.get(I)||[],g])});let I=[],L=new Set(g);for(;L.size;){let g=new Set,G=[];var _=[...L][0].tile;for(P.get(_.rx+"_"+_.ry).forEach(g=>{G.push(g)});G.length;){var U=G.shift();g.add(U),L.delete(U);for(let g=-1;g<=1;g++)for(let I=-1;I<=1;I++)if(g||I){let _=P.get(U.tile.rx+g+"_"+(U.tile.ry+I));_&&_.length&&_.forEach(g=>{L.has(g)&&(L.delete(g),G.push(g))})}}I.push({objects:g})}return I}findCenterTile(g){let P=0,I=0;g.forEach(g=>{P+=g.tile.rx,I+=g.tile.ry}),P=Math.round(P/g.length),I=Math.round(I/g.length);let L=this.map.tiles.getByMapCoords(P,I);if(!L&&(L=g.find(g=>Math.abs(g.tile.rx-P)<=1&&Math.abs(g.tile.ry-I)<=1)?.tile,!L))throw new Error("At least one adjacent object should have been found");return L}})}}}),System.register("game/gameobject/unit/RangeHelper",["game/Coords","util/math","game/gameobject/unit/ZoneType","game/type/MovementZone","game/math/Vector2"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){V=g=>void 0!==g.position,W=g=>void 0!==g.addScalar,g("RangeHelper",class{constructor(g){this.tileOccupation=g}isInWeaponRange(g,P,I,L,_){var G=_??g;if(I.rules.limboLaunch&&2<Math.abs((V(G)?G.position.tileElevation+G.tile.z:G.z)-(V(P)?P.position.tileElevation+P.tile.z:P.z)))return!1;var{minRange:W,range:z}=this.computeWeaponRangeVsTarget(G,P,I,L);return I.rules.cellRangefinding?this.isInTileRange(G,P,W,z):g.isUnit()&&g.rules.movementZone===U.MovementZone.Fly?this.isInRange2(G,P,W,z):this.isInRange3(G,P,W,z)}computeWeaponRangeVsTarget(g,P,I,L){let U=0;var G,W;return V(P)&&P.isBuilding()&&!I.projectileRules.arcing&&!I.projectileRules.vertical&&(W=P.getFoundation(),I.warhead.rules.ivanBomb&&2<W.width+W.height||(U+=(W.width+W.height)/4)),!I.projectileRules.subjectToElevation||I.projectileRules.arcing&&!V(P)||(G=V(g)?g.tile.z+g.tileElevation:g.z,(W=V(P)?P.tile.z+P.tileElevation:P.z)<G&&(U+=L.elevationModel.getBonus(G,W))),I.projectileRules.isAntiAir&&V(g)&&g.isTechno()&&V(P)&&P.isUnit()&&P.zone===_.ZoneType.Air&&(U+=g.rules.airRangeBonus),{minRange:I.minRange,range:I.range+U}}isInRange(g,P,I,L,_=!1){return _?this.isInTileRange(g,P,I,L):g.isUnit()&&g.rules.movementZone===U.MovementZone.Fly?this.isInRange2(g,P,I,L):this.isInRange3(g,P,I,L)}isInRange3(g,P,_,U){return L.isBetween(this.distance3(g,P)/I.Coords.LEPTONS_PER_TILE,_,U)}isInRange2(g,P,_,U){return L.isBetween(this.distance2(g,P)/I.Coords.LEPTONS_PER_TILE,_,U)}distance3(g,P){let L=V(g)?g.position.worldPosition:W(g)?g:I.Coords.tile3dToWorld(g.rx+.5,g.ry+.5,g.z);var _=V(P)?P.position.worldPosition:W(P)?P:I.Coords.tile3dToWorld(P.rx+.5,P.ry+.5,P.z);return L.distanceTo(_)}distance2(g,P){let L=V(g)?new G.Vector2(g.position.worldPosition.x,g.position.worldPosition.z):W(g)?new G.Vector2(g.x,g.z):new G.Vector2(g.rx+.5,g.ry+.5).multiplyScalar(I.Coords.LEPTONS_PER_TILE);var _=V(P)?new G.Vector2(P.position.worldPosition.x,P.position.worldPosition.z):W(P)?new G.Vector2(P.x,P.z):new G.Vector2(P.rx+.5,P.ry+.5).multiplyScalar(I.Coords.LEPTONS_PER_TILE);return L.distanceTo(_)}isInTileRange(g,P,_,U){let W;var z;return W=!Array.isArray(g)&&V(P)&&P.isUnit()?(z=V(g)?g.tile:g,new G.Vector2(z.rx+.5,z.ry+.5).distanceTo(P.position.getMapPosition().multiplyScalar(1/I.Coords.LEPTONS_PER_TILE))):this.tileDistance(g,P),L.isBetween(W,_,U)}tileDistance(g,P){var I,L=V(g)?this.tileOccupation.calculateTilesForGameObject(g.tile,g):Array.isArray(g)?g:[g],_=V(P)?this.tileOccupation.calculateTilesForGameObject(P.tile,P):Array.isArray(P)?P:[P];let U=new G.Vector2,W=new G.Vector2,z=Number.POSITIVE_INFINITY;for(I of L)for(var K of _)U.set(I.rx,I.ry),W.set(K.rx,K.ry),(K=U.distanceTo(W))<=z&&(z=K);return z}})}}}),System.register("game/gameobject/unit/ScatterPositionHelper",["game/gameobject/unit/MovePositionHelper","game/map/tileFinder/RandomTileFinder"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("ScatterPositionHelper",class{constructor(g){this.game=g,this.movePositionHelper=new I.MovePositionHelper(g.map)}findPositions(g,P){let I=new Set,L=new Map;for(var _ of g){var U=this.findFreeMovePosition(_,I,P);U&&(L.set(_,U),I.add(U.tile))}return L}findFreeMovePosition(g,P,{ignoredBlockers:I,excludedTiles:_,noSlopes:U}={}){let G,V,W=this.game.map,z=g.onBridge?W.tileOccupation.getBridgeOnTile(g.tile):void 0,K=new L.RandomTileFinder(W.tiles,W.mapBounds,g.tile,1,this.game,P=>{if(_?.includes(P))return!1;var I=W.tileOccupation.getBridgeOnTile(P);return(I&&this.movePositionHelper.isEligibleTile(P,I,z,g.tile)||this.movePositionHelper.isEligibleTile(P,void 0,z,g.tile))&&(!U||0===P.rampType)});for(;;){var q=K.getNextTile();if(!q)break;if(G=q,V=W.tileOccupation.getBridgeOnTile(q),V&&!this.movePositionHelper.isEligibleTile(q,V,z,g.tile)&&(V=void 0),!P.has(q)){let P=W.terrain.findObstacles({tile:q,onBridge:V},g);if(I&&I.length&&(P=P.filter(g=>!I.includes(g.obj))),!P.length)break}}if(G)return{tile:G,onBridge:V}}})}}}),System.register("game/gameobject/unit/TargetUtil",["game/math/Vector3","game/math/geometry","game/math/GameMath"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("TargetUtil",class{static computeInterceptPoint(g,P,L,U){let G=g.clone().sub(L);var V,W=P*P-(V=U.length())*V,z=2*G.dot(U);return z*z-4*W*(V=-G.dot(G))<0?new I.Vector3:(W=(-z+_.GameMath.sqrt(z*z-4*W*V))/(2*W),U.clone().multiplyScalar(W).add(L))}static computeTurnCircle(g,P,I,_){var U=_/L.degToRad(Math.abs(I));let G=L.rotateVec2(P.clone(),90*-Math.sign(I));return{center:isFinite(U)?G.setLength(U).add(g):g.clone(),radius:U}}})}}}),System.register("game/gameobject/unit/Timer",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("Timer",class{constructor(){this.activeTicks=0}isActive(){return 0<this.activeTicks}setActiveFor(g,P){this.activeTicks=g,this.activeFor=g,this.activeSince=P}reset(){this.activeTicks=0,this.activeSince=void 0,this.activeFor=void 0}getTicksLeft(){return this.activeTicks}getInitialTicks(){return this.activeFor??0}tick(g){return 0<this.activeTicks&&(this.activeTicks--,this.activeTicks<=0||void 0!==this.activeSince&&g-this.activeSince>this.activeFor)&&(this.reset(),!0)}})}}}),System.register("game/gameobject/unit/VeteranAbility",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("VeteranAbility",I={}))[P.FASTER=0]="FASTER",P[P.STRONGER=1]="STRONGER",P[P.FIREPOWER=2]="FIREPOWER",P[P.SCATTER=3]="SCATTER",P[P.ROF=4]="ROF",P[P.SIGHT=5]="SIGHT",P[P.SELF_HEAL=6]="SELF_HEAL",P[P.CLOAK=7]="CLOAK",P[P.EXPLODES=8]="EXPLODES",P[P.RADAR_INVISIBLE=9]="RADAR_INVISIBLE",P[P.SENSORS=10]="SENSORS",P[P.FEARLESS=11]="FEARLESS",P[P.C4=12]="C4",P[P.GUARD_AREA=13]="GUARD_AREA",P[P.CRUSHER=14]="CRUSHER"}}}),System.register("game/gameobject/unit/VeteranLevel",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("VeteranLevel",I={}))[P.None=0]="None",P[P.Veteran=1]="Veteran",P[P.Elite=2]="Elite"}}}),System.register("game/gameobject/unit/ZoneType",["game/type/LandType"],function(g,P){"use strict";var I,L;return P&&P.id,g("getZoneType",function(g){return[I.LandType.Water,I.LandType.Beach].includes(g)?L.Water:L.Ground}),{setters:[function(g){I=g}],execute:function(){var P;(P=L||g("ZoneType",L={}))[P.Ground=0]="Ground",P[P.Air=1]="Air",P[P.Water=2]="Water"}}}),System.register("game/gameobject/Vehicle",["engine/type/ObjectType","game/gameobject/trait/HarvesterTrait","game/gameobject/trait/TransportTrait","game/gameobject/trait/MoveTrait","game/gameobject/trait/TurretTrait","game/gameobject/unit/ZoneType","game/gameobject/trait/DockableTrait","game/gameobject/Techno","game/gameobject/trait/CrewedTrait","game/gameobject/trait/GunnerTrait","game/gameobject/trait/ParasiteableTrait","game/gameobject/trait/CrashableTrait","game/gameobject/trait/SubmergibleTrait","game/type/LocomotorType","game/gameobject/trait/HoverBobTrait","game/gameobject/unit/CrateBonuses","game/gameobject/trait/TilterTrait"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g}],execute:function(){g("ROCKING_TICKS",34),te=class extends z.Techno{get isMoving(){return this.moveTrait.isMoving()}static factory(g,P,I,V,z){let J=new this(g,P,I);return J.isSinker=!P.underwater&&(P.weight>=V.general.shipSinkingWeight||!P.naval),J.moveTrait=new U.MoveTrait(J,z),J.traits.add(J.moveTrait),P.crashable&&(J.crashableTrait=new Q.CrashableTrait(J),J.traits.add(J.crashableTrait)),P.crewed&&(J.crewedTrait=new K.CrewedTrait,J.traits.add(J.crewedTrait)),P.harvester&&(J.harvesterTrait=new L.HarvesterTrait(P.storage),J.traits.add(J.harvesterTrait)),P.passengers&&(J.transportTrait=new _.TransportTrait(J),J.traits.add(J.transportTrait),P.gunner&&(J.gunnerTrait=new q.GunnerTrait,J.traits.add(J.gunnerTrait))),P.turret&&(J.turretTrait=new G.TurretTrait,J.traits.add(J.turretTrait)),P.consideredAircraft&&!P.landable||J.traits.add(new W.DockableTrait),P.parasiteable&&(J.parasiteableTrait=new $.ParasiteableTrait(J),J.traits.add(J.parasiteableTrait)),P.naval&&P.underwater&&(J.submergibleTrait=new Y.SubmergibleTrait,J.traits.add(J.submergibleTrait)),P.locomotor===Z.LocomotorType.Hover&&J.traits.add(new X.HoverBobTrait),[Z.LocomotorType.Vehicle,Z.LocomotorType.Chrono].includes(P.locomotor)&&I.isVoxel&&(J.tilterTrait=new ee.TilterTrait,J.traits.add(J.tilterTrait)),J}constructor(g,P,L){super(I.ObjectType.Vehicle,g,P,L),this.direction=0,this.spinVelocity=0,this.crateBonuses=new J.CrateBonuses,this.turretNo=0,this.onBridge=!1,this.isSinker=!1,this.isFiring=!1,this.zone=P.naval?V.ZoneType.Water:V.ZoneType.Ground}isUnit(){return!0}isVehicle(){return!0}getUiName(){if(this.gunnerTrait){var g=this.armedTrait.getSpecialWeaponIndex(),P=this.gunnerTrait.getUiNameForIfvMode(g,this.transportTrait?.units[0]?.name);g="name:"+this.name;return P?`{${P}} {${g}}`:g}return super.getUiName()}update(g){this.rocking&&(this.rocking.ticksLeft--,this.rocking.ticksLeft||(this.rocking=void 0)),super.update(g)}applyRocking(g,P){this.rules.consideredAircraft||(this.rocking={ticksLeft:this.rocking?.ticksLeft??34,facing:g,factor:P})}},g("Vehicle",te)}}}),System.register("game/gameopts/constants",["game/gameopts/GameOpts"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("RANDOM_COUNTRY_ID",-2),g("RANDOM_COLOR_ID",-2),g("RANDOM_START_POS",-2),g("NO_TEAM_ID",-2),g("OBS_COUNTRY_ID",-3),g("OBS_COLOR_ID",-2),g("RANDOM_COUNTRY_NAME","Random"),g("OBS_COUNTRY_NAME","Observer"),g("aiUiNames",(new Map).set(I.AiDifficulty.Easy,"GUI:AIDummy").set(I.AiDifficulty.Medium,"GUI:AIEasyBeta").set(I.AiDifficulty.MediumSea,"GUI:AISeaLand")),g("aiUiTooltips",new Map),g("RANDOM_COUNTRY_UI_NAME","GUI:RandomEx"),g("RANDOM_COUNTRY_UI_TOOLTIP","STT:PlayerSideRandom"),g("OBS_COUNTRY_UI_NAME","GUI:Observer"),g("OBS_COUNTRY_UI_TOOLTIP","STT:PlayerSideObserver"),g("RANDOM_COLOR_NAME","")}}}),System.register("game/gameopts/GameOptRandomGen",["game/math/Vector2","game/Prng","game/rules/mpAllowedColors","util/typeGuard","game/gameopts/constants"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){g("GameOptRandomGen",class{static factory(g,P){return new this(L.Prng.factory(g,P))}constructor(g){this.prng=g}generateColors(g){let P=[...g.humanPlayers,...g.aiPlayers].filter(U.isNotNullOrUndefined),I=P.map(g=>g.colorId).filter(g=>g!==G.RANDOM_COLOR_ID);var L=_.mpAllowedColors.length;let V=new Array(L).fill(0).map((g,P)=>P).filter(g=>!I.includes(g)),W=new Map;return P.forEach(g=>{if(g.countryId!==G.OBS_COUNTRY_ID&&g.colorId===G.RANDOM_COLOR_ID){if(V.length<1)throw new Error("Out of available colors to choose from");var P=this.prng.generateRandomInt(0,V.length-1);W.set(g,V[P]),V.splice(P,1)}}),W}generateCountries(g,P){let I=P.getMultiplayerCountries().length,L=[...g.humanPlayers,...g.aiPlayers].filter(U.isNotNullOrUndefined),_=new Map;return L.forEach(g=>{g.countryId===G.RANDOM_COUNTRY_ID&&_.set(g,this.prng.generateRandomInt(0,I-1))}),_}generateStartLocations(g,P){let I=[...g.humanPlayers,...g.aiPlayers].filter(U.isNotNullOrUndefined),L=I.filter(g=>g.startPos!==G.RANDOM_START_POS).map(g=>g.startPos),_=[...P.keys()].filter(g=>!L.includes(g)),V=[];for(;_.length;){var W=_.length?this.prng.generateRandomInt(0,_.length-1):0;V.push(..._.splice(W,1))}if(V.unshift(...L),3<=V.length)for(var z of[1,2])if(!(L.length-1>=z)){let g=V.map(g=>P[g]),I=this.findFarthestPointFrom(g.slice(0,z),g.slice(z));var K=g.findIndex(g=>g.x===I.x&&g.y===I.y);V.splice(z,0,...V.splice(K,1))}if(4<=V.length&&L.length-1<3){let g=V.map(g=>P[g]),I=this.findFarthestPointFrom(g.slice(2,3),g.slice(3));var q=g.findIndex(g=>g.x===I.x&&g.y===I.y);V.splice(3,0,...V.splice(q,1))}V.splice(0,L.length);let $=new Map,Q=-1;return I.forEach(g=>{if(g.countryId!==G.OBS_COUNTRY_ID&&g.startPos===G.RANDOM_START_POS){if(Q>=V.length-1)throw new RangeError("Map has fewer starting locations than players");$.set(g,V[++Q])}}),$}findFarthestPointFrom(g,P){let L,_=g.map(g=>new I.Vector2(g.x,g.y)),U=0;if(!P.length)throw new Error("Search array must have at least one element");for(var G of P){let g=new I.Vector2(G.x,G.y);var V=_.reduce((P,I)=>P+g.distanceTo(I),0);V>=U&&(L=G,U=V)}return L}})}}}),System.register("game/gameopts/GameOpts",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;g("isHumanPlayerInfo",g=>"name"in g),(P=I||g("AiDifficulty",I={}))[P.Brutal=0]="Brutal",P[P.Medium=1]="Medium",P[P.Easy=2]="Easy",P[P.MediumSea=3]="MediumSea"}}}),System.register("game/gameopts/GameOptSanitizer",["util/math"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("GameOptSanitizer",class{static sanitize(g,P){var L=P.mpDialogSettings;g.credits=Math.floor(I.clamp(g.credits,L.minMoney,L.maxMoney)),g.gameSpeed=Math.floor(I.clamp(g.gameSpeed,0,6)),g.unitCount=Math.floor(I.clamp(g.unitCount,L.minUnitCount,L.maxUnitCount))}})}}}),System.register("game/GameSpeed",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){g("GameSpeed",I=class i{static computeGameSpeed(g){let P;return P=6===g?60:5===g?45:60/(6-g),P/i.BASE_TICKS_PER_SECOND}}),I.BASE_TICKS_PER_SECOND=15}}}),System.register("game/GameTurnManager",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("game/Hashable",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("game/ini/GameModes",["game/rules/MpDialogSettings","game/ini/GameModeType"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("GameModes",class{constructor(g,P){this.modeIniLoader=P,this.entries=new Map,this.loadIni(g)}loadIni(g){g.getOrderedSections().forEach(g=>{let P=L.GameModeType[g.name]??L.GameModeType.Battle;[...g.entries.keys()].forEach(L=>{let _=g.getArray(L);if(_.length<5)throw new Error(`Invalid format for mp mode entry "${L}".`);var U=Number(L),G=_[2].toLowerCase();G={id:U,type:P,label:_[0],description:_[1],rulesOverride:G,mapFilter:_[3],randomMapsAllowed:_[4],aiAllowed:U<3,mpDialogSettings:(new I.MpDialogSettings).readIni(this.modeIniLoader(G).getOrCreateSection("MultiplayerDialogSettings"))};this.entries.set(U,G)})})}getById(g){if(!this.entries.has(g))throw new Error("No game mode found with id "+g);return this.entries.get(g)}hasId(g){return this.entries.has(g)}getAll(){return[...this.entries.values()]}})}}}),System.register("game/ini/GameModeType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("GameModeType",I={}))[P.Battle=0]="Battle",P[P.ManBattle=1]="ManBattle",P[P.FreeForAll=2]="FreeForAll",P[P.Unholy=3]="Unholy",P[P.Cooperative=4]="Cooperative"}}}),System.register("game/ini/MixinRules",["game/ini/MixinRulesType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("MixinRules",class{static getTypes(g){let P=[];return g.noDogEngiKills&&P.push(I.MixinRulesType.NoDogEngiKills),P}})}}}),System.register("game/ini/MixinRulesType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("MixinRulesType",I={}))[P.NoDogEngiKills=0]="NoDogEngiKills"}}}),System.register("game/map/BridgeOverlayTypes",["util/math"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g}],execute:function(){var P;(P=L||g("OverlayBridgeType",L={}))[P.NotBridge=0]="NotBridge",P[P.Concrete=1]="Concrete",P[P.Wood=2]="Wood",g("BridgeOverlayTypes",_=class{static getOverlayBridgeType(g){return I.isBetween(g,this.minHighBridgeConcreteId,this.maxHighBridgeConcreteId)||I.isBetween(g,this.minLowBridgeConcreteId,this.maxLowBridgeConcreteId)?L.Concrete:I.isBetween(g,this.minHighBridgeWoodId,this.maxHighBridgeWoodId)||I.isBetween(g,this.minLowBridgeWoodId,this.maxLowBridgeWoodId)?L.Wood:L.NotBridge}static isBridge(g){return this.isHighBridge(g)||this.isLowBridge(g)}static isBridgePlaceholder(g){return this.bridgePlaceholderIds.includes(g)}static isHighBridge(g){return I.isBetween(g,this.minHighBridgeWoodId,this.maxHighBridgeWoodId)||I.isBetween(g,this.minHighBridgeConcreteId,this.maxHighBridgeConcreteId)}static isLowBridge(g){return I.isBetween(g,this.minLowBridgeWoodId,this.maxLowBridgeWoodId)||I.isBetween(g,this.minLowBridgeConcreteId,this.maxLowBridgeConcreteId)}static isXBridge(g){return g===this.minHighBridgeWoodId||g===this.minHighBridgeConcreteId||I.isBetween(g,this.minLowBridgeWoodId,this.minLowBridgeWoodId+8)||I.isBetween(g,this.minLowBridgeWoodId+18,this.minLowBridgeWoodId+21)||I.isBetween(g,this.minLowBridgeConcreteId,this.minLowBridgeConcreteId+8)||I.isBetween(g,this.minLowBridgeConcreteId+18,this.minLowBridgeConcreteId+21)}static isLowBridgeHead(g){return I.isBetween(g,this.minLowBridgeWoodId+18,this.minLowBridgeWoodId+25)||I.isBetween(g,this.minLowBridgeConcreteId+18,this.minLowBridgeConcreteId+25)}static isLowBridgeHeadStart(g){return I.isBetween(g,this.minLowBridgeWoodId+20,this.minLowBridgeWoodId+23)||I.isBetween(g,this.minLowBridgeConcreteId+20,this.minLowBridgeConcreteId+23)}static calculateLowBridgeOverlayId(g,P){let I;if(g===L.Concrete)I=this.minLowBridgeConcreteId;else{if(g!==L.Wood)throw new Error("Not implemented");I=this.minLowBridgeWoodId}return I+(P?0:9)}static calculateHighBridgeOverlayId(g,P){let I;if(g===L.Concrete)I=this.minHighBridgeConcreteId;else{if(g!==L.Wood)throw new Error("Not implemented");I=this.minHighBridgeWoodId}return I+(P?0:1)}}),_.minLowBridgeWoodId=74,_.maxLowBridgeWoodId=99,_.minLowBridgeConcreteId=205,_.maxLowBridgeConcreteId=230,_.minHighBridgeConcreteId=24,_.maxHighBridgeConcreteId=25,_.minHighBridgeWoodId=237,_.maxHighBridgeWoodId=238,_.bridgePlaceholderIds=[100,101,231,232]}}}),System.register("game/map/Bridges",["game/map/TileCollection","game/map/BridgeOverlayTypes","game/theater/TileSets","game/map/tileFinder/DirectionalTileFinder","game/map/tileFinder/RadialTileFinder","game/math/Vector2"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){var P;(P=W||g("BridgeHeadType",W={}))[P.None=0]="None",P[P.Start=1]="Start",P[P.End=2]="End",g("Bridges",class{constructor(g,P,I,L,_){this.tileSets=g,this.tiles=P,this.tileOccupation=I,this.mapBounds=L,this.rules=_,this.pieces=new Set,this.piecesByTile=new Map,this.handleTileOccupationUpdate=({object:g,type:P})=>{if(g.isOverlay()&&g.isBridge()){var I=g.tile;let U=this.piecesByTile.get(I);if("added"===P){if(U)throw new Error(`A bridge piece already exists at tile (${I.rx},${I.ry})`);var L=this.findBridgeAdjacentTiles(g);U={obj:g,prev:void 0,next:void 0,headType:this.computeHead(g,L.prev,L.next)},this.piecesByTile.set(I,U),this.pieces.add(U),this.connectPiece(U,L.prev,L.next),this.updateOverlayData(U),U.prev&&this.updateOverlayData(U.prev),U.next&&this.updateOverlayData(U.next)}else{if(!U)throw new Error(`Bridge piece was alredy removed at tile (${I.rx},${I.ry})`);var _=U.prev;L=U.next;this.disconnectPiece(U),this.piecesByTile.delete(I),this.pieces.delete(U),_&&this.updateOverlayData(_),L&&this.updateOverlayData(L)}}},I.onChange.subscribe(this.handleTileOccupationUpdate)}getPieceAtTile(g){return this.piecesByTile.get(g)}handlePieceHealthChange(g){this.updateOverlayData(g),g.prev&&this.updateOverlayData(g.prev),g.next&&this.updateOverlayData(g.next)}findDominoPieces(g){let P=[],I=!1,L=g.next;if(g.headType===W.None||L)for(;L;){if(P.push(L),L.headType!==W.None){I=!0;break}L=L.next}else I=!0;if(I){I=!1,P.length=0;let L=g.prev;if(g.headType===W.None||L)for(;L;){if(P.push(L),L.headType!==W.None){I=!0;break}L=L.prev}else I=!0;if(I)return[]}return P}findBridgeAdjacentTiles(g){var P=g.isXBridge(),I=new V.Vector2(Number(P),Number(!P));let L=new V.Vector2(g.tile.rx,g.tile.ry);return P=L.clone().sub(I),P=this.tiles.getByMapCoords(P.x,P.y),I=L.clone().add(I),{prev:P,next:this.tiles.getByMapCoords(I.x,I.y)}}connectPiece(g,P,I){P&&(g.prev=this.getPieceAtTile(P),g.prev&&(g.prev.next=g)),I&&(g.next=this.getPieceAtTile(I),g.next&&(g.next.prev=g))}disconnectPiece(g){g.next&&(g.next.prev=void 0,g.next=void 0),g.prev&&(g.prev.next=void 0,g.prev=void 0)}computeHead(g,P,I){var _=g.tile;return g.isHighBridge()?(_=_.z+g.tileElevation,P?.z===_?W.Start:I?.z===_?W.End:W.None):L.BridgeOverlayTypes.isLowBridgeHead(g.overlayId)?L.BridgeOverlayTypes.isLowBridgeHeadStart(g.overlayId)?W.Start:W.End:W.None}updateOverlayData(g){let P=g.obj,I=g.prev,_=g.next,U=!1;var G=P.isXBridge(),V=L.BridgeOverlayTypes.getOverlayBridgeType(P.overlayId);if(L.BridgeOverlayTypes.isLowBridgeHead(P.overlayId)){let g=0;L.BridgeOverlayTypes.isLowBridgeHeadStart(P.overlayId)?(g=G?20:22,_||g++):(g=G?18:24,I||g++),P.overlayId=(V===L.OverlayBridgeType.Wood?L.BridgeOverlayTypes.minLowBridgeWoodId:L.BridgeOverlayTypes.minLowBridgeConcreteId)+g,P.value=g,U=!0}else{let $;var z,K,q=(P.healthTrait?.health??100)<=50;$=g.headType!==W.None?g.headType===W.Start?_?q?6:(_.obj.healthTrait?.health??100)<=50?5:0:G?8:7:I?q?6:(I.obj.healthTrait?.health??100)<=50?4:0:G?7:8:(G||(K=I,I=_,_=K),I||_?I?_?(z=(I.obj.healthTrait?.health??100)<=50,K=(_.obj.healthTrait?.health??100)<=50,q||z&&K?6:z?4:K?5:0):8:7:0),G||($+=9),P.isHighBridge()?P.value=$:(P.overlayId=(V===L.OverlayBridgeType.Wood?L.BridgeOverlayTypes.minLowBridgeWoodId:L.BridgeOverlayTypes.minLowBridgeConcreteId)+$,P.value=$,U=!0)}U&&(P.name=this.rules.getOverlayName(P.overlayId))}findClosestBridgeSpec(g){let P=new G.RadialTileFinder(this.tiles,this.mapBounds,g,{width:1,height:1},1,3,P=>{if(P.z!==g.z)return!1;let I=this.tileOccupation.getBridgeOnTile(P);return!(!I?.isLowBridge()||this.getPieceAtTile(I.tile)?.headType===W.None)||!!this.tileSets.isHighBridgeBoundaryTile(P.tileNum)},!1);var I=P.getNextTile();if(I){let g,P,G,X;var V=!this.tileOccupation.getBridgeOnTile(I);let J;if(V){var z=this.findHighBridgeBoundary(I);if(!z)return;g=z.tile,P=L.OverlayBridgeType.Concrete,this.tileSets.getSetNum(I.tileNum)===this.tileSets.getGeneralValue("WoodBridgeSet")&&(P=L.OverlayBridgeType.Wood),G=z.headType===_.HighBridgeHeadType.TopLeft||z.headType===_.HighBridgeHeadType.BottomRight,X=z.headType===_.HighBridgeHeadType.TopLeft||z.headType===_.HighBridgeHeadType.TopRight,J=z.headType}else{g=this.tileOccupation.getBridgeOnTile(I).tile;let _=this.getPieceAtTile(g);if(!_)throw new Error("Bridge head is not defined");var K=L.BridgeOverlayTypes.getOverlayBridgeType(_.obj.overlayId);if(K===L.OverlayBridgeType.NotBridge)throw new Error("Expected a bridge type");P=K,G=_.obj.isXBridge(),X=_.headType===W.Start}var q=Number(G)*(X?1:-1),$=Number(!G)*(X?1:-1);let ee;if(V){if(I=new U.DirectionalTileFinder(this.tiles,this.mapBounds,g,1,100,q,$,P=>P.z===g.z&&this.tileSets.isHighBridgeBoundaryTile(P.tileNum),!1).getNextTile(),K=this.tileSets.getSetNum(g.tileNum),!I||this.tileSets.getSetNum(I.tileNum)!==K)return;if(!(I=this.findHighBridgeBoundary(I)))return;if(J!==this.tileSets.getOppositeHighBridgeHeadType(I.headType))return;ee=I.tile}else{let P,I=1;for(var Q=g.rx,Y=g.ry;!P;){var Z=this.tiles.getByMapCoords(Q+q*I,Y+$*I);if(!Z)return;let g=this.getPieceAtTile(Z);if(g&&g.obj.isXBridge()!==G)return;g?.headType===(X?W.End:W.Start)&&(P=g),I++}ee=P.obj.tile}return{start:X?g:ee,end:X?ee:g,type:P,isHigh:V,isXBridge:G}}}findHighBridgeBoundary(g){let P=this.tileSets.getTile(g.tileNum);var I=this.tileSets.getHighBridgeHeadType(P.index);if(void 0!==I){let W=0,z=0;switch(I){case _.HighBridgeHeadType.TopLeft:W=1,z=0;break;case _.HighBridgeHeadType.BottomRight:W=-1,z=0;break;case _.HighBridgeHeadType.TopRight:W=0,z=1;break;case _.HighBridgeHeadType.BottomLeft:W=0,z=-1;break;case _.HighBridgeHeadType.MiddleTlBr:W=1,z=0;break;case _.HighBridgeHeadType.MiddleTrBl:W=0,z=1;break;default:throw new Error(`Unhandled head type "${I}"`)}const K=P.getRelativeTilePositions();var L=K.filter(g=>4===g.z).sort((g,P)=>100*(W?W*(P.rx-g.rx):z*(P.ry-g.ry))+(W?g.ry-P.ry:g.rx-P.rx))[0].subTile,U=K[L].rx-K[g.subTile].rx,G=K[L].ry-K[g.subTile].ry,V=this.tiles.getByMapCoords(g.rx+U,g.ry+G);if(V){if(V.subTile===L&&V.tileNum===g.tileNum)return{tile:V,headType:I};console.warn(`Found invalid bridge boundary tile. (${g.rx},${g.ry})+(${U},${G})`)}}else console.warn(`Couldn't find a valid bridge type for index "${P.index}" @ ${g.rx},`+g.ry)}canBeRepaired(g){let P,L=this.createBridgePieceTileFinder(g,P=>!(this.getPieceAtTile(P)||this.tileSets.isHighBridgeMiddleTile(P.tileNum)&&P.z===g.start.z)),_=!1;for(var U=g.start.rx!==g.end.rx?I.TileDirection.BottomLeft:I.TileDirection.BottomRight;P=L.getNextTile();){_=!0;let I=this.tiles.getNeighbourTile(P,U),L=this.tiles.getNeighbourTile(I,U);if(g.isHigh){if([P,I,L].find(g=>this.tileOccupation.getGroundObjectsOnTile(g).some(g=>g.isBuilding()&&!g.rules.invisibleInGame)))return!1}else if([P,I,L].find(g=>this.tileOccupation.getGroundObjectsOnTile(g).some(g=>!(g.isUnit()||g.isSmudge()||g.isOverlay()&&g.isBridgePlaceholder()))))return!1}return _}getPieceTiles(g){var P=g.obj.tile,L=g.obj.isXBridge()?I.TileDirection.BottomLeft:I.TileDirection.BottomRight,_=this.tiles.getNeighbourTile(P,L);return[P,_,this.tiles.getNeighbourTile(_,L)]}findMapHighBridgeHeadTiles(){var g,P=this.tiles.getAllBridgeSetTiles();let I=new Set;for(g of P){var L=this.findHighBridgeBoundary(g);L&&I.add(L.tile)}return I}findBridgeSpecsForHeadTiles(g){let P=new Map;for(var I of g)(I=this.findClosestBridgeSpec(I))&&P.set(I.start.id+":"+I.end.id,I);return[...P.values()]}findAllBridgeTiles(g){let P=[];var L,_=g.start.rx!==g.end.rx?I.TileDirection.BottomLeft:I.TileDirection.BottomRight;for(L of this.findNonBuildablePieceTiles(g)){var U=this.tiles.getNeighbourTile(L,_),G=this.tiles.getNeighbourTile(U,_);P.push(L,U,G)}return P}getBridgeSize(g){var P=g.start.rx!==g.end.rx;return{width:P?g.end.rx-g.start.rx+1:3,height:P?3:g.end.ry-g.start.ry+1}}findBridgePieces(g){let P=this.createBridgePieceTileFinder(g,g=>!!this.getPieceAtTile(g)),I=[];for(var L;L=P.getNextTile();)I.push(this.getPieceAtTile(L));return I}findDestroyedPieceTiles(g){let P=this.createBridgePieceTileFinder(g,P=>!(this.getPieceAtTile(P)||this.tileSets.isHighBridgeMiddleTile(P.tileNum)&&P.z===g.start.z)),I=[];for(var L;L=P.getNextTile();)I.push(L);return I}findNonBuildablePieceTiles(g){let P=this.createBridgePieceTileFinder(g,P=>!(this.tileSets.isHighBridgeMiddleTile(P.tileNum)&&P.z===g.start.z)),I=[];for(var L;L=P.getNextTile();)I.push(L);return I}createBridgePieceTileFinder(g,P){var I=g.start.rx!==g.end.rx;return new U.DirectionalTileFinder(this.tiles,this.mapBounds,g.start,1,(I?g.end.rx-g.start.rx:g.end.ry-g.start.ry)-1,Number(I),Number(!I),P,!1)}dispose(){this.pieces.forEach(g=>{g.prev=void 0,g.next=void 0}),this.tileOccupation.onChange.unsubscribe(this.handleTileOccupationUpdate)}})}}}),System.register("game/map/MapBounds",["util/geometry","game/Coords","util/event"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("MapBounds",class{constructor(){this.mapCutoffHeight=0,this.mapBuildableSize={x:0,y:0,width:0,height:0},this.localSize={x:0,y:0,width:0,height:0},this.fullSize={width:0,height:0},this.clampedFullSize={x:0,y:0,width:0,height:0},this.rawLocalSize={x:0,y:0,width:0,height:0},this._onLocalResize=new _.EventDispatcher}get onLocalResize(){return this._onLocalResize.asEvent()}fromMapFile(g,P){this.fullSize={width:2*g.fullSize.width,height:2*g.fullSize.height},this.clampedFullSize={x:1,y:2,width:2*(g.fullSize.width-1)-1/L.Coords.ISO_TILE_SIZE,height:2*(g.fullSize.height-1)+1-1/L.Coords.ISO_TILE_SIZE},this.mapCutoffHeight=Math.max(9,P.getCutoffTileHeight());var I={x:I=Math.max(2,g.localSize.x),y:g.localSize.y,width:Math.min(g.fullSize.width-2-I,g.localSize.width),height:g.localSize.height};return this.updateRawLocalSize(I),this}updateRawLocalSize(g){this.rawLocalSize.width&&this.rawLocalSize.height&&!I.rectContainsRect(g,this.rawLocalSize)?console.warn("New map limits must be outside old limits. Skipping."):I.rectEquals(g,this.rawLocalSize)||(this.localSize=this.computeLocalSize(g,this.fullSize.height/2,this.mapCutoffHeight),this.rawLocalSize={...g},this.mapBuildableSize={x:this.localSize.x,y:this.localSize.y+4,width:this.localSize.width-2,height:this.localSize.height-8},this._onLocalResize.dispatch(this))}computeLocalSize(g,P,I){return{x:2*g.x,y:2*g.y-4,height:Math.min(2*(g.height+5)-1,2*P-2*(g.y-3)-I),width:2*g.width}}getLocalSize(){return this.localSize}getRawLocalSize(){return this.rawLocalSize}getFullSize(){return this.fullSize}getClampedFullSize(){return this.clampedFullSize}isWithinBounds(g){return I.rectContainsPoint(this.mapBuildableSize,{x:g.dx,y:g.dy-g.z})}clampWithinBounds(g){let{x:P,y:L}=I.rectClampPoint(this.mapBuildableSize,{x:g.dx,y:g.dy-g.z});return L+=P%2-L%2,L>this.mapBuildableSize.y+this.mapBuildableSize.height&&(L-=2),{dx:P,dy:L}}isWithinHardBounds(g){var P=g.x/L.Coords.LEPTONS_PER_TILE,_=P-(U=(g.z??g.y)/L.Coords.LEPTONS_PER_TILE)+this.fullSize.width/2-1,U=P+U-this.fullSize.width/2-1;return I.rectContainsPoint(this.clampedFullSize,{x:++_,y:++U})}})}}}),System.register("game/map/MapShroud",["util/event","game/GameSpeed","engine/type/TerrainType","util/math"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){var P;V=(1<<(G=3))-1,(P=W||g("ShroudType",W={}))[P.Unexplored=0]="Unexplored",P[P.TemporaryReveal=1]="TemporaryReveal",P[P.Explored=2]="Explored",(P=z||g("ShroudFlag",z={}))[P.Darken=8]="Darken",g("MapShroud",class h{constructor(){this.invalidations=new Map,this.temporaryReveals=new Map,this.fullInvalidation=!1,this._onChange=new I.EventDispatcher}get onChange(){return this._onChange.asEvent()}fromTiles(g){var P,I=g.getMapSize(),L=g.getMaxTileHeight();L=this.padding=(L+L%2)/2;for(P of(this.size={width:I.width+L,height:I.height+L},this.tiles=new Uint8Array(this.size.width*this.size.height),this.tiles.fill(W.Unexplored),this.tileElevation=new Uint8Array(this.size.width*this.size.height),g.getAll())){var U=this.getTileIndex(P);this.tileElevation[U]=Math.max(this.tileElevation[U],P.terrainType===_.TerrainType.Cliff&&0<P.z?P.z-1:P.z)}return this}getSize(){return this.size}getTileIndex(g){var{sx:P,sy:I}=this.rxyzToSxy(g.rx,g.ry,g.z);return P+I*this.size.width}rxyzToSxy(g,P,I){var L=(I|=0)+I%2;return{sx:g-L/2+this.padding,sy:P-L/2+this.padding}}sxyzToRxy(g,P,I){return{rx:g+Math.ceil(I/2)-this.padding,ry:P+Math.ceil(I/2)-this.padding}}shroudCoordsToWorld({sx:g,sy:P}){return this.sxyzToRxy(g,P,0)}findTilesAtShroudCoords({sx:g,sy:P},I){var L=I.getMaxTileHeight(),_=L+L%2;let U=[];for(let L=0;L<=_;L+=2){var G=L+L%2,{rx:V,ry:G}=this.sxyzToRxy(g,P,G);G=I.getByMapCoords(V,G);G?.z===L&&U.push(G)}return U}clone(){let g=new h;return g.tiles=this.tiles.slice(),g.size=this.size,g.padding=this.padding,g.tileElevation=this.tileElevation,g}copy(g){this.tiles=g.tiles.slice(),this.size=g.size,this.padding=g.padding,this.tileElevation=g.tileElevation}merge(g){if(this.size.width!==g.size.width||this.size.height!==g.size.height)throw new Error("Size mismatch");var P=g.tiles;for(let g=0,I=this.tiles.length;g<I;g++)this.tiles[g]=Math.max(P[g]&V,this.tiles[g]&V)|(P[g]|this.tiles[g])>>G<<G}isShrouded(g,P=0){var I=this.rxyzToSxy(g.rx,g.ry,g.z+P);return this.getShroudTypeByShroudCoords(I)===W.Unexplored}getShroudType(g){return this.tiles[this.getTileIndex(g)]&V}isFlagged(g,P){return 0!=(this.tiles[this.getTileIndex(g)]&P)}getShroudTypeByTileCoords(g,P,I){return this.getShroudTypeByShroudCoords(this.rxyzToSxy(g,P,I))}getShroudTypeByShroudCoords({sx:g,sy:P}){return g<0||P<0||g>=this.size.width||P>=this.size.height?W.Unexplored:this.tiles[g+P*this.size.width]&V}invalidateFull(){this.fullInvalidation=!0}invalidate(g,P,I){var L=g.sx+g.sy*this.size.width;let _=this.invalidations.get(L);_||(_={center:g,elevation:0,radius:0},this.invalidations.set(L,_)),_.elevation=Math.max(_.elevation,P),_.radius=Math.max(_.radius,I)}revealFrom(g){var P,I,L;g.isBuilding()&&g.wallTrait||(P=g.sight)&&(I=g.tile.z+g.tileElevation,L=this.rxyzToSxy(g.tile.rx,g.tile.ry,I),this.invalidate(L,I,P))}revealAround(g,P){var I=this.rxyzToSxy(g.rx,g.ry,g.z);this.invalidate(I,Number.POSITIVE_INFINITY,P)}unrevealAround(g,P){var I=[],L=this.rxyzToSxy(g.rx,g.ry,g.z);this.setValueAround(L,P,Number.POSITIVE_INFINITY,I,W.Unexplored,W.Explored),this._onChange.dispatch(this,{type:"incremental",coords:I})}revealTemporarily(g){var P=this.rxyzToSxy(g.tile.rx,g.tile.ry,g.tile.z+g.tileElevation);this.temporaryReveals.set(P,5*L.GameSpeed.BASE_TICKS_PER_SECOND)}revealObject(g){var P=this.rxyzToSxy(g.tile.rx,g.tile.ry,g.tile.z+g.tileElevation);this.invalidate(P,Number.POSITIVE_INFINITY,4.25)}toggleFlagsAround(g,P,I,L){var _=[],U=this.rxyzToSxy(g.rx,g.ry,g.z);this.setValueAround(U,P,Number.POSITIVE_INFINITY,_,void 0,void 0,L?{setFlags:I}:{clearFlags:I}),this._onChange.dispatch(this,{type:"incremental",coords:_})}update(){let g=[];if(this.invalidations.size){for(var P of this.invalidations.values())this.setValueAround(P.center,P.radius,P.elevation,g,W.Explored,[W.Unexplored,W.TemporaryReveal]);this.invalidations.clear()}this.temporaryReveals.size&&this.temporaryReveals.forEach((P,I)=>{P<=0?(this.setValueAround(I,3,Number.POSITIVE_INFINITY,g,W.Unexplored,W.TemporaryReveal),this.temporaryReveals.delete(I)):(P===5*L.GameSpeed.BASE_TICKS_PER_SECOND&&this.setValueAround(I,3,Number.POSITIVE_INFINITY,g,W.TemporaryReveal,W.Unexplored),this.temporaryReveals.set(I,P-1))}),this.fullInvalidation?(this.fullInvalidation=!1,this._onChange.dispatch(this,{type:"full"})):g.length&&this._onChange.dispatch(this,{type:"incremental",coords:g})}setValueAround(g,P,I,L,_,W=void 0,{setFlags:z,clearFlags:K}={}){var q=Math.ceil(P),$=U.clamp(g.sx-q,0,this.size.width-1),Q=U.clamp(g.sx+q,0,this.size.width-1),Y=U.clamp(g.sy-q,0,this.size.height-1),Z=U.clamp(g.sy+q,0,this.size.height-1),X=this.size.width;for(let U=$;U<=Q;U++)for(let q=Y;q<=Z;q++){var J=U+q*X,ee=this.tiles[J]&V,te=this.tiles[J]>>G<<G;let $=te;void 0!==z&&($|=z),void 0!==K&&($&=~K),void 0!==W&&("number"!=typeof W?!W.includes(ee):W!==ee)||(U-g.sx)*(U-g.sx)+(q-g.sy)*(q-g.sy)>P*P+1||this.tileElevation[J]>=I+4||(this.tiles[J]=(_??ee)|$,ee===_&&te===$||L.push({sx:U,sy:q}))}}revealAll(){this.tiles.fill(W.Explored),this._onChange.dispatch(this,{type:"clear"})}reset(){this.tiles.fill(W.Unexplored),this._onChange.dispatch(this,{type:"cover"})}})}}}),System.register("game/map/OreOverlayTypes",["engine/type/TiberiumType"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("OreOverlayTypes",L=class{static getOverlayTibType(g){return this.isRiparius(g)?I.TiberiumType.Riparius:this.isCruentus(g)?I.TiberiumType.Cruentus:this.isVinifera(g)?I.TiberiumType.Vinifera:this.isAboreus(g)?I.TiberiumType.Aboreus:void 0}static isRiparius(g){return g>=this.minIdRiparius&&g<=this.maxIdRiparius}static isCruentus(g){return g>=this.minIdCruentus&&g<=this.maxIdCruentus}static isVinifera(g){return g>=this.minIdVinifera&&g<=this.maxIdVinifera}static isAboreus(g){return g>=this.minIdAboreus&&g<=this.maxIdAboreus}}),L.minIdRiparius=102,L.maxIdRiparius=127,L.minIdCruentus=27,L.maxIdCruentus=38,L.minIdVinifera=127,L.maxIdVinifera=146,L.minIdAboreus=147,L.maxIdAboreus=166}}}),System.register("game/map/OreSpread",["game/map/OreOverlayTypes","engine/type/TiberiumType"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("OreSpread",class{static calculateOverlayId(g,P){var _=P.dx,U=P.dy;_=Math.floor((U-9)/2%12*((U-8)/2%12)%12-(_-13)/2%12*((_-12)/2%12)%12+12e4);return _%=12,g===L.TiberiumType.Riparius?I.OreOverlayTypes.minIdRiparius+_:g===L.TiberiumType.Cruentus?I.OreOverlayTypes.minIdCruentus+_:g===L.TiberiumType.Vinifera?I.OreOverlayTypes.minIdVinifera+_:g===L.TiberiumType.Aboreus?I.OreOverlayTypes.minIdAboreus+_:void 0}})}}}),System.register("game/map/pathFinder/NodeHeap",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("NodeHeap",class{constructor(g=[]){if(this.data=g,this.length=g.length,0<this.length)for(let g=this.length>>1;0<=g;g--)this.down(g);for(let g=0;g<this.length;++g)this.setNodeId(this.data[g],g)}compare(g,P){return g.fScore-P.fScore}setNodeId(g,P){g.heapIndex=P}push(g){this.data.push(g),this.setNodeId(g,this.length),this.length++,this.up(this.length-1)}pop(){if(0!==this.length){var g=this.data[0];return this.length--,0<this.length&&(this.data[0]=this.data[this.length],this.setNodeId(this.data[0],0),this.down(0)),this.data.pop(),g}}peek(){return this.data[0]}updateItem(g){this.down(g),this.up(g)}up(g){let P=this.data;for(var I=P[g];0<g;){var L=g-1>>1,_=P[L];if(0<=this.compare(I,_))break;P[g]=_,this.setNodeId(_,g),g=L}P[g]=I,this.setNodeId(I,g)}down(g){let P=this.data;for(var I=this.length>>1,L=P[g];g<I;){let I=1+(g<<1);var _=I+1;let U=P[I];if(_<this.length&&this.compare(P[_],U)<0&&(I=_,U=P[_]),0<=this.compare(U,L))break;P[g]=U,this.setNodeId(U,g),g=I}P[g]=L,this.setNodeId(L,g)}})}}}),System.register("game/map/pathFinder/PathFinder",["game/map/pathFinder/NodeHeap","game/map/pathFinder/SearchStatePool"],function(g,P){"use strict";var I,L;function r(){return 0}function s(){return 1}function v(g){let P=[g.node],I=g.parent;for(;I;)P.push(I.node),I=I.parent;return P}return P&&P.id,g("PathFinder",function(g,P={}){let _=P.bestEffort,U=P.maxExpandedNodes||Number.POSITIVE_INFINITY,G=P.heuristic??r,V=P.distance??s,W=P.excludedNodes,z=L.makeSearchStatePool();return{find:function(P,L){let K=g.getNode(P);if(!K)throw new Error("fromId is not defined in this graph: "+P);let q=g.getNode(L);if(!q)throw new Error("toId is not defined in this graph: "+L);if(K===q)return[];z.reset();let $=new Map,Q=new I.NodeHeap,Y=z.createNewState(K);if($.set(P,Y),Y.fScore=W?.(q.data)?Number.POSITIVE_INFINITY:G(K,q),!Number.isFinite(Y.fScore)&&K.neighbors.has(q))return[];Y.distanceToSource=0,Q.push(Y),Y.open=1;let Z,X=Y,J=0;for(;0<Q.length;){if(Z=Q.pop(),Z.node===q)return v(Z);if(J++,J>U)break;Z.closed=!0,Z.node.neighbors.forEach(h)}return _?v(X):[];function h(g){let P=$.get(g.id);var I;P||(P=z.createNewState(g),$.set(g.id,P)),P.closed||(0===P.open&&(Q.push(P),P.open=1),(I=W?.(g.data)?Number.POSITIVE_INFINITY:Z.distanceToSource+V(Z.node,g))>=P.distanceToSource||(P.parent=Z,P.distanceToSource=I,W?.(q.data)?P.fScore=Number.POSITIVE_INFINITY:P.fScore=I+G(P.node,q,P),P.fScore-P.distanceToSource<X.fScore-X.distanceToSource&&(X=P),Q.updateItem(P.heapIndex)))}}}}),{setters:[function(g){I=g},function(g){L=g}],execute:function(){}}}),System.register("game/map/pathFinder/SearchStatePool",[],function(g,P){"use strict";var I;return P&&P.id,g("makeSearchStatePool",function(){let g=0,P=[];return{createNewState(L){let _=P[g];return _?(_.node=L,_.parent=void 0,_.closed=!1,_.open=0,_.distanceToSource=Number.POSITIVE_INFINITY,_.fScore=Number.POSITIVE_INFINITY,_.heapIndex=-1):(_=new I(L),P[g]=_),g++,_},reset(){g=0}}}),{setters:[],execute:function(){g("NodeSearchState",I=class{constructor(g){this.node=g,this.closed=!1,this.open=0,this.distanceToSource=Number.POSITIVE_INFINITY,this.fScore=Number.POSITIVE_INFINITY,this.heapIndex=-1}})}}}),System.register("game/map/Terrain",["game/map/TileCollection","game/type/SpeedType","util/Graph","game/map/pathFinder/PathFinder","util/typeGuard","game/map/tileFinder/RadialTileFinder","util/geometry","game/type/LandType","game/rules/TerrainRules"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K;function E(g,P){var I=Math.abs(g.data.tile.rx-P.data.tile.rx),L=Math.abs(g.data.tile.ry-P.data.tile.ry);return I+L+(Math.SQRT2-2)*Math.min(I,L)}function C(g,P,I){var L=Math.abs(g.data.tile.rx-P.data.tile.rx),_=Math.abs(g.data.tile.ry-P.data.tile.ry);let U=L+_+(Math.SQRT2-2)*Math.min(L,_);return I?.parent&&(_=(L=I.parent.node).data.tile.rx-g.data.tile.rx,L=L.data.tile.ry-g.data.tile.ry,I.dirX=_,I.dirY=L,_===I.parent.dirX&&L===I.parent.dirY||(U+=.2)),U}return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g}],execute:function(){g("Terrain",class{constructor(g,P,I,_,U){this.tiles=g,this.theaterType=P,this.mapBounds=I,this.tileOccupation=_,this.rules=U,this.passabilityGraphs=new Map,this.invalidatedTiles=new Map,this.tiberiumMayChangePassability=new Set,this.handleTileOccupationUpdate=({tiles:g,object:P})=>{var I=g.filter(g=>{if(P.isOverlay()){if(P.isBridge())return!0;if(P.isTiberium()){var I=z.getLandType(g.terrainType);if(this.tiberiumMayChangePassability.has(I))return!0}}var _=L.SpeedType.Foot;I=!P.isTerrain();return this.isBlockerObject(P,g,!1,_,I)||P.isBuilding()&&P.rules.leaveRubble});I.length&&this.invalidateTiles(I)},this.handleMapBoundsResize=()=>{this.passabilityGraphs.clear()},_.onChange.subscribe(this.handleTileOccupationUpdate),I.onLocalResize.subscribe(this.handleMapBoundsResize),this.tiberiumMayChangePassability.clear();let G=this.rules.getLandRules(z.LandType.Tiberium);for(var V of Object.values(L.SpeedType).filter(g=>"string"!=typeof g)){var W,K=Boolean(Math.sign(G.getSpeedModifier(V)));for(W of Object.values(z.LandType).filter(g=>"string"!=typeof g))Boolean(Math.sign(this.rules.getLandRules(W).getSpeedModifier(V)))!==K&&this.tiberiumMayChangePassability.add(W)}}getGraphKey(g,P){return g+"_"+Number(P)}invalidateTiles(g){g.length&&[...this.passabilityGraphs.keys()].forEach(P=>{let I=this.invalidatedTiles.get(P);I?g.forEach(g=>I.add(g)):this.invalidatedTiles.set(P,new Set(g))})}computePath(g,P,I,L,_,G,{maxExpandedNodes:W=Number.POSITIVE_INFINITY,bestEffort:z=!0,excludeTiles:K,ignoredBlockers:q=[]}={}){let $=this.computePassabilityGraph(g,P);var Q=q.map(g=>this.tileOccupation.calculateTilesForGameObject(g.tile,g)).reduce((g,P)=>g.concat(P),[]);Q.length&&this.updatePassability(Q,g,P,$,q);var Y=this.getNodeId(I,L),Z=!!$.hasNode(Y);Z||this.updatePassability([I],g,P,$,q,1);var X=this.getNodeId(_,G),J=!!$.hasNode(X);let ee;var te=Z&&!Q.length;if(te){let _=this.getIslandIdMap(g,P),U=_.get(I,L);ee=(g,P)=>_.get(g,P)===U}else ee=(I,L)=>0<this.getPassableSpeed(I,g,P,L,q);if(!J||!ee(_,G)){var re=z?new V.RadialTileFinder(this.tiles,this.mapBounds,_,{width:1,height:1},1,te?15:5,g=>ee(g,!1)&&Math.abs(g.z-_.z)<2&&!K?.({tile:g,onBridge:void 0})).getNextTile():void 0;if(re)_=re,G=!1;else{if(te)return Q.length&&this.updatePassability(Q,g,P,$),[];$.addNode(X,{tile:_,onBridge:void 0}),W=Math.min(W,500)}}let se=U.PathFinder($,{bestEffort:z,maxExpandedNodes:W,excludedNodes:K,distance:E,heuristic:C}).find(this.getNodeId(I,L),this.getNodeId(_,G)).map(g=>({tile:g.data.tile,onBridge:g.data.onBridge}));return(se.length<2||K&&se.length&&(!z&&se[0].tile!==_||se[se.length-1].tile!==I))&&(se=[]),Z||($.removeNode(Y),this.updatePassability([I],g,P,$)),J||$.removeNode(X),Q.length&&this.updatePassability(Q,g,P,$),se}computeAllPassabilityGraphs(){Object.keys(L.SpeedType).forEach(g=>{var P=Number(g);isNaN(P)||P===L.SpeedType.Winged||(this.computePassabilityGraph(P,!1),this.computePassabilityGraph(P,!0))})}computePassabilityGraph(g,P){var I=this.getGraphKey(g,P);let L=this.passabilityGraphs.get(I);if(L){let _=this.invalidatedTiles.get(I);_?.size&&(this.updatePassability([..._],g,P,L),_.clear(),this.computeIslandIds(L))}else L=new _.Graph,this.passabilityGraphs.set(I,L),this.tiles.forEach(I=>{this.computePassability(I,g,P,L)}),this.computeIslandIds(L);return L}updatePassability(g,P,L,_,U=[],V){let W=new Set;g.forEach(g=>{[g,this.tiles.getNeighbourTile(g,I.TileDirection.Right),this.tiles.getNeighbourTile(g,I.TileDirection.BottomRight),this.tiles.getNeighbourTile(g,I.TileDirection.Bottom),this.tiles.getNeighbourTile(g,I.TileDirection.BottomLeft)].filter(G.isNotNullOrUndefined).forEach(g=>W.add(g))});let z=new Map;g.forEach(g=>{var P;for(P of[_.getNode(this.getNodeId(g,!1)),_.getNode(this.getNodeId(g,!0))])P&&(z.set(P.id,P.data.islandId),_.removeNode(P.id))}),W.forEach(I=>{this.computePassability(I,P,L,_,U,V&&g.includes(I)?V:void 0)}),z.forEach((g,P)=>{let I=_.getNode(P);I&&(I.data.islandId=g)})}computePassability(g,P,L,_,U=[],G){var V=[I.TileDirection.Left,I.TileDirection.TopLeft,I.TileDirection.Top,I.TileDirection.TopRight];if(G||this.getPassableSpeed(g,P,L,!1,U)){var W,z=this.getNodeId(g,!1);for(W of(_.hasNode(z)||_.addNode(z,{tile:g,onBridge:void 0,forceLandSpeed:G}),V))this.connectTiles(g,void 0,W,P,L,_,U)}var K=this.tileOccupation.getBridgeOnTile(g);if(K&&(G||this.getPassableSpeed(g,P,L,!0,U))){var q;z=this.getNodeId(g,!0);for(q of(_.hasNode(z)||_.addNode(z,{tile:g,onBridge:K,forceLandSpeed:G}),V))this.connectTiles(g,K,q,P,L,_,U)}}connectTiles(g,P,I,L,_,U,G=[]){var V=this.tiles.getNeighbourTile(g,I);if(V){let I=this.tileOccupation.getBridgeOnTile(V);var W=P||I?0:1;if(Math.abs(g.z+(P?.tileElevation??0)-(V.z+(I?.tileElevation??0)))>W){if(!I?.isHighBridge()&&!P?.isHighBridge()||0!==Math.abs(g.z-V.z)||!U.hasNode(this.getNodeId(g,!1)))return;P=I=void 0}W=this.getNodeId(V,!!I);let z=U.getNode(W);this.getPassableSpeed(V,L,_,!!I,G,void 0,z?.data.forceLandSpeed)&&(z=z??U.addNode(W,{tile:V,onBridge:I}),V=this.getNodeId(g,!!P),U.getNode(V).addLink(z))}}getNodeId(g,P){return g.id+(P?"_bridge":"")}computeIslandIds(g){let P=1;g.forEachNode(g=>{g.data.islandId=void 0}),g.forEachNode(g=>{g.data.islandId||this.floodIslandId(g,P++)})}floodIslandId(g,P){let I=[g];for(;I.length;){let g=I.pop();for(var L of(g.data.islandId=P,g.neighbors))L.data.islandId||I.push(L)}}getIslandIdMap(g,P){let I=this.computePassabilityGraph(g,P);return{get:(g,P)=>{var L=this.getNodeId(g,P);return I.getNode(L)?.data.islandId}}}getPassableSpeed(g,P,I,_,U=[],G=!1,V){if(!this.mapBounds.isWithinBounds(g))return 0;let W=_?g.onBridgeLandType:g.landType;if(void 0===W)return 0;W===z.LandType.Wall&&P===L.SpeedType.Track&&(W=z.getLandType(g.terrainType));let K=this.rules.getLandRules(W);var q,$=V||K.getSpeedModifier(P);if(!$)return 0;if(!G)for(q of this.tileOccupation.getObjectsOnTile(g))if(this.isBlockerObject(q,g,_,P,I)&&!U.includes(q))return 0;return $}isBlockerObject(g,P,I,_,U){if(g.rules.crushable&&[L.SpeedType.Track,L.SpeedType.Hover].includes(_))return!1;if(g.isTerrain())return!U||g.rules.getOccupationBits(this.theaterType)===K.OccupationBits.All;if(g.isBuilding()){if(g.rules.invisibleInGame)return!1;if(g.isDestroyed&&g.rules.leaveRubble)return!1;if(g.rules.gate)return!1;var G=g.art.foundation;let I=g.rules.numberImpassableRows;return U?I=G.width:g.rules.weaponsFactory&&!I&&(I=G.width-1),G={x:g.tile.rx,y:g.tile.ry,width:(I||G.width)-1,height:G.height-1},W.rectContainsPoint(G,{x:P.rx,y:P.ry})}return!(g.isAircraft()||g.isInfantry()||g.isVehicle()||g.isSmudge()||g.isOverlay()&&(I&&g.isBridge()||!I&&g.isHighBridge()||g.isTiberium()||g.rules.crate||g.isBridgePlaceholder()))}findObstacles(g,P){var I,_,U=P.rules.speedType,G=P.isInfantry();let V=[];for(I of this.tileOccupation.getGroundObjectsOnTile(g.tile))I!==P&&((_=this.isBlockerObject(I,g.tile,!!g.onBridge,U,G))||I.isUnit()&&(I.tile===g.tile&&I.onBridge===!!g.onBridge||I.moveTrait.reservedPathNodes.find(P=>P.tile===g.tile&&!!P.onBridge==!!g.onBridge))||[L.SpeedType.Track,L.SpeedType.Hover].includes(U)&&I.rules.crushable||G&&I.isTerrain()||I.isBuilding()&&I.rules.gate)&&(_={obj:I,static:_},I.isInfantry()&&G?I.position.desiredSubCell===P.position.desiredSubCell&&V.push(_):I.isTerrain()&&G&&!I.rules.getOccupiedSubCells(this.theaterType).includes(P.position.desiredSubCell)||V.push(_));return V}dispose(){this.tileOccupation.onChange.unsubscribe(this.handleTileOccupationUpdate),this.mapBounds.onLocalResize.unsubscribe(this.handleMapBoundsResize)}})}}}),System.register("game/map/Tile",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("game/map/TileCollection",["game/type/LandType","engine/type/TerrainType","util/typeGuard"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){var P;(P=U||g("TileDirection",U={}))[P.Top=0]="Top",P[P.TopLeft=1]="TopLeft",P[P.TopRight=2]="TopRight",P[P.Left=3]="Left",P[P.Right=4]="Right",P[P.BottomLeft=5]="BottomLeft",P[P.Bottom=6]="Bottom",P[P.BottomRight=7]="BottomRight",g("TileCollection",class{constructor(g,P,_,U){this.tileSets=P,this.generalRules=_;let G=this.rSize={width:0,height:0},V=this.dSize={width:0,height:0};for(let P=0,I=g.length;P<I;++P)G.width=Math.max(G.width,g[P].rx),G.height=Math.max(G.height,g[P].ry),V.width=Math.max(V.width,g[P].dx),V.height=Math.max(V.height,g[P].dy);G.width++,G.height++,V.width++,V.height++;let W=this.tilesByRxy=new Array(G.width*G.height);W.fill(void 0);let z=this.tilesByDxy=new Array(V.width*V.height);z.fill(void 0);let K=this.tiles=new Array(g.length),q=[],$=this.bridgeSetTiles=[],Q=new Set(Object.values(L.TerrainType));this.minTileHeight=Number.POSITIVE_INFINITY;for(let _=this.maxTileHeight=0,se=g.length;_<se;++_){var Y=g[_],Z=P.getTileImage(Y.tileNum,Y.subTile,U),X=Z.terrainType;if(!Q.has(X))throw new Error(`Tile (${Y.rx}, ${Y.ry}) has unknown terrain type "${X}"`);var J={...Y,terrainType:X,landType:I.getLandType(X),onBridgeLandType:void 0,rampType:Z.rampType,id:Y.rx+"_"+Y.ry,occluded:!1},ee=J.rx,te=J.ry,re=J.dx;X=J.dy;K[_]=J,W[ee+te*G.width]=J,z[re+X*V.width]=J,this.minTileHeight=Math.min(this.minTileHeight,J.z),this.maxTileHeight=Math.max(this.maxTileHeight,J.z),4!==Z.height||J.terrainType!==L.TerrainType.Cliff&&!P.isCliffTile(J.tileNum)||q.push(J),P.isHighBridgeBoundaryTile(Y.tileNum)&&$.push(J)}this.computeLandBehindCliffTiles(q),this.cutoffTileHeight=this.computeCutoffTileHeight()}computeLandBehindCliffTiles(g){if(!(this.generalRules.cliffBackImpassability<2)){let P=[[-2,-2],[-1,-1],[-1,1],[1,-1],[0,1],[1,0]];g.forEach(g=>{for(var[_,U]of P){let P=this.getByMapCoords(g.rx+_,g.ry+U);P&&P.z<g.z&&P.terrainType!==L.TerrainType.Cliff&&P.terrainType!==L.TerrainType.Rough&&0===P.rampType&&(P.landType=I.LandType.Rock)}})}}getTileRadarColor(g){return this.tileSets.getTileImage(g.tileNum,g.subTile,()=>0).radarLeft.clone().multiplyScalar(.5)}getAll(){return[...this.tiles]}forEach(g){for(let P=0,I=this.tiles.length;P<I;++P)g(this.tiles[P],P)}reduce(g,P){let I=P;return this.forEach(P=>{I=g(I,P)}),I}getMinTileHeight(){return this.minTileHeight}getMaxTileHeight(){return this.maxTileHeight}getCutoffTileHeight(){return this.cutoffTileHeight}computeCutoffTileHeight(){var g=this.dSize.width-1;let P=this.dSize.height-1,I=0,L=!0;for(;L&&0<P;){for(let U=1;U<g-3;U++){var _=this.getByDisplayCoords(U,P);_&&(L=!1,_.z>I&&(I=_.z))}L&&P--}return I}getAllBridgeSetTiles(){return this.bridgeSetTiles}getAllNeighbourTiles(g){var P=g.rx,I=g.ry;return[this.getByMapCoords(P+1,I+1),this.getByMapCoords(P-1,I-1),this.getByMapCoords(P-1,I+1),this.getByMapCoords(P+1,I-1),this.getByMapCoords(P,I+1),this.getByMapCoords(P+1,I),this.getByMapCoords(P-1,I),this.getByMapCoords(P,I-1)].filter(_.isNotNullOrUndefined)}getNeighbourTile(g,P){var I=g.rx,L=g.ry;switch(P){case U.Bottom:return this.getByMapCoords(I+1,L+1);case U.Top:return this.getByMapCoords(I-1,L-1);case U.Left:return this.getByMapCoords(I-1,L+1);case U.Right:return this.getByMapCoords(I+1,L-1);case U.BottomLeft:return this.getByMapCoords(I,L+1);case U.BottomRight:return this.getByMapCoords(I+1,L);case U.TopLeft:return this.getByMapCoords(I-1,L);case U.TopRight:return this.getByMapCoords(I,L-1);default:throw new Error("Invalid direction")}}getByDisplayCoords(g,P){if(!(g>=this.dSize.width||P>=this.dSize.height))return this.tilesByDxy[g+P*this.dSize.width]}getByMapCoords(g,P){if(!(g>=this.rSize.width||P>=this.rSize.height))return this.tilesByRxy[g+P*this.rSize.width]}getMapSize(){return this.rSize}getDisplaySize(){return this.dSize}getInRectangle(g,P){let I,L,_,U;U=P?(I=g.rx,L=g.ry,_=P.width,P.height):(I=g.x,L=g.y,_=g.width,g.height);let G=[];for(let g=0;g<_;g++)for(let P=0;P<U;P++){var V=I+g,W=L+P;(W=this.getByMapCoords(V,W))&&G.push(W)}return G}getPlaceholderTile(g,P){var _;return{rx:g,ry:P,dx:g-P+(_=(_=this.tiles[0]).dx-_.rx+_.ry+1)-1,dy:g+P-_-1,z:0,id:g+"_"+P,landType:I.LandType.Rock,terrainType:L.TerrainType.Rock1,rampType:0,subTile:0,tileNum:0,occluded:!1,onBridgeLandType:void 0}}})}}}),System.register("game/map/tileFinder/CardinalTileFinder",["game/math/Vector2"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("CardinalTileFinder",class{constructor(g,P,L,_,U,G=()=>!0){this.tiles=g,this.mapBounds=P,this.startTile=L,this.maxDistance=U,this.predicate=G,this.dirVec=new I.Vector2(10,0),this.finished=!1,this.diagonal=!0,this.distance=_}getNextTile(){if(!this.finished){let P;do{let L={x:this.startTile.rx,y:this.startTile.ry};L.x+=this.distance*Math.sign(this.dirVec.x),L.y+=this.distance*Math.sign(this.dirVec.y),this.dirVec.rotateAround(new I.Vector2,Math.PI/4*(this.diagonal?1:2)).round();var g=this.tiles.getByMapCoords(L.x,L.y);if(g&&this.mapBounds.isWithinBounds(g)&&this.predicate(g)&&(P=g),!this.dirVec.angle()){if(this.maxDistance&&this.distance>=this.maxDistance)return this.finished=!0,P;this.distance++}}while(!P);return P}}})}}}),System.register("game/map/tileFinder/DirectionalTileFinder",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("DirectionalTileFinder",class{constructor(g,P,I,L,_,U,G,V=()=>!0,W=!0){this.tiles=g,this.mapBounds=P,this.startTile=I,this.maxDistance=_,this.dirX=U,this.dirY=G,this.predicate=V,this.checkBounds=W,this.finished=!1,this.distance=L}getNextTile(){if(!this.finished){let P;do{let I={x:this.startTile.rx,y:this.startTile.ry};I.x+=this.distance*Math.sign(this.dirX),I.y+=this.distance*Math.sign(this.dirY);var g=this.tiles.getByMapCoords(I.x,I.y);if(g&&(!this.checkBounds||this.mapBounds.isWithinBounds(g))&&this.predicate(g)&&(P=g),this.maxDistance&&this.distance>=this.maxDistance)return this.finished=!0,P}while(this.distance++,!P);return P}}})}}}),System.register("game/map/tileFinder/FloodTileFinder",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("FloodTileFinder",class{constructor(g,P,I,L,_,U=!0){this.tiles=g,this.mapBounds=P,this.startTile=I,this.areConnected=L,this.predicate=_,this.checkBounds=U,this.generator=this.generate()}getNextTile(){return this.generator.next().value}*generate(){let g=[this.startTile],P=new Set;for(;g.length;){var I,L=g.pop();if(!P.has(L))for(I of(P.add(L),this.checkBounds&&!this.mapBounds.isWithinBounds(L)||!this.predicate(L)||(yield L),this.tiles.getAllNeighbourTiles(L)))this.areConnected(I,L)&&g.push(I)}}})}}}),System.register("game/map/tileFinder/RadialBackFirstTileFinder",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("RadialBackFirstTileFinder",class{constructor(g,P,I,L,_,U,G,V=!0){this.tiles=g,this.mapBounds=P,this.startTile=I,this.foundation=L,this.maxDistance=U,this.predicate=G,this.checkBounds=V,this.distance=_,this.generator=this.generate()}getNextTile(){return this.generator.next().value}*generate(){var r=(g,P)=>{var I=this.tiles.getByMapCoords(g,P);if(I&&(!this.checkBounds||this.mapBounds.isWithinBounds(I))&&this.predicate(I))return I};do{var g=this.startTile.rx-this.distance,P=this.startTile.ry-this.distance,I=this.startTile.rx+this.foundation.width-1+this.distance,L=this.startTile.ry+this.foundation.height-1+this.distance;let _,U,G;if(0<this.distance){for(U=1+P;U<L;U++)G=r(g,U),G&&(yield G);for(_=g;_<I;_++)G=r(_,P),G&&(yield G);for(U=L-1;U>=P;U--)G=r(I,U),G&&(yield G);for(_=I;_>=g;_--)G=r(_,L),G&&(yield G)}else this.predicate(this.startTile)&&(yield this.startTile)}while(this.distance++,this.distance<=this.maxDistance)}})}}}),System.register("game/map/tileFinder/RadialTileFinder",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("RadialTileFinder",class{constructor(g,P,I,L,_,U,G,V=!0){this.tiles=g,this.mapBounds=P,this.startTile=I,this.foundation=L,this.maxDistance=U,this.predicate=G,this.checkBounds=V,this.distance=_,this.generator=this.generate()}getNextTile(){return this.generator.next().value}*generate(){var r=(g,P)=>{var I=this.tiles.getByMapCoords(g,P);if(I&&(!this.checkBounds||this.mapBounds.isWithinBounds(I))&&this.predicate(I))return I};do{var g=this.startTile.rx-this.distance,P=this.startTile.ry-this.distance,I=this.startTile.rx+this.foundation.width-1+this.distance,L=this.startTile.ry+this.foundation.height-1+this.distance;let _,U,G;if(0<this.distance){for(_=I;_>=g;_--)G=r(_,L),G&&(yield G);for(U=L-1;U>=P;U--)G=r(I,U),G&&(yield G);for(_=g;_<I;_++)G=r(_,P),G&&(yield G);for(U=1+P;U<L;U++)G=r(g,U),G&&(yield G)}else this.predicate(this.startTile)&&(yield this.startTile)}while(this.distance++,this.distance<=this.maxDistance)}})}}}),System.register("game/map/tileFinder/RandomTileFinder",["game/math/GameMath"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("RandomTileFinder",class{constructor(g,P,L,_,U,G,V=!1,W=!0){this.tiles=g,this.mapBounds=P,this.startTile=L,this.maxDistance=_,this.rng=U,this.predicate=G,this.includeStartTile=V,this.checkBounds=W,this.pool=[],this.pool=new Array(I.GameMath.pow(2*this.maxDistance+1,2)).fill(0).map((g,P)=>P),this.generator=this.generate()}getNextTile(){return this.generator.next().value}*generate(){for(var e=(g,P)=>{var I=this.tiles.getByMapCoords(g,P);if(this.includeStartTile||I!==this.startTile)return I&&(!this.checkBounds||this.mapBounds.isWithinBounds(I))&&this.predicate(I)?I:void 0},g=2*this.maxDistance+1;this.pool.length;){var P=1<this.pool.length?this.rng.generateRandomInt(0,this.pool.length):0,I=(P=(I=this.pool.splice(P,1)[0])%g,Math.floor(I/g));(I=e(this.startTile.rx-this.maxDistance+P,this.startTile.ry-this.maxDistance+I))&&(yield I)}}})}}}),System.register("game/map/TileOcclusion",["game/math/Vector2"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("TileOcclusion",class{constructor(g){this.tiles=g,this.tileOcclusion=[];let P=this.tileOcclusion;for(var I of g.getAll())P[I.rx]=P[I.rx]||[],P[I.rx][I.ry]=new Set}addOccluder(g){this.calculateTilesForGameObject(g).forEach(P=>this.occludeTile(P,g))}removeOccluder(g){this.calculateTilesForGameObject(g).forEach(P=>this.unoccludeTile(P,g))}calculateTilesForGameObject(g){var P=g.art.occupyHeight,L=Math.max(0,P-2);let _=[];var U=g.getFoundation();for(let g=1;g<=L;g++)for(let P=0;P<U.width;P++)_.push(new I.Vector2(P-g,-g));for(let g=1;g<=L;g++)for(let P=1;P<U.height;P++)_.push(new I.Vector2(-g,P-g));_.push(...g.art.addOccupy);for(let{x:P,y:I}of g.art.removeOccupy){var G=_.findIndex(g=>g.x===P&&g.y===I);-1!==G&&_.splice(G,1)}var V,W,z=g.tile;let K=[];for({x:V,y:W}of _){var q=this.tiles.getByMapCoords(z.rx+V,z.ry+W);q&&K.push(q)}return K}occludeTile(g,P){this.tileOcclusion[g.rx][g.ry].add(P),g.occluded=!0}unoccludeTile(g,P){let I=this.tileOcclusion[g.rx][g.ry];I.delete(P),g.occluded=0<I.size}isTileOccluded(g){return 0<this.tileOcclusion[g.rx][g.ry].size}})}}}),System.register("game/map/TileOccupation",["game/type/LandType","util/event","game/gameobject/unit/ZoneType"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){var P;(P=U||g("LayerType",U={}))[P.All=0]="All",P[P.Ground=1]="Ground",P[P.Air=2]="Air",g("TileOccupation",class{get onChange(){return this._onChange.asEvent()}constructor(g){this.tiles=g,this.tileOccupation=[],this.emptyTiles=new Set,this._onChange=new L.EventDispatcher;let P=this.tileOccupation;for(var I of g.getAll())P[I.rx]=P[I.rx]||[],P[I.rx][I.ry]=new Set,this.emptyTiles.add(I)}occupyTileRange(g,P){let I=this.calculateTilesForGameObject(g,P);I.forEach(g=>this.occupyTile(g,P)),this._onChange.dispatch(this,{tiles:I,object:P,type:"added"})}unoccupyTileRange(g,P){let I=this.calculateTilesForGameObject(g,P);I.forEach(g=>this.unoccupyTile(g,P)),this._onChange.dispatch(this,{tiles:I,object:P,type:"removed"})}occupySingleTile(g,P){this.occupyTile(g,P),this._onChange.dispatch(this,{tiles:[g],object:P,type:"added"})}unoccupySingleTile(g,P){this.unoccupyTile(g,P),this._onChange.dispatch(this,{tiles:[g],object:P,type:"removed"})}calculateTilesForGameObject(g,P){return this.tiles.getInRectangle(g,P.getFoundation())}occupyTile(g,P){let I=this.tileOccupation[g.rx]?.[g.ry];I&&(I.add(P),this.emptyTiles.delete(g),g.landType=this.computeTileLandType(g),g.onBridgeLandType=this.computeOnBridgeLandType(g))}unoccupyTile(g,P){let I=this.tileOccupation[g.rx]?.[g.ry];I&&(I.delete(P),I.size||this.emptyTiles.add(g),g.landType=this.computeTileLandType(g),g.onBridgeLandType=this.computeOnBridgeLandType(g))}isTileOccupiedBy(g,P){return!!this.tileOccupation[g.rx]?.[g.ry]?.has(P)}computeTileLandType(g){if(g.landType===I.LandType.Rock)return I.LandType.Rock;var P,L=I.getLandType(g.terrainType);for(P of this.tileOccupation[g.rx]?.[g.ry]??[]){if(P.isBuilding()&&P.rules.wall)return I.LandType.Wall;if(P.isOverlay()&&!P.isBridge()&&!P.isBridgePlaceholder()&&P.getLandType()!==I.LandType.Clear)return P.getLandType()}return L}computeOnBridgeLandType(g){for(var P of this.tileOccupation[g.rx]?.[g.ry]??[])if(P.isOverlay()&&P.isBridge())return P.getLandType()}getTileZone(g,P=!1){return _.getZoneType(P?g.landType:g.onBridgeLandType??g.landType)}getBridgeOnTile(g){for(var P of this.tileOccupation[g.rx]?.[g.ry]??[])if(P.isOverlay()&&P.isBridge())return P}getObjectsOnTile(g){return[...this.tileOccupation[g.rx]?.[g.ry]??[]]}getGroundObjectsOnTile(g){let P=[];for(var I of this.tileOccupation[g.rx]?.[g.ry]??[])I.isTechno()&&!I.isBuilding()&&I.zone===_.ZoneType.Air||P.push(I);return P}getAirObjectsOnTile(g){let P=[];for(var I of this.tileOccupation[g.rx]?.[g.ry]??[])I.isUnit()&&I.zone===_.ZoneType.Air&&P.push(I);return P}getObjectsOnTileByLayer(g,P){if(P===U.Ground)return this.getGroundObjectsOnTile(g);if(P===U.Air)return this.getAirObjectsOnTile(g);if(P===U.All)return this.getObjectsOnTile(g);throw new Error(`Unhandled layer type "${P}"`)}getEmptyTiles(){return[...this.emptyTiles]}})}}}),System.register("game/map/wallTypes",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("wallTypes",[[0,0,0,0],[1,0,0,0],[0,1,0,0],[1,1,0,0],[0,0,1,0],[1,0,1,0],[0,1,1,0],[1,1,1,0],[0,0,0,1],[1,0,0,1],[0,1,0,1],[1,1,0,1],[0,0,1,1],[1,0,1,1],[0,1,1,1],[1,1,1,1]])}}}),System.register("game/math/Box2",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){I=class extends THREE.Box2{},g("Box2",I)}}}),System.register("game/math/CubicBezierCurve3",["game/math/Vector3"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends THREE.CubicBezierCurve3{constructor(g,P,L,_){super(g||new I.Vector3,P||new I.Vector3,L||new I.Vector3,_||new I.Vector3)}getPoint(g,P){return super.getPoint(g,P||new I.Vector3)}},g("CubicBezierCurve3",L)}}}),System.register("game/math/CurvePath",["game/math/LineCurve"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends THREE.CurvePath{closePath(){let g=this.curves[0].getPoint(0);var P=this.curves[this.curves.length-1].getPoint(1);g.equals(P)||this.curves.push(new I.LineCurve(P,g))}},g("CurvePath",L)}}}),System.register("game/math/Cylindrical",["game/math/GameMath"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends THREE.Cylindrical{setFromVector3(g){return this.radius=I.GameMath.sqrt(g.x*g.x+g.z*g.z),this.theta=I.GameMath.atan2(g.x,g.z),this.y=g.y,this}},g("Cylindrical",L)}}}),System.register("game/math/Euler",["util/math","game/math/GameMath","game/math/Quaternion","game/math/Vector3"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=class extends THREE.Euler{constructor(){super(...arguments),this.isEuler=!0}setFromRotationMatrix(g,P,_){var U=(Q=g.elements)[0],G=Q[4],V=Q[8],W=Q[1],z=Q[5],K=Q[9],q=Q[2],$=Q[6],Q=Q[10];return"XYZ"===(P=P||this._order)?(this._y=L.GameMath.asin(I.clamp(V,-1,1)),Math.abs(V)<.99999?(this._x=L.GameMath.atan2(-K,Q),this._z=L.GameMath.atan2(-G,U)):(this._x=L.GameMath.atan2($,z),this._z=0)):"YXZ"===P?(this._x=L.GameMath.asin(-I.clamp(K,-1,1)),Math.abs(K)<.99999?(this._y=L.GameMath.atan2(V,Q),this._z=L.GameMath.atan2(W,z)):(this._y=L.GameMath.atan2(-q,U),this._z=0)):"ZXY"===P?(this._x=L.GameMath.asin(I.clamp($,-1,1)),Math.abs($)<.99999?(this._y=L.GameMath.atan2(-q,Q),this._z=L.GameMath.atan2(-G,z)):(this._y=0,this._z=L.GameMath.atan2(W,U))):"ZYX"===P?(this._y=L.GameMath.asin(-I.clamp(q,-1,1)),Math.abs(q)<.99999?(this._x=L.GameMath.atan2($,Q),this._z=L.GameMath.atan2(W,U)):(this._x=0,this._z=L.GameMath.atan2(-G,z))):"YZX"===P?(this._z=L.GameMath.asin(I.clamp(W,-1,1)),Math.abs(W)<.99999?(this._x=L.GameMath.atan2(-K,z),this._y=L.GameMath.atan2(-q,U)):(this._x=0,this._y=L.GameMath.atan2(V,Q))):"XZY"===P?(this._z=L.GameMath.asin(-I.clamp(G,-1,1)),Math.abs(G)<.99999?(this._x=L.GameMath.atan2($,z),this._y=L.GameMath.atan2(V,U)):(this._x=L.GameMath.atan2(-K,Q),this._y=0)):console.warn("THREE.Euler: .setFromRotationMatrix() given unsupported order: "+P),this._order=P,!1!==_&&this.onChangeCallback(),this}reorder(g){return V.setFromEuler(this),this.setFromQuaternion(V,g)}toVector3(g){return g?g.set(this._x,this._y,this._z):new U.Vector3(this._x,this._y,this._z)}},g("Euler",G),V=new _.Quaternion}}}),System.register("game/math/GameMath",["util/math"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("GameMath",L=class{static reverseSinTableLookup(g,P,I,L){for(;P<=I;){var _=Math.floor((P+I)/2),U=this.SIN_TABLE[_];if(U===g)return _;(L?g<U:U<g)?P=_+1:I=_-1}return Math.abs(g-this.SIN_TABLE[P])<Math.abs(g-this.SIN_TABLE[I])?P:I}static pow(g,P){if(!Number.isFinite(g)||!Number.isFinite(P)||Number.isSafeInteger(g)&&Number.isSafeInteger(P))return g**P;if(!Number.isSafeInteger(P))throw new Error("Exponent must be a safe integer");return Math.floor(g*this.EXP_10_PRECISION)**P/this.EXP_10_PRECISION**P}static sqrt(g){if(0===g)return 0;var P;let I=g/3;for(;P=I,I=(g/I+I)/2,5e-15<Math.abs(P-I););return I}static sin(g){if(!Number.isFinite(g))return NaN;if(!g)return g;var P=g/(2*Math.PI)-Math.floor(g/(2*Math.PI));P=Math.floor(P*this.SIN_TABLE.length);return this.SIN_TABLE[P]}static cos(g){return this.sin(g+Math.PI/2)}static asin(g){if(!I.isBetween(g,-1,1))return NaN;if(!g)return 0;let P;var L=this.SIN_TABLE.length;return P=0<g?2*Math.PI*this.reverseSinTableLookup(g,0,L/4,!1)/L:Math.PI-2*Math.PI*this.reverseSinTableLookup(g,L/2,.75*L,!0)/L,P}static acos(g){return Math.PI/2-this.asin(g)}static atan2(g,P){if(Number.isNaN(P)||Number.isNaN(g))return NaN;let I;return I=Number.isFinite(g)||Number.isFinite(P)?Number.isFinite(P)&&0!==g?Number.isFinite(g)&&0!==P?this.atan2FiniteNonZero(g,P):this.signIncZero(g)*Math.PI*.5:this.signIncZero(g)*(this.signIncZero(P)<0?Math.PI:0):Math.sign(g)*Math.PI*(0<Math.sign(P)?.25:.75),I}static atan2FiniteNonZero(g,P){var I=Math.abs(P),L=Math.abs(g),_=Math.min(I,L)/Math.max(I,L),U=_*_;let G=((-.0464964749*U+.15931422)*U-.327622764)*U*_+_;return I<L&&(G=Math.PI/2-G),P<0&&(G=Math.PI-G),g<0&&(G=-G),G}static signIncZero(g){return g===-1/0||1/g<0?-1:1}}),L.PRECISION=6,L.EXP_10_PRECISION=10**L.PRECISION,L.SIN_TABLE=[0,.004848117819001859,.009696121685978396,.014543897651582654,.01939133177182437,.024238310110748135,.0290847187431114,.03393044375706223,.03877537125681671,.043619387365336,.04846237822700296,.05330423001029823,.05814482891047582,.06298406115223795,.06782181299240934,.0726579707226106,.07749242067193093,.08232504920959989,.08715574274765817,.09198438774362744,.09681087070317909,.10163507818280187,.10645689679246824,.11127621319829964,.11609291412523022,.12090688635966935,.12571801675216268,.13052619222005157,.13533129975013108,.14013322640130627,.14493185930724672,.1497270856790396,.15451879280784048,.15930686806752256,.16409119891732396,.1688716729044928,.17364817766693033,.17842060093583212,.18318883053832663,.18795275440011186,.19271226054808968,.19746723711299752,.20221757233203794,.20696315455150538,.2117038722294107,.21643961393810288,.22117026836688775,.2258957243246448,.23061587074244014,.2353305966761376,.24003979130900588,.2447433439543238,.24944114405798126,.25413308120107847,.25881904510252074,.26349892562161076,.2681726127606373,.272839996667461,.27750096763809573,.28215541611928774,.2868032327110902,.29144430816943495,.2960785334086999,.3007057995042731,.3053259976951131,.30993901938630514,.31454475615161365,.31914309973603083,.323733942058321,.328317175213561,.33289269147567657,.3374603832999741,.3420201433256687,.34657186437840753,.3511154394727888,.3556507618148765,.3601777248047104,.36469622203881186,.3692061473126844,.3737073946233105,.3781998581716425,.3826834323650898,.3871580118200006,.3916234913641391,.3960797660391568,.4005267311030606,.4049642820326736,.4093923145260926,.4138107245051391,.4182194081178064,.42261826174069944,.4270071819814715,.4313860656812534,.4357548099170794,.4401133120043048,.44446146949902104,.4487991802004621,.4531263421534082,.4574428536505808,.4617486132350339,.46604351970253877,.4703274721039625,.4746003697476404,.4788621122017435,.4831125992966384,.48735173112724234,.49157940805537054,.49579553071207916,.49999999999999994,.5041927170956704,.5083735834518556,.5125425007998652,.5166993711518628,.5208440968031697,.5249765803345602,.5290967246145525,.5332044328016912,.5372996083468239,.5413821549953696,.5454519767895825,.549508978070806,.5535530634817223,.5575841379685927,.5616021067834929,.5656068754865385,.5695983499481065,.573576436351046,.5775410411928851,.5814920712880266,.5854294337699405,.5893530360933448,.593262786036382,.5971585917027862,.6010403615240428,.6049080042615417,.6087614290087207,.6126005451932028,.6164252625789254,.62023549126826,.6240311417041269,.6278121246720986,.6315783513024975,.6353297330724851,.6390661818081416,.6427876096865393,.6464939292378065,.6501850533471834,.6538608952570697,.6575213685690636,.6611663872459932,.6647958656139378,.6684097183642425,.6720078605555224,.6755902076156601,.6791566753437932,.6827071799122926,.6862416378687335,.6897599661378576,.6932620820235242,.696747903210655,.7002173477671685,.7036703341459059,.7071067811865475,.710526608117521,.713929734557899,.7173160805192894,.7206855664077146,.7240381130254825,.7273736415730487,.7306920736508674,.7339933312612352,.7372773368101241,.7405440131090046,.7437932833766612,.747025071240996,.7502393007408245,.7534358963276606,.7566147828674927,.7597758856425494,.7629191303530553,.766044443118978,.7691517504817651,.7722409794060692,.7753120572814658,.7783649119241599,.7813994715786823,.7844156649195757,.7874134210530723,.7903926695187593,.7933533402912352,.7962953637817558,.7992186708398696,.8021231927550437,.8050088612582783,.8078756085237111,.8107233671702122,.8135520702629676,.8163616513150519,.8191520442889918,.821923183598318,.8246750041091067,.8274074411415104,.8301204304712788,.8328139083312671,.8354878114129364,.8381420768678404,.8407766423091032,.8433914458128856,.845986425919841,.848561521636559,.8511166724369997,.8536518182639162,.8561668995302665,.8586618571206132,.8611366323925137,.8635911671778986,.8660254037844386,.8684392849969005,.870832754078492,.8732057547721958,.8755582313020908,.8778901283746645,.8802013911801111,.8824919653936212,.8847617971766577,.8870108331782216,.8892390205361062,.8914463068781385,.8936326403234122,.8957979694835052,.8979422434636881,.9000654118641211,.9021674247810376,.9042482328079179,.9063077870366499,.9083460390586793,.9103629409661466,.9123584453530141,.9143325053161794,.9162850744565779,.918216106880274,.9201255571995389,.9220133805339185,.9238795325112867,.9257239692688903,.9275466474543786,.9293475242268224,.9311265572577219,.9328837047320004,.9346189253489884,.9363321783233931,.9380234233862578,.9396926207859083,.9413397312888874,.942964716180876,.9445675372676047,.9461481568757504,.947706537853822,.9492426435730339,.9507564379281666,.9522478853384153,.9537169507482269,.955163599628123,.9565877979755122,.9579895123154889,.9593687097016201,.9607253577167205,.9620594244736131,.9633708786158803,.9646596893185995,.9659258262890683,.9671692597675166,.9683899605278059,.969587899878116,.97076304966162,.9719153822571454,.9730448705798238,.9741514880817275,.9752352087524931,.9762960071199334,.9773338582506355,.9783487377505475,.9793406217655515,.980309486982024,.9812553106273847,.9821780704706308,.98307774482286,.9839543125377807,.984807753012208,.9856380461865492,.9864451725452739,.987229113117374,.987989849476809,.9887273637429388,.9894416385809445,.9901326572022359,.9908004033648453,.9914448613738104,.9920660160815423,.9926638528881819,.993238357741943,.9937895171394426,.9943173181260184,.9948217482960331,.9953027957931658,.9957604493106914,.9961946980917455,.9966055319295779,.996992941167792,.9973569167005722,.9976974499728977,.9980145329807433,.9983081582712682,.9985783189429907,.9988250086459504,.9990482215818578,.99924795250423,.9994241967185149,.9995769500822006,.9997062090049132,.9998119704485015,.9998942319271075,.9999529915072262,.9999882478077495,1,.9999882478077495,.9999529915072262,.9998942319271075,.9998119704485015,.9997062090049132,.9995769500822006,.9994241967185149,.99924795250423,.9990482215818578,.9988250086459504,.9985783189429907,.9983081582712682,.9980145329807433,.9976974499728977,.9973569167005722,.996992941167792,.9966055319295779,.9961946980917455,.9957604493106914,.9953027957931658,.9948217482960331,.9943173181260184,.9937895171394426,.993238357741943,.9926638528881819,.9920660160815423,.9914448613738105,.9908004033648453,.9901326572022359,.9894416385809446,.9887273637429388,.987989849476809,.987229113117374,.9864451725452739,.9856380461865492,.984807753012208,.9839543125377807,.98307774482286,.9821780704706307,.9812553106273847,.9803094869820241,.9793406217655516,.9783487377505476,.9773338582506356,.9762960071199334,.9752352087524931,.9741514880817276,.9730448705798238,.9719153822571455,.9707630496616201,.969587899878116,.9683899605278059,.9671692597675166,.9659258262890683,.9646596893185995,.9633708786158803,.9620594244736133,.9607253577167205,.9593687097016202,.9579895123154889,.9565877979755123,.9551635996281231,.9537169507482269,.9522478853384153,.9507564379281666,.949242643573034,.9477065378538221,.9461481568757505,.9445675372676048,.942964716180876,.9413397312888873,.9396926207859084,.9380234233862579,.9363321783233931,.9346189253489885,.9328837047320006,.9311265572577219,.9293475242268225,.9275466474543786,.9257239692688904,.9238795325112867,.9220133805339185,.920125557199539,.918216106880274,.916285074456578,.9143325053161794,.9123584453530141,.9103629409661467,.9083460390586793,.90630778703665,.904248232807918,.9021674247810377,.9000654118641213,.8979422434636883,.8957979694835051,.8936326403234123,.8914463068781386,.8892390205361062,.8870108331782218,.8847617971766579,.8824919653936212,.8802013911801111,.8778901283746644,.8755582313020909,.8732057547721958,.8708327540784921,.8684392849969006,.8660254037844387,.8635911671778987,.8611366323925138,.858661857120613,.8561668995302665,.8536518182639163,.8511166724369997,.8485615216365591,.8459864259198412,.8433914458128856,.8407766423091031,.8381420768678404,.8354878114129364,.8328139083312672,.8301204304712789,.8274074411415107,.8246750041091069,.8219231835983182,.819152044288992,.8163616513150518,.8135520702629675,.8107233671702123,.8078756085237112,.8050088612582784,.802123192755044,.7992186708398695,.7962953637817556,.7933533402912352,.7903926695187593,.7874134210530723,.7844156649195758,.7813994715786824,.7783649119241601,.775312057281466,.7722409794060693,.769151750481765,.766044443118978,.7629191303530551,.7597758856425494,.756614782867493,.7534358963276608,.7502393007408243,.7470250712409959,.7437932833766611,.7405440131090045,.7372773368101241,.7339933312612353,.7306920736508675,.7273736415730488,.7240381130254827,.7206855664077148,.7173160805192896,.713929734557899,.710526608117521,.7071067811865476,.703670334145906,.7002173477671687,.6967479032106549,.6932620820235241,.6897599661378576,.6862416378687336,.6827071799122926,.6791566753437933,.6755902076156604,.6720078605555225,.6684097183642426,.6647958656139381,.6611663872459935,.6575213685690636,.6538608952570697,.6501850533471835,.6464939292378067,.6427876096865395,.6390661818081418,.635329733072485,.6315783513024975,.6278121246720986,.6240311417041269,.6202354912682602,.6164252625789255,.612600545193203,.6087614290087209,.6049080042615419,.6010403615240432,.5971585917027862,.593262786036382,.5893530360933449,.5854294337699406,.5814920712880268,.5775410411928852,.5735764363510459,.5695983499481064,.5656068754865385,.5616021067834929,.5575841379685929,.5535530634817224,.5495089780708062,.5454519767895827,.5413821549953699,.5372996083468241,.5332044328016912,.5290967246145525,.5249765803345602,.5208440968031698,.516699371151863,.5125425007998654,.5083735834518555,.5041927170956703,.49999999999999994,.49579553071207916,.49157940805537065,.48735173112724245,.48311259929663863,.4788621122017437,.47460036974764064,.47032747210396275,.46604351970253877,.4617486132350339,.45744285365058085,.4531263421534083,.44879918020046233,.4444614694990212,.4401133120043047,.43575480991707927,.43138606568125343,.4270071819814714,.4226182617406995,.4182194081178065,.4138107245051393,.40939231452609276,.4049642820326738,.40052673110306086,.3960797660391572,.39162349136413904,.38715801182000065,.3826834323650899,.37819985817164264,.3737073946233107,.3692061473126843,.36469622203881175,.3601777248047104,.3556507618148765,.35111543947278884,.34657186437840765,.3420201433256689,.3374603832999743,.33289269147567685,.32831717521356135,.3237339420583214,.31914309973603083,.3145447561516137,.30993901938630525,.30532599769511326,.30070579950427334,.29607853340870016,.2914443081694349,.2868032327110902,.28215541611928774,.2775009676380958,.2728399966674611,.26817261276063753,.263498925621611,.258819045102521,.2541330812010788,.24944114405798165,.24474334395432376,.24003979130900596,.2353305966761377,.23061587074244033,.225895724324645,.22117026836688802,.21643961393810274,.21170387222941067,.20696315455150538,.20221757233203796,.19746723711299763,.19271226054808982,.18795275440011205,.18318883053832688,.17842060093583242,.17364817766693072,.16887167290449276,.16409119891732402,.15930686806752267,.15451879280784062,.1497270856790398,.14493185930724697,.14013322640130613,.135331299750131,.13052619222005157,.12571801675216274,.12090688635966945,.11609291412523036,.11127621319829985,.1064568967924685,.10163507818280217,.09681087070317945,.09198438774362741,.0871557427476582,.08232504920959997,.07749242067193107,.07265797072261079,.0678218129924096,.06298406115223781,.05814482891047573,.0533042300102982,.04846237822700297,.04361938736533607,.038775371256816835,.03393044375706242,.029084718743111644,.02423831011074843,.01939133177182472,.014543897651583058,.009696121685978408,.004848117819001927,12246467991473532e-32,-.004848117819001238,-.009696121685978163,-.01454389765158237,-.019391331771824474,-.02423831011074774,-.029084718743111398,-.03393044375706173,-.03877537125681659,-.04361938736533583,-.048462378227003174,-.05330423001029795,-.05814482891047593,-.06298406115223758,-.06782181299240934,-.07265797072261056,-.07749242067193128,-.08232504920959974,-.08715574274765794,-.09198438774362716,-.09681087070317876,-.10163507818280193,-.10645689679246781,-.1112762131982996,-.11609291412523012,-.12090688635966965,-.1257180167521625,-.13052619222005177,-.13533129975013078,-.14013322640130632,-.14493185930724675,-.14972708567904,-.1545187928078404,-.15930686806752198,-.16409119891732377,-.16887167290449254,-.17364817766693047,-.17842060093583176,-.18318883053832663,-.1879527544001114,-.1927122605480896,-.19746723711299738,-.20221757233203816,-.20696315455150513,-.21170387222941087,-.21643961393810252,-.2211702683668878,-.22589572432464475,-.23061587074244053,-.23533059667613745,-.2400397913090053,-.2447433439543235,-.24944114405798098,-.2541330812010786,-.25881904510252035,-.2634989256216107,-.26817261276063686,-.2728399966674609,-.27750096763809556,-.2821554161192879,-.28680323271108993,-.29144430816943506,-.29607853340869994,-.30070579950427306,-.30532599769511304,-.3099390193863046,-.3145447561516135,-.3191430997360306,-.3237339420583211,-.3283171752135607,-.33289269147567657,-.3374603832999737,-.34202014332566866,-.3465718643784074,-.35111543947278906,-.35565076181487626,-.36017772480471055,-.3646962220388115,-.3692061473126845,-.3737073946233105,-.3781998581716428,-.38268343236508967,-.38715801182000004,-.3916234913641388,-.39607976603915657,-.40052673110306064,-.4049642820326732,-.40939231452609254,-.41381072450513867,-.4182194081178062,-.4226182617406993,-.4270071819814716,-.4313860656812532,-.43575480991707943,-.4401133120043045,-.444461469499021,-.4487991802004621,-.4531263421534085,-.4574428536505806,-.46174861323503374,-.46604351970253854,-.47032747210396214,-.4746003697476404,-.47886211220174313,-.4831125992966384,-.4873517311272422,-.4915794080553708,-.49579553071207894,-.5000000000000001,-.50419271709567,-.5083735834518556,-.5125425007998652,-.5166993711518633,-.5208440968031696,-.5249765803345596,-.5290967246145523,-.533204432801691,-.5372996083468239,-.5413821549953693,-.5454519767895825,-.5495089780708056,-.5535530634817222,-.5575841379685926,-.5616021067834931,-.5656068754865384,-.5695983499481065,-.5735764363510458,-.577541041192885,-.5814920712880266,-.5854294337699408,-.5893530360933448,-.5932627860363815,-.597158591702786,-.6010403615240426,-.6049080042615417,-.6087614290087203,-.6126005451932028,-.6164252625789249,-.6202354912682599,-.6240311417041268,-.6278121246720987,-.6315783513024973,-.6353297330724852,-.6390661818081416,-.6427876096865393,-.6464939292378065,-.6501850533471829,-.6538608952570695,-.6575213685690635,-.6611663872459933,-.6647958656139376,-.6684097183642425,-.6720078605555221,-.6755902076156601,-.6791566753437931,-.6827071799122927,-.6862416378687334,-.6897599661378577,-.693262082023524,-.696747903210655,-.7002173477671685,-.7036703341459061,-.7071067811865475,-.7105266081175206,-.7139297345578989,-.7173160805192892,-.7206855664077146,-.7240381130254823,-.7273736415730487,-.7306920736508671,-.7339933312612352,-.737277336810124,-.7405440131090048,-.743793283376661,-.747025071240996,-.7502393007408242,-.7534358963276607,-.7566147828674927,-.7597758856425493,-.7629191303530554,-.7660444431189779,-.7691517504817651,-.7722409794060688,-.7753120572814659,-.7783649119241597,-.7813994715786822,-.7844156649195754,-.7874134210530722,-.7903926695187589,-.7933533402912349,-.7962953637817558,-.79921867083987,-.8021231927550437,-.8050088612582785,-.8078756085237111,-.8107233671702119,-.8135520702629674,-.8163616513150515,-.8191520442889916,-.8219231835983181,-.8246750041091064,-.8274074411415104,-.830120430471279,-.8328139083312671,-.8354878114129365,-.8381420768678401,-.8407766423091032,-.8433914458128855,-.8459864259198411,-.8485615216365587,-.8511166724369996,-.8536518182639165,-.8561668995302664,-.8586618571206132,-.8611366323925135,-.8635911671778986,-.8660254037844385,-.8684392849969005,-.8708327540784918,-.8732057547721956,-.8755582313020905,-.8778901283746643,-.8802013911801112,-.8824919653936215,-.8847617971766578,-.8870108331782218,-.889239020536106,-.8914463068781383,-.8936326403234122,-.8957979694835049,-.897942243463688,-.9000654118641208,-.9021674247810375,-.9042482328079179,-.90630778703665,-.9083460390586792,-.9103629409661468,-.912358445353014,-.9143325053161795,-.9162850744565778,-.918216106880274,-.9201255571995388,-.9220133805339183,-.9238795325112865,-.9257239692688903,-.9275466474543786,-.9293475242268223,-.9311265572577219,-.9328837047320003,-.9346189253489884,-.9363321783233929,-.9380234233862578,-.9396926207859082,-.9413397312888873,-.9429647161808761,-.9445675372676049,-.9461481568757504,-.9477065378538222,-.9492426435730339,-.9507564379281666,-.9522478853384153,-.9537169507482267,-.9551635996281229,-.956587797975512,-.9579895123154888,-.9593687097016201,-.9607253577167205,-.9620594244736131,-.9633708786158804,-.9646596893185994,-.9659258262890683,-.9671692597675166,-.9683899605278059,-.9695878998781159,-.97076304966162,-.9719153822571452,-.9730448705798238,-.9741514880817276,-.975235208752493,-.9762960071199334,-.9773338582506355,-.9783487377505475,-.9793406217655514,-.980309486982024,-.9812553106273846,-.9821780704706307,-.98307774482286,-.9839543125377805,-.984807753012208,-.9856380461865493,-.9864451725452739,-.9872291131173742,-.9879898494768089,-.9887273637429387,-.9894416385809445,-.9901326572022358,-.9908004033648452,-.9914448613738104,-.9920660160815423,-.9926638528881818,-.993238357741943,-.9937895171394426,-.9943173181260184,-.994821748296033,-.9953027957931658,-.9957604493106913,-.9961946980917455,-.9966055319295779,-.996992941167792,-.9973569167005722,-.9976974499728977,-.9980145329807433,-.9983081582712682,-.9985783189429907,-.9988250086459504,-.9990482215818578,-.99924795250423,-.9994241967185149,-.9995769500822006,-.9997062090049132,-.9998119704485015,-.9998942319271076,-.9999529915072262,-.9999882478077495,-1,-.9999882478077495,-.9999529915072262,-.9998942319271076,-.9998119704485015,-.9997062090049132,-.9995769500822006,-.9994241967185149,-.99924795250423,-.9990482215818578,-.9988250086459504,-.9985783189429907,-.9983081582712682,-.9980145329807433,-.9976974499728977,-.9973569167005724,-.996992941167792,-.9966055319295779,-.9961946980917455,-.9957604493106914,-.9953027957931658,-.9948217482960331,-.9943173181260185,-.9937895171394426,-.993238357741943,-.9926638528881819,-.9920660160815424,-.9914448613738105,-.9908004033648453,-.9901326572022358,-.9894416385809446,-.9887273637429387,-.987989849476809,-.9872291131173742,-.986445172545274,-.9856380461865493,-.9848077530122081,-.9839543125377807,-.9830777448228601,-.9821780704706308,-.9812553106273846,-.9803094869820241,-.9793406217655515,-.9783487377505476,-.9773338582506355,-.9762960071199335,-.9752352087524931,-.9741514880817276,-.9730448705798239,-.9719153822571454,-.9707630496616201,-.969587899878116,-.968389960527806,-.9671692597675167,-.9659258262890684,-.9646596893185995,-.9633708786158806,-.9620594244736133,-.9607253577167206,-.9593687097016202,-.9579895123154889,-.9565877979755121,-.955163599628123,-.9537169507482268,-.9522478853384154,-.9507564379281668,-.949242643573034,-.9477065378538223,-.9461481568757506,-.944567537267605,-.9429647161808762,-.9413397312888874,-.9396926207859083,-.9380234233862579,-.936332178323393,-.9346189253489885,-.9328837047320004,-.9311265572577221,-.9293475242268224,-.9275466474543788,-.9257239692688904,-.9238795325112866,-.9220133805339186,-.9201255571995389,-.9182161068802742,-.9162850744565779,-.9143325053161796,-.9123584453530141,-.9103629409661469,-.9083460390586794,-.9063077870366503,-.9042482328079181,-.9021674247810376,-.9000654118641209,-.8979422434636882,-.895797969483505,-.8936326403234123,-.8914463068781384,-.8892390205361063,-.887010833178222,-.8847617971766579,-.8824919653936216,-.8802013911801113,-.8778901283746645,-.8755582313020907,-.8732057547721959,-.870832754078492,-.8684392849969007,-.8660254037844386,-.8635911671778989,-.8611366323925137,-.8586618571206134,-.8561668995302666,-.8536518182639167,-.8511166724369998,-.848561521636559,-.8459864259198413,-.8433914458128857,-.8407766423091034,-.8381420768678404,-.8354878114129367,-.8328139083312672,-.8301204304712791,-.8274074411415107,-.8246750041091067,-.8219231835983183,-.8191520442889918,-.8163616513150517,-.8135520702629676,-.8107233671702121,-.8078756085237113,-.8050088612582788,-.802123192755044,-.7992186708398701,-.796295363781756,-.7933533402912352,-.7903926695187591,-.7874134210530724,-.7844156649195756,-.7813994715786825,-.7783649119241599,-.7753120572814661,-.7722409794060691,-.7691517504817653,-.7660444431189781,-.7629191303530556,-.7597758856425495,-.7566147828674927,-.753435896327661,-.7502393007408246,-.7470250712409963,-.7437932833766612,-.740544013109005,-.7372773368101242,-.7339933312612357,-.7306920736508676,-.7273736415730492,-.7240381130254828,-.7206855664077145,-.7173160805192891,-.7139297345578991,-.7105266081175208,-.7071067811865477,-.7036703341459063,-.7002173477671687,-.6967479032106556,-.6932620820235246,-.6897599661378577,-.6862416378687334,-.6827071799122926,-.679156675343793,-.6755902076156605,-.6720078605555223,-.6684097183642427,-.6647958656139378,-.6611663872459935,-.6575213685690637,-.6538608952570701,-.6501850533471836,-.6464939292378064,-.6427876096865396,-.6390661818081416,-.6353297330724854,-.6315783513024976,-.627812124672099,-.624031141704127,-.6202354912682606,-.6164252625789255,-.6126005451932034,-.6087614290087209,-.6049080042615417,-.6010403615240425,-.5971585917027863,-.5932627860363818,-.589353036093345,-.585429433769941,-.5814920712880269,-.5775410411928856,-.5735764363510465,-.5695983499481065,-.5656068754865391,-.561602106783493,-.5575841379685926,-.5535530634817225,-.5495089780708059,-.5454519767895828,-.5413821549953696,-.5372996083468242,-.5332044328016913,-.5290967246145529,-.5249765803345603,-.5208440968031696,-.5166993711518632,-.5125425007998651,-.5083735834518559,-.5041927170956704,-.5000000000000004,-.49579553071207927,-.49157940805537115,-.48735173112724256,-.48311259929663913,-.4788621122017438,-.47460036974764036,-.4703274721039621,-.4660435197025389,-.46174861323503363,-.45744285365058096,-.4531263421534088,-.44879918020046244,-.4444614694990217,-.4401133120043052,-.43575480991708015,-.4313860656812539,-.42700718198147153,-.4226182617406992,-.4182194081178066,-.413810724505139,-.40939231452609287,-.40496428203267354,-.400526731103061,-.3960797660391569,-.39162349136413954,-.38715801182000076,-.3826834323650904,-.37819985817164276,-.3737073946233104,-.3692061473126848,-.36469622203881186,-.3601777248047109,-.3556507618148766,-.3511154394727894,-.34657186437840776,-.34202014332566943,-.3374603832999744,-.3328926914756765,-.32831717521356063,-.32373394205832107,-.31914309973603056,-.3145447561516138,-.3099390193863049,-.30532599769511337,-.30070579950427384,-.2960785334087003,-.29144430816943584,-.2868032327110907,-.28215541611928785,-.2775009676380955,-.2728399966674612,-.2681726127606372,-.2634989256216111,-.2588190451025207,-.2541330812010789,-.24944114405798135,-.24474334395432432,-.24003979130900607,-.23533059667613823,-.23061587074244044,-.2258957243246447,-.22117026836688813,-.21643961393810288,-.21170387222941123,-.2069631545515055,-.20221757233203852,-.19746723711299774,-.19271226054809037,-.1879527544001122,-.18318883053832655,-.17842060093583256,-.1736481776669304,-.16887167290449245,-.16409119891732413,-.15930686806752234,-.15451879280784075,-.14972708567904036,-.1449318593072471,-.14013322640130713,-.13533129975013158,-.13052619222005168,-.1257180167521624,-.12090688635966958,-.11609291412523004,-.11127621319829996,-.10645689679246818,-.10163507818280229,-.09681087070317913,-.09198438774362797,-.08715574274765832,-.08232504920960054,-.0774924206719312,-.07265797072261047,-.06782181299240972,-.06298406115223794,-.0581448289104763,-.05330423001029832,-.04846237822700354,-.043619387365336194,-.038775371256817404,-.03393044375706254,-.02908471874311221,-.02423831011074855,-.019391331771824397,-.014543897651582293,-.009696121685978531,-.004848117819001606]}}}),System.register("game/math/geometry",["util/math","game/math/GameMath","game/math/Matrix4","game/math/Quaternion","game/math/Vector2","game/math/Vector3"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q;function p(g){return g*THREE.Math.RAD2DEG}function m(g){return g*THREE.Math.DEG2RAD}function f(g){return Math.round(p(g.angle()))}function y(g,P){var _=p(2*L.GameMath.acos(Math.abs(I.clamp(g.dot(P),-1,1))));return Math.round(_)}function T(g,P=new U.Quaternion){return P.setFromRotationMatrix(z.lookAt(g,K,q))}return P&&P.id,g("radToDeg",p),g("degToRad",m),g("rotateVec2",function(g,P){var I=m(Math.floor(P));return g.rotateAround(W,I)}),g("angleDegFromVec2",f),g("angleDegBetweenVec2",function(g,P){var I=f(g),L=f(P);return Math.min((I-L+360)%360,(L-I+360)%360)}),g("angleDegBetweenVec3",function(g,P){return y(T(g,$),T(P,Q))}),g("quaternionFromVec3",T),g("rotateVec3Towards",function(g,P,I){var L=g.length(),_=T(P,$),U=T(g,Q);!function(g,P,I){var L=y(g,P);0!==L&&(L=Math.min(1,I/L),g.slerp(P,L))}(U,_,I),g.set(0,0,1).applyQuaternion(U).setLength(L)}),{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){W=new G.Vector2,z=new _.Matrix4,K=new V.Vector3(0,0,0),q=new V.Vector3(0,1,0),$=new U.Quaternion,Q=new U.Quaternion}}}),System.register("game/math/LineCurve",["game/math/Vector2"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends THREE.LineCurve{constructor(g,P){super(g||new I.Vector2,P||new I.Vector2)}getPoint(g,P){return super.getPoint(g,P||new I.Vector2)}},g("LineCurve",L)}}}),System.register("game/math/Matrix4",["game/math/GameMath","game/math/Vector3"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends THREE.Matrix4{extractRotation(g){let P=this.elements;var I=g.elements,L=1/U.setFromMatrixColumn(g,0).length(),_=1/U.setFromMatrixColumn(g,1).length(),G=1/U.setFromMatrixColumn(g,2).length();return P[0]=I[0]*L,P[1]=I[1]*L,P[2]=I[2]*L,P[3]=0,P[4]=I[4]*_,P[5]=I[5]*_,P[6]=I[6]*_,P[7]=0,P[8]=I[8]*G,P[9]=I[9]*G,P[10]=I[10]*G,P[11]=0,P[12]=0,P[13]=0,P[14]=0,P[15]=1,this}makeRotationFromEuler(g){g&&g.isEuler||console.error("THREE.Matrix4: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");let P=this.elements;var L,_,U,G,V,W,z,K,q,$,Q,Y,Z=g.x,X=g.y,J=g.z,ee=I.GameMath.cos(Z),te=I.GameMath.sin(Z),re=I.GameMath.cos(X);Z=I.GameMath.sin(X),X=I.GameMath.cos(J),J=I.GameMath.sin(J);return"XYZ"===g.order?(_=ee*X,G=ee*J,U=te*X,L=te*J,P[0]=re*X,P[4]=-re*J,P[8]=Z,P[1]=G+U*Z,P[5]=_-L*Z,P[9]=-te*re,P[2]=L-_*Z,P[6]=U+G*Z,P[10]=ee*re):"YXZ"===g.order?(L=re*X,_=re*J,U=Z*X,G=Z*J,P[0]=L+G*te,P[4]=U*te-_,P[8]=ee*Z,P[1]=ee*J,P[5]=ee*X,P[9]=-te,P[2]=_*te-U,P[6]=G+L*te,P[10]=ee*re):"ZXY"===g.order?(K=re*X,V=re*J,W=Z*X,z=Z*J,P[0]=K-z*te,P[4]=-ee*J,P[8]=W+V*te,P[1]=V+W*te,P[5]=ee*X,P[9]=z-K*te,P[2]=-ee*Z,P[6]=te,P[10]=ee*re):"ZYX"===g.order?(V=ee*X,W=ee*J,z=te*X,K=te*J,P[0]=re*X,P[4]=z*Z-W,P[8]=V*Z+K,P[1]=re*J,P[5]=K*Z+V,P[9]=W*Z-z,P[2]=-Z,P[6]=te*re,P[10]=ee*re):"YZX"===g.order?(Q=ee*re,q=ee*Z,$=te*re,Y=te*Z,P[0]=re*X,P[4]=Y-Q*J,P[8]=$*J+q,P[1]=J,P[5]=ee*X,P[9]=-te*X,P[2]=-Z*X,P[6]=q*J+$,P[10]=Q-Y*J):"XZY"===g.order&&(q=ee*re,$=ee*Z,Q=te*re,Y=te*Z,P[0]=re*X,P[4]=-J,P[8]=Z*X,P[1]=q*J+Y,P[5]=ee*X,P[9]=$*J-Q,P[2]=Q*J-$,P[6]=te*X,P[10]=Y*J+q),P[3]=0,P[7]=0,P[11]=0,P[12]=0,P[13]=0,P[14]=0,P[15]=1,this}lookAt(g,P,I){G.set(0,0,0),V.set(0,0,0),W.set(0,0,0);const L=this.elements;return W.subVectors(g,P),0===W.lengthSq()&&(W.z=1),W.normalize(),G.crossVectors(I,W),0===G.lengthSq()&&(1===Math.abs(I.z)?W.x+=1e-4:W.z+=1e-4,W.normalize(),G.crossVectors(I,W)),G.normalize(),V.crossVectors(W,G),L[0]=G.x,L[4]=V.x,L[8]=W.x,L[1]=G.y,L[5]=V.y,L[9]=W.y,L[2]=G.z,L[6]=V.z,L[10]=W.z,this}getMaxScaleOnAxis(){var g=(L=this.elements)[0]*L[0]+L[1]*L[1]+L[2]*L[2],P=L[4]*L[4]+L[5]*L[5]+L[6]*L[6],L=L[8]*L[8]+L[9]*L[9]+L[10]*L[10];return I.GameMath.sqrt(Math.max(g,P,L))}makeRotationX(g){var P=I.GameMath.cos(g),L=I.GameMath.sin(g);return this.set(1,0,0,0,0,P,-L,0,0,L,P,0,0,0,0,1),this}makeRotationY(g){var P=I.GameMath.cos(g),L=I.GameMath.sin(g);return this.set(P,0,L,0,0,1,0,0,-L,0,P,0,0,0,0,1),this}makeRotationZ(g){var P=I.GameMath.cos(g),L=I.GameMath.sin(g);return this.set(P,-L,0,0,L,P,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(g,P){var L=I.GameMath.cos(P),_=I.GameMath.sin(P),U=1-L,G=g.x,V=g.y,W=g.z,z=U*G,K=U*V;return this.set(z*G+L,z*V-_*W,z*W+_*V,0,z*V+_*W,K*V+L,K*W-_*G,0,z*W-_*V,K*W+_*G,U*W*W+L,0,0,0,0,1),this}decompose(g,P,I){var L=this.elements;let _=U.set(L[0],L[1],L[2]).length();var G=U.set(L[4],L[5],L[6]).length(),V=U.set(L[8],L[9],L[10]).length();this.determinant()<0&&(_=-_),g.x=L[12],g.y=L[13],g.z=L[14],z.copy(this);var W=1/_,K=1/G;L=1/V;return z.elements[0]*=W,z.elements[1]*=W,z.elements[2]*=W,z.elements[4]*=K,z.elements[5]*=K,z.elements[6]*=K,z.elements[8]*=L,z.elements[9]*=L,z.elements[10]*=L,P.setFromRotationMatrix(z),I.x=_,I.y=G,I.z=V,this}},g("Matrix4",_),U=new L.Vector3,G=new L.Vector3,V=new L.Vector3,W=new L.Vector3,z=new _}}}),System.register("game/math/QuadraticBezierCurve",["game/math/Vector2"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends THREE.QuadraticBezierCurve{constructor(g,P,L){super(g||new I.Vector2,P||new I.Vector2,L||new I.Vector2)}getPoint(g,P){return super.getPoint(g,P||new I.Vector2)}},g("QuadraticBezierCurve",L)}}}),System.register("game/math/Quaternion",["game/math/GameMath"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends THREE.Quaternion{setFromEuler(g,P){if(!g||!g.isEuler)throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");var L=g.x,_=g.y,U=g.z,G=g.order,V=I.GameMath.cos(L/2),W=I.GameMath.cos(_/2),z=I.GameMath.cos(U/2);L=I.GameMath.sin(L/2),_=I.GameMath.sin(_/2),U=I.GameMath.sin(U/2);return"XYZ"===G?(this._x=L*W*z+V*_*U,this._y=V*_*z-L*W*U,this._z=V*W*U+L*_*z,this._w=V*W*z-L*_*U):"YXZ"===G?(this._x=L*W*z+V*_*U,this._y=V*_*z-L*W*U,this._z=V*W*U-L*_*z,this._w=V*W*z+L*_*U):"ZXY"===G?(this._x=L*W*z-V*_*U,this._y=V*_*z+L*W*U,this._z=V*W*U+L*_*z,this._w=V*W*z-L*_*U):"ZYX"===G?(this._x=L*W*z-V*_*U,this._y=V*_*z+L*W*U,this._z=V*W*U-L*_*z,this._w=V*W*z+L*_*U):"YZX"===G?(this._x=L*W*z+V*_*U,this._y=V*_*z+L*W*U,this._z=V*W*U-L*_*z,this._w=V*W*z-L*_*U):"XZY"===G&&(this._x=L*W*z-V*_*U,this._y=V*_*z-L*W*U,this._z=V*W*U+L*_*z,this._w=V*W*z+L*_*U),!1!==P&&this.onChangeCallback(),this}setFromAxisAngle(g,P){var L=P/2,_=I.GameMath.sin(L);return this._x=g.x*_,this._y=g.y*_,this._z=g.z*_,this._w=I.GameMath.cos(L),this.onChangeCallback(),this}setFromRotationMatrix(g){let P,L=g.elements,_=L[0],U=L[4],G=L[8],V=L[1],W=L[5],z=L[9],K=L[2],q=L[6],$=L[10],Q=_+W+$;return 0<Q?(P=.5/I.GameMath.sqrt(Q+1),this._w=.25/P,this._x=(q-z)*P,this._y=(G-K)*P,this._z=(V-U)*P):W<_&&$<_?(P=2*I.GameMath.sqrt(1+_-W-$),this._w=(q-z)/P,this._x=.25*P,this._y=(U+V)/P,this._z=(G+K)/P):$<W?(P=2*I.GameMath.sqrt(1+W-_-$),this._w=(G-K)/P,this._x=(U+V)/P,this._y=.25*P,this._z=(z+q)/P):(P=2*I.GameMath.sqrt(1+$-_-W),this._w=(V-U)/P,this._x=(G+K)/P,this._y=(z+q)/P,this._z=.25*P),this.onChangeCallback(),this}length(){return I.GameMath.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}slerp(g,P){if(0===P)return this;if(1===P)return this.copy(g);var L=this._x,_=this._y,U=this._z,G=this._w;let V=G*g._w+L*g._x+_*g._y+U*g._z;if(V<0?(this._w=-g._w,this._x=-g._x,this._y=-g._y,this._z=-g._z,V=-V):this.copy(g),1<=V)return this._w=G,this._x=L,this._y=_,this._z=U,this;if((K=1-V*V)<=Number.EPSILON){var W=1-P;return this._w=W*G+P*this._w,this._x=W*L+P*this._x,this._y=W*_+P*this._y,this._z=W*U+P*this._z,this.normalize()}var z=I.GameMath.sqrt(K),K=(W=I.GameMath.atan2(z,V),I.GameMath.sin((1-P)*W)/z);z=I.GameMath.sin(P*W)/z;return this._w=G*K+this._w*z,this._x=L*K+this._x*z,this._y=_*K+this._y*z,this._z=U*K+this._z*z,this.onChangeCallback(),this}},g("Quaternion",L)}}}),System.register("game/math/Spherical",["util/math","game/math/GameMath"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends THREE.Spherical{setFromVector3(g){return this.radius=g.length(),0===this.radius?(this.theta=0,this.phi=0):(this.theta=L.GameMath.atan2(g.x,g.z),this.phi=L.GameMath.acos(I.clamp(g.y/this.radius,-1,1))),this}},g("Spherical",_)}}}),System.register("game/math/Vector2",["game/math/GameMath"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends THREE.Vector2{length(){return I.GameMath.sqrt(this.x*this.x+this.y*this.y)}angle(){let g=I.GameMath.atan2(this.y,this.x);return g<0&&(g+=2*Math.PI),g}distanceTo(g){return I.GameMath.sqrt(this.distanceToSquared(g))}rotateAround(g,P){var L=I.GameMath.cos(P),_=I.GameMath.sin(P),U=this.x-g.x,G=this.y-g.y;return this.x=U*L-G*_+g.x,this.y=U*_+G*L+g.y,this}},g("Vector2",L)}}}),System.register("game/math/Vector3",["util/math","game/math/GameMath","game/math/Quaternion"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class extends THREE.Vector3{applyEuler(g){return g&&g.isEuler||console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(G.setFromEuler(g))}applyAxisAngle(g,P){return this.applyQuaternion(G.setFromAxisAngle(g,P))}length(){return L.GameMath.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}projectOnPlane(g){return V.copy(this).projectOnVector(g),this.sub(V)}reflect(g){return this.sub(V.copy(g).multiplyScalar(2*this.dot(g)))}angleTo(g){var P=this.dot(g)/L.GameMath.sqrt(this.lengthSq()*g.lengthSq());return L.GameMath.acos(I.clamp(P,-1,1))}distanceTo(g){return L.GameMath.sqrt(this.distanceToSquared(g))}setFromSpherical(g){var P=L.GameMath.sin(g.phi)*g.radius;return this.x=P*L.GameMath.sin(g.theta),this.y=L.GameMath.cos(g.phi)*g.radius,this.z=P*L.GameMath.cos(g.theta),this}setFromCylindrical(g){return this.x=g.radius*L.GameMath.sin(g.theta),this.y=g.y,this.z=g.radius*L.GameMath.cos(g.theta),this}},g("Vector3",U),G=new _.Quaternion,V=new U}}}),System.register("game/order/AttackMoveOrder",["game/order/OrderType","engine/type/PointerType","game/gameobject/task/move/AttackMoveTask","game/order/OrderFeedbackType","game/type/MovementZone","game/order/AttackOrder","game/gameobject/task/PlantC4Task","game/gameobject/task/move/AttackMoveTargetTask","game/gameobject/task/move/MoveTask","game/gameobject/task/AttackTask","game/type/LocomotorType"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g}],execute:function(){Q=class extends V.AttackOrder{constructor(g,P){super(g),this.map=P,this.orderType=I.OrderType.AttackMove,this.targetOptional=!1,this.feedbackType=U.OrderFeedbackType.Move}getPointerType(g,P){if(this.isTargetted()){let I=super.getPointerType(g,P);return I!==L.PointerType.AttackRange&&I!==L.PointerType.AttackNoRange||(I=L.PointerType.AttackMove),I}let I=this.isAllowed();var _,U,V;return I&&(_=!!this.target.getBridge(),U=this.sourceObject.rules.speedType,V=this.sourceObject.isInfantry(),I=this.sourceObject.rules.movementZone===G.MovementZone.Fly||0<this.map.terrain.getPassableSpeed(this.target.tile,U,V,_)||!!this.game.mapShroudTrait.getPlayerShroud(this.sourceObject.owner)?.isShrouded(this.target.tile,this.target.obj?.tileElevation)),g?I?L.PointerType.AttackMini:L.PointerType.NoActionMini:I?L.PointerType.AttackMove:L.PointerType.NoMove}isValid(){var g=this.sourceObject.isUnit()&&!!this.sourceObject.attackTrait&&!this.sourceObject.rules.preventAttackMove&&!(this.game.mapShroudTrait.getPlayerShroud(this.sourceObject.owner)?.isShrouded(this.target.tile,this.target.obj?.tileElevation)&&!this.sourceObject.rules.moveToShroud)&&(!this.isTargetted()||super.isValid());return this.feedbackType=U.OrderFeedbackType.Move,g}isAllowed(){return!(!this.isTargetted()&&this.sourceObject.moveTrait.isDisabled())&&super.isAllowed()}process(){if(this.isTargetted()){if(this.isC4)return[new W.PlantC4Task(this.game,this.target.obj)];var g=this.sourceObject.attackTrait.selectWeaponVersus(this.sourceObject,this.target,this.game);return[new z.AttackMoveTargetTask(this.game,this.target,g)]}return[new _.AttackMoveTask(this.game,this.target.tile,!!this.target.getBridge(),{closeEnoughTiles:this.game.rules.general.closeEnough})]}isTargetted(){return this.target.obj?.isTechno()}onAdd(g,P){let I=this.sourceObject;if(!P&&I.isUnit()&&this.isValid()&&this.isAllowed())if(I.rules.movementZone===G.MovementZone.Fly){let P=g.find(g=>[K.MoveTask,q.AttackTask,_.AttackMoveTask,z.AttackMoveTargetTask].includes(g.constructor)&&!g.isCancelling());if(P)if(this.isTargetted())(I.moveTrait.currentWaypoint?.tile===this.target.tile||I.isAircraft()||P.constructor!==K.MoveTask)&&P.forceCancel(I)&&g.splice(g.indexOf(P));else{if(P.constructor===_.AttackMoveTask)return P.updateTarget(this.target.tile,!!this.target.getBridge()),g.splice(g.indexOf(P)+1),I.unitOrderTrait.clearOrders(),!1;P.forceCancel(I)&&g.splice(g.indexOf(P))}}else this.isTargetted()&&g.length&&I.isUnit()&&(I.rules.locomotor===$.LocomotorType.Vehicle||I.rules.locomotor===$.LocomotorType.Ship)&&(I.moveTrait.speedPenalty=.5);return!0}},g("AttackMoveOrder",Q)}}}),System.register("game/order/AttackOrder",["game/order/Order","game/order/OrderType","engine/type/PointerType","game/gameobject/task/AttackTask","game/gameobject/unit/RangeHelper","game/order/OrderFeedbackType","game/gameobject/unit/LosHelper","game/type/ArmorType","game/gameobject/task/PlantC4Task","game/gameobject/unit/ZoneType","game/gameobject/task/move/MoveTask","game/type/MovementZone","game/type/LocomotorType"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g}],execute:function(){Z=class extends I.Order{constructor(g,{forceAttack:P,noIvanBomb:I}={}){super(P?L.OrderType.ForceAttack:L.OrderType.Attack),this.game=g,this.isC4=!1,this.forceAttack=!!P,this.ivanBombAllowed=!I||!!P,this.targetOptional=!1,this.feedbackType=V.OrderFeedbackType.None,this.rangeHelper=new G.RangeHelper(this.game.map.tileOccupation),this.losHelper=new W.LosHelper(this.game.map.tiles,g.map.tileOccupation)}getPointerType(g,P){if(!this.isAllowed())return g?_.PointerType.NoActionMini:_.PointerType.NoAction;if(this.isC4)return _.PointerType.C4;var I=this.sourceObject.attackTrait?.selectWeaponVersus(this.sourceObject,this.target,this.game,this.forceAttack);return I?.rules.sabotageCursor?_.PointerType.C4:this.ivanBombAllowed&&this.sourceObject.rules.ivan&&I?.warhead.rules.ivanBomb?_.PointerType.Dynamite:I?.warhead.rules.bombDisarm?_.PointerType.DefuseBomb:I&&I.rules.damage<0?_.PointerType.RepairMove:(I=P.every(g=>{if(!g.attackTrait)return!0;var P=g.attackTrait.selectWeaponVersus(g,this.target,this.game,this.forceAttack);return!P||this.rangeHelper.isInWeaponRange(g,this.target.obj||this.target.tile,P,this.game.rules)&&this.losHelper.hasLineOfSight(g,this.target.obj||this.target.tile,P)}),g?_.PointerType.AttackMini:I?_.PointerType.AttackRange:_.PointerType.AttackNoRange)}isValid(){if(!this.sourceObject.attackTrait)return!1;if(this.forceAttack&&this.game.mapShroudTrait.getPlayerShroud(this.sourceObject.owner)?.isShrouded(this.target.tile,this.target.obj?.tileElevation)&&!this.sourceObject.isBuilding())return!1;let g=this.target.obj;var P=this.game.map.getGroundObjectsOnTile(this.target.tile).find(g=>g.isTerrain());return this.terminal=!g&&!P,this.sourceObject.c4&&g?.isBuilding()&&g.c4ChargeTrait&&(this.forceAttack||!this.game.areFriendly(g,this.sourceObject)||g.cabHutTrait)?(this.isC4=!0,this.feedbackType=V.OrderFeedbackType.SpecialAttack,!0):(this.isC4=!1,this.feedbackType=V.OrderFeedbackType.Attack,!!this.game.isValidTarget(g)&&(!(!g&&P?.rules.immune)&&(!!(g||this.target.tile!==this.sourceObject.tile||this.sourceObject.isUnit()&&this.sourceObject.zone===q.ZoneType.Air)&&(g!==this.sourceObject&&(!!(P=this.sourceObject.attackTrait.selectWeaponVersus(this.sourceObject,this.target,this.game,this.forceAttack))&&!(!this.ivanBombAllowed&&P.warhead.rules.ivanBomb)&&!(g?.isBuilding()&&g.cabHutTrait&&!P.warhead.rules.ivanBomb&&!P.warhead.rules.bombDisarm)&&!!(this.sourceObject.isUnit()&&this.sourceObject.moveTrait&&!this.sourceObject.moveTrait.isDisabled()||this.rangeHelper.isInWeaponRange(this.sourceObject,g||this.target.tile,P,this.game.rules))&&!(this.sourceObject.airSpawnTrait&&P.rules.spawner&&!this.game.map.isWithinBounds(this.target.tile))&&(!!this.forceAttack||(!g?.isBuilding()||!g.hospitalTrait)&&!(!g||!g.healthTrait)&&!g.isDestroyed&&!g.isCrashing&&(!(!g.isOverlay()||!(P.warhead.rules.wall||P.warhead.rules.wood&&g.rules.armor===z.ArmorType.Wood))||g.isTechno())))))))}isAllowed(){return!this.sourceObject.attackTrait.isDisabled()}process(){if(this.isC4)return[new K.PlantC4Task(this.game,this.target.obj)];var g=this.sourceObject.attackTrait.selectWeaponVersus(this.sourceObject,this.target,this.game,this.forceAttack);return[new U.AttackTask(this.game,this.target,g,{force:this.forceAttack})]}onAdd(g,P){let I=this.sourceObject;if(!P&&I.isUnit()&&this.isValid()&&this.isAllowed())if(I.rules.movementZone===Q.MovementZone.Fly){var L,_=g.find(g=>(g.constructor===$.MoveTask||g.constructor===U.AttackTask)&&!g.isCancelling());let P;_&&(I.moveTrait.currentWaypoint?.tile===this.target.tile||I.isAircraft()||_.constructor===U.AttackTask||(L=this.sourceObject.attackTrait.selectWeaponVersus(this.sourceObject,this.target,this.game,this.forceAttack)).projectileRules.vertical&&_.constructor===$.MoveTask&&this.rangeHelper.isInWeaponRange(this.sourceObject,this.target.obj||this.target.tile,L,this.game.rules))&&(P=_),P?.forceCancel(I)&&g.splice(g.indexOf(P))}else{g.length&&I.isUnit()&&(I.rules.locomotor===Y.LocomotorType.Vehicle||I.rules.locomotor===Y.LocomotorType.Ship)&&(I.moveTrait.speedPenalty=.5);let P=g.find(g=>g.constructor===U.AttackTask&&!g.isCancelling());if(P?.getWeapon().warhead.rules.temporal)return P.setForceAttack(this.forceAttack),P.requestTargetUpdate(this.target),!1}return!0}},g("AttackOrder",Z)}}}),System.register("game/order/CaptureOrder",["game/order/Order","game/order/OrderType","engine/type/PointerType","game/gameobject/unit/RangeHelper","game/gameobject/task/CaptureBuildingTask","game/order/OrderFeedbackType"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){W=class extends I.Order{constructor(g){super(L.OrderType.Capture),this.game=g,this.targetOptional=!1,this.terminal=!0,this.feedbackType=V.OrderFeedbackType.Capture}getPointerType(g){if(!this.isAllowed())return g?_.PointerType.NoActionMini:_.PointerType.NoOccupy;if(g)return _.PointerType.OccupyMini;if(this.game.gameOpts.multiEngineer){var P=this.game.rules.general,I=this.target.obj;if((!I.rules.needsEngineer||!P.engineerAlwaysCaptureTech)&&I.healthTrait.health>100*P.engineerCaptureLevel)return _.PointerType.EngineerDamage}return _.PointerType.Occupy}isValid(){return!(this.target.obj?.isDestroyed||!this.target.obj?.isBuilding()||!this.sourceObject.isInfantry())&&this.target.obj.rules.capturable&&this.sourceObject.rules.engineer&&!this.game.areFriendly(this.sourceObject,this.target.obj)}isAllowed(){return!0}process(){return[new G.CaptureBuildingTask(this.game,this.target.obj)]}onAdd(g,P){if(!P){let P=g.find(g=>g instanceof G.CaptureBuildingTask);if(this.isValid()&&this.isAllowed()&&P&&!P.isCancelling()&&P.target===this.target.obj&&new U.RangeHelper(this.game.map.tileOccupation).isInTileRange(this.sourceObject,this.target.obj,0,Math.SQRT2))return!1}return!0}},g("CaptureOrder",W)}}}),System.register("game/order/CheerOrder",["game/order/Order","game/order/OrderType","engine/type/PointerType","game/gameobject/task/CheerTask","game/gameobject/infantry/StanceType"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){V=class extends I.Order{constructor(){super(L.OrderType.Cheer),this.getPointerType=()=>_.PointerType.NoAction}isValid(){return this.sourceObject.isInfantry()&&[G.StanceType.None,G.StanceType.Guard].includes(this.sourceObject.stance)}isAllowed(){return!0}process(){return[new U.CheerTask]}},g("CheerOrder",V)}}}),System.register("game/order/DeployOrder",["game/order/Order","game/order/OrderType","engine/type/PointerType","game/gameobject/task/morph/DeployIntoTask","game/gameobject/infantry/StanceType","game/gameobject/task/system/CallbackTask","game/event/UnitDeployUndeployEvent","game/event/PrimaryFactoryChangeEvent","game/gameobject/task/EvacuateTransportTask","game/type/SpeedType"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g}],execute:function(){$=class extends I.Order{constructor(g,P){super(P?L.OrderType.Deploy:L.OrderType.DeploySelected),this.game=g,this.targeted=P,this.minimapAllowed=!1,this.getPointerType=()=>this.isAllowed()?_.PointerType.Deploy:_.PointerType.NoDeploy,this.targetOptional=!P,this.singleSelectionRequired=P}isValid(){if(this.targeted&&(!this.target.obj||this.target.obj!==this.sourceObject))return!1;let g=this.sourceObject;return!!(g.isInfantry()&&g.deployerTrait&&![G.StanceType.Cheer].includes(g.stance)||g.isVehicle()&&g.deployerTrait||g.isVehicle()&&g.rules.deploysInto||g.isVehicle()&&g.transportTrait||g.isBuilding()&&g.rules.factory&&!g.owner.production?.isPrimaryFactory(g)||g.isBuilding()&&g.garrisonTrait?.units.length)}isAllowed(){let g=this.sourceObject;if(g.isVehicle()&&g.transportTrait)return!!(g.transportTrait.units.length&&0<this.game.map.terrain.getPassableSpeed(g.tile,q.SpeedType.Foot,!1,g.onBridge));if((g.isInfantry()||g.isVehicle())&&g.deployerTrait)return!0;if(g.isVehicle()&&g.rules.deploysInto){if(g.parasiteableTrait?.isInfested()&&!g.parasiteableTrait.beingBoarded)return!1;let I=this.game.getConstructionWorker(g.owner);if(g.moveTrait.currentWaypoint?.onBridge)return!1;var P=g.moveTrait.currentWaypoint?.tile??g.tile;return I.canPlaceAt(g.rules.deploysInto,P,{ignoreObjects:[g],ignoreAdjacent:!0})}if(g.isBuilding()&&g.rules.factory)return!0;if(g.isBuilding()&&g.garrisonTrait?.units.length)return!0;throw new Error("Shouldn't reach this point. Missed a case.")}process(){const g=this.sourceObject;return g.isVehicle()&&g.transportTrait?[new K.EvacuateTransportTask(this.game,!0)]:g.isBuilding()&&g.rules.factory?void 0:g.isVehicle()&&g.rules.deploysInto?[new U.DeployIntoTask(this.game)]:(g.isInfantry()||g.isVehicle())&&g.deployerTrait?[new V.CallbackTask(()=>{g.deployerTrait.toggleDeployed(),this.game.events.dispatch(new W.UnitDeployUndeployEvent(g,g.deployerTrait.isDeployed()?"undeploy":"deploy"))})]:g.isBuilding()&&g.garrisonTrait?.units.length?[new V.CallbackTask(()=>{g.garrisonTrait.evacuate(this.game,!0)})]:void 0}onAdd(g,P){let I=this.sourceObject;if(I.isBuilding()&&I.rules.factory)return I.owner.production.setPrimaryFactory(I),this.game.events.dispatch(new z.PrimaryFactoryChangeEvent(I)),!1;if(I.isVehicle()&&I.transportTrait&&!P&&this.isValid()&&this.isAllowed()){let P=g.find(g=>g.constructor===K.EvacuateTransportTask&&!g.isCancelling());if(P)return P.forceEvac(),!1}return!0}},g("DeployOrder",$)}}}),System.register("game/order/DockOrder",["game/order/Order","game/order/OrderType","engine/type/PointerType","game/gameobject/Building","game/gameobject/task/harvester/ReturnOreTask","game/order/OrderFeedbackType","game/gameobject/task/MoveToDockTask"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g}],execute:function(){z=class extends I.Order{constructor(g){super(L.OrderType.Dock),this.game=g,this.targetOptional=!1,this.feedbackType=V.OrderFeedbackType.Move}getPointerType(g){return g?this.isAllowed()?_.PointerType.OccupyMini:_.PointerType.NoActionMini:this.isAllowed()?_.PointerType.Occupy:_.PointerType.NoOccupy}isValid(){if(!this.target.obj?.isBuilding()||this.target.obj.isDestroyed||!this.target.obj.dockTrait||this.target.obj.buildStatus!==U.BuildStatus.Ready||!this.sourceObject.isUnit()||this.target.obj.warpedOutTrait.isActive())return!1;var g=!(this.target.obj.rules.refinery||this.target.obj.unitRepairTrait);return this.game.areFriendly(this.target.obj,this.sourceObject)&&this.target.obj.dockTrait.isValidUnitForDock(this.sourceObject)&&!this.target.obj.dockTrait.isDocked(this.sourceObject)&&!(this.target.obj.unitRepairTrait&&!this.sourceObject.rules.dock.includes(this.target.obj.name)&&100===this.sourceObject.healthTrait.health)&&(!g||0<(this.target.obj.dockTrait.getAvailableDockCount()??0)||this.target.obj.dockTrait.hasReservedDockForUnit(this.sourceObject))}isAllowed(){return!0}process(){var g=this.target.obj;return g.rules.refinery&&this.sourceObject.isVehicle()&&this.sourceObject.harvesterTrait?[new G.ReturnOreTask(this.game,g,!0,!0)]:g.unitRepairTrait||this.sourceObject.rules.dock.includes(g.name)?[new W.MoveToDockTask(this.game,g)]:[]}},g("DockOrder",z)}}}),System.register("game/order/EnterTransportOrder",["game/order/Order","game/order/OrderType","engine/type/PointerType","game/gameobject/unit/RangeHelper","game/order/OrderFeedbackType","game/gameobject/task/EnterTransportTask","game/gameobject/unit/ZoneType","game/gameobject/trait/MoveTrait","game/gameobject/task/system/CallbackTask","game/gameobject/task/move/MoveTask"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g}],execute:function(){$=class extends I.Order{constructor(g){super(L.OrderType.EnterTransport),this.game=g,this.targetOptional=!1,this.terminal=!0,this.feedbackType=G.OrderFeedbackType.Enter}getPointerType(g){return g?this.isAllowed()?_.PointerType.OccupyMini:_.PointerType.NoActionMini:this.isAllowed()?_.PointerType.Occupy:_.PointerType.NoOccupy}isValid(){return!(!this.target.obj?.isVehicle()||!this.target.obj.transportTrait||this.target.obj.isDestroyed||this.target.obj===this.sourceObject||!this.game.areFriendly(this.target.obj,this.sourceObject)||!this.sourceObject.isVehicle()&&!this.sourceObject.isInfantry())}isAllowed(){let g=this.target.obj,P=this.sourceObject;return P.zone!==W.ZoneType.Air&&g.zone!==W.ZoneType.Air&&g.transportTrait.unitFitsInside(P)&&g.moveTrait.moveState===z.MoveState.Idle&&!g.warpedOutTrait.isActive()&&!P.mindControllableTrait?.isActive()&&!P.mindControllerTrait?.isActive()}process(){let g=this.sourceObject,P=this.target.obj;return this.game.map.terrain.getPassableSpeed(P.tile,g.rules.speedType,g.isInfantry(),g.onBridge)?[new V.EnterTransportTask(this.game,P)]:[new K.CallbackTask(()=>{P.unitOrderTrait.addTask(new q.MoveTask(this.game,g.tile,g.onBridge)),P.unitOrderTrait.addTask(new K.CallbackTask(()=>{this.game.map.terrain.getPassableSpeed(P.tile,g.rules.speedType,g.isInfantry(),g.onBridge)&&g.unitOrderTrait.addTask(new V.EnterTransportTask(this.game,P))}))})]}onAdd(g,P){if(!P){let P=g.find(g=>g instanceof V.EnterTransportTask);if(this.isValid()&&this.isAllowed()&&P&&!P.isCancelling()&&P.target===this.target.obj&&new U.RangeHelper(this.game.map.tileOccupation).isInTileRange(this.sourceObject,this.target.obj,0,Math.SQRT2))return!1}return!0}},g("EnterTransportOrder",$)}}}),System.register("game/order/GatherOrder",["game/order/Order","game/order/OrderType","engine/type/PointerType","game/gameobject/task/harvester/GatherOreTask","game/order/OrderFeedbackType"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){V=class extends I.Order{constructor(g){super(L.OrderType.Gather),this.game=g,this.targetOptional=!1,this.feedbackType=G.OrderFeedbackType.Move}getPointerType(g){return g?_.PointerType.AttackMini:_.PointerType.AttackNoRange}isValid(){return!(!this.sourceObject.isVehicle()||!this.sourceObject.harvesterTrait||this.sourceObject.moveTrait.isDisabled()||this.game.mapShroudTrait.getPlayerShroud(this.sourceObject.owner)?.isShrouded(this.target.tile,this.target.obj?.tileElevation))&&this.target.isOre}isAllowed(){return!0}process(){return[new U.GatherOreTask(this.game,this.target.tile,!0)]}},g("GatherOrder",V)}}}),System.register("game/order/GuardAreaOrder",["game/order/Order","game/order/OrderType","engine/type/PointerType","game/gameobject/task/system/CallbackTask","game/gameobject/task/move/MoveTask","game/order/OrderFeedbackType","game/gameobject/trait/MoveTrait","game/gameobject/task/harvester/GatherOreTask","game/gameobject/task/harvester/ReturnOreTask"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g}],execute:function(){q=class extends I.Order{constructor(g,P){super(P?L.OrderType.GuardArea:L.OrderType.Guard),this.game=g,this.targeted=P,this.getPointerType=g=>g?this.isAllowed()?_.PointerType.GuardMini:_.PointerType.NoActionMini:this.isAllowed()?_.PointerType.Guard:_.PointerType.NoMove,this.terminal=!0,this.targetOptional=!P,this.minimapAllowed=P,this.feedbackType=P?V.OrderFeedbackType.Move:V.OrderFeedbackType.None}isValid(){return this.sourceObject.isUnit()&&(!!this.targetOptional||!this.sourceObject.moveTrait.isDisabled())&&!(this.target&&this.game.mapShroudTrait.getPlayerShroud(this.sourceObject.owner)?.isShrouded(this.target.tile,this.target.obj?.tileElevation)&&!this.sourceObject.rules.moveToShroud)}isAllowed(){return!0}process(){let g=this.targeted?this.target.tile:void 0;const P=this.sourceObject;let I=[];return g&&I.push(new G.MoveTask(this.game,g,!!this.target.getBridge(),{closeEnoughTiles:this.game.rules.general.closeEnough})),P.isVehicle()&&P.harvesterTrait?I.push(new U.CallbackTask(()=>P.harvesterTrait.lastOreSite=void 0),P.harvesterTrait.isFull()?new K.ReturnOreTask(this.game,void 0,void 0,!0):new z.GatherOreTask(this.game,void 0,!0)):I.push(new U.CallbackTask(P=>{g&&![W.MoveResult.Success,W.MoveResult.CloseEnough].includes(this.sourceObject.moveTrait?.lastMoveResult)||(this.sourceObject.guardMode=!0)})),I}},g("GuardAreaOrder",q)}}}),System.register("game/order/MoveOrder",["game/order/Order","game/order/OrderType","engine/type/PointerType","game/gameobject/task/morph/UndeployIntoTask","game/gameobject/task/move/MoveTask","game/order/OrderFeedbackType","game/event/RallyPointChangeEvent","game/type/MovementZone","game/type/SpeedType","game/gameobject/task/AttackTask","game/gameobject/Building","game/gameobject/task/WaitForBuildUpTask","game/gameobject/task/move/MoveToBlockTask","game/type/LandType","game/gameobject/task/move/AttackMoveTask","game/gameobject/task/move/AttackMoveTargetTask","game/gameobject/task/move/MoveTargetTask"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g}],execute:function(){te=class extends I.Order{constructor(g,P,I,_=!1){super(_?L.OrderType.ForceMove:L.OrderType.Move),this.game=g,this.map=P,this.unitSelection=I,this.forceMove=_,this.targetOptional=!1,this.feedbackType=V.OrderFeedbackType.Move}getPointerType(g){let P=this.isAllowed();var I,L,U,G,V;return!P||this.forceMove||this.sourceObject.isBuilding()||this.game.mapShroudTrait.getPlayerShroud(this.sourceObject.owner)?.isShrouded(this.target.tile,this.target.obj?.tileElevation)||(I=!!this.target.getBridge(),L=this.sourceObject.rules.speedType,U=this.sourceObject.isInfantry(),G=this.sourceObject.rules.movementZone===z.MovementZone.Fly,V=this.map.getObjectsOnTile(this.target.tile).some(g=>(g.isInfantry()||g.isVehicle())&&g.disguiseTrait?.hasTerrainDisguise()),P=G?this.sourceObject.rules.airportBound||this.target.tile.landType===Z.LandType.Cliff||0<this.map.terrain.getPassableSpeed(this.target.tile,K.SpeedType.Amphibious,!1,I)&&!V:0<this.map.terrain.getPassableSpeed(this.target.tile,L,U,I)&&!V&&!(this.target.obj?.isTechno()&&!this.game.areFriendly(this.target.obj,this.sourceObject))),g?P?_.PointerType.MoveMini:_.PointerType.NoActionMini:P?_.PointerType.Move:_.PointerType.NoMove}isValid(){return!(this.sourceObject.isBuilding()&&(!this.sourceObject.rules.undeploysInto||this.sourceObject.rules.constructionYard&&!this.game.gameOpts.mcvRepacks)&&!this.sourceObject.rallyTrait?.getRallyPoint())&&(this.forceMove||!this.target.obj||(this.target.obj.isOverlay()||this.target.obj.isBuilding())&&this.target.obj.rules.wall||this.target.obj.isTechno()&&this.target.obj.owner===this.sourceObject.owner&&this.unitSelection.isSelected(this.target.obj)||(this.target.obj.isInfantry()||this.target.obj.isVehicle())&&!!this.target.obj.disguiseTrait?.hasTerrainDisguise()||this.target.obj.isTechno()&&!this.game.areFriendly(this.target.obj,this.sourceObject))}isAllowed(){return(!this.sourceObject.isUnit()||!this.sourceObject.moveTrait.isDisabled())&&(this.game.mapShroudTrait.getPlayerShroud(this.sourceObject.owner)?.isShrouded(this.target.tile,this.target.obj?.tileElevation)?this.sourceObject.rules.moveToShroud:!(!this.forceMove&&this.target.obj?.isTechno()&&this.target.obj.owner===this.sourceObject.owner&&this.unitSelection.isSelected(this.target.obj)))}process(){const g=this.sourceObject;if(!g.isBuilding()||!g.rallyTrait?.getRallyPoint()){var P=this.game.rules.general.closeEnough;return g.isBuilding()&&g.rules.undeploysInto?[new U.UndeployIntoTask(this.game),new G.MoveTask(this.game,this.target.tile,!!this.target.getBridge(),{closeEnoughTiles:P,forceMove:this.forceMove})]:g.isUnit()?this.isEnemyBuildingBlock()?[new Y.MoveToBlockTask(this.game,this.target.obj)]:this.isFollowMove()?[new ee.MoveTargetTask(this.game,this.target.obj)]:[new G.MoveTask(this.game,this.target.tile,!!this.target.getBridge(),{closeEnoughTiles:P,forceMove:this.forceMove})]:void 0}}isEnemyBuildingBlock(){return this.forceMove&&this.sourceObject.isVehicle()&&!this.sourceObject.rules.consideredAircraft&&this.target.obj?.isBuilding()&&!this.game.areFriendly(this.sourceObject,this.target.obj)}isFollowMove(){return this.forceMove&&this.target.obj?.isInfantry()&&this.sourceObject.isVehicle()&&!this.sourceObject.rules.consideredAircraft&&!this.target.obj.moveTrait.isIdle()}onAdd(g,P){var I=this.sourceObject.isBuilding()&&this.sourceObject.rules.undeploysInto;if(I&&this.sourceObject.buildStatus===$.BuildStatus.BuildUp)return this.sourceObject.unitOrderTrait.getTasks().find(g=>g instanceof Q.WaitForBuildUpTask)?.setCancellable(!0),!0;if(!I&&this.sourceObject.isBuilding()&&this.sourceObject.rallyTrait?.getRallyPoint())return this.sourceObject.rallyTrait.changeRallyPoint(this.target.tile,this.sourceObject,this.game),this.game.events.dispatch(new W.RallyPointChangeEvent(this.sourceObject)),!1;if(!this.isEnemyBuildingBlock()&&!this.isFollowMove()&&!P&&this.isValid()&&this.isAllowed()){this.sourceObject.attackTrait?.cancelOpportunityFire();let P=g.find(g=>g.constructor===G.MoveTask&&!g.isCancelling());if(P)return P.setForceMove(this.forceMove),P.updateTarget(this.target.tile,!!this.target.getBridge(),!0),P.children.length&&P.children[0]instanceof q.AttackTask&&P.children[0].cancel(),g.splice(g.indexOf(P)+1),this.sourceObject.unitOrderTrait.clearOrders(),!1;if(this.sourceObject.isUnit()&&this.sourceObject.rules.movementZone===z.MovementZone.Fly){let P=g.find(g=>[q.AttackTask,X.AttackMoveTask,J.AttackMoveTargetTask].includes(g.constructor)&&!g.isCancelling());P&&P.forceCancel(this.sourceObject)&&g.splice(g.indexOf(P))}}return!0}},g("MoveOrder",te)}}}),System.register("game/order/OccupyOrder",["game/order/Order","game/order/OrderType","engine/type/PointerType","game/gameobject/task/GarrisonBuildingTask","game/gameobject/unit/RangeHelper","game/order/OrderFeedbackType","game/type/MovementZone","game/type/LocomotorType","game/gameobject/task/EnterRecyclerTask","game/gameobject/task/InfiltrateBuildingTask","game/gameobject/task/EnterHospitalTask"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g}],execute:function(){Q=class extends I.Order{constructor(g){super(L.OrderType.Occupy),this.game=g,this.targetOptional=!1,this.terminal=!0,this.feedbackType=V.OrderFeedbackType.Capture}getPointerType(g){return g?this.isAllowed()?_.PointerType.OccupyMini:_.PointerType.NoActionMini:this.isAllowed()?_.PointerType.Occupy:_.PointerType.NoOccupy}isValid(){return!!(this.target.obj?.isSpawned&&this.target.obj?.isBuilding()&&this.sourceObject.isUnit())&&(!!this.isUnitRecycle(this.sourceObject,this.target.obj)||!!this.sourceObject.isInfantry()&&(this.target.obj.isBuilding()&&this.target.obj.hospitalTrait?this.game.areFriendly(this.sourceObject,this.target.obj)&&this.sourceObject.isInfantry():this.target.obj.garrisonTrait?this.target.obj.garrisonTrait.canBeOccupied()&&this.sourceObject.rules.occupier&&!(this.target.obj.garrisonTrait.units.length&&this.target.obj.garrisonTrait.units[0].owner!==this.sourceObject.owner)&&!this.sourceObject.mindControllableTrait?.isActive()&&!this.sourceObject.mindControllerTrait?.isActive():!(!this.target.obj.rules.spyable||!this.sourceObject.rules.infiltrate||this.game.areFriendly(this.sourceObject,this.target.obj))))}isUnitRecycle(g,P){return g.owner===P.owner&&(g.isInfantry()&&P.rules.cloning||P.rules.grinding)&&!g.rules.engineer}isAllowed(){var g=this.target.obj,P=this.sourceObject;return this.isUnitRecycle(P,g)?P.rules.movementZone!==W.MovementZone.Fly&&P.rules.locomotor!==z.LocomotorType.Chrono&&0<this.game.sellTrait.computeRefundValue(P):g.hospitalTrait?P.healthTrait.health<100&&P.rules.movementZone!==W.MovementZone.Fly:!g.garrisonTrait||g.garrisonTrait.units.length<g.rules.maxNumberOccupants}process(){var g=this.target.obj,P=this.sourceObject;return this.isUnitRecycle(P,g)?[new K.EnterRecyclerTask(this.game,g)]:g.hospitalTrait?[new $.EnterHospitalTask(this.game,g)]:g.garrisonTrait?[new U.GarrisonBuildingTask(this.game,g)]:[new q.InfiltrateBuildingTask(this.game,g)]}onAdd(g,P){if(!P){let P=g.find(g=>g instanceof U.GarrisonBuildingTask||g instanceof q.InfiltrateBuildingTask);if(this.isValid()&&this.isAllowed()&&P&&!P.isCancelling()&&P.target===this.target.obj&&new G.RangeHelper(this.game.map.tileOccupation).isInTileRange(this.sourceObject,this.target.obj,0,Math.SQRT2))return!1}return!0}},g("OccupyOrder",Q)}}}),System.register("game/order/Order",["engine/type/PointerType","game/order/OrderFeedbackType"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("Order",class{constructor(g){this.orderType=g,this.targetOptional=!0,this.minimapAllowed=!0,this.singleSelectionRequired=!1,this.terminal=!1,this.feedbackType=L.OrderFeedbackType.None}getPointerType(g,P){return g?I.PointerType.Mini:I.PointerType.Default}set(g,P){return this.sourceObject=g,this.target=P,this}isValid(){return!0}isAllowed(){return!0}onAdd(g,P){return!0}})}}}),System.register("game/order/OrderFactory",["game/order/OrderType","game/order/DeployOrder","game/order/MoveOrder","game/order/OccupyOrder","game/order/AttackOrder","game/order/StopOrder","game/order/CheerOrder","game/order/DockOrder","game/order/GatherOrder","game/order/AttackMoveOrder","game/order/RepairOrder","game/order/GuardAreaOrder","game/order/ScatterOrder","game/order/EnterTransportOrder","game/order/CaptureOrder"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g}],execute:function(){g("OrderFactory",class{constructor(g,P){this.game=g,this.map=P}create(g,P){switch(g){case I.OrderType.Deploy:return new L.DeployOrder(this.game,!0);case I.OrderType.DeploySelected:return new L.DeployOrder(this.game,!1);case I.OrderType.ForceMove:return new _.MoveOrder(this.game,this.map,P,!0);case I.OrderType.Move:return new _.MoveOrder(this.game,this.map,P);case I.OrderType.ForceAttack:return new G.AttackOrder(this.game,{forceAttack:!0});case I.OrderType.Attack:return new G.AttackOrder(this.game,{noIvanBomb:!0});case I.OrderType.PlaceBomb:return new G.AttackOrder(this.game);case I.OrderType.AttackMove:return new q.AttackMoveOrder(this.game,this.map);case I.OrderType.Capture:return new X.CaptureOrder(this.game);case I.OrderType.Occupy:return new U.OccupyOrder(this.game);case I.OrderType.Stop:return new V.StopOrder(this.game);case I.OrderType.Cheer:return new W.CheerOrder;case I.OrderType.Dock:return new z.DockOrder(this.game);case I.OrderType.Gather:return new K.GatherOrder(this.game);case I.OrderType.Repair:return new $.RepairOrder(this.game);case I.OrderType.Guard:return new Q.GuardAreaOrder(this.game,!1);case I.OrderType.GuardArea:return new Q.GuardAreaOrder(this.game,!0);case I.OrderType.Scatter:return new Y.ScatterOrder(this.game);case I.OrderType.EnterTransport:return new Z.EnterTransportOrder(this.game);default:throw new Error("Unhandled order type "+I.OrderType[g])}}})}}}),System.register("game/order/OrderFeedbackType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("OrderFeedbackType",I={}))[P.None=0]="None",P[P.Move=1]="Move",P[P.Attack=2]="Attack",P[P.Enter=3]="Enter",P[P.Capture=4]="Capture",P[P.SpecialAttack=5]="SpecialAttack"}}}),System.register("game/order/orderPriorities",["game/order/OrderType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("orderPriorities",[I.OrderType.Occupy,I.OrderType.Dock,I.OrderType.Attack,I.OrderType.Capture,I.OrderType.Repair,I.OrderType.EnterTransport,I.OrderType.PlaceBomb,I.OrderType.Deploy,I.OrderType.Gather])}}}),System.register("game/order/OrderType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("OrderType",I={}))[P.Move=0]="Move",P[P.ForceMove=1]="ForceMove",P[P.Attack=2]="Attack",P[P.ForceAttack=3]="ForceAttack",P[P.AttackMove=4]="AttackMove",P[P.Guard=5]="Guard",P[P.GuardArea=6]="GuardArea",P[P.Capture=7]="Capture",P[P.Occupy=8]="Occupy",P[P.Deploy=9]="Deploy",P[P.DeploySelected=10]="DeploySelected",P[P.Stop=11]="Stop",P[P.Cheer=12]="Cheer",P[P.Dock=13]="Dock",P[P.Gather=14]="Gather",P[P.Repair=15]="Repair",P[P.Scatter=16]="Scatter",P[P.EnterTransport=17]="EnterTransport",P[P.PlaceBomb=18]="PlaceBomb"}}}),System.register("game/order/RepairOrder",["game/order/Order","game/order/OrderType","engine/type/PointerType","game/gameobject/unit/RangeHelper","game/gameobject/task/RepairBuildingTask","game/order/OrderFeedbackType"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){W=class extends I.Order{constructor(g){super(L.OrderType.Repair),this.game=g,this.targetOptional=!1,this.terminal=!0,this.feedbackType=V.OrderFeedbackType.Capture}getPointerType(g){return g?this.isAllowed()?_.PointerType.OccupyMini:_.PointerType.NoActionMini:this.isAllowed()?_.PointerType.RepairMove:_.PointerType.NoRepair}isValid(){return!!this.target.obj?.isBuilding()&&!this.target.obj.isDestroyed&&this.sourceObject.isInfantry()&&this.sourceObject.rules.engineer&&(!this.target.obj.owner.isCombatant()&&(!!this.target.obj.garrisonTrait||!!this.target.obj.cabHutTrait)||this.game.areFriendly(this.target.obj,this.sourceObject))}isAllowed(){let g=this.target.obj;return g.cabHutTrait?g.cabHutTrait.canRepairBridge():!!(g.rules.repairable&&g.healthTrait.health<100)}process(){var g=this.target.obj;return[new G.RepairBuildingTask(this.game,g)]}onAdd(g,P){if(!P){let P=g.find(g=>g instanceof G.RepairBuildingTask);if(this.isValid()&&this.isAllowed()&&P&&!P.isCancelling()&&P.target===this.target.obj&&new U.RangeHelper(this.game.map.tileOccupation).isInTileRange(this.sourceObject,this.target.obj,0,Math.SQRT2))return!1}return!0}},g("RepairOrder",W)}}}),System.register("game/order/ScatterOrder",["game/order/Order","game/order/OrderType","engine/type/PointerType","game/gameobject/task/ScatterTask","game/type/MovementZone"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){V=class extends I.Order{constructor(g){super(L.OrderType.Scatter),this.game=g,this.getPointerType=()=>_.PointerType.NoAction}isValid(){return(this.sourceObject.isInfantry()||this.sourceObject.isVehicle())&&this.sourceObject.rules.movementZone!==G.MovementZone.Fly&&!this.sourceObject.moveTrait.isDisabled()}isAllowed(){return!0}process(){if(!this.target)throw new Error("Target should be set for executing a scatter order. See OrderUnitsAction.");return[new U.ScatterTask(this.game,{tile:this.target.tile,toBridge:!!this.target.getBridge()})]}},g("ScatterOrder",V)}}}),System.register("game/order/StopOrder",["game/order/Order","game/order/OrderType","engine/type/PointerType","game/type/LocomotorType","game/gameobject/task/system/CallbackTask"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){V=class extends I.Order{constructor(g){super(L.OrderType.Stop),this.game=g,this.getPointerType=()=>_.PointerType.NoAction}isValid(){return this.sourceObject.isTechno()}isAllowed(){return!0}process(){return[new G.CallbackTask(g=>{!g.isUnit()||g.rules.locomotor!==U.LocomotorType.Vehicle&&g.rules.locomotor!==U.LocomotorType.Ship||(g.moveTrait.speedPenalty=0)})]}onAdd(g,P){let I=this.sourceObject;return P||!g.length||!I.isUnit()||I.rules.locomotor!==U.LocomotorType.Vehicle&&I.rules.locomotor!==U.LocomotorType.Ship||(I.moveTrait.speedPenalty=.5),I.isBuilding()&&I.rallyTrait?.getRallyPoint()&&(I.unitRepairTrait?.resetRallyPoint(I,this.game),I.factoryTrait?.resetRallyPoint(I,this.game)),!0}},g("StopOrder",V)}}}),System.register("game/Player",["util/Color","engine/type/ObjectType","game/Traits","util/math"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("Player",class{get credits(){return this._credits}set credits(g){if(g<0)throw new RangeError("Can't set credits to a negative value");this._credits=g}constructor(g,P=void 0,L,U=new I.Color(255,0,0)){this.name=g,this.country=P,this.startLocation=L,this.color=U,this.isAi=!1,this.defeated=!1,this.resigned=!1,this.dropped=!1,this.objectsByType=new Map,this.objectsById=new Map,this.traits=new _.Traits,this._credits=0,this.score=0,this.limitedUnitsBuiltByName=new Map,this.unitsBuiltByType=new Map,this.unitsKilledByType=new Map,this.unitsLostByType=new Map,this.buildingsCaptured=0,this.cratesPickedUp=0,this.creditsGained=0,this.cheerCooldownTicks=0,this.isObserver=!P,this.isNeutral=!!P&&!P.isPlayable()}getOrCreateObjectsForType(g){let P=this.objectsByType.get(g);return P||(P=new Set,this.objectsByType.set(g,P)),P}addOwnedObject(g){this.getOrCreateObjectsForType(g.type).add(g),(g.owner=this).objectsById.set(g.id,g)}removeOwnedObject(g){let P=this.objectsByType.get(g.type);if(!P||!P.has(g))throw new Error(`GameObject ${g.name} does not belong to player `+this.name);P.delete(g),this.objectsById.delete(g.id)}getOwnedObjectById(g){return this.objectsById.get(g)}getOwnedObjectsByType(g,P=!1){let I=[];return I=[...this.objectsByType.get(g)||new Set],P||(I=I.filter(g=>!g.limboData)),I}getOwnedObjects(g=!1){let P=[];return[...this.objectsByType.values()].forEach(g=>{g.forEach(g=>P.push(g))}),g||(P=P.filter(g=>!g.limboData)),P}removeAllOwnedObjects(){this.objectsByType.forEach(g=>g.clear()),this.objectsById.clear()}get buildings(){return this.getOrCreateObjectsForType(L.ObjectType.Building)}addUnitsBuilt(g,P){this.unitsBuiltByType.set(g.type,(this.unitsBuiltByType.get(g.type)??0)+P),g.buildLimit<0&&this.limitedUnitsBuiltByName.set(g.name,(this.limitedUnitsBuiltByName.get(g.name)??0)+P)}getUnitsBuilt(g){return void 0!==g?this.unitsBuiltByType.get(g)??0:[...this.unitsBuiltByType.values()].reduce((g,P)=>g+P,0)}getLimitedUnitsBuilt(g){return this.limitedUnitsBuiltByName.get(g)??0}addUnitsKilled(g,P){this.unitsKilledByType.set(g,(this.unitsKilledByType.get(g)??0)+P)}getUnitsKilled(g){return void 0!==g?this.unitsKilledByType.get(g)??0:[...this.unitsKilledByType.values()].reduce((g,P)=>g+P,0)}addUnitsLost(g,P){this.unitsLostByType.set(g,(this.unitsLostByType.get(g)??0)+P)}getUnitsLost(g){return void 0!==g?this.unitsLostByType.get(g)??0:[...this.unitsLostByType.values()].reduce((g,P)=>g+P,0)}isCombatant(){return!this.isNeutral&&!this.isObserver&&!this.defeated}canProduceVeteran(g){if(!this.production||!this.country)throw new Error("Non-combatants can't produce units");var P=this.production.getQueueTypeForObject(g);P=this.production.getFactoryTypeForQueueType(P);return this.production.hasVeteranType(P)||this.country.hasVeteranUnit(g.type,g.name)}getHash(){return U.fnv32a([this.credits,...this.traits.getAll().map(g=>g.getHash?.()??0)])}debugGetState(){return{name:this.name,credits:this.credits,traits:this.traits.getAll().reduce((g,P)=>{var I=P.debugGetState?.();return void 0!==I&&(g[P.constructor.name]=I),g},{})}}dispose(){this.traits.dispose(),this.production?.dispose()}})}}}),System.register("game/player/PlayerFactory",["game/Player","game/Country","game/player/trait/PowerTrait","game/player/trait/RadarTrait","game/player/production/Production","game/SideType","game/player/trait/SuperWeaponsTrait","game/player/trait/SharedDetectDisguiseTrait"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g}],execute:function(){g("PlayerFactory",class{constructor(g,P,I){this.rules=g,this.gameOpts=P,this.allAvailableObjects=I}createCombatant(g,P,L,V,K,q){let $=new I.Player(g,P,L,V);return $.isAi=K,$.aiDifficulty=q,$.powerTrait=new _.PowerTrait($),$.traits.add($.powerTrait),$.radarTrait=new U.RadarTrait,$.traits.add($.radarTrait),$.superWeaponsTrait=new W.SuperWeaponsTrait,$.traits.add($.superWeaponsTrait),$.production=G.Production.factory($,this.rules,this.gameOpts,this.allAvailableObjects),$.sharedDetectDisguiseTrait=new z.SharedDetectDisguiseTrait,$}createObserver(g,P){let L=new I.Player(g,void 0,void 0,P.colors.get("LightGrey"));return L.radarTrait=new U.RadarTrait,L.traits.add(L.radarTrait),L.radarTrait.setDisabled(!1),L}createNeutral(g,P){var U=[...g.countryRules.values()].find(g=>g.side===V.SideType.Civilian);if(!U)throw new Error("Missing neutral country. No country found in rules with Civilian side");U=new L.Country(U);let G=new I.Player(P,U,void 0,g.colors.get("LightGrey"));return G.powerTrait=new _.PowerTrait(G),G.traits.add(G.powerTrait),G}})}}}),System.register("game/player/production/Production",["game/player/production/ProductionQueue","game/rules/TechnoRules","engine/type/ObjectType","util/event","game/rules/GeneralRules","game/SideType"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){W=(new Map).set("POWER",G.PrereqCategory.Power).set("FACTORY",G.PrereqCategory.Factory).set("BARRACKS",G.PrereqCategory.Barracks).set("RADAR",G.PrereqCategory.Radar).set("TECH",G.PrereqCategory.Tech).set("PROC",G.PrereqCategory.Proc),g("Production",class c{static factory(g,P,L,_){let U=new c(g,P.mpDialogSettings.techLevel,L,P,_);var G=P.general.maximumQueuedObjects+1;return U.addQueue(I.QueueType.Structures,new I.ProductionQueue(I.QueueType.Structures,1,1)),U.addQueue(I.QueueType.Armory,new I.ProductionQueue(I.QueueType.Armory,1,1)),U.addQueue(I.QueueType.Infantry,new I.ProductionQueue(I.QueueType.Infantry,G,G)),U.addQueue(I.QueueType.Vehicles,new I.ProductionQueue(I.QueueType.Vehicles,G,G)),U.addQueue(I.QueueType.Ships,new I.ProductionQueue(I.QueueType.Ships,G,G)),U.addQueue(I.QueueType.Aircrafts,new I.ProductionQueue(I.QueueType.Aircrafts,0,G)),U}constructor(g,P,I,L,_){this.player=g,this.maxTechLevel=P,this.gameOpts=I,this.rules=L,this.allAvailableObjects=_,this.buildSpeedModifier=1,this.queues=new Map,this._onQueueUpdate=new U.EventDispatcher,this.primaryFactories=new Map,this.factoryCounts=new Map,this.veteranTypes=new Set,this.stolenTech=new Set}get onQueueUpdate(){return this._onQueueUpdate.asEvent()}addQueue(g,P){this.queues.set(g,P),P.onUpdate.subscribe(()=>this._onQueueUpdate.dispatch(this,P))}getQueue(g){var P=this.queues.get(g);if(!P)throw new Error("No queue found with type "+I.QueueType[g]);return P}getAllQueues(){return[...this.queues.values()]}getQueueTypeForObject(g){if(g.type===_.ObjectType.Building)return g.buildCat===L.BuildCat.Combat?I.QueueType.Armory:I.QueueType.Structures;if(g.type===_.ObjectType.Infantry)return I.QueueType.Infantry;if(g.type===_.ObjectType.Vehicle)return g.naval?I.QueueType.Ships:I.QueueType.Vehicles;if(g.type===_.ObjectType.Aircraft)return I.QueueType.Aircrafts;throw new Error("Unsupported object type "+_.ObjectType[g.type])}getQueueForObject(g){return this.getQueue(this.getQueueTypeForObject(g))}getQueueTypeForFactory(g){if(g===L.FactoryType.InfantryType)return I.QueueType.Infantry;if(g===L.FactoryType.UnitType)return I.QueueType.Vehicles;if(g===L.FactoryType.AircraftType)return I.QueueType.Aircrafts;if(g===L.FactoryType.NavalUnitType)return I.QueueType.Ships;throw new Error("Unsupported factory type "+L.FactoryType[g])}getFactoryTypeForQueueType(g){if(g===I.QueueType.Structures||g===I.QueueType.Armory)return L.FactoryType.BuildingType;if(g===I.QueueType.Infantry)return L.FactoryType.InfantryType;if(g===I.QueueType.Vehicles)return L.FactoryType.UnitType;if(g===I.QueueType.Aircrafts)return L.FactoryType.AircraftType;if(g===I.QueueType.Ships)return L.FactoryType.NavalUnitType;throw new Error("Unsupported queue type "+I.QueueType[g])}getQueueForFactory(g){return this.getQueue(this.getQueueTypeForFactory(g))}isAvailableForProduction(g){return-1!==g.techLevel&&g.techLevel<=this.maxTechLevel&&!(0===g.buildLimit&&!this.player.isAi)&&!(g.superWeapon&&this.rules.getSuperWeapon(g.superWeapon).disableableFromShell&&!this.gameOpts.superWeapons)&&this.hasFactoryFor(g)&&this.meetsPrerequisites(g)}getAvailableObjects(){return this.allAvailableObjects.filter(g=>this.isAvailableForProduction(g))}hasFactoryFor(g){if(g.owner.length){let P=this.getFactoryTypeFor(g);return!![...this.player.buildings].find(I=>I.factoryTrait?.type===P&&(P!==L.FactoryType.UnitType||I.rules.naval===g.naval)&&!!I.rules.owner.find(P=>g.owner.includes(P)))}return!0}meetsStolenTech(g){return g.requiresStolenAlliedTech?this.stolenTech.has(V.SideType.GDI):g.requiresStolenSovietTech?this.stolenTech.has(V.SideType.Nod):!g.requiresStolenThirdTech||this.stolenTech.has(V.SideType.ThirdSide)}getFactoryTypeFor(g){return g.type===_.ObjectType.Building?L.FactoryType.BuildingType:g.type===_.ObjectType.Infantry?L.FactoryType.InfantryType:g.type===_.ObjectType.Aircraft?L.FactoryType.AircraftType:g.naval?L.FactoryType.NavalUnitType:L.FactoryType.UnitType}meetsPrerequisites(g){let P=[...this.player.buildings].map(g=>g.name);for(var I of g.prerequisiteOverride)if(I=I.toUpperCase(),P.includes(I))return!0;if(!g.isAvailableTo(this.player.country))return!1;var L;for(L of g.prerequisite)if(L=L.toUpperCase(),W.has(L)){var _=W.get(L);if(void 0===_)throw new Error("Unknown prereqName "+L);var U,G=this.rules.general.prereqCategories.get(_);if(void 0===G)throw new Error(`Missing prerequisite category ${_} in rules`);let g=!1;for(U of G)if(-1!==P.indexOf(U)){g=!0;break}if(!g)return!1}else if(-1===P.indexOf(L))return!1;return!!this.meetsStolenTech(g)}getPrimaryFactory(g){return this.primaryFactories.get(g)}setPrimaryFactory(g){g.rules.factory&&this.primaryFactories.set(g.rules.factory,g)}isPrimaryFactory(g){return this.getPrimaryFactory(g.rules.factory)===g}incrementFactoryCount(g){this.factoryCounts.set(g,(this.factoryCounts.get(g)??0)+1)}decrementFactoryCount(g){if(!this.factoryCounts.get(g))throw new Error(`Can't decrement factory count ${L.FactoryType[g]}. Already 0`);this.factoryCounts.set(g,this.factoryCounts.get(g)-1)}getFactoryCount(g){return this.factoryCounts.get(g)??0}crownPrimaryFactoryHeir(g){var P=[...this.player.buildings].find(P=>P.rules.factory===g);P?this.primaryFactories.set(g,P):this.primaryFactories.delete(g)}hasAnyFactory(){return 0<this.primaryFactories.size}addVeteranType(g){this.veteranTypes.add(g)}hasVeteranType(g){return this.veteranTypes.has(g)}addStolenTech(g){this.stolenTech.add(g)}dispose(){this.queues.clear(),this.player=void 0}})}}}),System.register("game/player/production/ProductionQueue",["util/event"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g}],execute:function(){var P;(P=L||g("QueueType",L={}))[P.Structures=0]="Structures",P[P.Armory=1]="Armory",P[P.Infantry=2]="Infantry",P[P.Vehicles=3]="Vehicles",P[P.Aircrafts=4]="Aircrafts",P[P.Ships=5]="Ships",(P=_||g("QueueStatus",_={}))[P.Idle=0]="Idle",P[P.Active=1]="Active",P[P.OnHold=2]="OnHold",P[P.Ready=3]="Ready",g("ProductionQueue",class{get onUpdate(){return this._onUpdate.asEvent()}constructor(g,P,L){this.type=g,this._maxSize=P,this.maxItemQuantity=L,this.items=[],this.size=0,this._status=_.Idle,this._onUpdate=new I.EventDispatcher}get status(){return this._status}set status(g){var P=this._status;(this._status=g)!==P&&this._onUpdate.dispatch(this)}get maxSize(){return this._maxSize}set maxSize(g){var P=this.size;this.size=Math.min(g,this.size);let I=0,L=0;for(;I<=this.size&&L<this.items.length;){let g=this.items[L];I+=g.quantity,I>this.size&&(g.quantity-=I-this.size),0<g.quantity&&L++}this._maxSize=g,this.items[L]&&this.items.splice(L),P!==this.size&&(this.size||(this._status=_.Idle),this._onUpdate.dispatch(this))}get currentSize(){return this.size}find(g){return this.items.filter(P=>P.rules===g)}getFirst(){return this.items[0]}getAll(){return[...this.items]}push(g,P,I){P=Math.min(this.maxSize-this.size,P);var L=this.find(g).reduce((g,P)=>g+P.quantity,0);(P=Math.min(this.maxItemQuantity-L,P))&&(this.items[this.items.length-1]?.rules===g?this.items[this.items.length-1].quantity+=P:this.items.push({rules:g,quantity:P,creditsEach:I,creditsSpent:0,creditsSpentLeftover:0,progress:0}),this.size+=P,this._status===_.Idle&&(this._status=_.Active),this._onUpdate.dispatch(this))}insertAfterFirst(g,P,I){P=Math.min(this.maxSize-this.size,P);var L=this.find(g).reduce((g,P)=>g+P.quantity,0);if(P=Math.min(this.maxItemQuantity-L,P))if(this.items.length){let G=this.items[0];var U=G.quantity;L=Math.max(0,U-1);G.quantity=1;const V=[G];U=this.items.slice(1),V.push({rules:g,quantity:P,creditsEach:I,creditsSpent:0,creditsSpentLeftover:0,progress:0}),0<L&&V.push({rules:G.rules,quantity:L,creditsEach:G.creditsEach,creditsSpent:0,creditsSpentLeftover:0,progress:0}),V.push(...U),this.items=V,this.size+=P,this._status===_.Idle&&(this._status=_.Active),this._onUpdate.dispatch(this)}else this.push(g,P,I)}pop(g,P){this.remove(g,P,!1)}shift(g,P){this.remove(g,P,!0)}remove(g,P,I){let U=this.find(g);if(!U.length)throw new Error(`Can't remove non-existent item ${g.name} from queue `+L[this.type]);var G;if(U.reduce((g,P)=>g+P.quantity,0)<P)throw new Error(`Attempted to remove a quantity larger than the one in queue (${g.name})`);let V=P;for(;0<V;){let g=I?U.shift():U.pop();g.quantity<=V?(G=this.getFirst()===g,this.items.splice(this.items.indexOf(g),1),G&&(this._status=_.Active),V-=g.quantity):(g.quantity-=V,V=0)}this.size-=P,P&&(this.size||(this._status=_.Idle),this._onUpdate.dispatch(this))}notifyUpdated(){this._onUpdate.dispatch(this)}})}}}),System.register("game/player/trait/PowerTrait",["game/event/PowerLowEvent","game/event/PowerRestoreEvent","game/event/PowerChangeEvent","game/trait/interface/NotifyPower","util/math"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){var P;(P=V||g("PowerLevel",V={}))[P.Low=0]="Low",P[P.Normal=1]="Normal",g("PowerTrait",class{constructor(g){this.player=g,this.power=0,this.drain=0,this.level=V.Normal,this.blackoutFrames=0,this.powerByObject=new Map}isLowPower(){return this.level===V.Low}setBlackoutFor(g,P){var I=0<this.blackoutFrames;this.blackoutFrames=g,I||this.updateLevel(P)}updateBlackout(g){0<this.blackoutFrames&&(this.blackoutFrames--,this.blackoutFrames<=0&&this.updateLevel(g))}getBlackoutDuration(){return this.blackoutFrames}updateFrom(g,P,I){var L=g.rules.power;if(L){if(L<0)"add"!==P&&"remove"!==P||(this.drain+="add"===P?-L:L);else{let I=0;if("add"===P){var G=Math.ceil(L*g.healthTrait.health/100);this.powerByObject.set(g,G),I=G}else if("update"===P||"remove"===P){if(void 0===(G=this.powerByObject.get(g)))throw new Error("Cannot update power before add.");I="update"===P?(L=Math.ceil(L*g.healthTrait.health/100),this.powerByObject.set(g,L),L-G):(this.powerByObject.delete(g),-G)}this.power+=I}this.updateLevel(I),I.traits.filter(U.NotifyPower).forEach(g=>{g[U.NotifyPower.onPowerChange](this.player,I)}),I.events.dispatch(new _.PowerChangeEvent(this.player,this.power,this.drain))}}updateLevel(g){var P=this.level;this.level=this.power>=this.drain&&!this.blackoutFrames?V.Normal:V.Low,this.level!==P&&(P===V.Normal&&this.level===V.Low&&(g.traits.filter(U.NotifyPower).forEach(P=>{P[U.NotifyPower.onPowerLow](this.player,g)}),g.events.dispatch(new I.PowerLowEvent(this.player))),P===V.Low&&this.level===V.Normal&&(g.traits.filter(U.NotifyPower).forEach(P=>{P[U.NotifyPower.onPowerRestore](this.player,g)}),g.events.dispatch(new L.PowerRestoreEvent(this.player))))}getHash(){return G.fnv32a([this.power,this.drain])}debugGetState(){return{power:this.power,drain:this.drain}}dispose(){this.player=void 0,this.powerByObject.clear()}})}}}),System.register("game/player/trait/RadarTrait",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("RadarTrait",class{constructor(){this.disabled=!0,this.activeEvents=[]}isDisabled(){return this.disabled}setDisabled(g){this.disabled=g}})}}}),System.register("game/player/trait/SharedDetectDisguiseTrait",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("SharedDetectDisguiseTrait",class{constructor(){this.objects=new Set}add(g){this.objects.add(g)}delete(g){this.objects.delete(g)}has(g){return this.objects.has(g)}dispose(){this.objects.clear()}})}}}),System.register("game/player/trait/SuperWeaponsTrait",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("SuperWeaponsTrait",class{constructor(){this.superWeapons=new Map}getAll(){return[...this.superWeapons.values()]}add(g){this.superWeapons.set(g.name,g)}has(g){return this.superWeapons.has(g)}get(g){return this.superWeapons.get(g)}remove(g){this.superWeapons.delete(g)}})}}}),System.register("game/PlayerList",["game/SideType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("PlayerList",class{constructor(){this.players=[]}addPlayer(g){this.players.push(g)}getPlayerAt(g){if(g>=this.players.length)throw new RangeError(`Player #${g} out of bounds`);return this.players[g]}getPlayerByName(g){var P=this.players.find(P=>P.name===g);if(!P)throw new Error(`Player with name "${g}" not found`);return P}getPlayerNumber(g){var P=this.players.indexOf(g);if(-1===P)throw new Error(`Player ${g.name} not found`);return P}getCombatants(){return this.players.filter(g=>g.isCombatant())}getNonNeutral(){return this.players.filter(g=>!g.isNeutral)}getCivilian(){return this.players.find(g=>g.country?.side===I.SideType.Civilian)}getAll(){return this.players}})}}}),System.register("game/Prng",["mersenne-twister","data/Crc32","util/string"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("Prng",class a{static factory(g,P){var I=Number.isNaN(Number(g))?L.Crc32.calculateCrc(_.binaryStringToUint8Array(g)):Number(g+""+P);return new a(I)}constructor(g){this.prng=new I.default(g)}generateRandomInt(g,P){var I=this.prng.random();return this.lastRandom=I,Math.floor(I*(P-g+1))+g}generateRandom(){var g=this.prng.random();return this.lastRandom=g}getLastRandom(){return this.lastRandom}})}}}),System.register("game/rules/AiRules",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("AiRules",class{readIni(g){this.buildPower=g.getArray("BuildPower"),this.buildRefinery=g.getArray("BuildRefinery"),this.buildTech=g.getArray("BuildTech"),this.tiberiumFarScan=g.getNumber("TiberiumFarScan",50),this.tiberiumNearScan=g.getNumber("TiberiumNearScan",5)}})}}}),System.register("game/rules/AudioVisualRules",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("AudioVisualRules",class{readIni(g){this.ini=g,this.ambientChangeRate=g.getNumber("AmbientChangeRate"),this.ambientChangeStep=g.getNumber("AmbientChangeStep"),this.behind=g.getString("Behind"),this.bridgeExplosions=g.getArray("BridgeExplosions"),this.chronoBeamColor=g.getNumberArray("ChronoBeamColor"),this.chronoBlast=g.getString("ChronoBlast"),this.chronoBlastDest=g.getString("ChronoBlastDest"),this.chronoPlacement=g.getString("ChronoPlacement"),this.chronoSparkle1=g.getString("ChronoSparkle1"),this.conditionRed=g.getNumber("ConditionRed"),this.conditionYellow=g.getNumber("ConditionYellow"),this.creditTicks=g.getArray("CreditTicks"),this.extraAircraftLight=g.getNumber("ExtraAircraftLight"),this.extraInfantryLight=g.getNumber("ExtraInfantryLight"),this.extraUnitLight=g.getNumber("ExtraUnitLight");let P=g.getString("DamageFireTypes");P=P||"FIRE01,FIRE02,FIRE03",this.fireNames=P.split(/\.|,/).filter(g=>""!==g),this.flyerHelper=g.getString("FlyerHelper"),this.gravity=g.getNumber("Gravity"),this.idleActionFrequency=60*g.getNumber("IdleActionFrequency"),this.impactLandSound=g.getString("ImpactLandSound")||void 0,this.impactWaterSound=g.getString("ImpactWaterSound")||void 0,this.infantryExplode=g.getString("InfantryExplode"),this.flamingInfantry=g.getString("FlamingInfantry"),this.infantryHeadPop=g.getString("InfantryHeadPop"),this.infantryNuked=g.getString("InfantryNuked"),this.ironCurtainInvokeAnim=g.getString("IronCurtainInvokeAnim"),this.messageDuration=g.getNumber("MessageDuration",10),this.metallicDebris=g.getArray("MetallicDebris"),this.nukeTakeOff=g.getString("NukeTakeOff"),this.deadBodies=g.getArray("DeadBodies"),this.wake=g.getString("Wake"),this.parachute=g.getString("Parachute"),this.moveFlash=g.getString("MoveFlash"),this.warpOut=g.getString("WarpOut"),this.warpAway=g.getString("WarpAway"),this.weaponNullifyAnim=g.getString("WeaponNullifyAnim"),this.weatherConClouds=g.getArray("WeatherConClouds"),this.weatherConBoltExplosion=g.getString("WeatherConBoltExplosion"),this.weatherConBolts=g.getArray("WeatherConBolts")}})}}}),System.register("game/rules/CombatDamageRules",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("CombatDamageRules",class{readIni(g){this.ballisticScatter=g.getNumber("BallisticScatter"),this.bridgeStrength=g.getNumber("BridgeStrength"),this.c4Delay=g.getNumber("C4Delay"),this.c4Warhead=g.getString("C4Warhead"),this.deathWeapon=g.getString("DeathWeapon"),this.dMislEliteWarhead=g.getString("DMislEliteWarhead"),this.dMislWarhead=g.getString("DMislWarhead"),this.flameDamage=g.getString("FlameDamage"),this.ironCurtainDuration=g.getNumber("IronCurtainDuration"),this.ivanDamage=g.getNumber("IvanDamage"),this.ivanIconFlickerRate=g.getNumber("IvanIconFlickerRate"),this.ivanTimedDelay=g.getNumber("IvanTimedDelay"),this.ivanWarhead=g.getString("IvanWarhead"),this.splashList=g.getArray("SplashList"),this.v3EliteWarhead=g.getString("V3EliteWarhead"),this.v3Warhead=g.getString("V3Warhead")}})}}}),System.register("game/rules/CountryRules",["game/SideType"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=(new Map).set("GDI",I.SideType.GDI).set("Nod",I.SideType.Nod).set("Civilian",I.SideType.Civilian).set("Mutant",I.SideType.Mutant).set("ThirdSide",I.SideType.ThirdSide),_=new Map([["Americans","STT:PlayerSideAmerica"],["Alliance","STT:PlayerSideKorea"],["French","STT:PlayerSideFrance"],["Germans","STT:PlayerSideGermany"],["British","STT:PlayerSideBritain"],["Africans","STT:PlayerSideLibya"],["Arabs","STT:PlayerSideIraq"],["Confederation","STT:PlayerSideCuba"],["Russians","STT:PlayerSideRussia"],["YuriCountry","STT:PlayerSideYuriCountry"]]),g("CountryRules",class{constructor(g){this.id=g}readIni(g){this.name=g.name,this.uiName=g.getString("UIName"),this.uiTooltip=g.getString("UITooltip")||_.get(this.name);var P=g.getString("Side");if(!P)throw new Error(`Missing Side for country "${this.name}"`);var I=L.get(P);if(void 0===I)throw new Error(`Unknown side "${P}" for country "${this.name}"`);this.side=I,this.multiplay=g.getBool("Multiplay"),this.multiplayPassive=g.getBool("MultiplayPassive"),this.veteranAircraft=g.getArray("VeteranAircraft"),this.veteranInfantry=g.getArray("VeteranInfantry"),this.veteranUnits=g.getArray("VeteranUnits")}})}}}),System.register("game/rules/CrateRules",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("CrateRules",class{readIni(g){this.crateMaximum=g.getNumber("CrateMaximum"),this.crateMinimum=g.getNumber("CrateMinimum"),this.crateRadius=g.getNumber("CrateRadius"),this.crateRegen=g.getNumber("CrateRegen");let P=g.getString("UnitCrateType");return this.unitCrateType="none"!==P.toLowerCase()?P:void 0,this.healCrateSound=g.getString("HealCrateSound"),this.crateImg=g.getString("CrateImg"),this.waterCrateImg=g.getString("WaterCrateImg"),this.freeMCV=g.getBool("FreeMCV"),this}})}}}),System.register("game/rules/DebrisRules",["util/math","game/rules/ObjectRules"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.ObjectRules{parse(){super.parse(),this.damage=this.ini.getNumber("Damage"),this.damageRadius=this.ini.getNumber("DamageRadius"),this.duration=this.ini.getNumber("Duration"),this.elasticity=I.clamp(this.ini.getNumber("Elasticity",.75),0,1),this.expireAnim=this.ini.getString("ExpireAnim")||void 0,this.minAngularVelocity=this.ini.getNumber("MinAngularVelocity"),this.maxAngularVelocity=this.ini.getNumber("MaxAngularVelocity"),this.maxXYVel=this.ini.getNumber("MaxXYVel"),this.minZVel=this.ini.getNumber("MinZVel"),this.maxZVel=this.ini.getNumber("MaxZVel"),this.shareTurretData=this.ini.getBool("ShareTurretData"),this.shareBodyData=this.ini.getBool("ShareBodyData"),this.shareBarrelData=this.ini.getBool("ShareBarrelData"),this.shareSource=this.ini.getString("ShareSource")||void 0,this.trailerAnim=this.ini.getString("TrailerAnim")||void 0,this.trailerSeparation=this.ini.getNumber("TrailerSeperation"),this.warhead=this.ini.getString("Warhead")||void 0}},g("DebrisRules",_)}}}),System.register("game/rules/ElevationModelRules",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("ElevationModelRules",class{readIni(g){return this.increment=g.getNumber("ElevationIncrement"),this.incrementBonus=g.getNumber("ElevationIncrementBonus",1),this.bonusCap=g.getNumber("ElevationBonusCap"),this}getBonus(g,P){return g<=P?0:Math.min(this.bonusCap,Math.floor((g-P)/this.increment))*this.incrementBonus}})}}}),System.register("game/rules/general/CrewRules",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("CrewRules",class{readIni(g){return this.alliedCrew=g.getString("AlliedCrew"),this.alliedSurvivorDivisor=g.getNumber("AlliedSurvivorDivisor"),this.crewEscape=g.getNumber("CrewEscape"),this.sovietCrew=g.getString("SovietCrew"),this.sovietSurvivorDivisor=g.getNumber("SovietSurvivorDivisor"),this.survivorRate=g.getNumber("SurvivorRate"),this.thirdCrew=g.getString("ThirdCrew"),this.thirdSurvivorDivisor=g.getNumber("ThirdSurvivorDivisor"),this}})}}}),System.register("game/rules/general/DMislRules",["game/rules/general/MissileRules"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.MissileRules{readIni(g){return this.pauseFrames=g.getNumber("DMislPauseFrames"),this.tiltFrames=g.getNumber("DMislTiltFrames"),this.pitchInitial=g.getNumber("DMislPitchInitial"),this.pitchFinal=g.getNumber("DMislPitchFinal"),this.turnRate=g.getNumber("DMislTurnRate"),this.acceleration=g.getNumber("DMislAcceleration"),this.altitude=g.getNumber("DMislAltitude"),this.damage=g.getNumber("DMislDamage"),this.eliteDamage=g.getNumber("DMislEliteDamage"),this.bodyLength=g.getNumber("DMislBodyLength"),this.lazyCurve=g.getBool("DMislLazyCurve"),this.type=g.getString("DMislType"),this}},g("DMislRules",L)}}}),System.register("game/rules/general/HoverRules",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("HoverRules",class{readIni(g){return this.height=g.getNumber("HoverHeight"),this.dampen=g.getNumber("HoverDampen"),this.bob=g.getNumber("HoverBob"),this.boost=g.getNumber("HoverBoost"),this.acceleration=g.getNumber("HoverAcceleration"),this.brake=g.getNumber("HoverBrake"),this}})}}}),System.register("game/rules/general/LightningStormRules",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("LightningStormRules",class{readIni(g){return this.deferment=g.getNumber("LightningDeferment"),this.damage=g.getNumber("LightningDamage"),this.duration=g.getNumber("LightningStormDuration"),this.warhead=g.getString("LightningWarhead"),this.hitDelay=g.getNumber("LightningHitDelay"),this.scatterDelay=g.getNumber("LightningScatterDelay"),this.cellSpread=g.getNumber("LightningCellSpread"),this.separation=g.getNumber("LightningSeparation"),this}})}}}),System.register("game/rules/general/MissileRules",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("MissileRules",class{})}}}),System.register("game/rules/general/ParadropRules",["game/SideType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("ParadropRules",class{readIni(g){if(this.allyParaDrop=this.readParadropSquad(g.getArray("AllyParaDropInf"),g.getNumberArray("AllyParaDropNum"),"Ally"),this.amerParaDrop=this.readParadropSquad(g.getArray("AmerParaDropInf"),g.getNumberArray("AmerParaDropNum"),"Amer"),this.sovParaDrop=this.readParadropSquad(g.getArray("SovParaDropInf"),g.getNumberArray("SovParaDropNum"),"Sov"),this.yuriParaDrop=this.readParadropSquad(g.getArray("YuriParaDropInf"),g.getNumberArray("YuriParaDropNum"),"Yuri"),this.paradropPlane=g.getString("ParadropPlane"),!this.paradropPlane)throw new Error("Missing rules [General]->ParadropPlane");return this.paradropRadius=g.getNumber("ParadropRadius"),this}readParadropSquad(g,P,I){if(g.length!==P.length)throw new RangeError(`${I}ParaDropInf/Num size mismatch (${g.length}, ${P.length})`);let L=[];for(let I=0;I<g.length;++I)0<P[I]&&L.push({inf:g[I],num:P[I]});return L}getParadropSquads(g){switch(g){case I.SideType.GDI:return this.allyParaDrop;case I.SideType.Nod:return this.sovParaDrop;case I.SideType.ThirdSide:return this.yuriParaDrop;default:throw new Error(`Unhandled side type "${g}"`)}}})}}}),System.register("game/rules/general/PrismRules",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("PrismRules",class{readIni(g){return this.type=g.getString("PrismType"),this.supportHeight=g.getNumber("PrismSupportHeight"),this.supportMax=g.getNumber("PrismSupportMax"),this.supportModifier=g.getNumber("PrismSupportModifier",1),this}})}}}),System.register("game/rules/general/RadarRules",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("RadarEventType",I={}))[P.GenericCombat=0]="GenericCombat",P[P.GenericNonCombat=1]="GenericNonCombat",P[P.DropZone=2]="DropZone",P[P.BaseUnderAttack=3]="BaseUnderAttack",P[P.HarvesterUnderAttack=4]="HarvesterUnderAttack",P[P.EnemyObjectSensed=5]="EnemyObjectSensed",g("RadarRules",class{readIni(g){return this.eventSuppressionDistances=g.getNumberArray("RadarEventSuppressionDistances"),this.eventVisibilityDurations=g.getNumberArray("RadarEventVisibilityDurations"),this.eventDurations=g.getNumberArray("RadarEventDurations"),this.flashFrameTime=g.getNumber("FlashFrameTime"),this.combatFlashTime=g.getNumber("RadarCombatFlashTime"),this.eventMinRadius=g.getNumber("RadarEventMinRadius"),this.eventSpeed=g.getNumber("RadarEventSpeed"),this.eventRotationSpeed=g.getNumber("RadarEventRotationSpeed"),this.eventColorSpeed=g.getNumber("RadarEventColorSpeed"),this}getEventSuppresionDistance(g){if(g>this.eventSuppressionDistances.length-1)throw new RangeError("No event suppression distance is defined for type "+I[g]);return this.eventSuppressionDistances[g]}getEventVisibilityDuration(g){if(g>this.eventVisibilityDurations.length-1)throw new RangeError("No event visibility duration is defined for type "+I[g]);return this.eventVisibilityDurations[g]}getEventDuration(g){if(g>this.eventDurations.length-1)throw new RangeError("No event duration is defined for type "+I[g]);return this.eventDurations[g]}})}}}),System.register("game/rules/general/RepairRules",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("RepairRules",class{readIni(g){return this.reloadRate=g.getNumber("ReloadRate"),this.repairPercent=g.getNumber("RepairPercent"),this.repairRate=g.getNumber("RepairRate"),this.repairStep=g.getNumber("RepairStep"),this.uRepairRate=g.getNumber("URepairRate"),this.iRepairRate=g.getNumber("IRepairRate"),this.iRepairStep=g.getNumber("IRepairStep"),this}})}}}),System.register("game/rules/general/ThreatRules",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("ThreatRules",class{readIni(g){return this.myEffectivenessCoefficientDefault=g.getNumber("MyEffectivenessCoefficientDefault"),this.targetEffectivenessCoefficientDefault=g.getNumber("TargetEffectivenessCoefficientDefault"),this.targetSpecialThreatCoefficientDefault=g.getNumber("TargetSpecialThreatCoefficientDefault"),this.targetStrengthCoefficientDefault=g.getNumber("TargetStrengthCoefficientDefault"),this.targetDistanceCoefficientDefault=g.getNumber("TargetDistanceCoefficientDefault"),this}})}}}),System.register("game/rules/general/V3RocketRules",["game/rules/general/MissileRules"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.MissileRules{readIni(g){return this.pauseFrames=g.getNumber("V3RocketPauseFrames"),this.tiltFrames=g.getNumber("V3RocketTiltFrames"),this.pitchInitial=g.getNumber("V3RocketPitchInitial"),this.pitchFinal=g.getNumber("V3RocketPitchFinal"),this.turnRate=g.getNumber("V3RocketTurnRate"),this.acceleration=g.getNumber("V3RocketAcceleration"),this.altitude=g.getNumber("V3RocketAltitude"),this.damage=g.getNumber("V3RocketDamage"),this.eliteDamage=g.getNumber("V3RocketEliteDamage"),this.bodyLength=g.getNumber("V3RocketBodyLength"),this.lazyCurve=g.getBool("V3RocketLazyCurve"),this.type=g.getString("V3RocketType"),this}},g("V3RocketRules",L)}}}),System.register("game/rules/general/VeteranRules",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("VeteranRules",class{readIni(g){return this.veteranRatio=g.getNumber("VeteranRatio",3),this.veteranCombat=g.getNumber("VeteranCombat",1),this.veteranSpeed=g.getNumber("VeteranSpeed",1),this.veteranSight=Math.max(1,g.getNumber("VeteranSight",1)),this.veteranArmor=g.getNumber("VeteranArmor",1),this.veteranROF=g.getNumber("VeteranROF",1),this.veteranCap=g.getNumber("VeteranCap",2),this.initialVeteran=g.getBool("InitialVeteran"),this}})}}}),System.register("game/rules/GeneralRules",["game/rules/general/RadarRules","game/rules/general/RepairRules","game/rules/general/VeteranRules","game/rules/general/CrewRules","game/rules/general/PrismRules","game/rules/general/ThreatRules","game/rules/general/ParadropRules","game/rules/general/LightningStormRules","game/rules/general/V3RocketRules","game/rules/general/DMislRules","game/rules/general/HoverRules","util/math"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g}],execute:function(){var P;(P=Y||g("PrereqCategory",Y={}))[P.Power=0]="Power",P[P.Factory=1]="Factory",P[P.Barracks=2]="Barracks",P[P.Radar=3]="Radar",P[P.Tech=4]="Tech",P[P.Proc=5]="Proc",Z=(new Map).set(Y.Power,"PrerequisitePower").set(Y.Factory,"PrerequisiteFactory").set(Y.Barracks,"PrerequisiteBarracks").set(Y.Radar,"PrerequisiteRadar").set(Y.Tech,"PrerequisiteTech").set(Y.Proc,"PrerequisiteProc"),g("GeneralRules",class{constructor(){this.prereqCategories=new Map}readIni(g){this.aircraftFogReveal=g.getNumber("AircraftFogReveal"),this.alliedDisguise=g.getString("AlliedDisguise"),this.baseUnit=g.getArray("BaseUnit"),this.bridgeVoxelMax=g.getNumber("BridgeVoxelMax"),this.buildSpeed=g.getFixed("BuildSpeed"),this.buildupTime=g.getNumber("BuildupTime"),this.chronoDelay=g.getNumber("ChronoDelay"),this.chronoDistanceFactor=g.getNumber("ChronoDistanceFactor",32),this.chronoHarvTooFarDistance=g.getNumber("ChronoHarvTooFarDistance"),this.chronoMinimumDelay=g.getNumber("ChronoMinimumDelay"),this.chronoRangeMinimum=g.getNumber("ChronoRangeMinimum"),this.chronoTrigger=g.getBool("ChronoTrigger",!0),this.cliffBackImpassability=g.getNumber("CliffBackImpassability",2),this.cloakDelay=g.getNumber("CloakDelay"),this.closeEnough=g.getNumber("CloseEnough"),this.crew=(new U.CrewRules).readIni(g),this.defaultMirageDisguises=g.getArray("DefaultMirageDisguises"),this.dMisl=(new q.DMislRules).readIni(g),this.dropPodWeapon=g.getString("DropPodWeapon"),this.engineer=g.getString("Engineer"),this.engineerCaptureLevel=g.getFixed("EngineerCaptureLevel",.25),this.engineerDamage=g.getFixed("EngineerDamage",.437),this.engineerAlwaysCaptureTech=g.getBool("EngineerAlwaysCaptureTech",!0),this.flightLevel=g.getNumber("FlightLevel"),this.guardAreaTargetingDelay=g.getNumber("GuardAreaTargetingDelay"),this.harvesterTooFarDistance=g.getNumber("HarvesterTooFarDistance"),this.harvesterUnit=g.getArray("HarvesterUnit"),this.hover=(new $.HoverRules).readIni(g),this.infantryBlinkDisguiseTime=g.getNumber("InfantryBlinkDisguiseTime"),this.lightningStorm=(new z.LightningStormRules).readIni(g),this.lowPowerPenaltyModifier=g.getNumber("LowPowerPenaltyModifier",1),this.minLowPowerProductionSpeed=g.getFixed("MinLowPowerProductionSpeed",.5),this.maxLowPowerProductionSpeed=g.getFixed("MaxLowPowerProductionSpeed",1),this.maximumCheerRate=g.getNumber("MaximumCheerRate"),this.maximumQueuedObjects=g.getNumber("MaximumQueuedObjects"),this.maxWaypointPathLength=g.getNumber("MaxWaypointPathLength"),this.multipleFactory=g.getFixed("MultipleFactory",1),this.normalTargetingDelay=g.getNumber("NormalTargetingDelay"),this.padAircraft=g.getArray("PadAircraft"),this.parachuteMaxFallRate=g.getNumber("ParachuteMaxFallRate"),this.paradrop=(new W.ParadropRules).readIni(g),this.prism=(new G.PrismRules).readIni(g),this.purifierBonus=g.getNumber("PurifierBonus"),this.radar=(new I.RadarRules).readIni(g),this.refundPercent=Q.clamp(g.getNumber("RefundPercent"),0,1),this.repair=(new L.RepairRules).readIni(g),this.returnStructures=g.getBool("ReturnStructures"),this.revealTriggerRadius=Math.min(10,g.getNumber("RevealTriggerRadius")),this.shipSinkingWeight=g.getNumber("ShipSinkingWeight"),this.sovietDisguise=g.getString("SovietDisguise"),this.spyMoneyStealPercent=g.getNumber("SpyMoneyStealPercent"),this.spyPowerBlackout=g.getNumber("SpyPowerBlackout"),this.technician=g.getString("Technician"),this.thirdDisguise=g.getString("ThirdDisguise"),this.threat=(new V.ThreatRules).readIni(g),this.treeStrength=g.getNumber("TreeStrength"),this.unitsUnsellable=g.getBool("UnitsUnsellable"),this.v3Rocket=(new K.V3RocketRules).readIni(g),this.veteran=(new _.VeteranRules).readIni(g),this.wallBuildSpeedCoefficient=g.getFixed("WallBuildSpeedCoefficient"),this.readPrereqCategories(g)}readPrereqCategories(g){for(var[P,I]of Z){if(!g.has(I))throw new Error(`Missing prerequisite category ${I} in [General] section`);this.prereqCategories.set(P,g.getArray(I))}}getMissileRules(g){switch(g){case this.v3Rocket.type:return this.v3Rocket;case this.dMisl.type:return this.dMisl;default:throw new Error(`Unsupported missile type "${g}"`)}}})}}}),System.register("game/rules/LandRules",["game/type/SpeedType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("LandRules",class{constructor(){this.speedModifiers=new Map}readIni(g){return this.buildable=g.getBool("Buildable",!1),[...g.entries.keys()].forEach(P=>{void 0!==I.SpeedType[P]&&this.speedModifiers.set(I.SpeedType[P],g.getNumber(P))}),this}getSpeedModifier(g){if(g===I.SpeedType.Foot&&0===this.speedModifiers.get(I.SpeedType.Track))return 0;let P=this.speedModifiers.get(g);return void 0===P&&(P=1),g!==I.SpeedType.Track&&g!==I.SpeedType.Wheel&&0<P&&(P=1),P}})}}}),System.register("game/rules/mpAllowedColors",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("mpAllowedColors",["Gold","DarkRed","DarkBlue","DarkGreen","Orange","DarkSky","Purple","Magenta"])}}}),System.register("game/rules/MpDialogSettings",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("MpDialogSettings",class{readIni(g){return this.minMoney=g.getNumber("MinMoney"),this.money=g.getNumber("Money"),this.maxMoney=g.getNumber("MaxMoney"),this.moneyIncrement=g.getNumber("MoneyIncrement"),this.minUnitCount=g.getNumber("MinUnitCount"),this.unitCount=g.getNumber("UnitCount"),this.maxUnitCount=g.getNumber("MaxUnitCount"),this.crates=g.getBool("Crates"),this.gameSpeed=g.getNumber("GameSpeed"),this.mcvRedeploys=g.getBool("MCVRedeploys"),this.shortGame=g.getBool("ShortGame"),this.superWeapons=g.getBool("SuperWeapons"),this.techLevel=g.getNumber("TechLevel"),this.alliesAllowed=g.getBool("AlliesAllowed",!0),this.allyChangeAllowed=g.getBool("AllyChangeAllowed",!0),this.mustAlly=g.getBool("MustAlly"),this.bridgeDestruction=g.getBool("BridgeDestruction",!0),this.multiEngineer=g.getBool("MultiEngineer"),this}})}}}),System.register("game/rules/ObjectRules",["engine/type/ObjectType"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("ObjectRules",L=class{static iniSpeedToLeptonsPerTick(g,P){return Math.min(256,256*g/P)}static iniRotToDegsPerTick(g){return g/256*360}constructor(g,P,I=-1,L){this.type=g,this.ini=P,this.index=I,this.generalRules=L,this.parse()}parse(){this.alphaImage=this.ini.getString("AlphaImage")||void 0,this.alternateArcticArt=this.ini.getBool("AlternateArcticArt"),this.crushable=this.ini.getBool("Crushable",this.type===I.ObjectType.Infantry),this.crushSound=this.ini.getString("CrushSound")||void 0,this.dontScore=this.ini.getBool("DontScore"),this.insignificant=this.ini.getBool("Insignificant"),this.legalTarget=this.ini.getBool("LegalTarget",!0),this.noShadow=this.ini.getBool("NoShadow"),this.uiName=this.ini.getString("UIName")}get name(){return this.ini.name}get imageName(){let g=this.ini.getString("Image");return g&&"null"!==g||(g=this.name),g}}),L.IMAGE_NONE="none"}}}),System.register("game/rules/ObjectRulesFactory",["engine/type/ObjectType","game/rules/ObjectRules","game/rules/TechnoRules","game/rules/OverlayRules","game/rules/TerrainRules","game/rules/SmudgeRules","game/rules/DebrisRules"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g}],execute:function(){g("ObjectRulesFactory",class{create(g,P,z,K){switch(g){case I.ObjectType.Aircraft:case I.ObjectType.Building:case I.ObjectType.Infantry:case I.ObjectType.Vehicle:return new _.TechnoRules(g,P,K,z);case I.ObjectType.Overlay:return new U.OverlayRules(g,P,K);case I.ObjectType.Terrain:return new G.TerrainRules(g,P,K);case I.ObjectType.Smudge:return new V.SmudgeRules(g,P,K);case I.ObjectType.VoxelAnim:return new W.DebrisRules(g,P,K);default:return new L.ObjectRules(g,P,K)}}})}}}),System.register("game/rules/OverlayRules",["game/type/LandType","game/rules/ObjectRules","game/type/ArmorType"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class extends L.ObjectRules{parse(){super.parse(),this.armor=this.ini.getEnum("Armor",_.ArmorType,_.ArmorType.None,!0),this.crate=this.ini.getBool("Crate");var g=this.ini.getBool("IsARock");this.isARock=g,this.isRubble=this.ini.getBool("IsRubble"),this.isVeinholeMonster=this.ini.getBool("IsVeinholeMonster"),this.isVeins=this.ini.getBool("IsVeins"),this.land=this.ini.getEnum("Land",I.LandType,I.LandType.Clear),this.noUseTileLandType=!!this.ini.getString("NoUseTileLandType"),this.strength=this.ini.getNumber("Strength"),this.tiberium=this.ini.getBool("Tiberium");var P=this.ini.getBool("Wall");this.wall=P,this.radarInvisible=this.ini.getBool("RadarInvisible",!P&&!g)}},g("OverlayRules",U)}}}),System.register("game/rules/PowerupsRules",["game/trait/CrateGeneratorTrait","game/type/PowerupType"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("PowerupsRules",class{constructor(){this.powerups=[]}readIni(g){for(var[P,_]of g.entries){let[g,G,V,W]=_.split(",");var _,U=Number(g);void 0!==(_=L.PowerupType[P])?I.UNSUPPORTED_POWERUP_TYPES.includes(_)||this.powerups.push({type:_,probShares:U,animName:"<none>"!==G.toLowerCase()?G:void 0,waterAllowed:"yes"===V,data:W}):console.warn(`Unknown powerup "${P}". Skipping.`)}return this}})}}}),System.register("game/rules/ProjectileRules",["game/rules/ObjectRules"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.ObjectRules{parse(){super.parse();var g=this.ini.getNumber("ROT",0);let P=this.ini.getNumber("Acceleration");1!==g||P||(P=Number.POSITIVE_INFINITY),P=P||3,this.acceleration=P,this.arcing=this.ini.getBool("Arcing"),this.courseLockDuration=this.ini.getNumber("CourseLockDuration"),this.detonationAltitude=this.ini.getNumber("DetonationAltitude"),this.firersPalette=this.ini.getBool("FirersPalette"),this.flakScatter=this.ini.getBool("FlakScatter"),this.inaccurate=this.ini.getBool("Inaccurate"),this.inviso=this.ini.getBool("Inviso"),this.isAntiAir=this.ini.getBool("AA"),this.isAntiGround=this.ini.getBool("AG",!0),this.level=this.ini.getBool("Level"),this.rot=I.ObjectRules.iniRotToDegsPerTick(g),this.iniRot=g,this.shadow=this.ini.getBool("Shadow",!0),this.shrapnelWeapon=this.ini.getString("ShrapnelWeapon")||void 0,this.shrapnelCount=this.ini.getNumber("ShrapnelCount"),this.subjectToCliffs=this.ini.getBool("SubjectToCliffs"),this.subjectToElevation=this.ini.getBool("SubjectToElevation"),this.subjectToWalls=this.ini.getBool("SubjectToWalls"),this.vertical=this.ini.getBool("Vertical")}},g("ProjectileRules",L)}}}),System.register("game/rules/RadiationRules",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("RadiationRules",class{readIni(g){this.radDurationMultiple=g.getNumber("RadDurationMultiple"),this.radApplicationDelay=g.getNumber("RadApplicationDelay"),this.radLevelMax=g.getNumber("RadLevelMax"),this.radLevelDelay=g.getNumber("RadLevelDelay"),this.radLightDelay=g.getNumber("RadLightDelay"),this.radLevelFactor=g.getNumber("RadLevelFactor"),this.radLightFactor=g.getNumber("RadLightFactor"),this.radTintFactor=g.getNumber("RadTintFactor"),this.radColor=g.getNumberArray("RadColor"),this.radSiteWarhead=g.getString("RadSiteWarhead")}})}}}),System.register("game/rules/Rules",["util/Color","engine/type/ObjectType","game/rules/CountryRules","game/rules/WeaponRules","game/rules/AudioVisualRules","game/rules/GeneralRules","game/rules/MpDialogSettings","game/type/LandType","game/rules/LandRules","game/rules/WarheadRules","game/rules/ProjectileRules","game/rules/ObjectRulesFactory","game/rules/CombatDamageRules","game/rules/TiberiumRules","game/rules/AiRules","game/rules/ElevationModelRules","game/rules/RadiationRules","game/rules/SuperWeaponRules","game/rules/CrateRules","game/rules/PowerupsRules","game/rules/mpAllowedColors","util/typeGuard","game/Weapon"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g}],execute:function(){g("Rules",class{constructor(g,P){this.ini=g,this.logger=P,this.buildingTypes=new Map,this.vehicleTypes=new Map,this.infantryTypes=new Map,this.aircraftTypes=new Map,this.terrainTypes=new Map,this.overlayTypes=new Map,this.overlayIdsByType=new Map,this.animationTypes=new Map,this.animationNames=new Set,this.voxelAnimTypes=new Map,this.smudgeTypes=new Map,this.warheadTypes=new Map,this.tiberiumTypes=new Map,this.superWeaponTypes=new Map,this.countryTypes=new Map,this.weaponTypes=new Map,this.allObjectRules=new Map,this.buildingRules=new Map,this.infantryRules=new Map,this.vehicleRules=new Map,this.aircraftRules=new Map,this.terrainRules=new Map,this.overlayRules=new Map,this.smudgeRules=new Map,this.voxelAnimRules=new Map,this.countryRules=new Map,this.warheadRules=new Map,this.powerups=new se.PowerupsRules,this.colors=new Map,this.general=new V.GeneralRules,this.ai=new X.AiRules,this.crateRules=new re.CrateRules,this.elevationModel=new J.ElevationModelRules,this.mpDialogSettings=new W.MpDialogSettings,this.audioVisual=new G.AudioVisualRules,this.combatDamage=new Y.CombatDamageRules,this.radiation=new ee.RadiationRules,this.landRules=new Map,this.tiberiumRules=new Map,this.superWeaponRules=new Map,this.cachedWeaponRules=new Map,this.cachedProjectileRules=new Map,this.init()}hasObject(g,P){return this.allObjectRules.get(P)?.has(g)}getObject(g,P){var I=this.allObjectRules.get(P)?.get(g);if(!I)throw new Error(`Missing rules for object "${g}"`);return I}getTechnoByInternalId(g,P){let I;if(P===L.ObjectType.Building)I=this.buildingTypes.get(g);else if(P===L.ObjectType.Infantry)I=this.infantryTypes.get(g);else if(P===L.ObjectType.Vehicle)I=this.vehicleTypes.get(g);else{if(P!==L.ObjectType.Aircraft)throw new Error(`Type ${L.ObjectType[P]} is not a techno type`);I=this.aircraftTypes.get(g)}if(void 0===I)throw new Error(`Object type "${L.ObjectType[P]}" with ID "${g}" not found`);return this.getObject(I,P)}getBuilding(g){var P=this.buildingRules.get(g);if(!P)throw new Error(`Missing rules for building "${g}"`);return P}getWeapon(g){let P=this.cachedWeaponRules.get(g);if(!P){var I=this.ini.getSection(g);if(!I)throw new Error(`Weapon ${g} is missing ini section`);P=new U.WeaponRules(I),this.cachedWeaponRules.set(g,P)}return P}getWeaponByInternalId(g){var P=this.weaponTypes.get(g);if(!P)throw new RangeError(`Weapon with internal ID "${g}" not found`);return this.getWeapon(P)}getWarhead(g){let P=g.toLowerCase(),I=this.warheadRules.get(P);if(!I){let L=this.ini.getSection(g);if(!L&&(L=this.ini.getOrderedSections().find(g=>g.name.toLowerCase()===P),!L))throw new Error("Unknown warhead "+g);I=new q.WarheadRules(L),this.warheadRules.set(P,I)}return I}getProjectile(g){let P=g.toLowerCase(),I=this.cachedProjectileRules.get(P);if(!I){let _=this.ini.getSection(g);if(!_&&(_=this.ini.getOrderedSections().find(g=>g.name.toLowerCase()===P),!_))throw new Error(`Projectile ${g} is missing ini section`);I=new $.ProjectileRules(L.ObjectType.Projectile,_),this.cachedProjectileRules.set(P,I)}return I}getOverlayName(g){var P=this.overlayTypes.get(g);if(!P)throw new Error("Invalid overlay id "+g);return P}hasOverlayId(g){return this.overlayTypes.has(g)}getOverlayId(g){var P=this.overlayIdsByType.get(g);if(void 0===P)throw new Error("Invalid overlay name "+g);return P}getOverlay(g){var P=this.overlayRules.get(g);if(!P)throw new Error(`Missing rules for overlay "${g}"`);return P}getAnimationName(g){return this.animationTypes.get(g)}getCountry(g){if(!this.countryRules.has(g))throw new Error("Unknown country "+g);return this.countryRules.get(g)}getMultiplayerCountries(){return[...this.countryRules.values()].filter(g=>g.multiplay)}getMultiplayerColors(){let g=new Map;return ae.mpAllowedColors.forEach(P=>{if(!this.colors.has(P))throw new Error(`Multiplayer color "${P}" does not exist in the rules [Colors] section.`);g.set(P,this.colors.get(P))}),g}getLandRules(g){let P=this.landRules.get(g);var I;return P||(I=g===z.LandType.Cliff?"Rock":z.LandType[g],P=(new K.LandRules).readIni(this.ini.getOrCreateSection(I)),this.landRules.set(g,P)),P}getTiberium(g){var P=this.tiberiumTypes.get(g);if(!P)throw new Error("Unknown tiberium type "+g);return this.tiberiumRules.get(P)}getSuperWeapon(g){if(!this.superWeaponRules.has(g))throw new Error(`Unknown superweapon type "${g}"`);return this.superWeaponRules.get(g)}getIni(){return this.ini}applySpecialFlags(g){g.initialVeteran&&(this.general.veteran.initialVeteran=!0)}init(){this.readAudioVisual(),this.readCombatDamage(),this.readRadiation(),this.readGeneral(),this.readAi(),this.readCrateRules(),this.readElevationModel(),this.readMpDialogSettings(),this.readObjectTypes("BuildingTypes",this.buildingTypes),this.readObjectTypes("InfantryTypes",this.infantryTypes),this.readObjectTypes("VehicleTypes",this.vehicleTypes),this.readObjectTypes("AircraftTypes",this.aircraftTypes),this.readObjectTypes("TerrainTypes",this.terrainTypes),this.readObjectTypes("SmudgeTypes",this.smudgeTypes),this.readObjectTypes("Animations",this.animationTypes),this.animationNames=new Set(this.animationTypes.values()),this.readObjectTypes("VoxelAnims",this.voxelAnimTypes),this.readObjectTypes("OverlayTypes",this.overlayTypes),this.overlayTypes.forEach((g,P)=>this.overlayIdsByType.set(g,P)),this.readColors(),this.readObjectTypes("Countries",this.countryTypes),this.readObjectTypes("Warheads",this.warheadTypes),this.readObjectTypes("Tiberiums",this.tiberiumTypes),this.readObjectTypes("SuperWeaponTypes",this.superWeaponTypes),this.allObjectRules.set(L.ObjectType.Building,this.buildingRules).set(L.ObjectType.Infantry,this.infantryRules).set(L.ObjectType.Vehicle,this.vehicleRules).set(L.ObjectType.Aircraft,this.aircraftRules).set(L.ObjectType.Terrain,this.terrainRules).set(L.ObjectType.Overlay,this.overlayRules).set(L.ObjectType.Smudge,this.smudgeRules).set(L.ObjectType.VoxelAnim,this.voxelAnimRules),this.readObjects(L.ObjectType.Building,this.buildingTypes,this.buildingRules),this.readObjects(L.ObjectType.Infantry,this.infantryTypes,this.infantryRules),this.readObjects(L.ObjectType.Vehicle,this.vehicleTypes,this.vehicleRules),this.readObjects(L.ObjectType.Aircraft,this.aircraftTypes,this.aircraftRules),this.readObjects(L.ObjectType.Terrain,this.terrainTypes,this.terrainRules),this.readObjects(L.ObjectType.Overlay,this.overlayTypes,this.overlayRules),this.readObjects(L.ObjectType.Smudge,this.smudgeTypes,this.smudgeRules),this.readObjects(L.ObjectType.VoxelAnim,this.voxelAnimTypes,this.voxelAnimRules),this.readCountries(),this.readWarheads(),this.readPowerups(),this.readTiberiums(),this.readSuperWeapons(),this.buildWeaponsList()}readAudioVisual(){var g=this.ini.getSection("AudioVisual");if(!g)throw new Error("Missing [AudioVisual] section");this.audioVisual.readIni(g)}readCombatDamage(){var g=this.ini.getSection("CombatDamage");if(!g)throw new Error("Missing [CombatDamage] section");this.combatDamage.readIni(g)}readRadiation(){var g=this.ini.getSection("Radiation");if(!g)throw new Error("Missing [Radiation] section");this.radiation.readIni(g)}readGeneral(){var g=this.ini.getSection("General");if(!g)throw new Error("Missing [General] section");this.general.readIni(g)}readAi(){var g=this.ini.getSection("AI");if(!g)throw new Error("Missing [AI] section");this.ai.readIni(g)}readCrateRules(){var g=this.ini.getSection("CrateRules");if(!g)throw new Error("Missing [CrateRules] section");this.crateRules.readIni(g)}readElevationModel(){var g=this.ini.getSection("ElevationModel");if(!g)throw new Error("Missing [ElevationModel] section");this.elevationModel.readIni(g)}readMpDialogSettings(){var g=this.ini.getSection("MultiplayerDialogSettings");if(!g)throw new Error("Missing [MultiplayerDialogSettings] section");this.mpDialogSettings.readIni(g)}readObjectTypes(g,P){let I=this.ini.getSection(g);if(!I)throw new Error(`Missing [${g}] section`);let L=0,_=new Set;I.entries.forEach((I,U)=>{"string"==typeof I?Number.isNaN(Number(U))?this.logger?.debug(`Non-numeric id "${U}" found in rules section [${g}]. Skipping.`):_.has(I)?this.logger?.debug(`Duplicate type "${I}" in rules section [${g}]. Skipping.`):(P.set(L++,I),_.add(I)):this.logger?.debug(`Non-string type found in rules section [${g}]. Skipping.`)})}readColors(){let g=this.ini.getSection("Colors");if(!g)throw new Error("Missing [Colors] section");g.entries.forEach((g,P)=>{var[L,_,U]=g.split(","),U=I.Color.fromHsv(parseInt(L,10),parseInt(_,10),parseInt(U,10));this.colors.set(P,U)})}readObjects(g,P,I){P.forEach((P,_)=>{var U=this.ini.getSection(P);U?(U=(new Q.ObjectRulesFactory).create(g,U,this.general,_),I.set(P,U)):this.logger?.debug(L.ObjectType[g]+` type "${P}" has no rules section`)})}readCountries(){this.countryTypes.forEach((g,P)=>{var I=this.ini.getSection(g);if(!I)throw new Error("Missing ini section for country "+g);let L=new _.CountryRules(P);L.readIni(I),this.countryRules.set(g,L)})}readWarheads(){this.warheadTypes.forEach(g=>{var P=this.ini.getSection(g);P?(P=new q.WarheadRules(P),this.warheadRules.set(g.toLowerCase(),P)):this.logger?.debug(`Warhead "${g}" has no rules section`)})}readPowerups(){var g=this.ini.getSection("Powerups");if(!g)throw new Error("Missing [Powerups] section");this.powerups.readIni(g)}readTiberiums(){this.tiberiumTypes.forEach((g,P)=>{var I=this.ini.getSection(g);if(!I)throw new Error("Missing rules section for tiberium type "+g);this.tiberiumRules.set(g,new Z.TiberiumRules(P).readIni(I))})}readSuperWeapons(){this.superWeaponTypes.forEach((g,P)=>{var I=this.ini.getSection(g);if(!I)throw new Error("Missing rules section for superweapon type "+g);this.superWeaponRules.set(g,new te.SuperWeaponRules(P).readIni(I))})}buildWeaponsList(){let g=new Set;for(var P of(g.add(this.general.dropPodWeapon),this.superWeaponRules.values()))P.weaponType&&g.add(P.weaponType);var I,L;g.add(oe.Weapon.NUKE_PAYLOAD_NAME);for(let P of[...this.buildingRules.values(),...this.aircraftRules.values(),...this.vehicleRules.values(),...this.infantryRules.values()])for(I of[P.deathWeapon,P.primary,P.secondary,P.elitePrimary,P.eliteSecondary,P.occupyWeapon,P.eliteOccupyWeapon,...P.weaponCount?new Array(P.weaponCount).fill(0).map((g,I)=>[P.getWeaponAtIndex(I),P.getEliteWeaponAtIndex(I)]).flat():[]].filter(ne.isNotNullOrUndefined).filter(g=>""!==g))g.add(I);let _=0;for(L of g)this.weaponTypes.set(_++,L)}})}}}),System.register("game/rules/SmudgeRules",["game/rules/ObjectRules"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.ObjectRules{parse(){super.parse(),this.burn=this.ini.getBool("Burn"),this.crater=this.ini.getBool("Crater"),this.width=this.ini.getNumber("Width",1),this.height=this.ini.getNumber("Height",1)}},g("SmudgeRules",L)}}}),System.register("game/rules/SuperWeaponRules",["game/type/SuperWeaponType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("SuperWeaponRules",class{constructor(g){this.index=g}readIni(g){return this.disableableFromShell=g.getBool("DisableableFromShell"),this.isPowered=g.getBool("IsPowered",!0),this.name=g.name,this.preClick=g.getBool("PreClick"),this.preDependent=g.getEnum("PreDependent",I.SuperWeaponType,void 0),this.postClick=g.getBool("PostClick"),this.rechargeTime=g.getNumber("RechargeTime",5),this.showTimer=g.getBool("ShowTimer"),this.sidebarImage=g.getString("SidebarImage").toLowerCase(),this.type=g.getEnum("Type",I.SuperWeaponType,void 0),this.uiName=g.getString("UIName"),this.weaponType=g.getString("WeaponType")||void 0,this}})}}}),System.register("game/rules/TechnoRules",["engine/type/ObjectType","game/SideType","game/type/SpeedType","game/type/PipColor","game/type/LocomotorType","game/type/MovementZone","game/type/ArmorType","game/type/LandTargeting","game/type/NavalTargeting","game/rules/ObjectRules","game/WeaponType","game/gameobject/unit/VeteranAbility","game/type/VhpScan","game/math/Vector3"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g}],execute:function(){var P;(P=X||g("BuildCat",X={}))[P.Combat=0]="Combat",P[P.Tech=1]="Tech",P[P.Resource=2]="Resource",P[P.Power=3]="Power",(P=J||g("FactoryType",J={}))[P.None=0]="None",P[P.BuildingType=1]="BuildingType",P[P.InfantryType=2]="InfantryType",P[P.UnitType=3]="UnitType",P[P.NavalUnitType=4]="NavalUnitType",P[P.AircraftType=5]="AircraftType",ee=class b extends q.ObjectRules{constructor(g,P,I,L){super(g,P,I,L)}parse(){super.parse(),this.owner=this.ini.getArray("Owner");var g=this.ini.getNumber("AIBasePlanningSide");this.aiBasePlanningSide=-1!==g&&void 0!==L.SideType[g]?g:void 0,this.requiredHouses=this.ini.getArray("RequiredHouses"),this.forbiddenHouses=this.ini.getArray("ForbiddenHouses"),this.requiresStolenAlliedTech=this.ini.getBool("RequiresStolenAlliedTech"),this.requiresStolenSovietTech=this.ini.getBool("RequiresStolenSovietTech"),this.requiresStolenThirdTech=this.ini.getBool("RequiresStolenThirdTech"),this.techLevel=this.ini.getNumber("TechLevel",-1),this.cost=this.ini.getNumber("Cost"),this.points=this.ini.getNumber("Points"),this.power=this.ini.getNumber("Power"),this.powered=this.ini.getBool("Powered"),this.prerequisite=this.ini.getArray("Prerequisite"),this.prerequisiteOverride=this.ini.getArray("PrerequisiteOverride"),this.soylent=this.ini.getNumber("Soylent"),this.crateGoodie=this.ini.getBool("CrateGoodie"),this.buildCat=this.ini.getEnum("BuildCat",X,X.Combat),this.adjacent=this.ini.getNumber("Adjacent",1),this.baseNormal=this.ini.getBool("BaseNormal",!0),this.buildLimit=this.ini.getNumber("BuildLimit",Number.POSITIVE_INFINITY),this.airRangeBonus=this.ini.getNumber("AirRangeBonus"),this.guardRange=this.ini.getNumber("GuardRange"),this.defaultToGuardArea=this.ini.getBool("DefaultToGuardArea"),this.eligibileForAllyBuilding=this.ini.getBool("EligibileForAllyBuilding"),this.numberImpassableRows=this.ini.getNumber("NumberImpassableRows"),this.bridgeRepairHut=this.ini.getBool("BridgeRepairHut"),this.constructionYard=this.ini.getBool("ConstructionYard"),this.refinery=this.ini.getBool("Refinery"),this.unitRepair=this.ini.getBool("UnitRepair"),this.unitReload=this.ini.getBool("UnitReload"),this.unitSell=this.ini.getBool("UnitSell"),this.isBaseDefense=this.ini.getBool("IsBaseDefense"),this.superWeapon=this.parseWeaponName(this.ini.getString("SuperWeapon")),this.chargedAnimTime=this.ini.getNumber("ChargedAnimTime");var P=this.ini.getBool("Naval");this.naval=P,this.underwater=this.ini.getBool("Underwater"),this.waterBound=this.ini.getBool("WaterBound"),this.orePurifier=this.ini.getBool("OrePurifier"),this.cloning=this.ini.getBool("Cloning"),this.grinding=this.ini.getBool("Grinding"),this.nukeSilo=this.ini.getBool("NukeSilo"),this.repairable=this.ini.getBool("Repairable",this.type===I.ObjectType.Building),this.clickRepairable=this.ini.getBool("ClickRepairable",this.type===I.ObjectType.Building),this.unsellable=this.ini.getBool("Unsellable",this.type!==I.ObjectType.Building&&this.generalRules.unitsUnsellable),this.returnable=this.ini.getBool("Returnable",this.generalRules.returnStructures),this.gdiBarracks=this.ini.getBool("GDIBarracks"),this.nodBarracks=this.ini.getBool("NODBarracks"),this.numberOfDocks=this.ini.getNumber("NumberOfDocks"),this.unitRepair&&!this.numberOfDocks&&(this.numberOfDocks=1),this.factory=this.ini.getEnum("Factory",J,J.None),this.factory===J.UnitType&&P&&(this.factory=J.NavalUnitType),this.weaponsFactory=this.ini.getBool("WeaponsFactory"),this.helipad=this.ini.getBool("Helipad"),this.hospital=this.ini.getBool("Hospital"),this.landTargeting=this.ini.getEnumNumeric("LandTargeting",z.LandTargeting,z.LandTargeting.LandOk),this.navalTargeting=this.ini.getEnumNumeric("NavalTargeting",K.NavalTargeting,K.NavalTargeting.UnderwaterNever),this.tooBigToFitUnderBridge=this.ini.getBool("TooBigToFitUnderBridge",this.type===I.ObjectType.Building),this.canBeOccupied=this.ini.getBool("CanBeOccupied"),this.maxNumberOccupants=this.ini.getNumber("MaxNumberOccupants"),this.leaveRubble=this.ini.getBool("LeaveRubble"),this.undeploysInto=this.ini.getString("UndeploysInto"),this.deploysInto=this.ini.getString("DeploysInto"),this.deployTime=this.ini.getNumber("DeployTime"),this.capturable=this.ini.getBool("Capturable"),this.spyable=this.ini.getBool("Spyable"),this.needsEngineer=this.ini.getBool("NeedsEngineer"),this.c4=this.ini.getBool("C4"),this.canC4=this.ini.getBool("CanC4",!0),this.eligibleForDelayKill=this.ini.getBool("EligibleForDelayKill"),this.produceCashStartup=this.ini.getNumber("ProduceCashStartup"),this.produceCashAmount=this.ini.getNumber("ProduceCashAmount"),this.produceCashDelay=this.ini.getNumber("ProduceCashDelay"),this.explosion=this.ini.getArray("Explosion"),this.explodes=this.ini.getBool("Explodes"),this.ifvMode=this.ini.getNumber("IFVMode"),this.turretIndexesByIfvMode=this.parseTurretIndexes(),this.turret=this.ini.getBool("Turret"),this.turretCount=this.ini.getNumber("TurretCount",this.turret?1:0),this.turretAnim=this.ini.getString("TurretAnim"),this.turretAnimIsVoxel=this.ini.getBool("TurretAnimIsVoxel"),this.turretAnimX=this.ini.getNumber("TurretAnimX"),this.turretAnimY=this.ini.getNumber("TurretAnimY"),this.turretAnimZAdjust=this.ini.getNumber("TurretAnimZAdjust"),this.isChargeTurret=this.ini.getBool("IsChargeTurret"),this.overpowerable=this.ini.getBool("Overpowerable"),this.freeUnit=this.ini.getString("FreeUnit"),this.primary=this.parseWeaponName(this.ini.getString("Primary")),this.secondary=this.parseWeaponName(this.ini.getString("Secondary")),this.elitePrimary=this.parseWeaponName(this.ini.getString("ElitePrimary")),this.eliteSecondary=this.parseWeaponName(this.ini.getString("EliteSecondary")),this.weaponCount=this.ini.getNumber("WeaponCount"),this.deathWeapon=this.parseWeaponName(this.ini.getString("DeathWeapon")),this.deathWeaponDamageModifier=this.ini.getNumber("DeathWeaponDamageModifier",1),this.occupyWeapon=this.parseWeaponName(this.ini.getString("OccupyWeapon")),this.eliteOccupyWeapon=this.parseWeaponName(this.ini.getString("EliteOccupyWeapon")),this.veteranAbilities=new Set(this.ini.getEnumArray("VeteranAbilities",Q.VeteranAbility)),this.eliteAbilities=new Set([...this.veteranAbilities,...this.ini.getEnumArray("EliteAbilities",Q.VeteranAbility)]),this.selfHealing=this.ini.getBool("SelfHealing"),this.wall=this.ini.getBool("Wall"),this.gate=this.ini.getBool("Gate"),this.armor=this.ini.getEnum("Armor",W.ArmorType,W.ArmorType.None,!0),this.strength=Math.floor(this.ini.getNumber("Strength")),this.immune=this.ini.getBool("Immune"),this.immuneToRadiation=this.ini.getBool("ImmuneToRadiation"),this.immuneToPsionics=this.ini.getBool("ImmuneToPsionics"),this.typeImmune=this.ini.getBool("TypeImmune"),this.damageSelf=this.ini.getBool("DamageSelf"),this.warpable=this.ini.getBool("Warpable",!0),this.isTilter=this.ini.getBool("IsTilter",!0),this.walkRate=this.ini.getNumber("WalkRate",1),this.idleRate=this.ini.getNumber("IdleRate",0),this.noSpawnAlt=this.ini.getBool("NoSpawnAlt"),this.crusher=this.ini.getBool("Crusher"),this.consideredAircraft=this.ini.getBool("ConsideredAircraft"),this.crashable=this.ini.getBool("Crashable");var ee=this.ini.getBool("Landable");this.landable=ee,this.airportBound=this.ini.getBool("AirportBound"),this.balloonHover=this.ini.getBool("BalloonHover"),this.hoverAttack=this.ini.getBool("HoverAttack"),this.omniFire=this.ini.getBool("OmniFire"),this.fighter=this.ini.getBool("Fighter"),this.flightLevel=this.ini.getNumber("FlightLevel")||void 0;var te=this.ini.getString("Locomotor");g=this.type===I.ObjectType.Building?G.LocomotorType.Statue:G.LocomotorType.Chrono;if(te?(P=G.locomotorTypesByClsId.get(te))?this.locomotor=P:(console.warn(`Object rules "${this.name}" has invalid Locomotor "${te}"`),this.locomotor=g):this.locomotor=g,this.locomotor!==G.LocomotorType.Statue){let g=G.defaultSpeedsByLocomotor.get(this.locomotor);void 0===g&&(this.type===I.ObjectType.Aircraft||this.consideredAircraft?g=_.SpeedType.Winged:this.type===I.ObjectType.Vehicle?g=this.crusher?_.SpeedType.Track:_.SpeedType.Wheel:this.type===I.ObjectType.Infantry&&(g=_.SpeedType.Foot)),this.speedType=this.ini.getEnum("SpeedType",_.SpeedType,g,!0)}g=[G.LocomotorType.Ship,G.LocomotorType.Vehicle,G.LocomotorType.Chrono].includes(this.locomotor)?65:100,this.speed=q.ObjectRules.iniSpeedToLeptonsPerTick(this.ini.getNumber("Speed"),g),this.movementZone=this.ini.getEnum("MovementZone",V.MovementZone,V.MovementZone.Normal),this.fearless=this.ini.getBool("Fearless"),this.deployer=this.ini.getBool("Deployer"),this.deployFire=this.ini.getBool("DeployFire"),this.deployFireWeapon=this.ini.getNumber("DeployFireWeapon",$.WeaponType.Secondary),this.undeployDelay=this.ini.getNumber("UndeployDelay"),this.fraidycat=this.ini.getBool("Fraidycat",!1),this.isHuman=!this.ini.getBool("NotHuman"),this.organic=this.type===I.ObjectType.Infantry||this.ini.getBool("Organic"),this.occupier=this.ini.getBool("Occupier"),this.engineer=this.ini.getBool("Engineer"),this.ivan=this.ini.getBool("Ivan"),this.civilian=this.ini.getBool("Civilian"),this.agent=this.ini.getBool("Agent"),this.infiltrate=this.ini.getBool("Infiltrate"),this.threatPosed=this.ini.getNumber("ThreatPosed"),this.specialThreatValue=this.ini.getNumber("SpecialThreatValue"),this.canPassiveAquire=this.ini.getBool("CanPassiveAquire",!0),this.canRetaliate=this.ini.getBool("CanRetaliate",!0),this.preventAttackMove=this.ini.getBool("PreventAttackMove"),this.opportunityFire=this.ini.getBool("OpportunityFire"),this.distributedFire=this.ini.getBool("DistributedFire"),this.radialFireSegments=this.ini.getNumber("RadialFireSegments"),this.attackCursorOnFriendlies=this.ini.getBool("AttackCursorOnFriendlies"),this.bombable=this.ini.getBool("Bombable",!0),this.trainable=this.ini.getBool("Trainable",this.type!==I.ObjectType.Building),this.crewed=this.ini.getBool("Crewed"),this.parasiteable=this.ini.getBool("Parasiteable",this.type!==I.ObjectType.Building),this.suppressionThreshold=this.ini.getNumber("SuppressionThreshold"),this.reselectIfLimboed=this.ini.getBool("ReselectIfLimboed"),this.rejoinTeamIfLimboed=this.ini.getBool("RejoinTeamIfLimboed"),this.weight=this.ini.getNumber("Weight"),this.accelerates=this.ini.getBool("Accelerates",!0),this.accelerationFactor=this.ini.getNumber("AccelerationFactor",.03),this.teleporter=this.ini.getBool("Teleporter"),this.canDisguise=this.ini.getBool("CanDisguise"),this.disguiseWhenStill=this.ini.getBool("DisguiseWhenStill"),this.permaDisguise=this.ini.getBool("PermaDisguise"),this.detectDisguise=this.ini.getBool("DetectDisguise"),this.detectDisguiseRange=this.ini.getNumber("DetectDisguiseRange"),this.cloakable=this.ini.getBool("Cloakable"),this.sensors=this.ini.getBool("Sensors"),this.sensorArray=this.ini.getBool("SensorArray"),this.sensorsSight=this.ini.getNumber("SensorsSight"),this.burstDelay=this.parseBurstDelay(),this.vhpScan=this.ini.getEnum("VHPScan",Y.VhpScan,Y.VhpScan.None,!0),this.pip=this.ini.getEnum("Pip",U.PipColor,U.PipColor.Green,!0),this.passengers=this.ini.getNumber("Passengers"),this.gunner=this.ini.getBool("Gunner"),this.ammo=this.ini.getNumber("Ammo",-1),this.initialAmmo=this.ini.getNumber("InitialAmmo",-1),this.manualReload=this.ini.getBool("ManualReload",this.type===I.ObjectType.Aircraft),this.storage=this.ini.getNumber("Storage"),this.spawned=this.ini.getBool("Spawned"),this.spawns=this.ini.getString("Spawns"),this.spawnsNumber=this.ini.getNumber("SpawnsNumber"),this.spawnRegenRate=this.ini.getNumber("SpawnRegenRate"),this.spawnReloadRate=this.ini.getNumber("SpawnReloadRate"),this.missileSpawn=this.ini.getBool("MissileSpawn"),this.size=this.ini.getNumber("Size",1),this.sizeLimit=this.ini.getNumber("SizeLimit"),this.sight=Math.min(b.MAX_SIGHT,this.needsEngineer?6:this.ini.getNumber("Sight",1)),this.spySat=this.ini.getBool("SpySat"),this.gapGenerator=this.ini.getBool("GapGenerator"),this.gapRadiusInCells=this.ini.getNumber("GapRadiusInCells"),this.psychicDetectionRadius=this.ini.getNumber("PsychicDetectionRadius"),this.hasRadialIndicator=this.ini.getBool("HasRadialIndicator"),this.harvester=this.ini.getBool("Harvester"),this.unloadingClass=this.ini.getString("UnloadingClass"),this.dock=this.ini.getArray("Dock"),this.radar=this.ini.getBool("Radar"),this.radarInvisible=this.ini.getBool("RadarInvisible"),this.revealToAll=this.ini.getBool("RevealToAll"),this.selectable=!(this.type===I.ObjectType.Aircraft&&!ee)&&this.ini.getBool("Selectable",!0),this.isSelectableCombatant=this.ini.getBool("IsSelectableCombatant"),this.invisibleInGame=this.ini.getBool("InvisibleInGame"),this.moveToShroud=this.ini.getBool("MoveToShroud",this.type!==I.ObjectType.Aircraft),this.leadershipRating=this.ini.getNumber("LeadershipRating",5),this.unnatural=this.ini.getBool("Unnatural"),this.natural=this.ini.getBool("Natural"),this.buildTimeMultiplier=this.ini.getFixed("BuildTimeMultiplier",1),this.allowedToStartInMultiplayer=this.ini.getBool("AllowedToStartInMultiplayer",!0),this.rot=q.ObjectRules.iniRotToDegsPerTick(this.ini.getNumber("ROT",0)),this.jumpjetAccel=this.ini.getNumber("JumpJetAccel",2),this.jumpjetClimb=this.ini.getNumber("JumpjetClimb",5),this.jumpjetCrash=this.ini.getNumber("JumpjetCrash",5),this.jumpjetDeviation=this.ini.getNumber("JumpjetDeviation",40),this.jumpjetHeight=this.ini.getNumber("JumpjetHeight",500),this.jumpjetNoWobbles=this.ini.getBool("JumpjetNoWobbles"),this.jumpjetSpeed=this.ini.getNumber("JumpjetSpeed",14),this.jumpjetTurnRate=q.ObjectRules.iniRotToDegsPerTick(this.ini.getNumber("JumpJetTurnRate",4)),this.jumpjetWobbles=this.ini.getNumber("JumpjetWobbles",.15),this.pitchSpeed=this.ini.getNumber("PitchSpeed",.25),this.pitchAngle=1<=this.pitchSpeed?0:20,this.damageParticleSystems=this.ini.getArray("DamageParticleSystems"),ee=this.ini.getNumberArray("DamageSmokeOffset",void 0,[0,0,0]),this.damageSmokeOffset=new Z.Vector3(ee[0],ee[2]/Math.SQRT2,ee[1]),this.minDebris=this.ini.getNumber("MinDebris"),this.maxDebris=this.ini.getNumber("MaxDebris"),this.debrisTypes=this.ini.getArray("DebrisTypes"),this.debrisAnims=this.ini.getArray("DebrisAnims"),this.isLightpost="GALITE"===this.imageName,this.lightVisibility=this.ini.getNumber("LightVisibility",5e3),this.lightIntensity=this.ini.getNumber("LightIntensity"),this.lightRedTint=this.ini.getNumber("LightRedTint",1),this.lightGreenTint=this.ini.getNumber("LightGreenTint",1),this.lightBlueTint=this.ini.getNumber("LightBlueTint",1),this.ambientSound=this.ini.getString("AmbientSound")||void 0,this.createSound=this.ini.getString("CreateSound")||void 0,this.deploySound=this.ini.getString("DeploySound")||void 0,this.undeploySound=this.ini.getString("UndeploySound")||void 0,this.voiceSelect=this.ini.getString("VoiceSelect")||void 0,this.voiceMove=this.ini.getString("VoiceMove")||void 0,this.voiceAttack=this.ini.getString("VoiceAttack")||void 0,this.voiceFeedback=this.ini.getString("VoiceFeedback")||void 0,this.voiceSpecialAttack=this.ini.getString("VoiceSpecialAttack")||void 0,this.voiceEnter=this.ini.getString("VoiceEnter")||void 0,this.voiceCapture=this.ini.getString("VoiceCapture")||void 0,this.voiceCrashing=this.ini.getString("VoiceCrashing")||void 0,this.crashingSound=this.ini.getString("CrashingSound")||void 0,this.impactLandSound=this.ini.getString("ImpactLandSound")||void 0,this.auxSound1=this.ini.getString("AuxSound1")||void 0,this.auxSound2=this.ini.getString("AuxSound2")||void 0,this.dieSound=this.ini.getString("DieSound")||void 0,this.moveSound=this.ini.getString("MoveSound")||void 0,this.enterWaterSound=this.ini.getString("EnterWaterSound")||void 0,this.leaveWaterSound=this.ini.getString("LeaveWaterSound")||void 0,this.turretRotateSound=this.ini.getString("TurretRotateSound")||void 0,this.workingSound=this.ini.getString("WorkingSound")||void 0,this.notWorkingSound=this.ini.getString("NotWorkingSound")||void 0,this.chronoInSound=this.ini.getString("ChronoInSound")||void 0,this.chronoOutSound=this.ini.getString("ChronoOutSound")||void 0,this.enterTransportSound=this.ini.getString("EnterTransportSound")||void 0,this.leaveTransportSound=this.ini.getString("LeaveTransportSound")||void 0}parseWeaponName(g){return g&&"none"!==g.toLowerCase()?g:void 0}parseTurretIndexes(){let g=new Map;return this.ini.getBool("Gunner")&&this.ini.entries.forEach((P,I)=>{var L=I.match(/^(.*)TurretWeapon$/i);L&&(L=L[1]+"TurretIndex",this.ini.has(L)&&g.set(Number(P),this.ini.getNumber(L)))}),g}parseBurstDelay(){let g=[];for(let P=0;P<4;++P)g.push(this.ini.has("BurstDelay"+P)?this.ini.getNumber("BurstDelay"+P):void 0);return g}hasOwner(g){return!!this.owner.length&&-1!==this.owner.indexOf(g.name)}isAvailableTo(g){return(!this.requiredHouses.length||-1!==this.requiredHouses.indexOf(g.name))&&-1===this.forbiddenHouses.indexOf(g.name)}getWeaponAtIndex(g){return this.parseWeaponName(this.ini.getString("Weapon"+(g+1)))}getEliteWeaponAtIndex(g){return this.parseWeaponName(this.ini.getString("EliteWeapon"+(g+1)))}},g("TechnoRules",ee),ee.MAX_SIGHT=11}}}),System.register("game/rules/TerrainRules",["game/rules/ObjectRules","engine/TheaterType"],function(g,P){"use strict";var I,L,_,U;function n(g,P){switch(g){case 0:case 1:return!0;case 2:return 0!=(P&_.Right);case 3:return 0!=(P&_.Left);case 4:return 0!=(P&_.Bottom);default:throw new Error('Invalid subCell "'+g)}}return P&&P.id,g("testOccupationBit",n),{setters:[function(g){I=g},function(g){L=g}],execute:function(){var P;(P=_||g("OccupationBits",_={}))[P.All=7]="All",P[P.Right=1]="Right",P[P.Left=2]="Left",P[P.Bottom=4]="Bottom",U=class extends I.ObjectRules{parse(){super.parse(),this.animationRate=this.ini.getNumber("AnimationRate"),this.animationProbability=this.ini.getNumber("AnimationProbability"),this.gate=this.ini.getBool("Gate"),this.immune=this.ini.getBool("Immune"),this.isAnimated=this.ini.getBool("IsAnimated"),this.snowOccupationBits=this.normalizeOccupationBits(this.ini.getNumber("SnowOccupationBits",_.All)),this.spawnsTiberium=this.ini.getBool("SpawnsTiberium"),this.strength=this.ini.getNumber("Strength"),this.radarInvisible=this.ini.getBool("RadarInvisible"),this.temperateOccupationBits=this.normalizeOccupationBits(this.ini.getNumber("TemperateOccupationBits",_.All))}normalizeOccupationBits(g){return(g+8*Math.abs(Math.floor(g/8)))%8}getOccupationBits(g){return g!==L.TheaterType.Snow?this.temperateOccupationBits:this.snowOccupationBits}getOccupiedSubCells(g){var P,I=this.getOccupationBits(g),L=[0,1,2,3,4];if(I===_.All)return L;let U=[];for(P of L)n(P,I)&&U.push(P);return U}},g("TerrainRules",U)}}}),System.register("game/rules/TiberiumRules",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("TiberiumRules",class{constructor(g){this.type=g}readIni(g){return this.value=g.getNumber("Value"),this}})}}}),System.register("game/rules/WarheadRules",["game/gameobject/infantry/InfDeathType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("WarheadRules",class{constructor(g){this.rules=g,this.verses=new Map,this.parse()}get name(){return this.rules.name}parse(){this.affectsAllies=this.rules.getBool("AffectsAllies",!0),this.animList=this.rules.getArray("AnimList"),this.bombDisarm=this.rules.getBool("BombDisarm"),this.bullets=this.rules.getBool("Bullets"),this.causesDelayKill=this.rules.getBool("CausesDelayKill"),this.cellSpread=this.rules.getNumber("CellSpread"),this.conventional=this.rules.getBool("Conventional"),this.culling=this.rules.getBool("Culling"),this.delayKillAtMax=this.rules.getNumber("DelayKillAtMax"),this.delayKillFrames=this.rules.getNumber("DelayKillFrames"),this.electricAssault=this.rules.getBool("ElectricAssault"),this.emEffect=this.rules.getBool("EMEffect"),this.infDeath=this.rules.getEnumNumeric("InfDeath",I.InfDeathType,I.InfDeathType.None),this.ivanBomb=this.rules.getBool("IvanBomb"),this.makesDisguise=this.rules.getBool("MakesDisguise"),this.mindControl=this.rules.getBool("MindControl"),this.nukeMaker=this.rules.getBool("NukeMaker"),this.paralyzes=this.rules.getNumber("Paralyzes"),this.parasite=this.rules.getBool("Parasite"),this.percentAtMax=this.rules.getNumber("PercentAtMax",1),this.proneDamage=this.rules.getFixed("ProneDamage",1),this.psychicDamage=this.rules.getBool("PsychicDamage"),this.radiation=this.rules.getBool("Radiation"),this.rocker=this.rules.getBool("Rocker"),this.sonic=this.rules.getBool("Sonic"),this.temporal=this.rules.getBool("Temporal"),this.rules.getFixedArray("Verses").forEach((g,P)=>this.verses.set(P,g)),this.wallAbsoluteDestroyer=this.rules.getBool("WallAbsoluteDestroyer"),this.wall=this.rules.getBool("Wall"),this.wood=this.rules.getBool("Wood")}})}}}),System.register("game/rules/WeaponRules",["game/rules/ObjectRules"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("WeaponRules",class{constructor(g){this.rules=g,this.parse()}parse(){this.ambientDamage=this.rules.getNumber("AmbientDamage"),this.anim=this.rules.getArray("Anim"),this.areaFire=this.rules.getBool("AreaFire"),this.burst=this.rules.getNumber("Burst",1),this.cellRangefinding=this.rules.getBool("CellRangefinding"),this.damage=this.rules.getNumber("Damage"),this.decloakToFire=this.rules.getBool("DecloakToFire",!0),this.fireOnce=this.rules.getBool("FireOnce"),this.isAlternateColor=this.rules.getBool("IsAlternateColor"),this.isElectricBolt=this.rules.getBool("IsElectricBolt"),this.isHouseColor=this.rules.getBool("IsHouseColor"),this.isLaser=this.rules.getBool("IsLaser"),this.isRadBeam=this.rules.getBool("IsRadBeam"),this.isSonic=this.rules.getBool("IsSonic"),this.laserDuration=this.rules.getNumber("LaserDuration"),this.limboLaunch=this.rules.getBool("LimboLaunch"),this.minimumRange=this.rules.getNumber("MinimumRange"),this.name=this.rules.name,this.neverUse=this.rules.getBool("NeverUse"),this.omniFire=this.rules.getBool("OmniFire"),this.projectile=this.rules.getString("Projectile"),this.radLevel=this.rules.getNumber("RadLevel"),this.range=this.rules.getNumber("Range"),-2===this.range&&(this.range=Number.POSITIVE_INFINITY),this.report=this.rules.getArray("Report"),this.revealOnFire=this.rules.getBool("RevealOnFire",!0),this.rof=this.rules.getNumber("ROF"),this.sabotageCursor=this.rules.getBool("SabotageCursor"),this.spawner=this.rules.getBool("Spawner");var g=this.rules.getNumber("Speed");this.iniSpeed=g,this.speed=I.ObjectRules.iniSpeedToLeptonsPerTick(g,100),this.suicide=this.rules.getBool("Suicide"),this.useSparkParticles=this.rules.getBool("UseSparkParticles"),this.warhead=this.rules.getString("Warhead")}})}}}),System.register("game/SideType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("SideType",I={}))[P.GDI=0]="GDI",P[P.Nod=1]="Nod",P[P.ThirdSide=2]="ThirdSide",P[P.Civilian=3]="Civilian",P[P.Mutant=4]="Mutant"}}}),System.register("game/SpecialWarheadType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("SpecialWarheadType",I={}))[P.None=0]="None",P[P.Shrapnel=1]="Shrapnel",P[P.LightningStrike=2]="LightningStrike",P[P.TntCharge=3]="TntCharge"}}}),System.register("game/StartingUnitsGenerator",["engine/type/ObjectType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("StartingUnitsGenerator",class{static generate(g,P,L,_){var U,G=L.reduce((g,P)=>g+P.cost,0)/L.length*g;let V=[],W=G,z=(L=L.filter(g=>g.isAvailableTo(_)&&g.hasOwner(_))).filter(g=>P.includes(g.name));for(U of z){if(W<=0)break;var K=2/3/z.length;W-=(K=Math.ceil(K*G/U.cost))*U.cost,V.push({name:U.name,type:I.ObjectType.Vehicle,count:K})}var q,$=L.filter(g=>!z.includes(g)),Q=W/$.length;for(q of $){if(W<=0)break;var Y=Math.ceil(Q/q.cost);W-=Y*q.cost,V.push({name:q.name,type:I.ObjectType.Infantry,count:Y})}return V}})}}}),System.register("game/SuperWeapon",["game/event/SuperWeaponReadyEvent","game/GameSpeed"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){var P;(P=_||g("SuperWeaponStatus",_={}))[P.Charging=0]="Charging",P[P.Paused=1]="Paused",P[P.Ready=2]="Ready",g("SuperWeapon",class{constructor(g,P,I,U=!1){this.name=g,this.rules=P,this.owner=I,this.oneTimeOnly=U,this.status=_.Charging,this.isGift=!1,this.rechargeTicks=60*P.rechargeTime*L.GameSpeed.BASE_TICKS_PER_SECOND,this.chargeTicks=this.rechargeTicks,U&&(this.status=_.Ready,this.chargeTicks=0)}update(g){0<this.chargeTicks&&this.status!==_.Paused&&(this.chargeTicks--,0===this.chargeTicks&&(this.status=_.Ready,g.events.dispatch(new I.SuperWeaponReadyEvent(this))))}pauseTimer(){this.status=_.Paused}resumeTimer(){this.status=0<this.chargeTicks?_.Charging:_.Ready}resetTimer(){this.chargeTicks=this.rechargeTicks,this.status===_.Ready&&(this.status=_.Charging)}getTimerSeconds(){return this.chargeTicks/L.GameSpeed.BASE_TICKS_PER_SECOND}getChargeProgress(){return(this.rechargeTicks-this.chargeTicks)/this.rechargeTicks}})}}}),System.register("game/superweapon/ChronoSphereEffect",["game/gameobject/common/DeathType","game/gameobject/infantry/StanceType","game/gameobject/unit/ZoneType","game/map/tileFinder/RadialTileFinder","game/type/MovementZone","game/type/SpeedType","game/superweapon/SuperWeaponEffect"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g}],execute:function(){z=class extends W.SuperWeaponEffect{constructor(g,P,I,L){super(g,P,I),this.tile2=L,this.objectsToTeleport=[]}onStart(g){this.delayTicks=g.rules.general.chronoDelay;let P=g.map.tiles;for(let V=-1;V<=1;V++)for(let W=-1;W<=1;W++){var I=P.getByMapCoords(this.tile.rx+V,this.tile.ry+W);if(I){var _,U=!!I.onBridgeLandType,G=P.getByMapCoords(this.tile2.rx+V,this.tile2.ry+W);for(_ of g.map.getGroundObjectsOnTile(I))!_.isUnit()||_.tile!==I||_.onBridge!==U||_.isInfantry()&&_.stance===L.StanceType.Paradrop&&2<_.tileElevation||_.isDisposed||_.invulnerableTrait.isActive()||(_.rules.organic&&!_.rules.teleporter||!G?g.destroyObject(_,{player:this.owner}):_.warpedOutTrait.isActive()||(_.warpedOutTrait.setActive(!0,!0,g),this.objectsToTeleport.push({obj:_,destTile:G})))}}}onTick(g){if(0<this.delayTicks&&this.delayTicks--,this.delayTicks)return!1;for(let{obj:K,destTile:q}of this.objectsToTeleport)if(K.isSpawned){let $=!1,Q=q?g.map.tileOccupation.getBridgeOnTile(q):void 0,Y=g.map.getGroundObjectsOnTile(q),Z=Y.find(g=>g.isBuilding());var P=Y.some(P=>g.rules.general.padAircraft.includes(P.name)),W=g.rules.general.padAircraft.includes(K.name)&&!!Z?.helipadTrait&&!!Z.dockTrait?.getAllDockTiles().includes(q)&&!Z.dockTrait.hasReservedDockAt(Z.dockTrait.getDockNumberByTile(q))&&Z.owner===K.owner;let X=!1,J=K.rules.speedType,ee=K.isInfantry();K.rules.movementZone===G.MovementZone.Fly&&(J=V.SpeedType.Wheel);var z=g.map.mapBounds.isWithinBounds(q);if(!(W||g.map.terrain.getPassableSpeed(q,J,ee,!!Q)&&z)){let L=!1;if(!P&&(0<g.map.terrain.getPassableSpeed(q,J,ee,!!Q,void 0,!0)||!z)){Z&&($=!0),(z=new U.RadialTileFinder(g.map.tiles,g.map.mapBounds,q,{width:1,height:1},1,15,P=>0<g.map.terrain.getPassableSpeed(P,J,ee,!!P.onBridgeLandType)&&!g.map.terrain.findObstacles({tile:P,onBridge:!!P.onBridgeLandType},K).length).getNextTile())&&(q=z,Q=g.map.tileOccupation.getBridgeOnTile(q),Y=g.map.getGroundObjectsOnTile(q),L=!0)}L||(K.moveTrait.teleportUnitToTile(q,Q,!0,!1,g),K.warpedOutTrait.setActive(!1,!0,g),g.map.getTileZone(q)===_.ZoneType.Water&&(K.deathType=I.DeathType.Sink),g.destroyObject(K,{player:this.owner}),X=!0)}for(let P of Y)P.isDisposed||P.isUnit()&&(this.objectsToTeleport.some(({obj:g})=>g===P)||P.onBridge!==!!Q&&P.tile===q||2<Math.abs(P.tileElevation-K.tileElevation)||(P.isInfantry()&&P.stance!==L.StanceType.Paradrop&&(P.deathType=I.DeathType.Crush),g.destroyObject(P,{player:this.owner,obj:K})));if(!X){if(K.moveTrait.teleportUnitToTile(q,Q,!0,!1,g),W&&Z?.dockTrait){if(W=Z.dockTrait.getAllDockTiles().indexOf(q),Z.dockTrait.undockUnitAt(W),Z.dockTrait.hasReservedDockAt(W))throw new Error("Target building dock is already reserved by another unit");Z.dockTrait.dockUnitAt(K,W)}$?K.warpedOutTrait.setTimed(g.rules.general.chronoDelay,!1,g):K.warpedOutTrait.setActive(!1,!0,g)}}return!0}},g("ChronoSphereEffect",z)}}}),System.register("game/superweapon/IronCurtainEffect",["game/map/tileFinder/RadialTileFinder","game/superweapon/SuperWeaponEffect"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.SuperWeaponEffect{onStart(g){var P,L,_=g.rules.combatDamage.ironCurtainDuration,U={player:this.owner};let G=new I.RadialTileFinder(g.map.tiles,g.map.mapBounds,this.tile,{width:1,height:1},0,1,()=>!0);for(;P=G.getNextTile();)for(L of g.map.getGroundObjectsOnTile(P))!L.isTechno()||L.isDestroyed||L.isUnit()&&L.tile!==P||L.rules.missileSpawn||(L.rules.organic?g.destroyObject(L,U):(L.invulnerableTrait.setActiveFor(_,g.currentTick),(L.isVehicle()||L.isAircraft())&&L.parasiteableTrait?.isInfested()&&L.parasiteableTrait.destroyParasite(U,g)))}onTick(g){return!0}},g("IronCurtainEffect",_)}}}),System.register("game/superweapon/LightningStormEffect",["game/Coords","game/event/LightningStormCloudEvent","game/event/LightningStormManifestEvent","game/gameobject/unit/CollisionType","game/gameobject/unit/RangeHelper","game/GameSpeed","game/map/tileFinder/RandomTileFinder","game/Warhead","game/superweapon/SuperWeaponEffect","game/SpecialWarheadType"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g}],execute:function(){var P;(P=$=$||{})[P.Approaching=0]="Approaching",P[P.Manifesting=1]="Manifesting",Q=class extends K.SuperWeaponEffect{constructor(){super(...arguments),this.state=$.Approaching,this.clouds=[]}onStart(g){var P=g.rules.general.lightningStorm;this.manifestStartTimer=P.deferment,this.manifestEndTimer=P.duration,this.nextDirectHitTimer=0,this.nextRandomHitTimer=0}onTick(g){if(this.state===$.Approaching&&(0<this.manifestStartTimer?this.manifestStartTimer--:(this.state=$.Manifesting,g.events.dispatch(new _.LightningStormManifestEvent(this.tile)))),this.state===$.Manifesting){var P,L=g.rules.general.lightningStorm;if(0<this.manifestEndTimer&&(this.manifestEndTimer--,0<this.nextDirectHitTimer&&this.nextDirectHitTimer--,this.nextDirectHitTimer<=0&&(this.nextDirectHitTimer=L.hitDelay,this.spawnCloudAt(this.tile,g)),0<this.nextRandomHitTimer&&this.nextRandomHitTimer--,this.nextRandomHitTimer<=0)){this.nextRandomHitTimer=L.scatterDelay;var V=Math.floor(L.cellSpread/2);let P=L.separation,I=new G.RangeHelper(g.map.tileOccupation),_=new W.RandomTileFinder(g.map.tiles,g.map.mapBounds,this.tile,V,g,g=>!this.clouds.some(L=>I.tileDistance(g,L.tile)<P),!1);(V=_.getNextTile())&&this.spawnCloudAt(V,g)}for(P of this.clouds.slice())if(0<P.ticksLeft){if(P.ticksLeft--,P.ticksLeft===Math.floor(P.durationTicks/2)){var K=L.warhead;let _=new z.Warhead(g.rules.getWarhead(K));var Q=P.tile,Y=g.map.tileOccupation.getBridgeOnTile(Q),Z=Y?.tileElevation??0;K=g.map.getTileZone(Q);_.detonate(g,L.damage,Q,Z,I.Coords.tile3dToWorld(Q.rx+.5,Q.ry+.5,Q.z+Z),K,Y?U.CollisionType.OnBridge:U.CollisionType.None,g.createTarget(Y,Q),{player:this.owner,weapon:void 0},q.SpecialWarheadType.LightningStrike)}}else this.clouds.splice(this.clouds.indexOf(P),1);if(!this.clouds.length&&this.manifestEndTimer<=0)return!0}return!1}spawnCloudAt(g,P){var _=P.rules.audioVisual.weatherConClouds;_=P.generateRandomInt(0,_.length-1);_=P.art.getAnimation(P.rules.audioVisual.weatherConClouds[_]).art.getNumber("Rate",60*V.GameSpeed.BASE_TICKS_PER_SECOND)/60,_=Math.floor(V.GameSpeed.BASE_TICKS_PER_SECOND/_*60),this.clouds.push({tile:g,durationTicks:_,ticksLeft:_}),_=(P.map.tileOccupation.getBridgeOnTile(g)?.tileElevation??0)+I.Coords.worldToTileHeight(P.rules.general.flightLevel),_=I.Coords.tile3dToWorld(g.rx+.5,g.ry+.5,g.z+_),P.events.dispatch(new L.LightningStormCloudEvent(_))}},g("LightningStormEffect",Q)}}}),System.register("game/superweapon/NukeEffect",["game/Coords","engine/type/ObjectType","game/math/Vector2","game/Weapon","game/WeaponType","game/superweapon/SuperWeaponEffect"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){W=class extends V.SuperWeaponEffect{constructor(g,P,I,L){super(g,P,I),this.weaponType=L}onStart(g){var P=g.rules.getWeapon(this.weaponType),I=g.createTarget(void 0,this.tile),_=this.owner.getOwnedObjectsByType(L.ObjectType.Building).find(g=>g.rules.nukeSilo);if(_){U.Weapon.factory(P.name,G.WeaponType.Primary,_,g.rules).fire(I,g)}else this.fireLooseNuke(P,I,g)}fireLooseNuke(g,P,L){var U=new _.Vector2(this.tile.rx+.5,this.tile.ry+.5).multiplyScalar(I.Coords.LEPTONS_PER_TILE);if(L.map.isWithinHardBounds(U)){let _=L.createLooseProjectile(g.name,this.owner,P);_.position.moveToLeptons(U),_.position.tileElevation=I.Coords.worldToTileHeight(_.rules.detonationAltitude),L.spawnObject(_,_.position.tile)}}onTick(g){return!0}},g("NukeEffect",W)}}}),System.register("game/superweapon/ParadropEffect",["game/Coords","engine/type/ObjectType","game/gameobject/Infantry","game/gameobject/infantry/StanceType","game/gameobject/task/move/MoveTask","game/gameobject/task/ParadropTask","game/gameobject/trait/UnlandableTrait","game/gameobject/unit/FacingUtil","game/gameobject/unit/RangeHelper","game/gameobject/unit/VeteranLevel","game/gameobject/unit/ZoneType","game/GameSpeed","game/map/tileFinder/RadialTileFinder","game/math/Vector2","util/bresenham","game/superweapon/SuperWeaponEffect"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g}],execute:function(){var P;(P=ee=ee||{})[P.Spawning=0]="Spawning",P[P.EnRoute=1]="EnRoute",P[P.Dropping=2]="Dropping",P[P.TurningAround=3]="TurningAround",te=5*Q.GameSpeed.BASE_TICKS_PER_SECOND,re=class extends J.SuperWeaponEffect{constructor(g,P,I,L,_){super(g,P,I),this.paradropSquad=L,this.state=ee.Spawning,this.failedAttempts=0,this.spawnDelay=_*te}onStart(g){this.passengerRules=g.rules.getObject(this.paradropSquad.inf,L.ObjectType.Infantry),this.passengerCount=this.paradropSquad.num}computeFlightPath(g,P,L){if(P.equals(g))throw new Error("Source and destination must be different");let _=g.clone().sub(P);var U=L.rules.general.paradrop.paradropRadius/I.Coords.LEPTONS_PER_TILE;U=P.clone().add(_.clone().setLength(_.length()+2*U)).floor();let G=X.bresenham(P.x,P.y,U.x,U.y).map(g=>L.map.tiles.getByMapCoords(g.x,g.y)??L.map.tiles.getPlaceholderTile(g.x,g.y));for(;G.length;){var V=G[0];V=I.Coords.tileToWorld(V.rx+.5,V.ry+.5);if(L.map.isWithinHardBounds(new Z.Vector2(V.x,V.y)))break;G.shift()}if(!G.length)throw new Error("No valid paradrop path found");return{fromTile:G[0],toTile:G[G.length-1]}}onTick(g){if(this.state===ee.Spawning){if(0<this.spawnDelay)return this.spawnDelay--,!1;var P=g.map.tiles.getMapSize(),_=[new Z.Vector2(0,0),new Z.Vector2(Math.floor(P.width/2),0),new Z.Vector2(0,Math.floor(P.height/2))][g.generateRandomInt(0,2)];let U=this.passengerRules.speedType,V=new Y.RadialTileFinder(g.map.tiles,g.map.mapBounds,this.tile,{width:1,height:1},0,50,P=>0<g.map.terrain.getPassableSpeed(P,U,!0,!!P.onBridgeLandType));if(!(X=this.targetTile=V.getNextTile()))return!0;let K=new Z.Vector2(X.rx,X.ry);var{fromTile:Q,toTile:P}=this.computeFlightPath(K,_,g),X=g.rules.general.paradrop.paradropPlane;_=g.rules.getObject(X,L.ObjectType.Aircraft);let q=this.pdPlane=g.createUnitForPlayer(_,this.owner);g.spawnObject(q,Q),q.direction=z.FacingUtil.fromMapCoords(K.clone().sub(new Z.Vector2(Q.rx,Q.ry))),q.position.tileElevation=I.Coords.worldToTileHeight(q.rules.flightLevel??g.rules.general.flightLevel),q.zone=$.ZoneType.Air,q.onBridge=!1,q.unitOrderTrait.addTask(new G.MoveTask(g,P,!1,{allowOutOfBoundsTarget:!0})),q.traits.get(W.UnlandableTrait).setEnabled(!1),this.state=ee.EnRoute}if(!this.pdPlane||this.pdPlane.isDestroyed||this.pdPlane.isCrashing)return!0;if(X=this.targetTile,!this.pdPlane.unitOrderTrait.hasTasks())return this.state=ee.TurningAround,this.pdPlane.unitOrderTrait.addTask(new G.MoveTask(g,X,!1,{allowOutOfBoundsTarget:!0})),!1;if(_=g.rules.general.paradrop.paradropRadius/I.Coords.LEPTONS_PER_TILE,Q=new K.RangeHelper(g.map.tileOccupation).isInTileRange(this.pdPlane.tile,X,0,_),this.state===ee.EnRoute&&Q&&(this.state=ee.Dropping),this.state===ee.Dropping)if(Q&&0<this.passengerCount){let I=!!(P=this.pdPlane.tile).onBridgeLandType;if(5<this.failedAttempts&&g.map.mapBounds.isWithinBounds(P))return this.passengerCount=0,!1;if(!g.map.terrain.getPassableSpeed(P,this.passengerRules.speedType,!0,I))return!1;if(g.map.getGroundObjectsOnTile(P).some(g=>g.isVehicle()&&g.onBridge===I||g.isBuilding()&&!g.isDestroyed||g.isInfantry()&&g.stance===U.StanceType.Paradrop))return!1;if(!(_=this.findFreeSubCell(g,P)))return!1;this.passengerCount--;let L=g.createUnitForPlayer(this.passengerRules,this.owner);L.stance=U.StanceType.Paradrop,L.position.tileElevation=this.pdPlane.tileElevation,L.position.subCell=_,L.onBridge=I,L.rules.trainable&&this.owner.canProduceVeteran(L.rules)&&L.veteranTrait?.setVeteranLevel(q.VeteranLevel.Veteran),g.spawnObject(L,P),L.unitOrderTrait.addTask(new V.ParadropTask(g).setCancellable(!1))}else{if(!(0<this.passengerCount))return this.pdPlane.unitOrderTrait.getCurrentTask().forceCancel(this.pdPlane),this.pdPlane.traits.get(W.UnlandableTrait).setEnabled(!0),!0;this.failedAttempts++,this.state=ee.TurningAround,this.pdPlane.unitOrderTrait.getCurrentTask().updateTarget(X,!!X.onBridgeLandType)}return this.state===ee.TurningAround&&Q&&(X=this.computeFlightPath(new Z.Vector2(X.rx,X.ry),new Z.Vector2(this.pdPlane.tile.rx,this.pdPlane.tile.ry),g).toTile,this.pdPlane.unitOrderTrait.getCurrentTask().updateTarget(X,!1),this.state=ee.EnRoute),!1}findFreeSubCell(g,P){let I=g.map.getGroundObjectsOnTile(P).filter(g=>g.isTerrain()).map(P=>P.rules.getOccupiedSubCells(g.map.getTheaterType())).flat();var L=_.Infantry.SUB_CELLS.filter(g=>-1===I.indexOf(g));if(L.length)return 1<L.length?L[g.generateRandomInt(0,L.length-1)]:L[0]}},g("ParadropEffect",re)}}}),System.register("game/superweapon/SuperWeaponEffect",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("EffectStatus",I={}))[P.NotStarted=0]="NotStarted",P[P.Running=1]="Running",P[P.Finished=2]="Finished",g("SuperWeaponEffect",class{constructor(g,P,L){this.type=g,this.owner=P,this.tile=L,this.status=I.NotStarted}onStart(g){}onTick(g){return!0}})}}}),System.register("game/Target",["game/Coords","game/type/LandType"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("Target",class{constructor(g,P,I){this.tileOccupation=I,this.isOre=!1,g?g.isOverlay()&&g.isBridge()?(this.bridge=g,this.tile=P):g.isOverlay()&&g.isTiberium()?(this.isOre=!0,this.tile=g.tile):(this.obj=g,this.tile=g.isBuilding()?g.centerTile:g.tile):(P.landType===L.LandType.Tiberium&&(this.isOre=!0),this.tile=P)}equals(g){return this.obj===g.obj&&this.tile===g.tile&&this.bridge===g.bridge&&this.isOre===g.isOre}getWorldCoords(){return this.obj?this.obj.position.worldPosition:I.Coords.tile3dToWorld(this.tile.rx+.5,this.tile.ry+.5,this.tile.z+(this.bridge?.tileElevation??0))}isBridge(){return!this.obj&&!!this.bridge}getBridge(){return this.bridge||(this.obj?.isUnit()&&this.obj.onBridge?this.tileOccupation.getBridgeOnTile(this.obj.tile):void 0)}})}}}),System.register("game/theater/AutoLat",["game/map/TileCollection"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("AutoLat",class{static calculate(g,P){let L=new Map;g.forEach(g=>{var I=P.getSetNum(g.tileNum);L.set(g,I),P.isCLAT(I)&&(I=P.getLAT(I),L.set(g,I),g.tileNum=P.getTileNumFromSet(I))}),g.forEach(_=>{var U=L.get(_);if(P.isLAT(U)){let K=0;var G=g.getNeighbourTile(_,I.TileDirection.TopRight),V=g.getNeighbourTile(_,I.TileDirection.BottomRight),W=g.getNeighbourTile(_,I.TileDirection.BottomLeft),z=g.getNeighbourTile(_,I.TileDirection.TopLeft);G&&P.canConnectTiles(U,L.get(G))&&(K+=1),V&&P.canConnectTiles(U,L.get(V))&&(K+=2),W&&P.canConnectTiles(U,L.get(W))&&(K+=4),z&&P.canConnectTiles(U,L.get(z))&&(K+=8),0<K&&(z=P.getCLATSet(U),_.tileNum=P.getTileNumFromSet(z,K))}else if(U===P.getGeneralValue("RampBase")&&!(_.rampType<1||4<_.terrainType)){let L=-1;var K=g.getNeighbourTile(_,I.TileDirection.TopRight),q=g.getNeighbourTile(_,I.TileDirection.BottomRight),$=g.getNeighbourTile(_,I.TileDirection.BottomLeft),Q=g.getNeighbourTile(_,I.TileDirection.TopLeft);switch(_.rampType){case 1:Q&&0===Q.rampType&&L++,q&&0===q.rampType&&(L+=2);break;case 2:K&&0===K.rampType&&L++,$&&0===$.rampType&&(L+=2);break;case 3:q&&0===q.rampType&&L++,Q&&0===Q.rampType&&(L+=2);break;case 4:$&&0===$.rampType&&L++,K&&0===K.rampType&&(L+=2)}-1!==L&&(_.tileNum=P.getTileNumFromSet(P.getGeneralValue("RampSmooth"),3*(_.rampType-1)+L))}})}})}}}),System.register("game/theater/rampHeights",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("rampHeights",[[0,0,0,0],[0,0,1,1],[1,0,0,1],[1,1,0,0],[0,1,1,0],[0,0,0,1],[1,0,0,0],[0,1,0,0],[0,0,1,0],[1,0,1,1],[1,1,0,1],[1,1,1,0],[0,1,1,1],[1,0,1,2],[2,1,0,1],[1,2,1,0],[0,1,2,1],[1,0,1,0],[0,1,0,1],[1,0,1,0],[0,1,0,1]])}}}),System.register("game/theater/TileSet",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("TileSet",class{constructor(g,P,I){this.fileName=g,this.setName=P,this.tilesInSet=I,this.entries=[]}})}}}),System.register("game/theater/TileSetAnim",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("TileSetAnim",class{constructor(g,P,I,L){this.name=g,this.subTile=P,this.offsetX=I,this.offsetY=L}})}}}),System.register("game/theater/TileSetEntry",["game/Coords"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("TileSetEntry",class{constructor(g,P){this.owner=g,this.index=P,this.files=[]}addFile(g){this.files.push(g)}setAnimation(g){this.animation=g}getAnimation(){return this.animation}getTmpFile(g,P,I=!1){if(this.files.length){var L=this.files[P(0,this.files.length-1)];return L.images[Math.min(g,L.images.length-1)].hasDamagedData?this.files[Math.min(I?1:0,this.files.length-1)]:L}}getRelativeTilePositions(){return this.files[0].images.map(({x:g,y:P,height:L},_)=>({subTile:_,rx:(g+2*P)/2/I.Coords.ISO_TILE_SIZE,ry:(2*P-g)/2/I.Coords.ISO_TILE_SIZE,z:L}))}})}}}),System.register("game/theater/TileSets",["util/string","game/theater/TileSetEntry","game/theater/TileSet","game/theater/TileSetAnim"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){var P;(P=G||g("HighBridgeHeadType",G={}))[P.TopLeft=0]="TopLeft",P[P.BottomRight=1]="BottomRight",P[P.TopRight=2]="TopRight",P[P.BottomLeft=3]="BottomLeft",P[P.MiddleTlBr=4]="MiddleTlBr",P[P.MiddleTrBl=5]="MiddleTrBl",V=new Map([[G.TopLeft,["BridgeTopLeft1","BridgeTopLeft2"]],[G.BottomRight,["BridgeBottomRight1","BridgeBottomRight2"]],[G.TopRight,["BridgeTopRight1","BridgeTopRight2"]],[G.BottomLeft,["BridgeBottomLeft1","BridgeBottomLeft2"]],[G.MiddleTlBr,["BridgeMiddle1"]],[G.MiddleTrBl,["BridgeMiddle2"]]]),g("TileSets",class{constructor(g){this.theaterIni=g,this.tileSets=[],this.orderedEntries=[],this.highBridgeSetNums=[this.getGeneralValue("BridgeSet"),this.getGeneralValue("WoodBridgeSet")],this.cliffSetNums=[this.getGeneralValue("CliffSet"),this.getGeneralValue("WaterCliffs"),this.getGeneralValue("DestroyableCliffs")]}getTile(g){return this.orderedEntries[g]}getTileImage(g,P,I){let L=this.getTile(g);if(!L)throw new Error(`TileNum ${g} not found`);var _=L.getTmpFile(P,I);if(!_||P>=_.images.length)throw new Error(`SubTile ${P} not found`);return _.images[P]}getSetNum(g){var P=this.orderedEntries[g];if(!P)throw new Error("Invalid tileNum "+g);return this.tileSets.indexOf(P.owner)}getTileNumFromSet(g,P=0){let I=0;return this.tileSets.some((L,_)=>_===g?(I+=P,!0):(I+=L.entries.length,!1)),I}getGeneralValue(g){let P=this.theaterIni.getSection("General");if(!P)throw new Error("Missing [General] section in theather ini");return P.getNumber(g)}loadTileData(g,P){this.tileSets.length=0,this.orderedEntries.length=0,this.initTileSets(g,P),this.initAnimations()}readMaxTileNum(){let g=0,P=0;for(;;){var L="TileSet"+I.pad(g,"0000");let _=this.theaterIni.getSection(L);if(!_)break;g++,P+=_.getNumber("TilesInSet")}return P}initTileSets(g,P){let U,G=0;for(var V;V="TileSet"+I.pad(G,"0000"),U=this.theaterIni.getSection(V),U;){G++;let V=new _.TileSet(U.getString("FileName"),U.getString("SetName"),U.getNumber("TilesInSet"));this.tileSets.push(V);for(let _=1;_<=V.tilesInSet;_++){let U=new L.TileSetEntry(V,_-1);var W="a".charCodeAt(0);for(let L=W-1;L<="z".charCodeAt(0);L++)if(!(L>=W&&"Bridges"===V.setName)){let G=V.fileName+I.pad(_,"00");L>=W&&(G+=String.fromCharCode(L)),G+=P;var z=g.get(G);if(!z)break;U.addFile(z)}V.entries.push(U),this.orderedEntries.push(U)}}}initAnimations(){var g=this.theaterIni.getOrderedSections();for(let G=this.tileSets.length;G<g.length;++G){let V=g[G],W=this.tileSets.find(g=>g.setName===V.name);if(W)for(let g=1;g<=W.tilesInSet;++g){var P="Tile"+I.pad(g,"00"),L=P+"Anim",_=V.getString(L);_?(P=new U.TileSetAnim(_,V.getNumber(P+"AttachesTo"),V.getNumber(P+"XOffset"),V.getNumber(P+"YOffset")),W.entries[g-1].setAnimation(P)):console.warn(`Missing anim "${L}" for tileset `+W.setName)}}}isLAT(g){return g===this.getGeneralValue("RoughTile")||g===this.getGeneralValue("SandTile")||g===this.getGeneralValue("GreenTile")||g===this.getGeneralValue("PaveTile")}isCLAT(g){return g===this.getGeneralValue("ClearToRoughLat")||g===this.getGeneralValue("ClearToSandLat")||g===this.getGeneralValue("ClearToGreenLat")||g===this.getGeneralValue("ClearToPaveLat")}getLAT(g){return g===this.getGeneralValue("ClearToRoughLat")?this.getGeneralValue("RoughTile"):g===this.getGeneralValue("ClearToSandLat")?this.getGeneralValue("SandTile"):g===this.getGeneralValue("ClearToGreenLat")?this.getGeneralValue("GreenTile"):g===this.getGeneralValue("ClearToPaveLat")?this.getGeneralValue("PaveTile"):-1}getCLATSet(g){return g===this.getGeneralValue("RoughTile")?this.getGeneralValue("ClearToRoughLat"):g===this.getGeneralValue("SandTile")?this.getGeneralValue("ClearToSandLat"):g===this.getGeneralValue("GreenTile")?this.getGeneralValue("ClearToGreenLat"):g===this.getGeneralValue("PaveTile")?this.getGeneralValue("ClearToPaveLat"):-1}canConnectTiles(g,P){if(g===P)return!1;var I=this.getGeneralValue("GreenTile"),L=this.getGeneralValue("PaveTile"),_=this.getGeneralValue("MiscPaveTile"),U=this.getGeneralValue("ShorePieces"),G=this.getGeneralValue("WaterBridge"),V=this.getGeneralValue("PavedRoads"),W=this.getGeneralValue("Medians");return!(g===I&&P===U||P===I&&g===U||g===I&&P===G||P===I&&g===G||g===L&&P===V||P===L&&g===V||g===L&&P===_||P===L&&g===_||g===L&&P===W||P===L&&g===W)}getHighBridgeHeadType(g){for(var[P,I]of V)for(var L of I)if(this.getGeneralValue(L)===g+1)return P}getOppositeHighBridgeHeadType(g){switch(g){case G.TopLeft:return G.BottomRight;case G.TopRight:return G.BottomLeft;case G.BottomLeft:return G.TopRight;case G.BottomRight:return G.TopLeft;case G.MiddleTlBr:case G.MiddleTrBl:throw new Error("Middle bridge heads can't have opposites");default:throw new Error("Unhandled headType "+g)}}isCliffTile(g){return this.cliffSetNums.includes(this.getSetNum(g))}isHighBridgeBoundaryTile(g){if(this.highBridgeSetNums.includes(this.getSetNum(g))){var P=this.getTile(g);return void 0!==(P=this.getHighBridgeHeadType(P.index))&&![G.MiddleTlBr,G.MiddleTrBl].includes(P)}return!1}isHighBridgeMiddleTile(g){if(this.highBridgeSetNums.includes(this.getSetNum(g))){var P=this.getTile(g);return void 0!==(P=this.getHighBridgeHeadType(P.index))&&[G.MiddleTlBr,G.MiddleTrBl].includes(P)}return!1}})}}}),System.register("game/trait/CrateGeneratorTrait",["engine/type/ObjectType","engine/type/TerrainType","game/event/CratePickupEvent","game/gameobject/unit/RangeHelper","game/gameobject/unit/ZoneType","game/gameopts/constants","game/GameSpeed","game/map/tileFinder/RadialTileFinder","game/type/PowerupType","game/type/SpeedType","game/trait/interface/NotifyTick","game/type/SuperWeaponType","game/trait/SuperWeaponsTrait","game/gameobject/trait/CloakableTrait","game/Warhead","game/gameobject/unit/CollisionType","game/map/tileFinder/RandomTileFinder","game/map/OreSpread","engine/type/TiberiumType","game/gameobject/trait/TiberiumTrait","game/math/Vector2","game/math/Box2","game/SpecialWarheadType"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g}],execute:function(){g("UNSUPPORTED_POWERUP_TYPES",[K.PowerupType.IonStorm,K.PowerupType.Gas,K.PowerupType.Pod,K.PowerupType.Squad]),le=class{constructor(g){this.randomCrateSpawn=g,this.crates=[],this.availEdgeTiles=[],this.allTiles=[]}init(g){var P=g.map.tiles.getMapSize();let I=g.map.tiles,L=[],_=0;for(let V=0;V<P.width;++V){let z,K,q=!1,$=!1;for(let L=0;L<P.height;++L){var U=I.getByMapCoords(V,L);if(U&&this.canPlaceCrateOnTile(g,U)){var W=g.map.getTileZone(U)===G.ZoneType.Water;z?(W||(K=U),$=W):W?q=$=!0:z=K=U}else if(z&&!U)break}z&&(L.push(z),K&&K!==z&&L.push(K),q||$||_++)}this.availEdgeTiles=L,this.allTiles=I.getAll(),this.mapEdgeIsWater=0===_,this.minCrates=g.rules.crateRules.crateMinimum*g.gameOpts.humanPlayers.filter(g=>g.countryId!==V.OBS_COUNTRY_ID).length}[$.NotifyTick.onTick](g){for(var P of this.crates)P.ticksLeft--,P.ticksLeft<=0&&(g.unspawnObject(P.obj),P.obj.dispose());if(this.crates=this.crates.filter(g=>0<g.ticksLeft),this.randomCrateSpawn)for(let P=0;P<this.minCrates-this.crates.length&&this.spawnCrateAtRandom(this.allTiles,g);P++);}spawnCrateAtRandom(g,P){var I=this.chooseSpawnTile(g,P);if(I)return this.spawnRandomCrateAt(I,P)}spawnRandomCrateAt(g,P){if(this.canPlaceCrateOnTile(P,g)){var I=P.map.getTileZone(g,!0)===G.ZoneType.Water;if(I=this.choosePowerup(I,P.rules.powerups.powerups,P))return this.spawnCrateAt(g,I,P)}}spawnCrateAt(g,P,L){if(this.canPlaceCrateOnTile(L,g)){var _=L.map.getTileZone(g,!0)===G.ZoneType.Water,U=L.rules.crateRules;_=_?U.waterCrateImg:U.crateImg;let V=L.createObject(I.ObjectType.Overlay,_);return V.overlayId=L.rules.getOverlayId(_),V.value=0,L.spawnObject(V,g),U=60*U.crateRegen*W.GameSpeed.BASE_TICKS_PER_SECOND*(.5+1.5*L.generateRandom()),this.crates.push({obj:V,powerup:P,ticksLeft:U}),V}}chooseSpawnTile(g,P){return P.generateRandom()<(this.mapEdgeIsWater?1/3:2/3)&&this.availEdgeTiles.length&&(g=this.availEdgeTiles),this.chooseRandomTile(g,P)}chooseRandomTile(g,P){let I,L=0;for(;I=g[P.generateRandomInt(0,g.length-1)],L++,L<100&&!this.canPlaceCrateOnTile(P,I););if(100<=L){var _=P.map.tileOccupation.getEmptyTiles();if(!_.length)return;I=_[P.generateRandomInt(0,_.length-1)]}return I}canPlaceCrateOnTile(g,P){return g.map.mapBounds.isWithinBounds(P)&&!g.map.getGroundObjectsOnTile(P).length&&0<g.map.terrain.getPassableSpeed(P,q.SpeedType.Amphibious,!1,!1)&&P.terrainType!==L.TerrainType.Shore&&0===P.rampType}choosePowerup(g,P,I){if((P=g?P.filter(g=>g.waterAllowed):P).length){var L,_=P.reduce((g,P)=>g+P.probShares,0),U=I.generateRandomInt(0,_);let g=0;for(L of P)if(g+=L.probShares,U<g)return L}}peekInsideCrate(g){return this.crates.find(P=>P.obj===g)?.powerup.type}pickupCrate(g,P,I){let L=this.crates.find(g=>g.obj===P);if(L){this.crates.splice(this.crates.indexOf(L),1),I.unspawnObject(L.obj),L.obj.dispose();let P=this.grantPowerup(g,L.powerup,L.obj.tile,I);var U;return void 0!==P&&(g.owner.cratesPickedUp++,U=I.rules.powerups.powerups.find(g=>g.type===P),I.events.dispatch(new _.CratePickupEvent(U,g.owner,g,L.obj.tile))),this.randomCrateSpawn&&this.spawnCrateAtRandom(this.allTiles,I),P}}grantPowerup(g,P,L,_){let U=g.owner,G=!1;if(U.isCombatant()){if(P.type===K.PowerupType.Unit){let g;if(![...U.buildings].some(g=>g.rules.constructionYard)&&_.rules.crateRules.freeMCV){let P=_.rules.general.baseUnit;if(!U.getOwnedObjects(!0).some(g=>P.includes(g.name))&&U.credits>=[..._.rules.ai.buildPower,..._.rules.ai.buildRefinery].map(g=>_.rules.getBuilding(g)).filter(g=>g.aiBasePlanningSide===U.country.side).reduce((g,P)=>g+P.cost,0)){var V=P.find(g=>{let P=_.rules.getObject(g,I.ObjectType.Vehicle);return P.isAvailableTo(U.country)&&P.hasOwner(U.country)});if(!V)throw new Error("No suitable MCV found for player country "+U.country?.name);g=_.rules.getObject(V,I.ObjectType.Vehicle)}}if(g||(W=(W=_.rules.crateRules.unitCrateType)?_.rules.hasObject(W,I.ObjectType.Vehicle)?[_.rules.getObject(W,I.ObjectType.Vehicle)]:[]:[..._.rules.vehicleRules.values()].filter(g=>g.crateGoodie&&0<_.map.terrain.getPassableSpeed(L,g.speedType,!1,!1))).length&&(g=W[_.generateRandomInt(0,W.length-1)]),g){let P=_.createUnitForPlayer(g,U);var W=new z.RadialTileFinder(_.map.tiles,_.map.mapBounds,L,{width:1,height:1},0,3,g=>0<_.map.terrain.getPassableSpeed(g,P.rules.speedType,P.isInfantry(),!1)&&!_.map.terrain.findObstacles({tile:g,onBridge:void 0},P).length).getNextTile();W?(_.spawnObject(P,W),G=!0):(U.removeOwnedObject(P),P.dispose())}}else if(P.type===K.PowerupType.Money){if(!P.data)throw new Error("Money powerup missing data field");var q=Math.floor(Number(P.data)*(.55+2*_.generateRandom()*.45));U.credits=Math.max(0,U.credits+q),0<q&&(U.creditsGained+=q),G=!0}else if(P.type===K.PowerupType.HealBase){var $;for($ of U.getOwnedObjects(!0))$.isDestroyed||$.healthTrait.healToFull(void 0,_);G=!0}else if(P.type===K.PowerupType.Reveal)_.mapShroudTrait.revealMap(U,_),G=!0;else if(P.type===K.PowerupType.Darkness)_.mapShroudTrait.resetShroud(U,_),G=!0;else if(P.type===K.PowerupType.Veteran){if(g.veteranTrait&&!g.veteranTrait.isMaxLevel()){G=!0;var ae,ne=Number(P.data);for(ae of this.getUnitsInCrateRadius(_,L,U))ae.veteranTrait?.promote(ne,_)}}else if(P.type===K.PowerupType.Armor){if(1===g.crateBonuses.armor){G=!0;var le,ce=Number(P.data);for(le of this.getUnitsInCrateRadius(_,L,U))1===le.crateBonuses.armor&&(le.crateBonuses.armor=ce)}}else if(P.type===K.PowerupType.Firepower){if(1===g.crateBonuses.firepower){G=!0;var he,ue=Number(P.data);for(he of this.getUnitsInCrateRadius(_,L,U))1===he.crateBonuses.firepower&&(he.crateBonuses.firepower=ue)}}else if(P.type===K.PowerupType.Speed){if(1===g.crateBonuses.speed){G=!0;var de,ge=Number(P.data);for(de of this.getUnitsInCrateRadius(_,L,U))1===de.crateBonuses.speed&&(de.crateBonuses.speed=ge)}}else if(P.type===K.PowerupType.Cloak){if(!g.cloakableTrait)for(var pe of(G=!0,this.getUnitsInCrateRadius(_,L,U)))pe.cloakableTrait||(pe.cloakableTrait=new Z.CloakableTrait(pe,_.rules.general.cloakDelay),_.addObjectTrait(pe,pe.cloakableTrait))}else if(P.type===K.PowerupType.ICBM){if(q=[..._.rules.superWeaponRules.values()].find(g=>g.type===Q.SuperWeaponType.MultiMissile),q&&U.superWeaponsTrait&&!U.superWeaponsTrait.has(q.name)){let g=_.createSuperWeapon(q.name,U,!0);g.isGift=!0,U.superWeaponsTrait.add(g),G=!0}}else if(P.type===K.PowerupType.Invulnerability){var me=[..._.rules.superWeaponRules.values()].find(g=>g.type===Q.SuperWeaponType.IronCurtain);me&&(_.traits.get(Y.SuperWeaponsTrait).activateEffect(me,U,_,L,void 0,!0),G=!0)}else if(P.type===K.PowerupType.Explosion||P.type===K.PowerupType.Napalm){G=!0;var fe=Number(P.data);me=P.type===K.PowerupType.Napalm?_.rules.combatDamage.flameDamage:_.rules.combatDamage.c4Warhead;new X.Warhead(_.rules.getWarhead(me)).detonate(_,fe,g.tile,g.tileElevation,g.position.worldPosition,g.zone,J.CollisionType.None,_.createTarget(g,g.tile),{player:g.owner,weapon:void 0},oe.SpecialWarheadType.None,void 0,0)}else{if(P.type!==K.PowerupType.Tiberium)return void console.warn(`Unhandled powerup type "${K.PowerupType[P.type]}"`);{let g,P=new ee.RandomTileFinder(_.map.tiles,_.map.mapBounds,L,2,_,g=>se.TiberiumTrait.canBePlacedOn(g,_.map)),U=0;for(;U++<6&&(g=P.getNextTile());){var ye=te.OreSpread.calculateOverlayId(re.TiberiumType.Ore,g);if(void 0===ye)throw new Error("Expected an overlayId");let P=_.createObject(I.ObjectType.Overlay,_.rules.getOverlayName(ye));P.overlayId=ye,P.value=3,_.spawnObject(P,g),G=!0}}}return G?P.type:(fe=_.rules.powerups.powerups.find(g=>g.type===K.PowerupType.Money&&0<g.probShares),fe?this.grantPowerup(g,fe,L,_):void 0)}}getUnitsInCrateRadius(g,P,I){let L=g.rules.crateRules.crateRadius,_=new U.RangeHelper(g.map.tileOccupation);return g.map.technosByTile.queryRange((new ne.Box2).setFromCenterAndSize(new ae.Vector2(P.rx,P.ry),new ae.Vector2(L,L))).filter(g=>g.owner===I&&g.isUnit()&&_.tileDistance(g,P)<=L)}},g("CrateGeneratorTrait",le)}}}),System.register("game/trait/interface/NotifyAllianceChange",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifyAllianceChange",I={})).onChange=Symbol()}}}),System.register("game/trait/interface/NotifyAttack",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifyAttack",I={})).onAttack=Symbol()}}}),System.register("game/trait/interface/NotifyDestroy",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifyDestroy",I={})).onDestroy=Symbol()}}}),System.register("game/trait/interface/NotifyElevationChange",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifyElevationChange",I={})).onElevationChange=Symbol()}}}),System.register("game/trait/interface/NotifyHealthChange",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifyHealthChange",I={})).onChange=Symbol()}}}),System.register("game/trait/interface/NotifyObjectTraitAdd",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifyObjectTraitAdd",I={})).onAdd=Symbol()}}}),System.register("game/trait/interface/NotifyOwnerChange",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifyOwnerChange",I={})).onChange=Symbol()}}}),System.register("game/trait/interface/NotifyPlaceBuilding",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifyPlaceBuilding",I={})).onPlace=Symbol()}}}),System.register("game/trait/interface/NotifyPower",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("NotifyPower",I={})).onPowerLow=Symbol(),P.onPowerRestore=Symbol(),P.onPowerChange=Symbol()}}}),System.register("game/trait/interface/NotifyProduceUnit",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifyProduceUnit",I={})).onProduce=Symbol()}}}),System.register("game/trait/interface/NotifySpawn",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifySpawn",I={})).onSpawn=Symbol()}}}),System.register("game/trait/interface/NotifySuperWeaponActivate",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifySuperWeaponActivate",I={})).onActivate=Symbol()}}}),System.register("game/trait/interface/NotifySuperWeaponDeactivate",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifySuperWeaponDeactivate",I={})).onDeactivate=Symbol()}}}),System.register("game/trait/interface/NotifyTargetDestroy",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifyTargetDestroy",I={})).onDestroy=Symbol()}}}),System.register("game/trait/interface/NotifyTick",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifyTick",I={})).onTick=Symbol()}}}),System.register("game/trait/interface/NotifyTileChange",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifyTileChange",I={})).onTileChange=Symbol()}}}),System.register("game/trait/interface/NotifyUnspawn",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifyUnspawn",I={})).onUnspawn=Symbol()}}}),System.register("game/trait/interface/NotifyWarpChange",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){(I||g("NotifyWarpChange",I={})).onChange=Symbol()}}}),System.register("game/trait/MapLightingTrait",["data/map/MapLighting","game/GameSpeed","util/event","game/trait/interface/NotifyTick"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=class{get onChange(){return this._onChange.asEvent()}constructor(g,P){this.mapLighting=new I.MapLighting,this._onChange=new _.EventDispatcher,this.ambientChangeRate=g.ambientChangeRate,this.ambientChangeStep=g.ambientChangeStep,P&&this.mapLighting.copy(P)}setAmbientChangeRate(g){this.ambientChangeRate=g}setAmbientChangeStep(g){this.ambientChangeStep=g}setTargetAmbientIntensity(g){this.targetAmbient=g}getAmbient(){return this.mapLighting}[U.NotifyTick.onTick](){var g;void 0!==this.targetAmbient&&(this.ambientUpdateTicks??(this.ambientUpdateTicks=Math.floor(60*L.GameSpeed.BASE_TICKS_PER_SECOND*this.ambientChangeRate)),this.ambientUpdateTicks<=0?(this.ambientUpdateTicks=void 0,g=this.mapLighting.ambient,(g=this.targetAmbient-g)?(g=Math.sign(g)*Math.min(this.ambientChangeStep,Math.abs(g)),this.mapLighting.ambient+=g,this._onChange.dispatch(this,this.mapLighting)):this.targetAmbient=void 0):this.ambientUpdateTicks--)}},g("MapLightingTrait",G)}}}),System.register("game/trait/MapRadiationTrait",["game/gameobject/infantry/StanceType","game/gameobject/unit/RangeHelper","game/map/tileFinder/RadialTileFinder","game/Warhead","util/event","util/math","game/trait/interface/NotifyTick"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g}],execute:function(){z=class{get onChange(){return this._onChange.asEvent()}constructor(g){this.map=g,this.radSites=new Map,this.radLevelByTile=new Map,this._onChange=new G.EventDispatcher}getRadLevel(g){return this.radLevelByTile.get(g)}[W.NotifyTick.onTick](g){var P;this.radLevelByTile.size&&(P=g.rules.radiation,void 0===this.nextDamage?this.nextDamage=Math.max(0,P.radApplicationDelay-1):this.nextDamage<=0?(this.applyDamage(g),this.nextDamage=Math.max(0,P.radApplicationDelay)):this.nextDamage--,void 0===this.nextDecay?this.nextDecay=Math.max(0,P.radLevelDelay-1):this.nextDecay<=0?(this.applyDecay(Math.ceil(P.radLevelDelay/P.radDurationMultiple)),this.radLevelByTile.size?this.nextDecay=Math.max(0,P.radLevelDelay):this.nextDecay=void 0):this.nextDecay--)}applyDamage(g){let P=g.rules.radiation,L=new U.Warhead(g.rules.getWarhead(P.radSiteWarhead));this.radLevelByTile.forEach((_,U)=>{var G,V,W=Math.min(P.radLevelMax,_)*P.radLevelFactor;for(G of g.map.getGroundObjectsOnTile(U).filter(g=>g.isUnit()&&!(g.isInfantry()&&g.stance===I.StanceType.Paradrop&&1<g.tileElevation)))L.canDamage(G,U,G.zone)&&0<(V=L.computeDamage(W,G,g))&&L.inflictDamage(V,G,void 0,g,!0)})}applyDecay(g){var P=new Set(this.radLevelByTile.keys());this.radLevelByTile.clear(),this.radSites.forEach(({radLevel:P,radius:I},L)=>{var _=P-g;_<=0?this.radSites.delete(L):(this.radSites.set(L,{radLevel:_,radius:I}),this.setRadLevelAround(L,I,_))}),this._onChange.dispatch(this,P)}createRadSite(g,P,I){var L;(P-=this.radSites.get(g)?.radLevel??0)<=0||(this.radSites.set(g,{radLevel:(this.radSites.get(g)?.radLevel??0)+P,radius:I}),(L=this.setRadLevelAround(g,I,P)).size&&this._onChange.dispatch(this,L))}setRadLevelAround(g,P,I){let U=new L.RangeHelper(this.map.tileOccupation),G=new _.RadialTileFinder(this.map.tiles,this.map.mapBounds,g,{width:1,height:1},0,P,g=>!!g,!1);var W;let z=new Set;for(;W=G.getNextTile();){var K=U.tileDistance(g,W);K<=P&&(K=Math.ceil(V.lerp(I,0*I,K/P)),this.radLevelByTile.set(W,Math.min(1e3,(this.radLevelByTile.get(W)??0)+K)),z.add(W))}return z}getRadSiteLevel(g){return this.radSites.get(g)?.radLevel}},g("MapRadiationTrait",z)}}}),System.register("game/trait/MapShroudTrait",["game/map/MapShroud","game/trait/interface/NotifyTick","game/trait/interface/NotifyOwnerChange","game/trait/interface/NotifyAllianceChange","util/typeGuard","game/trait/interface/NotifySpawn","game/trait/interface/NotifyUnspawn","game/trait/RadarTrait","game/rules/general/RadarRules","engine/type/ObjectType","game/trait/interface/NotifyPower","game/trait/interface/NotifyElevationChange"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g}],execute:function(){Y=class{constructor(g,P){this.map=g,this.alliances=P,this.shroudByPlayer=new Map,this.revealedToAll=new Set,this.gapGenerators=new Set,this.handleTileOccupationUpdate=({object:g,type:P})=>{if("removed"!==P&&g.isTechno()){var I,L=g.owner;for(I of[L,...this.alliances.getAllies(L)])this.shroudByPlayer.get(I)?.revealFrom(g)}}}getPlayerShroud(g){return this.shroudByPlayer.get(g)}init(g){g.map.tileOccupation.onChange.subscribe(this.handleTileOccupationUpdate);let P=(new I.MapShroud).fromTiles(this.map.tiles);for(var L of g.getCombatants()){let I=P.clone();this.shroudByPlayer.set(L,I),this.revealObjects(I,L,g),I.update()}}[Q.NotifyElevationChange.onElevationChange](g,P,I){if(Math.floor(g.tileElevation)!==Math.floor(I)){var L,_=g.owner;for(L of[_,...this.alliances.getAllies(_)])this.shroudByPlayer.get(L)?.revealFrom(g)}}[L.NotifyTick.onTick](g){for(var[P,I]of this.shroudByPlayer)P.defeated&&!P.isObserver?this.shroudByPlayer.delete(P):I.update()}[_.NotifyOwnerChange.onChange](g,P,I){if(g.isBuilding()&&g.rules.spySat&&(this.revealMap(g.owner,I),P.getOwnedObjectsByType(q.ObjectType.Building).find(g=>g.rules.spySat)||this.resetShroud(P,I)),g.isSpawned)for(var L of[g.owner,...I.alliances.getAllies(g.owner)])this.shroudByPlayer.get(L)?.revealFrom(g)}[U.NotifyAllianceChange.onChange](g,P,I){if(P){let P=this.getPlayerShroud(g.players.first);var L,_,U=I.alliances.getAllies(g.players.first).map(g=>this.getPlayerShroud(g)).filter(G.isNotNullOrUndefined);for(L of U)P.merge(L);for(_ of(P.invalidateFull(),U))_.copy(P),_.invalidateFull()}}[V.NotifySpawn.onSpawn](g,P){if(g.isBuilding()){if(g.rules.spySat&&this.revealMap(g.owner,P),g.rules.revealToAll)for(var I of(this.revealedToAll.add(g),P.getCombatants()))I===g.owner||P.alliances.areAllied(g.owner,I)||(this.shroudByPlayer.get(I)?.revealObject(g),P.traits.get(z.RadarTrait).addEventForPlayer(K.RadarEventType.EnemyObjectSensed,I,g.centerTile,P));g.gapGeneratorTrait&&this.gapGenerators.add(g)}}[W.NotifyUnspawn.onUnspawn](g,P){g.isBuilding()&&(g.rules.spySat&&(g.owner.getOwnedObjectsByType(q.ObjectType.Building).find(g=>g.rules.spySat)||this.resetShroud(g.owner,P)),g.rules.revealToAll&&this.revealedToAll.delete(g),g.gapGeneratorTrait&&this.gapGenerators.delete(g))}[$.NotifyPower.onPowerLow](g,P){this.updateGaps(P,g)}[$.NotifyPower.onPowerRestore](g,P){this.updateGaps(P,g)}[$.NotifyPower.onPowerChange](g,P){}revealMap(g,P){this.shroudByPlayer.get(g)?.revealAll(),this.markOwnGapTiles(P,g),this.updateGaps(P)}resetShroud(g,P){let I=this.shroudByPlayer.get(g);I&&(I.reset(),this.markOwnGapTiles(P,g),this.revealObjects(I,g,P))}revealObjects(g,P,I){var L;for(L of[...P.getOwnedObjects(),...I.alliances.getAllies(P).map(g=>g.getOwnedObjects()).flat()])g.revealFrom(L);this.revealedToAll.forEach(P=>g.revealObject(P))}updateGaps(g,P){for(var I of this.gapGenerators)P&&I.owner!==P||I.gapGeneratorTrait.update(I,g)}markOwnGapTiles(g,P){for(var L of this.gapGenerators)L.owner!==P&&!g.alliances.areAllied(L.owner,P)||this.getPlayerShroud(P)?.toggleFlagsAround(L.tile,L.gapGeneratorTrait.radiusTiles,I.ShroudFlag.Darken,!0)}dispose(){this.map.tileOccupation.onChange.unsubscribe(this.handleTileOccupationUpdate)}},g("MapShroudTrait",Y)}}}),System.register("game/trait/PowerTrait",["game/trait/interface/NotifySpawn","game/trait/interface/NotifyHealthChange","game/trait/interface/NotifyUnspawn","game/trait/interface/NotifyOwnerChange","game/trait/interface/NotifyWarpChange","game/trait/interface/NotifyTick"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){W=class{[I.NotifySpawn.onSpawn](g,P){g.isTechno()&&g.rules.power&&!this.isCapturablePower(g,g.owner)&&g.owner.powerTrait?.updateFrom(g,"add",P)}[_.NotifyUnspawn.onUnspawn](g,P){g.isTechno()&&g.rules.power&&!g.warpedOutTrait.isActive()&&!this.isCapturablePower(g,g.owner)&&g.owner.powerTrait?.updateFrom(g,"remove",P)}[L.NotifyHealthChange.onChange](g,P){g.isTechno()&&g.rules.power&&!g.warpedOutTrait.isActive()&&!this.isCapturablePower(g,g.owner)&&g.owner.powerTrait?.updateFrom(g,"update",P)}[U.NotifyOwnerChange.onChange](g,P,I){g.rules.power&&!g.warpedOutTrait.isActive()&&(this.isCapturablePower(g,P)||P.powerTrait?.updateFrom(g,"remove",I),this.isCapturablePower(g,g.owner)||g.owner.powerTrait?.updateFrom(g,"add",I))}[G.NotifyWarpChange.onChange](g,P,I){g.rules.power&&!this.isCapturablePower(g,g.owner)&&g.owner.powerTrait?.updateFrom(g,I?"remove":"add",P)}[V.NotifyTick.onTick](g){for(var P of g.getCombatants())P.powerTrait.updateBlackout(g)}isCapturablePower(g,P){return 0<g.rules.power&&P.isNeutral&&g.rules.needsEngineer}},g("PowerTrait",W)}}}),System.register("game/trait/ProductionTrait",["game/trait/interface/NotifyTick","game/trait/interface/NotifyUnspawn","game/trait/interface/NotifyOwnerChange","game/player/production/ProductionQueue","game/event/InsufficientFundsEvent","game/rules/TechnoRules","game/trait/interface/NotifySpawn","game/trait/interface/NotifyPower","game/player/trait/PowerTrait","util/math","game/GameSpeed","engine/type/ObjectType","game/math/GameMath"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g}],execute:function(){Z=class{constructor(g,P){this.rules=g,this.speedCheat=P,this.availableObjectRules=new Set;var I=60*g.general.buildSpeed*$.GameSpeed.BASE_TICKS_PER_SECOND;this.baseBuildSpeed=1/(I/1e3),[...g.buildingRules.values(),...g.infantryRules.values(),...g.vehicleRules.values(),...g.aircraftRules.values()].forEach(g=>{g.owner.length&&this.availableObjectRules.add(g)})}[I.NotifyTick.onTick](g){for(var P of g.getCombatants())for(var I of P.production.getAllQueues())this.tickQueue(I,P,g)}[W.NotifySpawn.onSpawn](g,P){var I;g.isBuilding()&&g.owner.production?(I=g.rules.factory)&&(g.owner.production.getPrimaryFactory(I)||g.owner.production.setPrimaryFactory(g),g.owner.production.incrementFactoryCount(I),I===V.FactoryType.AircraftType&&this.updateAircraftQueueMaxSize(g.owner,P)):g.isAircraft()&&g.owner.production&&this.rules.general.padAircraft.includes(g.name)&&this.updateAircraftQueueMaxSize(g.owner,P)}[L.NotifyUnspawn.onUnspawn](g,P){var I;g.isBuilding()&&g.owner.production?(this.ensurePrerequisites(g.owner),(I=g.rules.factory)&&(g.owner.production.getPrimaryFactory(I)===g&&g.owner.production.crownPrimaryFactoryHeir(I),g.owner.production.decrementFactoryCount(I),I===V.FactoryType.AircraftType&&this.updateAircraftQueueMaxSize(g.owner,P))):g.isAircraft()&&g.owner.production&&this.rules.general.padAircraft.includes(g.name)&&this.updateAircraftQueueMaxSize(g.owner,P)}[_.NotifyOwnerChange.onChange](g,P,I){var L;g.isBuilding()?(this.ensurePrerequisites(P),(L=g.rules.factory)&&(P.production?.getPrimaryFactory(L)===g&&P.production.crownPrimaryFactoryHeir(L),g.owner.production&&!g.owner.production.getPrimaryFactory(L)&&g.owner.production.setPrimaryFactory(g),P.production?.decrementFactoryCount(L),g.owner.production?.incrementFactoryCount(L),L===V.FactoryType.AircraftType&&(this.updateAircraftQueueMaxSize(g.owner,I),this.updateAircraftQueueMaxSize(P,I)))):g.isAircraft()&&this.rules.general.padAircraft.includes(g.name)&&(this.updateAircraftQueueMaxSize(g.owner,I),this.updateAircraftQueueMaxSize(P,I))}[z.NotifyPower.onPowerLow](g){g.production&&(g.production.buildSpeedModifier=this.computeLowPowerBuildSpeedModifier(g.powerTrait.power,g.powerTrait.drain))}[z.NotifyPower.onPowerRestore](g){g.production&&(g.production.buildSpeedModifier=1)}[z.NotifyPower.onPowerChange](g){g.powerTrait?.level===K.PowerLevel.Low&&g.production&&(g.production.buildSpeedModifier=this.computeLowPowerBuildSpeedModifier(g.powerTrait.power,g.powerTrait.drain))}computeLowPowerBuildSpeedModifier(g,P){var I=1-Math.min(1,g/P),L=this.rules.general;I=.3*L.lowPowerPenaltyModifier*I/.15;return q.clamp(1-I,L.minLowPowerProductionSpeed,L.maxLowPowerProductionSpeed)}updateAircraftQueueMaxSize(g,P){g.production&&P.afterTick(()=>{var I=[...g.buildings].filter(g=>g.helipadTrait).reduce((g,P)=>g+P.dockTrait.numberOfDocks,0),L=g.getOwnedObjectsByType(Q.ObjectType.Aircraft,!0).filter(g=>P.rules.general.padAircraft.includes(g.name)).length;g.production.getQueueForFactory(V.FactoryType.AircraftType).maxSize=Math.max(0,I-L)})}tickQueue(g,P,I){if(g.status===U.QueueStatus.Active){let K=!1,$=g.getFirst();var L,_=P.production.getFactoryTypeForQueueType(g.type),V=P.production.getFactoryCount(_),W=P.production.buildSpeedModifier,z=1/Y.GameMath.pow(this.rules.general.multipleFactory,V-1);_=$.rules.wall?1/this.rules.general.wallBuildSpeedCoefficient:1,V=this.baseBuildSpeed*W*z*_,z=(W=$.creditsEach)&&!this.speedCheat.value?q.floorTo(W/V*$.rules.buildTimeMultiplier,54):54,z=Math.max(54,z),_=P.credits,V=$.creditsEach-$.creditsSpent;0<(V=Math.min(P.credits,W/z+$.creditsSpentLeftover,V))?(L=Math.floor(V),$.creditsSpentLeftover=V-L,L&&($.creditsSpent+=L,$.progress=$.creditsSpent/$.creditsEach,P.credits-=L,K=!0)):$.creditsEach||(L=$.progress*z,$.progress=Math.min(1,(1+L)/z),K=!0),K&&1===$.progress&&(g.status=U.QueueStatus.Ready),0<_&&!P.credits&&I.events.dispatch(new G.InsufficientFundsEvent(P)),K&&g.notifyUpdated()}}ensurePrerequisites(g){if(g.production)for(var P of g.production.getAllQueues()){var I;for(I of P.getAll().map(g=>({rules:g.rules,quantity:g.quantity,creditsSpent:g.creditsSpent})))g.production.isAvailableForProduction(I.rules)||(P.pop(I.rules,I.quantity),g.credits+=I.creditsSpent)}}getAvailableObjects(){return[...this.availableObjectRules]}},g("ProductionTrait",Z)}}}),System.register("game/trait/RadarTrait",["game/trait/interface/NotifySpawn","game/trait/interface/NotifyUnspawn","game/trait/interface/NotifyPower","game/player/trait/PowerTrait","game/event/RadarOnOffEvent","game/trait/interface/NotifyOwnerChange","game/gameobject/unit/RangeHelper","game/rules/general/RadarRules","game/event/RadarEvent","game/trait/interface/NotifyAttack","game/trait/interface/NotifyWarpChange","game/trait/interface/NotifySuperWeaponActivate","game/type/SuperWeaponType","game/trait/interface/NotifySuperWeaponDeactivate"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g}],execute:function(){X=class{constructor(){this.activeLightningStrikes=new Map}[I.NotifySpawn.onSpawn](g,P){g.isBuilding()&&g.rules.radar&&this.updateRadarForPlayer(g.owner,P)}[L.NotifyUnspawn.onUnspawn](g,P){g.isBuilding()&&g.rules.radar&&this.updateRadarForPlayer(g.owner,P)}[_.NotifyPower.onPowerLow](g,P){this.updateRadarForPlayer(g,P)}[_.NotifyPower.onPowerRestore](g,P){this.updateRadarForPlayer(g,P)}[_.NotifyPower.onPowerChange](){}[V.NotifyOwnerChange.onChange](g,P,I){g.rules.radar&&(this.updateRadarForPlayer(P,I),this.updateRadarForPlayer(g.owner,I))}[$.NotifyWarpChange.onChange](g,P){g.rules.radar&&this.updateRadarForPlayer(g.owner,P)}[Q.NotifySuperWeaponActivate.onActivate](g,P,I){if(g===Y.SuperWeaponType.LightningStorm)for(var L of(this.activeLightningStrikes.set(P,(this.activeLightningStrikes.get(P)??0)+1),I.getCombatants()))L===P||I.alliances.areAllied(L,P)||this.updateRadarForPlayer(L,I)}[Z.NotifySuperWeaponDeactivate.onDeactivate](g,P,I){if(g===Y.SuperWeaponType.LightningStorm){var L=(this.activeLightningStrikes.get(P)??0)-1;if(0<L?this.activeLightningStrikes.set(P,L):this.activeLightningStrikes.delete(P),L<=0)for(var _ of I.getCombatants())this.updateRadarForPlayer(_,I)}}updateRadarForPlayer(g,P){var I,L;g.radarTrait&&(I=g.radarTrait?.isDisabled(),L=![...g.buildings].find(g=>g.rules.radar&&!g.warpedOutTrait.isActive())||g.powerTrait.level===U.PowerLevel.Low||[...this.activeLightningStrikes.entries()].some(([I,L])=>L&&I!==g&&!P.alliances.areAllied(I,g)),g.radarTrait.setDisabled(L),I!==L&&P.events.dispatch(new G.RadarOnOffEvent(g,!L)))}[q.NotifyAttack.onAttack](g,P,I){g.isTechno()&&(!g.isBuilding()||g.rules.canBeOccupied||g.rules.needsEngineer?g.isVehicle()&&g.harvesterTrait&&this.addEventForPlayer(z.RadarEventType.HarvesterUnderAttack,g.owner,g.tile,I):this.addEventForPlayer(z.RadarEventType.BaseUnderAttack,g.owner,g.tile,I))}addEventForPlayer(g,P,I,L){let _=P.radarTrait;if(_){let U=L.rules.general.radar;_.activeEvents=_.activeEvents.filter(g=>L.currentTick-g.startTick<U.getEventDuration(g.type));let G=new W.RangeHelper(L.map.tileOccupation);_.activeEvents.find(P=>P.type===g&&G.isInTileRange(I,P.tile,0,U.getEventSuppresionDistance(P.type)))||(_.activeEvents.push({startTick:L.currentTick,tile:I,type:g}),L.events.dispatch(new K.RadarEvent(P,g,I)))}}},g("RadarTrait",X)}}}),System.register("game/trait/SellTrait",["game/event/ObjectSellEvent","game/gameobject/trait/interface/NotifySell"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("SellTrait",class{constructor(g,P){this.game=g,this.generalRules=P}sell(g){if(!g.isBuilding()||!g.rules.unsellable){let P=this.computeRefundValue(g);P&&(g.rules.wall&&(P=0),g.traits.filter(L.NotifySell).forEach(P=>{P[L.NotifySell.onSell](g,this.game)}),g.isBuilding()?this.game.getConstructionWorker(g.owner).unplace(g,()=>this.afterObjectUnspawned(g,P)):(this.game.unspawnObject(g),this.afterObjectUnspawned(g,P)))}}afterObjectUnspawned(g,P){g.owner.credits+=P,this.game.events.dispatch(new I.ObjectSellEvent(g)),g.dispose()}computeRefundValue(g){let P=0;return 0<g.rules.soylent?P=g.rules.soylent:g.rules.cost&&(P=g.purchaseValue,g.owner.isAi||(P=Math.floor(P*this.generalRules.refundPercent))),P}computePurchaseValue(g,P){return g.cost}dispose(){this.game=void 0}})}}}),System.register("game/trait/SharedDetectCloakTrait",["game/trait/interface/NotifyOwnerChange","game/trait/interface/NotifySpawn","game/trait/interface/NotifyTileChange","game/trait/interface/NotifyUnspawn","game/gameobject/unit/RangeHelper","game/trait/interface/NotifyPower","game/trait/interface/NotifyTick","game/trait/RadarTrait","game/rules/general/RadarRules","game/trait/interface/NotifyObjectTraitAdd","game/gameobject/trait/CloakableTrait","game/gameobject/trait/SensorsTrait","game/math/Vector2","game/math/Box2"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g}],execute:function(){X=class{constructor(){this.detectors=new Set}[L.NotifySpawn.onSpawn](g,P){this.isGlobalDetector(g)&&(this.detectors.add(g),this.updateAroundDetector(g,P)),this.isCloakable(g)&&this.detect(g,P)}[U.NotifyUnspawn.onUnspawn](g,P){g.isTechno()&&this.isGlobalDetector(g)&&this.detectors.delete(g)}[I.NotifyOwnerChange.onChange](g,P,I){this.isGlobalDetector(g)&&this.updateAroundDetector(g,I),this.isCloakable(g)&&this.detect(g,I)}[_.NotifyTileChange.onTileChange](g,P,I){this.isGlobalDetector(g)&&this.updateAroundDetector(g,P),this.isCloakable(g)&&this.detect(g,P)}[q.NotifyObjectTraitAdd.onAdd](g,P,I){g.isTechno()&&(P instanceof $.CloakableTrait?this.isCloakable(g)&&this.detect(g,I):P instanceof Q.SensorsTrait&&this.isGlobalDetector(g)&&this.updateAroundDetector(g,I))}[V.NotifyPower.onPowerLow](g,P){}[V.NotifyPower.onPowerRestore](g,P){var I=[...this.detectors].filter(P=>P.owner===g&&P.isBuilding()&&P.poweredTrait);this.updateAroundDetectors(I,P)}[V.NotifyPower.onPowerChange](g,P){}[W.NotifyTick.onTick](g){for(var P of g.getCombatants()){var I;for(I of P.getOwnedObjects())I.cloakableTrait&&!I.cloakableTrait.isCloaked()&&this.detect(I,g)}}updateAroundDetectors(g,P){let I=new Set;for(var L of g)for(var _ of this.findTechnosAroundDetector(L,P))I.add(_);for(var U of I)this.isCloakable(U)&&this.detect(U,P)}updateAroundDetector(g,P){var I;for(I of this.findTechnosAroundDetector(g,P))this.isCloakable(I)&&this.detect(I,P)}findTechnosAroundDetector(g,P){var I=g.getFoundation(),L=Math.max(I.width,I.height);I=g.rules.sensorsSight+L,L=new Y.Vector2(g.tile.rx,g.tile.ry).addScalar(-I),I=new Y.Vector2(g.tile.rx,g.tile.ry).addScalar(I);return P.map.technosByTile.queryRange(new Z.Box2(L,I))}detect(g,P){let I=new G.RangeHelper(P.map.tileOccupation);for(var L of this.detectors)if(!P.areFriendly(L,g)){var _=L.rules.sensorsSight;if((!L.isBuilding()||!L.poweredTrait||L.poweredTrait.isPoweredOn())&&I.tileDistance(g,L.tile)<=_){if(_=g.cloakableTrait?.isCloaked(),g.cloakableTrait.uncloak(P),_)for(var U of[L.owner,...P.alliances.getAllies(L.owner)])P.traits.get(z.RadarTrait).addEventForPlayer(K.RadarEventType.GenericNonCombat,U,g.tile,P);break}}}isGlobalDetector(g){return!(!g.isTechno()||!g.sensorsTrait&&!g.rules.sensorArray||!g.rules.sensorsSight)}isCloakable(g){return g.isTechno()&&!!g.cloakableTrait}},g("SharedDetectCloakTrait",X)}}}),System.register("game/trait/SharedDetectDisguiseTrait",["game/trait/interface/NotifyOwnerChange","game/trait/interface/NotifySpawn","game/trait/interface/NotifyTileChange","game/trait/interface/NotifyUnspawn","game/gameobject/unit/RangeHelper","game/trait/interface/NotifyPower","game/math/Vector2","game/math/Box2"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g}],execute:function(){K=class{constructor(){this.detectors=new Set}[L.NotifySpawn.onSpawn](g,P){this.isGlobalDetector(g)&&(this.detectors.add(g),this.updateAroundDetector(g,P)),this.isDisguisable(g)&&this.detect(g,P)}[U.NotifyUnspawn.onUnspawn](g,P){g.isTechno()&&(this.isGlobalDetector(g)&&(this.detectors.delete(g),this.updateAroundDetector(g,P)),this.isDisguisable(g)&&this.undetect(g,P))}[I.NotifyOwnerChange.onChange](g,P,I){this.isGlobalDetector(g)&&this.updateAroundDetector(g,I),this.isDisguisable(g)&&(this.undetect(g,I),this.detect(g,I))}[_.NotifyTileChange.onTileChange](g,P,I){this.isGlobalDetector(g)&&(this.updateAroundDetector(g,P,I),this.updateAroundDetector(g,P)),this.isDisguisable(g)&&(this.undetect(g,P),this.detect(g,P))}[V.NotifyPower.onPowerLow](g,P){var I=[...this.detectors].filter(P=>P.owner===g&&P.isBuilding()&&P.poweredTrait&&!P.poweredTrait.isPoweredOn());this.updateAroundDetectors(I,P)}[V.NotifyPower.onPowerRestore](g,P){var I=[...this.detectors].filter(P=>P.owner===g&&P.isBuilding()&&P.poweredTrait);this.updateAroundDetectors(I,P)}[V.NotifyPower.onPowerChange](g,P){}updateAroundDetectors(g,P){let I=new Set;for(var L of g)for(var _ of this.findTechnosAroundDetector(L,P,L.tile))I.add(_);for(var U of I)this.isDisguisable(U)&&(this.undetect(U,P),this.detect(U,P))}updateAroundDetector(g,P,I=g.tile){var L;for(L of this.findTechnosAroundDetector(g,P,I))this.isDisguisable(L)&&(this.undetect(L,P),this.detect(L,P))}findTechnosAroundDetector(g,P,I){var L=g.getFoundation(),_=Math.max(L.width,L.height);L=g.rules.detectDisguiseRange+_,_=new W.Vector2(I.rx,I.ry).addScalar(-L),L=new W.Vector2(I.rx,I.ry).addScalar(L);return P.map.technosByTile.queryRange(new z.Box2(_,L))}detect(g,P){let I=new Set,L=new G.RangeHelper(P.map.tileOccupation);for(var _ of this.detectors)if(!P.areFriendly(_,g)){var U=_.owner,V=_.rules.detectDisguiseRange;if(!I.has(U)&&(!_.isBuilding()||!_.poweredTrait||_.poweredTrait.isPoweredOn())&&L.tileDistance(g,_.tile)<=V)for(var W of[U,...P.alliances.getAllies(U)])I.add(W)}for(var z of I)z.sharedDetectDisguiseTrait?.add(g)}undetect(g,P){for(var I of P.getCombatants())I.sharedDetectDisguiseTrait?.delete(g)}isGlobalDetector(g){return!(!g.isTechno()||!g.rules.detectDisguiseRange)}isDisguisable(g){return!(!g.isInfantry()&&!g.isVehicle()||!g.disguiseTrait)}},g("SharedDetectDisguiseTrait",K)}}}),System.register("game/trait/StalemateDetectTrait",["game/event/StalemateDetectEvent","game/GameSpeed","game/trait/interface/NotifyDestroy","game/trait/interface/NotifyOwnerChange","game/trait/interface/NotifyPlaceBuilding","game/trait/interface/NotifyProduceUnit","game/trait/interface/NotifyTick"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g}],execute:function(){z=class c{constructor(){this.stale=!1,this.allPlayersCredits=new Map,this.resetCountdown()}isStale(){return this.stale}getCountdownTicks(){return this.countdownTicks}resetCountdown(){this.countdownTicks=Math.floor(60*c.graceMinutes*L.GameSpeed.BASE_TICKS_PER_SECOND)}clearStale(){this.stale=!1,this.resetCountdown()}[W.NotifyTick.onTick](g){for(var P of(0<this.countdownTicks?this.countdownTicks--:this.stale||(this.stale=!0,this.resetCountdown(),g.events.dispatch(new I.StalemateDetectEvent)),g.getCombatants())){var L=this.allPlayersCredits.get(P);L!==P.credits&&(this.allPlayersCredits.set(P,P.credits),P.credits>(L??0)&&P.production.hasAnyFactory()&&this.clearStale())}}[V.NotifyProduceUnit.onProduce](){this.clearStale()}[G.NotifyPlaceBuilding.onPlace](g){g.wallTrait||this.clearStale()}[_.NotifyDestroy.onDestroy](g,P,I){!g.isBuilding()||g.owner.isNeutral||g.wallTrait||g.rules.insignificant||g.owner.defeated&&this.stale||I?.obj&&P.areFriendly(g,I.obj)||this.clearStale()}[U.NotifyOwnerChange.onChange](g,P,I){g.isBuilding()&&!P.isNeutral&&(I.alliances.areAllied(g.owner,P)||this.clearStale())}},g("StalemateDetectTrait",z),z.graceMinutes=10}}}),System.register("game/trait/SuperWeaponsTrait",["game/trait/interface/NotifyWarpChange","game/SuperWeapon","game/superweapon/SuperWeaponEffect","game/trait/interface/NotifyPower","game/trait/interface/NotifyTick","game/type/SuperWeaponType","game/trait/interface/NotifySuperWeaponActivate","game/event/SuperWeaponActivateEvent","game/superweapon/ParadropEffect","game/superweapon/NukeEffect","game/superweapon/LightningStormEffect","game/superweapon/IronCurtainEffect","game/superweapon/ChronoSphereEffect","game/trait/interface/NotifySuperWeaponDeactivate","engine/type/ObjectType"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g}],execute:function(){J=class{constructor(){this.effects=[]}[G.NotifyTick.onTick](g){for(var P of g.getCombatants()){var I;for(I of P.superWeaponsTrait.getAll())I.update(g)}for(let P of this.effects)P.status===_.EffectStatus.NotStarted&&(P.onStart(g),P.status=_.EffectStatus.Running),P.onTick(g)&&(P.status=_.EffectStatus.Finished,g.traits.filter(Z.NotifySuperWeaponDeactivate).forEach(I=>{I[Z.NotifySuperWeaponDeactivate.onDeactivate](P.type,P.owner,g)}));this.effects=this.effects.filter(g=>g.status!==_.EffectStatus.Finished)}[U.NotifyPower.onPowerLow](g,P){g.superWeaponsTrait?.getAll()?.filter(g=>g.rules.isPowered).forEach(g=>{this.updateTimer(g,!1)})}[U.NotifyPower.onPowerRestore](g,P){g.superWeaponsTrait?.getAll()?.filter(g=>g.rules.isPowered).forEach(g=>{this.updateTimer(g,!0)})}[U.NotifyPower.onPowerChange](g,P){}[I.NotifyWarpChange.onChange](g,P){var I;g.owner.powerTrait&&g.isBuilding()&&g.superWeaponTrait&&(I=g.superWeaponTrait.getSuperWeapon(g))&&this.updateTimer(I,!g.owner.powerTrait.isLowPower())}updateTimer(g,P){var I=this.superWeaponHasValidBuilding(g);P&&I?g.resumeTimer():g.pauseTimer()}superWeaponHasValidBuilding(g){return[...g.owner.buildings].find(P=>!(P.superWeaponTrait?.getSuperWeapon(P)!==g||P.warpedOutTrait.isActive()&&g.rules.isPowered))}addEffect(g){this.effects.push(g)}activateSuperWeapon(g,P,I,_,U){let G=P.superWeaponsTrait?.getAll().find(P=>P.rules.type===g);if(G&&G.status===L.SuperWeaponStatus.Ready){if(G.oneTimeOnly)for(var V of(P.superWeaponsTrait.remove(G.name),P.buildings))V.rules.superWeapon===G.name&&V.superWeaponTrait&&V.superWeaponTrait.addSuperWeaponToPlayerIfNeeded(P,I);else G.resetTimer();this.activateEffect(G.rules,P,I,_,U)}}activateEffect(g,P,I,L,_,U=!1){const G=g.type;if(void 0!==G){let se=[];switch(G){case V.SuperWeaponType.AmerParaDrop:for(var[Z,J]of I.rules.general.paradrop.amerParaDrop.entries())I.rules.hasObject(J.inf,X.ObjectType.Infantry)?se.push(new K.ParadropEffect(G,P,L,J,Z)):console.warn(`Can't paradrop unknown infantry type "${J.inf}"`);break;case V.SuperWeaponType.ParaDrop:{let g=I.rules.general.paradrop.getParadropSquads(P.country.side);for(var[ee,te]of g.entries())I.rules.hasObject(te.inf,X.ObjectType.Infantry)?se.push(new K.ParadropEffect(G,P,L,te,ee)):console.warn(`Can't paradrop unknown infantry type "${te.inf}"`);break}case V.SuperWeaponType.MultiMissile:if(!g.weaponType)throw new Error("Missing WeaponType in super weapon rules");se.push(new q.NukeEffect(G,P,L,g.weaponType));break;case V.SuperWeaponType.LightningStorm:se.push(new $.LightningStormEffect(G,P,L));break;case V.SuperWeaponType.IronCurtain:se.push(new Q.IronCurtainEffect(G,P,L));break;case V.SuperWeaponType.ChronoSphere:if(!_)throw new Error("Missing tile2 action param");se.push(new Y.ChronoSphereEffect(G,P,L,_))}for(var re of se)this.addEffect(re);I.traits.filter(W.NotifySuperWeaponActivate).forEach(g=>{g[W.NotifySuperWeaponActivate.onActivate](G,P,I,L,_)}),I.events.dispatch(new z.SuperWeaponActivateEvent(G,P,L,_,U))}}},g("SuperWeaponsTrait",J)}}}),System.register("game/Traits",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("Traits",class{constructor(){this.allTraits=[],this.traitsByTypeCache=new Map}add(g){this.allTraits.push(g),this.traitsByTypeCache.clear()}addToFront(g){this.allTraits.unshift(g),this.traitsByTypeCache.clear()}remove(g){var P=this.allTraits.indexOf(g);-1!==P&&(this.allTraits.splice(P,1),this.traitsByTypeCache.clear())}filter(g){let P=this.traitsByTypeCache.get(g);return P||(P="function"==typeof g?this.allTraits.filter(P=>P instanceof g):this.allTraits.filter(P=>this.traitImplements(P,g)),this.traitsByTypeCache.set(g,P)),P}get(g){var P=this.find(g);if(!P)throw new Error("No matching trait found");return P}find(g){return this.filter(g)[0]}getAll(){return this.allTraits}traitImplements(g,P){for(var I of Object.getOwnPropertyNames(P))if(void 0===g[P[I]])return!1;return!0}clear(){this.allTraits.length=0,this.traitsByTypeCache.clear()}dispose(){this.getAll().forEach(g=>g.dispose?.()),this.clear()}})}}}),System.register("game/trigger/condition/AmbientLightCondition",["game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerCondition{constructor(g,P,I){super(g,P),this.type=I,this.threshold=Number(g.params[1])/100}check(g){var P=this.previousAmbient,I=g.mapLightingTrait.getAmbient().ambient;return this.previousAmbient=I,void 0!==P&&P!==I&&("above"===this.type?I>=this.threshold&&P<this.threshold:I<=this.threshold&&P>this.threshold)}},g("AmbientLightCondition",L)}}}),System.register("game/trigger/condition/AnyEventCondition",["game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerCondition{check(g){return!0}},g("AnyEventCondition",L)}}}),System.register("game/trigger/condition/AttackedByAnyCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerCondition{check(g,P){return P.filter(P=>{if(P.type!==I.EventType.ObjectAttacked)return!1;let L=P.target;if(!L.isTechno()||!this.targets.includes(L))return!1;var _=P.attacker?.player;return(!_||!g.alliances.areAllied(_,L.owner)&&_!==L.owner)&&!P.incidental}).map(g=>g.target)}},g("AttackedByAnyCondition",_)}}}),System.register("game/trigger/condition/AttackedByHouseCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerCondition{constructor(g,P){super(g,P),this.houseId=Number(g.params[1])}check(g,P){return P.filter(g=>{if(g.type!==I.EventType.ObjectAttacked)return!1;let P=g.target;if(!P.isTechno()||!this.targets.includes(P))return!1;var L=g.attacker?.player;return L&&(-1===this.houseId||L?.country?.id===this.houseId)}).map(g=>g.target)}},g("AttackedByHouseCondition",_)}}}),System.register("game/trigger/condition/BuildingExistsCondition",["game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerCondition{constructor(g,P,I=!1){super(g,P),this.negate=I,this.objectIndex=Number(g.params[1])}check(){if(!this.player)return!1;for(var g of this.player.buildings)if(g.rules.index===this.objectIndex)return!this.negate;return this.negate}},g("BuildingExistsCondition",L)}}}),System.register("game/trigger/condition/BuildObjectTypeCondition",["game/trigger/TriggerCondition","game/event/EventType"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends I.TriggerCondition{constructor(g,P,I){super(g,P),this.objectType=I,this.objectIndex=Number(g.params[1])}check(g,P){return P.some(g=>g.type===L.EventType.ObjectSpawn&&g.gameObject.type===this.objectType&&g.gameObject.rules.index===this.objectIndex)}},g("BuildObjectTypeCondition",_)}}}),System.register("game/trigger/condition/ComesNearWaypointCondition",["game/event/EventType","game/gameobject/unit/RangeHelper","game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class extends _.TriggerCondition{constructor(g,P){super(g,P)}init(g){super.init(g);var P=Number(this.event.params[1]);this.waypointTile=g.map.getTileAtWaypoint(P),this.waypointTile||console.warn(`No valid location found for waypoint ${P}. Skipping event ${this.getDebugName()}.`)}check(g,P){if(!this.waypointTile||!this.player)return!1;for(var _ of P)if(_.type===I.EventType.EnterTile&&_.source.owner===this.player){if(new L.RangeHelper(g.map.tileOccupation).tileDistance(_.target,this.waypointTile)<2)return!0}return!1}},g("ComesNearWaypointCondition",U)}}}),System.register("game/trigger/condition/CreditsBelowCondition",["game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerCondition{constructor(g,P){super(g,P),this.threshold=Number(g.params[1])}check(g,P){return!!this.player&&this.player.credits<this.threshold}},g("CreditsBelowCondition",L)}}}),System.register("game/trigger/condition/CreditsExceedCondition",["game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerCondition{constructor(g,P){super(g,P),this.threshold=Number(g.params[1])}check(g,P){return!!this.player&&this.player.credits>this.threshold}},g("CreditsExceedCondition",L)}}}),System.register("game/trigger/condition/CrossHorizLineCondition",["game/event/EventType","game/gameobject/unit/ZoneType","game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class extends _.TriggerCondition{constructor(g,P){super(g,P),this.houseId=Number(this.event.params[1])}check(g,P){return P.filter(g=>g.type===I.EventType.EnterTile&&g.source.zone!==L.ZoneType.Air&&this.targets.some(P=>P.ry===g.target.ry)&&(-1===this.houseId||g.source.owner.country?.id===this.houseId)).map(g=>g.target)}},g("CrossHorizLineCondition",U)}}}),System.register("game/trigger/condition/CrossVertLineCondition",["game/event/EventType","game/gameobject/unit/ZoneType","game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class extends _.TriggerCondition{constructor(g,P){super(g,P),this.houseId=Number(this.event.params[1])}check(g,P){return P.filter(g=>g.type===I.EventType.EnterTile&&g.source.zone!==L.ZoneType.Air&&this.targets.some(P=>P.rx===g.target.rx)&&(-1===this.houseId||g.source.owner.country?.id===this.houseId)).map(g=>g.target)}},g("CrossVertLineCondition",U)}}}),System.register("game/trigger/condition/DestroyedAllBuildingsCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerCondition{constructor(g,P){super(g,P),this.allDestroyed=!1,this.houseId=Number(g.params[1])}check(g,P){return!!this.allDestroyed||!!P.some(g=>{if(g.type!==I.EventType.ObjectDestroy)return!1;let P=g.target;return!(!P.isBuilding()||P.owner.country?.id!==this.houseId||P.owner.buildings.size)})&&(this.allDestroyed=!0)}},g("DestroyedAllBuildingsCondition",_)}}}),System.register("game/trigger/condition/DestroyedAllCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerCondition{constructor(g,P){super(g,P),this.allDestroyed=!1,this.houseId=Number(g.params[1])}check(g,P){return!!this.allDestroyed||!!P.some(g=>{if(g.type!==I.EventType.ObjectDestroy)return!1;let P=g.target;return!(!P.isTechno()||P.owner.country?.id!==this.houseId||P.owner.getOwnedObjects(!0).length)})&&(this.allDestroyed=!0)}},g("DestroyedAllCondition",_)}}}),System.register("game/trigger/condition/DestroyedAllUnitsCondition",["engine/type/ObjectType","game/event/EventType","game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class extends _.TriggerCondition{constructor(g,P){super(g,P),this.allDestroyed=!1,this.houseId=Number(g.params[1])}check(g,P){return!!this.allDestroyed||!!P.some(g=>{if(g.type!==L.EventType.ObjectDestroy)return!1;let P=g.target;return!(!P.isUnit()||P.owner.country?.id!==this.houseId||this.hasUnitsLeft(P.owner))})&&(this.allDestroyed=!0)}hasUnitsLeft(g){var P;for(P of[I.ObjectType.Aircraft,I.ObjectType.Vehicle,I.ObjectType.Infantry])if(g.getOwnedObjectsByType(P,!0).length)return!0;return!1}},g("DestroyedAllUnitsCondition",U)}}}),System.register("game/trigger/condition/DestroyedAllUnitsLandCondition",["engine/type/ObjectType","game/event/EventType","game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class extends _.TriggerCondition{constructor(g,P){super(g,P),this.allDestroyed=!1,this.houseId=Number(g.params[1])}check(g,P){return!!this.allDestroyed||!!P.some(g=>{if(g.type!==L.EventType.ObjectDestroy)return!1;let P=g.target;return!(!P.isUnit()||P.owner.country?.id!==this.houseId||this.hasLandUnitsLeft(P.owner))})&&(this.allDestroyed=!0)}hasLandUnitsLeft(g){var P;for(P of[I.ObjectType.Vehicle,I.ObjectType.Infantry])if(g.getOwnedObjectsByType(P,!0).filter(g=>!g.rules.naval).length)return!0;return!1}},g("DestroyedAllUnitsLandCondition",U)}}}),System.register("game/trigger/condition/DestroyedAllUnitsNavalCondition",["engine/type/ObjectType","game/event/EventType","game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class extends _.TriggerCondition{constructor(g,P){super(g,P),this.allDestroyed=!1,this.houseId=Number(g.params[1])}check(g,P){return!!this.allDestroyed||!!P.some(g=>{if(g.type!==L.EventType.ObjectDestroy)return!1;let P=g.target;return!(!P.isVehicle()||P.owner.country?.id!==this.houseId||P.owner.getOwnedObjectsByType(I.ObjectType.Vehicle,!0).filter(g=>g.rules.naval).length)})&&(this.allDestroyed=!0)}},g("DestroyedAllUnitsNavalCondition",U)}}}),System.register("game/trigger/condition/DestroyedBridgeCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerCondition{check(g,P){return P.filter(P=>{if(P.type!==I.EventType.ObjectDestroy)return!1;let L=P.target;if(!L.isOverlay()||!L.isBridge())return!1;var _=L.bridgeTrait?.bridgeSpec;if(!_)return!1;return g.map.bridges.findAllBridgeTiles(_).find(g=>this.targets.includes(g))}).map(g=>g.target.tile)}},g("DestroyedBridgeCondition",_)}}}),System.register("game/trigger/condition/DestroyedBuildingsCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerCondition{constructor(g,P){super(g,P),this.count=0,this.threshold=Number(g.params[1])}check(g,P){if(!this.player)return!1;if(this.count>=this.threshold)return!0;for(var L of P)if(L.type===I.EventType.ObjectDestroy){let g=L.target;g.isBuilding()&&g.owner.country?.id===this.houseId&&this.count++}return this.count>=this.threshold}},g("DestroyedBuildingsCondition",_)}}}),System.register("game/trigger/condition/DestroyedByAnyCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerCondition{check(g,P){return P.filter(P=>{if(P.type!==I.EventType.ObjectDestroy)return!1;let L=P.target;if(!L.isTechno()||!this.targets.includes(L))return!1;var _=P.attackerInfo?.player;return(!_||!g.alliances.areAllied(_,L.owner)&&_!==L.owner)&&!P.incidental}).map(g=>g.target)}},g("DestroyedByAnyCondition",_)}}}),System.register("game/trigger/condition/DestroyedOrCapturedCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerCondition{check(g,P){return P.filter(g=>{if(g.type!==I.EventType.ObjectDestroy&&g.type!==I.EventType.ObjectOwnerChange)return!1;let P=g.target;return!(!P.isTechno()||!this.targets.includes(P))}).map(g=>g.target)}},g("DestroyedOrCapturedCondition",_)}}}),System.register("game/trigger/condition/DestroyedOrCapturedOrInfiltratedCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerCondition{constructor(){super(...arguments),this.eventsFilter=[I.EventType.ObjectDestroy,I.EventType.ObjectOwnerChange,I.EventType.BuildingInfiltration]}check(g,P){return P.filter(g=>{if(!this.eventsFilter.includes(g.type))return!1;let P=g.target;return!(!P.isTechno()||!this.targets.includes(P))}).map(g=>g.target)}},g("DestroyedOrCapturedOrInfiltratedCondition",_)}}}),System.register("game/trigger/condition/DestroyedUnitsCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerCondition{constructor(g,P){super(g,P),this.count=0,this.threshold=Number(g.params[1])}check(g,P){if(!this.player)return!1;if(this.count>=this.threshold)return!0;for(var L of P)if(L.type===I.EventType.ObjectDestroy){let g=L.target;g.isUnit()&&g.owner.country?.id===this.houseId&&this.count++}return this.count>=this.threshold}},g("DestroyedUnitsCondition",_)}}}),System.register("game/trigger/condition/ElapsedScenarioTimeCondition",["game/GameSpeed","game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerCondition{constructor(g,P){super(g,P),this.timerTicks=Number(this.event.params[1])*I.GameSpeed.BASE_TICKS_PER_SECOND}check(g){return g.currentTick>this.timerTicks}},g("ElapsedScenarioTimeCondition",_)}}}),System.register("game/trigger/condition/ElapsedTimeCondition",["game/GameSpeed","game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerCondition{constructor(g,P){super(g,P),this.elapsedTicks=0,this.timerTicks=Number(this.event.params[1])*I.GameSpeed.BASE_TICKS_PER_SECOND}check(g){return this.elapsedTicks++>this.timerTicks}reset(){this.elapsedTicks=0}},g("ElapsedTimeCondition",_)}}}),System.register("game/trigger/condition/EnteredByCondition",["game/event/EventType","game/gameobject/unit/ZoneType","game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class extends _.TriggerCondition{constructor(g,P){super(g,P),this.houseId=Number(this.event.params[1])}check(g,P){return P.filter(g=>(g.type===I.EventType.EnterObject||g.type===I.EventType.EnterTile)&&this.targets.includes(g.target)&&(g.type!==I.EventType.EnterTile||g.source.zone!==L.ZoneType.Air)&&(-1===this.houseId||g.source.owner.country?.id===this.houseId)).map(g=>g.target)}},g("EnteredByCondition",U)}}}),System.register("game/trigger/condition/GlobalVariableCondition",["game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerCondition{constructor(g,P,I){super(g,P),this.value=I,this.blocking=!0,this.variableIdx=Number(g.params[1])}check(g){return g.triggers.getGlobalVariable(this.variableIdx)===this.value}},g("GlobalVariableCondition",L)}}}),System.register("game/trigger/condition/HealthBelowAnyCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerCondition{constructor(g,P,I){super(g,P),this.threshold=I}check(g,P){return P.filter(g=>{if(g.type!==I.EventType.HealthChange)return!1;let P=g.target;return!(!P.isTechno()||!this.targets.includes(P))&&g.currentHealth<this.threshold&&g.prevHealth>this.threshold}).map(g=>g.target)}},g("HealthBelowAnyCondition",_)}}}),System.register("game/trigger/condition/HealthBelowCombatCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerCondition{constructor(g,P,I){super(g,P),this.threshold=I}check(g,P){return P.filter(g=>{if(g.type!==I.EventType.InflictDamage)return!1;let P=g.target;return!(!P.isTechno()||!this.targets.includes(P))&&g.currentHealth<this.threshold&&g.prevHealth>this.threshold}).map(g=>g.target)}},g("HealthBelowCombatCondition",_)}}}),System.register("game/trigger/condition/LocalVariableCondition",["game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerCondition{constructor(g,P,I){super(g,P),this.value=I,this.blocking=!0,this.variableIdx=Number(g.params[1])}check(g){return g.triggers.getLocalVariable(this.variableIdx)===this.value}},g("LocalVariableCondition",L)}}}),System.register("game/trigger/condition/LowPowerCondition",["game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerCondition{constructor(g,P){super(g,P),this.houseId=Number(this.event.params[1])}init(g){super.init(g),this.targetPlayer=g.getAllPlayers().find(g=>g.country?.id===this.houseId)}check(){return!!this.targetPlayer?.powerTrait?.isLowPower()}},g("LowPowerCondition",L)}}}),System.register("game/trigger/condition/NoEventCondition",["game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerCondition{check(g){return!1}},g("NoEventCondition",L)}}}),System.register("game/trigger/condition/NoFactoriesLeftCondition",["game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerCondition{check(){if(!this.player)return!1;for(var g of this.player.buildings)if(g.factoryTrait)return!1;return!0}},g("NoFactoriesLeftCondition",L)}}}),System.register("game/trigger/condition/PickupCrateAnyCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerCondition{check(g,P){return P.some(g=>g.type===I.EventType.CratePickup)}},g("PickupCrateAnyCondition",_)}}}),System.register("game/trigger/condition/PickupCrateCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerCondition{check(g,P){return P.filter(g=>g.type===I.EventType.CratePickup&&this.targets.includes(g.source)).map(g=>g.source)}},g("PickupCrateCondition",_)}}}),System.register("game/trigger/condition/RandomDelayCondition",["game/GameSpeed","game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerCondition{constructor(){super(...arguments),this.elapsedTicks=0}check(g){return this.timerTicks??(this.timerTicks=Math.floor(g.generateRandomInt(50,150)/100*Number(this.event.params[1]))*I.GameSpeed.BASE_TICKS_PER_SECOND),this.elapsedTicks++>this.timerTicks}reset(){this.timerTicks=void 0,this.elapsedTicks=0}},g("RandomDelayCondition",_)}}}),System.register("game/trigger/condition/SpiedByCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerCondition{constructor(g,P){super(g,P),this.houseId=Number(this.event.params[1])}check(g,P){return P.filter(g=>g.type===I.EventType.BuildingInfiltration&&this.targets.includes(g.target)&&(-1===this.houseId||g.source.owner.country?.id===this.houseId)).map(g=>g.target)}},g("SpiedByCondition",_)}}}),System.register("game/trigger/condition/SpyEnteringAsHouseCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerCondition{constructor(g,P){super(g,P),this.houseId=Number(g.params[1])}check(g,P){return P.filter(g=>{if(g.type!==I.EventType.BuildingInfiltration)return!1;var P=g.target;return!!this.targets.includes(P)&&(-1===this.houseId||g.source.disguiseTrait?.getDisguise()?.owner?.country?.id===this.houseId)}).map(g=>g.target)}},g("SpyEnteringAsHouseCondition",_)}}}),System.register("game/trigger/condition/SpyEnteringAsInfantryCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerCondition{constructor(g,P){super(g,P),this.infantryIdx=Number(g.params[1])}check(g,P){return P.filter(g=>{if(g.type!==I.EventType.BuildingInfiltration)return!1;var P=g.target;return!!this.targets.includes(P)&&g.source.disguiseTrait?.getDisguise()?.rules.index===this.infantryIdx}).map(g=>g.target)}},g("SpyEnteringAsInfantryCondition",_)}}}),System.register("game/trigger/condition/TimerExpiredCondition",["game/event/EventType","game/trigger/TriggerCondition"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerCondition{check(g,P){return P.some(g=>g.type===I.EventType.TimerExpire)}},g("TimerExpiredCondition",_)}}}),System.register("game/trigger/executor/AddSuperWeaponExecutor",["game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerExecutor{constructor(g,P,I){super(g,P),this.oneTimeOnly=I,this.superWeaponIdx=Number(g.params[1])}execute(g){var P=[...g.rules.superWeaponRules.values()].find(g=>g.index===this.superWeaponIdx);if(P){let I=g.getAllPlayers().find(g=>g.country?.name===this.trigger.houseName);if(I&&I.superWeaponsTrait&&!I.superWeaponsTrait.has(P.name)){let L=g.createSuperWeapon(P.name,I,this.oneTimeOnly);L.isGift=!0,I.superWeaponsTrait.add(L)}}else console.warn(`No superweapon found with index "${this.superWeaponIdx}". Skipping action ${this.getDebugName()}.`)}},g("AddSuperWeaponExecutor",L)}}}),System.register("game/trigger/executor/ApplyDamageExecutor",["game/Coords","game/gameobject/unit/CollisionType","game/Warhead","game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=class extends U.TriggerExecutor{constructor(g,P,I){super(g,P),this.damage=I}execute(g){var P=Number(this.action.params[1]),U=g.map.getTileAtWaypoint(P);if(U){var G=g.rules.getWarhead(_.Warhead.HE_WARHEAD_NAME);let P=new _.Warhead(G);var V=g.map.tileOccupation.getBridgeOnTile(U),W=V?.tileElevation??0;G=g.map.getTileZone(U);P.detonate(g,this.damage,U,W,I.Coords.tile3dToWorld(U.rx+.5,U.ry+.5,U.z+W),G,V?L.CollisionType.OnBridge:L.CollisionType.None,g.createTarget(V,U),void 0)}else console.warn(`No valid location found for waypoint ${P}. Skipping action ${this.getDebugName()}.`)}},g("ApplyDamageExecutor",G)}}}),System.register("game/trigger/executor/ChangeHouseAllExecutor",["game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class a extends I.TriggerExecutor{execute(g){let P=g.getAllPlayers().find(g=>g.country?.name===this.trigger.houseName);if(P){let L,_=Number(this.action.params[1]);if(_>=a.locationHouseIdBegin&&_<a.locationHouseIdBegin+g.map.startingLocations.length){let P=_-a.locationHouseIdBegin;L=g.getAllPlayers().find(g=>g.startLocation===P)}else L=g.getAllPlayers().find(g=>g.country?.id===_);if(L?.defeated&&(L=g.isAssetRedistributionEnabled()?g.alliances.getAllies(P)[0]:void 0),L)for(var I of P.getOwnedObjects(!0))g.changeObjectOwner(I,L)}}},g("ChangeHouseAllExecutor",L),L.locationHouseIdBegin=4475}}}),System.register("game/trigger/executor/ChangeHouseExecutor",["game/gameobject/GameObject","game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class a extends L.TriggerExecutor{constructor(g,P){super(g,P),this.houseId=Number(g.params[1])}execute(g,P){let L;if(this.houseId>=a.locationHouseIdBegin&&this.houseId<a.locationHouseIdBegin+g.map.startingLocations.length){let P=this.houseId-a.locationHouseIdBegin;L=g.getAllPlayers().find(g=>g.startLocation===P)}else L=g.getAllPlayers().find(g=>g.country?.id===this.houseId);if(L?.defeated&&(L=g.isAssetRedistributionEnabled()?g.alliances.getAllies(L)[0]:void 0),L)for(var _ of P)_ instanceof I.GameObject&&_.isSpawned&&g.changeObjectOwner(_,L)}},g("ChangeHouseExecutor",_),_.locationHouseIdBegin=4475}}}),System.register("game/trigger/executor/CheerExecutor",["engine/type/ObjectType","game/gameobject/task/CheerTask","game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class extends _.TriggerExecutor{constructor(g,P){super(g,P),this.houseId=Number(g.params[1])}execute(g){let P=g.getAllPlayers().filter(g=>g.country&&!g.defeated);if(-1!==this.houseId&&(P=P.filter(g=>g.country?.id===this.houseId)),P.length)for(var _ of P[0].getOwnedObjectsByType(I.ObjectType.Infantry))_.unitOrderTrait.isIdle()&&_.unitOrderTrait.addTask(new L.CheerTask)}},g("CheerExecutor",U)}}}),System.register("game/trigger/executor/CreateCrateExecutor",["game/type/PowerupType","game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=new Map([[0,g=>{var P=g.rules.powerups.powerups.find(g=>g.type===I.PowerupType.Money);return P?{...P,data:"5000"}:void 0}],[1,I.PowerupType.Unit],[2,I.PowerupType.HealBase],[3,I.PowerupType.Cloak],[4,I.PowerupType.Explosion],[5,I.PowerupType.Napalm],[6,I.PowerupType.Money],[7,I.PowerupType.Darkness],[8,I.PowerupType.Reveal],[9,I.PowerupType.Armor],[10,I.PowerupType.Speed],[11,I.PowerupType.Firepower],[12,I.PowerupType.ICBM],[13,void 0],[14,I.PowerupType.Veteran],[15,void 0],[16,I.PowerupType.Gas],[17,I.PowerupType.Tiberium],[18,void 0]]),U=class extends L.TriggerExecutor{execute(g){var P=Number(this.action.params[1]),I=this.action.params[6],L=g.map.getTileAtWaypoint(I);if(L)if(_.has(P)){const I=_.get(P);(P="function"==typeof I?I(g):g.rules.powerups.powerups.find(g=>g.type===I))&&g.crateGeneratorTrait.spawnCrateAt(L,P,g)}else g.crateGeneratorTrait.spawnRandomCrateAt(L,g);else console.warn(`No valid location found for waypoint ${I}. Skipping action ${this.getDebugName()}.`)}},g("CreateCrateExecutor",U)}}}),System.register("game/trigger/executor/CreateRadarEventExecutor",["game/rules/general/RadarRules","game/trait/RadarTrait","game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class extends _.TriggerExecutor{execute(g){var P=Number(this.action.params[1])-1;if(Object.values(I.RadarEventType).includes(P)){var _=this.action.params[6],U=g.map.getTileAtWaypoint(_);if(U)for(var G of g.getCombatants())g.traits.get(L.RadarTrait).addEventForPlayer(P,G,U,g);else console.warn(`No valid location found for waypoint ${_}. Skipping action ${this.getDebugName()}.`)}else console.warn(`Unknown radar event type "${1+P}". Skipping action ${this.getDebugName()}.`)}},g("CreateRadarEventExecutor",U)}}}),System.register("game/trigger/executor/DestroyObjectExecutor",["game/gameobject/GameObject","game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerExecutor{execute(g,P){for(var L of P)L instanceof I.GameObject&&L.isSpawned&&g.destroyObject(L)}},g("DestroyObjectExecutor",_)}}}),System.register("game/trigger/executor/DestroyTagExecutor",["game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerExecutor{execute(g){var P=this.action.params[1];g.triggers.destroyTag(P)}},g("DestroyTagExecutor",L)}}}),System.register("game/trigger/executor/DestroyTriggerExecutor",["game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerExecutor{execute(g){var P=this.action.params[1];g.triggers.destroyTrigger(P)}},g("DestroyTriggerExecutor",L)}}}),System.register("game/trigger/executor/DetonateWarheadExecutor",["game/Coords","game/gameobject/unit/CollisionType","game/Warhead","game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=class extends U.TriggerExecutor{execute(g){var P=Number(this.action.params[1]),U=this.action.params[6],G=g.map.getTileAtWaypoint(U);if(G){let z,K;try{z=g.rules.getWeaponByInternalId(P)}catch(U){if(U instanceof RangeError)return void console.warn(`Weapon with internal ID "${P}" not found. Skipping action ${this.getDebugName()}.`);throw U}try{K=g.rules.getWarhead(z.warhead)}catch(U){return void console.warn(`Warhead "${z.warhead}" not found. Skipping action ${this.getDebugName()}.`)}let q=new _.Warhead(K);var V=g.map.tileOccupation.getBridgeOnTile(G),W=V?.tileElevation??0;P=g.map.getTileZone(G);q.detonate(g,z.damage,G,W,I.Coords.tile3dToWorld(G.rx+.5,G.ry+.5,G.z+W),P,V?L.CollisionType.OnBridge:L.CollisionType.None,g.createTarget(V,G),void 0)}else console.warn(`No valid location found for waypoint ${U}. Skipping action ${this.getDebugName()}.`)}},g("DetonateWarheadExecutor",G)}}}),System.register("game/trigger/executor/EvictOccupiersExecutor",["game/gameobject/GameObject","game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerExecutor{execute(g,P){for(var L of P)L instanceof I.GameObject&&L.isBuilding()&&L.garrisonTrait&&!L.isDestroyed&&L.garrisonTrait.evacuate(g)}},g("EvictOccupiersExecutor",_)}}}),System.register("game/trigger/executor/FireSaleExecutor",["game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerExecutor{constructor(g,P){super(g,P),this.houseId=Number(g.params[1])}execute(g){var P=g.getAllPlayers().find(g=>g.country?.id===this.houseId);if(P)for(var I of P.buildings)g.sellTrait.sell(I)}},g("FireSaleExecutor",L)}}});System.register("game/trigger/executor/ForceEndExecutor",["game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerExecutor{execute(g){g.end()}},g("ForceEndExecutor",L)}}}),System.register("game/trigger/executor/ForceTriggerExecutor",["game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerExecutor{execute(g){var P=this.action.params[1];g.triggers.forceTrigger(P,g)}},g("ForceTriggerExecutor",L)}}}),System.register("game/trigger/executor/GlobalVariableExecutor",["game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerExecutor{constructor(g,P,I){super(g,P),this.value=I,this.variableIdx=Number(g.params[1])}execute(g){g.triggers.toggleGlobalVariable(this.variableIdx,this.value)}},g("GlobalVariableExecutor",L)}}}),System.register("game/trigger/executor/IronCurtainExecutor",["game/trait/SuperWeaponsTrait","game/type/SuperWeaponType","game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class extends _.TriggerExecutor{execute(g){var P,_,U=this.action.params[6],G=g.map.getTileAtWaypoint(U);G?!(P=g.getAllPlayers().find(g=>!g.defeated&&g.country?.name===this.trigger.houseName))||(_=[...g.rules.superWeaponRules.values()].find(g=>g.type===L.SuperWeaponType.IronCurtain))&&g.traits.get(I.SuperWeaponsTrait).activateEffect(_,P,g,G,void 0,!0):console.warn(`No valid location found for waypoint ${U}. Skipping action ${this.getDebugName()}.`)}},g("IronCurtainExecutor",U)}}}),System.register("game/trigger/executor/LightningStrikeExecutor",["game/trait/SuperWeaponsTrait","game/type/SuperWeaponType","game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class extends _.TriggerExecutor{execute(g){var P,_,U=this.action.params[6],G=g.map.getTileAtWaypoint(U);G?!(P=g.getAllPlayers().find(g=>!g.defeated&&g.country?.name===this.trigger.houseName))||(_=[...g.rules.superWeaponRules.values()].find(g=>g.type===L.SuperWeaponType.LightningStorm))&&g.traits.get(I.SuperWeaponsTrait).activateEffect(_,P,g,G,void 0,!0):console.warn(`No valid location found for waypoint ${U}. Skipping action ${this.getDebugName()}.`)}},g("LightningStrikeExecutor",U)}}}),System.register("game/trigger/executor/LocalVariableExecutor",["game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerExecutor{constructor(g,P,I){super(g,P),this.value=I,this.variableIdx=Number(g.params[1])}execute(g){g.triggers.toggleLocalVariable(this.variableIdx,this.value)}},g("LocalVariableExecutor",L)}}}),System.register("game/trigger/executor/NoActionExecutor",["game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerExecutor{execute(){}},g("NoActionExecutor",L)}}}),System.register("game/trigger/executor/NukeStrikeExecutor",["game/trait/SuperWeaponsTrait","game/type/SuperWeaponType","game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class extends _.TriggerExecutor{execute(g){var P,_,U=this.action.params[6],G=g.map.getTileAtWaypoint(U);G?!(P=g.getAllPlayers().find(g=>!g.defeated&&g.country?.name===this.trigger.houseName))||(_=[...g.rules.superWeaponRules.values()].find(g=>g.type===L.SuperWeaponType.MultiMissile))&&g.traits.get(I.SuperWeaponsTrait).activateEffect(_,P,g,G,void 0,!0):console.warn(`No valid location found for waypoint ${U}. Skipping action ${this.getDebugName()}.`)}},g("NukeStrikeExecutor",U)}}}),System.register("game/trigger/executor/PlayAnimAtExecutor",["game/event/TriggerAnimEvent","game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerExecutor{execute(g){var P,L=this.action,_=Number(L.params[1]),U=g.rules.getAnimationName(_);void 0!==U?(P=L.params[6],(L=g.map.getTileAtWaypoint(P))?g.events.dispatch(new I.TriggerAnimEvent(U,L)):console.warn(`No valid location found for waypoint ${P}. Skipping action ${this.getDebugName()}.`)):console.warn(`No animation found for index "${_}". Skipping action `+this.getDebugName())}},g("PlayAnimAtExecutor",_)}}}),System.register("game/trigger/executor/PlaySoundFxAtExecutor",["game/event/TriggerSoundFxEvent","game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerExecutor{execute(g){var P,L=(P=this.action).params[1],_=P.params[6];(P=g.map.getTileAtWaypoint(_))?g.events.dispatch(new I.TriggerSoundFxEvent(L,P)):console.warn(`No valid location found for waypoint ${_}. Skipping action ${this.getDebugName()}.`)}},g("PlaySoundFxAtExecutor",_)}}}),System.register("game/trigger/executor/PlaySoundFxExecutor",["game/event/TriggerSoundFxEvent","game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerExecutor{execute(g){g.events.dispatch(new I.TriggerSoundFxEvent(this.action.params[1]))}},g("PlaySoundFxExecutor",_)}}}),System.register("game/trigger/executor/PlaySpeechExecutor",["game/event/TriggerEvaEvent","game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerExecutor{execute(g){g.events.dispatch(new I.TriggerEvaEvent(this.action.params[1]))}},g("PlaySpeechExecutor",_)}}}),System.register("game/trigger/executor/ReshroudMapExecutor",["game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerExecutor{execute(g){for(var P of g.getCombatants())g.mapShroudTrait.resetShroud(P,g)}},g("ReshroudMapExecutor",L)}}}),System.register("game/trigger/executor/ResizePlayerViewExecutor",["game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerExecutor{execute(g){var[P,I,L,_]=this.action.params.slice(2,6).map(Number);g.map.mapBounds.updateRawLocalSize({x:P,y:I,width:L,height:_})}},g("ResizePlayerViewExecutor",L)}}}),System.register("game/trigger/executor/RevealAroundWaypointExecutor",["game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerExecutor{execute(g){var P=Number(this.action.params[1]),I=g.map.getTileAtWaypoint(P);if(I)for(var L of g.getCombatants())g.mapShroudTrait.getPlayerShroud(L)?.revealAround(I,g.rules.general.revealTriggerRadius);else console.warn(`No valid location found for waypoint ${P}. Skipping action ${this.getDebugName()}.`)}},g("RevealAroundWaypointExecutor",L)}}}),System.register("game/trigger/executor/RevealMapExecutor",["game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerExecutor{execute(g){for(var P of g.getCombatants())g.mapShroudTrait.revealMap(P,g)}},g("RevealMapExecutor",L)}}}),System.register("game/trigger/executor/SellBuildingExecutor",["game/gameobject/GameObject","game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerExecutor{execute(g,P){for(var L of P)L instanceof I.GameObject&&L.isBuilding()&&!L.isDestroyed&&g.sellTrait.sell(L)}},g("SellBuildingExecutor",_)}}}),System.register("game/trigger/executor/SetAmbientLightExecutor",["game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerExecutor{execute(g){var P=Number(this.action.params[1])/100;g.mapLightingTrait.setTargetAmbientIntensity(P)}},g("SetAmbientLightExecutor",L)}}}),System.register("game/trigger/executor/SetAmbientRateExecutor",["util/number","game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerExecutor{execute(g){var P=I.int32ToFloat32(Number(this.action.params[1]));g.mapLightingTrait.setAmbientChangeRate(P)}},g("SetAmbientRateExecutor",_)}}}),System.register("game/trigger/executor/SetAmbientStepExecutor",["util/number","game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerExecutor{execute(g){var P=I.int32ToFloat32(Number(this.action.params[1]));g.mapLightingTrait.setAmbientChangeStep(P)}},g("SetAmbientStepExecutor",_)}}}),System.register("game/trigger/executor/StopSoundFxAtExecutor",["game/event/TriggerStopSoundFxEvent","game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerExecutor{execute(g){var P=this.action.params[6],L=g.map.getTileAtWaypoint(P);L?g.events.dispatch(new I.TriggerStopSoundFxEvent(L)):console.warn(`No valid location found for waypoint ${P}. Skipping action ${this.getDebugName()}.`)}},g("StopSoundFxAtExecutor",_)}}}),System.register("game/trigger/executor/TextTriggerExecutor",["game/event/TriggerTextEvent","game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerExecutor{execute(g){g.events.dispatch(new I.TriggerTextEvent(this.action.params[1]))}},g("TextTriggerExecutor",_)}}}),System.register("game/trigger/executor/TimerExtendExecutor",["game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerExecutor{execute(g){g.countdownTimer.addSeconds(Number(this.action.params[1]))}},g("TimerExtendExecutor",L)}}}),System.register("game/trigger/executor/TimerSetExecutor",["game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerExecutor{execute(g){g.countdownTimer.setSeconds(Number(this.action.params[1]))}},g("TimerSetExecutor",L)}}}),System.register("game/trigger/executor/TimerShortenExecutor",["game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerExecutor{execute(g){g.countdownTimer.addSeconds(-Number(this.action.params[1]))}},g("TimerShortenExecutor",L)}}}),System.register("game/trigger/executor/TimerStartExecutor",["game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerExecutor{execute(g){g.countdownTimer.start()}},g("TimerStartExecutor",L)}}}),System.register("game/trigger/executor/TimerStopExecutor",["game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerExecutor{execute(g){g.countdownTimer.stop()}},g("TimerStopExecutor",L)}}}),System.register("game/trigger/executor/TimerTextExecutor",["game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerExecutor{execute(g){g.countdownTimer.text=this.action.params[1]}},g("TimerTextExecutor",L)}}}),System.register("game/trigger/executor/ToggleTriggerExecutor",["game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerExecutor{constructor(g,P,I){super(g,P),this.triggerEnable=I}execute(g){var P=this.action.params[1];g.triggers.setTriggerEnabled(P,this.triggerEnable)}},g("ToggleTriggerExecutor",L)}}}),System.register("game/trigger/executor/TurnOnOffBuildingExecutor",["game/gameobject/GameObject","game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.TriggerExecutor{constructor(g,P,I){super(g,P),this.turnOn=I}execute(g,P){for(var L of P)L instanceof I.GameObject&&L.isBuilding()&&L.poweredTrait?.setTurnedOn(this.turnOn)}},g("TurnOnOffBuildingExecutor",_)}}}),System.register("game/trigger/executor/UnrevealAroundWaypointExecutor",["game/trigger/TriggerExecutor"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.TriggerExecutor{execute(g){var P=Number(this.action.params[1]),I=g.map.getTileAtWaypoint(P);if(I)for(var L of g.getCombatants())g.mapShroudTrait.getPlayerShroud(L)?.unrevealAround(I,g.rules.general.revealTriggerRadius);else console.warn(`No valid location found for waypoint ${P}. Skipping action ${this.getDebugName()}.`)}},g("UnrevealAroundWaypointExecutor",L)}}}),System.register("game/trigger/TriggerCondition",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("TriggerCondition",class{constructor(g,P){this.event=g,this.trigger=P,this.blocking=!1,this.targets=[]}init(g){var P=g.getAllPlayers().find(g=>g.country?.name===this.trigger.houseName);P&&(this.player=P)}setTargets(g){this.targets=g}reset(){}getDebugName(){return`${this.event.triggerId}[${this.event.eventIndex}] (${this.trigger.name}).`}})}}}),System.register("game/trigger/TriggerConditionFactory",["data/map/trigger/TriggerEventType","engine/type/ObjectType","game/trigger/condition/AmbientLightCondition","game/trigger/condition/AnyEventCondition","game/trigger/condition/AttackedByAnyCondition","game/trigger/condition/AttackedByHouseCondition","game/trigger/condition/BuildingExistsCondition","game/trigger/condition/BuildObjectTypeCondition","game/trigger/condition/ComesNearWaypointCondition","game/trigger/condition/CreditsBelowCondition","game/trigger/condition/CreditsExceedCondition","game/trigger/condition/CrossHorizLineCondition","game/trigger/condition/CrossVertLineCondition","game/trigger/condition/DestroyedAllBuildingsCondition","game/trigger/condition/DestroyedAllCondition","game/trigger/condition/DestroyedAllUnitsCondition","game/trigger/condition/DestroyedAllUnitsLandCondition","game/trigger/condition/DestroyedAllUnitsNavalCondition","game/trigger/condition/DestroyedBridgeCondition","game/trigger/condition/DestroyedBuildingsCondition","game/trigger/condition/DestroyedByAnyCondition","game/trigger/condition/DestroyedOrCapturedCondition","game/trigger/condition/DestroyedOrCapturedOrInfiltratedCondition","game/trigger/condition/DestroyedUnitsCondition","game/trigger/condition/ElapsedScenarioTimeCondition","game/trigger/condition/ElapsedTimeCondition","game/trigger/condition/EnteredByCondition","game/trigger/condition/GlobalVariableCondition","game/trigger/condition/HealthBelowAnyCondition","game/trigger/condition/HealthBelowCombatCondition","game/trigger/condition/LocalVariableCondition","game/trigger/condition/LowPowerCondition","game/trigger/condition/NoEventCondition","game/trigger/condition/NoFactoriesLeftCondition","game/trigger/condition/PickupCrateAnyCondition","game/trigger/condition/PickupCrateCondition","game/trigger/condition/RandomDelayCondition","game/trigger/condition/SpiedByCondition","game/trigger/condition/SpyEnteringAsHouseCondition","game/trigger/condition/SpyEnteringAsInfantryCondition","game/trigger/condition/TimerExpiredCondition"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be,Se,we,Ee,Ce,xe;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g},function(g){ce=g},function(g){he=g},function(g){ue=g},function(g){de=g},function(g){ge=g},function(g){pe=g},function(g){me=g},function(g){fe=g},function(g){ye=g},function(g){Te=g},function(g){ve=g},function(g){be=g},function(g){Se=g},function(g){we=g},function(g){Ee=g},function(g){Ce=g},function(g){xe=g}],execute:function(){g("TriggerConditionFactory",class{create(g,P){switch(g.type){case I.TriggerEventType.NoEvent:return new ye.NoEventCondition(g,P);case I.TriggerEventType.EnteredBy:return new ue.EnteredByCondition(g,P);case I.TriggerEventType.SpiedBy:return new we.SpiedByCondition(g,P);case I.TriggerEventType.AttackedByAny:return new G.AttackedByAnyCondition(g,P);case I.TriggerEventType.DestroyedByAny:return new ae.DestroyedByAnyCondition(g,P);case I.TriggerEventType.AnyEvent:return new U.AnyEventCondition(g,P);case I.TriggerEventType.DestroyedAllUnits:return new J.DestroyedAllUnitsCondition(g,P);case I.TriggerEventType.DestroyedAllBuildings:return new Z.DestroyedAllBuildingsCondition(g,P);case I.TriggerEventType.DestroyedAll:return new X.DestroyedAllCondition(g,P);case I.TriggerEventType.CreditsExceed:return new $.CreditsExceedCondition(g,P);case I.TriggerEventType.ElapsedTime:return new he.ElapsedTimeCondition(g,P);case I.TriggerEventType.MissionTimerExpired:return new xe.TimerExpiredCondition(g,P);case I.TriggerEventType.DestroyedBuildings:return new se.DestroyedBuildingsCondition(g,P);case I.TriggerEventType.DestroyedUnits:return new le.DestroyedUnitsCondition(g,P);case I.TriggerEventType.NoFactoriesLeft:return new Te.NoFactoriesLeftCondition(g,P);case I.TriggerEventType.BuildBuilding:return new z.BuildObjectTypeCondition(g,P,L.ObjectType.Building);case I.TriggerEventType.BuildUnit:return new z.BuildObjectTypeCondition(g,P,L.ObjectType.Vehicle);case I.TriggerEventType.BuildInfantry:return new z.BuildObjectTypeCondition(g,P,L.ObjectType.Infantry);case I.TriggerEventType.BuildAircraft:return new z.BuildObjectTypeCondition(g,P,L.ObjectType.Aircraft);case I.TriggerEventType.CrossesHorizontalLine:return new Q.CrossHorizLineCondition(g,P);case I.TriggerEventType.CrossesVerticalLine:return new Y.CrossVertLineCondition(g,P);case I.TriggerEventType.GlobalIsSet:return new de.GlobalVariableCondition(g,P,!0);case I.TriggerEventType.GlobalIsCleared:return new de.GlobalVariableCondition(g,P,!1);case I.TriggerEventType.DestroyedOrCaptured:return new ne.DestroyedOrCapturedCondition(g,P);case I.TriggerEventType.LowPower:return new fe.LowPowerCondition(g,P);case I.TriggerEventType.DestroyedBridge:return new re.DestroyedBridgeCondition(g,P);case I.TriggerEventType.BuildingExists:return new W.BuildingExistsCondition(g,P);case I.TriggerEventType.ComesNearWaypoint:return new K.ComesNearWaypointCondition(g,P);case I.TriggerEventType.LocalIsSet:return new me.LocalVariableCondition(g,P,!0);case I.TriggerEventType.LocalIsCleared:return new me.LocalVariableCondition(g,P,!1);case I.TriggerEventType.FirstDamagedCombat:return new pe.HealthBelowCombatCondition(g,P,100);case I.TriggerEventType.HalfHealthCombat:return new pe.HealthBelowCombatCondition(g,P,50);case I.TriggerEventType.QuarterHealthCombat:return new pe.HealthBelowCombatCondition(g,P,25);case I.TriggerEventType.FirstDamagedAny:return new ge.HealthBelowAnyCondition(g,P,100);case I.TriggerEventType.HalfHealthAny:return new ge.HealthBelowAnyCondition(g,P,50);case I.TriggerEventType.QuarterHealthAny:return new ge.HealthBelowAnyCondition(g,P,25);case I.TriggerEventType.AttackedByHouse:return new V.AttackedByHouseCondition(g,P);case I.TriggerEventType.AmbientLightBelow:return new _.AmbientLightCondition(g,P,"below");case I.TriggerEventType.AmbientLightAbove:return new _.AmbientLightCondition(g,P,"above");case I.TriggerEventType.ElapsedScenarioTime:return new ce.ElapsedScenarioTimeCondition(g,P);case I.TriggerEventType.DestroyedOrCapturedOrInfiltrated:return new oe.DestroyedOrCapturedOrInfiltratedCondition(g,P);case I.TriggerEventType.PickupCrate:return new be.PickupCrateCondition(g,P);case I.TriggerEventType.PickupCrateAny:return new ve.PickupCrateAnyCondition(g,P);case I.TriggerEventType.RandomDelay:return new Se.RandomDelayCondition(g,P);case I.TriggerEventType.CreditsBelow:return new q.CreditsBelowCondition(g,P);case I.TriggerEventType.SpyEnteringAsHouse:return new Ee.SpyEnteringAsHouseCondition(g,P);case I.TriggerEventType.SpyEnteringAsInfantry:return new Ce.SpyEnteringAsInfantryCondition(g,P);case I.TriggerEventType.DestroyedAllUnitsNaval:return new te.DestroyedAllUnitsNavalCondition(g,P);case I.TriggerEventType.DestroyedAllUnitsLand:return new ee.DestroyedAllUnitsLandCondition(g,P);case I.TriggerEventType.BuildingNotExists:return new W.BuildingExistsCondition(g,P,!0);default:throw new Error(`Unhandled trigger event type "${I.TriggerEventType[g.type]}"`)}}})}}}),System.register("game/trigger/TriggerExecutor",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("TriggerExecutor",class{constructor(g,P){this.action=g,this.trigger=P}getDebugName(){return`${this.action.triggerId}[${this.action.index}] (${this.trigger.name}).`}})}}}),System.register("game/trigger/TriggerExecutorFactory",["data/map/trigger/TriggerActionType","game/trigger/executor/AddSuperWeaponExecutor","game/trigger/executor/ApplyDamageExecutor","game/trigger/executor/ChangeHouseAllExecutor","game/trigger/executor/ChangeHouseExecutor","game/trigger/executor/CheerExecutor","game/trigger/executor/CreateCrateExecutor","game/trigger/executor/CreateRadarEventExecutor","game/trigger/executor/DestroyObjectExecutor","game/trigger/executor/DestroyTagExecutor","game/trigger/executor/DestroyTriggerExecutor","game/trigger/executor/DetonateWarheadExecutor","game/trigger/executor/EvictOccupiersExecutor","game/trigger/executor/FireSaleExecutor","game/trigger/executor/ForceEndExecutor","game/trigger/executor/ForceTriggerExecutor","game/trigger/executor/GlobalVariableExecutor","game/trigger/executor/IronCurtainExecutor","game/trigger/executor/LightningStrikeExecutor","game/trigger/executor/LocalVariableExecutor","game/trigger/executor/NoActionExecutor","game/trigger/executor/NukeStrikeExecutor","game/trigger/executor/PlayAnimAtExecutor","game/trigger/executor/PlaySoundFxAtExecutor","game/trigger/executor/PlaySoundFxExecutor","game/trigger/executor/PlaySpeechExecutor","game/trigger/executor/ReshroudMapExecutor","game/trigger/executor/ResizePlayerViewExecutor","game/trigger/executor/RevealAroundWaypointExecutor","game/trigger/executor/RevealMapExecutor","game/trigger/executor/SellBuildingExecutor","game/trigger/executor/SetAmbientLightExecutor","game/trigger/executor/SetAmbientRateExecutor","game/trigger/executor/SetAmbientStepExecutor","game/trigger/executor/StopSoundFxAtExecutor","game/trigger/executor/TextTriggerExecutor","game/trigger/executor/TimerExtendExecutor","game/trigger/executor/TimerSetExecutor","game/trigger/executor/TimerShortenExecutor","game/trigger/executor/TimerStartExecutor","game/trigger/executor/TimerStopExecutor","game/trigger/executor/TimerTextExecutor","game/trigger/executor/ToggleTriggerExecutor","game/trigger/executor/TurnOnOffBuildingExecutor","game/trigger/executor/UnrevealAroundWaypointExecutor"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be,Se,we,Ee,Ce,xe,Oe,Ae,Me,Re;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g},function(g){ce=g},function(g){he=g},function(g){ue=g},function(g){de=g},function(g){ge=g},function(g){pe=g},function(g){me=g},function(g){fe=g},function(g){ye=g},function(g){Te=g},function(g){ve=g},function(g){be=g},function(g){Se=g},function(g){we=g},function(g){Ee=g},function(g){Ce=g},function(g){xe=g},function(g){Oe=g},function(g){Ae=g},function(g){Me=g},function(g){Re=g}],execute:function(){g("TriggerExecutorFactory",class{create(g,P){switch(g.type){case I.TriggerActionType.NoAction:return new ae.NoActionExecutor(g,P);case I.TriggerActionType.FireSale:return new Z.FireSaleExecutor(g,P);case I.TriggerActionType.TextTrigger:return new be.TextTriggerExecutor(g,P);case I.TriggerActionType.DestroyTrigger:return new $.DestroyTriggerExecutor(g,P);case I.TriggerActionType.ChangeHouse:return new G.ChangeHouseExecutor(g,P);case I.TriggerActionType.RevealMap:return new pe.RevealMapExecutor(g,P);case I.TriggerActionType.RevealAroundWaypoint:return new ge.RevealAroundWaypointExecutor(g,P);case I.TriggerActionType.PlaySoundFx:return new ce.PlaySoundFxExecutor(g,P);case I.TriggerActionType.PlaySpeech:return new he.PlaySpeechExecutor(g,P);case I.TriggerActionType.ForceTrigger:return new J.ForceTriggerExecutor(g,P);case I.TriggerActionType.TimerStart:return new Ce.TimerStartExecutor(g,P);case I.TriggerActionType.TimerStop:return new xe.TimerStopExecutor(g,P);case I.TriggerActionType.TimerExtend:return new Se.TimerExtendExecutor(g,P);case I.TriggerActionType.TimerShorten:return new Ee.TimerShortenExecutor(g,P);case I.TriggerActionType.TimerSet:return new we.TimerSetExecutor(g,P);case I.TriggerActionType.GlobalSet:return new ee.GlobalVariableExecutor(g,P,!0);case I.TriggerActionType.GlobalClear:return new ee.GlobalVariableExecutor(g,P,!1);case I.TriggerActionType.DestroyObject:return new K.DestroyObjectExecutor(g,P);case I.TriggerActionType.AddOneTimeSuperWeapon:return new L.AddSuperWeaponExecutor(g,P,!0);case I.TriggerActionType.AddRepeatingSuperWeapon:return new L.AddSuperWeaponExecutor(g,P,!1);case I.TriggerActionType.AllChangeHouse:return new U.ChangeHouseAllExecutor(g,P);case I.TriggerActionType.ResizePlayerView:return new de.ResizePlayerViewExecutor(g,P);case I.TriggerActionType.PlayAnimAt:return new oe.PlayAnimAtExecutor(g,P);case I.TriggerActionType.DetonateWarhead:return new Q.DetonateWarheadExecutor(g,P);case I.TriggerActionType.ReshroudMap:return new ue.ReshroudMapExecutor(g,P);case I.TriggerActionType.EnableTrigger:return new Ae.ToggleTriggerExecutor(g,P,!0);case I.TriggerActionType.DisableTrigger:return new Ae.ToggleTriggerExecutor(g,P,!1);case I.TriggerActionType.CreateRadarEvent:return new z.CreateRadarEventExecutor(g,P);case I.TriggerActionType.LocalSet:return new se.LocalVariableExecutor(g,P,!0);case I.TriggerActionType.LocalClear:return new se.LocalVariableExecutor(g,P,!1);case I.TriggerActionType.SellBuilding:return new me.SellBuildingExecutor(g,P);case I.TriggerActionType.TurnOffBuilding:return new Me.TurnOnOffBuildingExecutor(g,P,!1);case I.TriggerActionType.TurnOnBuilding:return new Me.TurnOnOffBuildingExecutor(g,P,!0);case I.TriggerActionType.ApplyOneHundredDamage:return new _.ApplyDamageExecutor(g,P,100);case I.TriggerActionType.ForceEnd:return new X.ForceEndExecutor(g,P);case I.TriggerActionType.DestroyTag:return new q.DestroyTagExecutor(g,P);case I.TriggerActionType.SetAmbientStep:return new Te.SetAmbientStepExecutor(g,P);case I.TriggerActionType.SetAmbientRate:return new ye.SetAmbientRateExecutor(g,P);case I.TriggerActionType.SetAmbientLight:return new fe.SetAmbientLightExecutor(g,P);case I.TriggerActionType.NukeStrike:return new ne.NukeStrikeExecutor(g,P);case I.TriggerActionType.PlaySoundFxAt:return new le.PlaySoundFxAtExecutor(g,P);case I.TriggerActionType.UnrevealAroundWaypoint:return new Re.UnrevealAroundWaypointExecutor(g,P);case I.TriggerActionType.LightningStrike:return new re.LightningStrikeExecutor(g,P);case I.TriggerActionType.TimerText:return new Oe.TimerTextExecutor(g,P);case I.TriggerActionType.CreateCrate:return new W.CreateCrateExecutor(g,P);case I.TriggerActionType.IronCurtainAt:return new te.IronCurtainExecutor(g,P);case I.TriggerActionType.EvictOccupiers:return new Y.EvictOccupiersExecutor(g,P);case I.TriggerActionType.Cheer:return new V.CheerExecutor(g,P);case I.TriggerActionType.StopSoundsAt:return new ve.StopSoundFxAtExecutor(g,P);default:throw new Error(`Unhandled action type "${I.TriggerActionType[g.type]}"`)}}})}}}),System.register("game/trigger/TriggerInstance",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("game/trigger/TriggerManager",["data/map/tag/TagRepeatType","game/trigger/TriggerExecutorFactory","game/trigger/TriggerConditionFactory","util/disposable/CompositeDisposable","data/map/Variable"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){g("TriggerManager",class{constructor(){this.disposables=new U.CompositeDisposable,this.triggerInstances=new Map,this.targetsByTag=new Map,this.conditionFactory=new _.TriggerConditionFactory,this.executorFactory=new L.TriggerExecutorFactory,this.pendingGameEvents=[],this.globalVariables=new Map,this.localVariables=new Map}init(g){var P,I,L,_,U=g.map.getInitialMapObjects().technos;for(let P of U)if(P.tag){let I=this.targetsByTag.get(P.tag);I||(I=[],this.targetsByTag.set(P.tag,I));var G=g.map.tiles.getByMapCoords(P.rx,P.ry);!G||(G=g.map.getObjectsOnTile(G).find(g=>g.name===P.name&&g.type===P.type))&&I.push(G)}for(P of g.map.getCellTags()){var V=g.map.tiles.getByMapCoords(P.coords.x,P.coords.y);if(V){let g=this.targetsByTag.get(P.tagId);g||(g=[],this.targetsByTag.set(P.tagId,g)),g.push(V)}else console.warn(`CellTag out of bounds at (${P.coords.x}, ${P.coords.y}). Skipping.`)}for([I,L]of g.map.getVariables())this.localVariables.set(I,L.clone());for(_ of g.map.getTriggers())this.triggerInstances.set(_.id,this.createTriggerInstance(_,g));this.disposables.add(g.events.subscribe(g=>this.pendingGameEvents.push(g)))}createTriggerInstance(g,P){let L=this.targetsByTag.get(g.tag.id)??[];return{trigger:g,conditions:g.events.map(I=>{let _=this.conditionFactory.create(I,g);return _.setTargets(L),_.init(P),_}).sort((g,P)=>Number(P.blocking)-Number(g.blocking)),targets:L,remainingTargets:new Set(g.tag.repeatType===I.TagRepeatType.OnceAll?L:[]),disabled:g.disabled,finished:!1}}update(g){var P,L=this.pendingGameEvents.splice(0,this.pendingGameEvents.length);for(P of this.triggerInstances.values())if(!P.finished&&!P.disabled){let W=!0,z=[];for(var _ of P.conditions){var U=_.check(g,L);if("boolean"==typeof U?U||(W=!1):U.length?z.push(...U):W=!1,_.blocking&&!W)break}if(W){var G=P.trigger;P.conditions.forEach(g=>g.reset?.());let L=[];if(G.tag.repeatType===I.TagRepeatType.OnceAll){for(var V of z)P.remainingTargets.delete(V);if(P.remainingTargets.size)continue;L=z.length?[z[z.length-1]]:[]}else L=P.targets;this.executeActions(G,L,g),G.tag.repeatType!==I.TagRepeatType.Repeat&&(P.finished=!0)}}}executeActions(g,P,I){for(var L of g.actions){this.executorFactory.create(L,g).execute(I,P)}}setTriggerEnabled(g,P){let I=this.triggerInstances.get(g);I&&(I.disabled=!P)}forceTrigger(g,P){var I=this.triggerInstances.get(g);I&&this.executeActions(I.trigger,I.targets,P)}destroyTrigger(g){this.triggerInstances.delete(g)}destroyTag(g){let P=[];for(var[I,L]of this.triggerInstances)L.trigger.tag.id===g&&P.push(I);for(var _ of P)this.destroyTrigger(_)}getGlobalVariable(g){return!!this.globalVariables.get(g)?.value}toggleGlobalVariable(g,P){let I=this.globalVariables.get(g);void 0===I?this.globalVariables.set(g,new G.Variable("No name",P)):I.value=P}getLocalVariable(g){return!!this.localVariables.get(g)?.value}toggleLocalVariable(g,P){let I=this.localVariables.get(g);void 0===I?this.localVariables.set(g,new G.Variable("No name",P)):I.value=P}dispose(){this.disposables.dispose()}})}}}),System.register("game/trigger/TriggerTarget",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("game/type/ArmorType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("ArmorType",I={}))[P.None=0]="None",P[P.Flak=1]="Flak",P[P.Plate=2]="Plate",P[P.Light=3]="Light",P[P.Medium=4]="Medium",P[P.Heavy=5]="Heavy",P[P.Wood=6]="Wood",P[P.Steel=7]="Steel",P[P.Concrete=8]="Concrete",P[P.Special_1=9]="Special_1",P[P.Special_2=10]="Special_2"}}}),System.register("game/type/LandTargeting",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("LandTargeting",I={}))[P.LandOk=0]="LandOk",P[P.LandNotOk=1]="LandNotOk",P[P.LandSecondary=2]="LandSecondary"}}}),System.register("game/type/LandType",["engine/type/TerrainType"],function(g,P){"use strict";var I,L,_;return P&&P.id,g("getLandType",function(g){if(!_.has(g))throw new Error("Unknown terrain type "+g);return _.get(g)}),{setters:[function(g){I=g}],execute:function(){var P;(P=L||g("LandType",L={}))[P.Clear=0]="Clear",P[P.Road=1]="Road",P[P.Rock=2]="Rock",P[P.Beach=3]="Beach",P[P.Rough=4]="Rough",P[P.Railroad=5]="Railroad",P[P.Weeds=6]="Weeds",P[P.Water=7]="Water",P[P.Wall=8]="Wall",P[P.Tiberium=9]="Tiberium",P[P.Cliff=10]="Cliff",_=new Map([[I.TerrainType.Default,L.Clear],[I.TerrainType.Clear,L.Clear],[I.TerrainType.Tunnel,L.Cliff],[I.TerrainType.Railroad,L.Railroad],[I.TerrainType.Rock1,L.Rock],[I.TerrainType.Rock2,L.Rock],[I.TerrainType.Water,L.Water],[I.TerrainType.Shore,L.Beach],[I.TerrainType.Pavement,L.Road],[I.TerrainType.Dirt,L.Road],[I.TerrainType.Rough,L.Rough],[I.TerrainType.Cliff,L.Cliff]])}}}),System.register("game/type/LocomotorType",["game/type/SpeedType"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){var P;(P=L||g("LocomotorType",L={}))[P.Statue=0]="Statue",P[P.Aircraft=1]="Aircraft",P[P.Chrono=2]="Chrono",P[P.Hover=3]="Hover",P[P.Infantry=4]="Infantry",P[P.Jumpjet=5]="Jumpjet",P[P.Missile=6]="Missile",P[P.Ship=7]="Ship",P[P.Vehicle=8]="Vehicle",g("locomotorTypesByClsId",new Map([["{4A582746-9839-11d1-B709-00A024DDAFD1}",L.Aircraft],["{4A582747-9839-11d1-B709-00A024DDAFD1}",L.Chrono],["{4A582742-9839-11d1-B709-00A024DDAFD1}",L.Hover],["{4A582744-9839-11d1-B709-00A024DDAFD1}",L.Infantry],["{92612C46-F71F-11d1-AC9F-006008055BB5}",L.Jumpjet],["{B7B49766-E576-11d3-9BD9-00104B972FE8}",L.Missile],["{2BEA74E1-7CCA-11d3-BE14-00104B62A16C}",L.Ship],["{4A582741-9839-11d1-B709-00A024DDAFD1}",L.Vehicle]])),g("defaultSpeedsByLocomotor",new Map([[L.Infantry,I.SpeedType.Foot],[L.Ship,I.SpeedType.Float],[L.Hover,I.SpeedType.Hover],[L.Jumpjet,I.SpeedType.Winged],[L.Aircraft,I.SpeedType.Winged],[L.Missile,I.SpeedType.Winged]]))}}}),System.register("game/type/MovementZone",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("MovementZone",I={}))[P.Amphibious=0]="Amphibious",P[P.AmphibiousCrusher=1]="AmphibiousCrusher",P[P.AmphibiousDestroyer=2]="AmphibiousDestroyer",P[P.Crusher=3]="Crusher",P[P.CrusherAll=4]="CrusherAll",P[P.Destroyer=5]="Destroyer",P[P.Fly=6]="Fly",P[P.Infantry=7]="Infantry",P[P.InfantryDestroyer=8]="InfantryDestroyer",P[P.Normal=9]="Normal",P[P.Subterranean=10]="Subterranean",P[P.Water=11]="Water"}}}),System.register("game/type/NavalTargeting",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("NavalTargeting",I={}))[P.UnderwaterNever=0]="UnderwaterNever",P[P.UnderwaterSecondary=1]="UnderwaterSecondary",P[P.UnderwaterOnly=2]="UnderwaterOnly",P[P.OrganicSecondary=3]="OrganicSecondary",P[P.SealSpecial=4]="SealSpecial",P[P.NavalAll=5]="NavalAll",P[P.NavalNone=6]="NavalNone"}}}),System.register("game/type/PipColor",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("PipColor",I={}))[P.Green=0]="Green",P[P.Yellow=1]="Yellow",P[P.White=2]="White",P[P.Red=3]="Red",P[P.Blue=4]="Blue"}}}),System.register("game/type/PowerupType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("PowerupType",I={}))[P.Armor=0]="Armor",P[P.Firepower=1]="Firepower",P[P.HealBase=2]="HealBase",P[P.Money=3]="Money",P[P.Reveal=4]="Reveal",P[P.Speed=5]="Speed",P[P.Veteran=6]="Veteran",P[P.Unit=7]="Unit",P[P.Invulnerability=8]="Invulnerability",P[P.IonStorm=9]="IonStorm",P[P.Gas=10]="Gas",P[P.Tiberium=11]="Tiberium",P[P.Pod=12]="Pod",P[P.Cloak=13]="Cloak",P[P.Darkness=14]="Darkness",P[P.Explosion=15]="Explosion",P[P.ICBM=16]="ICBM",P[P.Napalm=17]="Napalm",P[P.Squad=18]="Squad"}}}),System.register("game/type/SpeedType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("SpeedType",I={}))[P.Foot=0]="Foot",P[P.Track=1]="Track",P[P.Wheel=2]="Wheel",P[P.Hover=3]="Hover",P[P.Float=4]="Float",P[P.FloatBeach=5]="FloatBeach",P[P.Amphibious=6]="Amphibious",P[P.Winged=7]="Winged"}}}),System.register("game/type/SuperWeaponType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("SuperWeaponType",I={}))[P.MultiMissile=0]="MultiMissile",P[P.IronCurtain=1]="IronCurtain",P[P.LightningStorm=2]="LightningStorm",P[P.ChronoSphere=3]="ChronoSphere",P[P.ChronoWarp=4]="ChronoWarp",P[P.ParaDrop=5]="ParaDrop",P[P.AmerParaDrop=6]="AmerParaDrop"}}}),System.register("game/type/VhpScan",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("VhpScan",I={}))[P.None=0]="None",P[P.Normal=1]="Normal",P[P.Strong=2]="Strong"}}}),System.register("game/Warhead",["game/gameobject/common/DeathType","game/gameobject/infantry/StanceType","game/gameobject/unit/ZoneType","game/gameobject/task/system/CallbackTask","game/gameobject/task/ScatterTask","game/map/BridgeOverlayTypes","game/trait/interface/NotifyAttack","game/type/ArmorType","game/gameobject/unit/CollisionType","game/gameobject/unit/RangeHelper","game/map/tileFinder/RadialTileFinder","game/Coords","util/math","game/gameobject/unit/FacingUtil","engine/type/ObjectType","game/event/WarheadDetonateEvent","game/WeaponType","game/rules/WeaponRules","data/IniSection","game/rules/ProjectileRules","game/gameobject/common/AnimTerrainEffect","game/event/ObjectAttackedEvent","game/SpecialWarheadType"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g}],execute:function(){g("Warhead",le=class{constructor(g){this.rules=g}canDamage(g,P,I){return!(!g.isSpawned||g.isDisposed||g.isDestroyed||g.isCrashing||g.isTechno()&&g.warpedOutTrait.isInvulnerable()&&!this.rules.temporal||g.isUnit()&&g.moveTrait.reservedPathNodes.find(g=>g.tile===P)||!g.healthTrait||g.isUnit()&&g.zone===_.ZoneType.Air&&I!==_.ZoneType.Air||!g.isUnit()&&I===_.ZoneType.Air||g.isBuilding()&&g.rules.invisibleInGame||(g.isTechno()||g.isTerrain())&&g.rules.immune&&!this.rules.temporal||g.isTechno()&&!g.rules.warpable&&this.rules.temporal||this.rules.radiation&&(!g.isUnit()||g.rules.immuneToRadiation)||this.rules.psychicDamage&&(!g.isUnit()||g.rules.immuneToPsionics)||g.isOverlay()&&V.BridgeOverlayTypes.isLowBridgeHead(g.overlayId))}computeDamage(g,P,I,U=!1){let G=g;if(0<g&&P.isTechno()&&P.invulnerableTrait.isActive())return 0;if(P.isAircraft()&&P.missileSpawnTrait&&P.zone!==_.ZoneType.Air)return 0;if(!I.gameOpts.destroyableBridges&&P.isOverlay()&&P.bridgeTrait)return 0;if(this.rules.radiation||this.rules.temporal||!P.isInfantry()||P.stance!==L.StanceType.Prone||(G*=this.rules.proneDamage),P.isTechno()||P.isOverlay()||P.isTerrain()){let g=P.isTerrain()?z.ArmorType.Wood:P.rules.armor;var W;P.isOverlay()&&P.isBridge()&&((W=V.BridgeOverlayTypes.getOverlayBridgeType(P.overlayId))===V.OverlayBridgeType.Wood?g=z.ArmorType.Wood:W===V.OverlayBridgeType.Concrete&&(g=z.ArmorType.Concrete)),U&&P.isOverlay()&&(P.isBridge()||P.rules.wall)||(G*=this.rules.verses.get(g)),0<G&&P.isTechno()&&P.veteranTrait&&(G/=P.veteranTrait.getVeteranArmorMultiplier()),0<G&&P.isUnit()&&(G/=P.crateBonuses.armor)}return(P.isOverlay()||P.isBuilding())&&P.rules.wall&&(this.rules.wallAbsoluteDestroyer?G=Number.POSITIVE_INFINITY:this.rules.wall||this.rules.wood&&P.rules.armor===z.ArmorType.Wood||(G=0)),P.isOverlay()&&P.isBridge()&&(this.rules.wall||(G=0)),G=0<G?Math.floor(G):Math.ceil(G),G}inflictDamage(g,P,L,U,G=!1){let V=P.healthTrait;return g===Number.POSITIVE_INFINITY&&(g=V.getHitPoints()),V.inflictDamage(g,L,U),U.traits.filter(W.NotifyAttack).forEach(g=>{g[W.NotifyAttack.onAttack](P,L?.obj,U)}),P.onAttack(U,L),U.events.dispatch(new ne.ObjectAttackedEvent(P,L,G)),P.isTechno()&&!this.rules.temporal&&this.supressOrScatterTarget(P,U),!V.health&&(P.isInfantry()&&(P.infDeathType=this.rules.infDeath),this.rules.temporal&&(P.deathType=I.DeathType.Temporal),P.isUnit()&&P.crashableTrait&&P.zone===_.ZoneType.Air&&!this.rules.temporal?P.crashableTrait.crash(L):U.destroyObject(P,L,void 0,G),!0)}supressOrScatterTarget(g,P){g.rules.fraidycat||g.isVehicle()&&!g.owner.isCombatant()&&g.rules.insignificant?g.unitOrderTrait.hasTasks()||(g.isInfantry()&&(g.isPanicked=!0),g.unitOrderTrait.addTask(new G.ScatterTask(P)),g.isInfantry()&&g.unitOrderTrait.addTask(new U.CallbackTask(()=>g.isPanicked=!1).setCancellable(!1))):g.isInfantry()&&(g.moveTrait.isIdle()||g.suppressionTrait?.isSuppressed())&&g.suppressionTrait?.suppress()}createDummyWeaponInfo(){return{minRange:0,range:0,speed:Number.POSITIVE_INFINITY,type:ee.WeaponType.Primary,rules:new te.WeaponRules(new re.IniSection("Dummy")),projectileRules:new se.ProjectileRules(X.ObjectType.Projectile,new re.IniSection("Dummy")),warhead:this}}detonate(g,P,I,L,U,G,V,W,z,X=oe.SpecialWarheadType.None,ee,te,re=!1){var se,ne,le,ce,he,ue=z?.weapon??this.createDummyWeaponInfo(),de=z?.obj,ge=z?.player,pe=X===oe.SpecialWarheadType.Shrapnel,me=X===oe.SpecialWarheadType.LightningStrike,fe=te?te/Q.Coords.LEPTONS_PER_TILE:this.rules.cellSpread,ye=this.rules.percentAtMax;let Te=new Set,ve=new Map,be=new q.RangeHelper(g.map.tileOccupation),Se=new $.RadialTileFinder(g.map.tiles,g.map.mapBounds,I,{width:1,height:1},0,Math.ceil(fe),()=>!0,!1);for(;se=Se.getNextTile();)for(ne of g.map.getObjectsOnTile(se))if((!Te.has(ne)||ne.isBuilding())&&(V!==K.CollisionType.UnderBridge||!ne.isUnit()||!ne.onBridge)&&!(de&&ne.isTechno()&&ne.rules.typeImmune&&ne.owner===ge&&ne.name===de.name)&&(ne!==de||de.rules.damageSelf)&&this.canDamage(ne,se,G)&&(!ne.isOverlay()||!(!V&&.1<Math.abs(ne.tileElevation-L)||V===K.CollisionType.OnBridge&&!ne.isBridge()))){let P=ne.isBuilding()?se===I?0:be.distance3(se,U)/Q.Coords.LEPTONS_PER_TILE:ne.isTerrain()||ne.isOverlay()?be.distance3(se,I)/Q.Coords.LEPTONS_PER_TILE:be.distance3(ne,U)/Q.Coords.LEPTONS_PER_TILE;if(fe&&ne.isAircraft()&&ne.zone===_.ZoneType.Air&&(P/=2),P<.001&&(P=0),!(pe&&ne.isInfantry()&&ge)||ne.owner!==ge&&!g.alliances.areAllied(ne.owner,ge)){if(!fe)if(ne.isTerrain()){if(se!==I||!this.rules.wall)continue}else if(!pe&&(se!==I||!ne.isBuilding()&&ne!==(W.obj||W.getBridge())))continue;fe&&P>fe||(Te.add(ne),ve.set(ne,ne.isBuilding()?(ve.get(ne)||[]).concat(P):[P]))}}let we,Ee=!1;for(le of Te)if(!le.isDestroyed&&!le.isCrashing){let I=this.computeDamage(P,le,g,me);if(0<P&&!this.rules.affectsAllies&&le.isTechno()&&ge&&(g.alliances.areAllied(le.owner,ge)||le.owner===ge)&&(I=0),I)for(var Ce of ve.get(le)){let P=I;if(0<fe&&Number.isFinite(P)&&(P=Y.lerp(P,ye*P,Ce/fe)),Math.abs(P)<1&&(!fe||.25<=P/I)&&(P=+Math.sign(P)),P=0<P?Math.floor(P):Math.ceil(P),P){let L=le.healthTrait;if(P<0){if(!de)throw new Error("Expected healer object to be set");if(L.healBy(-P,de,g),100===L.health)break}else{if(le===W.obj&&Ce<1&&(we=le),this.rules.causesDelayKill&&le.isBuilding()&&le.delayedKillTrait&&(P>=(ce=le.healthTrait.getHitPoints())&&(P=ce-1,le.delayedKillTrait.isActive()||(ce=this.rules.delayKillAtMax,he=this.rules.delayKillFrames,he=Y.lerp(he,ce*he,Ce/fe),le.delayedKillTrait.activate(he,z)))),this.inflictDamage(P,le,z,g,!we))break;le.isVehicle()&&this.rules.rocker&&0<(Ce=Y.clamp(I/300,0,1))&&(he=Z.FacingUtil.fromMapCoords(le.position.getMapPosition().clone().sub(Q.Coords.vecWorldToGround(U)))-le.direction,le.applyRocking(he,Ce))}}}else le.isTechno()&&le.invulnerableTrait.isActive()&&(Ee=!0)}if((ue=ue.rules.radLevel)&&fe&&g.mapRadiationTrait.createRadSite(I,ue,fe+1),ue=re?void 0:Ee?g.rules.audioVisual.weaponNullifyAnim:this.pickExplodeAnim(P,we,G,g,me),!Ee&&G===_.ZoneType.Ground){let P=new ae.AnimTerrainEffect;ue&&P.destroyOre(ue,I,g),ee&&P.spawnSmudges(ee,I,g),ue&&P.spawnSmudges(ue,I,g)}g.events.dispatch(new J.WarheadDetonateEvent(this,U,ue,me))}pickExplodeAnim(g,P,I,L,U){if(g){if(U)return L.rules.audioVisual.weatherConBoltExplosion;if(this.rules.conventional&&I===_.ZoneType.Water&&(!P||P.isBuilding()||P.isVehicle()&&P.submergibleTrait)){var G=L.rules.combatDamage.splashList;return G[Y.clamp(Math.floor(g/50),0,G.length-1)]}let V;return(G=this.rules.animList.length)?(V=L.rules.combatDamage.c4Warhead===this.rules.name?G-1:this.rules.emEffect?L.generateRandomInt(0,G-1):Y.clamp(Math.floor(g/25),0,G-1),this.rules.animList[V]):void 0}}}),le.SPECIAL_WARHEAD_NAME="Special",le.HE_WARHEAD_NAME="HE"}}}),System.register("game/Weapon",["game/Warhead","game/art/FlhCoords","game/event/WeaponFireEvent","game/math/geometry","game/rules/ObjectRules","game/Coords","engine/type/ObjectType","game/WeaponTargeting","game/WeaponType","game/math/Vector2","game/math/Vector3"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g}],execute:function(){g("Weapon",Q=class S{static factory(g,P,_,U,G){var V=U.getWeapon(g);let W=V.warhead;W===I.Warhead.SPECIAL_WARHEAD_NAME&&(W=S.findSpecialWarheadName(V,_,U));var K=new I.Warhead(U.getWarhead(W)),q=U.getProjectile(V.projectile),$=new z.WeaponTargeting(P,q,V,K.rules,_,U.general);return new this(P,_,V,K,q,G||new L.FlhCoords,$)}static findSpecialWarheadName(g,P,I){let L;if(!g.spawner)throw new Error(`Weapon "${g.name} can't use "Special" warhead without Spawner=yes`);if(P.rules.spawns===I.general.v3Rocket.type)L=I.combatDamage.v3Warhead;else if(P.rules.spawns===I.general.dMisl.type)L=I.combatDamage.dMislWarhead;else{if(!P.rules.spawns)throw new Error(`Can't use "Special" warhead on unit type "${P.name}" without "Spawns"`);var _=I.getObject(P.rules.spawns,W.ObjectType.Aircraft);if(!_.primary)throw new Error(`Spawned unit "${_.name}" doesn't have a primary weapon`);L=I.getWeapon(_.primary).warhead}return L}static computeSpeed(g,P){return P.arcing?.75*G.ObjectRules.iniSpeedToLeptonsPerTick(50,100):!P.rot||P.inviso||g.isLaser||g.isElectricBolt?Number.POSITIVE_INFINITY:g.speed}constructor(g,P,I,L,_,U,G){this.type=g,this.gameObject=P,this.rules=I,this.warhead=L,this.projectileRules=_,this.flh=U,this.targeting=G,this.cooldownTicks=0,this.burstsLeft=0,this.burstIndex=0,this.useBurstDelay=!1,this.lateralMuzzleMult=1,this.distributedFireAngle=P.rules.distributedFire&&P.rules.radialFireSegments?-90:0}get name(){return this.rules.name}get minRange(){return this.rules.minimumRange}get range(){return this.gameObject.isBuilding()&&!this.gameObject.overpoweredTrait&&this.type===K.WeaponType.Secondary&&this.gameObject.primaryWeapon?Math.min(this.gameObject.primaryWeapon.rules.range,this.rules.range):this.rules.range}get speed(){return S.computeSpeed(this.rules,this.projectileRules)}get rof(){let g=this.rules.rof;return this.gameObject.isBuilding()&&this.gameObject.garrisonTrait?.isOccupied()&&(g/=this.gameObject.garrisonTrait.units.length),this.gameObject.veteranTrait&&(g*=this.gameObject.veteranTrait.getVeteranRofMultiplier()),Math.floor(g)}getCooldownTicks(){return this.cooldownTicks}expireCooldown(){this.cooldownTicks=0}resetCooldown(){this.cooldownTicks=this.rof}hasBurstsLeft(){return 0<this.burstsLeft}resetBursts(){this.burstsLeft=0,this.burstIndex=0,this.resetCooldown(),this.gameObject.ammoTrait&&0<this.gameObject.ammoTrait.ammo&&this.gameObject.ammoTrait.ammo--}tick(){0<this.cooldownTicks&&this.cooldownTicks--}getBurstsFired(){return this.burstIndex}fire(g,P,I=1){let L,G=this.gameObject,W=0;if(!G.airSpawnTrait||!this.rules.spawner||(L=G.airSpawnTrait.prepareLaunch(G,g,P),W=G.airSpawnTrait.availableSpawns,L)){this.burstsLeft?(this.burstsLeft--,this.burstIndex++,this.lateralMuzzleMult*=-1):(this.useBurstDelay=!1,this.burstIndex=0,L?this.burstsLeft=W:this.gameObject.isAircraft()?this.burstsLeft=this.projectileRules.iniRot<=1?4:this.gameObject.rules.fighter?0:1:(this.burstsLeft=this.rules.burst-1,this.useBurstDelay=!0),this.lateralMuzzleMult=1),0<this.burstsLeft&&(L&&0<W?this.cooldownTicks=this.rules.iniSpeed:this.gameObject.isAircraft()?this.cooldownTicks=this.rules.rof:this.cooldownTicks=this.useBurstDelay&&void 0!==this.gameObject.rules.burstDelay[this.burstIndex]?this.gameObject.rules.burstDelay[this.burstIndex]:P.generateRandomInt(3,5)),this.burstsLeft||this.resetBursts(),this.rules.limboLaunch&&(P.limboObject(this.gameObject,{selected:P.getUnitSelection().isSelected(this.gameObject),controlGroup:P.getUnitSelection().getOrCreateSelectionModel(this.gameObject).getControlGroupNumber()}),this.warhead.rules.parasite&&(g.obj?.isVehicle()||g.obj?.isAircraft())&&g.obj.parasiteableTrait&&(g.obj.parasiteableTrait.beingBoarded=!0));let Y=L??P.createProjectile(this.projectileRules.name,this.gameObject,this,g,!1);Y.isAircraft()||(Y.baseDamageMultiplier=I*(this.gameObject.isUnit()?this.gameObject.crateBonuses.firepower:1));let Z=this.flh.clone();Z.lateral*=this.lateralMuzzleMult;var z=G.position.getMapPosition();if(P.map.isWithinHardBounds(z)){Y.position.moveToLeptons(z),Y.position.tileElevation=G.position.tileElevation;let I=new q.Vector2(Z.lateral,Z.forward);var K=this.getMuzzleFacing()+this.distributedFireAngle;I=U.rotateVec2(I,K),z=new q.Vector2(0,G.art.turretOffset),z=U.rotateVec2(z,G.direction),I.add(z),G.rules.radialFireSegments&&G.rules.distributedFire&&(z=Math.floor(180/G.rules.radialFireSegments),this.distributedFireAngle=(this.distributedFireAngle+z+90)%180-90),Y.direction=K,G.isBuilding()&&G.rules.turretAnim&&(Q=V.Coords.screenDistanceToWorld(G.rules.turretAnimX,G.rules.turretAnimY),K=G.getFoundationCenterOffset(),Y.position.moveByLeptons(-K.x+Q.x,-K.y+Q.y));let L=new $.Vector3(I.x,Z.vertical,-I.y);var Q=L.clone().add(Y.position.worldPosition);if(P.map.isWithinHardBounds(Q)&&Y.position.moveByLeptons3(L),Y.tileElevation<0&&(Y.position.tileElevation=0),Y.isAircraft()?P.unlimboObject(Y,Y.position.tile):P.spawnObject(Y,Y.position.tile),this.rules.revealOnFire&&g.obj?.isTechno()){let I=P.mapShroudTrait.getPlayerShroud(g.obj.owner);I?.isShrouded(G.tile,G.tileElevation)&&I.revealTemporarily(G)}this.rules.decloakToFire&&this.gameObject.cloakableTrait?.uncloak(P),P.events.dispatch(new _.WeaponFireEvent(this,this.gameObject))}else L&&(L.owner.removeOwnedObject(L),L.dispose())}}getMuzzleFacing(){let g,P=this.gameObject;return g=P.isInfantry()||P.isAircraft()||!P.isBuilding()&&!P.isVehicle()||!P.turretTrait?P.direction:P.turretTrait.facing,g}}),Q.NUKE_PAYLOAD_NAME="NukePayload"}}}),System.register("game/WeaponInfo",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("game/WeaponTargeting",["game/gameobject/infantry/StanceType","game/gameobject/unit/ZoneType","game/type/LandTargeting","game/type/LandType","game/type/NavalTargeting","game/type/SpeedType","game/WeaponType"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g}],execute:function(){g("WeaponTargeting",class{constructor(g,P,I,L,_,U){this.weaponType=g,this.projectileRules=P,this.weaponRules=I,this.warheadRules=L,this.gameObject=_,this.generalRules=U,this.targetChecks=[],this.initConditions()}initConditions(){this.projectileRules.isAntiGround||this.targetChecks.push(g=>!!g);const g=this.generalRules.prism.type;this.gameObject.name===g&&this.weaponType===W.WeaponType.Secondary?this.targetChecks.push((P,I,L,_,U)=>!(!U||!P?.isBuilding()||P.name!==g||P.owner!==this.gameObject.owner)):this.warheadRules.electricAssault?this.targetChecks.push((g,P,I,L,_)=>!(!L&&!_||!g?.isBuilding()||!g.overpoweredTrait||g.owner!==this.gameObject.owner)):this.weaponRules.damage<0?this.targetChecks.push((g,P,I)=>!!(g!==this.gameObject&&g?.isUnit()&&I.areFriendly(g,this.gameObject)&&g.healthTrait.health<100&&this.gameObject.isAircraft()===g.isAircraft())):(this.gameObject.rules.attackCursorOnFriendlies||this.warheadRules.bombDisarm?this.targetChecks.push((g,P,I,L,_)=>!_&&!!(!this.warheadRules.bombDisarm||g?.isTechno()&&g.tntChargeTrait?.hasCharge())):this.targetChecks.push((g,P,I,L)=>!((!L||this.warheadRules.mindControl)&&g?.isTechno()&&I.areFriendly(g,this.gameObject))),this.targetChecks.push((g,P,I)=>!(g?.isTechno()&&g.cloakableTrait?.isCloaked()&&!I.alliances.haveSharedIntel(this.gameObject.owner,g.owner))),this.weaponRules.limboLaunch&&this.targetChecks.push((g,P,I,L,_)=>!(_&&g&&(g.isVehicle()||g.isAircraft())&&g.parasiteableTrait?.isInfested())),this.warheadRules.ivanBomb&&this.targetChecks.push(g=>!(!g?.isTechno()||!g.tntChargeTrait||g.tntChargeTrait.hasCharge())),this.warheadRules.parasite&&this.targetChecks.push((g,P,I,L)=>!!(!g&&L||g?.isInfantry()||(g?.isVehicle()||g?.isAircraft())&&g.parasiteableTrait)),this.warheadRules.mindControl&&this.targetChecks.push(g=>!(!g?.isTechno()||!g.mindControllableTrait)),this.warheadRules.temporal||this.targetChecks.push((g,P,I,L,_)=>!(_&&g?.isTechno()&&g.warpedOutTrait.isInvulnerable())),this.gameObject.rules.natural&&this.targetChecks.push(g=>!g?.isTechno()||!g.rules.unnatural)),this.targetChecks.push((g,P)=>this.canTargetZone(g,P))}canTarget(g,P,I,L,_){return this.targetChecks.every(U=>U(g,P,I,L,_))}canTargetZone(g,P){let _;if(g?.isUnit()){if(g?.isInfantry()&&g.stance===I.StanceType.Paradrop&&2<g.tileElevation)return this.projectileRules.isAntiAir&&(this.projectileRules.isAntiGround||this.weaponType===W.WeaponType.Secondary);if(g.zone===L.ZoneType.Air)return this.projectileRules.isAntiAir;if(this.weaponType===W.WeaponType.Secondary&&this.projectileRules.isAntiAir&&!this.projectileRules.isAntiGround)return!1;_=g.zone}else _=P.landType===U.LandType.Water?L.ZoneType.Water:L.ZoneType.Ground;return _===L.ZoneType.Water?this.canTargetNaval(this.gameObject.rules.navalTargeting,this.gameObject,g,this.weaponType):this.canTargetLand(this.gameObject.rules.landTargeting,this.weaponType)}canTargetLand(g,P){switch(g){case _.LandTargeting.LandOk:return!0;case _.LandTargeting.LandNotOk:return!1;case _.LandTargeting.LandSecondary:return P===W.WeaponType.Secondary;default:throw new Error(`Unhandled LandTargeting value "${g}"`)}}canTargetNaval(g,P,I,L){switch(g){case G.NavalTargeting.UnderwaterNever:return!I||!(I.isVehicle()&&I.submergibleTrait?.isSubmerged());case G.NavalTargeting.UnderwaterSecondary:return I&&I.isVehicle()&&I.submergibleTrait&&!P.rules.spawned?L===W.WeaponType.Secondary:L===W.WeaponType.Primary;case G.NavalTargeting.UnderwaterOnly:return!!(I&&I.isVehicle()&&I.submergibleTrait);case G.NavalTargeting.OrganicSecondary:return I?.isTechno()&&I.rules.organic?L===W.WeaponType.Secondary:L===W.WeaponType.Primary;case G.NavalTargeting.SealSpecial:return I?.isTechno()&&I.rules.naval&&!I.rules.organic&&(I.isBuilding()||I.rules.speedType===V.SpeedType.Float)?L===W.WeaponType.Secondary:L===W.WeaponType.Primary;case G.NavalTargeting.NavalAll:return!0;case G.NavalTargeting.NavalNone:return!1;default:throw new Error(`Unhandled NavalTargeting value "${g}"`)}}})}}}),System.register("game/WeaponType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("WeaponType",I={}))[P.Primary=0]="Primary",P[P.Secondary=1]="Secondary",P[P.DeathWeapon=2]="DeathWeapon"}}}),System.register("game/World",["util/event"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("World",class{constructor(){this.allObjects=new Map,this._onObjectSpawned=new I.EventDispatcher,this._onObjectRemoved=new I.EventDispatcher}get onObjectSpawned(){return this._onObjectSpawned.asEvent()}get onObjectRemoved(){return this._onObjectRemoved.asEvent()}spawnObject(g){if(this.allObjects.has(g.id))throw new Error("Trying to add an already existing object");this.allObjects.set(g.id,g),this._onObjectSpawned.dispatch(this,g)}removeObject(g){if(!this.allObjects.has(g.id))throw new Error("Trying to remove non-existent object");this.allObjects.delete(g.id),this._onObjectRemoved.dispatch(this,g)}hasObjectId(g){return this.allObjects.has(g)}getObjectById(g){if(!this.allObjects.has(g))throw new Error(`Object with id ${g} doesn't exist`);return this.allObjects.get(g)}getAllObjects(){return[...this.allObjects.values()]}})}}}),System.register("Gui",["react","engine/Engine","engine/EngineType","gui/UiScene","engine/gfx/Renderer","game/rules/Rules","gui/screen/RootController","gui/screen/mainMenu/MainMenuRootScreen","gui/screen/game/GameScreen","gui/screen/game/gameMenu/ScreenType","gui/screen/mainMenu/ScreenType","gui/screen/ScreenType","gui/component/MessageBoxApi","network/WolConnection","network/GservConnection","network/gameopt/Parser","network/gameopt/Serializer","engine/ResourceLoader","ErrorHandler","engine/UiAnimationLoop","util/Logger","tools/DevToolsApi","gui/jsx/JsxRenderer","gui/Pointer","engine/sound/Sound","engine/sound/AudioSystem","engine/sound/Mixer","engine/sound/SoundSpecs","engine/sound/ChannelType","LocalPrefs","gui/screen/game/worldInteraction/keyboard/KeyBinds","gui/ReplayManager","gui/screen/replay/ReplayScreen","data/vfs/FileNotFoundError","engine/sound/Music","engine/sound/MusicSpecs","gui/screen/game/GameLoader","util/BoxedVar","engine/renderable/builder/vxlGeometry/VxlGeometryPool","engine/gfx/geometry/VxlGeometryCache","engine/gfx/RendererError","gui/replay/ReplayStorageFileSystem","gui/replay/ReplayStorageMemStorage","network/gamestate/Replay","data/vfs/StorageQuotaError","gui/CanvasMetrics","data/vfs/IOError","util/disposable/CompositeDisposable","gui/component/ToastApi","network/WolService","gui/screen/mainMenu/main/HomeScreen","gui/screen/mainMenu/lobby/SkirmishScreen","gui/screen/mainMenu/login/LoginScreen","gui/screen/mainMenu/newAccount/NewAccountScreen","gui/screen/mainMenu/customGame/CustomGameScreen","gui/screen/mainMenu/lobby/LobbyScreen","gui/screen/mainMenu/mapSel/MapSelScreen","gui/screen/replay/ReplaySelScreen","gui/screen/mainMenu/score/ScoreScreen","gui/screen/mainMenu/infoAndCredits/InfoAndCreditsScreen","gui/screen/mainMenu/credits/CreditsScreen","gui/screen/options/OptionsScreen","gui/screen/options/SoundOptsScreen","gui/screen/options/KeyboardScreen","gui/screen/options/StorageScreen","gui/screen/mainMenu/patchNotes/PatchNotesScreen","gui/screen/game/gameMenu/GameMenuHomeScreen","gui/screen/game/gameMenu/DiploScreen","gui/screen/game/gameMenu/ConnectionInfoScreen","gui/screen/game/gameMenu/QuitConfirmScreen","gui/screen/game/loadingScreen/LoadingScreenApiFactory","gui/screen/game/MapFileLoader","gui/screen/mainMenu/modSel/ModSelScreen","gui/screen/mainMenu/modSel/ModManager","gui/screen/mainMenu/quickGame/QuickGameScreen","network/ladder/WLadderService","gui/screen/mainMenu/ladder/LadderScreen","network/WolConfig","gui/screen/mainMenu/ladderRules/LadderRulesScreen","ClientApi","network/WGameResService","network/MapTransferService","engine/sound/RemoteMusicProvider","util/string","RouteHelper"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be,Se,we,Ee,Ce,xe,Oe,Ae,Me,Re,Pe,Ie,ke,Be,Ne,Le,je,De,Fe,_e,Ue,He,Ge,Ve,We,ze,Ke,qe,$e,Qe,Ye,Ze,Xe,Je,et,tt,it,rt,st,at,nt,ot,lt,ct,ht,ut,dt,gt,pt,mt;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g},function(g){ce=g},function(g){he=g},function(g){ue=g},function(g){de=g},function(g){ge=g},function(g){pe=g},function(g){me=g},function(g){fe=g},function(g){ye=g},function(g){Te=g},function(g){ve=g},function(g){be=g},function(g){Se=g},function(g){we=g},function(g){Ee=g},function(g){Ce=g},function(g){xe=g},function(g){Oe=g},function(g){Ae=g},function(g){Me=g},function(g){Re=g},function(g){Pe=g},function(g){Ie=g},function(g){ke=g},function(g){Be=g},function(g){Ne=g},function(g){Le=g},function(g){je=g},function(g){De=g},function(g){Fe=g},function(g){_e=g},function(g){Ue=g},function(g){He=g},function(g){Ge=g},function(g){Ve=g},function(g){We=g},function(g){ze=g},function(g){Ke=g},function(g){qe=g},function(g){$e=g},function(g){Qe=g},function(g){Ye=g},function(g){Ze=g},function(g){Xe=g},function(g){Je=g},function(g){et=g},function(g){tt=g},function(g){it=g},function(g){rt=g},function(g){st=g},function(g){at=g},function(g){nt=g},function(g){ot=g},function(g){lt=g},function(g){ct=g},function(g){ht=g},function(g){ut=g},function(g){dt=g},function(g){gt=g},function(g){pt=g},function(g){mt=g}],execute:function(){g("Gui",class{constructor(g,P,I,L,_,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te){this.appVersion=g,this.appLocale=P,this.engineVersion=I,this.engineModHash=L,this.gpuTier=_,this.config=G,this.gameResConfig=V,this.appResPath=W,this.localPrefs=z,this.generalOptions=K,this.rootEl=q,this.viewport=$,this.fullScreen=Q,this.strings=Y,this.cdnResourceLoader=Z,this.fsAccessLib=X,this.serverRegions=J,this.runtimeVars=ee,this.sentry=te,this.disposables=new ke.CompositeDisposable,this.handleFullScreenChange=g=>{g&&this.pointer?.getUserLockMode()&&this.pointer.lock()},this.handleViewportChange=g=>{var P;this.renderer?.setViewportSize(g.width,g.height),this.uiScene&&(P=U.UiScene.createCamera(this.viewport.value),this.uiScene.setCamera(P),this.uiScene.setViewport(this.viewport.value),this.jsxRenderer?.setCamera(P),this.messageBoxApi?.updateViewport(this.viewport.value),this.rootController?.rerenderCurrentScreen(),this.canvasMetrics?.notifyViewportChange())}}getRootController(){if(!this.rootController)throw new Error("Root controller is not initialized");return this.rootController}async init(g){let P,I,G=this.strings;try{({renderer:P,uiAnimationLoop:I}=this.initRenderer(this.rootEl,this.viewport.value,this.config.devMode))}catch(g){if(g instanceof xe.RendererError)return console.error(g.cause),void alert(G.get("TS:RendererInitError"));throw g}this.renderer=P,this.viewport.onChange.subscribe(this.handleViewportChange),this.disposables.add(()=>this.viewport.onChange.unsubscribe(this.handleViewportChange)),this.fullScreen.onChange.subscribe(this.handleFullScreenChange),this.disposables.add(()=>this.fullScreen.onChange.unsubscribe(this.handleFullScreenChange));var se=this.gameResConfig;let ne=U.UiScene.factory(this.viewport.value),ce=this.canvasMetrics=new Pe.CanvasMetrics(P.getCanvas(),window);ce.init(),this.disposables.add(ce);let he=this.pointer=le.Pointer.factory(L.Engine.getImages().get(L.Engine.getActiveEngine()===_.EngineType.YurisRevenge?"mouse.sha":"mouse.shp"),L.Engine.getPalettes().get("mousepal.pal"),P,document,ce,this.generalOptions.mouseAcceleration);he.init(),this.disposables.add(he),ne.add(he.getSprite());var ue=this.jsxRenderer=new oe.JsxRenderer(L.Engine.getImages(),L.Engine.getPalettes(),ne.camera,he.pointerEvents);this.toastApi=new Be.ToastApi(this.viewport,ne,ue),this.disposables.add(this.toastApi),this.messageBoxApi=new Y.MessageBoxApi(this.viewport.value,ne,ue);var de=new re.ErrorHandler(this.messageBoxApi,G),ge=new J.Parser,ve=new ee.Serializer;let be=this.rootController=new W.RootController(this.serverRegions);var Me=L.Engine.getMpModes(),ke=L.Engine.getFileNameVariant("keyboard.ini");let gt=new me.KeyBinds(L.Engine.rfs?.getRootDirectory(),ke,L.Engine.getIni(ke));await gt.load();var pt=await L.Engine.getReplayDir().catch(g=>{console.error("Couldn't get replay directory",[g]),g instanceof Re.StorageQuotaError||g instanceof Ie.IOError||g instanceof Te.FileNotFoundError||this.sentry?.captureException(new Error(`Couldn't get replay directory (${g.name})`,{cause:g}))}),mt=pt?new Oe.ReplayStorageFileSystem(pt,this.sentry):new Ae.ReplayStorageMemStorage,ft=new fe.ReplayManager(mt);let yt=this.generalOptions;var Tt=new te.ResourceLoader(this.config.mapsBaseUrl),vt=new te.ResourceLoader(this.appResPath),bt=new te.ResourceLoader(this.config.modsBaseUrl),St=new it.MapFileLoader(Tt,L.Engine.vfs),wt=ae.AppLogger.get("wol"),Et=lt.WolConfig.factory(lt.ClientType.Cdral2),Ct=Z.WolConnection.factory(wt);let xt=new Ne.WolService(Et,Ct,this.appVersion,this.appLocale);xt.init(),this.disposables.add(xt);var Ot=new nt.WLadderService(Et),At=new ut.WGameResService(xt,Et),Mt=new dt.MapTransferService(xt),Rt=ae.AppLogger.get("gserv"),Pt=X.GservConnection.factory(Rt),It=L.Engine.getMapList(),kt=await L.Engine.getModDir().catch(g=>{console.error("Couldn't get mods directory",[g]),g instanceof Re.StorageQuotaError||g instanceof Ie.IOError||g instanceof Te.FileNotFoundError||this.sentry?.captureException(new Error(`Couldn't get mods directory (${g.name})`,{cause:g}))});let Bt=kt?new st.ModManager(window.location,kt,vt):void 0;var Nt=L.Engine.getActiveMod();ke=Nt?await(Bt?.loadModMeta(Nt)):void 0,pt=await L.Engine.getMapDir().catch(g=>{console.error("Couldn't get map dir",[g])}),mt=ae.AppLogger.get("ini");let Lt;try{Lt=new V.Rules(L.Engine.getRules(),mt)}catch(g){if(Nt&&Bt)return console.error(g),P.addScene(ne),this.uiScene=ne,this.rootEl.appendChild(ne.getHtmlContainer().getElement()),await this.messageBoxApi.alert(G.get("TS:ModLoadError"),G.get("GUI:Ok")),void Bt.loadMod(void 0);throw g}var{mixer:Tt,sound:Et,music:Rt}=await this.initSound(Lt,se);let jt=(new Map).set($.ScreenType.Home,new Le.HomeScreen(G,this.fullScreen,this.appVersion,!(!L.Engine.rfs||!kt),!L.Engine.getActiveMod()&&this.config.quickMatchEnabled)).set($.ScreenType.Skirmish,new je.SkirmishScreen(be,de,this.messageBoxApi,G,Lt,ue,St,It,Me,this.localPrefs)).set($.ScreenType.Login,new De.LoginScreen(xt,Ot,At,Mt,G,ue,this.messageBoxApi,this.serverRegions,this.config.serversUrl,this.config.breakingNewsUrl,wt,de,this.localPrefs,be,this.config.devMode)).set($.ScreenType.NewAccount,new Fe.NewAccountScreen(this.appLocale,G,ue,this.messageBoxApi,this.serverRegions,de,this.localPrefs)).set($.ScreenType.QuickGame,new at.QuickGameScreen(this.config.unrankedQueueEnabled,this.engineVersion,this.engineModHash,this.appLocale,Lt,xt,Ct,Ot,this.serverRegions,be,this.messageBoxApi,ne,ue,G,this.localPrefs,Et,de)).set($.ScreenType.Ladder,new ot.LadderScreen(Ot,ue,de,this.messageBoxApi,this.serverRegions,G,this.appLocale)).set($.ScreenType.CustomGame,new _e.CustomGameScreen(this.engineModHash,G,Ct,xt,Ot,ue,Et,this.serverRegions,It,de)).set($.ScreenType.Lobby,new Ue.LobbyScreen(this.config.botsEnabled,this.engineModHash,ke,be,de,this.messageBoxApi,G,ne,Ct,xt,Ot,Mt,Pt,Lt,ge,ve,ue,St,It,Me,Et,this.localPrefs)).set($.ScreenType.MapSelection,new He.MapSelScreen(G,ue,St,de,this.messageBoxApi,this.localPrefs,It,Me,pt,this.fsAccessLib,this.sentry)).set($.ScreenType.ReplaySelection,new Ge.ReplaySelScreen(this.engineVersion,this.engineModHash,Nt,this.config.oldClientsBaseUrl,be,G,ue,de,this.messageBoxApi,ft,ne,Lt,this.sentry)).set($.ScreenType.Score,new Ve.ScoreScreen(G,ue,this.messageBoxApi,this.localPrefs,this.config,xt)).set($.ScreenType.InfoAndCredits,new We.InfoAndCreditsScreen(G,this.config,this.messageBoxApi)).set($.ScreenType.Credits,new ze.CreditsScreen(G,ue)).set($.ScreenType.Options,new Ke.OptionsScreen(G,ue,yt,this.localPrefs,this.fullScreen,!1,!!L.Engine.rfs)).set($.ScreenType.OptionsSound,new qe.SoundOptsScreen(G,ue,Tt,void 0,this.localPrefs)).set($.ScreenType.OptionsKeyboard,new $e.KeyboardScreen(G,ue,gt)).set($.ScreenType.OptionsStorage,new Qe.StorageScreen(G,ue,this.messageBoxApi,L.Engine.rfs));Bt&&jt.set($.ScreenType.ModSelection,new rt.ModSelScreen(be,G,ue,de,this.messageBoxApi,Bt,L.Engine.getActiveMod(),this.config.modSdkUrl,bt,this.fsAccessLib,this.sentry)),this.config.patchNotesUrl&&jt.set($.ScreenType.PatchNotes,new Ye.PatchNotesScreen(G,ue,this.config.patchNotesUrl)),this.config.ladderRulesUrl&&jt.set($.ScreenType.LadderRules,new ct.LadderRulesScreen(G,ue,this.config.ladderRulesUrl)),wt=await this.getMainMenuVideoUrl(se,kt),ke=new z.MainMenuRootScreen(jt,ne,se,G,L.Engine.getImages(),ue,wt,this.cdnResourceLoader,Et,Rt,this.sentry),Ct=new Ce.VxlGeometryCache(await L.Engine.getCacheDir(),L.Engine.getActiveMod());let Dt=new Ee.VxlGeometryPool(Ct,yt.graphics.models.value);yt.graphics.models.onChange.subscribe(g=>{Dt.setModelQuality(g),Dt.clear(),Dt.clearStorage().catch(g=>console.warn("Couldn't clear VXL geocache",[g]))}),Ot=window.CDWorkerHostLib,Nt=new we.BoxedVar(!1),bt=new Map,kt=ae.AppLogger.get("action"),wt=ae.AppLogger.get("lockstep"),Ct=new Se.GameLoader(this.appVersion,Ot,this.cdnResourceLoader,vt,Lt,Me,Et,mt,kt,Nt,se,Dt,bt,this.runtimeVars.debugBotIndex,this.config.devMode),vt=new Set;let Ft=new we.BoxedVar(Boolean(Number(this.localPrefs.getItem(pe.StorageKey.TauntsEnabled)??"1")));const H=g=>{this.localPrefs.setItem(pe.StorageKey.TauntsEnabled,String(Number(g)))};Ft.onChange.subscribe(H),this.disposables.add(()=>Ft.onChange.unsubscribe(H)),mt=(new Map).set(q.ScreenType.Home,new Ze.GameMenuHomeScreen(G,this.fullScreen)).set(q.ScreenType.Diplo,new Xe.DiploScreen(G,ue,P,Me,Ft,vt)).set(q.ScreenType.ConnectionInfo,new Je.ConnectionInfoScreen(G,ue)).set(q.ScreenType.QuitConfirm,new et.QuitConfirmScreen(G)).set(q.ScreenType.Options,new Ke.OptionsScreen(G,ue,yt,this.localPrefs,this.fullScreen,!0,!1)).set(q.ScreenType.OptionsSound,new qe.SoundOptsScreen(G,ue,Tt,Rt,this.localPrefs)).set(q.ScreenType.OptionsKeyboard,new $e.KeyboardScreen(G,ue,gt)),Me=new tt.LoadingScreenApiFactory(Lt,G,ne,ue,se,Pt),se=new ht.ClientApi,window.dispatchEvent(new CustomEvent("CdApiReady",{detail:se})),window.CdApi=se,Nt=new K.GameScreen(Ot,Pt,At,xt,Mt,this.engineVersion,this.engineModHash,de,mt,Me,ge,ve,this.config,G,P,ne,this.runtimeVars,this.messageBoxApi,this.toastApi,I,this.viewport,ue,he,Et,Rt,Tt,gt,yt,this.localPrefs,kt,wt,ft,this.fullScreen,St,pt,It,Ct,Dt,bt,vt,Ft,Nt,this.sentry,se.battleControl),se=new ye.ReplayScreen(this.engineVersion,this.engineModHash,de,mt,Me,this.config,G,P,ne,this.runtimeVars,this.messageBoxApi,I,this.viewport,ue,he,Et,Rt,gt,yt,kt,this.fullScreen,St,Ct,Dt,bt,()=>{void 0!==g?(window.close(),(async()=>{await this.destroy(),document.body.appendChild(document.createTextNode(G.get("GUI:ReplayWindowClose")))})()):be.goToScreen(Q.ScreenType.MainMenuRoot)},se.battleControl),be.addScreen(Q.ScreenType.MainMenuRoot,ke),be.addScreen(Q.ScreenType.Game,Nt),be.addScreen(Q.ScreenType.Replay,se),P.addScene(ne),this.uiScene=ne,this.rootEl.appendChild(ne.getHtmlContainer().getElement()),await this.routeToInitialScreen(be,yt,Rt,Et,g,ft)}async getMainMenuVideoUrl(g,P){let I,_=L.Engine.rfsSettings.menuVideoFileName;if(g.isCdn())I=g.getCdnBaseUrl()+_.replace(".webm",".mp4");else try{let g;P&&await P.containsEntry(_)&&(g=await P.getRawFile(_)),!g&&await(L.Engine.rfs?.containsEntry(_))&&(g=await L.Engine.rfs.getRawFile(_)),!g&&L.Engine.vfs?.fileExists(_)&&(g=L.Engine.vfs.openFile(_).asFile()),I=g?new File([g],g.name,{type:"video/webm"}):(console.warn("Main menu video file not found in browser FS"),"")}catch(g){console.error("Failed to read video file from browser FS"),I=""}return I}async routeToInitialScreen(g,P,L,_,U,G){let V=!1;var W=this.localPrefs.getItem(pe.StorageKey.LastConnection);let z,K;if(W)try{z=JSON.parse(W)}catch(g){console.error(`Unable to decode game params string "${W}"`)}if(z){var q=await this.messageBoxApi.confirm(this.strings.get("TS:ReconnectPrompt"),this.strings.get("TS:Reconnect"),this.strings.get("GUI:Quit"));if(V=!0,q)return z.create=!1,void g.goToScreen(Q.ScreenType.Game,z);this.localPrefs.removeItem(pe.StorageKey.LastConnection)}if(void 0!==(W=this.gpuTier)&&(q=this.localPrefs.getItem(pe.StorageKey.LastGpuTier),2<=W.tier?void 0!==q&&Number(q)!==W.tier?(await this.confirmHighGfxSettings()&&(P.graphics.applyHighPreset(),this.localPrefs.setItem(pe.StorageKey.Options,P.serialize())),V=!0):void 0===q&&W.isMobile&&(P.graphics.applyLowPreset(),this.localPrefs.setItem(pe.StorageKey.Options,P.serialize())):(void 0===q||2<=Number(q))&&(await this.confirmLowGfxSettings()&&(P.graphics.applyLowPreset(),this.localPrefs.setItem(pe.StorageKey.Options,P.serialize())),V=!0),this.localPrefs.setItem(pe.StorageKey.LastGpuTier,""+W.tier)),void 0===U&&this.config.patchNotesUrl&&((W=this.localPrefs.getItem(pe.StorageKey.LastSeenPatch))&&W!==this.appVersion&&(await new Promise(g=>this.messageBoxApi.show(I.default.createElement("iframe",{src:this.config.patchNotesUrl,className:"patch-notes"}),[{label:this.strings.get("GUI:Continue"),onClick:g}],{className:"patch-notes-box"})),V=!0),W&&W===this.appVersion||this.localPrefs.setItem(pe.StorageKey.LastSeenPatch,this.appVersion)),L&&!V&&_.audioSystem.isSuspended()&&await new Promise(g=>this.messageBoxApi.show(this.strings.get("GUI:RequestAudioPermission"),this.strings.get("GUI:OK"),async()=>{await _.audioSystem.initMusicLoop().catch(g=>console.error(g)),g()})),void 0!==U)try{if(void 0!==U.replayId){var $=(await G.loadList()).find(g=>g.id===U.replayId);if(!$)throw new Error(`Replay ID "${U.replayId}" not found`);K=await G.loadReplay($)}else{let g=new URL(U.replayUrl),P=!1;for(var Y of this.config.replaysUrlWhitelist)if(g.hostname.endsWith(Y)){P=!0;break}if(!P)throw new Error(`Can't load replay from URL "${g.href}".Domain is not within the allowed list of domains.`);var Z=await new te.ResourceLoader("").loadBinary(U.replayUrl);K=new Me.Replay,K.unserialize(pt.uint8ArrayToBinaryString(Z),{name:"untitled.rpl",timestamp:Date.now()}),K.engineVersion!==this.engineVersion&&(await this.loadReplayWithOldClient(g,K.engineVersion),K=void 0)}}catch(g){console.error("Failed to load replay",g),await this.messageBoxApi.alert(this.strings.get("GUI:ReplayError"),this.strings.get("GUI:Ok"))}K?g.goToScreen(Q.ScreenType.Replay,{replay:K}):g.goToScreen(Q.ScreenType.MainMenuRoot)}async loadReplayWithOldClient(g,P){let I;var _,U,G=this.config.oldClientsBaseUrl;if(G){this.messageBoxApi.show(this.strings.get("GUI:LoadingEx"));try{let g=new te.ResourceLoader(G);I=await g.loadJson("versions.json")}catch(g){console.warn("Couldn't download client version list",g)}finally{this.messageBoxApi.destroy()}}let V;I&&(V=I[P]),V?(_=(U=L.Engine.getActiveMod())?`?${mt.RouteHelper.modQueryStringName}=`+U:"",U=encodeURIComponent(g.href),window.location.href=`${G}v${V}/${_}#/replay/`+U):await this.messageBoxApi.alert(this.strings.get("GUI:ReplayVersionMismatch",P),this.strings.get("GUI:Ok"))}async confirmLowGfxSettings(){return await this.messageBoxApi.confirm(I.default.createElement("div",{dangerouslySetInnerHTML:{__html:this.strings.get("TS:RendererWarning").replace(/\n/g,"<br />").replace("{link}",'<a href="https://www.windowsdigitals.com/force-chrome-firefox-game-to-use-nvidia-gpu-integrated-graphics/" target="_blank" rel="noreferrer noopener">').replace("{/link}","</a>")}}),this.strings.get("TS:RendererUseLow"),this.strings.get("TS:RendererIgnore"))}async confirmHighGfxSettings(){return await this.messageBoxApi.confirm(this.strings.get("TS:RendererChangeDesc"),this.strings.get("GUI:Yes"),this.strings.get("GUI:No"))}initRenderer(g,P,I){var{width:L,height:_}=P;let U=new G.Renderer(L,_);U.init(g),this.disposables.add(U),ne.DevToolsApi.registerVar("fps",this.runtimeVars.fps),this.disposables.add(()=>ne.DevToolsApi.unregisterVar("fps")),this.runtimeVars.fps.onChange.subscribe(P=>{P?U.initStats(g):U.destroyStats()}),I&&(this.runtimeVars.fps.value=!0),this.runtimeVars.fps.value&&U.initStats(g);let V=new se.UiAnimationLoop(U);return V.start(),this.disposables.add(V),g.addEventListener("contextmenu",g=>{"A"===g.target.nodeName&&g.target.href.length||g.preventDefault()}),I||window.addEventListener("beforeunload",g=>{this.rootController?.getCurrentScreen()?.preventUnload&&(g.preventDefault(),g.returnValue="")}),U.getCanvas().addEventListener("mousedown",g=>{g.preventDefault()}),{renderer:U,uiAnimationLoop:V}}async initSound(g,P){let I;var _=this.localPrefs.getItem(pe.StorageKey.Mixer);if(_)try{I=(new ue.Mixer).unserialize(_)}catch(g){console.warn("Failed to read mixer values from local storage",[g])}I||(I=new ue.Mixer,I.setVolume(ge.ChannelType.Master,.4),I.setVolume(ge.ChannelType.CreditTicks,.2),I.setVolume(ge.ChannelType.Music,.3),I.setVolume(ge.ChannelType.Ambient,.3));let U,G,V=new ce.Sound(new he.AudioSystem(I),L.Engine.getSounds(),new de.SoundSpecs(L.Engine.getSoundIni()),g.audioVisual,document);V.initialize(),this.disposables.add(V);try{U=!!await(L.Engine.rfs?.containsEntry(L.Engine.rfsSettings.musicDir))}catch(g){console.error("Couldn't get music directory",[g]),g instanceof Re.StorageQuotaError||g instanceof Ie.IOError||g instanceof Te.FileNotFoundError||this.sentry?.captureException(new Error(`Couldn't get music directory (${g.name})`,{cause:g})),U=!1}const W=!!this.gameResConfig?.isCdn?.()&&!!this.config.musicBaseUrl;if(U||W){let P=L.Engine.getThemes();if(W&&(P=new gt.FallbackMusicProvider(P,new gt.RemoteMusicProvider(this.config.musicBaseUrl))),G=new ve.Music(V.audioSystem,P,new be.MusicSpecs(L.Engine.getIni(L.Engine.getFileNameVariant("theme.ini")))),this.disposables.add(G),_=this.localPrefs.getItem(pe.StorageKey.MusicOpts))try{G.unserializeOptions(_)}catch(g){console.warn("Failed to read music options from local storage",[g])}}return{mixer:I,sound:V,music:G}}async destroy(){var g;this.messageBoxApi&&(this.messageBoxApi.destroy(),this.messageBoxApi=void 0),this.rootController&&(await this.rootController.leaveCurrentScreen(),this.rootController.destroy()),this.uiScene&&((g=this.uiScene.getHtmlContainer()?.getElement())&&this.rootEl.removeChild(g),this.uiScene.destroy()),this.disposables.dispose()}})}}}),System.register("gui/CanvasMetrics",["util/disposable/CompositeDisposable","util/dom"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g},function(g){0}],execute:function(){g("CanvasMetrics",class{constructor(g,P){this.canvas=g,this.window=P,this.x=0,this.y=0,this.width=0,this.height=0,this.cssWidth=0,this.cssHeight=0,this.scaleX=1,this.scaleY=1,this.disposables=new I.CompositeDisposable,this.updateCanvasBoxMetrics=()=>{var g=this.canvas.getBoundingClientRect();this.x=g.left+(this.window.scrollX||0),this.y=g.top+(this.window.scrollY||0),this.width=this.canvas.width,this.height=this.canvas.height,this.cssWidth=g.width,this.cssHeight=g.height,this.scaleX=this.cssWidth?this.width/this.cssWidth:1,this.scaleY=this.cssHeight?this.height/this.cssHeight:1}}init(){this.updateCanvasBoxMetrics(),this.window.addEventListener("resize",this.updateCanvasBoxMetrics),this.disposables.add(()=>this.window.removeEventListener("resize",this.updateCanvasBoxMetrics))}notifyViewportChange(){this.updateCanvasBoxMetrics()}dispose(){this.disposables.dispose()}})}}}),System.register("gui/chat/ChatHistory",["network/chat/ChatMessage","network/gservConfig","util/BoxedVar","util/event"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("ChatHistory",class{constructor(){this.lastWhisperFrom=new _.BoxedVar(void 0),this.lastWhisperTo=new _.BoxedVar(void 0),this.lastComposeTarget=new _.BoxedVar({type:I.ChatRecipientType.Channel,name:L.RECIPIENT_ALL}),this.messages=[],this._onNewMessage=new U.EventDispatcher}get onNewMessage(){return this._onNewMessage.asEvent()}addChatMessage(g){this.messages.push(g),this._onNewMessage.dispatch(this,g)}getAll(){return this.messages}})}}}),System.register("gui/chat/ChatMessageFormat",["react","network/chat/ChatMessage","network/gservConfig","gui/ReactFormat"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("ChatMessageFormat",class{constructor(g,P,I){this.strings=g,this.localUsername=P,this.userColors=I}formatPrefixPlain(g){let P;if(g.to.type===L.ChatRecipientType.Channel)P=g.to.name===_.RECIPIENT_TEAM?this.strings.get("TS:ChatFromAllies",g.from):this.strings.get("TS:ChatFrom",g.from);else if(g.to.type===L.ChatRecipientType.Page)P=this.strings.get("TS:PageFrom",g.from);else{if(g.to.type!==L.ChatRecipientType.Whisper)throw new Error("Unknown message type "+g.to.type);P=g.from===this.localUsername?this.strings.get("TS:To",g.to.name):this.strings.get("TXT_FROM",g.from)}return P}formatPrefixHtml(g,P){let U,G=g.to.type===L.ChatRecipientType.Whisper&&g.from===this.localUsername?g.to.name:g.from,V=G;var W,z="{user}";let K;if(g.to.type!==L.ChatRecipientType.Page&&(void 0!==(W=this.userColors?.get(g.from))&&(V=I.default.createElement("span",{style:{color:W}},V)),P&&(q=this.strings.get("TS:ChatUserLink",z).split(z),V=I.default.createElement("span",{className:"user-link",onClick:()=>P(G)},q[0],V,q[1])),U=this.strings.get("TS:ChatTimestamp",g.time.toLocaleTimeString(void 0,{timeStyle:"short"}))+" "),g.to.type===L.ChatRecipientType.Channel)K=g.to.name===_.RECIPIENT_TEAM?this.strings.get("TS:ChatFromAllies",z):this.strings.get("TS:ChatFrom",z);else if(g.to.type===L.ChatRecipientType.Page)K=this.strings.get("TS:PageFrom",z);else{if(g.to.type!==L.ChatRecipientType.Whisper)throw new Error("Unknown message type "+g.to.type);K=g.from===this.localUsername?this.strings.get("TS:To",z):this.strings.get("TXT_FROM",z)}var[q,z]=K.split(z);return I.default.createElement(I.default.Fragment,null,U,q,V,z)}formatTextHtml(g,P){return P?U.ReactFormat.formatUrls(g):g}})}}}),System.register("gui/component/BasicErrorBoxApi",["gui/HtmlReactElement","util/disposable/CompositeDisposable","gui/component/Dialog","gui/ReactFormat"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("BasicErrorBoxApi",class{constructor(g,P,I){this.viewport=g,this.strings=P,this.rootEl=I,this.disposables=new L.CompositeDisposable}async show(g,P=!1){return new Promise(L=>{let G=this.component=I.HtmlReactElement.factory(_.Dialog,{children:U.ReactFormat.formatMultiline(g,g=>U.ReactFormat.formatUrls(g)),className:"basic-error-box",viewport:this.viewport.value,buttons:P?[]:[{label:this.strings.get("GUI:Ok"),onClick:()=>{this.destroy(),L()}}]}),i=g=>{this.component.setSize(g.width,g.height),this.component.applyOptions(P=>P.viewport=g)};this.viewport.onChange.subscribe(i),G.setSize(this.viewport.value.width,this.viewport.value.height),G.render(),this.rootEl.appendChild(G.getElement()),this.disposables.add(()=>this.viewport.onChange.unsubscribe(i),()=>this.component.getElement()&&this.rootEl.removeChild(this.component.getElement()),()=>this.component.unrender(),()=>this.component=void 0)})}destroy(){this.disposables.dispose()}})}}}),System.register("gui/component/ButtonSelect",["react","classnames"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("ButtonSelect",({initialValue:g,disabled:P,tooltip:_,className:U,onSelect:G,labelStyle:V,children:W})=>{let[z,K]=I.useState(()=>g),[q,$]=I.useState(()=>g);var Q=I.useRef(null);return I.useEffect(()=>{z!==g&&(K(g),$(g))},[g]),I.useEffect(()=>{$(z)},[]),I.default.createElement("div",{className:L.default("button-select",{disabled:P},U),"data-r-tooltip":_,ref:Q},I.default.Children.map(W,g=>{if(!g)return null;const L=g.props.value,_=g.props.disabled;return I.default.createElement("div",{onMouseEnter:()=>!_&&$(L),onMouseLeave:()=>q===L&&$(void 0)},I.default.cloneElement(g,{selected:L===z||L===q,disabled:_||P,labelStyle:V?.(L),onClick:()=>{var g;K(g=L),$(g),G(g)}}))}))})}}}),System.register("gui/component/ChannelOpIndicator",["react","gui/component/Image"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("ChannelOpIndicator",({operator:g})=>I.default.createElement("div",{className:"channel-op-indicator"},g?I.default.createElement(L.Image,{src:"woloper.pcx"}):null))}}}),System.register("gui/component/ChannelUser",["classnames","gui/screen/mainMenu/lobby/component/RankIndicator","react","gui/component/ChannelOpIndicator","gui/component/PlayerContextMenu"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){g("ChannelUser",({user:g,playerProfile:P,strings:V,menuItems:W,localUsername:z})=>{const[K,q]=_.default.useState(!1),$=g.name===z;let Q=g.name;g.operator&&(Q+=" : "+V.get("TXT_OPER")),Q+=void 0!==P?.rank?" : "+V.get(L.RANK_LABELS.get(P.rankType)):" : "+V.get("TXT_UNRANKED");var Y=W.map(P=>({label:P.label,onClick:()=>{P.onClick(g),q(!1)}}));return _.default.createElement("div",{className:I.default("player",{operator:g.operator,"menu-open":K}),"data-r-tooltip":Q,onClick:g=>{g.preventDefault(),g.stopPropagation(),$||q(!0)},onContextMenu:g=>{g.preventDefault(),g.stopPropagation(),$||q(!0)}},_.default.createElement(U.ChannelOpIndicator,{operator:g.operator}),_.default.createElement(L.RankIndicator,{playerProfile:P,strings:V}),_.default.createElement("span",{className:"player-name-wrapper"},_.default.createElement("span",{className:"player-name"},g.name),!$&&0<Y.length&&_.default.createElement(_.default.Fragment,null,_.default.createElement("span",{className:"player-menu-icon"},""),K&&_.default.createElement(G.PlayerContextMenu,{items:Y,onClose:()=>q(!1)}))))})}}}),System.register("gui/component/Chat",["react","classnames","network/chat/ChatMessage","gui/chat/ChatMessageFormat","gui/component/ChatInput"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){V=(new Map).set(_.ChatRecipientType.Channel,"type-channel").set(_.ChatRecipientType.Page,"type-page").set(_.ChatRecipientType.Whisper,"type-whisper"),W=class extends I.default.Component{constructor(){super(...arguments),this.prevMessageCount=0}render(){let{messages:g,tooltips:P,strings:L,chatHistory:_,channels:U}=this.props;return I.default.createElement("div",{className:"chat-wrapper"},I.default.createElement("div",{className:"messages",ref:g=>this.messageList=g,"data-r-tooltip":P?.output},g.map((g,P)=>this.renderMessage(g,P))),I.default.createElement("div",{className:"new-message-wrapper"},I.default.createElement(G.ChatInput,{ref:g=>this.textBox=g,chatHistory:_,channels:U,className:"new-message",tooltip:P?.input,strings:L,onSubmit:this.props.onSendMessage,onCancel:this.props.onCancelMessage}),I.default.createElement("button",{className:"icon-button send-message-button","data-r-tooltip":P?.button,onClick:()=>this.textBox.send()})))}componentDidUpdate(g,P){var I,L;this.props.messages[0]===this.prevOldestMessage&&this.props.messages.length===this.prevMessageCount||(this.prevMessageCount=this.props.messages.length,this.prevOldestMessage=this.props.messages[0],I=this.messageList.scrollHeight,L=this.messageList.clientHeight,I!==this.prevScrollHeight&&(!this.prevScrollHeight||Math.abs(this.messageList.scrollTop-(this.prevScrollHeight-L))<=1)&&(this.messageList.scrollTop=I-L),this.prevScrollHeight=I)}renderMessage(g,P){let G,W=new U.ChatMessageFormat(this.props.strings,this.props.localUsername,this.props.userColors),z=["message"];void 0!==g.from&&(G=W.formatPrefixHtml(g,P=>{this.props.chatHistory&&g.to&&g.to.type!==_.ChatRecipientType.Page&&(this.props.chatHistory.lastComposeTarget.value={type:_.ChatRecipientType.Whisper,name:P})}),z.push(V.get(g.to.type),{"operator-message":g.operator}));var K=void 0===g.from&&!g.untrustedContent;K=W.formatTextHtml(g.text,K);return I.default.createElement("div",{key:P,className:L.default(z)},G?I.default.createElement(I.default.Fragment,null,I.default.createElement("span",null,G)," ",K):K)}},g("Chat",W)}}}),System.register("gui/component/ChatInput",["react","network/chat/ChatMessage","network/gservConfig"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("IMPLICIT_CHANNEL_NAME",""),U=({chatHistory:g,channels:P,strings:U,className:G,tooltip:V,forceColor:W,noCycleHint:z,submitEmpty:K,onKeyDown:q,onKeyUp:$,onBlur:Q,onCancel:Y,onSubmit:Z},X)=>{const J=I.useRef(null),[ee,te]=I.useState(()=>A()),[re,se]=I.useState(()=>{var I=g?.lastComposeTarget.value;return M(I)?I:{type:L.ChatRecipientType.Channel,name:P[0]??""}}),[ae,ne]=I.useState(),[oe,le]=I.useState(),[ce,he]=I.useState(!1),[ue,de]=I.useState(!1);function A(){const I=(P.length?P:[""]).map(g=>({type:L.ChatRecipientType.Channel,name:g}));var _,U;return g&&(_=g.lastWhisperFrom.value,U=g.lastWhisperTo.value,_&&I.push({type:L.ChatRecipientType.Whisper,name:_}),U&&U!==_&&I.push({type:L.ChatRecipientType.Whisper,name:U})),I}function M(g){return g&&(g.type!==L.ChatRecipientType.Channel||P.includes(g.name))}function R(P){g&&(g.lastComposeTarget.value=P),se(P)}I.useEffect(()=>{J.current?.focus()},[]),I.useEffect(()=>{M(re)||se({type:L.ChatRecipientType.Channel,name:P[0]??""})},[P]),I.useEffect(()=>{if(g){let e=g=>{re!==g&&M(g)&&(se(g),J.current?.focus())},t=()=>{te(A())};return g.lastComposeTarget.onChange.subscribe(e),g.lastWhisperFrom.onChange.subscribe(t),g.lastWhisperTo.onChange.subscribe(t),()=>{g.lastComposeTarget.onChange.unsubscribe(e),g.lastWhisperFrom.onChange.unsubscribe(t),g.lastWhisperTo.onChange.unsubscribe(t)}}},[re,g,P]),I.useImperativeHandle(X,()=>({send(){let g=J.current;var P;!g||(P=g.value).length&&(Z({recipient:re,value:P}),g.value="",g.focus(),le(P))}}),[re]);var ge=function(g){if(g.type===L.ChatRecipientType.Channel)return g.name===_.RECIPIENT_TEAM?U.get("TS:ToAllies"):g.name===_.RECIPIENT_ALL?U.get("TS:ToAll"):"";if(g.type===L.ChatRecipientType.Whisper)return U.get("TS:To",g.name);throw new Error(`Recipient type ${g.type} not implemented`)}(re);let pe=!z&&ce&&!ue&&(1<ee.length||re.type===L.ChatRecipientType.Whisper)?U.get("TS:ChatCycleHint","Tab"):void 0;return I.default.createElement("div",{className:G},ge&&I.default.createElement("label",{style:{color:W}},ge),I.default.createElement("input",{type:"text",autoComplete:"off",spellCheck:!1,ref:J,maxLength:128,"data-r-tooltip":V,placeholder:pe,style:{color:W},onKeyDown:g=>{"Tab"===g.key&&g.preventDefault(),g.repeat||ne(g.key),q?.(g)},onKeyUp:g=>{let P=g.target;var I;"Enter"===g.key?"Enter"===ae&&(((I=P.value).length||K)&&Z({recipient:re,value:I}),I.length&&(P.value="",le(I))):"Tab"===g.key?"Tab"===ae&&function(g){if(1!==ee.length||ee[0].name!==g.name){let I=ee.findIndex(P=>P.type===g.type&&P.name===g.name);I=-1===I?0:(I+1)%ee.length;var P=ee[I];de(!0),R(P)}}(re):"ArrowUp"===g.key&&oe?P.value=oe:"Escape"===g.key&&"Process"!==ae&&(Y?.(0===P.value.length),P.value=""),$?.(g)},onChange:P=>{let I=P.target.value;var _=I.match(/^\/(?:page|whisper|w|msg|m) ([A-Za-z0-9-_']+) /i);_&&(R({type:L.ChatRecipientType.Whisper,name:_[1]}),P.target.value="");var U=I.match(/^\/r(eply)? /i);U&&(void 0!==g?.lastWhisperFrom.value&&R({type:L.ChatRecipientType.Whisper,name:g.lastWhisperFrom.value}),P.target.value=""),_||U||void 0===pe||de(!0)},onFocus:()=>{he(!0)},onBlur:()=>{he(!1),Q?.()}}))},g("ChatInput",I.forwardRef(U))}}}),System.register("gui/component/ColorSelect",["react","classnames","gui/component/Select","gui/component/Option"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("ColorSelect",({color:g,disabled:P,availableColors:G,onSelect:V,strings:W})=>{let[z,K]=I.useState(()=>g);return I.useEffect(()=>{z!==g&&K(g)},[g]),I.default.createElement(_.Select,{className:L.default("player-color-select",{"bg-color":!!z}),tooltip:W.get("STT:HostComboColor"),initialValue:z||"random",disabled:P,labelStyle:g=>({backgroundColor:"random"!==g?g:"transparent"}),onSelect:g=>{"random"===g&&(g=""),K(g),V?.(g)}},(P?[z]:G).map(g=>I.default.createElement(U.Option,{key:g,value:g||"random",label:g?"":W.get("GUI:RandomAsSymbols"),className:L.default({"bg-color":!!g})})))})}}}),System.register("gui/component/CountryIcon",["react","game/gameopts/constants","gui/component/Image"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=(new Map).set("Americans","usai.pcx").set("French","frai.pcx").set("Germans","geri.pcx").set("British","gbri.pcx").set("Russians","rusi.pcx").set("Confederation","lati.pcx").set("Africans","djbi.pcx").set("Arabs","arbi.pcx").set("Alliance","japi.pcx").set("YuriCountry","yrii.pcx").set(L.RANDOM_COUNTRY_NAME,"rani.pcx").set(L.OBS_COUNTRY_NAME,"obsi.pcx"),G=class extends I.default.Component{render(){var g=U.get(this.props.country);return I.default.createElement("div",{className:"player-country-icon"},g&&I.default.createElement(_.Image,{src:g}))}},g("CountryIcon",G)}}}),System.register("gui/component/CountrySelect",["react","gui/component/CountryIcon","gui/component/Select","gui/component/Option"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("CountrySelect",({country:g,availableCountries:P,onlyIcon:G,disabled:V,strings:W,countryUiNames:z,countryUiTooltips:K,onSelect:q})=>{let[$,Q]=I.useState(()=>g);return I.useEffect(()=>{$!==g&&Q(g)},[g]),I.default.createElement("div",{className:"country-select"},I.default.createElement("div",{className:"player-country-icon","data-r-tooltip":W.get("STT:HostPictureFlag")},I.default.createElement(L.CountryIcon,{country:$})),G?null:I.default.createElement(_.Select,{className:"player-country-select",tooltip:W.get("STT:HostComboCountry"),initialValue:$,disabled:V,onSelect:g=>{Q(g),q(g)}},(V?[$]:P).map(g=>{var P=W.get(z.get(g)||g),L=K.has(g)?W.get(K.get(g)):void 0;return I.default.createElement(U.Option,{key:g,value:g,label:P,tooltip:L})})))})}}}),System.register("gui/component/Dialog",["react"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.default.Component{render(){return this.props.hidden?null:I.default.createElement("div",{style:this.getWrapperStyle()},I.default.createElement("div",{className:"message-box "+(this.props.className||"")},I.default.createElement("div",{className:"message-box-content"},this.props.children),I.default.createElement("div",{className:"message-box-footer"},this.props.buttons.map((g,P)=>this.renderButton(g,P)))))}renderButton(g,P){return I.default.createElement("button",{key:P,className:"dialog-button",onClick:g.onClick,disabled:g.disabled},g.label)}getWrapperStyle(){var g=this.props.viewport;return{position:"absolute",top:g.x,left:g.y,width:g.width,height:g.height,zIndex:this.props.zIndex}}},g("Dialog",L)}}}),System.register("gui/component/GameResBoxApi",["react","classnames","gui/HtmlReactElement","gui/component/Dialog","gui/component/GameResForm","engine/gameRes/FileSystemUtil"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){g("GameResBoxApi",class{constructor(g,P,I,L){this.viewport=g,this.strings=P,this.rootEl=I,this.fsAccessLib=L}async promptForGameRes(g,P){return await this.fsAccessLib.polyfillDataTransferItem(),await new Promise(W=>{let z=_.HtmlReactElement.factory(U.Dialog,{className:L.default("game-res-box"),buttons:[],children:I.default.createElement(G.GameResForm,{defaultArchiveUrl:g,closable:P,strings:this.strings,onDrop:async g=>{if(g.items.length)try{var P=await g.items[0].getAsFileSystemHandle();if(!P)return;s(),W(P)}catch(g){console.error(g)}},onBrowseFolder:async()=>{try{var g=await this.fsAccessLib.showDirectoryPicker({_preferPolyfill:!0});s(),W(g)}catch(g){console.error(g)}},onBrowseArchive:async()=>{try{var g=await V.FileSystemUtil.showArchivePicker(this.fsAccessLib);s(),W(g)}catch(g){console.error(g)}},onDownloadArchive:async g=>{s(),W(g)},onClose:()=>{s(),W(void 0)}}),viewport:this.viewport.value}),t=g=>{z.setSize(g.width,g.height),z.applyOptions(P=>P.viewport=g)};this.viewport.onChange.subscribe(t);const s=()=>{this.viewport.onChange.unsubscribe(t),t=void 0;var g=z.getElement();g&&this.rootEl.removeChild(g),z.unrender(),z=void 0};z.setSize(this.viewport.value.width,this.viewport.value.height),z.render(),this.rootEl.appendChild(z.getElement())})}})}}}),System.register("gui/component/GameResForm",["react","classnames"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("GameResForm",({closable:g,strings:P,defaultArchiveUrl:_,onDownloadArchive:U,onBrowseFolder:G,onBrowseArchive:V,onDrop:W,onClose:z})=>{let[K,q]=I.default.useState(),[$,Q]=I.default.useState(_),Y=I.default.useRef(null);var Z=I.default.useCallback(g=>{g.target===K&&q(void 0)},[K]);return I.default.useEffect(()=>{Y.current?.focus()},[]),I.default.useEffect(()=>{let e=g=>g.preventDefault();return globalThis.addEventListener("drop",e),globalThis.addEventListener("dragover",e),()=>{globalThis.removeEventListener("drop",e),globalThis.removeEventListener("dragover",e)}},[]),I.default.createElement("div",null,g&&I.default.createElement("div",{className:"close-button",onClick:z}),I.default.createElement("div",{className:"title"},P.get("ts:gameres_locate_title")),I.default.createElement("div",{className:"browse-container"},I.default.createElement("p",null,P.get("ts:gameres_import_desc")),I.default.createElement("form",{className:"link-container",onSubmit:g=>{if(g.preventDefault(),$)try{var I=new URL($.trim());"http:"!==I.protocol&&"https:"!==I.protocol?alert(P.get("ts:gameres_invalid_url")):"http:"===I.protocol&&"https:"===location.protocol?alert(P.get("ts:gameres_insecure_url")):U(I)}catch(g){alert(P.get("ts:gameres_invalid_url"))}}},I.default.createElement("p",{className:"link-field"},I.default.createElement("label",null,P.get("ts:gameres_download_url")),I.default.createElement("input",{type:"url",ref:Y,value:$,onChange:g=>Q(g.currentTarget.value),placeholder:"https://"})),I.default.createElement("p",{className:"download-button"},I.default.createElement("button",{type:"submit",className:"dialog-button",disabled:!$?.trim()},P.get("ts:gameres_download_button")))),I.default.createElement("div",{className:L.default("drop-container",{"dropzone-active":!!K}),onDragOver:g=>g.preventDefault(),onDragLeave:Z,onDragEnter:g=>{[...g.dataTransfer.items].every(g=>"file"===g.kind)&&q(g.target)},onDrop:g=>{g.preventDefault(),[...g.dataTransfer.items].every(g=>"file"===g.kind)&&W(g.dataTransfer)}},I.default.createElement("p",{className:"drop-figures"},I.default.createElement("img",{src:"res/img/drag-archive.png",width:"98",height:"133",alt:"Red-Alert-2-Multiplayer.exe"}),P.get("ts:gameres_or"),I.default.createElement("img",{src:"res/img/drag-folder.png",width:"99",height:"153",alt:"Command and Conquer Red Alert II"})),I.default.createElement("p",{className:"desc"},P.get("ts:gameres_drop_desc"),I.default.createElement("br",null),P.get("ts:gameres_or")),I.default.createElement("p",{className:"browse-buttons"},I.default.createElement("button",{className:"dialog-button",onClick:G},P.get("ts:gameres_browse_folder")),I.default.createElement("button",{className:"dialog-button",onClick:V},P.get("ts:gameres_browse_archive"))),I.default.createElement("p",{className:"archive-formats"},I.default.createElement("em",null,P.get("ts:gameres_supported_archive_formats"))))))})}}}),System.register("gui/component/Image",["data/Palette","data/PcxFile","data/ShpFile","engine/gfx/ImageUtils","react","gui/component/ImageContext"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){g("Image",g=>{const P=V.ImageContext,[W,z]=G.useState("");return G.useEffect(()=>{let G,V;if(P.imageUrlCache.has(g.src))G=P.imageUrlCache.get(g.src);else if(P.vfs?.fileExists(g.src)){var W=g.src.split(".").pop();if("shp"===W){var K,q,$=g.palette;G=P.vfs.fileExists($)?(K=new _.ShpFile(P.vfs.openFile(g.src)),q=new I.Palette(P.vfs.openFile($)),U.ImageUtils.convertShpToCanvas(K,q).toDataURL()):(console.warn(`Palette "${$}" not found in VFS"`),"")}else if("pcx"===W){let I=new L.PcxFile(P.vfs.openFile(g.src));G=I.toDataUrl()}else"png"===W?($=P.vfs.openFile(g.src).stream,$=new Blob([new Uint8Array($.buffer,$.byteOffset,$.byteLength)],{type:"image/png"}),G=URL.createObjectURL($),V=()=>{URL.revokeObjectURL(G),P.imageUrlCache.delete(g.src)}):(console.warn(`Unknown image format "${W}"`),G="");P.imageUrlCache.set(g.src,G)}else G=P.cdnBaseUrl?P.cdnBaseUrl+g.src.substring(0,g.src.lastIndexOf("."))+".png":(console.warn(`Image "${g.src}" not found in VFS`),"");return z(G),V},[g.src]),W?G.default.createElement("img",{src:W}):null})}}}),System.register("gui/component/ImageContext",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){g("ImageContext",I=class{}),I.imageUrlCache=new Map}}}),System.register("gui/component/List",["react","classnames"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("List",({children:g,className:P,title:_,innerRef:U,tooltip:G})=>I.default.createElement(I.default.Fragment,null,_&&I.default.createElement("div",{className:"list-title"},_),I.default.createElement("div",{ref:U,className:L.default("list",P),"data-r-tooltip":G},g))),g("ListItem",({children:g,selected:P,disabled:_,tooltip:U,className:G,innerRef:V,...W})=>I.default.createElement("div",{ref:V,className:L.default("list-item",{selected:P,disabled:_},G),"data-r-tooltip":U,...W},g)),g("ListHeader",({children:g,tooltip:P,className:_,innerRef:U,...G})=>I.default.createElement("div",{ref:U,className:L.default("list-header",_),"data-r-tooltip":P,...G},g))}}}),System.register("gui/component/MenuButton",["react"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.default.Component{render(){var g=this.props.buttonConfig;return g?I.default.createElement("div",{className:this.getClassName(g),style:this.getStyle(),onMouseDown:g=>this.onMouseDown(g),onMouseUp:g=>this.onMouseUp(g),onClick:g=>this.onClick(g),"data-r-tooltip":g.tooltip},g.label):null}getClassName(g){let P=["menu-button"];return g.disabled&&P.push("disabled"),P.join(" ")}getStyle(){var g=this.props.box;return{position:"absolute",left:g.x,top:g.y,width:g.width,height:g.height,lineHeight:g.height+1+"px"}}onMouseDown(g){!this.props.buttonConfig.disabled&&this.props.onMouseDown&&this.props.onMouseDown(g)}onMouseUp(g){!this.props.buttonConfig.disabled&&this.props.onMouseUp&&this.props.onMouseUp(g)}onClick(g){!this.props.buttonConfig.disabled&&this.props.onClick&&this.props.onClick(g)}},g("MenuButton",L)}}}),System.register("gui/component/MessageBoxApi",["react","gui/jsx/jsx","gui/jsx/HtmlView","util/disposable/CompositeDisposable","gui/component/Dialog","gui/component/PromptDialog"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){g("MessageBoxApi",class{constructor(g,P,I){this.viewport=g,this.uiScene=P,this.jsxRenderer=I,this.disposables=new U.CompositeDisposable}show(g,P,I){this.destroy();var U="function"!=typeof I?I:void 0;let[V]=this.jsxRenderer.render(L.jsx(_.HtmlView,{innerRef:g=>this.component=g,component:G.Dialog,props:{children:"string"!=typeof g?g:this.splitNewLines(g),className:U?.className,viewport:this.viewport,zIndex:101,buttons:"string"==typeof P?[{label:P,onClick:()=>{this.disposables.dispose(),"function"==typeof I&&I()}}]:(P??[]).map(g=>({label:g.label,disabled:g.disabled,onClick:()=>{this.disposables.dispose(),g.onClick?.()}}))}}));this.uiScene.add(V),this.disposables.add(V,()=>this.uiScene.remove(V),()=>this.component=void 0)}splitNewLines(g){return g.split(/\n/g).map((g,P)=>P?I.createElement(I.Fragment,{key:P},I.createElement("br",null),I.createElement("span",null,g)):I.createElement("span",{key:P},g))}async confirm(g,P,I){return await new Promise(L=>{this.show(g,[{label:P,onClick:()=>L(!0)},{label:I,onClick:()=>L(!1)}])})}async alert(g,P){await new Promise(I=>this.show(g,P,I))}async prompt(g,P,I,U){return this.destroy(),await new Promise(G=>{let[W]=this.jsxRenderer.render(L.jsx(_.HtmlView,{innerRef:g=>this.component=g,component:V.PromptDialog,props:{promptText:g,submitLabel:P,cancelLabel:I,inputProps:U,onSubmit:g=>{G(g),W.destroy()},onDismiss:()=>{G(void 0),W.destroy()},viewport:this.uiScene.viewport}}));this.uiScene.add(W),this.disposables.add(W,()=>this.uiScene.remove(W),()=>this.component=void 0)})}updateViewport(g){this.viewport=g,this.component&&this.component.applyOptions(P=>P.viewport=g)}updateText(g){this.component&&this.component.applyOptions(P=>{P.promptText?P.promptText=g:P.children="string"!=typeof g?g:this.splitNewLines(g)})}destroy(){this.disposables.dispose()}})}}}),System.register("gui/component/Option",["classnames","react"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("Option",({selected:g,disabled:P,label:_,style:U,labelStyle:G,className:V,tooltip:W,onClick:z})=>L.createElement("div",{className:I.default("option",{selected:g,disabled:P},V),style:U,onClick:P?void 0:z,"data-r-tooltip":W},L.createElement("div",{style:G},_)))}}}),System.register("gui/component/PartyInviteDialog",["react","gui/component/Dialog"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("PartyInviteDialog",({inviterName:g,strings:P,showPreventionCheckbox:_=!1,viewport:U,onAccept:G,onDecline:V})=>{const[W,z]=I.useState(!1),[K,q]=I.useState(!1);return I.default.createElement(L.Dialog,{hidden:W,viewport:U,zIndex:100,buttons:[{label:P.get("GUI:PartyInviteAccept"),disabled:_&&K,onClick:()=>{z(!0),G()}},{label:P.get("GUI:PartyInviteDecline"),onClick:()=>{z(!0),V(K)}}]},I.default.createElement("div",null,I.default.createElement("div",{style:{marginBottom:_?"12px":"0"}},P.get("GUI:PartyInviteReceived",g)),_&&I.default.createElement("label",{style:{display:"flex",alignItems:"center",cursor:"pointer",marginBottom:"8px"}},I.default.createElement("input",{type:"checkbox",checked:K,onChange:g=>q(g.target.checked),style:{marginRight:"8px",cursor:"pointer"}}),I.default.createElement("span",{style:{fontSize:"12px",color:"yellow"}},P.get("GUI:PartyInvitePrevent",60)))))})}}}),System.register("gui/component/PingIndicator",["react","gui/component/Image"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){var P;(P=_=_||{})[P.Good=1]="Good",P[P.Average=2]="Average",P[P.Bad=3]="Bad",U=g=>g<=100?_.Good:g<=250?_.Average:_.Bad,G=(new Map).set(_.Bad,"pingr").set(_.Average,"pingy").set(_.Good,"pingg"),g("PingIndicator",({ping:g,strings:P})=>{var _=void 0!==g?P.get("Msg:PingInfo",g):void 0;return I.default.createElement("div",{className:"ping-indicator","data-r-tooltip":_,title:_},void 0!==g?I.default.createElement(L.Image,{src:G.get(U(g))+".pcx"}):null)})}}}),System.register("gui/component/PlayerContextMenu",["react","gui/component/List"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("PlayerContextMenu",({items:g,onClose:P})=>{const _=I.useRef(null);return I.useEffect(()=>{const e=g=>{_.current&&!_.current.contains(g.target)&&P()};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[P]),I.default.createElement(L.List,{className:"player-context-menu",innerRef:_},g.map((g,P)=>I.default.createElement(L.ListItem,{key:P,className:"player-context-menu-item",onClick:P=>{P.stopPropagation(),g.onClick()}},g.label)))})}}}),System.register("gui/component/PromptDialog",["react","gui/component/Dialog"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("PromptDialog",({viewport:g,promptText:P,submitLabel:_,cancelLabel:U,inputProps:G,onSubmit:V,onDismiss:W})=>{let z=I.useRef(null),[K,q]=I.useState(!1);I.useEffect(()=>{setTimeout(()=>{z.current?.focus()},50)},[]);var h=g=>{g&&g.preventDefault(),q(!0),V(z.current.value)};return I.default.createElement(L.Dialog,{className:"prompt-box",hidden:K,viewport:g,zIndex:100,buttons:[{label:_,onClick:h},{label:U,onClick:()=>{q(!0),W?.()}}]},I.default.createElement("form",{onSubmit:h,autoComplete:"off"},I.default.createElement("div",{className:"field"},I.default.createElement("label",null,P.split(/\r?\n/).map((g,P)=>I.default.createElement(I.default.Fragment,{key:P},P?I.default.createElement("br",null):null,g))),I.default.createElement("input",{name:"promptvalue",type:"text",autoComplete:"off","data-lpignore":"true",ref:z,...G})),I.default.createElement("button",{type:"submit",style:{visibility:"hidden"}})))})}}}),System.register("gui/component/Select",["react","classnames","util/dom"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("Select",({initialValue:g,disabled:P,tooltip:U,className:G,onSelect:V,labelStyle:W,children:z})=>{let[K,q]=I.useState(()=>g),[$,Q]=I.useState(()=>g),[Y,Z]=I.useState(!1),X=I.useRef(null);var J,ee;return I.useEffect(()=>{K!==g&&(q(g),Q(K))},[g]),I.useEffect(()=>{if(Y){Q(K);const e=g=>{_.contains(X.current,g.target)||Z(!1)};return document.addEventListener("click",e),()=>{document.removeEventListener("click",e)}}},[Y]),I.default.createElement("div",{style:{display:"inline-block",verticalAlign:"middle"},className:G},I.default.createElement("div",{className:L.default("select",{disabled:P}),"data-r-tooltip":U,ref:X},I.default.createElement("div",{className:"select-value",onClick:()=>!P&&Z(!Y)},I.default.createElement("div",{style:W?.(K)},(J=K,(ee=I.default.Children.toArray(z).find(g=>g.props.value===J))?ee.props.label:""))),Y&&I.default.createElement("div",{className:"select-layer"},I.default.Children.map(z,g=>{if(!g)return null;const P=g.props.value,L=g.props.disabled;return I.default.createElement("div",{onMouseEnter:()=>!L&&Q(P)},I.default.cloneElement(g,{selected:P===$,labelStyle:W?.(P),onClick:()=>{var g;q(g=P),Q(g),V?.(g),Z(!1)}}))}))))})}}}),System.register("gui/component/Slider",["react"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("Slider",({getLabel:g,...P})=>{let[L,_]=I.useState(()=>P.value);return I.useEffect(()=>{L!==P.value&&_(P.value)},[P.value]),I.default.createElement("div",{style:{display:"inline-block",verticalAlign:"middle"}},I.default.createElement("input",{type:"range",...P,value:L,onChange:g=>{_(g.target.value),P.onChange?.(g)}}),I.default.createElement("input",{type:"text",disabled:!0,readOnly:!0,value:g?.(L)??L}))})}}}),System.register("gui/component/SplashScreen",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("SplashScreen",class{constructor(g,P){this.width=g,this.height=P,this.rendered=!1}render(g){if(!this.rendered){let I=this.el=document.createElement("div");I.style.backgroundColor="black",I.style.color="white",I.style.padding="10px",I.style.boxSizing="border-box",I.style.backgroundRepeat="no-repeat",I.style.backgroundPosition="50% 50%",I.style.textShadow="1px 1px black",this.updateSize();var P=this.loadingEl=document.createElement("div");I.appendChild(P);let L=this.copyrightEl=document.createElement("div");L.style.position="absolute",L.style.bottom="10px",L.style.right="10px",L.style.textAlign="right",I.appendChild(L);let _=this.disclaimerEl=document.createElement("div");_.style.position="absolute",_.style.bottom="10px",_.style.left="10px",I.appendChild(_),g.appendChild(I),this.rendered=!0}}setBackgroundImage(g){this.el.style.backgroundImage=`url(${g})`}setLoadingText(g){this.loadingEl.innerHTML=g}setCopyrightText(g){this.copyrightEl.innerHTML=g.replace(/\n/g,"<br />")}setDisclaimerText(g){this.disclaimerEl.innerHTML=g.replace(/\n/g,"<br />")}setSize(g,P){this.width=g,this.height=P,this.updateSize()}updateSize(){this.el&&(this.el.style.width=this.width+"px",this.el.style.height=this.height+"px")}destroy(){this.rendered&&(this.el.remove(),this.rendered=!1)}})}}}),System.register("gui/component/StartPosSelect",["react","gui/component/Select","game/gameopts/constants","gui/component/Option"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("StartPosSelect",({startPos:g,disabled:P,availableStartPositions:G,onSelect:V,strings:W})=>{let z=[...new Set([g,...G]).values()].sort();return I.default.createElement(L.Select,{className:"player-start-pos-select",initialValue:""+g,disabled:P,tooltip:W.get("STT:HostComboStart"),onSelect:g=>{V?.(Number(g))}},z.map(g=>I.default.createElement(U.Option,{key:g,value:""+g,label:g===_.RANDOM_START_POS?W.get("GUI:RandomAsSymbols"):""+(g+1)})))})}}}),System.register("gui/component/TeamSelect",["react","gui/component/Select","gui/component/Option","game/gameopts/constants"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("formatTeamId",G=g=>String.fromCharCode("A".charCodeAt(0)+g)),g("TeamSelect",({teamId:g,required:P,disabled:V,maxTeams:W,onSelect:z,strings:K})=>{let q=new Array(W).fill(0).map((g,P)=>P);return I.default.createElement(L.Select,{className:"player-team-select",initialValue:""+g,disabled:V,tooltip:K.get("STT:HostComboTeam"),onSelect:g=>{z?.(Number(g))}},!P&&I.default.createElement(_.Option,{value:""+U.NO_TEAM_ID,label:K.get("GUI:NoneAsSymbols")}),q.map(g=>I.default.createElement(_.Option,{key:g,value:""+g,label:G(g)})))})}}}),System.register("gui/component/ToastApi",["gui/jsx/jsx","gui/jsx/HtmlView","util/disposable/CompositeDisposable","gui/component/Toasts"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("ToastApi",class{constructor(g,P,I){this.viewport=g,this.uiScene=P,this.jsxRenderer=I,this.messages=[],this.disposables=new _.CompositeDisposable,this.handleViewportChange=g=>{this.innerComponent&&this.innerComponent.applyOptions(P=>P.viewport=g)}}push(g){var P=Date.now();this.messages.push({text:g,timestamp:P}),this.updateTimeoutId&&(clearTimeout(this.updateTimeoutId),this.updateTimeoutId=void 0),this.update()}update(){if(this.messages=this.messages.filter(g=>g.timestamp>Date.now()-5e3),this.messages=this.messages.slice(-5),this.messages.length){let g=this.messages.map(g=>g.text);if(this.uiToasts)this.innerComponent?.applyOptions(P=>P.messages=g);else{let[P]=this.jsxRenderer.render(I.jsx(L.HtmlView,{innerRef:g=>this.innerComponent=g,component:U.Toasts,props:{messages:g,viewport:this.viewport.value,zIndex:101}}));this.uiToasts=P,this.uiScene.add(P),this.viewport.onChange.subscribe(this.handleViewportChange),this.disposables.add(P,()=>this.uiScene.remove(P),()=>this.viewport.onChange.unsubscribe(this.handleViewportChange),()=>this.innerComponent=void 0,()=>this.uiToasts=void 0)}this.updateTimeoutId=setTimeout(()=>this.update(),5e3)}else this.destroy()}destroy(){this.updateTimeoutId&&(clearTimeout(this.updateTimeoutId),this.updateTimeoutId=void 0),this.disposables.dispose()}})}}}),System.register("gui/component/Toasts",["react"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("Toasts",({messages:g,viewport:P,zIndex:L})=>I.default.createElement("div",{style:{position:"absolute",top:P.x,left:P.y,width:P.width,zIndex:L}},I.default.createElement("div",{className:"toasts"},g.map((g,P)=>I.default.createElement("div",{key:P,className:"toast"},g)))))}}}),System.register("gui/component/UiText",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","engine/gfx/SpriteUtils","engine/gfx/CanvasUtils"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){W=class extends _.UiComponent{constructor(){super(...arguments),this.value=this.props.value,this.textAlign=this.props.textAlign}createUiObject(){let g=new L.UiObject(new THREE.Object3D,new U.HtmlContainer);g.setPosition(this.props.x||0,this.props.y||0);var P=this.props.width,I=this.props.height;let _=document.createElement("canvas");return _.width=P,_.height=I,this.ctx=_.getContext("2d",{alpha:!0}),this.texture=this.createTexture(_),this.updateTexture(this.value,this.textAlign,this.props.textColor),this.mesh=this.createMesh(P,I),g}createTexture(g){let P=new THREE.Texture(g);return P.needsUpdate=!0,P.flipY=!1,P.minFilter=THREE.NearestFilter,P.magFilter=THREE.NearestFilter,P}createMesh(g,P){let I=G.SpriteUtils.createRectGeometry(g,P);G.SpriteUtils.addRectUvs(I,{x:0,y:0,width:g,height:P},{width:g,height:P}),I.translate(g/2,P/2,0);var L=new THREE.MeshBasicMaterial({map:this.texture,side:THREE.DoubleSide,transparent:!0});let _=new THREE.Mesh(I,L);return _.frustumCulled=!1,_}defineChildren(){return I.jsx("mesh",{zIndex:this.props.zIndex,onClick:this.props.onClick},this.mesh)}updateTexture(g,P,I){this.ctx.clearRect(0,0,this.props.width,this.props.height),V.CanvasUtils.drawText(this.ctx,g,0,0,{color:I,fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:12,fontWeight:"500",paddingTop:6,textAlign:P??"center",width:this.props.width,height:this.props.height}),this.texture.needsUpdate=!0}setValue(g){this.value!==g&&(this.value=g,this.updateTexture(g,this.textAlign,this.props.textColor))}setTextAlign(g){g!==this.textAlign&&(this.textAlign=g,this.updateTexture(this.value,g,this.props.textColor))}onDispose(){this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.texture.dispose()}},g("UiText",W)}}}),System.register("gui/FullScreen",["util/disposable/CompositeDisposable","util/fullScreen","util/event"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("FullScreen",U=class a{static isFullScreenHotKey(g){return g.keyCode===this.hotKey.keyCode&&g.altKey===this.hotKey.altKey&&g.shiftKey===this.hotKey.shiftKey&&g.ctrlKey===this.hotKey.ctrlKey&&g.metaKey===this.hotKey.metaKey}get onChange(){return this._onChange.asEvent()}constructor(g){this.document=g,this.disposables=new I.CompositeDisposable,this._onChange=new _.EventDispatcher,this.handleFullScreenChange=g=>{this._onChange.dispatch(this,g)}}init(){const e=g=>{a.isFullScreenHotKey(g)&&(g.preventDefault(),g.stopPropagation(),this.toggle())};this.document.addEventListener("keydown",e),this.disposables.add(()=>this.document.removeEventListener("keydown",e));var g=L.setupFullScreenChangeListener(this.document,this.handleFullScreenChange);g&&this.disposables.add(g)}toggle(){this.toggleAsync().catch(g=>console.error(g))}isFullScreen(){return!!this.document.fullscreenElement}isAvailable(){return this.document.fullscreenEnabled||this.document.webkitFullscreenEnabled}async toggleAsync(){if(this.document.fullscreenElement){try{screen?.orientation?.unlock?.()}catch(g){}await this.document.exitFullscreen()}else{await this.document.documentElement.requestFullscreen();try{await(screen?.orientation?.lock?.("landscape"))}catch(g){console.warn("Orientation lock failed",g)}}}dispose(){this.disposables.dispose()}}),U.hotKey={altKey:!0,shiftKey:!1,ctrlKey:!1,metaKey:!1,keyCode:"F".charCodeAt(0)}}}}),System.register("gui/HtmlContainer",["gui/LazyHtmlElement"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.LazyHtmlElement{constructor(){super(...arguments),this.visible=!0,this.left=0,this.top=0,this.width=0,this.height=0,this.relativeMode=!1,this.translateMode=!1}render(){var g;this.isRendered()||((g=this.getElement())||(g=document.createElement("div"),this.setElement(g)),this.updateMode(),this.updatePosition(),this.updateVisibility(),this.updateSize()),super.render()}setRelativeMode(g){this.relativeMode=g,this.updateMode()}setTranslateMode(g){this.translateMode=g,this.updatePosition()}setPosition(g,P){this.left=g,this.top=P,this.updatePosition()}setSize(g,P){this.width=g,this.height=P,this.updateSize()}getSize(){return{width:this.width,height:this.height}}setVisible(g){g!==this.visible&&(this.visible=g,this.updateVisibility())}updateMode(){let g=this.getElement();g&&(this.relativeMode?g.style.position="relative":(g.style.overflow="visible",g.style.position="absolute"))}updatePosition(){let g=this.getElement();g&&(this.translateMode?(g.style.top=g.style.left="0",g.style.transform=`translate(${this.left}px, ${this.top}px)`):(g.style.left=this.left+"px",g.style.top=this.top+"px",g.style.transform=""))}updateSize(){let g=this.getElement();g&&(g.style.width="number"==typeof this.width?this.width+"px":this.width,g.style.height="number"==typeof this.height?this.height+"px":this.height)}hide(){this.setVisible(!1)}show(){this.setVisible(!0)}updateVisibility(){let g=this.getElement();g&&(g.style.display=this.visible?"block":"none")}},g("HtmlContainer",L)}}}),System.register("gui/HtmlReactElement",["react","react-dom","gui/HtmlContainer"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class extends _.HtmlContainer{static factory(g,P){return new this(P,g)}constructor(g,P){super(),this.options=g,this.Component=P}render(){var g;this.isRendered()||(g=document.createElement("div"),this.setElement(g),this.renderReactElement()),super.render()}renderReactElement(){L.default.render(I.default.createElement(this.Component,this.options),this.getElement())}applyOptions(g){g(this.options),this.refresh()}refresh(){this.isRendered()&&this.renderReactElement()}unrender(){var g=this.getElement();g&&this.isRendered()&&L.default.unmountComponentAtNode(g),super.unrender()}},g("HtmlReactElement",U)}}}),System.register("gui/jsx/HtmlView",["gui/jsx/UiComponent","gui/UiObject","gui/HtmlReactElement"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class extends I.UiComponent{createUiObject(g){let P=_.HtmlReactElement.factory(this.props.component,this.props.props);P.setSize(g.width||0,g.height||0);let I=new L.UiObject(new THREE.Object3D,P);return I.setPosition(g.x||0,g.y||0),g.hidden&&I.setVisible(!1),this.props.innerRef?.(P),I}getElement(){return this.getUiObject().getHtmlContainer()}},g("HtmlView",U)}}}),System.register("gui/jsx/jsx",[],function(g,P){"use strict";return P&&P.id,g("createRef",function(){return{current:void 0}}),g("jsx",function(g,P,...I){let{ref:L,..._}=P=P||{};return{isJsxElement:!0,type:g,props:{..._,children:1<I.length?I:I[0]},ref:L}}),g("renderJsx",function r(g,P){let I,L,_;return(g=Array.isArray(g)?g:[g]).map(g=>{if(null==g||!g.isJsxElement)return[];if("string"==typeof g.type)if(L=g.props.children,"fragment"===g.type)I=void 0;else{let G=P[g.type];if(!G)throw new Error(`No renderer defined for intrinsic JSX element "${g.type}"`);var U=G({ref:g.ref,...g.props});I=U.obj,I&&(_=I),U.children&&(L=U.children)}else{let P=new g.type(g.props);I=P.getUiObject(),L=P.defineChildren?.()||g.props.children,P.onRender&&I.onFrame.subscribeOnce(g=>P.onRender(g)),P.onFrame&&I.onFrame.subscribe(g=>P.onFrame(g)),P.onDispose&&I.onDispose.subscribe(()=>P.onDispose()),_=P}return U=L?(Array.isArray(L)?L:[L]).map(g=>r(g,P)).reduce((g,P)=>[...g,...P],[]):[],I&&I.add(...U),_&&g.ref&&("function"==typeof g.ref?g.ref?.(_):g.ref.current=_),I?[I]:null!==I?U:[]}).reduce((g,P)=>[...g,...P],[])}),{setters:[],execute:function(){}}}),System.register("gui/jsx/JsxRenderer",["gui/jsx/jsx","gui/UiObjectSprite","gui/UiObject","gui/HtmlContainer","engine/renderable/builder/CanvasSpriteBuilder","gui/ShpSpriteBatch"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){W=g=>!!g.images,g("JsxRenderer",class{constructor(g,P,I,z){this.images=g,this.palettes=P,this.camera=I,this.jsxIntrinsicRenderers={sprite:g=>{let P;if(W(g)){let I=new G.CanvasSpriteBuilder(g.images,this.camera);I.setAlign(g.alignX??0,g.alignY??0),P=new L.UiObjectSprite(I)}else{var I="string"==typeof g.image?this.getImage(g.image):g.image,_="string"==typeof g.palette?this.getPalette(g.palette):g.palette;P=L.UiObjectSprite.fromShpFile(I,_,this.camera)}return z&&P.setPointerEvents(z),this.setupListeners(P,g),g.onFrame&&P.onFrame.subscribe(g.onFrame),P.setPosition(g.x||0,g.y||0),void 0!==g.frame&&P.setFrame(g.frame),g.animationRunner&&P.setAnimationRunner(g.animationRunner),g.hidden&&P.setVisible(!1),g.zIndex&&P.setZIndex(g.zIndex),void 0!==g.opacity&&P.setOpacity(g.opacity),void 0!==g.transparent&&P.setTransparent(g.transparent),void 0!==g.tooltip&&P.setTooltip(g.tooltip),{obj:P}},"sprite-batch":g=>{let P=[];P=g.children?Array.isArray(g.children)?g.children.flat():[g.children]:[];let I=[],L=[];for(var _ of P)"sprite"===_.type&&_.props.static&&!W(_.props)?L.push(_.props):I.push(_);return{obj:new V.ShpSpriteBatch(L,g=>this.getImage(g),g=>this.getPalette(g),this.camera),children:[...I]}},container:g=>{let P=new _.UiObject(new THREE.Object3D,new U.HtmlContainer);return z&&P.setPointerEvents(z),this.setupListeners(P,g),g.onFrame&&P.onFrame.subscribe(g.onFrame),g.hidden&&P.setVisible(!1),g.zIndex&&P.setZIndex(g.zIndex),P.setPosition(g.x||0,g.y||0),P.getHtmlContainer()?.setSize(g.width||0,g.height||0),{obj:P}},mesh:g=>{let P=new _.UiObject(g.children);return z&&P.setPointerEvents(z),this.setupListeners(P,g),P.setPosition(g.x||0,g.y||0),g.zIndex&&P.setZIndex(g.zIndex),g.hidden&&P.setVisible(!1),{obj:P}}}}setupListeners(g,P){const I={click:"onClick",dblclick:"onDoubleClick",mousedown:"onMouseDown",mouseenter:"onMouseEnter",mouseleave:"onMouseLeave",mouseout:"onMouseOut",mouseover:"onMouseOver",mouseup:"onMouseUp",mousemove:"onMouseMove",wheel:"onWheel"};Object.keys(I).forEach(L=>{var _=P[I[L]];_&&g.addEventListener(L,_)})}setCamera(g){this.camera=g}getImage(g){var P=this.images.get(g);if(!P)throw new Error(`Missing image "${g}"`);return P}getPalette(g){var P=this.palettes.get(g);if(!P)throw new Error(`Missing palette "${g}"`);return P}render(g){return I.renderJsx(g,this.jsxIntrinsicRenderers)}})}}}),System.register("gui/jsx/UiComponent",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("UiComponent",class{constructor(g){this.props=g,this.uiObject=this.createUiObject(g)}getUiObject(){return this.uiObject}})}}}),System.register("gui/LazyHtmlElement",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("LazyHtmlElement",class{constructor(g){this.children=new Set,this.rendered=!1,g&&this.setElement(g)}setElement(g){this.element=g}getElement(){return this.element}getChildren(){return[...this.children]}isRendered(){return this.rendered}add(...g){for(var P of g)this.children.has(P)||(this.children.add(P),this.rendered&&this.renderChild(P))}remove(...g){for(var P of g)this.children.has(P)&&(this.children.delete(P),this.rendered&&this.unrenderChild(P))}removeAll(){this.remove(...this.children)}render(){if(!this.element)throw new Error("An HTML element must be passed in the constructor or using the setter.");this.children.forEach(g=>this.renderChild(g)),this.rendered=!0}renderChild(g){g.render();var P=g.getElement();P&&this.getElement().appendChild(P)}unrenderChild(g){var P=g.getElement();P&&(g.unrender(),P.parentElement===this.getElement()&&this.getElement().removeChild(P))}unrender(){this.isRendered()&&(this.children.forEach(g=>this.unrenderChild(g)),this.rendered=!1)}})}}}),System.register("gui/Pointer",["util/PointerLock","util/math","util/disposable/CompositeDisposable","gui/PointerSprite","gui/PointerEvents","engine/type/PointerType","engine/animation/SimpleRunner","engine/Animation","engine/AnimProps","data/IniSection","util/BoxedVar"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g}],execute:function(){g("Pointer",class m{static factory(g,P,L,_,V,W){let z=U.PointerSprite.fromShpFile(g,P);z.setVisible(!1);var K=L.getCanvas();let q=new I.PointerLock(K,_),$=new m(q,z,_,K,V,W);return $.pointerEvents=new G.PointerEvents(L,$.getPosition(),_,V),$.disposables.add($.pointerEvents),$}constructor(g,P,I,U,G,W){this.pointerLock=g,this.sprite=P,this.document=I,this.canvas=U,this.canvasMetrics=G,this.mouseAcceleration=W,this.userLockMode=!1,this.userPointerVisible=!0,this.userPermissionGranted=!1,this.position={x:0,y:0},this.disposables=new _.CompositeDisposable,this.pointerType=V.PointerType.Default,this.pointerSubFrame=0,this.onMouseMove=g=>{let P=this.position;this.pointerLock.isActive()?(P.x=P.x+g.movementX,P.y=P.y+g.movementY):(P.x=(g.pageX-this.canvasMetrics.x)*(this.canvasMetrics.scaleX??1),P.y=(g.pageY-this.canvasMetrics.y)*(this.canvasMetrics.scaleY??1)),P.x=L.clamp(P.x,0,this.canvasMetrics.width-1),P.y=L.clamp(P.y,0,this.canvasMetrics.height-1),this.updateSpritePosition()}}getPosition(){return this.position}getPointerLock(){return this.pointerLock}init(){this.listenForFirstCanvasClick(),this.pointerLock.onChange.subscribe(g=>{this.sprite.setVisible(this.userPointerVisible&&g);const t=()=>{this.userLockMode&&this.pointerLock.request({unadjustedMovement:!this.mouseAcceleration.value}).catch(g=>{console.warn("Couldn't acquire pointer lock.",g),this.canvas.addEventListener("click",t,{once:!0})})};g||(this.canvas.addEventListener("click",t,{once:!0}),this.disposables.add(()=>this.canvas.removeEventListener("click",t)))}),this.document.addEventListener("mousemove",this.onMouseMove,!0),this.disposables.add(()=>this.document.removeEventListener("mousemove",this.onMouseMove,!0))}listenForFirstCanvasClick(){const t=async()=>{if(!this.userPermissionGranted)try{await this.pointerLock.request(),this.userLockMode||await this.pointerLock.exit(),this.userPermissionGranted=!0}catch(g){console.warn("Couldn't acquire initial pointer lock",g),this.canvas.addEventListener("click",t,{once:!0})}};this.canvas.addEventListener("click",t,{once:!0}),this.disposables.add(()=>this.canvas.removeEventListener("click",t))}lock(){this.userLockMode=!0,this.userPermissionGranted&&this.pointerLock.request({unadjustedMovement:!this.mouseAcceleration.value}).catch(g=>{console.warn("Couldn't reacquire pointer lock. Will attempt to require lock on next click",g),this.userPermissionGranted=!1,this.listenForFirstCanvasClick()})}unlock(){this.userLockMode=!1,this.pointerLock.exit().catch(g=>console.error("Couldn't release pointer lock. This should never happen",g))}setVisible(g){this.userPointerVisible=g,this.sprite.setVisible(g&&this.pointerLock.isActive())}getUserLockMode(){return this.userLockMode}getSprite(){return this.sprite}setPointerType(g,P=0){if(this.pointerType!==g||this.pointerSubFrame!==P){if(this.pointerType=g,this.pointerSubFrame=P,this.sprite.setAnimationRunner(void 0),[V.PointerType.Scroll,V.PointerType.NoScroll,V.PointerType.Pan].includes(g))this.sprite.setFrame(g+P);else{var I=g,L=(Object.keys(V.PointerType).map(Number).find(P=>!Number.isNaN(P)&&g<P)??this.sprite.getFrameCount())-1;if(this.sprite.setFrame(I),I<L){let g=new W.SimpleRunner,P=new K.AnimProps(new q.IniSection("dummy"),this.sprite.getFrameCount());P.loopCount=-1,P.start=I,P.loopStart=I,P.loopEnd=L,L=new z.Animation(P,new $.BoxedVar(1.5)),g.animation=L,this.sprite.setAnimationRunner(g)}}this.updateSpritePosition()}}updateSpritePosition(){let g={...this.position};var P=this.sprite.getSize(),I=Math.floor(P.width/2),_=Math.floor(P.height/2);this.pointerType>V.PointerType.Mini&&(g.x-=I,g.y-=_),[V.PointerType.Scroll,V.PointerType.NoScroll,V.PointerType.Pan].includes(this.pointerType)&&(g.x=L.clamp(g.x,0,this.canvasMetrics.width-1-P.width),g.y=L.clamp(g.y,0,this.canvasMetrics.height-1-P.height)),this.sprite.setPosition(g.x,g.y)}dispose(){this.disposables.dispose()}})}}}),System.register("gui/PointerEvents",["util/disposable/CompositeDisposable","util/array","util/math"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=(g,P)=>!!g.visible&&(g===P||!!g.parent&&U(g.parent,P)),g("PointerEvents",class{constructor(g,P,_,U){this.renderer=g,this.lockModePointer=P,this.document=_,this.canvasMetrics=U,this.disposables=new I.CompositeDisposable,this.canvasContext={handlers:new Map},this.objectContexts=new Map,this.intersectionsEnabled=!0,this.clickPaths=new Map,this.touchFingers=0,this.onDblClick=g=>{0===g.button&&this.onMouseEvent("dblclick",g)},this.onMouseMove=g=>{let P=this.getPointerPosition(g);if(this.intersectionsEnabled){let V=this.currentHoverPath?[...this.currentHoverPath]:void 0;var I=V?.[0],_=this.findObjectUnderPointer(P);let W=_?.object;if(this.currentHoverPath=void 0,W&&(this.currentHoverPath=[W],W.traverseAncestors(g=>{this.currentHoverPath.push(g)})),!L.equals(this.currentHoverPath??[],V??[])){if(V)for(var U of V)this.currentHoverPath&&this.currentHoverPath.includes(U)||this.notify("mouseleave",U,P,g,void 0,!1);if(this.currentHoverPath)for(var G of this.currentHoverPath)V&&V.includes(G)||this.notify("mouseenter",G,P,g,_,!1);I&&this.notify("mouseout",I,P,g),W&&this.notify("mouseover",W,P,g,_)}W?this.notify("mousemove",W,P,g,_):this.renderer.getScenes().forEach(I=>this.notify("mousemove",I.get3DObject(),P,g))}this.notify("mousemove","canvas",P,g)},this.onMouseDown=g=>{this.onMouseEvent("mousedown",g)},this.onMouseUp=g=>{this.onMouseEvent("mouseup",g)},this.onMouseWheel=g=>{this.onMouseEvent("wheel",g)},this.onTouchMove=g=>{if(g.preventDefault(),this.initialTouchEvent?.touches){let I=this.initialTouchEvent.touches[0];var P=[...g.changedTouches].find(g=>I.identifier===g.identifier);P&&(this.touchStartBuffer&&(clearTimeout(this.touchStartBuffer.timeoutId),this.touchStartBuffer.cb(),this.touchStartBuffer=void 0),P=this.fakeMouseEventFromTouch(P,g),this.onMouseMove(P))}},this.onTouchStart=g=>{g.preventDefault();let P=g.touches;var I,L;1<P.length?0<this.touchFingers||P[0].target===this.renderer.getCanvas()&&2===P.length&&(this.touchStartBuffer&&(clearTimeout(this.touchStartBuffer.timeoutId),this.touchStartBuffer=void 0),this.touchFingers=2,this.initialTouchEvent||(this.initialTouchEvent=g),I=this.initialTouchEvent.touches[0],L=this.fakeMouseEventFromTouch(I,g,2),this.onMouseEvent("mousedown",L)):(I=()=>{this.touchFingers=1;var I=this.fakeMouseEventFromTouch(P[0],g);this.onMouseEvent("mousedown",I)},L=setTimeout(I,50),this.touchStartBuffer={cb:I,timeoutId:L},this.initialTouchEvent=g)},this.onTouchEnd=g=>{if(g.preventDefault(),this.initialTouchEvent?.touches){let L=this.initialTouchEvent.touches[0];var P=[...g.changedTouches].find(g=>L.identifier===g.identifier);if(P){this.touchStartBuffer&&(clearTimeout(this.touchStartBuffer.timeoutId),this.touchStartBuffer.cb(),this.touchStartBuffer=void 0);var I=2===this.touchFingers?2:0;let L=this.fakeMouseEventFromTouch(P,g,I);L.touchDuration=g.timeStamp-this.initialTouchEvent.timeStamp,this.touchFingers=0,this.initialTouchEvent=void 0,this.onMouseEvent("mouseup",L)}}},this.onTouchCancel=g=>{this.onTouchEnd(g)};let G=g.getCanvas();G.addEventListener("dblclick",this.onDblClick,!1),G.addEventListener("mousemove",this.onMouseMove,!1),G.addEventListener("mousedown",this.onMouseDown,!1),G.addEventListener("mouseup",this.onMouseUp,!1),G.addEventListener("touchmove",this.onTouchMove,!1),G.addEventListener("touchstart",this.onTouchStart,!1),G.addEventListener("touchend",this.onTouchEnd,!1),G.addEventListener("touchcancel",this.onTouchCancel,!1),G.addEventListener("wheel",this.onMouseWheel,{passive:!0}),this.disposables.add(()=>{G.removeEventListener("dblclick",this.onDblClick,!1),G.removeEventListener("mousemove",this.onMouseMove,!1),G.removeEventListener("mousedown",this.onMouseDown,!1),G.removeEventListener("mouseup",this.onMouseUp,!1),G.removeEventListener("touchmove",this.onTouchMove,!1),G.removeEventListener("touchstart",this.onTouchStart,!1),G.removeEventListener("touchend",this.onTouchEnd,!1),G.removeEventListener("touchcancel",this.onTouchCancel,!1),G.removeEventListener("wheel",this.onMouseWheel,!1)})}addEventListener(g,P,I,L=!1){let _="canvas"===g?this.canvasContext:this.getOrCreateObjectContext(g),U=_.handlers.get(P);return U||(U=[],_.handlers.set(P,U)),U.push({callback:I,useCapture:L}),()=>this.removeEventListener(g,P,I,L)}removeEventListener(g,P,I,L=!1){let _="canvas"===g?this.canvasContext:this.objectContexts.get(g);if(_&&_.handlers.has(P)){let U=_.handlers.get(P);U=U.filter(g=>!(g.callback===I&&g.useCapture===L)),U.length?_.handlers.set(P,U):_.handlers.delete(P),_.handlers.size||"canvas"===g||this.objectContexts.delete(g)}}getOrCreateObjectContext(g){if(!g)throw new Error("Undefined Object3D instance.");let P=this.objectContexts.get(g);return P||(P={handlers:new Map},this.objectContexts.set(g,P)),P}fakeMouseEventFromTouch(g,P,I=0){var L=this.computeTouchPosition(g);return{offsetX:L.x,offsetY:L.y,button:I,touchId:g.identifier,isTouch:!0,virtual:!1,detail:1,altKey:P.altKey,ctrlKey:P.ctrlKey,metaKey:P.metaKey,shiftKey:P.shiftKey,timeStamp:P.timeStamp}}computeTouchPosition(g){let P={x:(g.pageX-this.canvasMetrics.x)*(this.canvasMetrics.scaleX??1),y:(g.pageY-this.canvasMetrics.y)*(this.canvasMetrics.scaleY??1)};return P.x=_.clamp(P.x,0,this.canvasMetrics.width-1),P.y=_.clamp(P.y,0,this.canvasMetrics.height-1),P}onMouseEvent(g,P){let I=this.getPointerPosition(P);var L=this.findObjectUnderPointer(I);if(L?this.notify(g,L.object,I,P,L):this.renderer.getScenes().forEach(L=>this.notify(g,L.get3DObject(),I,P)),this.notify(g,"canvas",I,P),"mousedown"===g||"mouseup"===g){let U=L?.object,G=[];if(U&&(G=[U],U.traverseAncestors(g=>{G.push(g)})),"mousedown"===g)this.clickPaths.set(P.button,G);else{let g=this.clickPaths.get(P.button);this.clickPaths.delete(P.button);let U=!1;for(var _ of G)if(g?.includes(_)){this.notify("click",_,I,P,L),U=!0;break}U||this.renderer.getScenes().forEach(g=>this.notify("click",g.get3DObject(),I,P)),this.notify("click","canvas",I,P)}}}getPointerPosition(g){return this.document.pointerLockElement?this.lockModePointer:{x:g.isTouch?g.offsetX:g.offsetX*(this.canvasMetrics.scaleX??1),y:g.isTouch?g.offsetY:g.offsetY*(this.canvasMetrics.scaleY??1)}}findObjectUnderPointer(g){let P=this.renderer.getScenes(),I=this.groupObjectsByScene();for(let _=P.length-1;0<=_;_--){let G=new THREE.Raycaster;var L=this.normalizePointer(g,P[_].viewport);G.setFromCamera(L,P[_].camera),L=I.get(P[_].scene).filter(g=>U(g,P[_].get3DObject()));let V=G.intersectObjects(L,!0);if(V.length){if(1===V.length)return V[0];let g=new Set(V.map(g=>g.object));return V.forEach(P=>{g.has(P.object)&&P.object.traverseAncestors(P=>{g.has(P)&&g.delete(P)})}),V.filter(P=>g.has(P.object))[0]}}}normalizePointer(g,P){return{x:(g.x-P.x)/P.width*2-1,y:-(g.y-P.y)/P.height*2+1}}groupObjectsByScene(){let g=new Map;return this.renderer.getScenes().forEach(P=>g.set(P.get3DObject(),[])),[...this.objectContexts.keys()].forEach(P=>{if("Scene"!==P.type){let I=P;for(;I.parent;)I=I.parent;"Scene"===I.type&&g.get(I).push(P)}}),g}notify(g,P,I,L,_,U=!0){let G="canvas"===P?this.canvasContext:this.objectContexts.get(P),V=G?.handlers.get(g);if(V&&V.length||"canvas"!==P&&P.parent&&U&&this.notify(g,P.parent,I,L,_),V&&V.length){let G=!0,W=!1,z=V.filter(g=>g.useCapture),K=V.filter(g=>!g.useCapture),q=[...z,...K];for(let V of q){let z=!0;if(V.callback({type:g,target:"canvas"!==P?P:void 0,pointer:{...I},intersection:_,button:L.button,isTouch:!!L.isTouch,virtual:!!L.virtual,touchDuration:L.touchDuration,clicks:L.detail,altKey:L.altKey,ctrlKey:L.ctrlKey,metaKey:L.metaKey,shiftKey:L.shiftKey,timeStamp:L.timeStamp,wheelDeltaY:L.deltaY??0,stopPropagation:()=>{G=!1,z=!1},stopImmediatePropagation:()=>{G=!1,z=!1,W=!0}}),z&&"canvas"!==P&&!V.useCapture&&P.parent&&U&&this.notify(g,P.parent,I,L,_),W&&(G=!1),W)break}}}virtualClick(g,{button:P=0,clicks:I=1,mods:L}={}){let _={offsetX:g.x,offsetY:g.y,button:P,isTouch:!0,virtual:!0,detail:I,altKey:!!L?.altKey,ctrlKey:!!L?.ctrlKey,metaKey:!!L?.metaKey,shiftKey:!!L?.shiftKey,timeStamp:Date.now()};this.onMouseEvent("mousedown",_),this.onMouseEvent("mouseup",_)}resetTouchState(){this.touchStartBuffer&&(clearTimeout(this.touchStartBuffer.timeoutId),this.touchStartBuffer=void 0),this.touchFingers=0,this.initialTouchEvent=void 0}dispose(){this.touchStartBuffer&&(clearTimeout(this.touchStartBuffer.timeoutId),this.touchStartBuffer=void 0),this.disposables.dispose()}})}}}),System.register("gui/PointerSprite",["gui/UiObject","engine/gfx/ImageUtils","gui/HtmlContainer"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class a extends I.UiObject{static fromShpFile(g,P){return new this(L.ImageUtils.convertShpToCanvas(g,P),{width:g.width,height:g.height},g.numImages)}constructor(g,P,I){super(new THREE.Object3D,new _.HtmlContainer),this.images=g,this.size=P,this.frameCount=I,this.currentFrame=0}setAnimationRunner(g){this.animationRunner=g}getAnimationRunner(){return this.animationRunner}update(g){super.update(g),this.animationRunner&&(this.animationRunner.tick(g),this.animationRunner.shouldUpdate()&&this.setFrame(this.animationRunner.getCurrentFrame()))}getSize(){return this.size}setFrame(g){if(g!==this.currentFrame){if(g<0||this.frameCount<=g)throw new RangeError(`Pointer frame index out of bounds (index=${g}, length=${this.frameCount})`);this.currentFrame=g,this.drawFrame(g)}}drawFrame(g){this.targetContext&&(this.targetContext.clearRect(0,0,this.size.width,this.size.height),this.targetContext.drawImage(this.images,g*this.size.width,0,this.size.width,this.size.height,0,0,this.size.width,this.size.height))}getFrame(){return this.currentFrame}getFrameCount(){return this.frameCount}create3DObject(){if(super.create3DObject(),!this.targetContext){let P=document.createElement("canvas"),I=this.getHtmlContainer();I.setTranslateMode(!0);let L=I.getElement();L.appendChild(P),L.style.zIndex=""+a.HTML_ZINDEX;var g=P.getContext("2d",{alpha:!0});if(!g)throw new Error("Couldn't create pointer canvas context");this.targetContext=g,this.drawFrame(this.currentFrame)}}destroy(){super.destroy()}},g("PointerSprite",U),U.HTML_ZINDEX=100}}}),System.register("gui/ReactFormat",["react"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=/(\[(?:[^\]]+)\]\((?:https?:\/\/[^\s]+|mailto:[^\s]+)\))|(https?:\/\/[^\s]+|mailto:[^\s]+)/g,_=/^\[([^\]]+)\]\((https?:\/\/[^\s]+|mailto:[^\s]+)\)$/,g("ReactFormat",class{static formatMultiline(g,P){return g.split(/\n/g).map((g,L)=>L?I.createElement(I.Fragment,{key:L},I.createElement("br",null),P(g)):g)}static formatUrls(g){return I.createElement(I.Fragment,null,g.split(L).filter(Boolean).map((g,P)=>{if(!L.test(g))return g;let U,G;var V=g.match(_);return V?[,U,G]=V:U=G=g,I.createElement("a",{key:P,href:G,rel:"noopener noreferrer",target:"_blank"},U)}))}})}}}),System.register("gui/replay/ReplayExistsError",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){I=class extends Error{},g("ReplayExistsError",I)}}}),System.register("gui/replay/ReplayMeta",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("gui/replay/ReplayStorage",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("gui/replay/ReplayStorageError",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){I=class extends Error{},g("ReplayStorageError",I)}}}),System.register("gui/replay/ReplayStorageFileSystem",["data/vfs/VirtualFile","data/DataStream","data/vfs/StorageQuotaError","network/gamestate/Replay","gui/replay/ReplayStorageError"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){g("ReplayStorageFileSystem",V=class d{constructor(g,P){this.dir=g,this.sentry=P}async getManifest(g=!1){if(g)return await this.rebuildManifest();if(!await this.dir.containsEntry(d.manifestFileName))return[];let P=(await this.dir.openFile(d.manifestFileName)).readAsString("utf-8");if(!P.length)return[];try{return JSON.parse(P)}catch(g){return console.error("Replay manifest is corrupt",g),this.sentry?.captureException(g,g=>(g.addAttachment({filename:d.manifestFileName,data:P}),g)),await this.deleteManifest(),await this.rebuildManifest()}}async saveManifest(g){let P=new L.DataStream;P.writeString(JSON.stringify(g),"utf-8");var U=new I.VirtualFile(P,d.manifestFileName);try{await this.dir.writeFile(U)}catch(g){if(g instanceof _.StorageQuotaError)throw g;throw new G.ReplayStorageError(`Failed to save manifest (${g.message})`,{cause:g})}}async deleteManifest(){await this.dir.deleteFile(d.manifestFileName)}async rebuildManifest(){var g,P,I,L=await this.getManifest();let G=0;for await(g of this.dir.getEntries())g.endsWith(U.Replay.extension)&&G++;if(G===L.length)return L;console.info("Rebuilding replay index...");let V=new Map;for await(P of this.dir.getRawFiles())P.name.endsWith(U.Replay.extension)&&V.set(P.name,P);let W=[];for(I of L){var z=this.getReplayFileName(I);V.has(z)&&(W.push(I),V.delete(z))}if(0<L.length-W.length&&console.info(`Removed ${L.length-W.length} orphaned entries from index`),V.size){for(var K of V.values()){var q=K.lastModified;W.unshift({id:THREE.Math.generateUUID(),name:K.name.replace(d.unsavedReplayPrefix,"").replace(U.Replay.extension,""),keep:!K.name.startsWith(d.unsavedReplayPrefix),timestamp:q})}W.sort((g,P)=>g.timestamp===P.timestamp?g.name.localeCompare(P.name):P.timestamp-g.timestamp),console.info(`Added ${V.size} new entries to replay index`)}try{await this.saveManifest(W)}catch(g){if(!(g instanceof _.StorageQuotaError))throw g;console.error("Failed to save rebuilt manifest because storage is full",g)}return console.info("Rebuild finished."),W}async deleteAllReplays(){for await(var g of this.dir.getEntries())g.endsWith(U.Replay.extension)&&await this.dir.deleteFile(g);await this.deleteManifest()}async getReplayData(g){var P=this.getReplayFileName(g);if(!await this.dir.containsEntry(P))throw new Error(`Replay file "${P}" not found.`);return await this.dir.getRawFile(P)}async hasReplayData(g){var P=this.getReplayFileName(g);return await this.dir.containsEntry(P)}async saveReplayData(g,P){let U=new L.DataStream;U.writeString(P,"utf-8");var V=this.getReplayFileName(g),W=new I.VirtualFile(U,V);try{await this.dir.writeFile(W)}catch(g){if(g instanceof _.StorageQuotaError)throw g;if(g instanceof TypeError)throw new G.ReplayStorageError(`Failed to save replay file "${V}" (${g.message})`,{cause:g});throw new G.ReplayStorageError(`Failed to save replay file (${g.message})`,{cause:g})}}async deleteReplayData(g){await this.dir.deleteFile(this.getReplayFileName(g))}getReplayFileName(g){return(g.keep?"":d.unsavedReplayPrefix)+g.name+U.Replay.extension}}),V.manifestFileName="_index.json",V.unsavedReplayPrefix="Unsaved_"}}}),System.register("gui/replay/ReplayStorageMemStorage",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("ReplayStorageMemStorage",class{constructor(){this.replays=new Map}async getManifest(){return this.manifest?JSON.parse(this.manifest):[]}async saveManifest(g){this.manifest=JSON.stringify(g)}async getReplayData(g){var P=this.replays.get(g.id);if(!P)throw new Error(`Replay "${g.id}" not found in memory`);return P}async hasReplayData(g){return this.replays.has(g.id)}async saveReplayData(g,P){this.replays.set(g.id,P)}async deleteReplayData(g){this.replays.delete(g.id)}})}}}),System.register("gui/replay/ReplayStorageMigration",["network/gamestate/Replay","gui/replay/ReplayStorageFileSystem"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("ReplayStorageMigration",_=class i{constructor(g,P,I,L,_){this.splashScreen=g,this.strings=P,this.replayDir=I,this.localPrefs=L,this.storageFileSystem=_}async migrate(){4!==Number(this.localPrefs.getItem(i.migratedMarker)||0)&&(console.info("Running replay storage migrations..."),await this.runMigrationTo4(),this.localPrefs.setItem(i.migratedMarker,"4"),console.info("Migrations finished."))}async runMigrationTo4(){for(var g of(this.localPrefs.removeItem("_r_replayList"),this.localPrefs.listItems()))g.startsWith("_r_replay_")&&this.localPrefs.removeItem(g);let P=this.replayDir;var _="replays.json";if(await P.containsEntry(_))if(await P.containsEntry(L.ReplayStorageFileSystem.manifestFileName))await P.deleteFile(_);else{var U=(await P.openFile(_)).readAsString("utf-8");let L=[];try{L=JSON.parse(U)}catch(g){}if(L.length){this.splashScreen.setLoadingText(this.strings.get("ts:replay_storage_migrating",0));let U=[],$=new Set;for await(var G of P.getEntries())G.endsWith(I.Replay.extension)&&$.add(G);let Q=new Map,Y=new Set;for(var V of L){var W="replay_"+V.id+I.Replay.extension;if($.has(W)){let g={id:THREE.Math.generateUUID(),name:I.Replay.sanitizeFileName(V.name),keep:V.keep,timestamp:V.timestamp};U.push(g);let P=this.storageFileSystem.getReplayFileName(g),L=1;for(;Y.has(P.toLowerCase());)P=P.replace(I.Replay.extension,""),1<L&&(P=P.replace(/ \(\d+\)$/,"")),P+=` (${++L})`+I.Replay.extension;1<L&&(g.name+=` (${L})`),Q.set(W,P),Y.add(P.toLowerCase())}}await P.deleteFile(_);try{let g=0;var z,K,q=Q.size;for([z,K]of Q){let I=await P.openFile(z);I.filename=K,await P.writeFile(I),await P.deleteFile(z),this.splashScreen.setLoadingText(this.strings.get("ts:replay_storage_migrating",Math.floor(++g/q*100)))}await this.storageFileSystem.saveManifest(U)}catch(g){console.error(g)}}else await P.deleteFile(_)}}}),_.migratedMarker="_r_replays_migrated"}}}),System.register("gui/ReplayManager",["network/gamestate/Replay","gui/replay/ReplayExistsError"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("ReplayManager",class{constructor(g){this.storage=g}async loadList(g=!1){return await this.storage.getManifest(g)}async loadSerializedReplay(g){return await this.storage.getReplayData(g)}async loadReplay(g){let P=await this.loadSerializedReplay(g),L=new I.Replay;return L.unserialize("string"==typeof P?P:await P.text(),g),L}async saveReplay(g,P=!1){var I=g.name;if(!I)throw new Error("Replay is not initialized");var L=THREE.Math.generateUUID(),_=g.serialize();let U={id:L,name:I,keep:P,timestamp:g.timestamp},G=1;for(;await this.storage.hasReplayData(U);)1<G&&(U.name=U.name.replace(/ \(\d+\)$/,"")),U.name+=` (${++G})`;let V=await this.loadList(),W=V.filter(g=>!g.keep);if(50<W.length)for(var z of W.slice(50))await this.storage.deleteReplayData(z),V.splice(V.indexOf(z),1);return V.unshift(U),await this.storage.saveReplayData(U,_),await this.storage.saveManifest(V),L}async keepReplay(g,P){let _=await this.loadList();var U=_.find(P=>P.id===g);if(U){var G={...U,name:I.Replay.sanitizeFileName(P),keep:!0};if(await this.storage.hasReplayData(G))throw new L.ReplayExistsError(`A replay with name "${G.name}" already exists`);let g=await this.storage.getReplayData(U);var V="string"==typeof g?g:await g.text();await this.storage.deleteReplayData(U),await this.storage.saveReplayData(G,V),Object.assign(U,G),await this.storage.saveManifest(_)}}async deleteReplay(g){await this.storage.deleteReplayData(g);let P=await this.loadList();var I=P.findIndex(P=>P.id===g.id);-1!==I&&(P.splice(I,1),await this.storage.saveManifest(P))}async importReplay(g){return new Promise((P,L)=>{let _=new FileReader;_.onload=async _=>{try{var U=g.name.replace(I.Replay.extension,"");let L=new I.Replay;L.unserialize(_.target.result,{name:U,timestamp:g.lastModified}),await this.saveReplay(L,!0),P(L)}catch(g){L(g)}},_.onerror=()=>{L(_.error)},_.readAsText(g,"utf-8")})}})}}}),System.register("gui/screen/Controller",["util/event"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("Controller",class{constructor(){this.screens=new Map,this.screenStack=[],this._onScreenChange=new I.EventDispatcher}get onScreenChange(){return this._onScreenChange.asEvent()}addScreen(g,P){this.screens.set(g,P),P.setController(this)}hasScreen(g){return this.screens.has(g)}async leaveCurrentScreen(){await this.popScreen()}async goToScreenBlocking(g,P){for(;this.screenStack.length;)await this.leaveCurrentScreen();await this.pushScreen(g,P)}goToScreen(g,P){this.goToScreenBlocking(g,P)}async pushScreen(g,P){let I=this.screens.get(g);if(!I)throw new Error("Invalid screen type "+g);this.screenStack.length&&await(this.screenStack[this.screenStack.length-1].onStack?.()),this.screenStack.push(I),this._onScreenChange.dispatch(this,g),I.onEnter(P)}async popScreen(g){this.screenStack.length&&(await this.screenStack.pop().onLeave(),this._onScreenChange.dispatch(this,void 0)),this.screenStack.length&&this.screenStack[this.screenStack.length-1].onUnstack?.(g)}rerenderCurrentScreen(){this.screenStack.length&&this.screenStack[this.screenStack.length-1].onViewportChange?.()}getCurrentScreen(){return this.screenStack.length?this.screenStack[this.screenStack.length-1]:void 0}destroy(){for(var g of this.screens.values())g.setController(void 0);this.screens.clear(),this.screenStack.length=0}})}}}),System.register("gui/screen/game/ChatNetHandler",["util/disposable/CompositeDisposable","network/chat/ChatMessage","network/gservConfig"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("ChatNetHandler",class{constructor(g,P,U,G,V,W,z,K,q){this.gservCon=g,this.wolCon=P,this.messageList=U,this.chatHistory=G,this.chatMessageFormat=V,this.localPlayer=W,this.game=z,this.replayRecorder=K,this.mutedPlayers=q,this.disposables=new I.CompositeDisposable,this.handleMessage=g=>{if(g.from===this.localPlayer.name&&g.to.type===L.ChatRecipientType.Whisper)return this.messageList.addChatMessage(this.chatMessageFormat.formatPrefixPlain(g)+" "+g.text,"mediumpurple"),void this.chatHistory.addChatMessage(g);var P=this.chatMessageFormat.formatPrefixPlain(g);let I;if(g.to.type!==L.ChatRecipientType.Page||g.from!==this.gservCon.getServerName()&&g.from!==this.wolCon.getServerName()){let P;if(g.to.type===L.ChatRecipientType.Whisper)P=g.from,I="mediumpurple";else{if(g.to.type!==L.ChatRecipientType.Channel||![_.RECIPIENT_ALL,_.RECIPIENT_TEAM].includes(g.to.name))return;{let L=this.game.getPlayerByName(g.from);P=L.name,I=L.color.asHexString()}}if(this.mutedPlayers.has(P))return}else I="yellow";g.to.type===L.ChatRecipientType.Channel&&g.to.name===_.RECIPIENT_ALL&&this.replayRecorder.recordChatMessage(this.game.currentTick,g.from,g.text),this.messageList.addChatMessage(P+" "+g.text,I),this.chatHistory.addChatMessage(g),g.to.type===L.ChatRecipientType.Whisper&&g.to.name!==this.wolCon.getServerName()&&g.to.name!==this.gservCon.getServerName()&&(this.chatHistory.lastWhisperFrom.value=g.from)}}init(){this.wolCon.onChatMessage.subscribe(this.handleMessage),this.disposables.add(()=>this.wolCon.onChatMessage.unsubscribe(this.handleMessage)),this.gservCon.onChatMessage.subscribe(this.handleMessage),this.disposables.add(()=>this.gservCon.onChatMessage.unsubscribe(this.handleMessage))}submitMessage(g,P){var I;this.gservCon.isOpen()?P.type===L.ChatRecipientType.Channel&&P.name===_.RECIPIENT_ALL?g.startsWith("/")?(I=this.wolCon.getCurrentUser(),this.wolCon.isOpen()&&I&&this.wolCon.privmsg([I],g)):this.gservCon.sayChannel(g):P.type===L.ChatRecipientType.Channel&&P.name===_.RECIPIENT_TEAM?(I=this.game.alliances.getAllies(this.localPlayer).filter(g=>!g.isAi).map(g=>g.name),this.gservCon.privmsg([...I,this.localPlayer.name],g)):P.type===L.ChatRecipientType.Whisper&&this.wolCon.isOpen()&&(this.wolCon.privmsg([P.name],g),this.chatHistory.lastWhisperTo.value=P.name):console.warn("Can't send chat message. Network connection is already closed.")}dispose(){this.disposables.dispose()}})}}}),System.register("gui/screen/game/ChatTypingHandler",["network/chat/ChatMessage","network/gservConfig"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("ChatTypingHandler",class{constructor(g,P,I,L){this.keyboardHandler=g,this.arrowScrollHandler=P,this.messageList=I,this.chatHistory=L,this.isTyping=!1}startTyping(){this.isTyping||(this.keyboardHandler.pause(),this.arrowScrollHandler.pause(),this.messageList.isComposing=!0,this.isTyping=!0)}endTyping(){this.isTyping&&(this.keyboardHandler.unpause(),this.arrowScrollHandler.unpause(),this.messageList.isComposing=!1,this.isTyping=!1)}handleKeyDown(g){this.isTyping||("Enter"===g.key?this.startTyping():"Backspace"===g.key&&(this.chatHistory.lastComposeTarget.value={type:I.ChatRecipientType.Channel,name:L.RECIPIENT_TEAM},this.startTyping()))}handleKeyUp(g){}dispose(){this.keyboardHandler.unpause(),this.arrowScrollHandler.unpause(),this.messageList.isComposing=!1}})}}}),System.register("gui/screen/game/CombatantUi",["react","gui/screen/game/worldInteraction/PlacementMode","game/action/ActionType","util/disposable/CompositeDisposable","engine/sound/SoundKey","engine/sound/ChannelType","game/order/OrderType","game/action/OrderUnitsAction","gui/screen/game/worldInteraction/keyboard/KeyCommandType","engine/util/MapPanningHelper","gui/screen/game/worldInteraction/keyboard/command/SelectGroupCmd","gui/screen/game/worldInteraction/keyboard/command/CenterGroupCmd","gui/screen/game/component/hud/viewmodel/SidebarModel","game/event/EventType","gui/screen/game/worldInteraction/SellMode","gui/screen/game/worldInteraction/keyboard/command/LastRadarEventCmd","game/player/production/ProductionQueue","engine/type/ObjectType","game/action/UpdateQueueAction","gui/screen/game/worldInteraction/RepairMode","gui/screen/game/worldInteraction/keyboard/KeyCommand","gui/screen/game/worldInteraction/PlanningMode","game/order/OrderFeedbackType","gui/screen/game/worldInteraction/keyboard/command/SelectNextUnitCmd","gui/screen/game/worldInteraction/keyboard/command/SetCameraLocationCmd","gui/screen/game/worldInteraction/keyboard/command/GoToCameraLocationCmd","gui/screen/game/worldInteraction/SpecialActionMode","game/SuperWeapon","gui/screen/game/worldInteraction/keyboard/command/CenterViewCmd","gui/screen/game/worldInteraction/keyboard/command/FollowUnitCmd","gui/screen/game/worldInteraction/PendingPlacementHandler","gui/screen/game/component/hud/commandBar/CommandBarButtonType","gui/screen/game/worldInteraction/BeaconMode","gui/screen/mainMenu/main/ReportBug","gui/screen/game/worldInteraction/keyboard/command/CenterBaseCmd","gui/screen/game/worldInteraction/keyboard/command/SelectTypeByCmd"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g},function(g){ce=g},function(g){he=g},function(g){ue=g},function(g){de=g},function(g){ge=g},function(g){pe=g},function(g){me=g},function(g){fe=g},function(g){ye=g},function(g){Te=g},function(g){ve=g},function(g){be=g}],execute:function(){g("CombatantUi",class{constructor(g,P,I,L,_,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe){this.game=g,this.player=P,this.isSinglePlayer=I,this.actionQueue=L,this.actionFactory=_,this.sidebarModel=G,this.renderer=V,this.worldScene=W,this.soundHandler=z,this.messageList=K,this.sound=q,this.eva=$,this.worldInteractionFactory=Q,this.gameMenu=Y,this.pointer=Z,this.runtimeVars=X,this.speedCheat=J,this.strings=ee,this.tauntHandler=te,this.renderableManager=re,this.superWeaponFxHandler=se,this.beaconFxHandler=ae,this.messageBoxApi=ne,this.discordUrl=oe,this.disposables=new U.CompositeDisposable}init(g){let P=this.game.getUnitSelection(),I=L.PlacementMode.factory(this.game,this.player,this.renderer,this.worldScene,this.eva);this.placementMode=I,this.disposables.add(I);let U=me.PendingPlacementHandler.factory(this.game,this.player,this.renderer,this.worldScene);U.init(),this.disposables.add(U),I.onBuildingPlaceRequest.subscribe(({rules:g,tile:P})=>{U.pushPlacementInfo({rules:g,tile:P}),this.pushAction(_.ActionType.PlaceBuilding,I=>{I.buildingRules=g,I.tile={x:P.rx,y:P.ry}})});let W=X.SellMode.factory(this.game,this.player,this.sidebarModel,this.pointer,this.renderer);this.sellMode=W,this.disposables.add(W),W.onExecute.subscribe(g=>{this.pushAction(_.ActionType.SellObject,P=>{P.objectId=g.id})});let z=se.RepairMode.factory(this.game,this.player,this.sidebarModel,this.pointer,this.renderer);this.repairMode=z,this.disposables.add(z);let K=ye.BeaconMode.factory(this.pointer,this.renderer);this.beaconMode=K,this.disposables.add(K),z.onExecute.subscribe(g=>{this.pushAction(_.ActionType.ToggleRepair,P=>{P.buildingId=g.id}),this.sound.play(G.SoundKey.GenericClick,V.ChannelType.Ui)}),K.onExecute.subscribe(g=>this.handleBeacon(g));let q=this.worldInteractionFactory.create();this.worldInteraction=q,q.init(),this.disposables.add(q);let $=new ne.PlanningMode(this.player,this.messageList,this.sound,this.strings,this.worldScene,P,q.unitSelectionHandler,this.renderer,q.targetLines,this.game.rules.general.maxWaypointPathLength);this.planningMode=$,this.disposables.add($),this.disposables.add(()=>this.specialMode?.dispose()),I.init(),this.initKeyboardCommands(q),this.initGameEventListeners(),this.initGameMenuListeners(),this.initHudEventListeners(g,W,z,K,q),this.lastSelectionHash=P.getHash(),q.unitSelectionHandler.onUserSelectionChange.subscribe(g=>{if($.isActive()){var I=$.updateSelection(g.selection);if(I)for(var L of I)P.addToSelection(L)}this.lastSelectionHash=P.getHash(),this.pushAction(_.ActionType.SelectUnits,g=>{g.unitIds=P.getSelectedUnits().map(g=>g.id)})}),q.unitSelectionHandler.onUserSelectionUpdate.subscribe(g=>this.soundHandler.handleSelectionChangeEvent(g)),q.defaultActionHandler.onOrder.subscribe(({orderType:g,terminal:P,feedbackType:I,feedbackUnit:L,target:_})=>{$.isActive()?$.pushOrder(g,_,P):this.pushOrder(g,_,I,L)})}handleHudChange(g){this.worldInteraction&&this.initHudEventListeners(g,this.sellMode,this.repairMode,this.beaconMode,this.worldInteraction)}dispose(){this.disposables.dispose()}initGameEventListeners(){let e=g=>{g.isTechno()&&g.owner===this.player&&(g.isBuilding()||Number.isFinite(g.rules.buildLimit)||g.isVehicle()&&g.transportTrait||this.game.rules.general.padAircraft.includes(g.name))&&(this.sidebarModel.updateAvailableObjects(this.game.art),this.soundHandler.handleAvailableObjectsUpdate(this.player.production.getAvailableObjects()))},g=this.game.getWorld();this.sidebarModel.updateAvailableObjects(this.game.art),g.onObjectSpawned.subscribe(e),g.onObjectRemoved.subscribe(e),this.disposables.add(()=>g.onObjectSpawned.unsubscribe(e),()=>g.onObjectRemoved.unsubscribe(e)),this.disposables.add(this.game.events.subscribe(Z.EventType.BuildingInfiltration,g=>{g.source.owner===this.player&&this.sidebarModel.updateAvailableObjects(this.game.art)})),this.disposables.add(this.game.events.subscribe(Z.EventType.ObjectOwnerChange,g=>{!g.target.isBuilding()||g.prevOwner!==this.player&&g.target.owner!==this.player||(this.sidebarModel.updateAvailableObjects(this.game.art),this.soundHandler.handleAvailableObjectsUpdate(this.player.production.getAvailableObjects()))})),this.player.production.onQueueUpdate.subscribe(g=>{this.sidebarModel.updateFromQueue(g);var P=this.placementMode.getBuilding();P&&!this.player.production.getQueueForObject(P).find(P).length&&this.worldInteraction.setMode(void 0),this.soundHandler.handleProductionQueueUpdate(g)});let i=()=>{this.sidebarModel.updateSuperWeapons(),this.specialMode&&this.worldInteraction.getMode()===this.specialMode&&!this.player.superWeaponsTrait.getAll().find(g=>g.rules.type===this.specialMode.superWeaponType)&&(this.worldInteraction.setMode(void 0),this.specialMode.dispose(),this.specialMode=void 0)};this.renderer.onFrame.subscribe(i),this.disposables.add(()=>this.renderer.onFrame.unsubscribe(i)),this.disposables.add(this.game.events.subscribe(g=>{g.type===Z.EventType.PowerChange&&g.target===this.player&&(this.sidebarModel.powerGenerated=g.power,this.sidebarModel.powerDrained=g.drain)}))}initGameMenuListeners(){const e=(g,P)=>{this.pushAction(_.ActionType.ToggleAlliance,I=>{I.toPlayer=P,I.toggle=g})};this.gameMenu.onToggleAlliance.subscribe(e),this.disposables.add(()=>this.gameMenu.onToggleAlliance.unsubscribe(e))}initHudEventListeners(g,P,L,_,U){g.onSidebarSlotClick.subscribe(g=>this.handleSidebarSlotClick(g)),g.onSidebarTabClick.subscribe(()=>{this.sound.play(G.SoundKey.GUITabSound,V.ChannelType.Ui)}),g.onRepairButtonClick.subscribe(()=>{U.isEnabled()&&(this.sidebarModel.repairMode?U.setMode(void 0):U.setMode(L),this.sound.play(G.SoundKey.GenericClick,V.ChannelType.Ui))}),g.onSellButtonClick.subscribe(()=>{U.isEnabled()&&(this.sidebarModel.sellMode?U.setMode(void 0):U.setMode(P),this.sound.play(G.SoundKey.GenericClick,V.ChannelType.Ui))});let z=this.game.rules.audioVisual.creditTicks;g.onCreditsTick.subscribe(g=>{this.sound.play("up"===g?z[0]:z[1],V.ChannelType.CreditTicks)}),g.onMessagesTick.subscribe(()=>{this.sound.play(G.SoundKey.MessageCharTyped,V.ChannelType.Ui)}),g.onScrollButtonClick.subscribe(g=>{this.sound.play(g?G.SoundKey.GenericClick:G.SoundKey.ScoldSound,V.ChannelType.Ui)});let K=!1,q=U.unitSelectionHandler;g.onCommandBarButtonClick.subscribe(g=>{switch(g){case fe.CommandBarButtonType.BugReport:if(!this.discordUrl)break;this.gameMenu.open(),this.messageBoxApi.show(I.createElement(Te.ReportBug,{discordUrl:this.discordUrl,strings:this.strings}),this.strings.get("GUI:OK"));break;case fe.CommandBarButtonType.Beacon:U.getMode()!==_&&U.setMode(_);break;case fe.CommandBarButtonType.Cheer:this.pushOrder(W.OrderType.Cheer,void 0);break;case fe.CommandBarButtonType.Deploy:this.handleDeploy();break;case fe.CommandBarButtonType.Guard:this.handleGuard();break;case fe.CommandBarButtonType.PlanningMode:var P;this.planningMode.isActive()?(P=this.planningMode.exit(),this.sound.play(G.SoundKey.EndPlanningModeSound,V.ChannelType.Ui),this.queueOrders(P),K||(this.messageList.addUiFeedbackMessage(this.strings.get("MSG:PlanningModeIntro3")),K=!0)):(this.planningMode.enter(),this.planningMode.updateSelection(U.unitSelectionHandler.getSelectedUnits()),this.sound.play(G.SoundKey.StartPlanningModeSound,V.ChannelType.Ui),K||this.messageList.addUiFeedbackMessage(this.strings.get("MSG:PlanningModeIntro1Button")));break;case fe.CommandBarButtonType.Stop:this.handleStop();break;case fe.CommandBarButtonType.Team01:this.handleCommandBarTeam(1,q);break;case fe.CommandBarButtonType.Team02:this.handleCommandBarTeam(2,q);break;case fe.CommandBarButtonType.Team03:this.handleCommandBarTeam(3,q);break;case fe.CommandBarButtonType.TypeSelect:q.selectByType();break;default:console.warn("Unhandled command type "+g)}})}handleSidebarSlotClick(g){if(this.worldInteraction.isEnabled())if((g=g.isTouch&&0===g.button&&g.touchDuration&&300<g.touchDuration?{...g,shiftKey:!0,button:2}:g).target.type!==Y.SidebarItemTargetType.Special){const L=g.target.rules;let U=this.player.production.getQueueForObject(L),W=U.find(L);var P=W.reduce((g,P)=>g+P.quantity,0);let z=!1;if(0===g.button)if(U.status===ee.QueueStatus.Ready&&L.type===te.ObjectType.Building)W[0]===U.getFirst()?(this.placementMode.setBuilding(L),this.worldInteraction.setMode(this.placementMode)):this.eva.play("EVA_UnableToComply");else if(U.status===ee.QueueStatus.OnHold&&W[0]===U.getFirst())this.pushAction(_.ActionType.UpdateQueue,g=>{g.queueType=U.type,g.updateType=re.UpdateType.Resume});else{var I=Math.min(U.maxSize-U.currentSize,U.maxItemQuantity-P);let W=Math.min(g.shiftKey?5:1,I);if(W<=0)L.type===te.ObjectType.Building?this.eva.play("EVA_UnableToComply"):(z=!0,this.sound.play(G.SoundKey.ScoldSound,V.ChannelType.Ui));else{let g=this.worldInteraction.getLastKeyModifiers()?.ctrlKey??!1;this.pushAction(_.ActionType.UpdateQueue,P=>{P.queueType=U.type,P.updateType=g?re.UpdateType.AddNext:re.UpdateType.Add,P.item=L,P.quantity=W})}}else{if(2!==g.button)return;if(U.status===ee.QueueStatus.Active&&W[0]===U.getFirst())this.pushAction(_.ActionType.UpdateQueue,g=>{g.queueType=U.type,g.updateType=re.UpdateType.Pause});else if(W.length&&[ee.QueueStatus.Ready,ee.QueueStatus.OnHold,ee.QueueStatus.Active].includes(U.status)){let I=Math.min(P,g.shiftKey?Number.POSITIVE_INFINITY:1);0<I&&(this.pushAction(_.ActionType.UpdateQueue,g=>{g.queueType=U.type,g.updateType=re.UpdateType.Cancel,g.item=L,g.quantity=I}),this.eva.play("EVA_Canceled"))}else z=!0}z||this.sound.play(G.SoundKey.GenericClick,V.ChannelType.Ui)}else if(0===g.button){if(this.sound.play(G.SoundKey.GenericClick,V.ChannelType.Ui),this.player.superWeaponsTrait?.getAll().find(P=>P.rules===g.target.rules)?.status!==de.SuperWeaponStatus.Ready)return;void 0!==g.target.rules.type&&this.activateSpecialMode(g.target.rules)}}pushOrder(g,P,I=oe.OrderFeedbackType.None,L=void 0){let U=this.game.getUnitSelection();var G=U.getHash();let V=U.getSelectedUnits(),W=this.actionQueue.getLast();if(W&&W instanceof z.OrderUnitsAction&&W.orderType===g&&!W.queue&&G===this.lastSelectionHash){if(!W.target||!P||W.target.equals(P))return;this.actionQueue.dequeueLast()}G!==this.lastSelectionHash&&(this.lastSelectionHash=G,this.pushAction(_.ActionType.SelectUnits,g=>{g.unitIds=V.map(g=>g.id)})),this.pushAction(_.ActionType.OrderUnits,I=>{I.orderType=g,I.target=P}),this.soundHandler.handleOrderPushed(L||V[0],g,I)}queueOrders(g){if(g.length){for(let P of g){this.pushAction(_.ActionType.SelectUnits,g=>{g.unitIds=[...P.units].map(g=>g.id)});for(let g of P.waypoints)this.pushAction(_.ActionType.OrderUnits,P=>{P.orderType=g.orderType,P.target=g.target,P.queue=!0})}this.pushAction(_.ActionType.SelectUnits,g=>{g.unitIds=this.worldInteraction.unitSelectionHandler.getSelectedUnits().map(g=>g.id)})}}pushAction(g,P){var I=this.actionFactory.create(g);P?.(I),this.actionQueue.push(I)}activateSpecialMode(g){this.specialMode?.dispose();let P=this.specialMode=ue.SpecialActionMode.factory(this.game.rules.superWeaponRules,g,this.superWeaponFxHandler,this.pointer,this.eva);P.onExecute.subscribe(({tile:P,tile2:I})=>{this.pushAction(_.ActionType.ActivateSuperWeapon,L=>{L.superWeaponType=g.type,L.tile={x:P.rx,y:P.ry},I&&(L.tile2={x:I.rx,y:I.ry})})}),this.worldInteraction.setMode(P)}initKeyboardCommands(g){let P=g.unitSelectionHandler,I=new be.SelectByTypeCmd(P);I.init(),this.disposables.add(I),g.registerKeyCommand(K.KeyCommandType.Options,()=>this.gameMenu.open()).registerKeyCommand(K.KeyCommandType.Scoreboard,()=>this.gameMenu.openDiplo()).registerKeyCommand(K.KeyCommandType.DeployObject,()=>this.handleDeploy()).registerKeyCommand(K.KeyCommandType.StopObject,()=>this.handleStop()).registerKeyCommand(K.KeyCommandType.GuardObject,()=>this.handleGuard()).registerKeyCommand(K.KeyCommandType.AllToCheer,()=>this.pushOrder(W.OrderType.Cheer,void 0)).registerKeyCommand(K.KeyCommandType.TypeSelect,I).registerKeyCommand(K.KeyCommandType.CombatantSelect,()=>P.selectCombatants()).registerKeyCommand(K.KeyCommandType.VeterancyNav,()=>P.selectByVeterancy()).registerKeyCommand(K.KeyCommandType.HealthNav,()=>P.selectByHealth()),[K.KeyCommandType.TeamCreate_1,K.KeyCommandType.TeamCreate_2,K.KeyCommandType.TeamCreate_3,K.KeyCommandType.TeamCreate_4,K.KeyCommandType.TeamCreate_5,K.KeyCommandType.TeamCreate_6,K.KeyCommandType.TeamCreate_7,K.KeyCommandType.TeamCreate_8,K.KeyCommandType.TeamCreate_9,K.KeyCommandType.TeamCreate_10].forEach((I,L)=>g.registerKeyCommand(I,()=>P.createGroup((L+1)%10))),[K.KeyCommandType.TeamAddSelect_1,K.KeyCommandType.TeamAddSelect_2,K.KeyCommandType.TeamAddSelect_3,K.KeyCommandType.TeamAddSelect_4,K.KeyCommandType.TeamAddSelect_5,K.KeyCommandType.TeamAddSelect_6,K.KeyCommandType.TeamAddSelect_7,K.KeyCommandType.TeamAddSelect_8,K.KeyCommandType.TeamAddSelect_9,K.KeyCommandType.TeamAddSelect_10].forEach((I,L)=>g.registerKeyCommand(I,()=>P.addGroupToSelection((L+1)%10)));let L=new q.MapPanningHelper(this.game.map);[K.KeyCommandType.TeamSelect_1,K.KeyCommandType.TeamSelect_2,K.KeyCommandType.TeamSelect_3,K.KeyCommandType.TeamSelect_4,K.KeyCommandType.TeamSelect_5,K.KeyCommandType.TeamSelect_6,K.KeyCommandType.TeamSelect_7,K.KeyCommandType.TeamSelect_8,K.KeyCommandType.TeamSelect_9,K.KeyCommandType.TeamSelect_10].forEach((I,_)=>g.registerKeyCommand(I,new $.SelectGroupCmd((_+1)%10,P,g.targetLines,L,this.worldScene.cameraPan))),[K.KeyCommandType.TeamCenter_1,K.KeyCommandType.TeamCenter_2,K.KeyCommandType.TeamCenter_3,K.KeyCommandType.TeamCenter_4,K.KeyCommandType.TeamCenter_5,K.KeyCommandType.TeamCenter_6,K.KeyCommandType.TeamCenter_7,K.KeyCommandType.TeamCenter_8,K.KeyCommandType.TeamCenter_9,K.KeyCommandType.TeamCenter_10].forEach((I,_)=>g.registerKeyCommand(I,new Q.CenterGroupCmd((_+1)%10,P,L,this.worldScene.cameraPan))),new Map([[K.KeyCommandType.StructureTab,Y.SidebarCategory.Structures],[K.KeyCommandType.DefenseTab,Y.SidebarCategory.Armory],[K.KeyCommandType.InfantryTab,Y.SidebarCategory.Infantry],[K.KeyCommandType.UnitTab,Y.SidebarCategory.Vehicles]]).forEach((P,I)=>{g.registerKeyCommand(I,()=>{var I;for(I of(this.sidebarModel.selectTab(P),this.player.production.getAllQueues().filter(g=>g.status===ee.QueueStatus.Ready))){var L=this.sidebarModel.getTabForQueueType(I.type);if(P===L.id&&I.getFirst().rules.type===te.ObjectType.Building){this.placementMode.setBuilding(I.getFirst().rules),g.setMode(this.placementMode);break}}})}),g.registerKeyCommand(K.KeyCommandType.CenterBase,new ve.CenterBaseCmd(this.player,this.game.rules,L,this.worldScene.cameraPan)),g.registerKeyCommand(K.KeyCommandType.ToggleSell,()=>{this.sidebarModel.sellMode?g.setMode(void 0):g.setMode(this.sellMode)}),g.registerKeyCommand(K.KeyCommandType.ToggleRepair,()=>{this.sidebarModel.repairMode?g.setMode(void 0):g.setMode(this.repairMode)});let U=new J.LastRadarEventCmd(this.player,L,this.worldScene.cameraPan);g.registerKeyCommand(K.KeyCommandType.CenterOnRadarEvent,U),this.disposables.add(this.game.events.subscribe(g=>U.handleGameEvent(g)));let a=()=>{this.runtimeVars.cheatsEnabled.value?g.registerKeyCommand(K.KeyCommandType.BuildCheat,()=>this.speedCheat.value=!this.speedCheat.value).registerKeyCommand(K.KeyCommandType.FreeMoney,()=>this.player.credits+=1e4).registerKeyCommand(K.KeyCommandType.ToggleShroud,()=>this.game.mapShroudTrait.revealMap(this.player,this.game)):(g.unregisterKeyCommand(K.KeyCommandType.BuildCheat).unregisterKeyCommand(K.KeyCommandType.FreeMoney).unregisterKeyCommand(K.KeyCommandType.ToggleShroud),this.speedCheat.value=!1)};a(),this.runtimeVars.cheatsEnabled.onChange.subscribe(a),this.disposables.add(()=>this.runtimeVars.cheatsEnabled.onChange.unsubscribe(a)),g.registerKeyCommand(K.KeyCommandType.ToggleFps,()=>this.runtimeVars.fps.value=!this.runtimeVars.fps.value),g.registerKeyCommand(K.KeyCommandType.TogglePersistentTags,()=>this.runtimeVars.persistentHoverTags.value=!this.runtimeVars.persistentHoverTags.value),g.registerKeyCommand(K.KeyCommandType.ToggleAlliance,()=>{var g=this.game.rules.mpDialogSettings;if(g.alliesAllowed&&g.allyChangeAllowed){let g=P.getSelectedUnits()[0]?.owner;g&&g!==this.player&&this.game.alliances.canRequestAlliance(g)&&this.pushAction(_.ActionType.ToggleAlliance,P=>{P.toPlayer=g,P.toggle=!this.game.alliances.areAllied(this.player,g)})}});let z=!1;g.registerKeyCommand(K.KeyCommandType.PlanningMode,{triggerMode:ae.TriggerMode.KeyDownUp,execute:P=>{var I;P?(I=this.planningMode.exit(),this.sound.play(G.SoundKey.EndPlanningModeSound,V.ChannelType.Ui),this.queueOrders(I),z||(this.messageList.addUiFeedbackMessage(this.strings.get("MSG:PlanningModeIntro3")),z=!0)):(this.planningMode.enter(),this.planningMode.updateSelection(g.unitSelectionHandler.getSelectedUnits()),this.sound.play(G.SoundKey.StartPlanningModeSound,V.ChannelType.Ui),z||this.messageList.addUiFeedbackMessage(this.strings.get("MSG:PlanningModeIntro1Key")))}}),g.registerKeyCommand(K.KeyCommandType.ScatterObject,()=>{this.planningMode.isActive()?this.handleInvalidCommand(this.strings.get("MSG:PlanningModeNoScatter")):this.pushOrder(W.OrderType.Scatter,void 0)});let Z=new le.SelectNextUnitCmd(P,L,this.worldScene.cameraPan,this.player,this.game.getWorld());g.registerKeyCommand(K.KeyCommandType.NextObject,()=>{Z.setReverse(!1),Z.execute()}),g.registerKeyCommand(K.KeyCommandType.PreviousObject,()=>{Z.setReverse(!0),Z.execute()}),this.disposables.add(Z);var X=this.game.map.startingLocations[this.player.startLocation];X=this.game.map.tiles.getByMapCoords(X.x,X.y);let re=L.computeCameraPanFromTile(X.rx,X.ry),se=new Map;[K.KeyCommandType.SetView1,K.KeyCommandType.SetView2,K.KeyCommandType.SetView3,K.KeyCommandType.SetView4].forEach((P,I)=>{g.registerKeyCommand(P,new ce.SetCameraLocationCmd(this.worldScene.cameraPan,se,I-1))}),[K.KeyCommandType.View1,K.KeyCommandType.View2,K.KeyCommandType.View3,K.KeyCommandType.View4].forEach((P,I)=>{g.registerKeyCommand(P,new he.GoToCameraLocationCmd(this.worldScene.cameraPan,se,I-1,re))}),[K.KeyCommandType.Taunt_1,K.KeyCommandType.Taunt_2,K.KeyCommandType.Taunt_3,K.KeyCommandType.Taunt_4,K.KeyCommandType.Taunt_5,K.KeyCommandType.Taunt_6,K.KeyCommandType.Taunt_7,K.KeyCommandType.Taunt_8].forEach((P,I)=>{g.registerKeyCommand(P,()=>this.tauntHandler?.sendTaunt(I+1))}),g.registerKeyCommand(K.KeyCommandType.PlaceBeacon,()=>{g.getMode()!==this.beaconMode&&g.setMode(this.beaconMode)}),X=new ge.CenterViewCmd(P,L,this.worldScene.cameraPan),g.registerKeyCommand(K.KeyCommandType.CenterView,X);let ne=new pe.FollowUnitCmd(P,this.renderableManager,g,L,this.worldScene.cameraPan,this.worldScene);ne.init(),this.disposables.add(ne),g.registerKeyCommand(K.KeyCommandType.Follow,ne);let d=()=>this.sound.play(G.SoundKey.SystemError,V.ChannelType.Ui);[K.KeyCommandType.PageUser,K.KeyCommandType.ScreenCapture].forEach(P=>g.registerKeyCommand(P,d))}handleDeploy(){this.planningMode.isActive()?this.handleInvalidCommand(this.strings.get("MSG:PlanningModeNoDeploy")):this.pushOrder(W.OrderType.DeploySelected,void 0)}handleStop(){this.planningMode.isActive()?this.handleInvalidCommand(this.strings.get("MSG:PlanningModeNoStop")):this.pushOrder(W.OrderType.Stop,void 0)}handleGuard(){this.planningMode.isActive()?this.handleInvalidCommand(this.strings.get("MSG:PlanningModeNoGuardArea")):this.pushOrder(W.OrderType.Guard,void 0)}handleBeacon(g){this.isSinglePlayer||this.beaconFxHandler.canPingLocation(this.player,g)&&this.pushAction(_.ActionType.PingLocation,P=>{P.tile={x:g.rx,y:g.ry}})}handleCommandBarTeam(g,P){let I=P.getGroupUnits(g);if(I.length)if(P.getSelectedUnits().some(g=>I.includes(g))){new Q.CenterGroupCmd(g,P,new q.MapPanningHelper(this.game.map),this.worldScene.cameraPan).execute()}else P.selectGroup(g);else P.createGroup(g)}handleInvalidCommand(g){this.sound.play(G.SoundKey.ScoldSound,V.ChannelType.Ui),this.messageList.addUiFeedbackMessage(g)}})}}}),System.register("gui/screen/game/component/GameResultPopup",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){var P;(P=G||g("GameResultType",G={}))[P.SpVictory=0]="SpVictory",P[P.SpDefeat=1]="SpDefeat",P[P.MpVictory=2]="MpVictory",P[P.MpDefeat=3]="MpDefeat",V=class extends _.UiComponent{createUiObject({viewport:g}){let P=new L.UiObject(new THREE.Object3D,new U.HtmlContainer);return P.setPosition(g.x,g.y),P.getHtmlContainer().setSize(g.width,g.height),P}defineChildren(){let{viewport:g,type:P}=this.props;return I.jsx("sprite",{image:"grfxtxt.shp",palette:"grfxtxt.pal",ref:P=>{var I=P.getSize();P.setPosition((g.width-I.width)/2,(g.height-I.height)/2)},frame:P})}},g("GameResultPopup",V)}}}),System.register("gui/screen/game/component/Hud",["gui/jsx/jsx","data/ShpFile","game/SideType","gui/screen/game/component/hud/SidebarCard","gui/screen/game/component/hud/SidebarTabs","gui/screen/game/component/hud/SidebarIconButton","gui/screen/game/component/hud/SidebarMenu","gui/UiObject","gui/HtmlContainer","util/event","gui/screen/game/component/hud/GameMenuContentArea","gui/screen/game/component/hud/SidebarPower","gui/screen/game/component/hud/SidebarCredits","gui/screen/game/component/hud/SidebarRadar","gui/screen/game/component/hud/viewmodel/CombatantSidebarModel","gui/screen/game/component/hud/SidebarGameTime","gui/screen/game/component/hud/Messages","gui/screen/game/component/hud/SuperWeaponTimers","engine/renderable/builder/ShpAggregator","gui/screen/game/component/hud/commandBar/CommandBarButtonType","gui/screen/game/component/hud/commandBar/commandButtonConfigs","util/typeGuard","gui/screen/game/component/hud/DebugText","engine/Engine","engine/EngineType"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce,he;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g},function(g){ce=g}],execute:function(){he=class extends z.UiObject{constructor(g,P,I,L,_,U,G,V,W,z,$,Q,Y,Z,X,J,ee){super(new THREE.Object3D,new K.HtmlContainer),this.sideType=g,this.viewport=P,this.images=I,this.palettes=L,this.cameoFilenames=_,this.sidebarModel=U,this.messageList=G,this.chatHistory=V,this.debugTextValue=W,this.debugTextEnabled=z,this.localPlayer=$,this.players=Q,this.stalemateDetectTrait=Y,this.countdownTimer=Z,this.jsxRenderer=X,this.strings=J,this.commandBarButtonTypes=ee,this.persistentHoverTags=arguments[17],this._onDiploButtonClick=new q.EventDispatcher,this._onOptButtonClick=new q.EventDispatcher,this._onRepairButtonClick=new q.EventDispatcher,this._onSellButtonClick=new q.EventDispatcher,this._onSidebarSlotClick=new q.EventDispatcher,this._onSidebarTabClick=new q.EventDispatcher,this._onCreditsTick=new q.EventDispatcher,this._onMessagesTick=new q.EventDispatcher,this._onMessageSubmit=new q.EventDispatcher,this._onMessageCancel=new q.EventDispatcher,this._onScrollButtonClick=new q.EventDispatcher,this._onCommandBarButtonClick=new q.EventDispatcher,this.commandBarButtons=[],this.init()}get onDiploButtonClick(){return this._onDiploButtonClick.asEvent()}get onOptButtonClick(){return this._onOptButtonClick.asEvent()}get onRepairButtonClick(){return this._onRepairButtonClick.asEvent()}get onSellButtonClick(){return this._onSellButtonClick.asEvent()}get onSidebarSlotClick(){return this._onSidebarSlotClick.asEvent()}get onSidebarTabClick(){return this._onSidebarTabClick.asEvent()}get onCreditsTick(){return this._onCreditsTick.asEvent()}get onMessagesTick(){return this._onMessagesTick.asEvent()}get onMessageSubmit(){return this._onMessageSubmit.asEvent()}get onMessageCancel(){return this._onMessageCancel.asEvent()}get onScrollButtonClick(){return this._onScrollButtonClick.asEvent()}get onCommandBarButtonClick(){return this._onCommandBarButtonClick.asEvent()}getImage(g){var P=this.images.get(g);if(!P)throw new Error(`Missing image "${g}"`);return P}init(){const g=this.palettes.get("sidebar.pal");if(!g)throw new Error('Missing palette "sidebar.pal"');var P=le.Engine.getActiveEngine()===ce.EngineType.YurisRevenge&&this.sideType===_.SideType.ThirdSide,L=this.getImage("credits.shp"),W=this.getImage("top.shp"),z=P?this.getImage("radary.shp"):this.getImage("radar.shp"),K=P?this.palettes.get("radaryuri.pal"):g;if(!K)throw new Error('Missing palette "radaryuri.pal"');var q=this.getImage("side1.shp");let se=this.getImage("side2.shp"),he=this.getImage("side2b.shp");var ue=this.getImage("side3.shp"),de=this.getImage("addon.shp");let ge=this.getImage("tab00.shp"),pe=this.getImage("tab01.shp"),me=this.getImage("tab02.shp"),fe=this.getImage("tab03.shp"),ye=this.getImage("diplobtn.shp"),Te=this.getImage("optbtn.shp"),ve=this.getImage("repair.shp"),be=this.getImage("sell.shp"),Se=this.getImage("r-up.shp"),we=this.getImage("r-dn.shp");var Ee=[...new Set(this.commandBarButtonTypes.map(g=>ae.commandButtonConfigs.find(P=>P.type===g)?.icon))].map(g=>g?this.images.get(g):void 0).filter(ne.isNotNullOrUndefined);let Ce=(new re.ShpAggregator).aggregate([ye,Te,ve,be,ge,pe,me,fe,we,Se,...Ee].map(g=>re.ShpAggregator.getShpFrameInfo(g,!1)),"agg_hud.shp");var xe=this.sidebarWidth=L.width,Oe={x:this.viewport.width-xe,y:0,width:xe,height:this.viewport.height},Ae=L.height+W.height,Me=Ae+z.height;let Re=Ae+z.height+q.height;var Pe=this.repeaterCount=Math.floor((Oe.height-Re-ue.height)/se.height);let Ie=this.repeaterHeight=se.height;var ke=Ae+z.height+q.height+Ie*Pe;let Be=this.getImage("lendcap.shp");var Ne=this.actionBarHeight=Be.height,Le=this.viewport.y+this.viewport.height-Ne;let je=this.getImage("bttnbkgd.shp");var De=this.getImage("rendcap.shp"),Fe=Oe.x-Be.width-De.width,_e=Math.floor(Fe/je.width),Ue=Fe%je.width;let He;Ue&&(He=je.clip(Ue,je.height));let Ge={x:12,y:4};this.sideType!==_.SideType.GDI&&(Ge={x:14,y:5});let Ve={x:20,y:8};this.sideType!==_.SideType.GDI&&(Ve={x:34,y:7});let We=1,ze={x:26,y:-3};if(this.sideType!==_.SideType.GDI&&(We=0,ze={x:20,y:-2}),!(P=this.palettes.get("cameo.pal")))throw new Error('Missing palette "cameo.pal"');Ee=this.buildCameoFile(),xe=this.createCameoNameToIdMap();Ne=this.sideType===_.SideType.GDI?{x:5,y:2}:{x:0,y:0};Fe=this.getImage("powerp.shp"),Ue=this.getTextColor(),this.add(...this.jsxRenderer.render(I.jsx("fragment",null,I.jsx("container",{x:Oe.x,y:Oe.y},I.jsx("sprite-batch",null,I.jsx("sprite",{static:!0,image:L,palette:g}),I.jsx("container",{ref:g=>this.sidebarTop=g,zIndex:1},this.sidebarModel instanceof X.CombatantSidebarModel?I.jsx(Y.SidebarCredits,{sidebarModel:this.sidebarModel,height:L.height,width:L.width,textColor:Ue,onTick:g=>this._onCreditsTick.dispatch(this,g)}):I.jsx(J.SidebarGameTime,{sidebarModel:this.sidebarModel,height:L.height,width:L.width,textColor:Ue})),I.jsx("sprite",{static:!0,image:W,palette:g,y:L.height}),I.jsx("sprite",{static:!0,image:z,palette:K,y:Ae}),I.jsx(Z.SidebarRadar,{image:z,palette:K,y:Ae,sidebarModel:this.sidebarModel instanceof X.CombatantSidebarModel?this.sidebarModel:void 0,zIndex:1,ref:g=>this.sidebarRadar=g}),I.jsx("sprite",{static:!0,image:q,palette:g,y:Me}),new Array(Pe).fill(0).map((P,L)=>I.jsx("sprite",{static:!0,image:he,palette:g,y:Re+Ie*L})),I.jsx("sprite-batch",{ref:g=>this.sideCameoRepeaters=g},new Array(Pe).fill(0).map((P,L)=>I.jsx("sprite",{static:!0,image:se,palette:g,y:Re+Ie*L,zIndex:1}))),I.jsx(Q.SidebarPower,{sidebarModel:this.sidebarModel,powerImg:Fe,palette:g,x:Ne.x,y:Re,height:Ie*Pe+Ne.y,ref:g=>this.sidebarPower=g,zIndex:2,strings:this.strings}),I.jsx(U.SidebarCard,{cameoImages:Ee,cameoPalette:P,cameoNameToIdMap:xe,sidebarModel:this.sidebarModel,slots:2*Pe,onSlotClick:g=>this._onSidebarSlotClick.dispatch(this,g),x:22,y:Re+1,strings:this.strings,textColor:Ue,persistentHoverTags:this.persistentHoverTags,ref:g=>this.sidebarCard=g,zIndex:2}),I.jsx("container",{ref:g=>this.sidebarMenuContainer=g,x:21,y:Re+1,zIndex:2}),I.jsx("sprite",{static:!0,image:ue,palette:g,y:ke}),I.jsx("sprite",{static:!0,image:de,palette:g,y:ke+ue.height}))),I.jsx("container",{x:Oe.x,y:Oe.y,ref:g=>this.sidebarButtonsContainer=g,zIndex:2},I.jsx(V.SidebarIconButton,{image:Ce.file,palette:g,imageFrameOffset:Ce.imageIndexes.get(ye),x:Ge.x,y:L.height+Ge.y,onClick:()=>this._onDiploButtonClick.dispatch(this,void 0),tooltip:this.strings.get("Tip:DiplomacyButton")}),I.jsx(V.SidebarIconButton,{image:Ce.file,palette:g,imageFrameOffset:Ce.imageIndexes.get(Te),x:Ge.x+ye.width,y:L.height+Ge.y,onClick:()=>this._onOptButtonClick.dispatch(this,void 0),tooltip:this.strings.get("Tip:OptionsButton")}),I.jsx(V.SidebarIconButton,{image:Ce.file,palette:g,imageFrameOffset:Ce.imageIndexes.get(ve),x:Ve.x,y:Me+Ve.y,toggle:this.sidebarModel.repairMode,ref:g=>this.repairButton=g,onClick:()=>this._onRepairButtonClick.dispatch(this,void 0),tooltip:this.strings.get("TXT_REPAIR_MODE")}),I.jsx(V.SidebarIconButton,{image:Ce.file,palette:g,imageFrameOffset:Ce.imageIndexes.get(be),x:Ve.x+ve.width,y:Me+Ve.y,toggle:this.sidebarModel.sellMode,ref:g=>this.sellButton=g,onClick:()=>this._onSellButtonClick.dispatch(this,void 0),tooltip:this.strings.get("TXT_SELL_MODE")}),I.jsx(G.SidebarTabs,{aggregatedImageData:Ce,images:[ge,pe,me,fe],palette:g,sidebarModel:this.sidebarModel,tabSpacing:We,onTabClick:g=>{this.sidebarModel.selectTab(g.id),this._onSidebarTabClick.dispatch(this,g.id)},strings:this.strings,x:ze.x,y:Re-ge.height+ze.y}),I.jsx(V.SidebarIconButton,{image:Ce.file,palette:g,disabled:!0,imageFrameOffset:Ce.imageIndexes.get(we),x:38,y:ke+7,ref:g=>this.pgDnButton=g,onClick:()=>this._onScrollButtonClick.dispatch(this,this.sidebarCard.pageDown())}),I.jsx(V.SidebarIconButton,{image:Ce.file,palette:g,disabled:!0,imageFrameOffset:Ce.imageIndexes.get(Se),x:38+we.width,y:ke+7,ref:g=>this.pgUpButton=g,onClick:()=>this._onScrollButtonClick.dispatch(this,this.sidebarCard.pageUp())})),I.jsx("container",{x:this.viewport.x,y:Le},I.jsx("container",{x:Be.width,zIndex:1},this.renderCommandBarButtons(Ce,this.commandBarButtonTypes,je.width,_e)),I.jsx("sprite-batch",null,I.jsx("sprite",{static:!0,image:Be,palette:g}),new Array(_e).fill(0).map((P,L)=>I.jsx("sprite",{static:!0,image:je,palette:g,x:Be.width+je.width*L})),He?I.jsx("sprite",{static:!0,image:He,palette:g,x:Be.width+_e*je.width}):[],I.jsx("sprite",{static:!0,image:De,palette:g,x:Oe.x-De.width}))),I.jsx(ee.Messages,{messages:this.messageList,chatHistory:this.chatHistory,width:Oe.x-10,height:200,ref:g=>this.messages=g,strings:this.strings,onMessageTick:()=>this._onMessagesTick.dispatch(this),onMessageSubmit:g=>this._onMessageSubmit.dispatch(this,g),onMessageCancel:()=>this._onMessageCancel.dispatch(this)}),I.jsx(oe.DebugText,{text:this.debugTextValue,visible:this.debugTextEnabled,color:new THREE.Color(16777215),x:20,y:200,width:Math.floor(Oe.x/2),height:200,ref:g=>this.debugText=g}),I.jsx(te.SuperWeaponTimers,{localPlayer:this.localPlayer,players:this.players,stalemateDetectTrait:this.stalemateDetectTrait,countdownTimer:this.countdownTimer,strings:this.strings,width:200,height:500,x:Oe.x-200,y:Le-500,ref:g=>this.superWeaponTimers=g}),I.jsx($.GameMenuContentArea,{hidden:!0,screenSize:this.viewport,viewport:{x:this.viewport.x,y:this.viewport.y,width:Oe.x,height:Le},sideType:this.sideType,images:this.images,ref:g=>this.menuContentContainer=g.getUiObject(),innerRef:g=>this.menuContentContainerInner=g}))))}getTextColor(){return this.sideType===_.SideType.GDI?"rgb(165,211,255)":"yellow"}createSidebarMenu(g){return this.jsxRenderer.render(I.jsx(W.SidebarMenu,{buttonImg:this.getImage("sidebttn.shp"),buttonPal:"sidebar.pal",menuHeight:this.repeaterHeight*this.repeaterCount-2,buttons:g}))[0]}showSidebarMenu(g){this.destroySidebarMenu(),this.sidebarMenu=this.createSidebarMenu(g),this.sidebarMenuContainer.add(this.sidebarMenu),this.sideCameoRepeaters.setVisible(!1),this.remove(this.sidebarButtonsContainer),this.sidebarCard.hide(),this.sidebarPower.hide(),this.sidebarTop?.setVisible(!1),this.sidebarRadar?.hide(),this.commandBarButtons?.forEach(g=>g.getUiObject().setVisible(!1)),this.messages.getUiObject().setVisible(!1),this.debugText.getUiObject().setVisible(!1),this.superWeaponTimers.getUiObject().setVisible(!1)}hideSidebarMenu(){this.sideCameoRepeaters.setVisible(!0),this.destroySidebarMenu(),this.add(this.sidebarButtonsContainer),this.sidebarCard.show(),this.sidebarPower.show(),this.sidebarTop?.setVisible(!0),this.sidebarRadar?.show(),this.commandBarButtons?.forEach(g=>g.getUiObject().setVisible(!0)),this.messages.getUiObject().setVisible(!0),this.debugText.getUiObject().setVisible(!0),this.superWeaponTimers.getUiObject().setVisible(!0)}setMenuContentComponent(g){let P=this.menuContentContainerInner;this.menuContent&&(P.remove(this.menuContent),this.menuContent.destroy(),this.menuContent=void 0),g&&(P.add(g),this.menuContent=g)}setMinimap(g){this.sidebarRadar.setMinimap(g)}toggleMenuContentVisibility(g){this.menuContentContainer.setVisible(g)}renderCommandBarButtons(g,P,L,_){let U=0,G=[];for(let K of P.slice(0,_))if(K!==se.CommandBarButtonType.Separator){let P=ae.commandButtonConfigs.find(g=>g.type===K);var W,z;P?(W=this.images.get(P.icon))?(z=g.imageIndexes.get(W),G.push(I.jsx(V.SidebarIconButton,{image:void 0!==z?g.file:W,imageFrameOffset:z,palette:"sidebar.pal",tooltip:P.tooltip(this.strings),x:U,onClick:()=>{this._onCommandBarButtonClick.dispatch(this,K)},ref:g=>this.commandBarButtons.push(g)})),U+=W.width):console.warn(`Missing image for command bar button "${se.CommandBarButtonType[K]}"`):console.warn(`Unknown command bar button type "${K}"`)}else U+=L;return G}buildCameoFile(){let g=new L.ShpFile;return g.filename="agg_cameos.shp",this.cameoFilenames.forEach(P=>{let I=this.getImage(P);g.width||(g.width=I.width),g.height||(g.height=I.height),g.addImage(I.getImage(0))}),g}createCameoNameToIdMap(){let g=new Map;for(let P=0;P<this.cameoFilenames.length;++P)g.set(this.cameoFilenames[P],P);return g}destroySidebarMenu(){this.sidebarMenu&&(this.sidebarMenuContainer.remove(this.sidebarMenu),this.sidebarMenu.destroy())}update(g){super.update(g),this.repairButton?.setToggleState(this.sidebarModel.repairMode),this.sellButton?.setToggleState(this.sidebarModel.sellMode);var P=0<this.sidebarModel.activeTab.items.length-2*this.repeaterCount;this.pgUpButton?.setDisabled(!P),this.pgDnButton?.setDisabled(!P)}destroy(){this.sidebarButtonsContainer.destroy(),this.destroySidebarMenu(),this.sidebarRadar.setMinimap(void 0),super.destroy()}},g("Hud",he)}}}),System.register("gui/screen/game/component/hud/commandBar/CommandBarButtonList",["gui/screen/game/component/hud/commandBar/CommandBarButtonType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("CommandBarButtonList",class{constructor(){this.buttons=[]}fromIni(g){var P,L=(g.getString("ButtonList")||void 0)?.split(",")??[];let _=[],U=new Set(Object.keys(I.CommandBarButtonType).filter(g=>"string"==typeof g));for(P of L)"x"===P?_.push(I.CommandBarButtonType.Separator):U.has(P)?_.push(I.CommandBarButtonType[P]):console.warn(`Unknown command bar button type "${P}"`);return this.buttons=_,this}})}}}),System.register("gui/screen/game/component/hud/commandBar/CommandBarButtonType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("CommandBarButtonType",I={}))[P.Separator=0]="Separator",P[P.BugReport=1]="BugReport",P[P.Beacon=2]="Beacon",P[P.Cheer=3]="Cheer",P[P.Deploy=4]="Deploy",P[P.Guard=5]="Guard",P[P.PlanningMode=6]="PlanningMode",P[P.Stop=7]="Stop",P[P.Team01=8]="Team01",P[P.Team02=9]="Team02",P[P.Team03=10]="Team03",P[P.TypeSelect=11]="TypeSelect",P[P.ReplayRewind=12]="ReplayRewind",P[P.ReplayPlay=13]="ReplayPlay",P[P.ReplayPause=14]="ReplayPause",P[P.ReplaySpeed=15]="ReplaySpeed"}}}),System.register("gui/screen/game/component/hud/commandBar/CommandButtonConfig",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("gui/screen/game/component/hud/commandBar/commandButtonConfigs",["gui/screen/game/component/hud/commandBar/CommandBarButtonType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("commandButtonConfigs",[{type:I.CommandBarButtonType.BugReport,icon:"reportbug.shp",tooltip:g=>g.get("ts:reportbug")},{type:I.CommandBarButtonType.Team01,icon:"button00.shp",tooltip:g=>g.get("tip:team01")},{type:I.CommandBarButtonType.Team02,icon:"button01.shp",tooltip:g=>g.get("tip:team02")},{type:I.CommandBarButtonType.Team03,icon:"button02.shp",tooltip:g=>g.get("tip:team03")},{type:I.CommandBarButtonType.TypeSelect,icon:"button03.shp",tooltip:g=>g.get("tip:typeselect")},{type:I.CommandBarButtonType.Deploy,icon:"button04.shp",tooltip:g=>g.get("tip:deploy")},{type:I.CommandBarButtonType.Guard,icon:"button06.shp",tooltip:g=>g.get("tip:guard")},{type:I.CommandBarButtonType.Beacon,icon:"button07.shp",tooltip:g=>g.get("tip:beacon")},{type:I.CommandBarButtonType.Stop,icon:"button08.shp",tooltip:g=>g.get("tip:stop")},{type:I.CommandBarButtonType.PlanningMode,icon:"button09.shp",tooltip:g=>g.get("tip:planningmode")},{type:I.CommandBarButtonType.Cheer,icon:"button10.shp",tooltip:g=>g.get("tip:cheer")},{type:I.CommandBarButtonType.ReplayRewind,icon:"rewind.shp",tooltip:g=>g.get("tip:replayrewind")},{type:I.CommandBarButtonType.ReplayPlay,icon:"play.shp",tooltip:g=>g.get("tip:play")},{type:I.CommandBarButtonType.ReplayPause,icon:"pause.shp",tooltip:g=>g.get("tip:pause")},{type:I.CommandBarButtonType.ReplaySpeed,icon:"ffwd.shp",tooltip:g=>g.get("tip:replayspeed")}])}}}),System.register("gui/screen/game/component/hud/DebugText",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","engine/gfx/SpriteUtils","engine/gfx/CanvasUtils"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){W=class extends _.UiComponent{createUiObject(){let g=new L.UiObject(new THREE.Object3D,new U.HtmlContainer);g.setPosition(this.props.x||0,this.props.y||0);var P=this.props.width,I=this.props.height;let _=document.createElement("canvas");return _.width=P,_.height=I,this.ctx=_.getContext("2d",{alpha:!0}),this.texture=this.createTexture(_),this.mesh=this.createMesh(P,I),g}createTexture(g){let P=new THREE.Texture(g);return P.needsUpdate=!0,P.flipY=!1,P.minFilter=THREE.NearestFilter,P.magFilter=THREE.NearestFilter,P}createMesh(g,P){let I=G.SpriteUtils.createRectGeometry(g,P);G.SpriteUtils.addRectUvs(I,{x:0,y:0,width:g,height:P},{width:g,height:P}),I.translate(g/2,P/2,0);var L=new THREE.MeshBasicMaterial({map:this.texture,side:THREE.DoubleSide,transparent:!0});let _=new THREE.Mesh(I,L);return _.frustumCulled=!1,_}defineChildren(){return I.jsx("mesh",{zIndex:this.props.zIndex},this.mesh)}onFrame(g){if(!this.lastUpdate||g-this.lastUpdate>=1e3/30){this.lastUpdate=g;let I=this.props.text.value;var P;this.props.visible.value!==this.getUiObject().isVisible()&&this.getUiObject().setVisible(this.props.visible.value),this.lastText!==I&&(this.lastText=I,P=I.split(/\r?\n/g),this.drawLines(P))}}drawLines(g){this.ctx.clearRect(0,0,this.props.width,this.props.height);var P,I,L=Math.floor(110*this.props.width/600);let _=0;for(P of g)for(I of this.wrapText(P,L))_+=this.drawLine(I,this.props.color,_);this.texture.needsUpdate=!0}drawLine(g,P,I){var L=.5<.299*P.r+.587*P.g+.114*P.b?"black":"white";return V.CanvasUtils.drawText(this.ctx,g,0,I,{color:"#"+P.getHexString(),outlineColor:L,outlineWidth:2,fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:12,fontWeight:"400",paddingTop:6,height:20,paddingLeft:4,paddingRight:4}).height}wrapText(g,P){let I=[];for(;g.length>P;){let L=g.slice(0,P).search(/\s[^\s]*$/);-1!==L&&0!==L||(L=Math.min(g.length,P)),I.push(g.substr(0,L)),g=g.slice(L)}return g.length&&I.push(g),I}onDispose(){this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.texture.dispose()}},g("DebugText",W)}}}),System.register("gui/screen/game/component/hud/GameMenuContentArea",["gui/jsx/jsx","gui/jsx/UiComponent","gui/UiObject","gui/HtmlContainer","engine/gfx/SpriteUtils","game/SideType","engine/Engine","engine/EngineType"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g}],execute:function(){K=class extends L.UiComponent{createUiObject({viewport:g,hidden:P}){let I=new _.UiObject(new THREE.Object3D,new U.HtmlContainer);return I.setPosition(g.x,g.y),I.getHtmlContainer().setSize(g.width,g.height),I.setVisible(!P),I}defineChildren(){let{viewport:g,screenSize:P,sideType:L,images:_,innerRef:U}=this.props,G="lg";(P.width<1024||P.height<768)&&(G="md"),(P.width<800||P.height<600)&&(G="sm");var K=(Z=W.Engine.getActiveEngine()===z.EngineType.YurisRevenge&&L===V.SideType.ThirdSide)?`bkgd${G}y.shp`:`bkgd${G}.shp`,q=Z?"uibkgdy.pal":"uibkgd.pal",$=_.get(K),Q=$?(g.width-$.width)/2:0,Y=$?(g.height-$.height)/2:0,Z=($||g).width;K=($||g).height;return I.jsx("fragment",null,I.jsx("mesh",null,this.createMask(g)),I.jsx("container",{zIndex:1,x:Q,y:Y,width:Z,height:K,ref:U},$&&I.jsx("sprite",{image:$,palette:q})))}createMask(g){let P=G.SpriteUtils.createRectGeometry(g.width,g.height);P.translate(g.width/2,g.height/2,0);var I=new THREE.MeshBasicMaterial({color:0,opacity:.75,transparent:!0,side:THREE.DoubleSide});let L=new THREE.Mesh(P,I);return L.frustumCulled=!1,L}},g("GameMenuContentArea",K)}}}),System.register("gui/screen/game/component/hud/HudChat",["gui/component/ChatInput","network/gservConfig","react"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("HudChat",({messageList:g,chatHistory:P,strings:U,onSubmit:G,onCancel:V})=>{if(!g.isComposing)return null;var W=g.localPlayer?.color.asHexString()??"white";return _.default.createElement(I.ChatInput,{chatHistory:P,channels:[L.RECIPIENT_ALL,L.RECIPIENT_TEAM],className:"game-chat-input",forceColor:W,noCycleHint:!0,submitEmpty:!0,strings:U,onKeyDown:g=>{"Escape"===g.key&&g.preventDefault(),g.stopPropagation(),g.nativeEvent.stopImmediatePropagation()},onKeyUp:g=>{g.stopPropagation(),g.nativeEvent.stopImmediatePropagation()},onSubmit:g=>{g.value.length?G(g):V()},onCancel:V,onBlur:V})})}}}),System.register("gui/screen/game/component/hud/Messages",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","engine/gfx/SpriteUtils","engine/gfx/CanvasUtils","gui/jsx/HtmlView","gui/screen/game/component/hud/HudChat","network/chat/ChatMessage","network/gservConfig"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g}],execute:function(){$=class extends _.UiComponent{createUiObject(){let g=new L.UiObject(new THREE.Object3D,new U.HtmlContainer);g.setPosition(this.props.x||0,this.props.y||0);var P=this.props.width,I=this.props.height;let _=document.createElement("canvas");return _.width=P,_.height=I,this.ctx=_.getContext("2d",{alpha:!0}),this.texture=this.createTexture(_),this.mesh=this.createMesh(P,I),g}createTexture(g){let P=new THREE.Texture(g);return P.needsUpdate=!0,P.flipY=!1,P.minFilter=THREE.NearestFilter,P.magFilter=THREE.NearestFilter,P}createMesh(g,P){let I=G.SpriteUtils.createRectGeometry(g,P);G.SpriteUtils.addRectUvs(I,{x:0,y:0,width:g,height:P},{width:g,height:P}),I.translate(g/2,P/2,0);var L=new THREE.MeshBasicMaterial({map:this.texture,side:THREE.DoubleSide,transparent:!0});let _=new THREE.Mesh(I,L);return _.frustumCulled=!1,_}defineChildren(){return I.jsx("fragment",null,I.jsx("container",{hidden:!0,ref:g=>this.inputContainer=g},I.jsx(W.HtmlView,{component:z.HudChat,props:{strings:this.props.strings,messageList:this.props.messages,chatHistory:this.props.chatHistory,onSubmit:this.props.onMessageSubmit,onCancel:this.props.onMessageCancel},innerRef:g=>this.inputComponent=g})),I.jsx("mesh",{zIndex:this.props.zIndex},this.mesh))}onFrame(g){var P,I,L,_,U;(!this.lastUpdate||g-this.lastUpdate>=1e3/30)&&(this.lastUpdate=g,this.props.messages.prune(),P=this.props.messages.getAll(),I=Date.now(),L=P[P.length-1]?.time,_=P.length,U=this.props.messages.isComposing,(this.lastComposing!==U||this.lastMessageTime!==L||_!==this.lastMessageCount||L&&I-L<=2e3)&&(this.lastMessageTime=L,this.lastMessageCount=_,this.lastComposing=U,this.drawMessages(U,P,I),this.inputContainer.setVisible(U),this.inputComponent.refresh()))}drawMessages(g,P,I){this.ctx.clearRect(0,0,this.props.width,this.props.height);var L=Math.floor(110*this.props.width/600);let _=!1;var U,G;let V=0;for(G of(g&&(V=20,(U=this.props.chatHistory.lastComposeTarget.value).type===K.ChatRecipientType.Channel&&U.name===q.RECIPIENT_ALL||(P=[{color:"gray",text:this.props.strings.get("TS:ChatCycleHint","Tab"),animate:!1,time:Date.now()},...P])),P)){var W,z=Math.min(1e3,10*G.text.length);z=G.animate?Math.min(1,(I-G.time)/z):1;let g=Math.round(z*G.text.length);for(W of(z<1&&(_=!0),this.wrapText(G.text,L)))W.length>g?(W=W.slice(0,g),g=0):g-=W.length,V+=this.drawLine(W,G.color,V)}this.texture.needsUpdate=!0,_&&this.props.onMessageTick?.()}drawLine(g,P,I){return V.CanvasUtils.drawText(this.ctx,g,0,I,{color:P,fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:13,fontWeight:"500",paddingTop:5,height:20,backgroundColor:"rgba(0, 0, 0, .75)",paddingLeft:4,paddingRight:4}).height}wrapText(g,P){let I=[];for(;g.length>P;){let L=g.slice(0,P).search(/\s[^\s]*$/);-1!==L&&0!==L||(L=Math.min(g.length,P)),I.push(g.substr(0,L)),g=g.slice(L)}return g.length&&I.push(g),I}onDispose(){this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.texture.dispose()}},g("Messages",$)}}}),System.register("gui/screen/game/component/hud/SidebarCard",["gui/jsx/jsx","gui/screen/game/component/hud/viewmodel/SidebarModel","gui/UiObject","gui/jsx/UiComponent","engine/gfx/OverlayUtils","gui/HtmlContainer","util/math","gui/screen/game/component/hud/viewmodel/CombatantSidebarModel","game/art/ObjectArt","gui/screen/game/TooltipTextResolver"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){0},function(g){z=g},function(g){$=g}],execute:function(){var P;(P=K=K||{})[P.Ready=0]="Ready",P[P.OnHold=1]="OnHold",q=class u extends U.UiComponent{constructor(){super(...arguments),this.slotContainers=[],this.slotObjects=[],this.progressOverlays=[],this.visible=!0,this.labelObjects=[],this.quantityObjects=[],this.tagObjects=[],this.justCreated=!0,this.lastItemCount=0,this.pagingOffset=0,this.handleWheel=g=>{this.scrollToOffset(this.pagingOffset+(0<g.wheelDeltaY?2:-2))}}createUiObject(){let g=new _.UiObject(new THREE.Object3D,new V.HtmlContainer);g.setPosition(this.props.x||0,this.props.y||0),g.onFrame.subscribe(()=>this.handleFrame()),this.slotOutline=new _.UiObject(this.createSlotOutline()),this.slotOutline.setVisible(!1),this.slotOutline.setZIndex((this.props.zIndex??0)+1),g.add(this.slotOutline);let P=u.labelImageCache.get(this.props.textColor);P||(P=this.createLabelImages(this.props.textColor),u.labelImageCache.set(this.props.textColor,P)),this.labelImages=P;let I=u.quantityImageCache.get(this.props.textColor);return I||(I=this.createQuantityImages(this.props.textColor),u.quantityImageCache.set(this.props.textColor,I)),this.quantityImages=I,this.tagImages=[this.createTextBox("",this.props.textColor,{fontSize:12,fontWeight:"400",paddingTop:2,paddingBottom:2,paddingLeft:2,paddingRight:2})],this.tagFrameByText=new Map,this.tagFrameByText.set("",0),g}defineChildren(){let{slots:g,cameoImages:P,cameoPalette:L,sidebarModel:_,onSlotClick:U,zIndex:G}=this.props;var V=this.getCameoSize();let W=[];for(let z=0;z<g;z++){let g={x:(3+V.width)*(z%2),y:(2+V.height)*Math.floor(z/2)};W.push(I.jsx("container",{x:g.x,y:g.y,zIndex:G,ref:g=>this.slotContainers.push(g),onWheel:this.handleWheel,onClick:g=>{var P=_.activeTab.items[this.getItemIndexAtSlot(z)];P&&!P.disabled&&U?.(this.createSlotClickEvent(P,g))},onMouseEnter:()=>{var P=_.activeTab.items[this.getItemIndexAtSlot(z)];P&&(P.disabled||this.slotOutline.setPosition(g.x,g.y),this.slotOutline.setVisible(!P.disabled),this.hoverSlotIndex=z)},onMouseLeave:()=>{this.hoverSlotIndex===z&&(this.slotOutline.setVisible(!1),this.hoverSlotIndex=void 0)}},I.jsx("sprite",{image:"gclock2.shp",palette:"sidebar.pal",zIndex:1,frame:0,opacity:.5,transparent:!0,ref:g=>this.progressOverlays.push(g)}),I.jsx("sprite",{images:this.tagImages,zIndex:.5,x:V.width/2,y:V.height/2,transparent:!0,ref:g=>this.tagObjects.push(g)}),I.jsx("sprite",{images:this.labelImages,zIndex:2,x:V.width/2,transparent:!0,ref:g=>this.labelObjects.push(g)}),I.jsx("sprite",{images:this.quantityImages,zIndex:2,x:V.width,alignX:1,alignY:-1,transparent:!0,ref:g=>this.quantityObjects.push(g)}),I.jsx("sprite",{image:P,palette:L,ref:g=>this.slotObjects.push(g)})))}return W}createSlotClickEvent(g,P){return{target:g.target,button:P.button,altKey:P.altKey,ctrlKey:P.ctrlKey,metaKey:P.metaKey,shiftKey:P.shiftKey,isTouch:P.isTouch,touchDuration:P.touchDuration}}handleFrame(){let{sidebarModel:g,slots:P}=this.props;var I;this.getUiObject().get3DObject().visible=this.visible,(this.justCreated||g.activeTab.needsUpdate||this.lastActiveTab!==g.activeTab)&&(this.justCreated=!1,I=g.activeTab.items.length,this.lastActiveTab===g.activeTab&&this.lastItemCount===I||(this.lastItemCount>I&&(this.pagingOffset=0),this.lastItemCount=I),this.lastActiveTab=g.activeTab,g.activeTab.needsUpdate=!1,this.updateSlots(g.activeTab.items,P))}updateSlots(g,P){for(let L=0;L<P;L++){var I=g[this.getItemIndexAtSlot(L)];let P=this.slotObjects[L],_=this.progressOverlays[L],U=this.labelObjects[L],G=this.quantityObjects[L],V=this.tagObjects[L];g.length-this.pagingOffset<=L?(P.get3DObject().visible=!1,_.get3DObject().visible=!1,U.get3DObject().visible=!1,G.get3DObject().visible=!1,V.get3DObject().visible=!1):(this.updateCameo(I,P),this.updatePersistentTag(I,V),this.updateProgressOverlay(I,_),this.updateStatusText(I,U),this.updateQuantities(I,G),this.updateTooltip(I,this.slotContainers[L]))}}updateCameo(g,P){let I=this.props.cameoNameToIdMap;var L;let _=g.cameo+".shp";if(void 0===I.get(_)&&(_=z.ObjectArt.MISSING_CAMEO+".shp"),void 0===(L=I.get(_)))throw new Error(`Missing cameo placeholder image "${z.ObjectArt.MISSING_CAMEO}.shp"`);P.setFrame(L),P.get3DObject().visible=!0,P.setLightMult(g.disabled?.5:1)}updateProgressOverlay(g,P){let I=0;var _;[L.SidebarItemStatus.Started,L.SidebarItemStatus.OnHold].includes(g.status)&&(_=P.getFrameCount(),I=Math.max(1,Math.ceil(g.progress*(_-1)))%_),P.setFrame(I),P.get3DObject().visible=0<I}updateStatusText(g,P){P.get3DObject().visible=[L.SidebarItemStatus.Ready,L.SidebarItemStatus.OnHold].includes(g.status),g.status===L.SidebarItemStatus.Ready?(P.setFrame(K.Ready),P.setPosition(this.getCameoSize().width/2,P.getPosition().y),P.builder.setAlign(0,-1)):g.status===L.SidebarItemStatus.OnHold&&(P.setFrame(K.OnHold),P.setPosition(1<g.quantity?0:this.getCameoSize().width/2,P.getPosition().y),P.builder.setAlign(1<g.quantity?-1:0,-1))}updateQuantities(g,P){g.quantity>(g.status===L.SidebarItemStatus.InQueue?0:1)?(P.setFrame(g.quantity>u.MAX_QUANTITY?u.MAX_QUANTITY:g.quantity-1),P.setVisible(!0)):P.setVisible(!1)}updateTooltip(g,P){P.setTooltip($.resolveSidebarItemTooltipText(g,this.props.sidebarModel,this.props.strings))}ensureTagFrame(g){let P=g??"";if(this.tagFrameByText.has(P))return this.tagFrameByText.get(P);let I=this.tagImages.length,L=this.createTextBox(P,this.props.textColor,{fontSize:12,fontWeight:"400",paddingTop:2,paddingBottom:2,paddingLeft:2,paddingRight:2});try{var _=L.getContext("2d"),U=_?.getImageData?.(0,0,L.width,L.height)?.data;if(U)for(let g=0;g<U.length;g+=4)0<U[g+3]&&(0<U[g]||0<U[g+1]||0<U[g+2])&&0}catch(P){}return this.tagImages=[...this.tagImages,L],this.tagFrameByText.set(P,I),this.tagObjects.forEach(g=>{var P=g?.builder;if(P){let g=P.getFrame?.()??0;P.images=this.tagImages,P.atlas=void 0,P.initTexture?.(),P.frameGeometries?.forEach(g=>g.dispose()),P.frameGeometries?.clear(),P.mesh&&(P.mesh.material&&(P.mesh.material.map=P.atlas?.getTexture?.(),P.mesh.material.needsUpdate=!0),P.frameNo=-1,P.setFrame(Math.min(g,P.frameCount-1)))}}),I}updatePersistentTag(g,P){if(!P)return;if(!this.props.persistentHoverTags?.value)return void P.setVisible(!1);let I=$.resolveSidebarItemTooltipText(g,this.props.sidebarModel,this.props.strings);if(!I)return void P.setVisible(!1);g=this.ensureTagFrame(I),P.setFrame(g),P.setVisible(!0);let L,_,U,G=P.get3DObject?.(),V=G?.material,W=0,z=0,K=0,q=0,Q=0,Y=0,Z=this.tagImages[g];try{if(Z){var X=Z.getContext("2d")?.getImageData(0,0,Z.width,Z.height)?.data;if(X)for(let g=0;g<X.length;g+=4)W=Math.max(W,X[g]),z=Math.max(z,X[g+1]),K=Math.max(K,X[g+2]),(X[g]>180||X[g+1]>180||X[g+2]>180)&&0<X[g+3]&&0}}catch(g){}try{var J=P.builder?.atlas,ee=J&&Z?J.getImageRect(Z):void 0,te=J?.getTexture?.()?.image,re=te?.getContext?.("2d")?.getImageData(ee.x,ee.y,ee.width,ee.height)?.data;if(re)for(let g=0;g<re.length;g+=4)q=Math.max(q,re[g]),Q=Math.max(Q,re[g+1]),Y=Math.max(Y,re[g+2]),(re[g]>180||re[g+1]>180||re[g+2]>180)&&0<re[g+3]&&0}catch(g){}try{var se=V?.map,ae=P.builder?.atlas?.getTexture?.(),ne=P.builder?.atlas&&Z?P.builder.atlas.getImageRect(Z):void 0,oe=se?.image?.getContext?.("2d")?.getImageData(ne.x,ne.y,ne.width,ne.height)?.data;if(L=!!se&&!!ae&&se===ae,_=se?.image?.width,U=ae?.image?.width,oe)for(let g=0;g<oe.length;g+=4)(oe[g]>180||oe[g+1]>180||oe[g+2]>180)&&0<oe[g+3]&&0,0<oe[g+3]&&0}catch(g){}}getItemIndexAtSlot(g){return g+this.pagingOffset}getCameoSize(){return{width:this.props.cameoImages.width,height:this.props.cameoImages.height}}createSlotOutline(){var g=(P=this.getCameoSize()).width,P=P.height;let I=new THREE.Geometry;return I.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(0,P,0),new THREE.Vector3(g,P,0),new THREE.Vector3(g,0,0),new THREE.Vector3(0,0,0)),g=new THREE.LineBasicMaterial({color:this.props.textColor,transparent:!0,side:THREE.DoubleSide}),new THREE.Line(I,g)}hide(){this.visible=!1}show(){this.visible=!0}scrollToOffset(g){var P=this.pagingOffset,I=Math.max(0,this.props.sidebarModel.activeTab.items.length-this.props.slots);return this.pagingOffset=W.clamp(g,0,I),this.pagingOffset%2&&this.pagingOffset++,this.updateSlots(this.props.sidebarModel.activeTab.items,this.props.slots),P!==this.pagingOffset}pageDown(){return this.scrollToOffset(this.pagingOffset+this.props.slots)}pageUp(){return this.scrollToOffset(this.pagingOffset-this.props.slots)}createLabelImages(g){return[{text:this.props.strings.get("TXT_READY"),type:K.Ready},{text:this.props.strings.get("TXT_HOLD"),type:K.OnHold}].map(P=>this.createTextBox(P.text,g))}createQuantityImages(g){let P={paddingRight:2},I=new Array(u.MAX_QUANTITY).fill(0).map((I,L)=>this.createTextBox(""+(L+1),g,P));return I.push(this.createTextBox("",g,P)),I}createTextBox(g,P,I){var L={color:P,backgroundColor:"rgba(0, 0, 0, .5)",fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:12,fontWeight:"500",paddingTop:5,paddingBottom:5,paddingLeft:2,paddingRight:4,...I};if("string"==typeof g&&-1!==g.indexOf("\n")){let P=g.split(/\r?\n/),I=Math.max(1,L.fontSize??12),G=2,q=document.createElement("canvas"),$=!L.backgroundColor||!!L.backgroundColor.match(/^rgba/),Q=q.getContext("2d",{alpha:$});if(!Q)return q;Q.font=L.fontWeight+` ${I}px `+L.fontFamily;let Y=0,Z=Q.measureText("A"),X=Math.ceil(Z.actualBoundingBoxAscent+Z.actualBoundingBoxDescent||1.2*I);for(let g of P){var _=Q.measureText(g);Y=Math.max(Y,Math.ceil(Math.max(_.width,Math.abs(_.actualBoundingBoxLeft)+Math.abs(_.actualBoundingBoxRight))))}var U=L.paddingLeft??0,V=L.paddingRight??0,W=L.paddingTop??0,z=L.paddingBottom??0,K=P.length*X+Math.max(0,P.length-1)*G;if(q.width=Math.max(1,Y+U+V),q.height=Math.max(1,K+W+z),Q=q.getContext("2d",{alpha:$}),!Q)return q;L.backgroundColor&&(Q.fillStyle=L.backgroundColor,Q.fillRect(0,0,q.width,q.height)),Q.font=L.fontWeight+` ${I}px `+L.fontFamily,Q.fillStyle=L.color,Q.textAlign="center",Q.textBaseline="top";let J=q.width/2,ee=(q.height-K)/2,te=Math.max(1,q.width-U-V);for(let g=0;g<P.length;g++)Q.fillText(P[g],J+.5,ee+g*(X+G)+.5,te);return q}return G.OverlayUtils.createTextBox(g,L)}},g("SidebarCard",q),q.MAX_QUANTITY=99,q.labelImageCache=new Map,q.quantityImageCache=new Map}}}),System.register("gui/screen/game/component/hud/SidebarCredits",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","gui/component/UiText"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){V=class extends _.UiComponent{createUiObject(){return new L.UiObject(new THREE.Object3D,new U.HtmlContainer)}defineChildren(){var{textColor:g,width:P,height:L,zIndex:_}=this.props;return I.jsx(G.UiText,{ref:g=>this.text=g,value:"",textColor:g,width:P,height:L,zIndex:_})}onFrame(g){var{sidebarModel:{credits:P,topTextLeftAlign:I}}=this.props;this.targetCredits!==P&&(this.targetCredits=P,_=Math.abs(P-(this.renderedCredits??0)),L=THREE.Math.lerp(300,2e3,Math.min(1,_/5e3)),this.tickSpeed=_/L);var L,_=this.tickSpeed;(!this.lastUpdate||50<=g-this.lastUpdate)&&(L=this.lastUpdate?g-this.lastUpdate:0,this.lastUpdate=g,this.renderedCredits!==P&&(void 0===this.renderedCredits?this.renderedCredits=0:(P-=this.renderedCredits,L*=_,this.renderedCredits+=Math.abs(P)>=L?Math.sign(P)*L:P,this.props.onTick(1===Math.sign(P)?"up":"down")),this.text.setValue(""+Math.floor(this.renderedCredits))),I!==this.lastLeftAligned&&(I?(this.text.setTextAlign("left"),this.text.getUiObject().setPosition(15,0)):(this.text.setTextAlign("center"),this.text.getUiObject().setPosition(0,0)),this.lastLeftAligned=I))}},g("SidebarCredits",V)}}}),System.register("gui/screen/game/component/hud/SidebarGameTime",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","gui/component/UiText","util/format"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){W=class extends _.UiComponent{createUiObject(){return new L.UiObject(new THREE.Object3D,new U.HtmlContainer)}defineChildren(){var{textColor:g,width:P,height:L,zIndex:_}=this.props;return I.jsx(G.UiText,{ref:g=>this.text=g,value:"",textColor:g,width:P,height:L,zIndex:_})}onFrame(g){var{sidebarModel:{currentGameTime:P,replayTime:I,topTextLeftAlign:L}}=this.props;(!this.lastUpdate||50<=g-this.lastUpdate)&&(this.lastUpdate=g,this.lastGameTime!==P&&(this.text.setValue(V.formatTimeDuration(P)+(I?" / "+V.formatTimeDuration(I):"")),this.lastGameTime=P),L!==this.lastLeftAligned&&(L?(this.text.setTextAlign("left"),this.text.getUiObject().setPosition(15,0)):(this.text.setTextAlign("center"),this.text.getUiObject().setPosition(0,0)),this.lastLeftAligned=L))}},g("SidebarGameTime",W)}}}),System.register("gui/screen/game/component/hud/SidebarIconButton",["gui/jsx/jsx","gui/jsx/UiComponent","gui/UiObject"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class extends L.UiComponent{constructor(){super(...arguments),this.toggle=this.props.toggle,this.disabled=!!this.props.disabled,this.handleMouseDown=()=>{this.disabled||(void 0===this.toggle&&this.sprite.setFrame((this.props.imageFrameOffset??0)+1),document.addEventListener("mouseup",this.onDocumentMouseUp),document.addEventListener("touchend",this.onDocumentMouseUp),document.addEventListener("touchcancel",this.onDocumentMouseUp))},this.onDocumentMouseUp=()=>{void 0===this.toggle&&this.sprite.setFrame((this.props.imageFrameOffset??0)+0),document.removeEventListener("mouseup",this.onDocumentMouseUp),document.removeEventListener("touchend",this.onDocumentMouseUp),document.removeEventListener("touchcancel",this.onDocumentMouseUp)}}createUiObject(){return new _.UiObject(new THREE.Object3D)}defineChildren(){let{image:g,imageFrameOffset:P,palette:L,x:_,y:U,onClick:G,tooltip:V}=this.props;return I.jsx("sprite",{image:g,palette:L,x:_,y:U,frame:this.getBaseFrameNo(P??0),onClick:g=>0===g.button&&!this.disabled&&G?.(),onMouseDown:this.handleMouseDown,tooltip:V,ref:g=>this.sprite=g})}getBaseFrameNo(g){return g+(this.disabled?2:this.toggle?1:0)}setToggleState(g){this.toggle!==g&&(this.toggle=g,this.sprite.setFrame(this.getBaseFrameNo(this.props.imageFrameOffset??0)))}setDisabled(g){g!==this.disabled&&(this.disabled=g,this.sprite.setFrame(this.getBaseFrameNo(this.props.imageFrameOffset??0)))}onDispose(){document.removeEventListener("mouseup",this.onDocumentMouseUp),document.removeEventListener("touchend",this.onDocumentMouseUp),document.removeEventListener("touchcancel",this.onDocumentMouseUp)}},g("SidebarIconButton",U)}}}),System.register("gui/screen/game/component/hud/SidebarMenu",["gui/jsx/jsx","gui/component/MenuButton","gui/UiObject","gui/HtmlContainer","gui/jsx/HtmlView","gui/jsx/UiComponent"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){W=class extends V.UiComponent{createUiObject(){return new _.UiObject(new THREE.Object3D,new U.HtmlContainer)}defineChildren(){return this.props.buttons.map((g,P)=>this.createButton(g,P))}createButton(g,P){var _=this.props.buttonImg;let U={x:0,y:P*_.height};g.isBottom&&(U.y=this.props.menuHeight-_.height);var V={x:U.x,y:U.y,width:_.width,height:_.height};let W=I.createRef();return I.jsx("fragment",null,I.jsx("sprite",{image:_,palette:this.props.buttonPal,x:U.x,y:U.y,ref:W}),I.jsx(G.HtmlView,{component:L.MenuButton,props:{buttonConfig:{label:g.label,disabled:!!g.disabled},box:{x:V.x,y:V.y,width:V.width,height:V.height},onMouseDown:g=>{W.current.setFrame(1);let t=()=>{W.current.setFrame(0),document.removeEventListener("mouseup",t)};document.addEventListener("mouseup",t)},onClick:P=>{g.onClick&&g.onClick()}}}))}},g("SidebarMenu",W)}}}),System.register("gui/screen/game/component/hud/SidebarPower",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","data/Bitmap","engine/gfx/SpriteUtils","util/math","engine/gfx/TextureUtils","engine/renderable/entity/HighlightAnimRunner","util/BoxedVar","util/array","engine/gfx/material/PaletteBasicMaterial"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g}],execute:function(){var P;Y=(g,P)=>g.green===P.green&&g.yellow===P.yellow&&g.red===P.red,(P=Z=Z||{})[P.None=0]="None",P[P.Green=1]="Green",P[P.Yellow=2]="Yellow",P[P.Red=3]="Red",P[P.Highlight=4]="Highlight",X=class extends _.UiComponent{constructor(){super(...arguments),this.visible=!0,this.pipHighlightAnimRunner=new K.HighlightAnimRunner(new q.BoxedVar(1),1,2,15)}createUiObject(){let g=new L.UiObject(new THREE.Object3D,new U.HtmlContainer);g.setPosition(this.props.x||0,this.props.y||0),this.pips=this.createPips(this.props.powerImg);var P=this.props.powerImg.width,I=this.props.height;return this.textureBitmap=new G.IndexedBitmap(P,I),this.texture=this.createDataTexture(this.textureBitmap.data,P,I),this.mesh=this.createMesh(P,I),g}createPips(g){let P=[];for(let L=0;L<g.numImages;L++){var I=g.getImage(L);P.push(new G.IndexedBitmap(I.width,I.height,I.imageData))}return P}createDataTexture(g,P,I){let L=new THREE.DataTexture(g,P,I,THREE.AlphaFormat);return L.needsUpdate=!0,L.minFilter=THREE.NearestFilter,L.magFilter=THREE.NearestFilter,L}createMesh(g,P){let I=V.SpriteUtils.createRectGeometry(g,P);V.SpriteUtils.addRectUvs(I,{x:0,y:0,width:g,height:P},{width:g,height:P}),I.translate(g/2,P/2,0);var L=new Q.PaletteBasicMaterial({map:this.texture,palette:z.TextureUtils.textureFromPalette(this.props.palette),side:THREE.DoubleSide});let _=new THREE.Mesh(I,L);return _.frustumCulled=!1,_}defineChildren(){return I.jsx("mesh",{zIndex:this.props.zIndex,ref:g=>this.meshEvtTarget=g,onClick:()=>{}},this.mesh)}onFrame(g){this.getUiObject().get3DObject().visible=this.visible;var P=(I=this.props.sidebarModel).powerDrained,I=I.powerGenerated;let L=!1;this.lastPowerDrained===P&&this.lastPowerGenerated===I||(this.lastPowerDrained=P,this.lastPowerGenerated=I,this.meshEvtTarget.setTooltip(this.props.strings.get("TXT_POWER_DRAIN",I,P)),_=(z=Math.max(I,P))?Math.min(1,P/z):1,V=z?Math.min(1,W.clamp(I-P,0,100)/z):0,G=this.pips[0].height+1,U=z?this.computeHeightFromPowerLevel(Math.max(100,z)):1,this.targetPipCount={green:Math.floor((1-_-V)*U/G),yellow:Math.floor(V*U/G),red:z?Math.floor(_*U/G):1},this.pipHighlightAnimRunner.animation.stop(),L=!0);var _,U,G,V=this.targetPipCount,z=this.pipCount&&Y(this.pipCount,V);this.lastPipUpdate&&!(50<=g-this.lastPipUpdate)||z||(this.lastPipUpdate=g,this.pipCount?(_=Math.sign(V.red-this.pipCount.red),U=Math.sign(V.yellow-this.pipCount.yellow),G=Math.sign(V.green-this.pipCount.green),_?0<_&&(this.pipCount.yellow>_?this.pipCount.yellow=Math.max(0,this.pipCount.yellow-_):this.pipCount.green=Math.max(0,this.pipCount.green-_)):(U?0<U&&(this.pipCount.green=Math.max(0,this.pipCount.green-U)):this.pipCount.green+=G,this.pipCount.yellow+=U),this.pipCount.red+=_):this.pipCount={red:1,yellow:0,green:0},this.updateTexture(this.pipCount,!0),Y(this.pipCount,V)&&this.pipHighlightAnimRunner.animate(10)),z&&(L&&this.pipHighlightAnimRunner.animate(10),this.pipHighlightAnimRunner.shouldUpdate()&&(V=!!this.pipHighlightAnimRunner.getValue(),this.pipHighlightAnimRunner.tick(g),(z=!!this.pipHighlightAnimRunner.getValue())!=V&&this.updateTexture(this.pipCount,z)))}computeHeightFromPowerLevel(g){return W.clamp((Math.log10((g/100+5)/5e7)/(g/100+3)+2)/2,0,1)*this.props.height}updateTexture(g,P){var I,L=this.pips[0].height,_=this.props.height,U=L+1;let G=[[[Z.None,Math.floor(_/L),L]],[[Z.Red,g.red,U],[Z.Yellow,g.yellow,U],[Z.Green,g.green,U]]];if(P){let g=$.findReverse(G[1],([,g])=>0<g);g&&g[1]--,G[1].push([Z.Highlight,1,U])}for(I of G){let g=_-L;for(var[V,W,z]of I){var K=this.pips[V];for(let P=0;P<W;P++)this.textureBitmap.drawIndexedImage(K,0,g),g-=z}}this.texture.needsUpdate=!0}hide(){this.visible=!1}show(){this.visible=!0}onDispose(){this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.texture.dispose()}},g("SidebarPower",X)}}}),System.register("gui/screen/game/component/hud/SidebarRadar",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","gui/screen/game/component/hud/SidebarRadarAnimRunner"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){V=class extends _.UiComponent{constructor(){super(...arguments),this.visible=!0}createUiObject(){let g=new L.UiObject(new THREE.Object3D,new U.HtmlContainer);return g.setPosition(this.props.x||0,this.props.y||0),g}defineChildren(){return I.jsx("fragment",null,I.jsx("sprite",{image:this.props.image,palette:this.props.palette,zIndex:this.props.zIndex,ref:g=>this.cover=g,animationRunner:new G.SidebarRadarAnimationRunner(this.props.image)}),I.jsx("container",{ref:g=>this.minimapContainer=g,hidden:!0,x:13}))}onFrame(g){this.getUiObject().get3DObject().visible=this.visible;var P=this.props.sidebarModel;(P=P?.radarEnabled??!0)!==this.coverOpen&&(this.toggleCover(P,void 0===this.coverOpen),this.coverOpen=P),this.cover.getAnimationRunner().isStopped()&&this.minimapContainer.setVisible(this.coverOpen)}toggleCover(g,P=!1){let I=this.cover.getAnimationRunner();g?I.radarOn(P):I.radarOff(P),this.minimapContainer.setVisible(!!P&&g)}setMinimap(g){this.minimap&&this.minimapContainer.remove(this.minimap),(this.minimap=g)&&(g.setFitSize(this.getMinimapAvailSpace()),this.minimapContainer.add(g),g.setZIndex(this.props.zIndex+1))}getMinimapAvailSpace(){return{width:this.props.image.width-13-15,height:this.props.image.height}}hide(){this.visible=!1}show(){this.visible=!0}},g("SidebarRadar",V)}}}),System.register("gui/screen/game/component/hud/SidebarRadarAnimRunner",["data/IniSection","engine/Animation","engine/AnimProps","engine/Engine","util/BoxedVar"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){var P;(P=V||g("AnimationType",V={}))[P.None=0]="None",P[P.RadarOff=1]="RadarOff",P[P.RadarOn=2]="RadarOn",g("SidebarRadarAnimationRunner",class{constructor(g){this.shpFile=g,this.closed=!0,this.currentAnimationType=V.None}radarOff(g=!1){this.currentAnimationType=V.RadarOff,g||this.initAnimation()}radarOn(g=!1){this.currentAnimationType=V.RadarOn,g||this.initAnimation()}initAnimation(){var g=new I.IniSection("");g=new _.AnimProps(g,this.shpFile),g=new L.Animation(g,new G.BoxedVar(U.Engine.UI_ANIM_SPEED));this.animation=g}tick(g){let P=this.animation;var I=this.currentAnimationType;if(P&&I!==V.None){switch(P.getState()){case L.AnimationState.STOPPED:break;case L.AnimationState.NOT_STARTED:P.start(g);case L.AnimationState.RUNNING:default:P.update(g)}P.getState()===L.AnimationState.STOPPED&&(this.closed=I===V.RadarOff,this.currentAnimationType=V.None)}}shouldUpdate(){return!0}isStopped(){return this.currentAnimationType===V.None}getCurrentFrame(){if(!this.animation)return this.currentAnimationType===V.RadarOn?this.shpFile.numImages-1:0;let g=this.currentAnimationType===V.RadarOff?-1:1;this.currentAnimationType===V.None&&this.closed&&(g*=-1);let P=0;return-1===g&&(P=this.animation.props.end),P+g*this.animation.getCurrentFrame()}})}}}),System.register("gui/screen/game/component/hud/SidebarTabs",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class extends _.UiComponent{constructor(){super(...arguments),this.tabObjects=[],this.flashing=!1}createUiObject(){let g=new L.UiObject(new THREE.Object3D);return g.setPosition(this.props.x||0,this.props.y||0),g}defineChildren(){let{aggregatedImageData:g,images:P,palette:L,tabSpacing:_,onTabClick:U,sidebarModel:G,strings:V}=this.props,W=[];for(let K=0;K<4;K++){var z=P[K];const q=this.props.aggregatedImageData.imageIndexes.get(z);if(void 0===q)throw new Error(`Tab ${K} image not found in aggregated file`);W.push(I.jsx("sprite",{image:g.file,palette:L,x:(_+z.width)*K,tooltip:V.get("Tip:Tab"+(K+1)),onClick:g=>{var P;0===g.button&&((P=G.tabs[K]).disabled||U?.(P))},onFrame:(g,P)=>this.handleFrame(g,P,G.tabs[K],q)}))}return W}handleFrame(g,P,I,L){let _;(!this.lastFlashUpdate||250<=g-this.lastFlashUpdate)&&(this.lastFlashUpdate=g,this.flashing=!this.flashing),_=I.disabled?2:this.props.sidebarModel.activeTab===I?1:0,I.flashing&&this.flashing&&(_=3),P.setFrame(L+_)}},g("SidebarTabs",U)}}}),System.register("gui/screen/game/component/hud/SuperWeaponTimers",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","engine/gfx/SpriteUtils","engine/gfx/CanvasUtils","game/GameSpeed","util/format"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g}],execute:function(){K=class extends _.UiComponent{createUiObject(){let g=new L.UiObject(new THREE.Object3D,new U.HtmlContainer);g.setPosition(this.props.x||0,this.props.y||0);var P=this.props.width,I=this.props.height;let _=document.createElement("canvas");return _.width=P,_.height=I,this.ctx=_.getContext("2d",{alpha:!0}),this.texture=this.createTexture(_),this.mesh=this.createMesh(P,I),g}createTexture(g){let P=new THREE.Texture(g);return P.needsUpdate=!0,P.flipY=!1,P.minFilter=THREE.NearestFilter,P.magFilter=THREE.NearestFilter,P}createMesh(g,P){let I=G.SpriteUtils.createRectGeometry(g,P);G.SpriteUtils.addRectUvs(I,{x:0,y:0,width:g,height:P},{width:g,height:P}),I.translate(g/2,P/2,0);var L=new THREE.MeshBasicMaterial({map:this.texture,side:THREE.DoubleSide,transparent:!0});let _=new THREE.Mesh(I,L);return _.frustumCulled=!1,_}defineChildren(){return I.jsx("mesh",{zIndex:this.props.zIndex},this.mesh)}onFrame(g){if(!this.lastUpdate||100<=g-this.lastUpdate){this.lastUpdate=g;let J=[];var P,I;this.props.stalemateDetectTrait?.isStale()&&(P=Math.floor(this.props.stalemateDetectTrait.getCountdownTicks()/W.GameSpeed.BASE_TICKS_PER_SECOND),P=this.props.strings.get("TS:StalemateTimer")+"   "+z.formatTimeDuration(P,!0),J.push({text:P,color:"red",flash:!0}));let ee=this.props.countdownTimer;for(I of(ee.isRunning()&&(Q=ee.getSeconds(),Q=(void 0!==ee.text?this.props.strings.get(ee.text)+"   ":"")+z.formatTimeDuration(Q,!0),J.push({text:Q,color:this.props.localPlayer?.color.asHexString()??"white",flash:!1})),this.props.players))if(!I.defeated){var L=I.superWeaponsTrait?.getAll(),_=(I.powerTrait?.getBlackoutDuration()??0)/W.GameSpeed.BASE_TICKS_PER_SECOND;if(L?.length||_){var U,G,V=I.color.asHexString();let g=[];if(L)for(var K of L)K.rules.showTimer&&g.push({seconds:K.getTimerSeconds(),label:this.props.strings.get(K.rules.uiName)});for({seconds:U,label:G}of(_&&g.push({seconds:_,label:this.props.strings.get("MSG:BlackoutTimer")}),g)){var q=Math.floor(U),$=G+"   "+z.formatTimeDuration(q,!0);J.push({text:$,color:V,flash:0===q})}}}var Q=!!J.length;if(Q!==this.lastHasTimers||Q){this.lastHasTimers=Q,this.ctx.clearRect(0,0,this.props.width,this.props.height);let P=this.props.height-20;for(var{text:Y,color:Z,flash:X}of J)X&&(Z=Math.floor(g/1e3)%2?Z:"orange"),P-=this.drawLine(Y,Z,P);this.texture.needsUpdate=!0}}}drawLine(g,P,I){return V.CanvasUtils.drawText(this.ctx,g,0,I,{color:P,fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:12,fontWeight:"500",paddingTop:6,height:20,backgroundColor:"rgba(0, 0, 0, .75)",textAlign:"right",paddingLeft:4,paddingRight:4}).height}onDispose(){this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.texture.dispose()}},g("SuperWeaponTimers",K)}}}),System.register("gui/screen/game/component/hud/viewmodel/CombatantSidebarModel",["game/rules/TechnoRules","game/player/production/ProductionQueue","engine/type/ObjectType","game/gameobject/trait/DockTrait","gui/screen/game/component/hud/viewmodel/SidebarModel","game/SuperWeapon"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){W=(new Map).set(V.SuperWeaponStatus.Charging,G.SidebarItemStatus.Started).set(V.SuperWeaponStatus.Paused,G.SidebarItemStatus.OnHold).set(V.SuperWeaponStatus.Ready,G.SidebarItemStatus.Ready),z=class extends G.SidebarModel{get credits(){return Math.floor(this.player.credits)}get radarEnabled(){return!(!this.player.radarTrait||this.player.radarTrait.isDisabled())}constructor(g,P){super(P),this.player=g,this.rules=P.rules}computePurchaseCost(g){return this.game.sellTrait.computePurchaseValue(g,this.player)}updateAvailableObjects(g){if(!this.player.production)throw new Error("Player is not a combatant");var P,I,L,_=this.sortAvailableObjects(this.player.production.getAvailableObjects());for(P of this.tabs)P.items.length=0,P.needsUpdate=!0;for(I of(this.updateSuperWeaponItems(),_)){var U=g.getObject(I.name,I.type);let P=this.tabs[this.getSidebarCategoryForQueueType(this.player.production.getQueueTypeForObject(I))];var V=this.player.production.getQueueForObject(I),W=this.player.production.getFactoryTypeForQueueType(V.type);U={target:{type:G.SidebarItemTargetType.Techno,rules:I},cameo:this.player.production.hasVeteranType(W)&&I.trainable?U.altCameo:U.cameo,disabled:!1,progress:0,quantity:0,status:G.SidebarItemStatus.Idle};P.items.push(U),this.updateSidebarTechnoItem(U,V,this.player.production)}for(L of this.tabs)this.updateTabFlashing(L);this.updateActiveTab()}updateActiveTab(){var g;0!==this.activeTab.items.length||void 0!==(g=this.tabs.find(g=>0<g.items.length)?.id)&&this.selectTab(g)}updateFromQueue(g){if(!this.player.production)throw new Error("Player is not a combatant");let P=this.tabs[this.getSidebarCategoryForQueueType(g.type)];for(var I of(P.needsUpdate=!0,P.items))I.target.type===G.SidebarItemTargetType.Techno&&this.player.production.getQueueForObject(I.target.rules)===g&&this.updateSidebarTechnoItem(I,g,this.player.production);this.updateTabFlashing(P)}updateSuperWeapons(){this.updateSuperWeaponItems(),this.updateActiveTab()}updateSuperWeaponItems(){let g=this.player.superWeaponsTrait?.getAll().slice().sort((g,P)=>1e3*(g.rules.rechargeTime-P.rules.rechargeTime)+g.name.charCodeAt(0)-P.name.charCodeAt(0)),P=this.tabs[G.SidebarCategory.Armory];P.needsUpdate=!0;var I=P.items.findIndex(g=>g.target.type===G.SidebarItemTargetType.Techno);-1!==I?P.items.splice(0,I):P.items.length=0,I=g?.map(g=>{var P=W.get(g.status);if(void 0===P)throw new Error(`Unhandled super weapon status "${g.status}"`);return{target:{type:G.SidebarItemTargetType.Special,rules:g.rules},cameo:g.rules.sidebarImage,disabled:!1,progress:g.getChargeProgress(),quantity:1,status:P}}),I&&P.items.unshift(...I),this.updateTabFlashing(P)}updateTabFlashing(g){g.flashing=g.items.some(g=>g.status===G.SidebarItemStatus.Ready)}updateSidebarTechnoItem(g,P,L){if(g.target.type===G.SidebarItemTargetType.Special)throw new Error("Sidebar item must be of type Techno");let V=g.target.rules,W=[...this.player.buildings],z=!1;if(Number.isFinite(V.buildLimit)){let g;g=0<=V.buildLimit?(V.type===_.ObjectType.Building?W:this.player.getOwnedObjectsByType(V.type,!0)).filter(g=>g.name===V.name).length:this.player.getLimitedUnitsBuilt(V.name),z=g>=Math.abs(V.buildLimit)}this.rules.general.padAircraft.includes(V.name)&&(q=W.filter(g=>g.factoryTrait?.type===I.FactoryType.AircraftType&&g.helipadTrait).reduce((g,P)=>g+(P.traits.find(U.DockTrait)?.numberOfDocks??0),0),z=z||[...this.player.getOwnedObjectsByType(_.ObjectType.Aircraft,!0)].filter(g=>this.rules.general.padAircraft.includes(g.name)).length>=q);let K=L.getFactoryTypeForQueueType(P.type);var q=W.filter(g=>g.factoryTrait?.type===K&&!g.warpedOutTrait.isActive());let $=P.find(V);g.progress=$.length?$[0].progress:0,g.quantity=$.reduce((g,P)=>g+P.quantity,0),g.status=this.computeStatus(P,$[0]),g.disabled=1===P.maxSize&&$[0]!==P.getFirst()||z||!q.length&&(!P.currentSize||$[0]!==P.getFirst())}getTabForQueueType(g){return this.tabs[this.getSidebarCategoryForQueueType(g)]}getSidebarCategoryForQueueType(g){switch(g){case L.QueueType.Structures:return G.SidebarCategory.Structures;case L.QueueType.Armory:return G.SidebarCategory.Armory;case L.QueueType.Infantry:return G.SidebarCategory.Infantry;case L.QueueType.Vehicles:case L.QueueType.Ships:case L.QueueType.Aircrafts:return G.SidebarCategory.Vehicles;default:throw new Error("Unhandled queueType "+L.QueueType[g])}}computeStatus(g,P){return P?g.getFirst()===P?g.status===L.QueueStatus.Ready?G.SidebarItemStatus.Ready:g.status===L.QueueStatus.OnHold?G.SidebarItemStatus.OnHold:G.SidebarItemStatus.Started:G.SidebarItemStatus.InQueue:G.SidebarItemStatus.Idle}sortAvailableObjects(g){return[...g].sort((g,P)=>{var I=this.getObjectTypeSortValue(g),L=this.getObjectTypeSortValue(P);return I===L?g.aiBasePlanningSide===P.aiBasePlanningSide?g.techLevel===P.techLevel?g.prerequisite.length<P.prerequisite.length?-1:1:g.techLevel<P.techLevel?-1:1:(g.aiBasePlanningSide??-1)<(P.aiBasePlanningSide??-1)?-1:1:I-L})}getObjectTypeSortValue(g){return g.type===_.ObjectType.Aircraft?1:g.type===_.ObjectType.Vehicle?g.naval?2:g.consideredAircraft?1:0:0}},g("CombatantSidebarModel",z)}}}),System.register("gui/screen/game/component/hud/viewmodel/MessageList",["util/event"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("MessageList",class{get onNewMessage(){return this._onNewMessage.asEvent()}constructor(g,P,L){this.messageDurationSeconds=g,this.maxMessages=P,this.localPlayer=L,this.isComposing=!1,this.messages=[],this._onNewMessage=new I.EventDispatcher}addUiFeedbackMessage(g){var P={text:g,color:this.localPlayer?.color.asHexString()??"grey",time:Date.now(),animate:!1};this.messages.push(P),this._onNewMessage.dispatch(this,P)}addSystemMessage(g,P,I){var L={text:g,color:"string"==typeof P?P:P.color.asHexString(),time:Date.now(),animate:!0,durationSeconds:I};this.messages.push(L),this._onNewMessage.dispatch(this,L)}addChatMessage(g,P){var I={text:g,color:P,time:Date.now(),animate:!0};this.messages.push(I),this._onNewMessage.dispatch(this,I)}prune(){let g=Date.now();this.messages=this.messages.filter(P=>P.time>=g-1e3*(P.durationSeconds??this.messageDurationSeconds)),this.messages.splice(0,this.messages.length-this.maxMessages)}getAll(){return this.messages}})}}}),System.register("gui/screen/game/component/hud/viewmodel/SidebarModel",["gui/screen/game/component/hud/viewmodel/SidebarTab","game/GameSpeed"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){var P;(P=_||g("SidebarItemTargetType",_={}))[P.Techno=0]="Techno",P[P.Special=1]="Special",(P=U||g("SidebarItemStatus",U={}))[P.Idle=0]="Idle",P[P.InQueue=1]="InQueue",P[P.Started=2]="Started",P[P.OnHold=3]="OnHold",P[P.Ready=4]="Ready",(P=G||g("SidebarCategory",G={}))[P.Structures=0]="Structures",P[P.Armory=1]="Armory",P[P.Infantry=2]="Infantry",P[P.Vehicles=3]="Vehicles",g("SidebarModel",class{constructor(g,P){this.game=g,this.replay=P,this.powerDrained=0,this.powerGenerated=0,this.sellMode=!1,this.repairMode=!1,this.topTextLeftAlign=!1,this.tabs=[new I.SidebarTab(G.Structures),new I.SidebarTab(G.Armory),new I.SidebarTab(G.Infantry),new I.SidebarTab(G.Vehicles)],this.activeTabId=G.Structures}get activeTab(){return this.tabs[this.activeTabId]}get currentGameTime(){return Math.floor(this.game.currentTime/1e3)}get replayTime(){return this.replay?Math.floor(this.replay.endTick/L.GameSpeed.BASE_TICKS_PER_SECOND):void 0}selectTab(g){this.tabs[g].disabled||(this.activeTabId=g)}})}}}),System.register("gui/screen/game/component/hud/viewmodel/SidebarTab",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("SidebarTab",class{constructor(g){this.items=[],this.needsUpdate=!0,this.flashing=!1,this.id=g}get disabled(){return!this.items.length}})}}}),System.register("gui/screen/game/component/hud/VirtualJoystickLite",["gui/screen/game/worldInteraction/keyboard/KeyCommandType"],function(g,P){"use strict";var I,L="ra2web.mobileJoystickLite.enabled";function a(g,P,I){return Math.max(P,Math.min(I,g))}function o(g){try{g.preventDefault()}catch(g){}try{g.stopPropagation()}catch(g){}try{g.stopImmediatePropagation?.()}catch(g){}}function l(g,P,I,L){return g.addEventListener(P,I,L),()=>{try{g.removeEventListener(P,I,L)}catch(g){}}}return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("VirtualJoystickLite",class{constructor({pointerEvents:g,battleControlApi:P,canvasMetrics:I,getWorldInteraction:L,localPrefs:_}){this.pointerEvents=g,this.battleControlApi=P,this.canvasMetrics=I,this.getWorldInteraction="function"==typeof L?L:()=>{},this.localPrefs=_,this.disposers=[],this.deadZone=.12,this.maxPanRadius=32,this.menuOpen=!1,this.holdMode=void 0,this.holdTouchId=void 0,this.joystickTouchId=void 0,this.joystickMouseDown=!1,this.quickTouchId=void 0,this.quickTouchKey=void 0,this.quickMouseDown=!1,this.quickMouseKey=void 0,this.buttonHitInnerRatio=0,this.buttonHitOuterRatio=1,this.deadZonePolygon=[{x:47,y:61},{x:86,y:10},{x:125,y:61},{x:176,y:100},{x:125,y:139},{x:86,y:190},{x:47,y:139},{x:-4,y:100}],this.buttonDefs=[{key:"home",label:"",hold:!1,dirIndex:0},{key:"cancel",label:"",hold:!0,dirIndex:1},{key:"next",label:"",hold:!1,dirIndex:2},{key:"force",label:"",hold:!0,dirIndex:3},{key:"scatter",label:"",hold:!1,dirIndex:4},{key:"combat",label:"",hold:!1,dirIndex:5},{key:"view",label:"",hold:!1,dirIndex:6},{key:"event",label:"",hold:!1,dirIndex:7}],this.buttons=[],this.buttonsByKey=new Map,this.enabled=this.readEnabledFlag(),this.onCanvasTouchStartCapture=g=>{if(this.menuOpen)return;let P=!1,I=!1;for(let _ of Array.from(g.changedTouches||[]))if(_.identifier!==this.holdTouchId&&_.identifier!==this.joystickTouchId){var L=this.pointFromTouch(_);if(this.holdMode)L&&(this.applyHoldTap(L),P=!0);else if(this.isDeadZoneClientPoint(_.clientX,_.clientY)){!!L&&this.isHudPoint(L)||(I=!0)}}(P||I)&&(this.pointerEvents?.resetTouchState?.(),o(g))},this.onCanvasMouseDownCapture=g=>{if(!this.menuOpen&&!this.rootEl?.contains(g.target)){var P=this.pointFromMouseEvent(g);this.holdMode&&P?(this.applyHoldTap(P),this.pointerEvents?.resetTouchState?.(),o(g)):!this.holdMode&&this.isDeadZoneClientPoint(g.clientX,g.clientY)&&P&&!this.isHudPoint(P)&&(this.pointerEvents?.resetTouchState?.(),o(g))}},this.onJoystickTouchStart=g=>{if(!this.menuOpen&&void 0===this.joystickTouchId){var P=g.changedTouches?.[0];P&&(this.joystickTouchId=P.identifier,this.updatePanFromClientPoint(P.clientX,P.clientY),o(g))}},this.onWindowTouchMove=g=>{if(void 0!==this.joystickTouchId&&!this.menuOpen)for(let P of Array.from(g.changedTouches||[]))if(P.identifier===this.joystickTouchId){this.updatePanFromClientPoint(P.clientX,P.clientY),o(g);break}},this.onWindowTouchEnd=g=>{if(void 0!==this.joystickTouchId)for(let P of Array.from(g.changedTouches||[]))if(P.identifier===this.joystickTouchId){this.stopPan(),this.joystickTouchId=void 0,o(g);break}},this.onJoystickMouseDown=g=>{this.menuOpen||(this.joystickMouseDown=!0,this.updatePanFromClientPoint(g.clientX,g.clientY),o(g))},this.onWindowMouseMove=g=>{this.joystickMouseDown&&this.updatePanFromClientPoint(g.clientX,g.clientY)},this.onWindowMouseUp=()=>{this.joystickMouseDown&&(this.joystickMouseDown=!1,this.stopPan())},this.onWindowHoldTouchEnd=g=>{if(void 0!==this.holdTouchId)for(let P of Array.from(g.changedTouches||[]))if(P.identifier===this.holdTouchId){this.clearHoldMode(),o(g);break}}}readEnabledFlag(){var g=this.localPrefs?.getItem?.(L);return"0"!==g&&("1"===g||(!!window.matchMedia?.("(pointer: coarse)")?.matches||(navigator.maxTouchPoints??0)>0||"ontouchstart"in window))}mount(g){return!(!g||this.rootEl)&&(this.hostEl=g,this.canvasEl=this.canvasMetrics?.canvas,this.canvasEl&&(this.previousCanvasTouchAction=this.canvasEl.style.touchAction,this.canvasEl.style.touchAction="none"),this.initDom(),this.bindEvents(),this.setEnabled(this.enabled,!1),!0)}initDom(){var g=document.createElement("div");g.className="ra2web-vjoy-lite",g.style.position="absolute",g.style.left="0",g.style.top="0",g.style.right="0",g.style.bottom="0",g.style.pointerEvents="none",g.style.userSelect="none",g.style.zIndex="60",this.rootEl=g;var P=document.createElement("div");P.style.position="absolute",P.style.left="max(env(safe-area-inset-left), 56px)",P.style.bottom="max(env(safe-area-inset-bottom), 56px)",P.style.width="186px",P.style.height="186px",P.style.pointerEvents="none",this.clusterEl=P;var I=document.createElement("div");I.style.position="absolute",I.style.left="42px",I.style.bottom="42px",I.style.width="88px",I.style.height="88px",I.style.borderRadius="44px",I.style.pointerEvents="auto",I.style.touchAction="none",this.joystickTouchPad=I;var L=document.createElement("div");L.style.position="absolute",L.style.left="12px",L.style.top="12px",L.style.width="64px",L.style.height="64px",L.style.borderRadius="32px",L.style.background="rgba(255, 64, 64, 0.28)",L.style.border="2px solid rgba(255, 96, 96, 0.48)",L.style.boxSizing="border-box",L.style.pointerEvents="none",I.appendChild(L);var _=document.createElement("div");_.style.position="absolute",_.style.left="50%",_.style.top="50%",_.style.width="20px",_.style.height="20px",_.style.borderRadius="10px",_.style.transform="translate(-50%, -50%)",_.style.background="rgba(255, 224, 120, 0.82)",_.style.border="1px solid rgba(255, 240, 180, 0.75)",_.style.boxSizing="border-box",_.style.pointerEvents="none",this.knobEl=_,I.appendChild(_),P.appendChild(I),this.buttons=[],this.buttonsByKey?.clear?.(),(this.buttonDefs||[]).forEach(g=>{var I=this.getButtonPositionByDirIndex(g.dirIndex),L=this.createButton(g.label,I.left,I.bottom,g.key,g.hold);this.buttons.push(L),this.buttonsByKey?.set(g.key,L),P.appendChild(L.el)}),g.appendChild(P),this.hostEl.appendChild(g)}createButton(g,P,I,L,_){var U=document.createElement("div");return U.style.position="absolute",U.style.left=P+"px",U.style.bottom=I+"px",U.style.width="46px",U.style.height="46px",U.style.borderRadius="23px",U.style.pointerEvents="auto",U.style.touchAction="none",U.style.display="flex",U.style.alignItems="center",U.style.justifyContent="center",U.style.background="rgba(255, 64, 64, 0.28)",U.style.border="2px solid rgba(255, 96, 96, 0.48)",U.style.boxSizing="border-box",U.style.color="rgba(255, 236, 170, 0.92)",U.style.font="700 18px/1 sans-serif",U.style.letterSpacing="1px",U.style.webkitTapHighlightColor="transparent",U.dataset.vjoyKey=L,U.dataset.vjoyHold=_?"1":"0",U.textContent=g,{key:L,hold:_,el:U}}getButtonPositionByDirIndex(g){var P=Math.round(55/Math.SQRT2),I=[{x:-P,y:P},{x:0,y:90},{x:P,y:P},{x:90,y:0},{x:P,y:-P},{x:0,y:-90},{x:-P,y:-P},{x:-90,y:0}][g]||{x:0,y:0};return{left:86+I.x-23,bottom:86+I.y-23}}getButtonByKey(g){return this.buttonsByKey?.get(g)}getHoldButtons(){return(this.buttons||[]).filter(g=>g.hold)}bindEvents(){var g=this.canvasEl;this.onHostTouchStartCapture=g=>{if(!this.menuOpen){var P=g.changedTouches?.[0];if(P){var I=this.getHoldButtons();if(I.length){var L=I.filter(g=>this.isPointInButtonRing(g,P.clientX,P.clientY));if(L.length){var _=L.find(g=>"force"===g.key)||L[0],U=g.target;U===_.el||_.el.contains(U)||(this.setHoldMode(_.key,P.identifier),o(g))}}}}},this.disposers.push(l(this.hostEl,"touchstart",this.onHostTouchStartCapture,{capture:!0,passive:!1})),this.disposers.push(l(window,"touchend",this.onWindowHoldTouchEnd,{capture:!0,passive:!1})),this.disposers.push(l(window,"touchcancel",this.onWindowHoldTouchEnd,{capture:!0,passive:!1})),g&&(this.disposers.push(l(g,"touchstart",this.onCanvasTouchStartCapture,{capture:!0,passive:!1})),this.disposers.push(l(g,"mousedown",this.onCanvasMouseDownCapture,{capture:!0}))),this.disposers.push(l(this.joystickTouchPad,"touchstart",this.onJoystickTouchStart,{passive:!1})),this.disposers.push(l(window,"touchmove",this.onWindowTouchMove,{capture:!0,passive:!1})),this.disposers.push(l(window,"touchend",this.onWindowTouchEnd,{capture:!0,passive:!1})),this.disposers.push(l(window,"touchcancel",this.onWindowTouchEnd,{capture:!0,passive:!1})),this.disposers.push(l(this.joystickTouchPad,"mousedown",this.onJoystickMouseDown)),this.disposers.push(l(window,"mousemove",this.onWindowMouseMove)),this.disposers.push(l(window,"mouseup",this.onWindowMouseUp)),(this.buttons||[]).forEach(g=>this.bindButtonEvents(g))}bindButtonEvents(g){var P=g.el.dataset.vjoyKey,I="1"===g.el.dataset.vjoyHold,n=g=>this.setButtonPressedVisual(g,!0),i=g=>this.setButtonPressedVisual(g,!1),a=L=>{var _=!1;for(let g of Array.from(L.changedTouches||[]))I&&g.identifier===this.holdTouchId?(this.clearHoldMode(),_=!0):I||g.identifier!==this.quickTouchId||(this.quickTouchId=void 0,this.triggerQuickCommand(this.quickTouchKey||P),this.quickTouchKey=void 0,_=!0);_&&(i(g),o(L))};this.disposers.push(l(g.el,"touchstart",L=>{if(!this.menuOpen){var _=L.changedTouches?.[0];_&&this.isPointInButtonRing(g,_.clientX,_.clientY)&&(o(L),n(g),I?this.setHoldMode(P,_.identifier):(this.quickTouchId=_.identifier,this.quickTouchKey=P))}},{passive:!1})),this.disposers.push(l(g.el,"touchend",a,{passive:!1})),this.disposers.push(l(g.el,"touchcancel",a,{passive:!1})),this.disposers.push(l(g.el,"mousedown",L=>{this.menuOpen||this.isPointInButtonRing(g,L.clientX,L.clientY)&&(o(L),n(g),I?this.setHoldMode(P,"mouse"):(this.quickMouseDown=!0,this.quickMouseKey=P))})),this.disposers.push(l(window,"mouseup",L=>{I&&"mouse"===this.holdTouchId?(this.clearHoldMode(),i(g),o(L)):this.quickMouseDown&&(this.quickMouseDown=!1,this.triggerQuickCommand(this.quickMouseKey||P),this.quickMouseKey=void 0,i(g),o(L))}))}setButtonPressedVisual(g,P){g?.el&&(g.el.style.background=P?"rgba(255, 64, 64, 0.48)":"rgba(255, 64, 64, 0.28)",g.el.style.borderColor=P?"rgba(255, 120, 120, 0.72)":"rgba(255, 96, 96, 0.48)",g.el.style.transform=P?"scale(0.96)":"")}setHoldMode(g,P){this.holdMode!==g&&this.clearHoldMode(),this.holdMode=g,this.holdTouchId=P,this.getHoldButtons().forEach(P=>this.setButtonPressedVisual(P,P.key===g)),"force"===g&&this.battleControlApi?.applyKeyModifiers?.({ctrlKey:!0,shiftKey:!1,altKey:!1,metaKey:!1})}clearHoldMode(){"force"===this.holdMode&&this.battleControlApi?.applyKeyModifiers?.({ctrlKey:!1,shiftKey:!1,altKey:!1,metaKey:!1}),this.holdMode=void 0,this.holdTouchId=void 0,this.getHoldButtons().forEach(g=>this.setButtonPressedVisual(g,!1)),this.pointerEvents?.resetTouchState?.()}updatePanFromClientPoint(g,P){if(this.joystickTouchPad&&!this.menuOpen){var I=this.joystickTouchPad.getBoundingClientRect(),L=g-(I.left+I.width/2),_=P-(I.top+I.height/2),U=Math.sqrt(L*L+_*_)||1,G=Math.min(this.maxPanRadius,U),V=L/U*G,W=_/U*G,z=V/this.maxPanRadius,K=W/this.maxPanRadius,q=Math.sqrt(z*z+K*K);this.knobEl&&(this.knobEl.style.transform="translate(calc(-50% + "+V.toFixed(2)+"px), calc(-50% + "+W.toFixed(2)+"px))"),q<this.deadZone?this.battleControlApi?.cancelPan?.():this.battleControlApi?.requestPan?.(z,K)}}stopPan(){this.battleControlApi?.cancelPan?.(),this.knobEl&&(this.knobEl.style.transform="translate(-50%, -50%)")}triggerQuickCommand(g){var P={home:I?.KeyCommandType?.CenterBase??"CenterBase",next:I?.KeyCommandType?.NextObject??"NextObject",scatter:I?.KeyCommandType?.ScatterObject??"ScatterObject",combat:I?.KeyCommandType?.CombatantSelect??"CombatantSelect",view:I?.KeyCommandType?.TogglePersistentTags??"TogglePersistentTags",event:I?.KeyCommandType?.CenterOnRadarEvent??"CenterOnRadarEvent"}[g];P&&this.battleControlApi?.executeKeyCommand?.(P)}pointFromTouch(g){return this.pointFromPage(g.pageX,g.pageY)}pointFromMouseEvent(g){var P="number"==typeof g.pageX?g.pageX:g.clientX+window.scrollX,I="number"==typeof g.pageY?g.pageY:g.clientY+window.scrollY;return this.pointFromPage(P,I)}pointFromPage(g,P){var I=this.canvasMetrics;if(I){var L=(g-I.x)*(I.scaleX??1),_=(P-I.y)*(I.scaleY??1);return{x:a(L,0,I.width-1),y:a(_,0,I.height-1)}}}isDeadZoneClientPoint(g,P){var I=this.clusterEl?.getBoundingClientRect?.();if(!I||I.width<8||I.height<8)return!1;var L=this.getCurrentDeadZonePolygon(I);return!!L?.length&&function c(g,P){let I=!1;for(let V=0,W=P.length-1;V<P.length;W=V++){var L=P[V].x,_=P[V].y,U=P[W].x,G=P[W].y;_>g.y!=G>g.y&&g.x<(U-L)*(g.y-_)/(G-_||1e-6)+L&&(I=!I)}return I}({x:g-I.left,y:P-I.top},L)}getCurrentDeadZonePolygon(g){var P=(this.buttons||[]).map(P=>this.getButtonCenterInCluster(P,g)).filter(Boolean);return P.length===(this.buttonDefs?.length||0)?P:this.deadZonePolygon}getButtonCenterInCluster(g,P){var I=g?.el?.getBoundingClientRect?.();if(!(!I||I.width<4||I.height<4))return{x:I.left+I.width/2-P.left,y:I.top+I.height/2-P.top}}isPointInButtonRing(g,P,I){var L=g?.el?.getBoundingClientRect?.();if(!L||L.width<4||L.height<4)return!1;var _=L.left+L.width/2,U=L.top+L.height/2,G=Math.min(L.width,L.height)/2,V=G*this.buttonHitInnerRatio,W=G*this.buttonHitOuterRatio,z=P-_,K=I-U,q=Math.sqrt(z*z+K*K);return q>=V&&q<=W}isHudPoint(g){var P=this.getWorldInteraction?.(),I=P?.worldScene?.viewport;return!(!I||g.x>=I.x&&g.x<I.x+I.width&&g.y>=I.y&&g.y<I.y+I.height)}applyHoldTap(g){if(this.holdMode){var P=this.isHudPoint(g);if("cancel"===this.holdMode)!!this.pointerEvents?.virtualClick?this.pointerEvents.virtualClick(g,{button:2}):this.battleControlApi?.virtualTap?.(g,{},!0);else if("force"===this.holdMode){var I={ctrlKey:!0,shiftKey:!1,altKey:!1,metaKey:!1};P?this.pointerEvents?.virtualClick?.(g,{button:0,mods:I}):this.battleControlApi?.virtualTap?.(g,I,!1)||this.pointerEvents?.virtualClick?.(g,{button:0,mods:I})}}}setEnabled(g,P=!0){this.enabled=!!g,P&&this.localPrefs?.setItem?.(L,this.enabled?"1":"0"),this.enabled||(this.stopPan(),this.clearHoldMode()),this.clusterEl&&(this.clusterEl.style.display=!this.enabled||this.menuOpen?"none":"block")}setMenuOpen(g){this.menuOpen=!!g,this.clusterEl&&(this.clusterEl.style.display=this.menuOpen||!this.enabled?"none":"block"),this.menuOpen&&(this.stopPan(),this.clearHoldMode())}onViewportChange(){this.stopPan()}dispose(){this.stopPan(),this.clearHoldMode(),this.disposers.forEach(g=>{try{g()}catch(g){}}),this.disposers=[],this.rootEl?.remove(),this.rootEl=void 0,this.clusterEl=void 0,this.hostEl=void 0,this.joystickTouchPad=void 0,this.knobEl=void 0,this.buttons=[],this.buttonsByKey?.clear?.(),this.buttonsByKey=void 0,this.buttonDefs=void 0,this.holdMode=void 0,this.holdTouchId=void 0,this.joystickTouchId=void 0,this.quickTouchId=void 0,this.quickTouchKey=void 0,this.joystickMouseDown=!1,this.quickMouseDown=!1,this.quickMouseKey=void 0,this.canvasEl&&(this.canvasEl.style.touchAction=this.previousCanvasTouchAction??""),this.previousCanvasTouchAction=void 0,this.canvasEl=void 0}}),g("VJOY_ENABLED_PREF_KEY",L)}}}),System.register("gui/screen/game/component/Minimap",["gui/UiObject","engine/gfx/SpriteUtils","util/geometry","engine/renderable/entity/map/MinimapRenderer","engine/util/MapTileIntersectHelper","engine/IsoCoords","util/disposable/CompositeDisposable","util/event","game/event/EventType","gui/screen/game/component/MinimapPing","game/rules/general/RadarRules","engine/renderable/entity/map/MinimapModel","game/GameSpeed"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g}],execute:function(){Z=new Map([[$.RadarEventType.EnemyObjectSensed,{high:16776960,low:8684544}],[$.RadarEventType.GenericNonCombat,{high:65535,low:33924}]]),X=class extends I.UiObject{get onClick(){return this._onClick.asEvent()}get onRightClick(){return this._onRightClick.asEvent()}get onMouseOver(){return this._onMouseOver.asEvent()}get onMouseMove(){return this._onMouseMove.asEvent()}get onMouseOut(){return this._onMouseOut.asEvent()}constructor(g,P,I,L){super(new THREE.Object3D),this.game=g,this.localPlayer=P,this.borderColor=I,this.radarRules=L,this.disposables=new W.CompositeDisposable,this.tilesForRecalc=new Set,this.tilesForRedraw=new Set,this.needsFullRedraw=!1,this.pings=[],this._onClick=new z.EventDispatcher,this._onRightClick=new z.EventDispatcher,this._onMouseOver=new z.EventDispatcher,this._onMouseMove=new z.EventDispatcher,this._onMouseOut=new z.EventDispatcher,this.handleTileUpdate=({tiles:g})=>{g.forEach(g=>{this.tilesForRecalc.add(g),this.tilesForRedraw.add(g)})},this.handleShroudUpdate=(g,P)=>{"incremental"===g.type?g.coords.forEach(g=>{var I;for(I of P.findTilesAtShroudCoords(g,this.map.tiles))this.tilesForRedraw.add(I)}):this.needsFullRedraw=!0},this.handleObjectChange=g=>{g.target.isSpawned&&this.map.tileOccupation.calculateTilesForGameObject(g.target.tile,g.target).forEach(g=>{this.tilesForRecalc.add(g),this.tilesForRedraw.add(g)})},this.handleRadarEvent=g=>{if(g.target===this.localPlayer){var P=this.minimapRenderer.dxyToCanvas(g.tile.dx,g.tile.dy),I=Z.get(g.radarEventType);let L=new q.MinimapPing(this.radarRules,I?.high??16711935,I?.low??8650884);L.setPosition(this.wrapperObj.position.x+P.x,this.wrapperObj.position.y+P.y),this.pings.push({obj:L,startTime:void 0,duration:this.radarRules.getEventVisibilityDuration(g.radarEventType)})}},this.shroud=this.localPlayer&&g.mapShroudTrait.getPlayerShroud(this.localPlayer),this.minimapModel=new Q.MinimapModel(g.map.tiles,g.map.tileOccupation,this.shroud,this.localPlayer,this.game.alliances,this.game.rules.general.paradrop)}get map(){return this.game.map}setFitSize(g){var P=this.fitSize;(this.fitSize=g).width===P?.width&&g.height===P?.height||this.forceRerender()}forceRerender(){var g,P,I,L;this.wrapperObj&&this.fitSize&&(this.get3DObject().remove(this.wrapperObj),this.destroyMesh(),({mesh:g,texture:P,wrapperObj:I,canvasLayoutSize:L}=this.renderMinimap(this.fitSize)),this.mesh=g,this.texture=P,this.wrapperObj=I,this.size=L,this.get3DObject().add(I),this.setupListeners(this.mesh),this.lastViewport=void 0)}initWorld(g){this.worldScene=g,this.mapTileIntersectHelper=new G.MapTileIntersectHelper(this.map,g)}changeLocalPlayer(g){this.localPlayer=g,this.shroud?.onChange.unsubscribe(this.handleShroudUpdate),this.shroud=this.localPlayer&&this.game.mapShroudTrait.getPlayerShroud(this.localPlayer),this.shroud?.onChange.subscribe(this.handleShroudUpdate),this.minimapModel=new Q.MinimapModel(this.game.map.tiles,this.game.map.tileOccupation,this.shroud,this.localPlayer,this.game.alliances,this.game.rules.general.paradrop),this.forceRerender()}create3DObject(){if(super.create3DObject(),!this.mesh){var g;if(!(g=this.fitSize))throw new Error("setFitSize must be called before first render");var{mesh:P,texture:I,wrapperObj:L,canvasLayoutSize:g}=this.renderMinimap(g);this.mesh=P,this.texture=I,this.wrapperObj=L,this.size=g,this.get3DObject().add(L),this.setupListeners(this.mesh),this.map.tileOccupation.onChange.subscribe(this.handleTileUpdate),this.disposables.add(()=>this.map.tileOccupation.onChange.unsubscribe(this.handleTileUpdate)),this.shroud?.onChange.subscribe(this.handleShroudUpdate),this.disposables.add(this.game.events.subscribe(K.EventType.ObjectOwnerChange,this.handleObjectChange),this.game.events.subscribe(K.EventType.ObjectDisguiseChange,this.handleObjectChange),this.game.events.subscribe(K.EventType.ObjectDestroy,g=>{var P;!g.target.isBuilding()||(P=g.target).rules.leaveRubble&&this.map.tileOccupation.calculateTilesForGameObject(P.tile,P).forEach(g=>{this.tilesForRecalc.add(g),this.tilesForRedraw.add(g)})}),this.game.events.subscribe(K.EventType.RadarEvent,this.handleRadarEvent))}}renderMinimap(g){this.minimapRenderer=new U.MinimapRenderer(this.map,this.minimapModel,g,this.borderColor,2),this.minimapModel.computeAllColors();var P={width:.5*(_=this.minimapRenderer.renderFull()).width,height:.5*_.height},I=this.computeMinimapPosition(g,P),L=this.createTexture(_),_=this.createMesh(L,P.width,P.height);let G=new THREE.Object3D;return G.matrixAutoUpdate=!1,G.position.x=I.x,G.position.y=I.y,G.updateMatrix(),G.add(_),{mesh:_,texture:L,wrapperObj:G,canvasLayoutSize:P}}computeMinimapPosition(g,P){return{x:Math.floor((g.width-P.width)/2),y:Math.floor((g.height-P.height)/2)}}createTexture(g){let P=new THREE.Texture(g);return P.needsUpdate=!0,P.flipY=!1,P.minFilter=THREE.NearestFilter,P.magFilter=THREE.NearestFilter,P}createMesh(g,P,I){let _=L.SpriteUtils.createRectGeometry(P,I);L.SpriteUtils.addRectUvs(_,{x:0,y:0,width:P,height:I},{width:P,height:I}),_.translate(P/2,I/2,0);var U=new THREE.MeshBasicMaterial({map:g,side:THREE.DoubleSide});let G=new THREE.Mesh(_,U);return G.matrixAutoUpdate=!1,G.frustumCulled=!1,G}setupListeners(g){if(!this.pointerEvents)throw new Error("Must call setPointerEvents before rendering");this.disposables.add(this.pointerEvents.addEventListener(g,"click",g=>{var P=this.computeIntersectionTile(g.intersection.uv);P&&(2===g.button||g.isTouch?this._onRightClick.dispatch(this,P):0===g.button&&this._onClick.dispatch(this,P))}),this.pointerEvents.addEventListener(g,"mouseover",()=>this._onMouseOver.dispatch(this)),this.pointerEvents.addEventListener(g,"mousemove",g=>this.queuedHoverUv=g.intersection.uv),this.pointerEvents.addEventListener(g,"mouseout",()=>this._onMouseOut.dispatch(this)))}computeIntersectionTile(g){return this.canvasCoordsToTile(g.x*this.size.width,g.y*this.size.height)}canvasCoordsToTile(g,P){let I=this.minimapRenderer.canvasToDxy(g,P);return I.x=Math.round(I.x),I.y=Math.round(I.y),this.map.tiles.getByDisplayCoords(I.x,I.y+(I.x%2-I.y%2))}update(g){if(super.update(g),!this.lastCanvasUpdate||g-this.lastCanvasUpdate>=1e3/30){if(this.tilesForRecalc.size&&(this.minimapModel.updateColors(this.tilesForRecalc),this.tilesForRecalc.clear()),this.needsFullRedraw&&(this.minimapRenderer.renderFull(),this.texture.needsUpdate=!0,this.needsFullRedraw=!1,this.tilesForRedraw.clear()),this.tilesForRedraw.size&&(this.lastCanvasUpdate=g,this.minimapRenderer.renderIncremental(this.tilesForRedraw),this.texture.needsUpdate=!0,this.tilesForRedraw.clear()),this.worldScene){var P=this.worldScene.cameraPan.getPan(),I=this.worldScene.viewport,L=!this.lastViewport||!_.rectEquals(I,this.lastViewport);if(!_.pointEquals(P,this.lastPan)||L){this.lastPan=P,this.lastViewport=I;var U=this.mapTileIntersectHelper.getTileAtScreenPoint({x:I.x+I.width/2,y:I.y+I.height/2});if(!U)return void console.warn("Current pan intersects no map tile");I=V.IsoCoords.screenToScreenTile(I.width/2,I.height/2),U={x:U.dx-I.x,y:U.dy-I.y,width:2*I.x,height:2*I.y},this.viewportOutline&&!L||(I=this.minimapRenderer.dxyToCanvas(U.x,U.y),I={width:(L=this.minimapRenderer.dxyToCanvas(U.x+U.width,U.y+U.height)).x-I.x,height:L.y-I.y},this.viewportOutline?this.updateOutlineSize(this.viewportOutline,I.width,I.height):(this.viewportOutline=this.createViewportOutline(I.width,I.height),this.viewportOutline.matrixAutoUpdate=!1,this.wrapperObj.add(this.viewportOutline))),U=this.minimapRenderer.dxyToCanvas(U.x,U.y),this.viewportOutline.position.x=Math.max(2,Math.floor(U.x)),this.viewportOutline.position.y=Math.max(1,Math.floor(U.y)),this.viewportOutline.updateMatrix()}}this.queuedHoverUv&&((U=this.computeIntersectionTile(this.queuedHoverUv))&&this._onMouseMove.dispatch(this,U),this.queuedHoverUv=void 0),this.pings.forEach(P=>{P.startTime?g-P.startTime>P.duration/(Y.GameSpeed.BASE_TICKS_PER_SECOND/1e3*this.game.speed.value)&&(this.remove(P.obj),P.obj.destroy(),this.pings.splice(this.pings.indexOf(P),1)):(P.startTime=g,this.add(P.obj))})}}createViewportOutline(g,P){let I=new THREE.Geometry;I.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(0,P,0),new THREE.Vector3(g,P,0),new THREE.Vector3(g,0,0),new THREE.Vector3(0,0,0));var L=new THREE.LineBasicMaterial({color:this.borderColor,transparent:!0,side:THREE.DoubleSide});return new THREE.Line(I,L)}updateOutlineSize(g,P,I){let L=g.geometry;L.vertices[1].set(0,I,0),L.vertices[2].set(P,I,0),L.vertices[3].set(P,0,0),L.verticesNeedUpdate=!0}destroy(){super.destroy(),this.destroyMesh(),this.shroud?.onChange.unsubscribe(this.handleShroudUpdate),this.disposables.dispose()}destroyMesh(){this.mesh&&(this.mesh.geometry.dispose(),this.mesh.material.dispose()),this.texture?.dispose(),this.destroyViewportOutline()}destroyViewportOutline(){this.viewportOutline&&(this.wrapperObj?.remove(this.viewportOutline),this.viewportOutline.geometry.dispose(),this.viewportOutline.material.dispose(),this.viewportOutline=void 0)}},g("Minimap",X)}}}),System.register("gui/screen/game/component/MinimapPing",["gui/UiObject"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.UiObject{constructor(g,P,I){super(),this.radarRules=g,this.colorLerpFactor=0,this.hiColor=new THREE.Color(P),this.lowColor=new THREE.Color(I),this.matHiColor=this.hiColor.clone(),this.matLowColor=this.lowColor.clone();var L=g.eventMinRadius;let _=this.createPingRectLine(L,L,this.matHiColor,this.matLowColor);_.name="minimap_ping",_.scale.x=15,_.scale.y=15,this.set3DObject(_),this.get3DObject().matrixAutoUpdate=!0}createPingRectLine(g,P,I,L){let _=new THREE.Geometry,U=[new THREE.Vector3(-.5*g,-.5*P,0),new THREE.Vector3(-.5*g,.5*P,0),new THREE.Vector3(.5*g,.5*P,0),new THREE.Vector3(.5*g,-.5*P,0)],G=[I,L];U.forEach((g,P)=>{_.vertices.push(g,U[(P+1)%U.length]),_.colors.push(G[P%2],G[(P+1)%2])});var V=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,side:THREE.DoubleSide});return new THREE.LineSegments(_,V)}get3DObject(){return super.get3DObject()}update(g){super.update(g),this.lastUpdate||(this.lastUpdate=g);var P=(g-this.lastUpdate)/1e3*60;this.lastUpdate=g;let I=this.get3DObject();var L=this.radarRules.eventSpeed/this.radarRules.eventMinRadius;I.scale.x=Math.max(1,I.scale.x-L*P),I.scale.y=Math.max(1,I.scale.y-L*P),I.rotation.z=I.rotation.z+this.radarRules.eventRotationSpeed*P,1===I.scale.x&&(I.rotation.z=Math.min(I.rotation.z,Math.floor(I.rotation.z/(Math.PI/2))*Math.PI/2)),this.colorLerpFactor=(this.colorLerpFactor+this.radarRules.eventColorSpeed*P)%2,P=Math.min(1,this.colorLerpFactor)-Math.max(0,this.colorLerpFactor-1),this.matHiColor.copy(this.hiColor).lerp(this.lowColor,P),this.matLowColor.copy(this.lowColor).lerp(this.hiColor,P),I.geometry.colorsNeedUpdate=!0}destroy(){super.destroy(),this.get3DObject().material.dispose(),this.get3DObject().geometry.dispose()}},g("MinimapPing",L)}}}),System.register("gui/screen/game/GameLoader",["data/DataStream","@puzzl/core/lib/async/cancellation","engine/ResourceLoader","engine/resourceConfigs","engine/Engine","engine/EngineType","engine/TheaterType","util/time","game/SideType","game/Coords","engine/IsoCoords","engine/type/ObjectType","engine/ImageFinder","engine/renderable/builder/ShpBuilder","engine/renderable/entity/PipOverlay","engine/renderable/builder/CanvasSpriteBuilder","game/theater/TileSets","game/GameFactory","engine/renderable/fx/TrailerSmokeFx","engine/renderable/builder/ShpAggregator","engine/renderable/entity/building/BuildingShpHelper","engine/renderable/entity/building/BuildingAnimArtProps","util/math","data/MixFile","util/userAgent","game/gameopts/GameOptRandomGen","engine/renderable/DebugRenderable","game/ini/MixinRules","util/typeGuard"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce,he,ue,de,ge;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g},function(g){ce=g},function(g){he=g},function(g){ue=g},function(g){de=g},function(g){ge=g}],execute:function(){g("GameLoader",class{constructor(g,P,I,L,_,U,G,V,W,z,K,q,$,Q,Y){this.appVersion=g,this.workerHostApi=P,this.cdnResourceLoader=I,this.appResourceLoader=L,this.rules=_,this.gameModes=U,this.sound=G,this.iniLogger=V,this.actionLogger=W,this.speedCheat=z,this.gameResConfig=K,this.vxlGeometryPool=q,this.buildingImageDataCache=$,this.debugBotIndex=Q,this.devMode=Y}async load(g,P,I,L,_,U,G,V){var W=this.resolveLoadingPlayerInfos(g,P,I);G.start(W,I.mapTitle,_);try{return this.workerHostApi.warmUpPool(),await this.doLoad(g,P,I,L,_,U,G,V)}finally{this.workerHostApi.dispose()}}resolveLoadingPlayerInfos(g,P,I){let L=he.GameOptRandomGen.factory(g,P),_=L.generateColors(I),U=L.generateCountries(I,this.rules);return I.humanPlayers.map(g=>({...g,colorId:_.get(g)??g.colorId,countryId:U.get(g)??g.countryId}))}async doLoad(g,P,V,W,Q,Z,X,J){if(!G.Engine.vfs)throw new Error("Virtual File System not initialized");this.clearStaticCaches(),this.buildingImageDataCache.clear();try{G.Engine.getActiveMod()||await this.loadFestiveAssets(J)}catch(g){if(g instanceof L.OperationCanceledError)throw g;console.error("Couldn't load festive assets",g)}await this.loadTheater(W.theaterType,J,g=>X.onLoadProgress(g/100*30)),await z.sleep(1);var ee=await this.loadBotsLib();if(!this.devMode&&ee.version!==this.appVersion)throw new _.DownloadError(`Bot library version mismatch. Expected ${this.appVersion}, but got `+ee.version);let te,{game:re,theater:se}=await this.createGame(g,P,V,W,Z,ee),ae=K.SideType.GDI;Q&&(te=re.getPlayerByName(Q),te.isObserver||(ae=te.country.side));let ne=this.gameResConfig.isCdn()?await this.cdnResourceLoader.loadResources([U.ResourceType.Sounds,...ae===K.SideType.GDI?[U.ResourceType.EvaAlly,U.ResourceType.UiAlly]:[U.ResourceType.EvaSov,U.ResourceType.UiSov],U.ResourceType.Cameo],J,g=>X.onLoadProgress(30+g/100*15)):void 0;ne&&G.Engine.vfs.addArchive(new le.MixFile(new I.DataStream(ne.pop(U.ResourceType.Cameo))),this.cdnResourceLoader.getResourceFileName(U.ResourceType.Cameo)),await G.Engine.vfs.addMixFile("cameocd.mix");var oe,he=this.collectCameoFileNames(re);if(await this.loadHudSideImages(ne,ae),X.onLoadProgress(40),await z.sleep(1),ne){for(oe of[U.ResourceType.Sounds,ae===K.SideType.GDI?U.ResourceType.EvaAlly:U.ResourceType.EvaSov])G.Engine.vfs.addArchive(new le.MixFile(new I.DataStream(ne.pop(oe))),this.cdnResourceLoader.getResourceFileName(oe));await G.Engine.vfs.addBagFile("audio.bag")}return X.onLoadProgress(45),await z.sleep(1),(ee=/iPhone|Android|CrOS|Windows Phone|webOS/i.test(navigator.userAgent)||ce.isIpad())||(console.time("Load sounds"),await this.prepareSounds(J,g=>X.onLoadProgress(45+g/100*15)),console.timeEnd("Load sounds")),X.onLoadProgress(60),await z.sleep(1),ee||(ee=G.Engine.getImages(),ee=new Y.ImageFinder(ee,se),console.time("Load textures"),await this.prepareTextures(re.rules,re.art,W,ee,J,g=>X.onLoadProgress(60+g/100*10)),console.timeEnd("Load textures")),X.onLoadProgress(70),await z.sleep(1),console.time("Load voxels"),await this.prepareVxlGeometries(re.rules,re.art,re.map,G.Engine.getVoxels(),J,g=>X.onLoadProgress(70+g/100*20)),console.timeEnd("Load voxels"),await z.sleep(1),J?.throwIfCancelled(),$.IsoCoords.init({x:0,y:re.map.mapBounds.getFullSize().width*q.Coords.getWorldTileSize()/2}),re.init(te),J?.throwIfCancelled(),X.onLoadProgress(95),await z.sleep(1),{game:re,theater:se,hudSide:ae,cameoFilenames:he}}collectCameoFileNames(g){let P=[],I=[...g.rules.buildingRules.values(),...g.rules.infantryRules.values(),...g.rules.vehicleRules.values(),...g.rules.aircraftRules.values()];for(var L of I.values())g.art.hasObject(L.name,L.type)&&(L=g.art.getObject(L.name,L.type),P.push(L.cameo+".shp"),P.push(L.altCameo+".shp"));for(var _ of g.rules.superWeaponRules.values())_.sidebarImage.length&&P.push(_.sidebarImage+".shp");return P=P.filter(g=>G.Engine.getImages().has(g)),[...new Set(P)]}async prepareSounds(g,P){let I=new Set;for(var _ of this.sound.soundSpecs.getAll())for(var U of _.sounds){const g=this.sound.getWavFile(U);g&&g.isRawImaAdpcm()&&I.add(g)}let G=0,V=I.size;if(V){let _=[...I].sort((g,P)=>g.getRawData().length-P.getRawData().length);var W=this.workerHostApi.concurrency;try{for(let I=0;I<W;I++)this.workerHostApi.queueTask(async I=>{for(;_.length&&!g?.isCancelled();){let g=_.pop();var L=g.getRawData();L=await I.decodeWav(L);g.setData(L),G++,L=G/V*100,Math.floor(L)%10==0&&P(G/V*100)}}),await Promise.resolve();await this.workerHostApi.waitForTasks(),g?.throwIfCancelled()}catch(I){if(I instanceof L.OperationCanceledError)throw I;console.error(I)}}}async loadTheater(g,P,L){if(this.gameResConfig.isCdn()){if(!(V=U.theaterSpecificResources.get(g)))throw new Error("Unhandled theater type "+W.TheaterType[g]);var _,V=[U.ResourceType.BuildGen,U.ResourceType.Anims,U.ResourceType.Vxl,...V];let z=await this.cdnResourceLoader.loadResources(V,P,g=>L(g/100*60));for(_ of V)G.Engine.vfs.addArchive(new le.MixFile(new I.DataStream(z.pop(_))),this.cdnResourceLoader.getResourceFileName(_))}else L(100)}async createGame(g,P,I,L,_,U){var V=G.Engine.getIni(this.gameModes.getById(I.gameMode).rulesOverride),W=de.MixinRules.getTypes(I).map(g=>G.Engine.mixinRulesFileNames.get(g)).filter(ge.isNotNullOrUndefined).map(g=>G.Engine.getIni(g)),z=await G.Engine.loadTheater(L.theaterType),K=G.Engine.getActiveEngine(),q=G.Engine.getTheaterSettings(K,L.theaterType);K=G.Engine.getTheaterIni(K,L.theaterType);let $=new ee.TileSets(K);return $.loadTileData(G.Engine.getTileData(),q.extension),{game:te.GameFactory.create(L,$,G.Engine.getRules(),G.Engine.getArt(),G.Engine.getAi(),V,W,g,P,I,this.gameModes,_,U,this.iniLogger,this.speedCheat,this.debugBotIndex,this.actionLogger),theater:z}}async loadBotsLib(){let g,P;try{g=await SystemJS.import("@ra2web/sp-bots"),P=await SystemJS.import("@ra2web/sp-bots-2")}catch(g){throw new _.DownloadError("Failed to download bot lib",{cause:g})}return{...g,lib2:P}}async loadHudSideImages(g,P){if(!G.Engine.vfs)throw new Error("VFS is not initialized");if(G.Engine.vfs.removeArchive("sidec01.mix"),G.Engine.vfs.removeArchive("sidec02.mix"),G.Engine.vfs.removeArchive("sidec02md.mix"),G.Engine.vfs.removeArchive("sidec01cd.mix"),G.Engine.vfs.removeArchive("sidec02cd.mix"),G.Engine.unloadSideMixData(),g){var L=P===K.SideType.GDI?U.ResourceType.UiAlly:U.ResourceType.UiSov,_=this.cdnResourceLoader.getResourceFileName(L);if(!["sidec01.mix","sidec02.mix"].includes(_))throw new Error(`Side mix file name "${_}" mismatch`);G.Engine.vfs.addArchive(new le.MixFile(new I.DataStream(g.pop(L))),_)}else await G.Engine.vfs.addMixFile(P===K.SideType.GDI?"sidec01.mix":"sidec02.mix"),G.Engine.getActiveEngine()===V.EngineType.YurisRevenge&&P===K.SideType.ThirdSide&&await G.Engine.vfs.addMixFile("sidec02md.mix");await G.Engine.vfs.addMixFile(P===K.SideType.GDI?"sidec01cd.mix":"sidec02cd.mix")}async loadFestiveAssets(g){let P=new Date;var L=P.getMonth()+1,_=P.getDate();let V;if(10===L&&oe.isBetween(_,24,31)||11===L&&oe.isBetween(_,1,6)?V=U.ResourceType.HalloweenMix:12===L&&oe.isBetween(_,16,31)&&(V=U.ResourceType.XmasMix),void 0!==V&&(L=this.appResourceLoader.getResourceFileName(V),!G.Engine.vfs.hasArchive(L))){_=(await this.appResourceLoader.loadResources([V],g)).pop(V),_=new le.MixFile(new I.DataStream(_)),G.Engine.vfs.addArchive(_,L)}}async prepareTextures(g,P,I,L,_,U){let G=new ae.BuildingShpHelper(L),V=new se.ShpAggregator,W=new Set,K=performance.now(),q=new Set;for(var $ of I.structures)q.add($.name);let X=[];for(var[J,ee]of g.buildingRules)!q.has(J)&&-1===ee.techLevel||X.push(J);let te=0;var re,oe,le=X.length+g.animationNames.size;for(re of X){_?.throwIfCancelled();var ce=performance.now();if(1e3<ce-K&&(K=ce,U(te/le*100),await z.sleep(0)),te++,!this.buildingImageDataCache.has(re)&&P.hasObject(re,Q.ObjectType.Building)&&!(ce=P.getObject(re,Q.ObjectType.Building)).demandLoad){let I=new ne.BuildingAnimArtProps;for(var he of(I.read(ce.art,P),I.getAll().values()))for(var ue of he)W.add(ue.name);try{var de=L.findByObjectArt(ce),ge=ce.bibShape?L.find(ce.bibShape,ce.useTheaterExtension):void 0,pe=G.collectAnimShpFiles(I,ce);let g=G.getShpFrameInfos(ce,de,ge,pe);var me=V.aggregate(g.values(),`agg_${re}.shp`);this.buildingImageDataCache.set(re,me),Z.ShpBuilder.prepareTexture(me.file)}catch(g){if(g instanceof Y.ImageFinder.MissingImageError)continue;throw g}}}for(oe of g.animationNames){_?.throwIfCancelled();var fe=performance.now();if(1e3<fe-K&&(K=fe,U(te/le*100),await z.sleep(0)),te++,!W.has(oe)&&P.hasObject(oe,Q.ObjectType.Animation)){fe=P.getAnimation(oe);try{var ye=L.findByObjectArt(fe);Z.ShpBuilder.prepareTexture(ye)}catch(g){if(g instanceof Y.ImageFinder.MissingImageError)continue;throw g}}}}async prepareVxlGeometries(g,P,I,_,U,G){let V=new Set([...g.vehicleRules.values(),...g.aircraftRules.values(),...g.buildingRules.values()].filter(g=>(-1!==g.techLevel||g.spawned)&&P.hasObject(g.name,g.type)));for(var W of g.buildingRules.values()){if(W.freeUnit){let P;g.hasObject(W.freeUnit,Q.ObjectType.Vehicle)&&(P=g.getObject(W.freeUnit,Q.ObjectType.Vehicle)),P&&V.add(P)}W.undeploysInto&&g.hasObject(W.undeploysInto,Q.ObjectType.Vehicle)&&V.add(g.getObject(W.undeploysInto,Q.ObjectType.Vehicle))}for(var z of I.getInitialMapObjects().technos)(z.isVehicle()||z.isAircraft())&&g.hasObject(z.name,z.type)&&V.add(g.getObject(z.name,z.type));let K=new Map;for(var q of V){let I=P.getObject(q.name,q.type);if(I.isVoxel||q.type===Q.ObjectType.Building&&q.turretAnimIsVoxel){var $,Y=I.imageName.toLowerCase();let P=[];if(q.type!==Q.ObjectType.Building){if(P.push(Y+".vxl"),q.spawns&&q.noSpawnAlt&&P.push(Y+"wo.vxl"),q.harvester&&q.unloadingClass&&g.hasObject(q.unloadingClass,Q.ObjectType.Vehicle)&&P.push(g.getObject(q.unloadingClass,Q.ObjectType.Vehicle).imageName.toLowerCase()+".vxl"),q.turret){for(let g=0;g<q.turretCount;++g)P.push(Y+`tur${g||""}.vxl`);var Z=Y+"barl.vxl";_.has(Z)&&P.push(Z)}}else if(q.turretAnimIsVoxel){let g=q.turretAnim.toLowerCase()+".vxl";P.push(g),Z=g.replace("tur","barl"),_.has(Z)&&P.push(Z)}for($ of P){var X=_.get($);X&&K.set($,X)}}}let J=0,ee=[];for(var[te,re]of K)U?.throwIfCancelled(),await this.vxlGeometryPool.loadFromStorage(re,te)?(J++,G(J/K.size*100)):ee.push([te,re]);if(ee.length){ee.sort((g,P)=>P[1].voxelCount-g[1].voxelCount);var se=this.workerHostApi.concurrency;let g=this.vxlGeometryPool.getModelQuality(),P=[()=>this.vxlGeometryPool.clearOtherModStorage()];try{for(let I=0;I<se;I++)this.workerHostApi.queueTask(async I=>{for(;ee.length&&!U?.isCancelled();){let[L,_]=ee.pop(),U=await I.generateVxlGeometry(_,g);P.push(()=>this.vxlGeometryPool.persistToStorage(_,L,U)),J++,G(J/K.size*100)}});await this.workerHostApi.waitForTasks(),U?.throwIfCancelled()}catch(I){if(I instanceof L.OperationCanceledError)throw I;console.error(I),console.warn("Failed to pre-load VXL geometries. Skipping.")}await Promise.all(P.map(g=>g())).catch(g=>console.warn("Failed to persist VXL geometry cache",[g]))}}clearStaticCaches(){X.PipOverlay.clearCaches(),Z.ShpBuilder.clearCaches(),ue.DebugRenderable.clearCaches(),J.CanvasSpriteBuilder.clearCaches(),re.TrailerSmokeFx.clearTextureCache()}})}}}),System.register("gui/screen/game/GameMenu",["util/disposable/CompositeDisposable","gui/screen/game/gameMenu/GameMenuController","gui/screen/game/gameMenu/ScreenType","util/event"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("GameMenu",class{get onOpen(){return this._onOpen.asEvent()}get onQuit(){return this._onQuit.asEvent()}get onObserve(){return this._onObserve.asEvent()}get onCancel(){return this._onCancel.asEvent()}get onToggleAlliance(){return this._onToggleAlliance.asEvent()}get onSendMessage(){return this._onSendMessage.asEvent()}constructor(g,P,L,_,G,V,W=!1){this.subScreens=g,this.game=P,this.localPlayer=L,this.chatHistory=_,this.gservCon=G,this.isSinglePlayer=V,this.isTournament=W,this.disposables=new I.CompositeDisposable,this._onOpen=new U.EventDispatcher,this._onQuit=new U.EventDispatcher,this._onObserve=new U.EventDispatcher,this._onCancel=new U.EventDispatcher,this._onToggleAlliance=new U.EventDispatcher,this._onSendMessage=new U.EventDispatcher}init(g){let P=new L.GameMenuController(g);for(var[I,_]of this.subScreens)P.addScreen(I,_);this.controller=P,this.disposables.add(P,()=>this.controller=void 0),this.bindHudEvents(g)}handleHudChange(g){this.controller&&(this.controller.setHud(g),this.bindHudEvents(g),this.controller.rerenderCurrentScreen())}bindHudEvents(g){g.onOptButtonClick.subscribe(()=>this.open()),g.onDiploButtonClick.subscribe(()=>this.openDiplo())}open(){this.controller?(this._onOpen.dispatch(this),this.controller.goToScreen(_.ScreenType.Home,{observeAllowed:!(this.isTournament||this.isSinglePlayer||void 0===this.localPlayer||this.localPlayer.isObserver||this.localPlayer.defeated),onQuit:async()=>{this.controller.close(),this._onQuit.dispatch(this)},onObserve:()=>{this.controller.close(),this._onObserve.dispatch(this)},onCancel:()=>{this.controller.close(),this._onCancel.dispatch(this)}})):console.warn("Menu not initialized")}openDiplo(){this.controller?(this._onOpen.dispatch(this),this.controller.goToScreen(_.ScreenType.Diplo,{game:this.game,localPlayer:this.localPlayer,isSinglePlayer:this.isSinglePlayer,chatHistory:this.chatHistory,gservCon:this.gservCon,onToggleAlliance:(g,P)=>{this._onToggleAlliance.dispatch(g,P)},onSendMessage:g=>this._onSendMessage.dispatch(this,g),onCancel:()=>{this.controller.close(),this._onCancel.dispatch(this)}})):console.warn("Menu not initialized")}openConnectionInfo(g,P,I){this.controller?(this._onOpen.dispatch(this),this.controller.goToScreen(_.ScreenType.ConnectionInfo,{players:g,localPlayer:this.localPlayer,chatHistory:this.chatHistory,chatNetHandler:I,gservCon:P,onQuit:async()=>{this.controller.close(),this._onQuit.dispatch(this)}})):console.warn("Menu not initialized")}close(){this.controller?this.controller.getCurrentScreen()&&(this.controller.close(),this._onCancel.dispatch(this)):console.warn("Menu not initialized")}getCurrentScreen(){return this.controller?.getCurrentScreen()}dispose(){this.disposables.dispose()}})}}}),System.register("gui/screen/game/gameMenu/ConInfoForm",["react","gui/component/CountryIcon","game/gameopts/constants","network/gamestate/PlayerConnectionStatus","network/gservConfig","gui/component/Chat"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){g("ConInfoForm",({strings:g,conInfos:P,players:W,localPlayer:z,messages:K,chatHistory:q,onSendMessage:$})=>{let[Q,Y]=I.useState(()=>Math.floor((G.TURN_TIMEOUT_MILLIS-G.LAG_STATE_THRESH_MILLIS-G.CON_INFO_THRESH_MILLIS)/1e3));return I.useEffect(()=>{let g=setInterval(()=>Y(Math.max(0,Q-1)),1e3);return()=>clearInterval(g)},[Q]),I.default.createElement("div",{className:"con-info-form"},I.default.createElement("div",{className:"con-info-form-content"},I.default.createElement("table",null,I.default.createElement("thead",null,I.default.createElement("tr",null,I.default.createElement("th",null),I.default.createElement("th",{className:"player-name"},g.get("GUI:Player")),I.default.createElement("th",{className:"player-ping"},g.get("GUI:Ping")),I.default.createElement("th",{className:"player-time"},g.get("GUI:Time")))),I.default.createElement("tbody",null,W.filter(g=>!g.isAi).map(g=>{var G=P?.find(P=>P.name===g.name);return I.default.createElement("tr",{key:g.name,style:{color:g.color.asHexString(),opacity:G&&G.status!==U.PlayerConnectionStatus.Connected?.5:1}},I.default.createElement("td",null,I.default.createElement(L.CountryIcon,{country:g.country?g.country.name:_.OBS_COUNTRY_NAME})),I.default.createElement("td",{className:"player-name"},g.name),I.default.createElement("td",{className:"player-ping"},I.default.createElement("meter",{value:G?.ping??1e3,max:1e3,low:150,high:500,optimum:0})),I.default.createElement("td",{className:"player-time"},G?Math.floor(G?.lagAllowanceMillis/1e3):void 0))})))),I.default.createElement("div",{className:"con-info-form-footer"},I.default.createElement("div",{className:"time-allowed"},g.get("TXT_TIME_ALLOWED",Q)),I.default.createElement("div",{className:"chat"},I.default.createElement(V.Chat,{strings:g,messages:K,channels:[G.RECIPIENT_ALL,G.RECIPIENT_TEAM],chatHistory:q,userColors:new Map(W.map(g=>[g.name,g.color.asHexString()])),localUsername:z.name,onSendMessage:$}))))})}}}),System.register("gui/screen/game/gameMenu/ConnectionInfoScreen",["gui/jsx/jsx","gui/screen/game/gameMenu/ScreenType","gui/jsx/HtmlView","util/disposable/CompositeDisposable","gui/screen/game/gameMenu/ConInfoForm","gui/screen/game/GameMenuScreen","network/gameopt/LoadInfoParser"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g}],execute:function(){z=class extends V.GameMenuScreen{constructor(g,P){super(),this.strings=g,this.jsxRenderer=P,this.messages=[],this.disposables=new U.CompositeDisposable,this.handleChatMessage=g=>{this.messages.push(g),this.form.refresh()},this.handleConInfoUpdate=g=>{this.form.applyOptions(P=>{P.conInfos=(new W.LoadInfoParser).parse(g)})}}onEnter(g){if(this.params=g,this.controller.toggleContentAreaVisibility(!0),this.initView(g),g.gservCon.isOpen()){g.gservCon.onLoadInfo.subscribe(this.handleConInfoUpdate),this.disposables.add(()=>g.gservCon.onLoadInfo.unsubscribe(this.handleConInfoUpdate)),g.gservCon.requestLoadInfo();let P=setInterval(()=>{g.gservCon.isOpen()?g.gservCon.requestLoadInfo():this.disposables.dispose()},1e3);this.disposables.add(()=>clearInterval(P)),g.chatHistory.onNewMessage.subscribe(this.handleChatMessage),this.disposables.add(()=>{this.messages.length=0,g.chatHistory.onNewMessage.unsubscribe(this.handleChatMessage)})}this.messages.push({text:this.strings.get("GUI:ConnectingToPlayers")+"...\n"+this.strings.get("TXT_RECONNECT_HELP2")+" "+this.strings.get("TXT_RECONNECT_HELP2B")})}initView(g){var P=[{label:this.strings.get("GUI:AbortMission"),onClick:()=>{this.controller?.pushScreen(L.ScreenType.QuitConfirm,{onQuit:g.onQuit,onCancel:()=>{this.controller?.popScreen()}})}}];this.controller.setSidebarButtons(P),this.controller.showSidebarButtons();var[P]=this.jsxRenderer.render(I.jsx(_.HtmlView,{width:"100%",height:"100%",component:G.ConInfoForm,innerRef:g=>this.form=g,props:{players:g.players,localPlayer:g.localPlayer,strings:this.strings,messages:this.messages,chatHistory:g.chatHistory,onSendMessage:P=>{g.chatNetHandler.submitMessage(P.value,P.recipient)}}}));this.controller.setMainComponent(P),this.disposables.add(()=>this.form=void 0)}async onLeave(){this.params=void 0,this.controller.hideSidebarButtons(),this.controller.toggleContentAreaVisibility(!1),this.disposables.dispose()}async onStack(){this.controller.hideSidebarButtons()}onUnstack(){this.initView(this.params)}},g("ConnectionInfoScreen",z)}}}),System.register("gui/screen/game/gameMenu/DiploForm",["react","game/Alliances","game/gameopts/constants","gui/component/CountryIcon","gui/component/Chat","network/gservConfig","gui/component/PingIndicator","network/gamestate/PlayerConnectionStatus"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g}],execute:function(){g("DiploForm",({strings:g,playerInfos:P,localPlayer:K,taunts:q,singlePlayer:$,alliancesAllowed:Q,gameModes:Y,gameOpts:Z,mapName:X,messages:J,chatHistory:ee,conInfos:te,onToggleTaunts:re,onToggleAlliance:se,onToggleChat:ae,onSendMessage:ne,onCancelMessage:oe})=>{var le,ce=g.get(Y.getById(Z.gameMode).label),v=P=>P?g.get("TXT_ON"):g.get("TXT_OFF");return I.default.createElement("div",{className:"diplo-form"},I.default.createElement("div",{className:"players"},I.default.createElement("table",null,I.default.createElement("thead",null,I.default.createElement("tr",null,I.default.createElement("th",{className:"player-country"}),I.default.createElement("th",{className:"player-ping"}),I.default.createElement("th",{className:"player-name"},g.get("GUI:Player")),I.default.createElement("th",null,g.get("GUI:Allies")),!$&&I.default.createElement("th",null,g.get("GUI:Chat")),I.default.createElement("th",null,g.get("GUI:Kills")))),I.default.createElement("tbody",null,K&&I.default.createElement("tr",{style:{color:K.defeated?"grey":K.color.asHexString()}},I.default.createElement("td",{className:"player-country"},I.default.createElement(U.CountryIcon,{country:K.country?K.country.name:_.OBS_COUNTRY_NAME})),I.default.createElement("td",{className:"player-ping"},void 0!==(le=te?.find(g=>g.name===K.name)?.ping)&&I.default.createElement(W.PingIndicator,{ping:le,strings:g})),I.default.createElement("td",{className:"player-name"},K.name),I.default.createElement("td",null),!$&&I.default.createElement("td",null),I.default.createElement("td",null,!K.isObserver||K.defeated?K.getUnitsKilled():void 0)),P.map((P,G)=>I.default.createElement("tr",{key:G,style:{color:P.player.defeated?"grey":P.player.color.asHexString()}},I.default.createElement("td",{className:"player-country"},I.default.createElement(U.CountryIcon,{country:P.player.country?P.player.country.name:_.OBS_COUNTRY_NAME})),I.default.createElement("td",{className:"player-ping"},(()=>{var L=te?.find(g=>g.name===P.player.name);return void 0!==(L=L?.status===z.PlayerConnectionStatus.Connected?L?.ping:void 0)&&I.default.createElement(W.PingIndicator,{ping:L,strings:g})})()),I.default.createElement("td",{className:"player-name"},P.player.isAi?g.get(_.aiUiNames.get(P.player.aiDifficulty)):P.player.name),I.default.createElement("td",null,(!K?.isObserver||K.defeated)&&I.default.createElement("input",{type:"checkbox",name:"alliance",className:P.alliance?.status===L.AllianceStatus.Requested?P.alliance.players.first===K?"semi-checked-left":"semi-checked-right":void 0,disabled:!Q||!P.allianceToggleable||!P.player.isCombatant(),checked:P.alliance?.status===L.AllianceStatus.Formed,onChange:()=>se(P.player,!(P.alliance?.status===L.AllianceStatus.Formed||P.alliance?.status===L.AllianceStatus.Requested&&P.alliance.players.first===K))})),!$&&I.default.createElement("td",null,!P.player.isAi&&I.default.createElement("input",{type:"checkbox",name:"mute",checked:!P.muted,onChange:g=>ae(P.player,g.target.checked)})),I.default.createElement("td",null,!P.player.isObserver||P.player.defeated?P.player.getUnitsKilled():void 0)))))),I.default.createElement("div",{className:"diplo-form-footer"},I.default.createElement("div",{className:"game-settings"},I.default.createElement("div",null,g.get("TXT_MAP",X)),I.default.createElement("div",null,[g.get("GUI:GameType")+": "+ce,g.get("GUI:ShortGame")+": "+v(Z.shortGame),g.get("GUI:CratesAppear")+": "+v(Z.cratesAppear),g.get("GUI:SuperWeaponsAllowed")+": "+v(Z.superWeapons),g.get("GUI:DestroyableBridges")+": "+v(Z.destroyableBridges),g.get("GUI:MultiEngineer")+": "+v(Z.multiEngineer),g.get("GUI:NoDogEngiKills")+": "+v(Z.noDogEngiKills)].join(", "))),!$&&I.default.createElement("div",{"data-r-tooltip":g.get("STT:TauntsOn")},I.default.createElement("label",null,I.default.createElement("input",{type:"checkbox",name:"taunts",checked:!!q,disabled:void 0===q,onChange:g=>re(g.target.checked)})," ",I.default.createElement("span",null,g.get("GUI:TauntsOn")))),!$&&J&&ee&&K&&I.default.createElement("div",{className:"chat"},I.default.createElement(G.Chat,{localUsername:K.name,messages:J,chatHistory:ee,channels:[V.RECIPIENT_ALL,V.RECIPIENT_TEAM],strings:g,userColors:new Map([K,...P.map(g=>g.player)].map(g=>[g.name,g.color.asHexString()])),onSendMessage:ne,onCancelMessage:oe}))))})}}}),System.register("gui/screen/game/gameMenu/DiploScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/game/gameMenu/DiploForm","util/disposable/CompositeDisposable","gui/screen/game/GameMenuScreen","network/gameopt/LoadInfoParser"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){W=class extends G.GameMenuScreen{constructor(g,P,I,L,_,G){super(),this.strings=g,this.jsxRenderer=P,this.renderer=I,this.gameModes=L,this.taunts=_,this.mutedPlayers=G,this.disposables=new U.CompositeDisposable,this.onFrame=g=>{(!this.lastUpdate||500<g-this.lastUpdate)&&(this.lastUpdate=g,this.updateForm())},this.handleConInfoUpdate=g=>{this.form.applyOptions(P=>{P.conInfos=(new V.LoadInfoParser).parse(g)})},this.updateForm=()=>{this.form.applyOptions(g=>{this.params&&(g.playerInfos=this.buildPlayerInfos(this.params.game,this.params.localPlayer),g.taunts=this.taunts.value,g.messages=this.params.chatHistory?.getAll())})}}onEnter(g){this.controller.toggleContentAreaVisibility(!0),this.initView(g),this.params=g,this.renderer.onFrame.subscribe(this.onFrame),this.disposables.add(()=>this.renderer.onFrame.unsubscribe(this.onFrame));const P=g.chatHistory;P&&(P.onNewMessage.subscribe(this.updateForm),this.disposables.add(()=>P.onNewMessage.unsubscribe(this.updateForm)));const I=g.gservCon;if(I?.isOpen()){I.onLoadInfo.subscribe(this.handleConInfoUpdate),this.disposables.add(()=>I.onLoadInfo.unsubscribe(this.handleConInfoUpdate)),I.requestLoadInfo();let g=setInterval(()=>{I.isOpen()?I.requestLoadInfo():this.disposables.dispose()},1e4);this.disposables.add(()=>clearInterval(g))}}initView(g){var P=[{label:this.strings.get("GUI:ResumeMission"),isBottom:!0,onClick:g.onCancel}];this.controller.setSidebarButtons(P),this.controller.showSidebarButtons();var{localPlayer:U,isSinglePlayer:G,game:P}=g,[P]=this.jsxRenderer.render(I.jsx(L.HtmlView,{width:"100%",height:"100%",component:_.DiploForm,innerRef:g=>this.form=g,props:{playerInfos:this.buildPlayerInfos(P,U),localPlayer:U,gameOpts:P.gameOpts,gameModes:this.gameModes,taunts:G?void 0:this.taunts.value,singlePlayer:G,alliancesAllowed:!G&&P.rules.mpDialogSettings.alliesAllowed&&P.rules.mpDialogSettings.allyChangeAllowed,mapName:P.gameOpts.mapTitle,messages:g.chatHistory?.getAll(),chatHistory:g.chatHistory,onToggleTaunts:g=>this.taunts.value=g,onToggleAlliance:g.onToggleAlliance,onToggleChat:(g,P)=>{P?this.mutedPlayers.delete(g.name):this.mutedPlayers.add(g.name)},onSendMessage:g.onSendMessage,onCancelMessage:P=>P&&g.onCancel(),strings:this.strings}}));this.controller.setMainComponent(P),this.disposables.add(()=>this.form=void 0)}buildPlayerInfos(g,P){let I=P?g.alliances.filterByPlayer(P):void 0;return g.getNonNeutralPlayers().filter(g=>g!==P).map(L=>({player:L,muted:this.mutedPlayers.has(L.name),allianceToggleable:!!P&&g.alliances.canRequestAlliance(L)&&g.alliances.canFormAlliance(P,L),alliance:I?.find(g=>g.players.first===L||g.players.second===L)}))}async onLeave(){this.params=void 0,this.controller.hideSidebarButtons(),this.controller.toggleContentAreaVisibility(!1),this.disposables.dispose()}},g("DiploScreen",W)}}}),System.register("gui/screen/game/gameMenu/GameMenuController",["gui/screen/Controller"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.Controller{constructor(g){super(),this.hud=g,this.contentAreaVisible=!1}async goToScreenBlocking(...g){var[P,I]=g;return super.goToScreenBlocking(P,I)}goToScreen(...g){var[P,I]=g;return super.goToScreen(P,I)}async pushScreen(...g){var[P,I]=g;this.setMainComponent(),await super.pushScreen(P,I)}async popScreen(g){this.setMainComponent(),await super.popScreen(g)}async close(){for(;this.screenStack.length;)await this.popScreen()}setHud(g){this.hud=g}setSidebarButtons(g){this.sidebarButtons=g}showSidebarButtons(){if(void 0===this.sidebarButtons)throw new Error("Sidebar buttons should be set first");this.hud.showSidebarMenu(this.sidebarButtons)}hideSidebarButtons(){this.sidebarButtons=void 0,this.hud.hideSidebarMenu()}setMainComponent(g){this.mainContentComponent=g,this.hud.setMenuContentComponent(this.mainContentComponent)}toggleContentAreaVisibility(g){this.contentAreaVisible=g,this.hud.toggleMenuContentVisibility(g)}rerenderCurrentScreen(){super.rerenderCurrentScreen(),this.sidebarButtons&&this.hud.showSidebarMenu(this.sidebarButtons),this.hud.setMenuContentComponent(this.mainContentComponent),this.hud.toggleMenuContentVisibility(this.contentAreaVisible)}destroy(){super.destroy(),this.setMainComponent(void 0)}},g("GameMenuController",L)}}}),System.register("gui/screen/game/gameMenu/GameMenuHomeScreen",["gui/screen/game/gameMenu/ScreenType","gui/FullScreen","gui/screen/options/component/getHumanReadableKey","gui/screen/game/GameMenuScreen"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=class extends U.GameMenuScreen{constructor(g,P){super(),this.strings=g,this.fullScreen=P}onEnter(g){this.params=g,this.controller.toggleContentAreaVisibility(!0),this.initView(g)}initView(g){let P=this.strings;var U=[{label:P.get("GUI:Options"),onClick:()=>{this.controller?.pushScreen(I.ScreenType.Options)}},{label:P.get("GUI:Fullscreen",_.getHumanReadableKey(L.FullScreen.hotKey)),tooltip:P.get("STT:Fullscreen"),disabled:!this.fullScreen.isAvailable(),onClick:()=>this.fullScreen.toggle()},{label:P.get("GUI:AbortMission"),onClick:()=>{this.controller?.pushScreen(I.ScreenType.QuitConfirm,this.params)}},{label:P.get("GUI:ResumeMission"),isBottom:!0,onClick:g.onCancel}];this.controller.setSidebarButtons(U),this.controller.showSidebarButtons()}async onLeave(){this.controller.hideSidebarButtons(),this.controller.toggleContentAreaVisibility(!1)}async onStack(){this.controller.hideSidebarButtons()}onUnstack(){this.initView(this.params)}},g("GameMenuHomeScreen",G)}}}),System.register("gui/screen/game/gameMenu/QuitConfirmScreen",["gui/screen/game/GameMenuScreen"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){L=class extends I.GameMenuScreen{constructor(g){super(),this.strings=g}onEnter(g){this.initView(g)}initView(g){let P=this.strings;var I=[{label:P.get("GUI:Quit"),onClick:g.onQuit},...g.observeAllowed?[{label:P.get("GUI:Observe"),onClick:g.onObserve}]:[],{label:P.get("GUI:ResumeMission"),isBottom:!0,onClick:g.onCancel}];this.controller.setSidebarButtons(I),this.controller.showSidebarButtons()}async onLeave(){this.controller.hideSidebarButtons()}},g("QuitConfirmScreen",L)}}}),System.register("gui/screen/game/gameMenu/ScreenParamsMap",["gui/screen/game/gameMenu/ScreenType"],function(g,P){"use strict";return P&&P.id,{setters:[function(g){}],execute:function(){}}}),System.register("gui/screen/game/gameMenu/ScreenType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("ScreenType",I={}))[P.Home=0]="Home",P[P.Diplo=1]="Diplo",P[P.ConnectionInfo=2]="ConnectionInfo",P[P.QuitConfirm=3]="QuitConfirm",P[P.Options=4]="Options",P[P.OptionsSound=5]="OptionsSound",P[P.OptionsKeyboard=6]="OptionsKeyboard"}}}),System.register("gui/screen/game/GameMenuScreen",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("GameMenuScreen",class{setController(g){this.controller=g}})}}}),System.register("gui/screen/game/GameScreen",["data/DataStream","network/GservError","gui/screen/ScreenType","gui/screen/mainMenu/ScreenType","@puzzl/core/lib/async/sleep","game/Game","engine/Engine","gui/screen/game/component/hud/viewmodel/SidebarModel","network/gamestate/LockstepManager","network/gamestate/ActionSerializer","game/action/ActionFactory","game/action/ActionQueue","tools/DevToolsApi","engine/GameAnimationLoop","gui/screen/game/component/GameResultPopup","gui/jsx/jsx","util/disposable/CompositeDisposable","network/gamestate/SoloPlayTurnManager","gui/screen/game/SoundHandler","LocalPrefs","gui/screen/game/worldInteraction/WorldInteractionFactory","gui/screen/game/CombatantUi","gui/screen/game/ObserverUi","gui/screen/game/GameMenu","gui/screen/game/WorldView","engine/sound/Eva","engine/sound/EvaSpecs","gui/screen/game/NetStats","gui/screen/game/HudFactory","gui/screen/game/component/Minimap","game/SideType","network/gamestate/Replay","network/gamestate/ReplayRecorder","gui/screen/game/component/hud/viewmodel/CombatantSidebarModel","game/action/ActionFactoryReg","gui/screen/game/component/hud/viewmodel/MessageList","engine/sound/SoundKey","engine/sound/ChannelType","gui/screen/game/ChatNetHandler","gui/screen/game/ChatTypingHandler","@puzzl/core/lib/async/Task","network/IrcConnection","@puzzl/core/lib/async/cancellation","network/gservConfig","engine/sound/Music","gui/screen/game/TauntHandler","gui/screen/game/TauntPlayback","game/action/ActionType","game/event/EventType","gui/screen/game/gameMenu/ConnectionInfoScreen","gui/screen/game/component/hud/commandBar/CommandBarButtonList","gui/screen/game/component/hud/commandBar/CommandBarButtonType","engine/ResourceLoader","data/vfs/StorageQuotaError","data/vfs/FileNotFoundError","util/userAgent","data/vfs/IOError","gui/screen/RootScreen","gui/screen/game/loadingScreen/LoadingScreenApiFactory","gui/replay/ReplayStorageError","data/MapFile","data/vfs/VirtualFile","util/string","engine/MapDigest","engine/MapSupport","network/gameres/GameRes","game/gameopts/constants","gui/screen/mainMenu/MainMenuRoute","gui/screen/RootRoute","gui/chat/ChatHistory","gui/chat/ChatMessageFormat","gui/screen/game/MedianPing","gui/screen/game/PingMonitor"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be,Se,we,Ee,Ce,xe,Oe,Ae,Me,Re,Pe,Ie,ke,Be,Ne,Le,je,De,Fe,_e,Ue,He,Ge,Ve,We,ze,Ke,qe,$e,Qe,Ye,Ze,Xe,Je,et,tt,it,rt,st;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g},function(g){ce=g},function(g){he=g},function(g){ue=g},function(g){de=g},function(g){ge=g},function(g){pe=g},function(g){me=g},function(g){fe=g},function(g){ye=g},function(g){Te=g},function(g){ve=g},function(g){be=g},function(g){Se=g},function(g){we=g},function(g){Ee=g},function(g){Ce=g},function(g){xe=g},function(g){Oe=g},function(g){Ae=g},function(g){Me=g},function(g){Re=g},function(g){Pe=g},function(g){Ie=g},function(g){ke=g},function(g){Be=g},function(g){Ne=g},function(g){Le=g},function(g){je=g},function(g){De=g},function(g){Fe=g},function(g){_e=g},function(g){Ue=g},function(g){He=g},function(g){Ge=g},function(g){Ve=g},function(g){We=g},function(g){ze=g},function(g){Ke=g},function(g){qe=g},function(g){$e=g},function(g){Qe=g},function(g){Ye=g},function(g){Ze=g},function(g){Xe=g},function(g){Je=g},function(g){et=g},function(g){tt=g},function(g){it=g},function(g){rt=g}],execute:function(){st=class extends Ge.RootScreen{constructor(g,P,I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,te,re,se,ae,ne,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be,Se,we,Ee,Ce,xe,Oe,Ae){super(),this.workerHostApi=g,this.gservCon=P,this.wgameresService=I,this.wolService=L,this.mapTransferService=_,this.engineVersion=U,this.engineModHash=G,this.errorHandler=V,this.gameMenuSubScreens=W,this.loadingScreenApiFactory=z,this.gameOptsParser=K,this.gameOptsSerializer=q,this.config=$,this.strings=Q,this.renderer=Y,this.uiScene=Z,this.runtimeVars=X,this.messageBoxApi=J,this.toastApi=te,this.uiAnimationLoop=re,this.viewport=se,this.jsxRenderer=ae,this.pointer=ne,this.sound=oe,this.music=le,this.mixer=ce,this.keyBinds=he,this.generalOptions=ue,this.localPrefs=de,this.actionLogger=ge,this.lockstepLogger=pe,this.replayManager=me,this.fullScreen=fe,this.mapFileLoader=ye,this.mapDir=Te,this.mapList=ve,this.gameLoader=be,this.vxlGeometryPool=Se,this.buildingImageDataCache=we,this.mutedPlayers=Ee,this.tauntsEnabled=Ce,this.speedCheat=xe,this.sentry=Oe,this.battleControlApi=Ae,this.preventUnload=!0,this.avgPing=new it.MedianPing,this.disposables=new ee.CompositeDisposable,this.onGservClose=g=>{this.replay&&(this.replay.finish(this.game.currentTick),this.saveReplay(this.replay)),this.handleError(g,this.strings.get("TXT_YOURE_DISCON")),this.game&&this.sendGameRes(this.game,{disconnect:!0,desync:!1,quit:!1,finished:!1})}}async onEnter(g){this.pointer.lock(),this.pointer.setVisible(!1),this.music?.play(Re.MusicType.Loading).catch(g=>console.warn("Failed to play loading music",g));let P=new Ae.CancellationTokenSource;this.disposables.add(()=>P.cancel());let I,L=P.token;this.returnTo=g.returnTo,this.isTournament=g.tournament;var G=this.playerName=g.playerName,z=this.isSinglePlayer=g.create&&g.singlePlayer;if(z)I=g.gameOpts;else{var K=this.wolService.getCredentials();if(!K||K.user!==G)return this.localPrefs.removeItem(se.StorageKey.LastConnection),void this.controller?.goToScreen(_.ScreenType.MainMenuRoot,{route:new Xe.MainMenuRoute(U.ScreenType.Login,{forceUser:G,afterLogin:P=>new Je.RootRoute(_.ScreenType.Game,g)})});this.wolService.setAutoReconnect(!0),this.gservCon.onClose.subscribe(this.onGservClose);try{I=await this.connectToServerInstance(g,K,L)}catch(P){return void this.handleGservConError(P)}let{returnTo:V,...W}=g;this.localPrefs.setItem(se.StorageKey.LastConnection,JSON.stringify(W))}let Z;this.config.devMode?this.runtimeVars.cheatsEnabled.value=this.isSinglePlayer:this.isSinglePlayer||(this.runtimeVars.cheatsEnabled.value=!1);try{var X=await this.transferAndLoadMapFile(g,I.mapName,I.mapDigest,L);I.mapOfficial||(this.debugMapFile=X,this.disposables.add(()=>this.debugMapFile=void 0)),Z=new ze.MapFile(X);var J=Qe.MapSupport.check(Z,this.strings);if(J)return void this.handleError(J,J)}catch(P){return void this.handleMapLoadError(P,I.mapName)}if(J=this.loadingScreenApiFactory.create(z?Ve.LoadingScreenType.SinglePlayer:Ve.LoadingScreenType.MultiPlayer),this.loadingScreenApi=J,this.disposables.add(J,()=>this.loadingScreenApi=void 0),this.disposables.add(()=>this.gameLoader.clearStaticCaches()),!L.isCancelled()){let _;try{_=await this.gameLoader.load(g.gameId,g.timestamp,I,Z,G,this.isSinglePlayer,J,L)}catch(P){return void this.handleGameLoadError(P,g,I)}if(!L.isCancelled()){let{game:L,theater:U,hudSide:K,cameoFilenames:Z}=_;this.game=L,this.disposables.add(L,()=>this.game=void 0,()=>W.Engine.unloadTheater(U.type));let X,ee=L.getPlayerByName(G);try{X=this.loadUi(L,U,ee,K,Z)}catch(P){return J=P.message?.match(/memory|allocation/i)?this.strings.get("TS:GameInitOom"):this.strings.get("TS:GameInitError")+(L.gameOpts.mapOfficial?"":"\n\n"+this.strings.get("TS:CustomMapCrash")),void this.handleGameError(P,J,L)}let re=new $.ActionFactory;(new ve.ActionFactoryReg).register(re,L,G);let se=new Q.ActionQueue,ae=this.replay=new fe.Replay;this.disposables.add(()=>this.replay=void 0),ae.init(L.id,L.startTimestamp,I,this.engineVersion,this.engineModHash);let ne=new ye.ReplayRecorder(ae,L.getPlayerNumber(ee),L.gameOpts.humanPlayers,new q.ActionSerializer);if(this.isSinglePlayer)this.gameTurnMgr=new te.SoloPlayTurnManager(L,ee,se,this.actionLogger,ne);else{this.lagState=!1;let g=this.initLockstep(L,ee,re,se,ne);if(ee.isObserver)try{g.setPassiveMode(!0)}catch(P){if(P instanceof Oe.IrcConnection.SocketError)return;throw P}else this.disposables.add(L.events.subscribe(Be.EventType.PlayerDefeated,g=>{g.target===ee&&ee.isObserver&&this.gameTurnMgr.setPassiveMode?.(!0)}));this.gameTurnMgr=g}this.gameTurnMgr.init();let h=()=>{if(L.status!==V.GameStatus.Started)try{this.onGameStart(ee,L,X,se,re,ae,ne)}catch(P){var g=P.message?.match(/memory|allocation/i)?this.strings.get("TS:GameInitOom"):this.strings.get("TS:GameInitError")+(L.gameOpts.mapOfficial?"":"\n\n"+this.strings.get("TS:CustomMapCrash"));this.handleGameError(P,g,L)}};if(z)h(),Y.DevToolsApi.registerCommand("reset",async()=>{await this.onLeave(),await this.onEnter(g)}),Y.DevToolsApi.registerVar("speed",L.desiredSpeed),this.disposables.add(()=>Y.DevToolsApi.unregisterCommand("reset"),()=>Y.DevToolsApi.unregisterVar("speed")),Y.DevToolsApi.registerVar("cheats",this.runtimeVars.cheatsEnabled),this.disposables.add(()=>Y.DevToolsApi.unregisterVar("cheats"));else if(this.gservCon.isOpen()){let e=g=>this.gameTurnMgr.setRate(g);this.gservCon.onRateChange.subscribe(e),this.disposables.add(()=>this.gservCon.onRateChange.unsubscribe(e)),this.gservCon.onGameStart.subscribe(h),this.disposables.add(()=>this.gservCon.onGameStart.unsubscribe(h)),this.gservCon.sendLoadedPercent(100)}}}}async connectToServerInstance(g,P,I){let L=!1,_=new xe.Task(async g=>{await G.sleep(1e3),g.isCancelled()||(this.messageBoxApi.show(this.strings.get("TXT_CONNECTING")),L=!0)});_.start();try{var U,V,W;await this.gservCon.connect(g.gservUrl),await this.gservCon.cvers(this.engineVersion),await this.gservCon.login(P.user,P.pass),I.throwIfCancelled(),g.create?(U=this.gameOptsSerializer.serializeOptions(g.gameOpts),({gameId:V,timestamp:W}=g),await this.gservCon.createGame(V,W,U,this.engineVersion,this.engineModHash,g.createPrivateGame),console.log(`Created game instance with id ${g.gameId}.`),this.localPrefs.removeItem(se.StorageKey.LastConnection)):(await this.joinGame(g.gameId,5,I),console.log("Joined game instance with id "+g.gameId));var z=await this.gservCon.gameOpts();return this.gameOptsParser.parseOptions(z)}catch(g){throw this.gservCon.isOpen()||(L=!1),g}finally{_.cancel(),L&&this.messageBoxApi.destroy()}}async joinGame(g,P,I){if(P){let _;for(;P--;)try{return console.log(`Attempting to join game with id ${g}...`,P+" retries left"),I.throwIfCancelled(),void await this.gservCon.joinGame(g,this.engineVersion,this.engineModHash)}catch(g){if(!(g instanceof L.GservError&&g.code===L.GservError.Code.InstanceNonExistent))throw g;_=g,await G.sleep(3e3)}throw this.localPrefs.removeItem(se.StorageKey.LastConnection),_}await this.gservCon.joinGame(g,this.engineVersion,this.engineModHash)}async transferAndLoadMapFile(g,P,I,L){let _;if(g.create&&g.singlePlayer||!g.mapTransfer)_=await this.mapFileLoader.load(P,L);else{if(this.messageBoxApi.show(this.strings.get("GUI:MapTransfer")),g.create)_=await this.mapFileLoader.load(P,L),this.mapTransferService.getUrl()?await this.mapTransferService.putMap(_.getBytes(),g.gameId,L):this.gservCon.sendMap(_.readAsString());else{let U;if(U=this.mapTransferService.getUrl()?await this.mapTransferService.getMap(g.gameId,L):qe.binaryStringToUint8Array(await this.gservCon.getMap()),_=Ke.VirtualFile.fromBytes(U,P),$e.MapDigest.compute(_)!==I)throw new De.DownloadError("Transferred map is corrupt");if(this.mapDir&&!await this.mapDir.containsEntry(P))try{await this.mapDir.writeFile(_),this.mapList.addFromMapFile(_)}catch(g){console.error("Map couldn't be saved",[g])}}this.messageBoxApi.destroy()}return _}loadUi(g,P,I,L,_){var U=I.isObserver?new z.SidebarModel(g):new Te.CombatantSidebarModel(I,g),G=new be.MessageList(g.rules.audioVisual.messageDuration,6,I),V=new et.ChatHistory;this.sidebarModel=U,this.disposables.add(()=>this.sidebarModel=void 0);let K=W.Engine.getUiIni(),q=new Le.CommandBarButtonList;I.isObserver||q.fromIni(K.getOrCreateSection(this.isSinglePlayer?"AdvancedCommandBar":"MultiplayerAdvancedCommandBar")),this.config.discordUrl&&q.buttons.push(je.CommandBarButtonType.BugReport),this.hudFactory=new ge.HudFactory(L,this.uiScene,U,G,V,g.debugText,this.runtimeVars.debugText,I,g.getCombatants(),g.stalemateDetectTrait,g.countdownTimer,_,this.jsxRenderer,this.strings,q.buttons,this.runtimeVars.persistentHoverTags),this.disposables.add(()=>this.hudFactory=void 0);let $=this.hudFactory.create();this.hud=$;let Q=this.minimap=new pe.Minimap(g,I,$.getTextColor(),g.rules.general.radar);$.setMinimap(Q),this.disposables.add(Q,()=>this.minimap=void 0),Q.setPointerEvents(this.pointer.pointerEvents),U={width:$.sidebarWidth,height:$.actionBarHeight};let Y=new ce.WorldView(U,g,this.sound,this.renderer,this.runtimeVars,Q,this.strings,this.generalOptions,this.vxlGeometryPool,this.buildingImageDataCache),Z=Y.init(I,this.viewport.value,P);return this.worldView=Y,this.disposables.add(Y,()=>this.worldView=void 0),Z.worldScene.create3DObject(),{worldViewInitResult:Z,messageList:G,chatHistory:V,minimap:Q}}initLockstep(g,P,L,_,U){const V=this.runtimeVars.debugGameState.value;let W,z=new I.DataStream;V&&(W=g=>{z.byteLength<10485760&&z.writeString(g+"\n")});let $,Q=new K.LockstepManager(g,this.gservCon,this.gameOptsParser,this.gameOptsSerializer,new q.ActionSerializer,L,_,()=>{this.gservCon.onClose.unsubscribe(this.onGservClose),this.gservCon.close(),this.handleGameError("desync_error",this.strings.get("TS:DesyncDetected"),g,V?async()=>{let g,P;try{let I=JSON.stringify(Q.debugGameStateHistory,void 0,2);console.log("Game state dump:",I),this.workerHostApi.queueTask(async P=>{g=await P.compressFile(I,"statedump.json")}),this.workerHostApi.queueTask(async g=>{P=await g.compressFile(new Uint8Array(z.buffer,0,z.byteLength),"lockstep.log")}),await this.workerHostApi.waitForTasks()}catch(g){console.error("Failed to export debug data",g)}finally{this.workerHostApi.dispose()}return{stateDump:g,debugLog:P}}:void 0)},this.actionLogger,this.lockstepLogger,W,U,V);return Q.onLagStateChange.subscribe(P=>{this.lagState=P,$?.cancel(),$=void 0,P?($=new xe.Task(async P=>{await G.sleep(Me.CON_INFO_THRESH_MILLIS,P),P.isCancelled()||this.menu?.openConnectionInfo(g.getCombatants(),this.gservCon,this.chatNetHandler)}),$.start().catch(g=>{if(!(g instanceof Ae.OperationCanceledError))throw g}),this.disposables.add(()=>$?.cancel())):this.menu?.getCurrentScreen()instanceof Ne.ConnectionInfoScreen&&this.menu.close()}),Q}onViewportChange(){this.loadingScreenApi?.updateViewport(),this.rerenderHud()}rerenderHud(){if(this.hud){this.uiScene.remove(this.hud),this.hud.destroy(),this.hudFactory.setSidebarModel(this.sidebarModel);let g=this.hudFactory.create();this.hud=g,g.setMinimap(this.minimap),this.playerUi&&(this.uiScene.add(g),this.menu?.handleHudChange(g),this.worldView.handleViewportChange(this.viewport.value),this.playerUi.handleHudChange(g),this.chatTypingHandler&&this.initHudChatTypingEvents(this.chatTypingHandler,this.chatNetHandler,g))}}onGameStart(g,P,I,L,_,U,G){this.localPrefs.removeItem(se.StorageKey.LastConnection),this.loadingScreenApi?.dispose(),this.music?.play(Re.MusicType.Normal);var V=new ue.EvaSpecs(g.country?.side??me.SideType.GDI).readIni(W.Engine.getIni(W.Engine.getFileNameVariant("eva.ini")));let z=new he.Eva(V,this.sound,this.renderer);z.init(),this.disposables.add(z),this.initUi(g,P,G,L,_,this.hud,z,I),this.renderer.removeScene(this.uiScene),this.renderer.addScene(I.worldViewInitResult.worldScene),this.renderer.addScene(this.uiScene),this.pointer.setVisible(!0),P.onEnd.subscribe(()=>this.onGameEnd(P,g,z,U)),P.start(),this.isSinglePlayer||this.initNetStats(g),this.gameAnimationLoop=new Z.GameAnimationLoop(g,this.renderer,this.sound,this.gameTurnMgr,{skipFrames:!this.isSinglePlayer,onError:this.config.devMode?void 0:(g,I)=>{var L;g instanceof Oe.IrcConnection.SocketError||(L=g.message?.match(/memory|allocation/i)?this.strings.get("TS:GameCrashOom"):this.strings.get("TS:GameCrashed")+(I||P.gameOpts.mapOfficial?"":"\n\n"+this.strings.get("TS:CustomMapCrash")),this.handleGameError(g,L,P,void 0,I))}}),this.uiAnimationLoop.stop(),this.gameAnimationLoop.start()}initNetStats(g){let P,I=new rt.PingMonitor(this.gameTurnMgr,this.gservCon,this.avgPing);this.disposables.add(I);let e=L=>{P?.dispose(),I.setPingInterval(L?1e3:1e4),L&&(P=new de.NetStats(this.gameTurnMgr,g,this.renderer,I),P.init(),this.disposables.add(P))};e(this.runtimeVars.fps.value),I.monitor(),this.runtimeVars.fps.onChange.subscribe(e),this.disposables.add(()=>{this.runtimeVars.fps.onChange.unsubscribe(e)})}initUi(g,P,I,L,_,U,G,V){let{worldViewInitResult:z,messageList:K,chatHistory:q,minimap:$}=V;var{worldScene:Q,worldSound:Y,superWeaponFxHandler:Z,beaconFxHandler:X,renderableManager:J}=z;let ee=new re.SoundHandler(P,Y,G,this.sound,P.events,K,this.strings,g);if(ee.init(),this.disposables.add(ee),K.onNewMessage.subscribe(g=>{g.animate&&this.sound.play(Se.SoundKey.IncomingMessage,we.ChannelType.Ui)}),Ue.isIpad()){let e=g=>{this.sidebarModel.topTextLeftAlign=g};this.fullScreen.onChange.subscribe(e),this.disposables.add(()=>this.fullScreen.onChange.unsubscribe(e))}this.uiScene.add(U);let te=this.menu=new le.GameMenu(this.gameMenuSubScreens,P,g,q,this.isSinglePlayer?void 0:this.gservCon,this.isSinglePlayer,this.isTournament);te.init(U),this.initGameMenuEvents(te,G,P,g,L,_),this.disposables.add(te,()=>this.menu=void 0);var se=P.getUnitSelection(),ce=this.runtimeVars.freeCamera,he=this.runtimeVars.debugPaths,ue=this.runtimeVars.debugText,Y=this.config.devMode;ue=new ae.WorldInteractionFactory(g,P,se,J,this.uiScene,Q,this.pointer,this.renderer,this.keyBinds,this.generalOptions,ce,he,Y,document,$,this.strings,U.getTextColor(),ue,this.battleControlApi);let de;this.isSinglePlayer||(ge=new Ie.TauntPlayback(this.sound.audioSystem,W.Engine.getTaunts()),de=new Pe.TauntHandler(this.gservCon,g,P,I,this.tauntsEnabled,ge,this.mutedPlayers),de.init(),this.disposables.add(de));var ge=this.config.discordUrl;if(g.isObserver){(this.playerUi=new oe.ObserverUi(P,void 0,this.sidebarModel,void 0,this.renderer,Q,this.sound,ue,te,this.runtimeVars,this.strings,J,this.messageBoxApi,ge)).onPlayerChange.subscribe(({player:g,sidebarModel:P})=>{this.sidebarModel=P,this.rerenderHud(),this.worldView?.changeLocalPlayer(g),this.minimap.changeLocalPlayer(g)})}else this.playerUi=new ne.CombatantUi(P,g,this.isSinglePlayer,L,_,this.sidebarModel,this.renderer,Q,ee,K,this.sound,G,ue,te,this.pointer,this.runtimeVars,this.speedCheat,this.strings,de,J,Z,X,this.messageBoxApi,ge);if(this.playerUi.init(U),this.disposables.add(this.playerUi,()=>this.playerUi=void 0),!this.isSinglePlayer){X=this.wolService.getConnection(),ge=new Map(P.getNonNeutralPlayers().map(g=>[g.name,g.color.asHexString()])),ge=new tt.ChatMessageFormat(this.strings,g.name,ge);let L=new Ee.ChatNetHandler(this.gservCon,X,K,q,ge,g,P,I,this.mutedPlayers);L.init(),this.disposables.add(L);let _=this.playerUi.worldInteraction;ge=new Ce.ChatTypingHandler(_.keyboardHandler,_.arrowScrollHandler,K,q),_.chatTypingHandler=ge,this.chatTypingHandler=ge,this.chatNetHandler=L,this.disposables.add(()=>this.chatTypingHandler=this.chatNetHandler=void 0),this.initHudChatTypingEvents(ge,L,U),te.onSendMessage.subscribe(g=>{g.value.length&&L.submitMessage(g.value,g.recipient)});const x=g=>{P.getPlayerByName(g).isObserver&&K.addSystemMessage(this.strings.get("TXT_LEFT_GAME",g),"grey")};this.gservCon.onPlayerDisconnect.subscribe(x),this.disposables.add(()=>this.gservCon.onPlayerDisconnect.unsubscribe(x));const O=()=>{K.addSystemMessage(this.strings.get("TS:ChatRestricted"),"white")};this.gservCon.onPrivMsgNotAllowed.subscribe(O),this.disposables.add(()=>this.gservCon.onPrivMsgNotAllowed.unsubscribe(O))}}initHudChatTypingEvents(g,P,I){I.onMessageCancel.subscribe(()=>{g.endTyping()}),I.onMessageSubmit.subscribe(I=>{g.endTyping(),I.value.length&&P.submitMessage(I.value,I.recipient)})}initGameMenuEvents(g,P,I,L,V,W){g.onOpen.subscribe(()=>{this.pointer.unlock(),this.playerUi.worldInteraction.setEnabled(!1),this.isSinglePlayer&&(this.pausedAtSpeed=I.speed.value,I.desiredSpeed.value=Number.EPSILON,this.mixer.setMuted(we.ChannelType.Effect,!0),this.mixer.setMuted(we.ChannelType.Ambient,!0))}),g.onQuit.subscribe(async()=>{this.controller&&(this.isSinglePlayer&&this.pausedAtSpeed&&(this.mixer.setMuted(we.ChannelType.Effect,!1),this.mixer.setMuted(we.ChannelType.Ambient,!1)),L.isObserver||P.play("EVA_BattleControlTerminated"),this.pointer.lock(),this.pointer.setVisible(!1),this.playerUi.dispose(),L.isObserver||this.isSinglePlayer||this.lagState||(V.push(W.create(ke.ActionType.ResignGame)),await new Promise(g=>{this.gameTurnMgr.onActionsSent.subscribeOnce(()=>g())})),this.gservCon.onClose.unsubscribe(this.onGservClose),this.gservCon.close(),this.gameTurnMgr.dispose(),this.replay&&(this.replay.finish(this.game.currentTick),this.saveReplay(this.replay)),this.isSinglePlayer||this.sendGameRes(I,{disconnect:!1,desync:!1,quit:!0,finished:!1}),L.isObserver||this.logGame(I,!1),await G.sleep(2e3),this.controller?.goToScreen(_.ScreenType.MainMenuRoot,{route:new Xe.MainMenuRoute(U.ScreenType.Score,{game:I,localPlayer:L,singlePlayer:this.isSinglePlayer,tournament:this.isTournament,returnTo:this.returnTo??new Xe.MainMenuRoute(U.ScreenType.Home)})}))}),g.onObserve.subscribe(()=>{this.pointer.lock(),this.playerUi.worldInteraction.setEnabled(!0),V.push(W.create(ke.ActionType.ObserveGame)),this.logGame(I,!1)}),g.onCancel.subscribe(()=>{this.pointer.lock(),this.playerUi.worldInteraction.setEnabled(!0),this.isSinglePlayer&&this.pausedAtSpeed&&(I.desiredSpeed.value=this.pausedAtSpeed,this.gameTurnMgr.doGameTurn(performance.now()),this.pausedAtSpeed=void 0,this.mixer.setMuted(we.ChannelType.Effect,!1),this.mixer.setMuted(we.ChannelType.Ambient,!1))})}async onGameEnd(g,P,I,L){var V=!P.defeated||g.alliances.getAllies(P).some(g=>!g.defeated);let[W]=this.jsxRenderer.render(J.jsx(X.GameResultPopup,{type:V&&!P.isObserver?X.GameResultType.MpVictory:X.GameResultType.MpDefeat,viewport:this.viewport.value}));this.pointer.setVisible(!1),this.playerUi.dispose(),this.gservCon.onClose.unsubscribe(this.onGservClose),this.gservCon.close(),this.uiScene.add(W),P.isObserver||I.play(V?"EVA_YouAreVictorious":"EVA_YouHaveLost",!0),L.finish(g.currentTick),this.saveReplay(L),this.isSinglePlayer||this.sendGameRes(g,{disconnect:!1,desync:!1,quit:!1,finished:!g.alliances.getHostilePlayers().length}),P.isObserver||this.logGame(g,V),await G.sleep(5e3),this.uiScene.remove(W),W.destroy(),this.controller?.goToScreen(_.ScreenType.MainMenuRoot,{route:new Xe.MainMenuRoute(U.ScreenType.Score,{game:g,localPlayer:P,singlePlayer:this.isSinglePlayer,tournament:this.isTournament,returnTo:this.returnTo??new Xe.MainMenuRoute(U.ScreenType.Home)})})}logGame(g,P){window.gtag?.("event","game_finish",{singlePlayer:Number(this.isSinglePlayer),numPlayers:g.gameOpts.humanPlayers.filter(g=>g.countryId!==Ze.OBS_COUNTRY_ID).length+g.gameOpts.aiPlayers.filter(g=>!!g).length,won:Number(P),tournament:Number(this.isTournament),duration:g.currentTime})}async onLeave(){this.pointer.unlock(),this.gameAnimationLoop&&(this.gameAnimationLoop.destroy(),this.gameAnimationLoop=void 0,this.uiAnimationLoop.start()),this.hud&&(this.uiScene.remove(this.hud),this.hud.destroy(),this.hud=void 0),this.gameTurnMgr?.dispose(),this.gameTurnMgr=void 0,this.disposables.dispose(),this.isSinglePlayer||(this.wolService.setAutoReconnect(!1),this.gservCon.onClose.unsubscribe(this.onGservClose),this.gservCon.close())}handleGservConError(g){if(!(g instanceof Ae.OperationCanceledError)){let P;if(g instanceof L.GservError&&g.code===L.GservError.Code.InstanceNonExistent)P=this.strings.get("WOL:InstanceNotFound");else if(g instanceof L.GservError&&g.code===L.GservError.Code.BadLogin)P=this.strings.get("TXT_BADPASS");else if(g instanceof L.GservError&&g.code===L.GservError.Code.AlreadyLoggedIn)P=this.strings.get("WOL:AlreadyLoggedIn");else if(g instanceof L.GservError&&g.code===L.GservError.Code.OutdatedClient)P=this.strings.get("TXT_YOURGAME_OUTDATED");else if(g instanceof L.GservError&&g.code===L.GservError.Code.TooManyLoginAttempts)P=this.strings.get("WOL:TooManyLoginAttempts");else if(g instanceof L.GservError&&g.code===L.GservError.Code.CreatedTooManyInstances)P=this.strings.get("WOL:CreatedTooManyInstances");else if(g instanceof L.GservError&&g.code===L.GservError.Code.InstanceNotAllowed)P=this.strings.get("WOL:InstanceNotAllowed");else if(g instanceof L.GservError&&g.code===L.GservError.Code.InstanceAlreadyStarted)P=this.strings.get("WOL:GameAlreadyStarted");else if(g instanceof L.GservError&&g.code===L.GservError.Code.InstanceVersMismatch)P=this.strings.get("TXT_MISMATCH");else{if(g instanceof Oe.IrcConnection.SocketError)return;g instanceof Oe.IrcConnection.ConnectError?P=this.strings.get("TS:ConnectFailed"):(P=this.strings.get("WOL:MatchBadParameters"),g instanceof L.GservError?this.sendDebugInfo(new Error("Gserv error "+g.code,{cause:g})):g instanceof Oe.IrcConnection.NoReplyError||this.sendDebugInfo(new Error(`Failed to connect to game instance (${g.message??g.name})`,{cause:g})))}this.handleError(g,P)}}handleMapLoadError(g,P){if(!(g instanceof Ae.OperationCanceledError||g instanceof Oe.IrcConnection.SocketError)){let I;I=g instanceof De.DownloadError?404===g.statusCode?this.strings.get("TS:MapNotFound",P):this.strings.get("TS:MapDownloadFailed",P):("string"==typeof g?g:g.message)?.match(/memory|allocation/i)?this.strings.get("TS:GameInitOom"):g instanceof Oe.IrcConnection.NoReplyError?this.strings.get("TS:MapDownloadFailed",P):this.strings.get("TXT_MAP_ERROR"),this.handleError(g,I)}}handleGameLoadError(g,P,I){if(!(g instanceof Ae.OperationCanceledError||g instanceof Oe.IrcConnection.SocketError)){let L;if(g instanceof De.DownloadError)L=this.strings.get("TS:AssetLoadError");else if(g instanceof He.IOError)L=this.strings.get("ts:storage_io_error");else{let _="string"==typeof g?g:g.message;if(_?.match(/memory|allocation/i))L=this.strings.get("TS:GameInitOom");else{L=this.strings.get("TS:GameInitError"),I.mapOfficial||(L+="\n\n"+this.strings.get("TS:CustomMapCrash"));let _=new fe.Replay;_.init(P.gameId,P.timestamp,I,this.engineVersion,this.engineModHash),_.debugInfo=g instanceof Error?g.stack:g,_.finish(0),this.sendDebugInfo(new Error(`Game init failed (${"string"==typeof g?g:g.message??g.name})`,{cause:g}),{gameId:P.gameId,replay:_,map:this.debugMapFile,official:I.mapOfficial})}}this.handleError(g,L)}}handleGameError(g,P,I,L,_){const U=this.replay;U&&(U.name+=" (crashdump)",U.debugInfo=g instanceof Error?g.stack:g,"desync_error"===g&&(U.debugInfo+="\nConstants: "+[Math.E,Math.LN10,Math.LN2,Math.LOG10E,Math.LOG2E,Math.PI,Math.SQRT1_2,Math.SQRT2].join(",")),U.finish(I.currentTick),this.saveReplay(U)),this.handleError(g,P,_),this.sendDebugInfo(g,{gameId:I.id,replay:U,map:this.debugMapFile,official:I.gameOpts.mapOfficial},L),"desync_error"===g&&this.sendGameRes(I,{disconnect:!1,desync:!0,quit:!1,finished:!1})}sendDebugInfo(g,{gameId:P,replay:I,map:L,official:_}={},U){this.sentry&&!g.message?.match(/out of memory|buffer allocation|WebGLRenderingContext/i)&&(async()=>{let G=U?await U():void 0;this.sentry.captureException(g,g=>{if(P&&g.setTag("gameId",P),g.setTag("nick",this.playerName),g.setTag("tournament",this.isTournament),G?.stateDump&&g.addAttachment({filename:"statedump.7z",data:G.stateDump}),G?.debugLog&&g.addAttachment({filename:"lockstep_log.7z",data:G.debugLog}),I)try{g.addAttachment({filename:I.name+fe.Replay.extension,data:I.serialize()})}catch(P){g.setExtra("replayError",P)}return L&&(g.addAttachment({filename:L.filename,data:L.getBytes()}),g.setTag("mapName",L.filename)),void 0!==_&&g.setTag("officialMap",_),g})})().catch(g=>console.error("Failed sending error to sentry",g))}handleError(g,P,I){this.gameTurnMgr&&this.gameTurnMgr.setErrorState(),this.pointer.unlock();let r=()=>{this.wolService.closeWolConnection(),!this.isSinglePlayer&&this.gservCon.isOpen()&&(this.gservCon.onClose.unsubscribe(this.onGservClose),this.gservCon.close())};this.errorHandler.handle(g,P,I?void 0:()=>{r(),this.controller?.goToScreen(_.ScreenType.MainMenuRoot)}),I&&(r(),this.playerUi?.dispose())}saveReplay(g){(async()=>{try{await this.replayManager.saveReplay(g)}catch(P){P instanceof Fe.StorageQuotaError||P instanceof He.IOError||P instanceof _e.FileNotFoundError||P instanceof We.ReplayStorageError||this.sendDebugInfo(P,{replay:g,gameId:this.game?.id}),console.error(P),this.toastApi.push(this.strings.get("GUI:SaveReplayError"))}})()}sendGameRes(g,P){(async()=>{if(this.wgameresService.getUrl())try{var I=(new Ye.GameRes).fromGame(g,this.isTournament,this.getGameResClientInfo(P)).toBinary();await this.wgameresService.sendGameResPacket(I)}catch(g){console.error(g)}})()}getGameResClientInfo(g){return{clientVers:this.engineVersion,avgFps:0,avgRtt:this.avgPing.calculate()??0,outOfSync:g.desync,gameSku:this.wolService.getConfig().getClientSku(),accountName:this.playerName,suddenDisconnect:g.disconnect,quit:g.quit,finished:g.finished,pingsRecv:0,pingsSent:0}}},g("GameScreen",st)}}}),System.register("gui/screen/game/HudFactory",["gui/screen/game/component/Hud","engine/Engine"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("HudFactory",class{constructor(g,P,I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z){this.sideType=g,this.uiScene=P,this.sidebarModel=I,this.messageList=L,this.chatHistory=_,this.debugText=U,this.debugTextEnabled=G,this.localPlayer=V,this.players=W,this.stalemateDetectTrait=z,this.countdownTimer=K,this.cameoFilenames=q,this.jsxRenderer=$,this.strings=Q,this.commandBarButtons=Y,this.persistentHoverTags=Z}setSidebarModel(g){this.sidebarModel=g}create(){return new I.Hud(this.sideType,this.uiScene.viewport,L.Engine.getImages(),L.Engine.getPalettes(),this.cameoFilenames,this.sidebarModel,this.messageList,this.chatHistory,this.debugText,this.debugTextEnabled,this.localPlayer,this.players,this.stalemateDetectTrait,this.countdownTimer,this.jsxRenderer,this.strings,this.commandBarButtons,this.persistentHoverTags)}})}}}),System.register("gui/screen/game/loadingScreen/LoadingScreen",["react","network/gamestate/PlayerConnectionStatus","gui/component/CountryIcon","game/gameopts/constants","gui/component/TeamSelect"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){V=(new Map).set("Americans","Name:Para").set("French","Name:GTGCAN").set("Germans","Name:TNKD").set("British","Name:SNIPE").set("Russians","Name:TTNK").set("Confederation","Name:TERROR").set("Africans","Name:DTRUCK").set("Arabs","Name:DESO").set("Alliance","Name:BEAGLE"),W=(new Map).set("Americans","LoadBrief:USA").set("French","LoadBrief:French").set("Germans","LoadBrief:Germans").set("British","LoadBrief:British").set("Russians","LoadBrief:Russia").set("Confederation","LoadBrief:Cuba").set("Africans","LoadBrief:Lybia").set("Arabs","LoadBrief:Iraq").set("Alliance","LoadBrief:Korea"),z=class extends I.default.Component{render(){let g=this.props.playerInfos;var P=this.props.countryName,L=this.props.color;let _=1<g.length&&g.every(g=>!g.country||g.team!==U.NO_TEAM_ID);var G=W.get(P),z=V.get(P);let K=this.props.strings;return I.default.createElement("div",{className:"loading-screen",style:this.getStyle(this.props.bgImageSrc)},z?I.default.createElement("div",{className:"special-unit-name"},K.get(z)):null,G?I.default.createElement("div",{className:"briefing-text",style:{color:L}},K.get(G)):null,I.default.createElement("div",{className:"loading-text",style:{color:L}},K.get("GUI:LoadingEx")),I.default.createElement("div",{className:"player-status-container"},g?g.map(g=>this.renderStatus(g,_)):null),I.default.createElement("div",{style:{color:L},className:"country-name"},this.props.strings.get(this.props.countryUiNames.get(P)||P)),I.default.createElement("div",{style:{color:L},className:"map-name"},this.props.mapName))}renderStatus(g,P){var V=g.status===L.PlayerConnectionStatus.Connected?1:.5;return I.default.createElement("div",{key:g.name,className:"player-status",style:{opacity:V,color:g.color}},P&&I.default.createElement("span",{className:"player-team"},void 0!==g.country&&this.props.strings.get("GUI:TeamNo",G.formatTeamId(g.team))),I.default.createElement("progress",{value:""+g.loadPercent,max:100}),I.default.createElement(_.CountryIcon,{country:g.country?g.country.name:U.OBS_COUNTRY_NAME}),I.default.createElement("span",{className:"player-name"},g.name))}getStyle(g){var P=this.props.viewport;return{backgroundImage:g?`url(${g})`:void 0,backgroundSize:"cover",width:P.width+"px",height:P.height+"px",position:"absolute",left:P.x,top:P.y}}},g("LoadingScreen",z)}}}),System.register("gui/screen/game/loadingScreen/LoadingScreenApi",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("gui/screen/game/loadingScreen/LoadingScreenApiFactory",["network/gameopt/LoadInfoParser","gui/screen/game/loadingScreen/MpLoadingScreenApi","gui/screen/game/loadingScreen/ReplayLoadingScreenApi","gui/screen/game/loadingScreen/SpLoadingScreenApi"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){var P;(P=G||g("LoadingScreenType",G={}))[P.SinglePlayer=0]="SinglePlayer",P[P.MultiPlayer=1]="MultiPlayer",P[P.Replay=2]="Replay",g("LoadingScreenApiFactory",class{constructor(g,P,I,L,_,U){this.rules=g,this.strings=P,this.uiScene=I,this.jsxRenderer=L,this.gameResConfig=_,this.gservCon=U}create(g){var{rules:P,strings:V,uiScene:W,jsxRenderer:z,gameResConfig:K,gservCon:q}=this;switch(g){case G.SinglePlayer:return new U.SpLoadingScreenApi(P,V,W,z,K);case G.MultiPlayer:var $=new I.LoadInfoParser;return new L.MpLoadingScreenApi(q,$,P,V,W,z,K);case G.Replay:return new _.ReplayLoadingScreenApi(P,V,W,z,K);default:throw new Error(`Unsupported loading screen type "${g}"`)}}})}}}),System.register("gui/screen/game/loadingScreen/LoadingScreenWrapper",["gui/jsx/jsx","gui/HtmlContainer","gui/jsx/UiComponent","gui/UiObject","gui/jsx/HtmlView","gui/screen/game/loadingScreen/LoadingScreen","game/gameopts/constants","game/SideType","engine/Engine","engine/EngineType"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g}],execute:function(){$=(new Map).set("Americans","ls800ustates.shp").set("French","ls800france.shp").set("Germans","ls800germany.shp").set("British","ls800ukingdom.shp").set("Russians","ls800russia.shp").set("Confederation","ls800cuba.shp").set("Africans","ls800libya.shp").set("Arabs","ls800iraq.shp").set("Alliance","ls800korea.shp").set("YuriCountry","ls800yuri.shp").set(W.OBS_COUNTRY_NAME,"ls800obs.shp"),Q=(new Map).set("Americans","mplsu.pal").set("French","mplsf.pal").set("Germans","mplsg.pal").set("British","mplsuk.pal").set("Russians","mplsr.pal").set("Confederation","mplsc.apl").set("Africans","mplsl.pal").set("Arabs","mplsi.pal").set("Alliance","mplsk.pal").set("YuriCountry","mpyls.pal").set(W.OBS_COUNTRY_NAME,"mplsobs.pal"),Y=class extends _.UiComponent{createUiObject({playerName:g,gameResConfig:P}){var I,_=new U.UiObject(new THREE.Object3D,new L.HtmlContainer),G=g?this.props.playerInfos.find(P=>P.name===g):void 0,V=G?.country?G.country.name:W.OBS_COUNTRY_NAME;this.countryName=V;let Y=G?.color??"#fff";G?.country&&(I=G.country.side===z.SideType.GDI?"AlliedLoad":"SovietLoad",Y=this.props.rules.colors.get(I)?.asHexString()??"#fff"),this.color=Y;let Z=$.get(V);return Z?P.isCdn()?this.bgHtmlImg=P.getCdnBaseUrl()+"ls/"+Z.replace(".shp",".png"):(this.bgSpriteImg=Z,K.Engine.getActiveEngine()===q.EngineType.YurisRevenge?this.bgSpritePal=Q.get(V):this.bgSpritePal=G?.country?"mpls.pal":"mplsobs.pal"):console.warn("Missing loading image for country "+V),_}defineChildren(){let g=this.props.rules.getMultiplayerCountries();var P=this.props.viewport;return I.jsx("fragment",null,this.props.gameResConfig.isCdn()?[]:I.jsx("sprite",{image:this.bgSpriteImg,palette:this.bgSpritePal,x:P.x,y:P.y,ref:g=>this.sprite=g}),I.jsx(G.HtmlView,{innerRef:g=>this.htmlEl=g,component:V.LoadingScreen,props:{viewport:this.props.viewport,countryUiNames:new Map([[W.OBS_COUNTRY_NAME,W.OBS_COUNTRY_UI_NAME]].concat(g.map(g=>[g.name,g.uiName]))),strings:this.props.strings,countryName:this.countryName,mapName:this.props.mapName,color:this.color,playerInfos:this.props.playerInfos,bgImageSrc:this.bgHtmlImg}}))}updateViewport(g){this.htmlEl?.applyOptions(P=>P.viewport=g),this.sprite?.setPosition(g.x,g.y)}applyOptions(g){this.htmlEl?.applyOptions(g)}},g("LoadingScreenWrapper",Y)}}}),System.register("gui/screen/game/loadingScreen/MpLoadingScreenApi",["gui/jsx/jsx","game/gameopts/constants","util/disposable/CompositeDisposable","gui/screen/game/loadingScreen/LoadingScreenWrapper"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("MpLoadingScreenApi",class{constructor(g,P,I,L,U,G,V){this.gservCon=g,this.loadInfoParser=P,this.rules=I,this.strings=L,this.uiScene=U,this.jsxRenderer=G,this.gameResConfig=V,this.lastLoadPercent=0,this.disposables=new _.CompositeDisposable,this.handleLoadInfoUpdate=g=>{let P=this.loadInfoParser.parse(g);this.loadingScreen?this.loadingScreen.applyOptions(g=>{g.playerInfos=this.createExtendedLoadingInfos(P)}):this.createLoadingScreen(P)}}async start(g,P,I){if(this.gservCon.isOpen()){this.players=g,this.localPlayerName=I,this.mapName=P,this.gservCon.onLoadInfo.subscribe(this.handleLoadInfoUpdate),this.disposables.add(()=>this.gservCon.onLoadInfo.unsubscribe(this.handleLoadInfoUpdate)),this.gservCon.requestLoadInfo();let L=setInterval(()=>{this.gservCon.isOpen()?this.gservCon.requestLoadInfo():this.disposables.dispose()},1e4);this.disposables.add(()=>clearInterval(L))}}onLoadProgress(g){(g=Math.floor(g))>this.lastLoadPercent&&(this.lastLoadPercent=g,this.gservCon.isOpen()&&this.gservCon.sendLoadedPercent(g))}createExtendedLoadingInfos(g){let P=[...this.rules.getMultiplayerColors().values()],I=this.rules.getMultiplayerCountries(),_=this.players?.every(g=>g.countryId===L.OBS_COUNTRY_ID||g.teamId!==L.NO_TEAM_ID);return g.map(g=>{var _=this.players.find(P=>P.name===g.name);return{name:g.name,status:g.status,loadPercent:g.loadPercent,country:I[_.countryId],color:_.countryId===L.OBS_COUNTRY_ID?"#fff":P[_.colorId].asHexString(),team:_.teamId}}).sort((g,P)=>_?Boolean(g.country)===Boolean(P.country)?g.team-P.team:Number(void 0!==P.country)-Number(void 0!==g.country):0)}createLoadingScreen(g){let[P]=this.jsxRenderer.render(I.jsx(U.LoadingScreenWrapper,{ref:g=>this.loadingScreen=g,strings:this.strings,rules:this.rules,viewport:this.uiScene.menuViewport,playerName:this.localPlayerName,mapName:this.mapName,playerInfos:this.createExtendedLoadingInfos(g),gameResConfig:this.gameResConfig}));this.uiScene.add(P),this.disposables.add(P,()=>this.uiScene.remove(P),()=>this.loadingScreen=void 0)}dispose(){this.disposables.dispose()}updateViewport(){this.loadingScreen?.updateViewport(this.uiScene.menuViewport)}})}}}),System.register("gui/screen/game/loadingScreen/ReplayLoadingScreenApi",["gui/jsx/jsx","game/gameopts/constants","util/disposable/CompositeDisposable","network/gamestate/PlayerConnectionStatus","gui/screen/game/loadingScreen/LoadingScreenWrapper"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){g("ReplayLoadingScreenApi",class{constructor(g,P,I,L,U){this.rules=g,this.strings=P,this.uiScene=I,this.jsxRenderer=L,this.gameResConfig=U,this.lastLoadPercent=0,this.disposables=new _.CompositeDisposable,this.handleLoadInfoUpdate=g=>{var P;this.loadingScreen?(P=performance.now(),(!this.lastRenderTime||P-this.lastRenderTime>1e3/15)&&(this.lastRenderTime=P,this.loadingScreen.applyOptions(P=>{P.playerInfos=this.createExtendedLoadingInfos(g)}))):this.createLoadingScreen(g)}}async start(g,P){this.players=g,this.mapName=P,this.handleLoadInfoUpdate(0)}onLoadProgress(g){(g=Math.floor(g))>this.lastLoadPercent&&(this.lastLoadPercent=g,this.handleLoadInfoUpdate(g))}createExtendedLoadingInfos(g){let P=[...this.rules.getMultiplayerColors().values()],I=this.rules.getMultiplayerCountries(),_=this.players?.every(g=>g.countryId===L.OBS_COUNTRY_ID||g.teamId!==L.NO_TEAM_ID);return this.players.filter(g=>g.countryId!==L.OBS_COUNTRY_ID).map(L=>({name:L.name,status:U.PlayerConnectionStatus.Connected,loadPercent:g,country:I[L.countryId],color:P[L.colorId].asHexString(),team:L.teamId})).sort((g,P)=>_?Boolean(g.country)===Boolean(P.country)?g.team-P.team:Number(void 0!==P.country)-Number(void 0!==g.country):0)}createLoadingScreen(g){let[P]=this.jsxRenderer.render(I.jsx(G.LoadingScreenWrapper,{ref:g=>this.loadingScreen=g,strings:this.strings,rules:this.rules,viewport:this.uiScene.menuViewport,playerName:void 0,mapName:this.mapName,playerInfos:this.createExtendedLoadingInfos(g),gameResConfig:this.gameResConfig}));this.uiScene.add(P),this.disposables.add(P,()=>this.uiScene.remove(P),()=>this.loadingScreen=void 0)}dispose(){this.disposables.dispose()}updateViewport(){this.loadingScreen?.updateViewport(this.uiScene.menuViewport)}})}}}),System.register("gui/screen/game/loadingScreen/SpLoadingScreenApi",["gui/jsx/jsx","game/gameopts/constants","util/disposable/CompositeDisposable","network/gamestate/PlayerConnectionStatus","gui/screen/game/loadingScreen/LoadingScreenWrapper"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){g("SpLoadingScreenApi",class{constructor(g,P,I,L,U){this.rules=g,this.strings=P,this.uiScene=I,this.jsxRenderer=L,this.gameResConfig=U,this.lastLoadPercent=0,this.disposables=new _.CompositeDisposable,this.handleLoadInfoUpdate=g=>{var P;this.loadingScreen?(P=performance.now(),(!this.lastRenderTime||P-this.lastRenderTime>1e3/15)&&(this.lastRenderTime=P,this.loadingScreen.applyOptions(P=>{P.playerInfos=this.createExtendedLoadingInfos(g)}))):this.createLoadingScreen()}}async start(g,P,I){this.players=g,this.localPlayerName=I,this.mapName=P,this.handleLoadInfoUpdate(0)}onLoadProgress(g){(g=Math.floor(g))>this.lastLoadPercent&&(this.lastLoadPercent=g,this.handleLoadInfoUpdate(g))}createExtendedLoadingInfos(g){let P=[...this.rules.getMultiplayerColors().values()];var I=this.rules.getMultiplayerCountries(),_=this.players.find(g=>g.name===this.localPlayerName);return[{name:this.localPlayerName,status:U.PlayerConnectionStatus.Connected,loadPercent:g,country:I[_.countryId],color:_.countryId===L.OBS_COUNTRY_ID?"#fff":P[_.colorId].asHexString(),team:_.teamId}]}createLoadingScreen(){let[g]=this.jsxRenderer.render(I.jsx(G.LoadingScreenWrapper,{ref:g=>this.loadingScreen=g,strings:this.strings,rules:this.rules,viewport:this.uiScene.menuViewport,playerName:this.localPlayerName,mapName:this.mapName,playerInfos:this.createExtendedLoadingInfos(0),gameResConfig:this.gameResConfig}));this.uiScene.add(g),this.disposables.add(g,()=>this.uiScene.remove(g))}dispose(){this.disposables.dispose()}updateViewport(){this.loadingScreen?.updateViewport(this.uiScene.menuViewport)}})}}}),System.register("gui/screen/game/MapFileLoader",["data/vfs/FileNotFoundError","data/vfs/VirtualFile"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("MapFileLoader",class{constructor(g,P){this.resourceLoader=g,this.vfs=P}async load(g,P){let _;if(this.vfs)try{_=await this.vfs.openFileWithRfs(g)}catch(g){g instanceof I.FileNotFoundError||console.error(g)}return _=_||L.VirtualFile.fromBytes(await this.resourceLoader.loadBinary(g,P),g),_}})}}}),System.register("gui/screen/game/MedianPing",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("MedianPing",class{constructor(g=100){this.reservoirSize=g,this.reservoir=[],this.totalSamples=0}pushSample(g){var P;this.totalSamples++,this.reservoir.length<this.reservoirSize?this.reservoir.push(g):(P=Math.floor(Math.random()*this.totalSamples))<this.reservoirSize&&(this.reservoir[P]=g)}calculate(){if(0!==this.reservoir.length){var g=[...this.reservoir].sort((g,P)=>g-P),P=Math.floor(g.length/2);return g.length%2==1?g[P]:(g[P-1]+g[P])/2}}})}}}),System.register("gui/screen/game/NetStats",["stats.js","util/disposable/CompositeDisposable"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("NetStats",class{constructor(g,P,I,_){this.lockstep=g,this.player=P,this.renderer=I,this.pingMonitor=_,this.disposables=new L.CompositeDisposable}init(){let g=this.renderer.getStats(),P=new I.default.Panel("ms RTT","#ff8","#221"),r=g=>{requestAnimationFrame(()=>P.update(g,250))};if(this.pingMonitor.onNewSample.subscribe(r),this.disposables.add(()=>{this.pingMonitor.onNewSample.unsubscribe(r);let g=this.renderer.getStats();g&&P.dom&&g.dom.removeChild(P.dom)}),g.addPanel(P),!this.player.isObserver){let P=new I.default.Panel("ms LAT","#f8f","#212"),L=new Map;this.lockstep.onActionsSent.subscribe(g=>{L.set(g,performance.now())}),this.lockstep.onActionsReceived.subscribe(g=>{if(L.has(g)){let I=performance.now()-L.get(g);L.delete(g),requestAnimationFrame(()=>P.update(I,1e3))}}),g.addPanel(P),this.disposables.add(()=>{let g=this.renderer.getStats();g&&P.dom&&g.dom.removeChild(P.dom)})}}dispose(){this.disposables.dispose()}})}}}),System.register("gui/screen/game/ObserverUi",["react","util/disposable/CompositeDisposable","engine/sound/SoundKey","engine/sound/ChannelType","gui/screen/game/worldInteraction/keyboard/KeyCommandType","engine/util/MapPanningHelper","gui/screen/game/component/hud/viewmodel/SidebarModel","game/event/EventType","gui/screen/game/component/hud/viewmodel/CombatantSidebarModel","gui/screen/game/worldInteraction/keyboard/command/CenterViewCmd","gui/screen/game/worldInteraction/keyboard/command/FollowUnitCmd","gui/screen/game/component/hud/commandBar/CommandBarButtonType","gui/screen/mainMenu/main/ReportBug","util/event","gui/screen/game/worldInteraction/keyboard/command/SetCameraLocationCmd","gui/screen/game/worldInteraction/keyboard/command/GoToCameraLocationCmd","gui/screen/game/worldInteraction/keyboard/command/CenterBaseCmd","gui/screen/game/worldInteraction/keyboard/command/SelectPlayerCmd","util/BoxedVar"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g}],execute:function(){g("ObserverUi",class{get onPlayerChange(){return this._onPlayerChange.asEvent()}constructor(g,P,I,_,U,G,V,W,z,q,$,Q,Y,X){this.game=g,this.player=P,this.sidebarModel=I,this.replay=_,this.renderer=U,this.worldScene=G,this.sound=V,this.worldInteractionFactory=W,this.gameMenu=z,this.runtimeVars=q,this.strings=$,this.renderableManager=Q,this.messageBoxApi=Y,this.discordUrl=X,this.disposables=new L.CompositeDisposable,this._onPlayerChange=new Z.EventDispatcher,this.handleProductionQueueUpdate=g=>{this.sidebarModel instanceof K.CombatantSidebarModel&&this.sidebarModel.updateFromQueue(g)}}init(g){let P=this.worldInteractionFactory.create();this.worldInteraction=P,P.init(),this.disposables.add(P),this.initKeyboardCommands(P),this.initGameEventListeners(),this.initHudEventListeners(g)}handleHudChange(g){this.initHudEventListeners(g)}dispose(){this.disposables.dispose()}initGameEventListeners(){let e=g=>{this.sidebarModel instanceof K.CombatantSidebarModel&&g.isTechno()&&g.owner===this.player&&(g.isBuilding()||Number.isFinite(g.rules.buildLimit)||g.isVehicle()&&g.transportTrait||this.game.rules.general.padAircraft.includes(g.name))&&this.sidebarModel.updateAvailableObjects(this.game.art)},g=this.game.getWorld();this.sidebarModel instanceof K.CombatantSidebarModel&&this.sidebarModel.updateAvailableObjects(this.game.art),g.onObjectSpawned.subscribe(e),g.onObjectRemoved.subscribe(e),this.disposables.add(()=>g.onObjectSpawned.unsubscribe(e),()=>g.onObjectRemoved.unsubscribe(e)),this.disposables.add(this.game.events.subscribe(z.EventType.BuildingInfiltration,g=>{g.source.owner===this.player&&this.sidebarModel instanceof K.CombatantSidebarModel&&this.sidebarModel.updateAvailableObjects(this.game.art)})),this.disposables.add(this.game.events.subscribe(z.EventType.ObjectOwnerChange,g=>{g.target.isBuilding()&&(g.prevOwner===this.player||g.target.owner===this.player)&&this.sidebarModel instanceof K.CombatantSidebarModel&&this.sidebarModel.updateAvailableObjects(this.game.art)})),this.player?.production.onQueueUpdate.subscribe(this.handleProductionQueueUpdate),this.disposables.add(()=>this.player?.production.onQueueUpdate.unsubscribe(this.handleProductionQueueUpdate));let i=()=>{this.sidebarModel instanceof K.CombatantSidebarModel&&this.sidebarModel.updateSuperWeapons()};this.renderer.onFrame.subscribe(i),this.disposables.add(()=>this.renderer.onFrame.unsubscribe(i)),this.disposables.add(this.game.events.subscribe(g=>{g.type===z.EventType.PowerChange&&g.target===this.player&&(this.sidebarModel.powerGenerated=g.power,this.sidebarModel.powerDrained=g.drain)}))}changePlayer(g){var P;g!==this.player&&(this.player?.production.onQueueUpdate.unsubscribe(this.handleProductionQueueUpdate),this.player=g,this.player?.production.onQueueUpdate.subscribe(this.handleProductionQueueUpdate),P=this.sidebarModel,this.sidebarModel=g?new K.CombatantSidebarModel(g,this.game):new W.SidebarModel(this.game,this.replay),this.sidebarModel instanceof K.CombatantSidebarModel&&this.sidebarModel.updateAvailableObjects(this.game.art),this.sidebarModel.selectTab(P.activeTab.id),this.sidebarModel.topTextLeftAlign=P.topTextLeftAlign,P=g?this.game.mapShroudTrait.getPlayerShroud(g):void 0,this.worldInteraction?.setShroud(P),this._onPlayerChange.dispatch(this,{player:g,sidebarModel:this.sidebarModel}))}initHudEventListeners(g){g.onSidebarTabClick.subscribe(()=>{this.sound.play(_.SoundKey.GUITabSound,U.ChannelType.Ui)});let P=this.game.rules.audioVisual.creditTicks;g.onCreditsTick.subscribe(g=>{this.sound.play("up"===g?P[0]:P[1],U.ChannelType.CreditTicks)}),g.onMessagesTick.subscribe(()=>{this.sound.play(_.SoundKey.MessageCharTyped,U.ChannelType.Ui)}),g.onScrollButtonClick.subscribe(g=>{this.sound.play(g?_.SoundKey.GenericClick:_.SoundKey.ScoldSound,U.ChannelType.Ui)}),g.onCommandBarButtonClick.subscribe(g=>{switch(g){case Q.CommandBarButtonType.BugReport:if(!this.discordUrl)break;this.gameMenu.open(),this.messageBoxApi.show(I.createElement(Y.ReportBug,{discordUrl:this.discordUrl,strings:this.strings}),this.strings.get("GUI:OK"))}})}initKeyboardCommands(g){let P=g.unitSelectionHandler;g.registerKeyCommand(G.KeyCommandType.Options,()=>this.gameMenu.open()).registerKeyCommand(G.KeyCommandType.Scoreboard,()=>this.gameMenu.openDiplo()).registerKeyCommand(G.KeyCommandType.VeterancyNav,()=>P.selectByVeterancy()).registerKeyCommand(G.KeyCommandType.HealthNav,()=>P.selectByHealth()).registerKeyCommand(G.KeyCommandType.ToggleFps,()=>this.runtimeVars.fps.value=!this.runtimeVars.fps.value).registerKeyCommand(G.KeyCommandType.TogglePersistentTags,()=>this.runtimeVars.persistentHoverTags.value=!this.runtimeVars.persistentHoverTags.value);let I=new V.MapPanningHelper(this.game.map),L=new re.BoxedVar(this.player);[G.KeyCommandType.TeamSelect_1,G.KeyCommandType.TeamSelect_2,G.KeyCommandType.TeamSelect_3,G.KeyCommandType.TeamSelect_4,G.KeyCommandType.TeamSelect_5,G.KeyCommandType.TeamSelect_6,G.KeyCommandType.TeamSelect_7,G.KeyCommandType.TeamSelect_8,G.KeyCommandType.TeamSelect_9,G.KeyCommandType.TeamSelect_10].forEach((P,_)=>g.registerKeyCommand(P,new te.SelectPlayerCmd(_,L,I,this.worldScene.cameraPan,this.game))),L.onChange.subscribe(g=>this.changePlayer(g)),new Map([[G.KeyCommandType.StructureTab,W.SidebarCategory.Structures],[G.KeyCommandType.DefenseTab,W.SidebarCategory.Armory],[G.KeyCommandType.InfantryTab,W.SidebarCategory.Infantry],[G.KeyCommandType.UnitTab,W.SidebarCategory.Vehicles]]).forEach((P,I)=>{g.registerKeyCommand(I,()=>{this.sidebarModel.selectTab(P)})});let _=new Map;[G.KeyCommandType.SetView1,G.KeyCommandType.SetView2,G.KeyCommandType.SetView3,G.KeyCommandType.SetView4].forEach((P,I)=>{g.registerKeyCommand(P,new X.SetCameraLocationCmd(this.worldScene.cameraPan,_,I-1))}),[G.KeyCommandType.View1,G.KeyCommandType.View2,G.KeyCommandType.View3,G.KeyCommandType.View4].forEach((P,I)=>{g.registerKeyCommand(P,new J.GoToCameraLocationCmd(this.worldScene.cameraPan,_,I-1))}),g.registerKeyCommand(G.KeyCommandType.CenterBase,()=>{if(this.player){new ee.CenterBaseCmd(this.player,this.game.rules,I,this.worldScene.cameraPan).execute()}});var U=new q.CenterViewCmd(P,I,this.worldScene.cameraPan);g.registerKeyCommand(G.KeyCommandType.CenterView,U);let z=new $.FollowUnitCmd(P,this.renderableManager,g,I,this.worldScene.cameraPan,this.worldScene);z.init(),this.disposables.add(z),g.registerKeyCommand(G.KeyCommandType.Follow,z)}})}}}),System.register("gui/screen/game/PingMonitor",["network/IrcConnection","util/event"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("PingMonitor",class{get onNewSample(){return this._onNewSample.asEvent()}constructor(g,P,I,_=1e3,U=5){this.gameTurnMgr=g,this.gservCon=P,this.avgPing=I,this.pingIntervalMillis=_,this.pingTimeoutSeconds=U,this.isDisposed=!1,this._onNewSample=new L.EventDispatcher}monitor(){this.isDisposed=!1,this.pingTimeoutId??(this.pingTimeoutId=setTimeout(()=>this.updatePing(),this.pingIntervalMillis))}setPingInterval(g){g!==this.pingIntervalMillis&&(this.pingIntervalMillis=g,this.pingTimeoutId&&(clearTimeout(this.pingTimeoutId),this.updatePing()))}async updatePing(){if(this.pingTimeoutId=void 0,!this.gameTurnMgr.getErrorState()&&this.gservCon.isOpen()){let g;try{if(g=await this.gservCon.ping(this.pingTimeoutSeconds),this.isDisposed||this.pingTimeoutId)return}catch(P){P instanceof I.IrcConnection.NoReplyError||console.error(P),g=1e3*this.pingTimeoutSeconds}this.avgPing.pushSample(g),this._onNewSample.dispatch(this,g),this.pingTimeoutId=setTimeout(()=>this.updatePing(),this.pingIntervalMillis)}}dispose(){this.pingTimeoutId&&clearTimeout(this.pingTimeoutId),this.isDisposed=!0,this._onNewSample=new L.EventDispatcher}})}}}),System.register("gui/screen/game/PlayerUi",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("gui/screen/game/SoundHandler",["game/order/OrderType","engine/sound/SoundKey","engine/sound/ChannelType","util/disposable/CompositeDisposable","game/event/EventType","util/math","gui/screen/game/worldInteraction/UnitSelectionHandler","util/typeGuard","game/gameobject/Building","game/rules/TechnoRules","util/array","game/rules/general/RadarRules","game/player/production/ProductionQueue","engine/type/ObjectType","game/Coords","game/event/AllianceChangeEvent","game/gameobject/unit/VeteranLevel","game/order/OrderFeedbackType","game/gameopts/constants","game/gameobject/common/DeathType","game/WeaponType","game/gameobject/unit/ZoneType","game/type/SuperWeaponType","game/gameobject/infantry/StanceType","game/type/PowerupType","game/gameobject/unit/HealthLevel","game/trait/StalemateDetectTrait"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g},function(g){ce=g},function(g){he=g},function(g){ue=g}],execute:function(){de=(new Map).set(oe.SuperWeaponType.MultiMissile,"EVA_NuclearSiloDetected").set(oe.SuperWeaponType.IronCurtain,"EVA_IronCurtainDetected").set(oe.SuperWeaponType.ChronoSphere,"EVA_ChronosphereDetected").set(oe.SuperWeaponType.LightningStorm,"EVA_WeatherDeviceReady"),ge=(new Map).set(oe.SuperWeaponType.MultiMissile,"EVA_NuclearMissileReady").set(oe.SuperWeaponType.IronCurtain,"EVA_IronCurtainReady").set(oe.SuperWeaponType.ChronoSphere,"EVA_ChronosphereReady").set(oe.SuperWeaponType.LightningStorm,"EVA_LightningStormReady").set(oe.SuperWeaponType.ParaDrop,"EVA_ReinforcementsReady").set(oe.SuperWeaponType.AmerParaDrop,"EVA_ReinforcementsReady"),pe=(new Map).set(oe.SuperWeaponType.MultiMissile,"EVA_NuclearMissileLaunched").set(oe.SuperWeaponType.IronCurtain,"EVA_IronCurtainActivated").set(oe.SuperWeaponType.ChronoSphere,"EVA_ChronosphereActivated").set(oe.SuperWeaponType.LightningStorm,"EVA_LightningStormCreated"),me=(new Map).set(oe.SuperWeaponType.MultiMissile,L.SoundKey.DigSound),fe=(new Map).set(oe.SuperWeaponType.LightningStorm,"TXT_LIGHTNING_STORM_APPROACHING"),ye=new Map([[ce.PowerupType.Veteran,L.SoundKey.CratePromoteSound],[ce.PowerupType.Money,L.SoundKey.CrateMoneySound],[ce.PowerupType.Reveal,L.SoundKey.CrateRevealSound],[ce.PowerupType.Firepower,L.SoundKey.CrateFireSound],[ce.PowerupType.Armor,L.SoundKey.CrateArmourSound],[ce.PowerupType.Speed,L.SoundKey.CrateSpeedSound],[ce.PowerupType.Unit,L.SoundKey.CrateUnitSound]]),Te=new Map([[ce.PowerupType.Armor,"EVA_UnitArmorUpgraded"],[ce.PowerupType.Firepower,"EVA_UnitFirePowerUpgraded"],[ce.PowerupType.Speed,"EVA_UnitSpeedUpgraded"]]),g("SoundHandler",class{constructor(g,P,I,L,_,G,V,W){this.game=g,this.worldSound=P,this.eva=I,this.sound=L,this.gameEvents=_,this.messageList=G,this.strings=V,this.player=W,this.lastAvailableObjectNames=[],this.lastQueueStatuses=new Map,this.triggerSoundHandles=new Map,this.disposables=new U.CompositeDisposable}init(){this.disposables.add(this.gameEvents.subscribe(g=>this.handleGameEvent(g)))}dispose(){this.disposables.dispose()}handleGameEvent(g){switch(g.type){case G.EventType.Cheer:this.sound.play(L.SoundKey.CheerSound,_.ChannelType.Effect);break;case G.EventType.UnitDeployUndeploy:var P="undeploy"===g.deployType,I=g.unit;(P=P?I.rules.undeploySound:I.rules.deploySound)&&this.worldSound.playEffect(P,I,I.owner);break;case G.EventType.ObjectTeleport:(P=g).isChronoshift&&(P.target.rules.chronoInSound&&this.worldSound.playEffect(P.target.rules.chronoInSound,P.target,P.target.owner),P.target.rules.chronoOutSound&&(I=X.Coords.tile3dToWorld(P.prevTile.rx+.5,P.prevTile.ry+.5,P.prevTile.z),this.worldSound.playEffect(P.target.rules.chronoOutSound,I,P.target.owner)));break;case G.EventType.WeaponFire:var U=g.weapon,W=g.gameObject;if(U.type===ae.WeaponType.DeathWeapon&&W.isCrashing)break;(z=U.rules.report).length&&($=g.weapon.warhead.rules.electricAssault?.25:1,this.worldSound.playEffect(z[V.getRandomInt(0,z.length-1)],W.position.worldPosition,W.owner,$));break;case G.EventType.InflictDamage:{let P=g;if((U=P.target.healthTrait.health)&&P.target.isTechno())if(P.target.isBuilding()){if(P.target.wallTrait)break;var z=P.damageHitPoints/P.target.healthTrait.maxHitPoints*100,$=100*(W=this.game.rules.audioVisual).conditionRed;(U<=(W=100*W.conditionYellow)&&W<U+z||U<=$&&$<U+z)&&this.worldSound.playEffect(L.SoundKey.BuildingDamageSound,P.target,P.target.owner)}else{var Y=P.target.rules.voiceFeedback;P.target.owner===this.player&&Y&&.9<Math.random()&&this.worldSound.playEffect(Y,P.target,P.target.owner)}}break;case G.EventType.RadarEvent:if((Y=g).radarEventType===Q.RadarEventType.BaseUnderAttack)Y.target===this.player?(this.eva.play("EVA_OurBaseIsUnderAttack"),this.sound.play(L.SoundKey.BaseUnderAttackSound,_.ChannelType.Effect)):this.player&&this.game.alliances.areAllied(this.player,Y.target)&&(this.eva.play("EVA_OurAllyIsUnderAttack"),this.sound.play(L.SoundKey.BaseUnderAttackSound,_.ChannelType.Effect));else if(Y.radarEventType===Q.RadarEventType.HarvesterUnderAttack)Y.target===this.player&&this.eva.play("EVA_OreMinerUnderAttack");else if(Y.radarEventType===Q.RadarEventType.EnemyObjectSensed&&Y.target===this.player){let g=this.game.map.getGroundObjectsOnTile(Y.tile).find(g=>g.isBuilding()&&g.superWeaponTrait);g&&(void 0===(oe=g.superWeaponTrait?.getSuperWeapon(g)?.rules.type)||(he=de.get(oe))&&this.eva.play(he))}break;case G.EventType.SuperWeaponReady:var Z=g.target;Z.owner!==this.player||(te=void 0!==Z.rules.type?ge.get(Z.rules.type):void 0)&&this.eva.play(te);break;case G.EventType.SuperWeaponActivate:var te,oe=g.target,he=g.owner;g.noSfxWarning||((Z=pe.get(oe))&&this.eva.play(Z,!0),(te=me.get(oe))&&(Z=g.atTile,this.worldSound.playEffect(te,X.Coords.tile3dToWorld(Z.rx,Z.ry,Z.z),he))),(oe=fe.get(oe))&&this.messageList.addSystemMessage(this.strings.get(oe),this.player??"grey");break;case G.EventType.LightningStormManifest:this.messageList.addSystemMessage(this.strings.get("TXT_LIGHTNING_STORM"),this.player??"grey");var ve=g.target;this.worldSound.playEffect(L.SoundKey.StormSound,X.Coords.tile3dToWorld(ve.rx,ve.ry,ve.z));break;case G.EventType.WarheadDetonate:g.isLightningStrike&&this.worldSound.playEffect(L.SoundKey.LightningSounds,g.position);break;case G.EventType.ObjectLiftOff:(ve=(be=g.gameObject).rules.auxSound1)&&this.worldSound.playEffect(ve,be,be.owner);break;case G.EventType.ObjectLand:var be;(be=(Se=g.gameObject).rules.auxSound2)&&this.worldSound.playEffect(be,Se,Se.owner);break;case G.EventType.ObjectCrashing:var Se,we=g.gameObject;(Se=we.rules.crashingSound)&&this.worldSound.playEffect(Se,we.position.worldPosition,we.owner),we.owner!==this.player||(Ee=we.rules.voiceCrashing)&&this.worldSound.playEffect(Ee,we.position.worldPosition,we.owner);break;case G.EventType.ObjectDestroy:{let P,I=g.target;if(I.isUnit()&&!I.isInfantry()&&I.isCrashing?P=I.zone===ne.ZoneType.Water?this.game.rules.audioVisual.impactWaterSound:I.rules.impactLandSound??this.game.rules.audioVisual.impactLandSound:I.deathType===se.DeathType.Temporal||I.deathType===se.DeathType.None?P=void 0:I.deathType===se.DeathType.Crush?P=I.rules.crushSound:I.isVehicle()&&I.zone===ne.ZoneType.Water&&I.isSinker?P=L.SoundKey.SinkingSound:I.isTechno()?(P=I.rules.dieSound,!P&&I.isBuilding()&&(P=L.SoundKey.BuildingDieSound)):I.isProjectile()&&(I.fromWeapon.warhead.rules.ivanBomb?P=L.SoundKey.BombAttachSound:I.fromWeapon.warhead.rules.mindControl&&(P=L.SoundKey.YuriMindControlSound)),P){let g;I.isTechno()?g=I.owner:I.isProjectile()&&(g=I.fromPlayer),this.worldSound.playEffect(P,I.position.worldPosition,g)}I.isUnit()&&!I.rules.spawned&&I.owner===this.player&&this.eva.play("EVA_UnitLost")}break;case G.EventType.ObjectSpawn:{let P=g.gameObject;P.isTechno()&&P.rules.createSound&&this.worldSound.playEffect(P.rules.createSound,P,P.owner),P.isInfantry()&&P.stance===le.StanceType.Paradrop&&this.worldSound.playEffect(L.SoundKey.ChuteSound,P,P.owner)}break;case G.EventType.ObjectUnspawn:{let P=g.gameObject;P.isBuilding()&&P.rules.spySat&&this.worldSound.playEffect(L.SoundKey.SpySatDeactivationSound,P,P.owner)}break;case G.EventType.ObjectMorph:{let P=g.to;P.isBuilding()&&this.worldSound.playEffect(L.SoundKey.BuildingDrop,P,P.owner);break}case G.EventType.ShipSubmergeChange:this.worldSound.playEffect(L.SoundKey.CloakSound,g.target,g.target.owner);break;case G.EventType.BridgeRepair:g.source===this.player&&this.eva.play("EVA_BridgeRepaired");break;case G.EventType.BuildStatusChange:var Ee=g.target;g.status===K.BuildStatus.BuildDown&&(this.worldSound.playEffect(L.SoundKey.SellSound,Ee.position.worldPosition,Ee.owner),!Ee.poweredTrait||(we=Ee.rules.notWorkingSound)&&this.worldSound.playEffect(we,Ee,Ee.owner));break;case G.EventType.BuildingPlace:var Ce=g.target;this.worldSound.playEffect(L.SoundKey.BuildingSlam,Ce,Ce.owner),Ce.rules.spySat&&this.worldSound.playEffect(L.SoundKey.SpySatActivationSound,Ce,Ce.owner);break;case G.EventType.BuildingFailedPlace:this.player===g.player&&this.eva.play("EVA_CannotDeployHere");break;case G.EventType.ObjectSell:{let P=g.target;P.rules.wall&&this.worldSound.playEffect(L.SoundKey.SellSound,P.position.worldPosition,P.owner),this.player===P.owner&&this.eva.play(P.isBuilding()?"EVA_StructureSold":"EVA_UnitSold",!0);break}case G.EventType.BuildingRepairFull:Ce=g.target;var xe=g.source;xe===this.player&&this.worldSound.playEffect(L.SoundKey.BuildingRepairedSound,Ce,xe);break;case G.EventType.BuildingCapture:var Oe=g.target;Oe.owner===this.player&&this.eva.play(Oe.rules.needsEngineer?"EVA_TechBuildingCaptured":"EVA_BuildingCaptured");break;case G.EventType.BuildingInfiltration:if(xe=g.source,Oe=g.target,!this.player||this.player.isObserver||Oe.owner===this.player||xe.owner===this.player){let g;xe=Oe.owner===this.player,Oe.rules.radar||xe||this.eva.play("EVA_BuildingInfiltrated"),Oe.rules.radar&&(g=xe?"EVA_RadarSabotaged":"EVA_BuildingInfRadarSabotaged"),0<Oe.rules.power&&(g=xe?"EVA_PowerSabotaged":"EVA_EnemyBasePoweredDown"),Oe.rules.storage&&(g=xe?"EVA_CashStolen":"EVA_BuildingInfCashStolen"),(this.game.rules.ai.buildTech.includes(Oe.name)||[q.FactoryType.InfantryType,q.FactoryType.UnitType].includes(Oe.factoryTrait?.type))&&(g=xe?"EVA_TechnologyStolen":"EVA_NewTechnologyAcquired"),g&&this.eva.play(g)}break;case G.EventType.BuildingGarrison:var Ae=g.target;this.worldSound.playEffect(L.SoundKey.BuildingGarrisonedSound,Ae,Ae.owner),Ae.owner===this.player&&this.eva.play("EVA_StructureGarrisoned");break;case G.EventType.BuildingEvacuate:g.player===this.player&&this.eva.play("EVA_StructureAbandoned");break;case G.EventType.BuildingRepairStart:case G.EventType.UnitRepairStart:g.target.owner===this.player&&this.eva.play("EVA_Repairing");break;case G.EventType.UnitRepairFinish:(Ae=g.target).owner===this.player&&(this.eva.play("EVA_UnitRepaired"),g.from.rules.hospital&&this.worldSound.playEffect(this.game.rules.crateRules.healCrateSound,Ae,Ae.owner));break;case G.EventType.PlayerDefeated:(Re=g.target)===this.player&&!this.player.isObserver||Re.resigned||(Me=Re.isAi?this.strings.get(re.aiUiNames.get(Re.aiDifficulty)):Re.name,this.eva.play(Re!==this.player?"EVA_PlayerDefeated":"EVA_YouHaveLost"),this.messageList.addSystemMessage(this.strings.get("TXT_PLAYER_DEFEATED",Me),Re));break;case G.EventType.PlayerResigned:this.eva.play("EVA_PlayerResigned");var Me=g.target,Re=Me.isAi?this.strings.get(re.aiUiNames.get(Me.aiDifficulty)):Me.name;this.messageList.addSystemMessage(Me.isObserver?this.strings.get("TXT_PLAYER_DEFEATED",Re):this.strings.get("TXT_LEFT_GAME",Re),Me),g.assetsRedistributed&&this.messageList.addSystemMessage(this.strings.get("TS:PlayerAssetsSplit",Me.name),Me);break;case G.EventType.PlayerDropped:var Pe=g.target;this.messageList.addSystemMessage(this.strings.get("TXT_CONNECTION_LOST",Pe.name),"grey"),g.assetsRedistributed&&this.messageList.addSystemMessage(this.strings.get("TS:PlayerAssetsSplit",Pe.name),Pe);break;case G.EventType.DeployNotAllowed:g.target.owner===this.player&&this.eva.play("EVA_CannotDeployHere");break;case G.EventType.PowerLow:g.target===this.player&&(this.eva.play("EVA_LowPower"),this.messageList.addSystemMessage(this.strings.get("TXT_LOW_POWER"),this.player));break;case G.EventType.RadarOnOff:g.target===this.player&&(Ie=g.radarEnabled,this.sound.play(Ie?L.SoundKey.RadarOn:L.SoundKey.RadarOff,_.ChannelType.Effect));break;case G.EventType.InsufficientFunds:g.target===this.player&&this.eva.play("EVA_InsufficientFunds");break;case G.EventType.RallyPointChange:g.target.owner===this.player&&this.eva.play("EVA_NewRallyPointEstablished");break;case G.EventType.PrimaryFactoryChange:g.target.owner===this.player&&this.eva.play("EVA_PrimaryBuildingSelected");break;case G.EventType.AllianceChange:{let P=g.alliance;Pe=g.changeType;var Ie=g.from;Pe===J.AllianceEventType.Formed?(!this.player||this.player.isObserver||P.players.has(this.player)||this.game.alliances.areAllied(this.player,P.players.first)&&this.game.alliances.areAllied(this.player,P.players.second)?this.eva.play("EVA_AllianceFormed"):this.eva.play("EVA_EnemyAllianceFormed"),this.messageList.addSystemMessage(this.strings.get("TXT_HAS_ALLIED",P.players.second.name,P.players.first.name),"white")):Pe===J.AllianceEventType.Requested?(this.player===P.players.first?this.eva.play("EVA_RequestingAlliance"):this.player===P.players.second&&this.eva.play("EVA_AllianceRequested"),this.messageList.addSystemMessage(this.strings.get("TXT_HAS_ALLIED",P.players.first.name,P.players.second.name),"lightgrey")):Pe===J.AllianceEventType.Broken&&(this.eva.play("EVA_AllianceBroken"),this.messageList.addSystemMessage(this.strings.get("TXT_AT_WAR",Ie.name,(Ie===P.players.first?P.players.second:P.players.first).name),"white"))}break;case G.EventType.UnitPromote:g.target.owner===this.player&&(this.sound.play(g.target.veteranLevel===ee.VeteranLevel.Elite?L.SoundKey.UpgradeEliteSound:L.SoundKey.UpgradeVeteranSound,_.ChannelType.Effect),this.eva.play("EVA_UnitPromoted",!0));break;case G.EventType.EnterTransport:var ke=g.target,Be=ke.rules.enterTransportSound;Be&&this.worldSound.playEffect(Be,ke,ke.owner);break;case G.EventType.LeaveTransport:(ke=(Be=g.target).rules.leaveTransportSound)&&this.worldSound.playEffect(ke,Be,Be.owner);break;case G.EventType.UnitRecycle:var Ne=g.target,Le=Ne.rules.dieSound;Le&&this.worldSound.playEffect(Le,Ne.position.worldPosition,Ne.owner);break;case G.EventType.CratePickup:{Le=g;let P=ye.get(Le.target.type);P||Le.target.type!==ce.PowerupType.HealBase||(P=this.game.rules.crateRules.healCrateSound);var je=Te.get(Le.target.type);this.player&&!this.player.isObserver&&Le.player!==this.player&&!this.game.alliances.areAllied(Le.player,this.player)||(P&&(Ne=X.Coords.tile3dToWorld(Le.tile.rx,Le.tile.ry,Le.tile.z),this.worldSound.playEffect(P,Ne,Le.player)),je&&this.eva.play(je))}break;case G.EventType.StalemateDetect:var De=Math.floor(ue.StalemateDetectTrait.graceMinutes);this.messageList.addSystemMessage(this.strings.get("TS:StalemateWarning",De),"white",20),this.eva.play(1<De?`EVA_${De}MinutesRemaining`:"EVA_1MinuteRemaining");break;case G.EventType.TriggerSoundFx:if(je=(Fe=g).tile){if(De=this.worldSound.playEffect(Fe.soundId,X.Coords.tile3dToWorld(je.rx,je.ry,je.z))){let g=this.triggerSoundHandles.get(je);g||(g=[],this.triggerSoundHandles.set(je,g)),g.push(De)}}else this.sound.play(Fe.soundId,_.ChannelType.Effect);break;case G.EventType.TriggerStopSoundFx:var Fe,_e=g.tile;if(Fe=this.triggerSoundHandles.get(_e)){for(var Ue of Fe)Ue.isPlaying()&&Ue.stop();this.triggerSoundHandles.delete(_e)}break;case G.EventType.TriggerEva:this.eva.play(g.soundId);break;case G.EventType.TriggerText:_e=g.label,this.messageList.addSystemMessage(this.strings.get(_e),this.player??"grey")}}handleOrderPushed(g,P,U){var G=Date.now();if(!this.lastFeedbackTime||250<=G-this.lastFeedbackTime){let V;if(P===I.OrderType.Stop)V=L.SoundKey.StopSound;else if(P===I.OrderType.Guard)V=L.SoundKey.GuardSound;else if(P===I.OrderType.Scatter)V=L.SoundKey.ScatterSound;else switch(U){case te.OrderFeedbackType.Attack:V=g.rules.voiceAttack;break;case te.OrderFeedbackType.Move:V=g.rules.voiceMove;break;case te.OrderFeedbackType.Capture:V=g.rules.voiceCapture||g.rules.voiceSpecialAttack;break;case te.OrderFeedbackType.SpecialAttack:V=g.rules.voiceSpecialAttack;break;case te.OrderFeedbackType.Enter:V=g.rules.voiceEnter??g.rules.voiceMove;case te.OrderFeedbackType.None:}V&&(this.sound.play(V,_.ChannelType.Effect),this.lastFeedbackTime=G)}}handleSelectionChangeEvent({selection:g,queryType:P,veteranLevel:I,healthLevel:L}){if(!g.length||g[0].owner===this.player){var U,G=Date.now(),V=!this.lastFeedbackTime||250<=G-this.lastFeedbackTime;if(V&&(this.lastFeedbackTime=G),P){if(V){let P=g.map(g=>g.rules.voiceSelect).filter(z.isNotNullOrUndefined),I=new Map;P.forEach(g=>I.set(g,(I.get(g)??0)+1)),I.forEach((g,P)=>{var I=this.sound.getSoundSpec(P);if(I){var L=Math.min(I.limit,g);for(let g=0;g<L;g++)this.sound.play(P,_.ChannelType.Effect)}})}if(g.length||[W.QueryType.Veteran,W.QueryType.Health].includes(P)){let _;switch(P){case W.QueryType.OnScreen:_=this.strings.get("Msg:SelAcrossScreen");break;case W.QueryType.OnMap:_=this.strings.get("Msg:SelAcrossMap");break;case W.QueryType.Veteran:case W.QueryType.Health:{if(!g.length&&(P===W.QueryType.Veteran&&void 0===I||P===W.QueryType.Health&&void 0===L)){_=this.strings.get("Msg:NavEmpty");break}let G;if(P===W.QueryType.Veteran)switch(I){case ee.VeteranLevel.Elite:G=this.strings.get("Msg:Elite");break;case ee.VeteranLevel.Veteran:G=this.strings.get("Msg:Veteran");break;case ee.VeteranLevel.None:G=this.strings.get("Msg:LittleExperience")}else if(P===W.QueryType.Health)switch(L){case he.HealthLevel.Green:G=this.strings.get("Msg:Healthy");break;case he.HealthLevel.Yellow:G=this.strings.get("Msg:HeavilyDamaged");break;case he.HealthLevel.Red:G=this.strings.get("Msg:Critical")}void 0!==G&&(G=G.toUpperCase(),_=g.length?(U=g.reduce((g,P)=>g+P.rules.cost,0),this.strings.get("Msg:UnitsWorth",g.length,G,U)):this.strings.get("Msg:NoUnitsSel",G));break}}_&&this.messageList.addUiFeedbackMessage(_)}else this.messageList.addUiFeedbackMessage(this.strings.get("Msg:NothingSelected"))}else!V||(V=g.find(g=>g.rules.voiceSelect)?.rules.voiceSelect)&&this.sound.play(V,_.ChannelType.Effect)}}handleAvailableObjectsUpdate(g){var P=g.map(g=>g.name);!$.equals(this.lastAvailableObjectNames,P)&&P.length>this.lastAvailableObjectNames.length&&(this.lastAvailableObjectNames=P,this.eva.play("EVA_NewConstructionOptions"))}handleProductionQueueUpdate(g){var P=this.lastQueueStatuses.get(g.type);if(void 0===P||g.status!==P)switch(this.lastQueueStatuses.set(g.type,g.status),g.status){case Y.QueueStatus.Ready:g.getFirst().rules.type===Z.ObjectType.Building?this.eva.play("EVA_ConstructionComplete"):this.eva.play("EVA_UnitReady");break;case Y.QueueStatus.Active:g.getFirst().rules.type===Z.ObjectType.Building?this.eva.play("EVA_Building"):P===Y.QueueStatus.Idle&&this.eva.play("EVA_Training");break;case Y.QueueStatus.OnHold:this.eva.play("EVA_OnHold")}}})}}}),System.register("gui/screen/game/TauntHandler",["util/disposable/CompositeDisposable"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("TauntHandler",class{constructor(g,P,L,_,U,G,V){this.gservCon=g,this.localPlayer=P,this.game=L,this.replayRecorder=_,this.tauntsEnabled=U,this.tauntPlayback=G,this.mutedPlayers=V,this.lastTauntTimeByPlayer=new Map,this.disposables=new I.CompositeDisposable,this.handleMessage=g=>{var P;!this.tauntsEnabled.value||(P=this.game.getPlayerByName(g.from)).country&&(this.mutedPlayers.has(P.name)||this.checkAndUpdateLastTauntTime(P.name)&&(this.recordReplayEvent(P,g.tauntNo),this.tauntPlayback.playTaunt(P,g.tauntNo).catch(g=>console.error(g))))}}init(){this.gservCon.onTaunt.subscribe(this.handleMessage),this.disposables.add(()=>this.gservCon.onTaunt.unsubscribe(this.handleMessage))}sendTaunt(g){this.checkAndUpdateLastTauntTime(this.localPlayer.name)&&this.gservCon.isOpen()&&(this.gservCon.sendTaunt(g),this.recordReplayEvent(this.localPlayer,g),this.tauntPlayback.playTaunt(this.localPlayer,g).catch(g=>console.error(g)))}checkAndUpdateLastTauntTime(g){var P=Date.now(),I=this.lastTauntTimeByPlayer.get(g);return!(I&&P-I<=5e3||(this.lastTauntTimeByPlayer.set(g,P),0))}recordReplayEvent(g,P){this.replayRecorder.recordTaunt(this.game.currentTick,g.name,P)}dispose(){this.disposables.dispose()}})}}}),System.register("gui/screen/game/TauntPlayback",["engine/sound/ChannelType","util/string"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=(new Map).set("Americans","am").set("French","fr").set("Germans","ge").set("British","br").set("Russians","ru").set("Confederation","cu").set("Africans","li").set("Arabs","ir").set("Alliance","ko"),g("TauntPlayback",class{constructor(g,P){this.audioSystem=g,this.taunts=P}async playTaunt(g,P){var L=this.getTauntFileName(g.country.name,P),_=await this.taunts.get(L);_?this.audioSystem.playWavFile(_,I.ChannelType.Voice):console.warn(`Taunt file "${L}" not found.`)}getTauntFileName(g,P){return`tau${_.get(g)}${L.pad(P,"00")}.wav`}})}}}),System.register("gui/screen/game/TooltipTextResolver",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){let P=24,I=24;function i(g,I){let L;return void 0!==g&&""!==g&&(-1!==g.indexOf("{")?L=g.replace(/\{([^}]+)\}/g,(g,P)=>I.get(P)):(I.has(g)||g.match(/^NOSTR:/i))&&(L=I.get(g)),void 0===L&&P>0&&P--),L}g("resolveUiNameText",i),g("resolveHoverTooltipText",function r(g,P,I=!1){let L;if(g.entity){var _=g.entity.getUiName?.();L=i(_,P),I&&void 0!==L&&(L+=` (ID: ${g.entity.gameObject.id})`)}else g.uiObject&&(L=g.uiObject.userData.tooltip);return L}),g("resolveSidebarItemTooltipText",function n(g,P,L){if(!g?.target?.rules)return;let _=L.get(g.target.rules.uiName);if(I>0&&I--,void 0===g.target.rules.cost)return _;let U=g.target.rules.cost;return"function"==typeof P?.computePurchaseCost&&(U=P.computePurchaseCost(g.target.rules)),_+"\n$"+U})}}}),System.register("gui/screen/game/worldInteraction/ArrowScrollHandler",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("ArrowScrollHandler",class{constructor(g){this.mapScrollHandler=g,this.isPaused=!1,this.scrollDir=new THREE.Vector2,this.pressedKeys=new Set}handleKeyDown(g){!this.isPaused&&["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(g.key)&&(g.preventDefault(),g.stopPropagation(),g.repeat||(this.pressedKeys.add(g.key),this.updateScrollDir(),this.mapScrollHandler.requestForceScroll(this.scrollDir)))}handleKeyUp(g){["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(g.key)&&(g.preventDefault(),g.stopPropagation(),this.pressedKeys.delete(g.key),this.updateScrollDir(),this.scrollDir.length()||this.mapScrollHandler.cancelForceScroll())}cancel(){this.pressedKeys.clear(),this.updateScrollDir(),this.scrollDir.length()||this.mapScrollHandler.cancelForceScroll()}updateScrollDir(){for(var g of(this.scrollDir.set(0,0),this.pressedKeys))switch(g){case"ArrowUp":--this.scrollDir.y;break;case"ArrowDown":this.scrollDir.y+=1;break;case"ArrowLeft":--this.scrollDir.x;break;case"ArrowRight":this.scrollDir.x+=1;break;default:throw new Error("Should never reach this line")}}pause(){this.isPaused=!0}unpause(){this.isPaused=!1}})}}}),System.register("gui/screen/game/worldInteraction/BeaconMode",["engine/type/PointerType","util/event"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("BeaconMode",class{get onExecute(){return this._onExecute.asEvent()}static factory(g,P){return new this(g,P)}constructor(g,P){this.pointer=g,this.renderer=P,this._onExecute=new L.EventDispatcher,this.onFrame=g=>{var P;(this.lastTile!==this.currentTile||!this.lastUpdate||g-this.lastUpdate>=1e3/15)&&(this.lastTile=this.currentTile,this.lastUpdate=g,P=this.currentTile,this.pointer.setPointerType(P?I.PointerType.Beacon:I.PointerType.Default))}}enter(){this.currentTile=void 0,this.lastTile=void 0,this.lastUpdate=void 0,this.renderer.onFrame.subscribe(this.onFrame)}hover(g,P){P||(this.currentTile=g?.tile)}execute(g,P){if(P)return!1;var I=g?.tile;if(!I)return!1;this._onExecute.dispatch(this,I),this.end()}cancel(){this.end()}end(){this.renderer.onFrame.unsubscribe(this.onFrame)}dispose(){this.end()}})}}}),System.register("gui/screen/game/worldInteraction/CameraPanHandler",["util/geometry","engine/type/PointerType","util/math"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("CameraPanHandler",class{constructor(g,P,U,G,V){this.cameraPan=g,this.pointer=P,this.panRate=U,this.freeCamera=G,this.worldScene=V,this.isPanning=!1,this.paused=!1,this.stickyMode=!1,this.onFrame=g=>{if(!this.paused&&this.isPanning&&(!this.lastUpdate||g-this.lastUpdate>=1e3/60))if(this.lastUpdate=g,this.panVector.x||this.panVector.y){var P=this.stickyMode?this.initialPan:this.cameraPan.getPan(),U=this.cameraPan.getPanLimits();let g={x:_.clamp(P.x+this.panVector.x,U.x,U.x+U.width),y:_.clamp(P.y+this.panVector.y,U.y,U.y+U.height)};this.freeCamera.value&&(g={x:P.x+this.panVector.x,y:P.y+this.panVector.y});var G=!I.pointEquals(g,P);U=this.panVector.x&&g.x===P.x,P=this.panVector.y&&g.y===P.y;let V=0;if(U||P){let g=new THREE.Vector2(U?Math.sign(this.panVector.x):0,P?Math.sign(this.panVector.y):0);V=1+(THREE.Math.radToDeg(g.angle())+90)%360/45}this.pointer.setPointerType(L.PointerType.Pan,V),G&&this.cameraPan.setPan({x:g.x,y:g.y}),this.isPanning=G}else this.pointer.setPointerType(L.PointerType.Pan)}}start(g){this.startPos=g,this.isPanning=!1,this.panVector=new THREE.Vector2(0,0),this.worldScene.onBeforeCameraUpdate.subscribe(this.onFrame)}update(g,P){var I;P?(this.initialPan||(this.initialPan=this.cameraPan.getPan()),this.panVector.x=this.startPos.x-g.x,this.panVector.y=this.startPos.y-g.y):(I=this.panRate.value/5*100,this.panVector.x=Math.floor(I*_.clamp(g.x-this.startPos.x,-600,600)/600),this.panVector.y=Math.floor(I*_.clamp(g.y-this.startPos.y,-600,600)/600)),this.isPanning=!0,this.stickyMode=P}finish(){this.worldScene.onBeforeCameraUpdate.unsubscribe(this.onFrame),this.pointer.setPointerType(L.PointerType.Default),this.initialPan=void 0}setPaused(g){this.paused=g}dispose(){this.finish()}})}}}),System.register("gui/screen/game/worldInteraction/CustomScrollHandler",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("CustomScrollHandler",class{constructor(g){this.mapScrollHandler=g,this.isPaused=!1}requestScroll(g){this.isPaused||this.mapScrollHandler.requestForceScroll(g)}cancel(){this.mapScrollHandler.cancelForceScroll()}pause(){this.isPaused=!0}unpause(){this.isPaused=!1}})}}}),System.register("gui/screen/game/worldInteraction/DefaultActionHandler",["engine/type/PointerType","game/Coords","util/typeGuard","util/event","game/order/MoveOrder","game/order/orderPriorities","game/order/OrderFactory","game/order/AttackOrder","game/Target","game/order/AttackMoveOrder","game/order/OrderFeedbackType","game/order/GuardAreaOrder"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g}],execute:function(){var P;Y=class{constructor(g,P,L,_=!1){this.game=g,this.unitSelectionHandler=P,this.currentPlayer=L,this.toggleSelect=_,this.force=!1,this.allowTypeSelect=!1,this.getPointerType=()=>I.PointerType.Select,this.isAllowed=()=>!0}setForce(g){return this.force=g,this}setTypeSelect(g){return this.allowTypeSelect=g,this}isValidTarget(g){if(!g?.isTechno())return!1;if(this.currentPlayer&&(g.isInfantry()||g.isVehicle())&&g.disguiseTrait?.hasTerrainDisguise()&&!this.game.alliances.haveSharedIntel(this.currentPlayer,g.owner))return!1;let P=this.unitSelectionHandler.getSelectedUnits();return!(!this.toggleSelect&&P.some(g=>g.isUnit())&&this.currentPlayer&&!this.currentPlayer.isObserver&&g.isTechno()&&!this.game.areFriendly(g,P[0])&&P[0].owner===this.currentPlayer)&&g.rules.selectable&&(this.toggleSelect||this.force||this.allowTypeSelect&&1===P.length&&P[0]===g||!P.includes(g))}execute(g){if(this.allowTypeSelect){var P=this.unitSelectionHandler.getSelectedUnits();if(1===P.length&&P[0]===g)return void this.unitSelectionHandler.selectByType()}this.toggleSelect?this.unitSelectionHandler.toggleSelection(g):this.unitSelectionHandler.selectSingleUnit(g)}},(P=Z||g("ActionFilter",Z={}))[P.All=0]="All",P[P.SelectOnly=1]="SelectOnly",P[P.NoSelect=2]="NoSelect",g("DefaultActionHandler",class{get onOrder(){return this._onOrder.asEvent()}static factory(g,P,I,L,_,U,K){let $=new this(g,L,K,_.tileOccupation);var Z=new Y(U,I,L);return $.selectAction=Z,L&&!L.isObserver?($.defaultActions=[...V.orderPriorities.map(g=>new W.OrderFactory(U,_).create(g,P)),Z,new G.MoveOrder(U,_,P)],$.selectToggleAction=new Y(U,I,L,!0),$.forceMoveAction=new G.MoveOrder(U,_,P,!0),$.forceAttackAction=new z.AttackOrder(U,{forceAttack:!0}),$.attackMoveAction=new q.AttackMoveOrder(U,_),$.guardAreaAction=new Q.GuardAreaOrder(U,!0),$.specialActions=[$.selectToggleAction,$.forceMoveAction,$.forceAttackAction,$.attackMoveAction,$.guardAreaAction]):($.defaultActions=[Z],$.specialActions=[]),$}constructor(g,P,I,L){this.renderableManager=g,this.currentPlayer=P,this.audioVisualRules=I,this.tileOccupation=L,this._onOrder=new U.EventDispatcher}createOrderTarget(g){return new K.Target(g.gameObject,g.tile,this.tileOccupation)}getDefaultAction(g,P,I,L,_,U,G,V,W){var z=I.gameObject;let K=this.selectAction;if(K.setForce(U).setTypeSelect(!1),!g||g.owner!==this.currentPlayer||g.rules.spawned)return!W&&_!==Z.NoSelect&&K.isValidTarget(z)?K:void 0;if(_!==Z.NoSelect&&!W&&V?.shiftKey&&!V?.ctrlKey&&this.selectToggleAction?.isValidTarget(z))return this.selectToggleAction;if(_===Z.SelectOnly)return!W&&K.setTypeSelect(G).isValidTarget(z)?K:void 0;var q,$=P.every(g=>g.warpedOutTrait.isActive());if(V?.ctrlKey&&!$)if(V.shiftKey){if(this.attackMoveAction?.set(g,L).isValid())return this.attackMoveAction}else if(V.altKey){if(this.guardAreaAction?.set(g,L).isValid())return this.guardAreaAction}else if(this.forceAttackAction?.set(g,L).isValid())return this.forceAttackAction;if(V?.altKey&&!$&&this.forceMoveAction?.set(g,L).isValid())return this.forceMoveAction;for(q of this.defaultActions.values())if(q instanceof Y){if(_!==Z.NoSelect&&!W&&q.setForce(U).setTypeSelect(!1).isValidTarget(z))return q}else if(!$&&(!W||q.minimapAllowed)&&!(q.singleSelectionRequired&&1<P.length)&&q.set(g,L).isValid())return q;return W&&!$&&this.forceMoveAction?.set(g,L).isValid()?this.forceMoveAction:void 0}updateMostSignificantAction(g,P,I,L,U,G,V,W){if(!g.length)return this.getDefaultAction(void 0,g,P,I,L,U,G,V,W);let z=g.map(_=>{var z=this.getDefaultAction(_,g,P,I,L,U,G,V,W);if(z)return{unit:_,action:z}}).filter(_.isNotNullOrUndefined),K=[...this.specialActions.values()];return z.length?z.reduce((g,P)=>!g||K.includes(P.action)||this.defaultActions.indexOf(P.action)<this.defaultActions.indexOf(g)||!(g instanceof Y)&&g.sourceObject.rules.leadershipRating<P.unit.rules.leadershipRating&&this.defaultActions.indexOf(P.action)===this.defaultActions.indexOf(g)?P.action instanceof Y?P.action:P.action.set(P.unit,I):g,void 0):void 0}getPointerType(g){if(this.mostSignificantAction instanceof Y)return this.mostSignificantAction.getPointerType();if(!this.currentSelected||!this.mostSignificantAction)return g?I.PointerType.Mini:I.PointerType.Default;if(!this.mostSignificantAction.isAllowed()){var P,L=this.mostSignificantAction.sourceObject;for(P of this.currentSelected)if(this.mostSignificantAction.set(P,this.currentTarget),this.mostSignificantAction.isValid()&&this.mostSignificantAction.isAllowed())return this.mostSignificantAction.getPointerType(g,this.currentSelected);this.mostSignificantAction.set(L,this.currentTarget)}return this.mostSignificantAction.getPointerType(g,this.currentSelected)}update(g,P,I,L,_=!1){var U=this.currentTarget=this.createOrderTarget(g);this.currentSelected=P,this.mostSignificantAction=this.updateMostSignificantAction(P,g,U,Z.All,I,!1,L,_)}execute(g,P,I,_,U,V,W=!1){let z=this.currentTarget=this.createOrderTarget(g);if(this.currentSelected=P,this.mostSignificantAction=this.updateMostSignificantAction(P,g,z,I,_,U,V,W),this.mostSignificantAction){var K=this.mostSignificantAction.isAllowed();return K&&(this.mostSignificantAction instanceof G.MoveOrder||this.mostSignificantAction instanceof q.AttackMoveOrder&&!z.obj?.isTechno()||this.mostSignificantAction instanceof Q.GuardAreaOrder?this.renderableManager.createTransientAnim(this.audioVisualRules.moveFlash,g=>{g.setPosition(L.Coords.tile3dToWorld(z.tile.rx+.5,z.tile.ry+.5,z.tile.z+(z.getBridge()?.tileElevation??0)))}):this.mostSignificantAction instanceof Y||P.includes(g.gameObject)||g.entity?.highlight?.()),this.mostSignificantAction instanceof Y?this.mostSignificantAction.execute(g.gameObject):this._onOrder.dispatch(this,{orderType:this.mostSignificantAction.orderType,terminal:this.mostSignificantAction.terminal,feedbackType:K?this.mostSignificantAction.feedbackType:$.OrderFeedbackType.None,feedbackUnit:K?this.mostSignificantAction.sourceObject:void 0,target:z}),!0}return!1}})}}}),System.register("gui/screen/game/worldInteraction/InteractionMode",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/CenterBaseCmd",["engine/type/ObjectType","game/rules/TechnoRules"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("CenterBaseCmd",class{constructor(g,P,I,L){this.player=g,this.rules=P,this.mapPanningHelper=I,this.cameraPan=L}execute(){let g;var P=this.player.production.getPrimaryFactory(L.FactoryType.BuildingType);P?g=P.centerTile:(P=this.player.getOwnedObjectsByType(I.ObjectType.Vehicle).find(g=>this.rules.general.baseUnit.includes(g.name)))&&(g=P.tile),g&&this.cameraPan.setPan(this.mapPanningHelper.computeCameraPanFromTile(g.rx,g.ry))}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/CenterGroupCmd",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("CenterGroupCmd",class{constructor(g,P,I,L){this.groupNum=g,this.unitSelectionHandler=P,this.mapPanningHelper=I,this.cameraPan=L}execute(){this.unitSelectionHandler.selectGroup(this.groupNum);var g=this.unitSelectionHandler.getGroupUnits(this.groupNum);g.length&&(g=this.computePanTile(g),g=this.mapPanningHelper.computeCameraPanFromTile(g.rx,g.ry),this.cameraPan.setPan(g))}computePanTile(g){return{rx:Math.floor(g.reduce((g,P)=>g+P.tile.rx,0)/g.length),ry:Math.floor(g.reduce((g,P)=>g+P.tile.ry,0)/g.length)}}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/CenterViewCmd",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("CenterViewCmd",class{constructor(g,P,I){this.unitSelectionHandler=g,this.mapPanningHelper=P,this.cameraPan=I}execute(){var g=this.unitSelectionHandler.getSelectedUnits();g.length&&(g=this.computePanTile(g),g=this.mapPanningHelper.computeCameraPanFromTile(g.rx,g.ry),this.cameraPan.setPan(g))}computePanTile(g){return{rx:Math.floor(g.reduce((g,P)=>g+P.tile.rx,0)/g.length),ry:Math.floor(g.reduce((g,P)=>g+P.tile.ry,0)/g.length)}}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/FollowUnitCmd",["util/disposable/CompositeDisposable"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("FollowUnitCmd",class{constructor(g,P,L,_,U,G){this.unitSelectionHandler=g,this.renderableManager=P,this.worldInteraction=L,this.mapPanningHelper=_,this.cameraPan=U,this.worldScene=G,this.disposables=new I.CompositeDisposable,this.handleUserSelectionChange=()=>{this.updateUnit(void 0)},this.handleFrame=()=>{let g=this.unitSelectionHandler.getSelectedUnits();this.unit&&!g.includes(this.unit)&&this.updateUnit(void 0),this.unit&&this.updatePan(this.unit)}}init(){this.unitSelectionHandler.onUserSelectionUpdate.subscribe(this.handleUserSelectionChange),this.disposables.add(()=>this.unitSelectionHandler.onUserSelectionUpdate.unsubscribe(this.handleUserSelectionChange)),this.worldScene.onBeforeCameraUpdate.subscribe(this.handleFrame),this.disposables.add(()=>this.worldScene.onBeforeCameraUpdate.unsubscribe(this.handleFrame))}execute(){let g=this.unitSelectionHandler.getSelectedUnits();this.unit&&!g.includes(this.unit)&&this.updateUnit(void 0),this.updateUnit(this.unit?void 0:g[0]),this.unit&&this.updatePan(this.unit)}updateUnit(g){(this.unit=g)?this.worldInteraction.pausePanning():this.worldInteraction.unpausePanning()}updatePan(g){let P=this.renderableManager.getRenderableByGameObject(g);var I;P&&(I=this.mapPanningHelper.computeCameraPanFromWorld(P.getPosition()),this.cameraPan.setPan(I))}dispose(){this.disposables.dispose()}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/GoToCameraLocationCmd",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("GoToCameraLocationCmd",class{constructor(g,P,I,L){this.cameraPan=g,this.cameraLocations=P,this.idx=I,this.defaultLocation=L}execute(){var g=this.cameraLocations.get(this.idx)||this.defaultLocation;g&&this.cameraPan.setPan(g)}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/LastRadarEventCmd",["game/event/EventType","game/type/SuperWeaponType"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("LastRadarEventCmd",class{constructor(g,P,I){this.player=g,this.mapPanningHelper=P,this.cameraPan=I,this.eventHistory=[],this.eventPointer=-1}execute(){var g,P;this.eventHistory.length&&(this.lastRun?(P=(g=Date.now())-this.lastRun,this.lastRun=g,400<P?this.eventPointer=this.eventHistory.length-1:(this.eventPointer--,this.eventPointer<0&&(this.eventPointer=this.eventHistory.length-1))):this.lastRun=Date.now(),(P=this.eventHistory[this.eventPointer])&&(P=this.mapPanningHelper.computeCameraPanFromTile(P.rx,P.ry),this.cameraPan.setPan(P)))}recordEvent(g){this.eventHistory.push(g),this.eventHistory=this.eventHistory.slice(-8),this.eventPointer=this.eventHistory.length-1}handleGameEvent(g){switch(g.type){case I.EventType.RadarEvent:g.target===this.player&&this.recordEvent(g.tile);break;case I.EventType.BridgeRepair:g.source===this.player&&this.recordEvent(g.tile);break;case I.EventType.ObjectDestroy:{let P=g.target;P.isUnit()&&P.owner===this.player&&this.recordEvent(P.tile),P.isProjectile()&&P.isNuke&&this.recordEvent(P.tile)}break;case I.EventType.FactoryProduceUnit:var P=g.target;P.owner===this.player&&this.recordEvent(P.tile);break;case I.EventType.SuperWeaponActivate:P=g,[L.SuperWeaponType.IronCurtain,L.SuperWeaponType.ChronoSphere].includes(P.target)&&this.recordEvent(P.atTile2??P.atTile);break;case I.EventType.LightningStormManifest:this.recordEvent(g.target)}}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/SelectGroupCmd",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("SelectGroupCmd",class{constructor(g,P,I,L,_){this.groupNum=g,this.unitSelectionHandler=P,this.targetLines=I,this.mapPanningHelper=L,this.cameraPan=_}execute(){this.unitSelectionHandler.selectGroup(this.groupNum),this.targetLines.forceShow();var g=performance.now();let P=!0;(!this.lastSelectTime||400<g-this.lastSelectTime)&&(P=!1,this.lastSelectTime=g),!P||(g=this.unitSelectionHandler.getSelectedUnits()).length&&(g=this.computePanTile(g),g=this.mapPanningHelper.computeCameraPanFromTile(g.rx,g.ry),this.cameraPan.setPan(g))}computePanTile(g){return{rx:Math.floor(g.reduce((g,P)=>g+P.tile.rx,0)/g.length),ry:Math.floor(g.reduce((g,P)=>g+P.tile.ry,0)/g.length)}}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/SelectNextUnitCmd",["util/disposable/CompositeDisposable"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("SelectNextUnitCmd",class{constructor(g,P,L,_,U){this.unitSelectionHandler=g,this.mapPanningHelper=P,this.cameraPan=L,this.player=_,this.world=U,this.reverse=!1,this.unitList=[],this.disposables=new I.CompositeDisposable;const a=g=>{g.isTechno()&&g.owner===_&&this.unitList.push(g)};this.world.onObjectSpawned.subscribe(a),this.disposables.add(()=>this.world.onObjectSpawned.unsubscribe(a))}getNextUnit(){return this.generator||(this.generator=this.generate()),this.generator.next().value}*generate(){for(;;){let I=this.unitList=this.player.getOwnedObjects().filter(g=>g.isUnit()).sort((g,P)=>g.tile.dx+1e3*g.tile.dy-(P.tile.dx+1e3*P.tile.dy)+.1*(P.position.subCell-g.position.subCell));if(I.length){let L=this.reverse?I.length:-1,_=this.unitSelectionHandler.getSelectedUnits();var g;for(1<_.length&&_[0].isUnit()&&-1!==(g=I.indexOf(_[0]))&&(L=g);this.reverse?0<=--L:++L<I.length;){if(this.unitSelectionHandler.getHash()!==this.lastSelectionHash){this.lastSelectionHash=this.unitSelectionHandler.getHash();break}var P=I[L];P.owner===this.player&&P.isSpawned&&(yield P)}}else yield}}setReverse(g){this.reverse=g}execute(){var g=this.getNextUnit();g&&(this.unitSelectionHandler.selectSingleUnit(g),this.lastSelectionHash=this.unitSelectionHandler.getHash(),g=g.tile,g=this.mapPanningHelper.computeCameraPanFromTile(g.rx,g.ry),this.cameraPan.setPan(g))}dispose(){this.disposables.dispose()}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/SelectPlayerCmd",["gui/screen/game/worldInteraction/keyboard/command/CenterBaseCmd"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("SelectPlayerCmd",class{constructor(g,P,I,L,_){this.playerNum=g,this.player=P,this.mapPanningHelper=I,this.cameraPan=L,this.game=_}execute(){var g=performance.now();let P,L=!0;if((!this.lastSelectTime||400<g-this.lastSelectTime)&&(L=!1,this.lastSelectTime=g),g=this.game.getCombatants(),this.playerNum<g.length&&(P=g[this.playerNum]),P&&(this.player.value===P||L&&!this.player.value))if(L){new I.CenterBaseCmd(P,this.game.rules,this.mapPanningHelper,this.cameraPan).execute()}else P=void 0;this.player.value=P}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/SelectTypeByCmd",["gui/screen/game/worldInteraction/keyboard/KeyCommand","util/disposable/CompositeDisposable"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("SelectByTypeCmd",class{constructor(g){this.unitSelectionHandler=g,this.triggerMode=I.TriggerMode.KeyDownUp,this.disposables=new L.CompositeDisposable,this.handleUserSelectionUpdate=g=>{!g.queryType&&this.keyDownTime&&this.unitSelectionHandler.selectByType()}}init(){this.unitSelectionHandler.onUserSelectionUpdate.subscribe(this.handleUserSelectionUpdate),this.disposables.add(()=>this.unitSelectionHandler.onUserSelectionUpdate.unsubscribe(this.handleUserSelectionUpdate))}execute(g){var P=Date.now();g?(this.keyDownTime&&P-this.keyDownTime<=1e3&&this.unitSelectionHandler.selectByType(),this.keyDownTime=void 0):this.keyDownTime??(this.keyDownTime=P)}dispose(){this.disposables.dispose()}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/command/SetCameraLocationCmd",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("SetCameraLocationCmd",class{constructor(g,P,I){this.cameraPan=g,this.cameraLocations=P,this.idx=I}execute(){this.cameraLocations.set(this.idx,this.cameraPan.getPan())}})}}}),System.register("gui/screen/game/worldInteraction/keyboard/KeyBinds",["data/DataStream","data/IniFile","data/vfs/VirtualFile","gui/screen/game/worldInteraction/keyboard/KeyCommandType"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=new Map([[98,40],[100,37],[102,39],[104,38]]),g("KeyBinds",V=class o{constructor(g,P,I){this.configDir=g,this.persistFileName=P,this.defaultIni=I,this.hotKeys=new Map}async load(){this.hotKeys.clear();let g,P=!0;try{this.configDir&&await this.configDir.containsEntry(this.persistFileName)&&(g=new L.IniFile(await this.configDir.openFile(this.persistFileName)),this.loadHotKeys(g),P=!1)}catch(P){console.log(`Failed to load hotkeys from local file "${this.persistFileName}"`,P)}if(P){var I,_;for([I,_]of(g=this.defaultIni,new Map([[U.KeyCommandType.PreviousObject,"M".charCodeAt(0)],[U.KeyCommandType.VeterancyNav,"Y".charCodeAt(0)],[U.KeyCommandType.HealthNav,"U".charCodeAt(0)],[U.KeyCommandType.FreeMoney,582],[U.KeyCommandType.BuildCheat,593],[U.KeyCommandType.ToggleFps,512+"R".charCodeAt(0)],[U.KeyCommandType.ToggleShroud,1024+"S".charCodeAt(0)]])))this.addHotKey(I,_);this.loadHotKeys(g)}this.addHotKey(U.KeyCommandType.Scoreboard,9)}async saveIni(g){await(this.configDir?.writeFile(new _.VirtualFile((new I.DataStream).writeString(g.toString()),this.persistFileName)))}async resetAndReload(){this.configDir&&await this.configDir.containsEntry(this.persistFileName)&&await this.configDir.deleteFile(this.persistFileName),await this.load()}loadHotKeys(g){let P=g.getSection(o.iniSection);if(!P)throw new Error(`Missing [${o.iniSection}] ini section`);let I=Object.keys(U.KeyCommandType);for(var L of P.entries.keys()){var _;I.includes(L)?(_=P.getNumber(L),this.changeHotKey(L,_)):console.warn("Unknown keyboard command "+L)}return this}async save(){let g=new L.IniFile,P=g.getOrCreateSection(o.iniSection);for(var[I,_]of this.hotKeys)P.set(_,""+I);await this.saveIni(g)}addHotKey(g,P){this.hotKeys.set("number"==typeof P?P:this.getHotKeyCode(P),g)}changeHotKey(g,P){var I;for(I of[...this.hotKeys.entries()].filter(([,P])=>P===g).map(([g])=>g))this.hotKeys.delete(I);P&&this.addHotKey(g,P)}getCommandType(g){if(!(255<g.keyCode)){var P=this.getHotKeyCode(g);return this.hotKeys.get(P)}}getHotKeyCode(g){let P=(Number(g.metaKey)<<12)+(Number(g.altKey)<<10)+(Number(g.ctrlKey)<<9)+(Number(g.shiftKey)<<8)+g.keyCode;var I=G.get(g.keyCode);return I&&(P+=2048-g.keyCode+I),P}getHotKey(g){var P,I=[...this.hotKeys.entries()].find(([,P])=>P===g)?.[0];if(void 0!==I){let g=255&I;return 2048&I&&((P=[...G].find(([,P])=>P===g)?.[0])?g=P:console.error(`Expected an numpad arrow key code but got ${g} (${I}) instead`)),{keyCode:g,shiftKey:Boolean(256&I),ctrlKey:Boolean(512&I),altKey:Boolean(1024&I),metaKey:Boolean(4096&I)}}}}),V.iniSection="Hotkey"}}}),System.register("gui/screen/game/worldInteraction/keyboard/KeyboardHandler",["gui/screen/game/worldInteraction/keyboard/KeyCommandType","gui/screen/game/worldInteraction/keyboard/KeyCommand"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("KeyboardHandler",_=class s{constructor(g,P){this.keyBinds=g,this.devMode=P,this.commands=new Map,this.isPaused=!1}registerCommand(g,P){if(this.commands.has(g))throw new Error("Duplicate command "+g);this.commands.set(g,P)}unregisterCommand(g){this.commands.delete(g)}executeCommand(g){let P=this.commands.get(g);P&&!this.isPaused&&("function"==typeof P?P():P.triggerMode!==L.TriggerMode.KeyDownUp?P.execute(P.triggerMode===L.TriggerMode.KeyUp):(P.execute(!1),P.execute(!0)))}handleKeyDown(g){if("Backspace"===g.key&&(g.preventDefault(),g.stopPropagation()),!(g.repeat||["F5","F12"].includes(g.key)&&this.devMode)){let P=this.keyBinds.getCommandType(g);if(void 0===P&&(P=this.getNoModCmdType(g.keyCode)),void 0!==P){g.preventDefault(),g.stopPropagation();let I=this.commands.get(P);I&&!this.isPaused&&("function"==typeof I?I():I.triggerMode!==L.TriggerMode.KeyUp&&I.execute(!1))}}}handleKeyUp(g){if("Alt"===g.key)g.preventDefault(),g.stopPropagation();else if(!this.isPaused){let P=this.keyBinds.getCommandType(g);if(void 0===P&&(P=this.getNoModCmdType(g.keyCode)),void 0!==P){let g=this.commands.get(P);!g||"function"==typeof g||g.triggerMode!==L.TriggerMode.KeyUp&&g.triggerMode!==L.TriggerMode.KeyDownUp||g.execute(!0)}}}getNoModCmdType(g){var P=this.keyBinds.getCommandType({keyCode:g,altKey:!1,ctrlKey:!1,shiftKey:!1,metaKey:!1});if(P){var I=this.commands.get(P);if(I&&"function"!=typeof I&&s.anyModifierCommands.includes(P))return P}}pause(){this.isPaused=!0}unpause(){this.isPaused=!1}dispose(){this.commands.clear()}}),_.anyModifierCommands=[I.KeyCommandType.PlanningMode]}}}),System.register("gui/screen/game/worldInteraction/keyboard/KeyCommand",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("TriggerMode",I={}))[P.KeyDown=0]="KeyDown",P[P.KeyUp=1]="KeyUp",P[P.KeyDownUp=2]="KeyDownUp"}}}),System.register("gui/screen/game/worldInteraction/keyboard/KeyCommandType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("KeyCommandType",I={})).CenterView="CenterView",P.Options="Options",P.CenterOnRadarEvent="CenterOnRadarEvent",P.RightSidebarUp="RightSidebarUp",P.RightSidebarDown="RightSidebarDown",P.LeftSidebarDown="LeftSidebarDown",P.LeftSidebarUp="LeftSidebarUp",P.Delete="Delete",P.TeamSelect_10="TeamSelect_10",P.TeamSelect_1="TeamSelect_1",P.TeamSelect_2="TeamSelect_2",P.TeamSelect_3="TeamSelect_3",P.TeamSelect_4="TeamSelect_4",P.TeamSelect_5="TeamSelect_5",P.TeamSelect_6="TeamSelect_6",P.TeamSelect_7="TeamSelect_7",P.TeamSelect_8="TeamSelect_8",P.TeamSelect_9="TeamSelect_9",P.ToggleAlliance="ToggleAlliance",P.PlaceBeacon="PlaceBeacon",P.AllToCheer="AllToCheer",P.DeployObject="DeployObject",P.InfantryTab="InfantryTab",P.Follow="Follow",P.GuardObject="GuardObject",P.CenterBase="CenterBase",P.ToggleRepair="ToggleRepair",P.ToggleSell="ToggleSell",P.PreviousObject="PreviousObject",P.NextObject="NextObject",P.CombatantSelect="CombatantSelect",P.StructureTab="StructureTab",P.UnitTab="UnitTab",P.StopObject="StopObject",P.TypeSelect="TypeSelect",P.PageUser="PageUser",P.DefenseTab="DefenseTab",P.ScatterObject="ScatterObject",P.HealthNav="HealthNav",P.VeterancyNav="VeterancyNav",P.PlanningMode="PlanningMode",P.View1="View1",P.View2="View2",P.View3="View3",P.View4="View4",P.Taunt_1="Taunt_1",P.Taunt_2="Taunt_2",P.Taunt_3="Taunt_3",P.Taunt_4="Taunt_4",P.Taunt_5="Taunt_5",P.Taunt_6="Taunt_6",P.Taunt_7="Taunt_7",P.Taunt_8="Taunt_8",P.RaiseCell="RaiseCell",P.LowerCell="LowerCell",P.DeleteObject="DeleteObject",P.TeamAddSelect_10="TeamAddSelect_10",P.TeamAddSelect_1="TeamAddSelect_1",P.TeamAddSelect_2="TeamAddSelect_2",P.TeamAddSelect_3="TeamAddSelect_3",P.TeamAddSelect_4="TeamAddSelect_4",P.TeamAddSelect_5="TeamAddSelect_5",P.TeamAddSelect_6="TeamAddSelect_6",P.TeamAddSelect_7="TeamAddSelect_7",P.TeamAddSelect_8="TeamAddSelect_8",P.TeamAddSelect_9="TeamAddSelect_9",P.IonStorm="IonStorm",P.TeamCreate_10="TeamCreate_10",P.TeamCreate_1="TeamCreate_1",P.TeamCreate_2="TeamCreate_2",P.TeamCreate_3="TeamCreate_3",P.TeamCreate_4="TeamCreate_4",P.TeamCreate_5="TeamCreate_5",P.TeamCreate_6="TeamCreate_6",P.TeamCreate_7="TeamCreate_7",P.TeamCreate_8="TeamCreate_8",P.TeamCreate_9="TeamCreate_9",P.ScreenCapture="ScreenCapture",P.ToggleElite="ToggleElite",P.FreeMoney="FreeMoney",P.IonBlast="IonBlast",P.LightningBolt="LightningBolt",P.ToggleMono="ToggleMono",P.NukeExplosion="NukeExplosion",P.BuildCheat="BuildCheat",P.ToggleShroud="ToggleShroud",P.ToggleThreatPrint="ToggleThreatPrint",P.SpecialWeapons="SpecialWeapons",P.ToggleAttackFriendlies="ToggleAttackFriendlies",P.SetView1="SetView1",P.SetView2="SetView2",P.SetView3="SetView3",P.SetView4="SetView4",P.Explosion="Explosion",P.PrevMonoPage="PrevMonoPage",P.NextMonoPage="NextMonoPage",P.TeamCenter_10="TeamCenter_10",P.TeamCenter_1="TeamCenter_1",P.TeamCenter_2="TeamCenter_2",P.TeamCenter_3="TeamCenter_3",P.TeamCenter_4="TeamCenter_4",P.TeamCenter_5="TeamCenter_5",P.TeamCenter_6="TeamCenter_6",P.TeamCenter_7="TeamCenter_7",P.TeamCenter_8="TeamCenter_8",P.TeamCenter_9="TeamCenter_9",P.ToggleMarbleMadness="ToggleMarbleMadness",P.ForceWin="ForceWin",P.BailOut="BailOut",P.SuperExplosion="SuperExplosion",P.SidebarPageUp="SidebarPageUp",P.SidebarUp="SidebarUp",P.SidebarPageDown="SidebarPageDown",P.SidebarDown="SidebarDown",P.ToggleFps="ToggleFps",P.TogglePersistentTags="TogglePersistentTags",P.Scoreboard="Scoreboard"}}}),System.register("gui/screen/game/worldInteraction/MapHoverHandler",["util/event","game/Coords"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("MapHoverHandler",class{get onHoverChange(){return this._onHoverChange.asEvent()}constructor(g,P,L,_,U){this.entityIntersectHelper=g,this.mapTileIntersectHelper=P,this.map=L,this.shroud=_,this.renderer=U,this._onHoverChange=new I.EventDispatcher,this.isActive=!1,this.needsUpdate=!1,this.onFrame=g=>{this.isActive&&(this.needsUpdate||!this.lastUpdate||g-this.lastUpdate>=1e3/15)&&(this.needsUpdate=!1,this.lastUpdate=g,this.doUpdate())}}getCurrentHover(){if(this.currentHoverTile)return this.currentHoverEntity?.gameObject.isDestroyed||this.currentHoverEntity?.gameObject.isCrashing?{entity:void 0,gameObject:void 0,tile:this.currentHoverTile}:{entity:this.currentHoverEntity,gameObject:this.currentHoverEntity?.gameObject,tile:this.currentHoverTile}}setShroud(g){this.shroud=g}update(g,P=!1){this.lastPointerPos=g,P?this.doUpdate():this.isActive||(this.isActive=!0,this.needsUpdate=!0,this.renderer.onFrame.subscribe(this.onFrame))}doUpdate(){let g=this.currentHoverEntity;var P=this.currentHoverTile,I=this.entityIntersectHelper.getEntityAtScreenPoint(this.lastPointerPos);if(I){this.currentHoverEntity=I.renderable;let g,P=I.renderable.gameObject;var _=P.getFoundation();P.isBuilding()&&(1<_.width||1<_.height)?g=this.mapTileIntersectHelper.getTileAtScreenPoint(this.lastPointerPos):P.isTechno()&&!P.art.isVoxel?g=P.tile:(U=new THREE.Vector2(I.point.x,I.point.z).multiplyScalar(1/L.Coords.LEPTONS_PER_TILE).floor(),g=this.map.tiles.getByMapCoords(U.x,U.y),g||console.warn(`No tile exists at rx,ry="${JSON.stringify(U)}". Falling back to obj location.`)),g=g||P.tile;var U=this.map.tileOccupation.getBridgeOnTile(g);this.currentHoverEntity.gameObject.isOverlay()&&this.currentHoverEntity.gameObject.isBridge()&&!U&&(this.currentHoverEntity=void 0),this.currentHoverTile=g}else this.currentHoverEntity=void 0,U=this.mapTileIntersectHelper.getTileAtScreenPoint(this.lastPointerPos),this.currentHoverTile=U;!(this.shroud&&this.currentHoverTile&&this.shroud.isShrouded(this.currentHoverTile,this.currentHoverEntity?.gameObject.tileElevation))||this.currentHoverEntity?.gameObject.isOverlay()&&this.currentHoverEntity.gameObject.isBridge()||(this.currentHoverEntity=void 0),this.currentHoverEntity===g&&this.currentHoverTile===P||(g?.selectionModel?.setHover(!1),this.currentHoverEntity?.selectionModel?.setHover(!0),this.currentHoverTile&&this._onHoverChange.dispatch(this,{entity:this.currentHoverEntity,gameObject:this.currentHoverEntity?.gameObject,tile:this.currentHoverTile}))}finish(){this.currentHoverEntity?.selectionModel?.setHover(!1),this.currentHoverEntity=void 0,this.currentHoverTile=void 0,this.isActive&&(this.renderer.onFrame.unsubscribe(this.onFrame),this.isActive=!1,this.needsUpdate=!1)}dispose(){this.finish()}})}}}),System.register("gui/screen/game/worldInteraction/MapScrollHandler",["util/geometry","util/math","engine/type/PointerType"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("MapScrollHandler",class{constructor(g,P,U,G,V){this.canvas=g,this.cameraPan=P,this.pointer=U,this.scrollRate=G,this.worldScene=V,this.isActive=!1,this.paused=!1,this.forceScrollCancelRequested=!1,this.onFrame=g=>{if(!this.paused&&this.isActive&&(!this.lastUpdate||g-this.lastUpdate>=1e3/60)){this.lastUpdate=g;var P=this.cameraPan.getPan(),U=this.cameraPan.getPanLimits();let V,W=!1;(this.panDirection?.x||this.panDirection?.y)&&(G=this.scrollRate.value/5*10,V={x:L.clamp(P.x+this.panDirection.x*G,U.x,U.x+U.width),y:L.clamp(P.y+this.panDirection.y*G,U.y,U.y+U.height)},G=!I.pointEquals(V,P),this.pointer.setPointerType(G?_.PointerType.Scroll:_.PointerType.NoScroll,this.pointerFrameNo),G&&(W=!0));var G=this.forceScrollDirection;let z=!1;G&&(V={x:L.clamp(P.x+30*G.x,U.x,U.x+U.width),y:L.clamp(P.y+30*G.y,U.y,U.y+U.height)},I.pointEquals(V,P)||(z=!0)),this.isActive=W||z,V&&this.cameraPan.setPan({x:V.x,y:V.y}),this.isActive||this.worldScene.onBeforeCameraUpdate.unsubscribe(this.onFrame),this.forceScrollCancelRequested&&(this.forceScrollCancelRequested=!1,this.forceScrollDirection=void 0)}}}isScrolling(){return!(!this.panDirection||!this.panDirection.x&&!this.panDirection.y)}requestForceScroll(g){this.forceScrollDirection=g,this.forceScrollCancelRequested=!1,this.isActive||(this.isActive=!0,this.worldScene.onBeforeCameraUpdate.subscribe(this.onFrame))}cancelForceScroll(){this.forceScrollCancelRequested=!0}update(g){var P=this.canvas.height,I=this.canvas.width;let L=g.x<3?-1:g.x>I-1-3?1:0,_=g.y<3?-1:g.y>P-1-3?1:0;L?g.y<Math.min(300,P/3)?_=-1:g.y>Math.max(P-300,2*P/3)&&(_=1):_&&(g.x<Math.min(300,I/3)?L=-1:g.x>Math.max(I-300,2*I/3)&&(L=1)),this.panDirection=new THREE.Vector2(L,_),this.pointerFrameNo=(THREE.Math.radToDeg(this.panDirection.angle())+90)%360/45,this.isActive||(this.isActive=!0,this.worldScene.onBeforeCameraUpdate.subscribe(this.onFrame))}cancel(){this.cancelForceScroll(),this.isActive&&(this.worldScene.onBeforeCameraUpdate.unsubscribe(this.onFrame),this.isActive=!1)}setPaused(g){this.paused=g}dispose(){this.cancel()}})}}}),System.register("gui/screen/game/worldInteraction/MinimapHandler",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("MinimapHandler",class{constructor(g,P,I,L,_){this.minimap=g,this.map=P,this.shroud=I,this.worldScene=L,this.mapPanningHelper=_}setShroud(g){this.shroud=g}panToTile(g){this.worldScene.cameraPan.setPan(this.mapPanningHelper.computeCameraPanFromTile(g.rx,g.ry))}getHover(g){return{entity:void 0,gameObject:this.shroud?.isShrouded(g)?void 0:this.map.getObjectsOnTile(g).sort((g,P)=>Number(g.isTechno())-Number(P.isTechno())).shift(),tile:g}}})}}}),System.register("gui/screen/game/worldInteraction/PendingPlacementHandler",["game/event/EventType","util/disposable/CompositeDisposable","gui/screen/game/worldInteraction/placementMode/PlacementGrid"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("PendingPlacementHandler",class{static factory(g,P,I,L){var _=g.getConstructionWorker(P);return new this(g,_,I,L)}constructor(g,P,I,_){this.game=g,this.constructionWorker=P,this.renderer=I,this.worldScene=_,this.placements=[],this.gridModels=new Map,this.grids=new Map,this.disposables=new L.CompositeDisposable,this.onFrame=()=>{for(var g of this.placements){let I=this.gridModels.get(g);var P;I&&(P=g.rules.name,I.tiles=this.constructionWorker.getPlacementPreview(P,g.tile,{normalizedTile:!0}))}}}pushPlacementInfo(g){this.placements.push(g),this.addGrid(g)}init(){this.renderer.onFrame.subscribe(this.onFrame),this.disposables.add(()=>this.renderer.onFrame.unsubscribe(this.onFrame)),this.disposables.add(this.game.events.subscribe(I.EventType.BuildingPlace,g=>{this.removePendingPlacement(g.target.tile)}),this.game.events.subscribe(I.EventType.BuildingFailedPlace,g=>{this.removePendingPlacement(g.tile)}))}removePendingPlacement(g){var P=this.placements.findIndex(P=>P.tile===g),I=this.placements[P];-1!==P&&(this.placements.splice(P,1),this.removeGrid(I))}addGrid(g){var P={tiles:this.constructionWorker.getPlacementPreview(g.rules.name,g.tile,{normalizedTile:!0}),visible:!0,rangeIndicator:void 0,rangeIndicatorColor:void 0,showBusy:!0},I=new _.PlacementGrid(P,this.worldScene.camera,this.game.map.tiles);this.worldScene.add(I),this.gridModels.set(g,P),this.grids.set(g,I)}removeGrid(g){let P=this.grids.get(g);P&&(this.worldScene.remove(P),P.dispose(),this.gridModels.delete(g))}dispose(){for(var g of this.placements)this.removeGrid(g);this.disposables.dispose()}})}}}),System.register("gui/screen/game/worldInteraction/PlacementMode",["gui/screen/game/worldInteraction/placementMode/PlacementGrid","util/geometry","util/event","engine/type/ObjectType"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("PlacementMode",class{get onBuildingPlaceRequest(){return this._onBuildingPlaceRequest}static factory(g,P,L,_,U){var G=g.getConstructionWorker(P),V={tiles:[],visible:!1,rangeIndicator:void 0,rangeIndicatorColor:void 0};let W=new this(g,P,G,L,U,new I.PlacementGrid(V,_.camera,g.map.tiles),_);return W.placementGridModel=V,W}constructor(g,P,I,L,U,G,V){this.game=g,this.player=P,this.constrWorker=I,this.renderer=L,this.eva=U,this.placementGrid=G,this.worldScene=V,this.defenseMode=!1,this.buildingRanges=new Map,this._onBuildingPlaceRequest=new _.EventDispatcher,this.onFrame=g=>{(this.lastTile!==this.currentTile||!this.lastUpdate||g-this.lastUpdate>=1e3/15)&&(this.lastTile=this.currentTile,this.lastUpdate=g,this.currentBuilding&&this.updateGridModel(this.currentBuilding.name))}}init(){this.worldScene.add(this.placementGrid)}dispose(){this.worldScene.remove(this.placementGrid),this.placementGrid.dispose(),this.endConstrMode()}enter(){this.currentTile=void 0,this.lastTile=void 0,this.lastUpdate=void 0,this.renderer.onFrame.subscribe(this.onFrame)}setBuilding(g){(this.currentBuilding=g).primary||g.hasRadialIndicator?(this.defenseMode=!0,this.prepareBuildingRanges(g)):this.defenseMode=!1}getBuilding(){return this.currentBuilding}hover(g,P){var I;P||(I=g?.tile)!==this.currentTile&&(this.currentTile=I)}updateGridModel(g){var P,I=this.currentTile;I?(P=this.constrWorker.getPlacementPreview(g,I),this.placementGridModel.tiles=P,this.placementGridModel.visible=!0,this.defenseMode?(this.showBuildingRangeOverlays(I,g),this.placementGridModel.rangeIndicator=this.getBuildingRangeCircle(I,g),this.placementGridModel.rangeIndicatorColor=this.player.color.asHex()):this.placementGridModel.rangeIndicator=void 0):this.placementGridModel.visible=!1}execute(g,P){if(!this.currentBuilding||P)return!1;var I=g?.tile;if(!I)return!1;if(this.player.production.isAvailableForProduction(this.currentBuilding)){if(!this.constrWorker.canPlaceAt(this.currentBuilding.name,I))return this.eva.play("EVA_CannotDeployHere"),!1;this._onBuildingPlaceRequest.dispatch(this,{rules:this.currentBuilding,tile:this.constrWorker.normalizePlacementTile(this.currentBuilding.name,I)}),this.endConstrMode()}else this.endConstrMode()}cancel(){this.endConstrMode()}endConstrMode(){this.defenseMode=!1,this.placementGridModel.visible=!1,this.hideBuildingRangeOverlays(),this.buildingRanges.clear(),this.currentBuilding=void 0,this.renderer.onFrame.unsubscribe(this.onFrame)}hideBuildingRangeOverlays(){this.buildingRanges.forEach((g,P)=>{P.showWeaponRange=!1})}showBuildingRangeOverlays(g,P){let I=this.getBuildingRangeCircle(g,P);this.buildingRanges.forEach((g,P)=>{P.showWeaponRange=L.circleIntersect(I,g)})}getBuildingRangeCircle(g,P){var I=this.game.art.getObject(P,U.ObjectType.Building).foundation;return{center:{x:g.rx+(I.width%2!=0?.5:0),y:g.ry+(I.height%2!=0?.5:0)},radius:this.currentRangeCircleRadius}}prepareBuildingRanges(g){let P=[...this.player.buildings].filter(P=>P.name===g.name);var I;g.psychicDetectionRadius?this.currentRangeCircleRadius=g.psychicDetectionRadius:g.gapGenerator?this.currentRangeCircleRadius=g.gapRadiusInCells:(I=g.primary)&&(this.currentRangeCircleRadius=this.game.rules.getWeapon(I).range),this.buildingRanges.clear(),P.forEach(g=>{var P=g.tile,I=this.game.art.getObject(g.name,U.ObjectType.Building).foundation;P={x:P.rx+I.width/2,y:P.ry+I.height/2};(I=g.psychicDetectorTrait?.radiusTiles??g.gapGeneratorTrait?.radiusTiles??g.primaryWeapon?.range)&&this.buildingRanges.set(g,{center:P,radius:I})})}})}}}),System.register("gui/screen/game/worldInteraction/placementMode/PlacementGrid",["game/Coords","game/theater/rampHeights","engine/gfx/OverlayUtils","util/geometry","engine/gfx/SpriteUtils","engine/IsoCoords"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){W=g}],execute:function(){V=THREE.Math.ceilPowerOfTwo,g("PlacementGrid",class{constructor(g,P,I){this.viewModel=g,this.camera=P,this.mapTiles=I,this.tileOverlays=new Map}get3DObject(){return this.target}create3DObject(){let g=new THREE.Object3D;g.name="placement_grid",this.target=g,this.createTileOverlays()}update(){if(this.refreshRangeCircle(),this.viewModel.visible||!this.tilesObject){let I=new THREE.Object3D;for(var g of(I.visible=!0,this.viewModel.tiles)){var P=this.mapTiles.getByMapCoords(g.rx,g.ry);if(!P)throw new Error(`Map tile not found for coords (${g.rx}, ${g.ry})`);let L=this.tileOverlays.get(P.rampType);if(!L)throw new Error("Missing overlay mesh for rampType "+P.rampType);let _=L.clone();_.material=_.material.clone(),g=g.buildable?this.viewModel.showBusy?16776960:65280:16711680,_.material.color.set(g),P=this.getTilePosition(P),_.position.copy(P),I.add(_)}let L=this.get3DObject();L.remove(this.tilesObject),this.tilesObject=I,L.add(I)}else this.tilesObject.visible=!1}refreshRangeCircle(){if(this.viewModel.visible||!this.rangeObject){this.rangeObject&&(this.rangeObject.visible=!0);let V=this.get3DObject();var g=this.viewModel.rangeIndicator;if(g){if(this.lastRangeCircle&&g.radius===this.lastRangeCircle.radius||(G=_.OverlayUtils.createGroundCircle(g.radius*I.Coords.getWorldTileSize(),this.viewModel.rangeIndicatorColor),this.rangeObject&&V.remove(this.rangeObject),V.add(G),this.rangeObject=G),!this.lastRangeCircle||!U.pointEquals(g.center,this.lastRangeCircle.center)){var P=Math.floor(g.center.x),L=Math.floor(g.center.y),G=this.mapTiles.getByMapCoords(P,L);if(!G)return void console.warn(`Map tile not found for coords (${P}, ${L})`);let _=this.getTilePosition(G);_.x+=g.center.x%1*I.Coords.getWorldTileSize(),_.z+=g.center.y%1*I.Coords.getWorldTileSize(),this.rangeObject.position.copy(_)}this.lastRangeCircle=g}else this.rangeObject&&(V.remove(this.rangeObject),this.rangeObject=void 0,this.lastRangeCircle=void 0)}else this.rangeObject.visible=!1}createTileOverlays(){for(let g=0;g<L.rampHeights.length;++g)this.tileOverlays.set(g,this.createTileOverlay(g))}createTileOverlay(g){var P=W.IsoCoords.getScreenTileSize();let L=G.SpriteUtils.createSpriteGeometry({texture:this.getTileOverlayTexture(),textureArea:{x:0,y:2*g*P.height,width:P.width,height:2*P.height},align:{x:0,y:-1},camera:this.camera,scale:I.Coords.ISO_WORLD_SCALE});L.applyMatrix((new THREE.Matrix4).makeTranslation(0,I.Coords.tileHeightToWorld(1),0)),P=new THREE.MeshBasicMaterial({map:this.getTileOverlayTexture(),alphaTest:.5,transparent:!0,opacity:.7,flatShading:!0,depthTest:!1,depthWrite:!1});let _=new THREE.Mesh(L,P);return _.renderOrder=1e6,_.frustumCulled=!1,_}getTilePosition(g){return I.Coords.tile3dToWorld(g.rx,g.ry,g.z)}getTileOverlayTexture(){let g=this.textureCache;if(!g){var P=W.IsoCoords.getScreenTileSize();let q=document.createElement("canvas"),$=q.getContext("2d");if(!$)throw new Error("Couldn't acquire canvas 2d context");q.width=V(P.width),q.height=V(2*P.height*L.rampHeights.length);let Q=W.IsoCoords.tileToScreen(0,0);Q.x+=-P.width/2;var _=I.Coords.ISO_TILE_SIZE/2;for(let g=0;g<L.rampHeights.length;++g){var U=L.rampHeights[g],G=[[0,1],[0,0],[1,0],[1,1]];$.beginPath();var z=W.IsoCoords.tileToScreen(G[0][0],G[0][1]);$.moveTo(-Q.x+z.x,-Q.y+z.y+(1-U[0])*_+2*g*P.height);for(let I=1;I<G.length;++I){var K=W.IsoCoords.tileToScreen(G[I][0],G[I][1]);$.lineTo(-Q.x+K.x,-Q.y+K.y+(1-U[I])*_+2*g*P.height)}$.closePath(),$.lineWidth=1,$.fillStyle="#"+16777215..toString(16),$.fill(),$.strokeStyle="#"+(0).toString(16),$.stroke()}g=new THREE.Texture(q),g.needsUpdate=!0,this.textureCache=g}return g}dispose(){this.tileOverlays.forEach(g=>{g.material.dispose(),g.geometry.dispose()})}})}}}),System.register("gui/screen/game/worldInteraction/placementMode/PlacementGridModel",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("gui/screen/game/worldInteraction/PlanningMode",["game/order/OrderType","engine/sound/SoundKey","engine/sound/ChannelType","engine/type/ObjectType","util/typeGuard","engine/renderable/entity/WaypointLines","game/action/OrderUnitsAction"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g}],execute:function(){g("PlanningMode",class{constructor(g,P,I,L,_,U,G,V,W,z){this.player=g,this.messageList=P,this.sound=I,this.strings=L,this.worldScene=_,this.unitSelection=U,this.unitSelectionHandler=G,this.renderer=V,this.targetLines=W,this.maxWaypointPathLength=z,this.active=!1,this.paths=[],this.selectedPaths=[],this.selectedUnits=new Set,this.onFrame=g=>{(!this.lastUpdate||g-this.lastUpdate>1e3/15)&&(this.lastUpdate=g,this.updatePaths())}}isActive(){return this.active}enter(){var g;this.active||(this.active=!0,this.targetLines.get3DObject()&&(this.targetLines.get3DObject().visible=!1),this.renderer.onFrame.subscribe(this.onFrame),g=new Set([...this.player.getOwnedObjectsByType(U.ObjectType.Infantry),...this.player.getOwnedObjectsByType(U.ObjectType.Vehicle)].map(g=>g.unitOrderTrait.waypointPath).filter(G.isNotNullOrUndefined)),this.paths=[...g].map(g=>{let P={original:g,units:new Set(g.units),waypoints:[]};return g.waypoints.forEach(g=>{var I={orderType:g.orderType,target:g.target,next:void 0,draft:!1,terminal:g.terminal,original:g};P.waypoints.length&&(P.waypoints[P.waypoints.length-1].next=I),P.waypoints.push(I)}),P}),g=this.waypointLines=new V.WaypointLines(this.unitSelection,this.player,this.selectedPaths,this.paths,this.worldScene.camera),this.worldScene.add(g))}pushOrder(g,P,U){if(g!==I.OrderType.Deploy)if(1<this.selectedPaths.length)this.handleInvalidCommand(this.strings.get("MSG:PlanningModeHeteroSel"));else if(this.selectedUnits.size>W.ORDER_UNIT_LIMIT)this.handleInvalidCommand(this.strings.get("MSG:PlannerMaximum"));else{for(var G of this.selectedUnits){if(G.isBuilding())return void this.handleInvalidCommand(this.strings.get("MSG:PlanningModeNoBuildings"));if(G.isAircraft())return void this.handleInvalidCommand(this.strings.get("MSG:PlanningModeNoAircraft"))}let I=this.selectedPaths[0];var V;!I&&this.selectedUnits.size&&(I={original:void 0,units:new Set(this.selectedUnits),waypoints:[]},this.paths.push(I),this.selectedPaths.push(I)),I&&(I.waypoints.length!==this.maxWaypointPathLength?I.waypoints.find(g=>g.target.equals(P))?this.handleInvalidCommand(this.strings.get("MSG:PlanningModeInvalidNodeX")):I.waypoints.length&&I.waypoints.slice(I.waypoints[0].draft?0:1).find(g=>g.terminal)?this.handleInvalidCommand(this.strings.get("MSG:PostTerminatingCommand")):(V={orderType:g,target:P,terminal:U,next:void 0,draft:!0,original:void 0},I.waypoints.length&&(I.waypoints[I.waypoints.length-1].next=V),I.waypoints.push(V),U?(this.handleInvalidCommand(this.strings.get("MSG:PostTerminatingCommand")),this.unitSelectionHandler.deselectAll()):this.sound.play(L.SoundKey.AddPlanningModeCommandSound,_.ChannelType.Ui)):this.handleInvalidCommand(this.strings.get("MSG:NodeMaximum")))}else this.handleInvalidCommand(this.strings.get("MSG:PlanningModeNoDeploy"))}exit(){let g=this.paths;for(var P of(this.active&&(this.targetLines.get3DObject()&&(this.targetLines.get3DObject().visible=!0),this.renderer.onFrame.unsubscribe(this.onFrame),this.active=!1,this.paths=[],this.selectedPaths=[],this.selectedUnits.clear(),this.waypointLines&&(this.worldScene.remove(this.waypointLines),this.waypointLines.dispose(),this.waypointLines=void 0)),g))P.waypoints=P.waypoints.filter(g=>g.draft);return g.filter(g=>g.waypoints.length)}updatePaths(){for(let P of this.paths){var g;P.original&&(P.original.units.length===P.units.size||P.waypoints.find(g=>g.draft)||(P.units=new Set(P.original.units)),0===P.original.units.length?P.waypoints=P.waypoints.filter(g=>g.draft):P.waypoints=P.waypoints.filter(g=>g.draft||P.original.waypoints.includes(g.original)),P.waypoints.length||(this.paths.splice(this.paths.indexOf(P),1),-1!==(g=this.selectedPaths.indexOf(P))&&this.selectedPaths.splice(g,1)))}}updateSelection(g){this.updatePaths();let P=[...g],I=new Set;for(var L of g)for(var _ of this.paths)_.units.has(L)&&(I.add(_),P.push(..._.units));this.selectedPaths.length=0,this.selectedPaths.push(...I);var U=new Set(P);if((this.selectedUnits=U).size!==g.length)return[...this.selectedUnits]}handleInvalidCommand(g){this.sound.play(L.SoundKey.ScoldSound,_.ChannelType.Ui),this.messageList.addUiFeedbackMessage(g)}dispose(){this.exit()}})}}}),System.register("gui/screen/game/worldInteraction/RepairMode",["engine/type/PointerType","util/event"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("RepairMode",class{get onExecute(){return this._onExecute.asEvent()}static factory(g,P,I,L,_){return new this(g,P,I,L,_)}constructor(g,P,_,U,G){this.game=g,this.player=P,this.sidebarModel=_,this.pointer=U,this.renderer=G,this._onExecute=new L.EventDispatcher,this.onFrame=g=>{var P,L;(this.lastTile!==this.currentTile||!this.lastUpdate||g-this.lastUpdate>=1e3/15)&&(this.lastTile=this.currentTile,this.lastUpdate=g,L=!(!(P=this.currentTile)||!this.findRepairableBuilding(P)),this.pointer.setPointerType(P?L?I.PointerType.SideRepair:I.PointerType.NoRepair:I.PointerType.Default))}}enter(){this.sidebarModel.repairMode=!0,this.currentTile=void 0,this.lastTile=void 0,this.lastUpdate=void 0,this.renderer.onFrame.subscribe(this.onFrame)}hover(g,P){P||(this.currentTile=g?.tile)}findRepairableBuilding(g){return this.game.map.getObjectsOnTile(g).find(g=>g.isBuilding()&&g.owner===this.player&&g.healthTrait.health<100&&g.rules.repairable&&g.rules.clickRepairable)}execute(g,P){if(P)return!1;var I=g?.tile;return!!I&&((I=this.findRepairableBuilding(I))&&this._onExecute.dispatch(this,I),!1)}cancel(){this.end()}end(){this.sidebarModel.repairMode=!1,this.renderer.onFrame.unsubscribe(this.onFrame)}dispose(){this.end()}})}}}),System.register("gui/screen/game/worldInteraction/SellMode",["engine/type/PointerType","util/event","game/gameobject/Building","game/gameobject/trait/DockableTrait"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("SellMode",class{get onExecute(){return this._onExecute.asEvent()}static factory(g,P,I,L,_){return new this(g,P,I,L,_)}constructor(g,P,_,U,G){this.game=g,this.player=P,this.sidebarModel=_,this.pointer=U,this.renderer=G,this._onExecute=new L.EventDispatcher,this.onFrame=g=>{if(this.lastHover?.tile!==this.currentHover?.tile||this.lastHover?.gameObject!==this.currentHover?.gameObject||!this.lastUpdate||g-this.lastUpdate>=1e3/15){this.lastHover=this.currentHover,this.lastUpdate=g;let P=I.PointerType.Default;if(this.currentHover?.tile){let g=this.currentHover.gameObject;P=g&&this.isRefundableObject(g)?g.isBuilding()?I.PointerType.Sell:I.PointerType.SellMini:I.PointerType.NoSell}this.pointer.setPointerType(P)}}}enter(){this.sidebarModel.sellMode=!0,this.currentHover=void 0,this.lastHover=void 0,this.lastUpdate=void 0,this.renderer.onFrame.subscribe(this.onFrame)}hover(g,P){P||(this.currentHover=g)}isRefundableObject(g){return!!(g.isTechno()&&g.owner===this.player&&!g.rules.unsellable&&0<this.game.sellTrait.computeRefundValue(g)&&(g.isBuilding()?g.buildStatus===_.BuildStatus.Ready&&!g.warpedOutTrait.isActive():g.traits.find(U.DockableTrait)?.dock?.rules.unitSell))}execute(g,P){if(P)return!1;var I=g?.gameObject;return I&&this.isRefundableObject(I)&&this._onExecute.dispatch(this,I),!1}cancel(){this.end()}end(){this.sidebarModel.sellMode=!1,this.renderer.onFrame.unsubscribe(this.onFrame)}dispose(){this.end()}})}}}),System.register("gui/screen/game/worldInteraction/SpecialActionMode",["engine/type/PointerType","util/event","game/type/SuperWeaponType"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=(new Map).set(_.SuperWeaponType.MultiMissile,I.PointerType.Nuke).set(_.SuperWeaponType.LightningStorm,I.PointerType.Storm).set(_.SuperWeaponType.IronCurtain,I.PointerType.Iron).set(_.SuperWeaponType.ChronoSphere,I.PointerType.Chrono).set(_.SuperWeaponType.ChronoWarp,I.PointerType.Chrono).set(_.SuperWeaponType.AmerParaDrop,I.PointerType.Para).set(_.SuperWeaponType.ParaDrop,I.PointerType.Para),g("SpecialActionMode",class{get onExecute(){return this._onExecute.asEvent()}get superWeaponType(){return this.superWeaponRules.type}static factory(g,P,I,L,_){return new this(g,P,I,L,_)}constructor(g,P,I,_,U){this.allSuperWeaponRules=g,this.superWeaponRules=P,this.superWeaponFxHandler=I,this.pointer=_,this.eva=U,this._onExecute=new L.EventDispatcher,this.isPostClick=!1,this.pointerSwType=this.superWeaponRules.type}enter(){this.eva.play("EVA_SelectTarget")}hover(g){var P=g?.tile,L=U.get(this.pointerSwType);this.pointer.setPointerType(P&&void 0!==L?L:I.PointerType.Default)}execute(g){var P=g?.tile;if(!P)return!1;if(this.superWeaponRules.type!==_.SuperWeaponType.ChronoSphere||this.isPostClick||this.superWeaponFxHandler.createChronoSphereAnim(P),this.superWeaponRules.preClick&&!this.isPostClick){this.isPostClick=!0,this.preTile=P;var I=[...this.allSuperWeaponRules.values()].find(g=>g.postClick&&g.preDependent===this.superWeaponRules.type)?.type;if(void 0===I)throw new Error('No super weapon section found with PostClick=yes and PreDependent="'+_.SuperWeaponType[this.superWeaponRules.type]);return this.pointerSwType=I,!1}this._onExecute.dispatch(this,this.isPostClick?{tile:this.preTile,tile2:P}:{tile:P,tile2:void 0})}cancel(){this.end()}end(){this.superWeaponRules.type===_.SuperWeaponType.ChronoSphere&&this.isPostClick&&this.superWeaponFxHandler.disposeChronoSphereAnim()}dispose(){this.end()}})}}}),System.register("gui/screen/game/worldInteraction/Tooltip",["gui/UiObject","engine/gfx/SpriteUtils","engine/gfx/CanvasUtils"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class extends I.UiObject{constructor(g,P,I,L){super(new THREE.Object3D),this.text=g,this.color=P,this.pointer=I,this.viewport=L}create3DObject(){if(!this.mesh){let I=this.get3DObject();var g=this.texture=this.createTexture(this.text,this.color),P={width:g.image.width,height:g.image.height};let L=this.mesh=this.createMesh(g,P.width,P.height);P=this.computePosition(this.pointer,this.viewport,P),L.position.x=P.x,L.position.y=P.y,I.add(L),L.updateMatrix()}super.create3DObject()}createMesh(g,P,I){let _=L.SpriteUtils.createRectGeometry(P,I);L.SpriteUtils.addRectUvs(_,{x:0,y:0,width:P,height:I},{width:P,height:I}),_.translate(P/2,I/2,0);var U=new THREE.MeshBasicMaterial({map:g,side:THREE.DoubleSide});let G=new THREE.Mesh(_,U);return G.matrixAutoUpdate=!1,G.frustumCulled=!1,G}createTexture(g,P){let I=document.createElement("canvas");I.width=I.height=0;let L=I.getContext("2d",{willReadFrequently:!0}),U=0;for(var G of g.split("\n"))U+=(G=_.CanvasUtils.drawText(L,G,0,U,{color:P,fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:12,fontWeight:"500",paddingTop:5,paddingBottom:5,paddingLeft:2,paddingRight:4,autoEnlargeCanvas:!0})).height;var V=I.width,W=I.height;W=L.getImageData(0,0,V,W);I.width+=1,I.height+=1,L.putImageData(W,1,1),L.globalCompositeOperation="destination-over",L.fillStyle="black",L.fillRect(0,0,I.width,I.height),L.globalCompositeOperation="source-over",L.strokeStyle=P,L.strokeRect(.5,.5,I.width-1,I.height-1);let z=new THREE.Texture(I);return z.minFilter=THREE.NearestFilter,z.magFilter=THREE.NearestFilter,z.needsUpdate=!0,z.flipY=!1,z}computePosition(g,P,I){let L={...g.getPosition()};return L.x+20+I.width>P.x+P.width?L.x-=20+I.width:L.x+=20,L.y+20+I.height>P.x+P.height?L.y-=20+I.height:L.y+=20,L}destroy(){super.destroy(),this.texture?.dispose(),this.mesh&&(this.mesh.material.dispose(),this.mesh.geometry.dispose())}},g("Tooltip",U)}}}),System.register("gui/screen/game/worldInteraction/TooltipHandler",["util/disposable/CompositeDisposable","gui/screen/game/worldInteraction/Tooltip","gui/screen/game/TooltipTextResolver"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){G=g}],execute:function(){_=class{equals(g){return(this.entity??this.uiObject)===(g.entity??g.uiObject)}copy(g){this.entity=g.entity,this.uiObject=g.uiObject}},g("TooltipHandler",U=class h{constructor(g,P,U,G,V,W,z){this.mapHoverHandler=g,this.textColor=P,this.pointer=U,this.uiScene=G,this.renderer=V,this.strings=W,this.debugText=z,this.disposables=new I.CompositeDisposable,this.currentHover=new _,this.lastHover=new _,this.isTouch=!1,this.needsHoverTimeReset=!1,this.paused=!1,this.handleUiMouseMove=g=>{var P=g.intersection?.object;let I=P;for(;void 0===I?.userData.tooltip&&(I=I?.parent,I););this.currentHover.uiObject=I??P,this.hoverStartTime&&(this.needsHoverTimeReset=!0),this.isTouch=g.isTouch},this.handleMouseDown=()=>{this.paused=!0,this.reset()},this.handleMouseUp=g=>{this.paused=!1,this.isTouch=g.isTouch},this.handleMouseWheel=()=>{this.reset()},this.onFrame=g=>{var P;(!this.lastUpdate||g-this.lastUpdate>=1e3/15)&&(this.lastUpdate=g,P=this.mapHoverHandler.getCurrentHover()?.entity,this.currentHover.entity=P,this.paused||(this.currentHover.equals(this.lastHover)?(this.needsHoverTimeReset&&(this.needsHoverTimeReset=!1,this.hoverStartTime=g),P=this.currentHover.entity?800:400,this.hoverStartTime&&g-this.hoverStartTime>P&&(!(P=this.getTooltipText(this.currentHover))||this.tooltip||this.isTouch||(this.tooltip=new L.Tooltip(P,this.textColor,this.pointer,this.uiScene.viewport),this.tooltip.setZIndex(h.ZINDEX),this.uiScene.add(this.tooltip)))):(this.lastHover.copy(this.currentHover),this.hoverStartTime=void 0,this.destroyTooltip(),void 0!==this.getTooltipText(this.currentHover)&&(this.hoverStartTime=g))))}}init(){this.disposables.add(this.pointer.pointerEvents.addEventListener(this.uiScene.get3DObject(),"mousemove",this.handleUiMouseMove)),this.disposables.add(this.pointer.pointerEvents.addEventListener("canvas","mousedown",this.handleMouseDown),this.pointer.pointerEvents.addEventListener("canvas","wheel",this.handleMouseWheel),this.pointer.pointerEvents.addEventListener("canvas","mouseup",this.handleMouseUp)),this.renderer.onFrame.subscribe(this.onFrame),this.disposables.add(()=>this.renderer.onFrame.unsubscribe(this.onFrame))}reset(){this.destroyTooltip(),this.hoverStartTime&&(this.needsHoverTimeReset=!0)}getTooltipText(g){return G.resolveHoverTooltipText(g,this.strings,this.debugText.value)}destroyTooltip(){this.tooltip&&(this.uiScene.remove(this.tooltip),this.tooltip?.destroy(),this.tooltip=void 0)}dispose(){this.disposables.dispose(),this.destroyTooltip()}}),U.ZINDEX=100}}}),System.register("gui/screen/game/worldInteraction/UnitSelectionHandler",["util/geometry","util/math","util/event","util/array","game/gameobject/unit/HealthLevel"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){var P;(P=V||g("QueryType",V={}))[P.None=0]="None",P[P.OnScreen=1]="OnScreen",P[P.OnMap=2]="OnMap",P[P.Veteran=3]="Veteran",P[P.Health=4]="Health",g("UnitSelectionHandler",class{get onUserSelectionChange(){return this._onUserSelectionChange.asEvent()}get onUserSelectionUpdate(){return this._onUserSelectionUpdate.asEvent()}constructor(g,P,I,L,U,G){this.worldScene=g,this.uiScene=P,this.player=I,this.unitSelection=L,this.entityIntersectHelper=U,this.veteranCap=G,this.shouldSelectByTypeOnMap=!1,this.shouldSelectCombatantsOnMap=!1,this._onUserSelectionChange=new _.EventDispatcher,this._onUserSelectionUpdate=new _.EventDispatcher,this._onUserSelectionChange.subscribe(()=>{this.shouldSelectByTypeOnMap=!1,this.shouldSelectCombatantsOnMap=!1}),this._onUserSelectionUpdate.subscribe(()=>{this.selectVeteranState=void 0,this.selectHealthState=void 0})}addToSelection(g){if(g.rules.selectable){let P=this.unitSelection.getSelectedUnits();P.length&&(g.owner===this.player&&!P.find(P=>P.owner!==g.owner)||this.unitSelection.deselectAll()),this.unitSelection.addToSelection(g)}}selectSingleUnit(g){var P,I,L;g.rules.selectable&&((P=this.unitSelection.getSelectedUnits()).length&&this.unitSelection.deselectAll(),this.unitSelection.addToSelection(g),L={selection:I=this.unitSelection.getSelectedUnits()},I.length===P.length&&I[0]===P[0]||this._onUserSelectionChange.dispatch(this,L),this._onUserSelectionUpdate.dispatch(this,L))}toggleSelection(g){var P;g.rules.selectable&&(this.unitSelection.isSelected(g)?this.unitSelection.removeFromSelection([g]):this.addToSelection(g),P={selection:this.unitSelection.getSelectedUnits()},this._onUserSelectionChange.dispatch(this,P),this._onUserSelectionUpdate.dispatch(this,P))}deselectAll(){var g={selection:[]};this.unitSelection.getSelectedUnits().length&&(this.unitSelection.deselectAll(),this._onUserSelectionChange.dispatch(this,g)),this._onUserSelectionUpdate.dispatch(this,g)}selectMultipleUnits(g,{queryType:P,veteranLevel:I,healthLevel:L},_=!0){var G=this.unitSelection.getSelectedUnits();_&&this.unitSelection.deselectAll(),g.forEach(g=>this.addToSelection(g));var V=this.unitSelection.getSelectedUnits(),W={selection:V,queryType:P,veteranLevel:I,healthLevel:L};U.equals(G,V)||this._onUserSelectionChange.dispatch(this,W),this._onUserSelectionUpdate.dispatch(this,W)}getSelectedUnits(){return this.unitSelection.getSelectedUnits()}startBoxSelect(g){this.boxSelectOrigin=g,this.disposeBoxSelect(),this.selectBox=this.createSelectBox(new THREE.Box2),this.uiScene.get3DObject().add(this.selectBox)}updateBoxSelect(g){var P;this.boxSelectOrigin&&(g=this.clampPointerToWorldViewport(g),P=(new THREE.Box2).setFromPoints([new THREE.Vector2(this.boxSelectOrigin.x,this.boxSelectOrigin.y),new THREE.Vector2(g.x,g.y)]),this.selectBox.geometry.dispose(),this.selectBox.geometry=this.createBoxGeometry(P))}finishBoxSelect(g,P){if(!this.boxSelectOrigin)return!1;var L=this.boxSelectOrigin;if(this.boxSelectOrigin=void 0,this.disposeBoxSelect(),I.pointEquals(g,L))return!1;g=this.clampPointerToWorldViewport(g),L=(new THREE.Box2).setFromPoints([new THREE.Vector2(L.x,L.y),new THREE.Vector2(g.x,g.y)]);let _,U=this.entityIntersectHelper.getEntitiesAtScreenBox(L)?.map(g=>g.gameObject).filter(g=>g.isTechno()&&g.rules.selectable&&g.owner===this.player);return!!U.length&&(_=1===U.length?[U[0]]:U.filter(g=>!g.isBuilding()),!!_.length&&(this.selectMultipleUnits(_,{queryType:V.None},P),!0))}cancelBoxSelect(){this.boxSelectOrigin=void 0,this.disposeBoxSelect()}createGroup(g){var P=this.unitSelection.getSelectedUnits();1===P.length&&P[0].owner!==this.player||this.unitSelection.createGroup(g)}getGroupUnits(g){return this.unitSelection.getGroupUnits(g)}addGroupToSelection(g){var P=this.getSelectedUnits();this.unitSelection.addGroupToSelection(g);var I=this.getSelectedUnits(),L={selection:I};U.equals(I,P)||this._onUserSelectionChange.dispatch(this,L),this._onUserSelectionUpdate.dispatch(this,L)}selectGroup(g){var P=this.getSelectedUnits();this.unitSelection.selectGroup(g);var I=this.getSelectedUnits(),L={selection:I};U.equals(I,P)||this._onUserSelectionChange.dispatch(this,L),this._onUserSelectionUpdate.dispatch(this,L)}selectByType(){let g=this.player??this.unitSelection.getSelectedUnits()[0]?.owner;if(g){let I=this.getSelectedUnits().reduce((g,P)=>g.add(P.name),new Set),L=[],_=[];this.shouldSelectByTypeOnMap||(L=this.getOwnedObjectsOnScreen(g),_=L.filter(g=>I.has(g.name)),_.every(g=>this.unitSelection.isSelected(g))&&(this.shouldSelectByTypeOnMap=!0)),this.shouldSelectByTypeOnMap&&(L=g.getOwnedObjects(),_=L.filter(g=>I.has(g.name)));var P=this.shouldSelectByTypeOnMap?V.OnMap:V.OnScreen;_.length?this.selectMultipleUnits(_,{queryType:P},!1):I.size||this.selectMultipleUnits([],{queryType:P}),this.shouldSelectByTypeOnMap=!0}}selectCombatants(){let g=this.player??this.unitSelection.getSelectedUnits()[0]?.owner;if(g){let L=[];L=this.shouldSelectCombatantsOnMap?g.getOwnedObjects():this.getOwnedObjectsOnScreen(g);var P,I=L.filter(g=>g.isUnit()&&g.rules.selectable&&g.rules.isSelectableCombatant&&g.attackTrait&&!g.rules.harvester);I.length?(P=this.shouldSelectCombatantsOnMap?V.OnMap:V.OnScreen,this.selectMultipleUnits(I,{queryType:P})):this.shouldSelectCombatantsOnMap?this.selectMultipleUnits([],{queryType:V.OnMap}):(this.shouldSelectCombatantsOnMap=!0,this.selectCombatants()),this.shouldSelectCombatantsOnMap=!0}}selectByVeterancy(){let g=this.player??this.unitSelection.getSelectedUnits()[0]?.owner;if(g){let I;void 0===this.selectVeteranState?(I=this.veteranCap,this.vetNavSelectionSet=this.unitSelection.getSelectedUnits(),this.vetNavSelectionSet.length||(this.vetNavSelectionSet=this.getOwnedObjectsOnScreen(g).filter(g=>g.isUnit()))):(P=this.veteranCap+1,I=(this.selectVeteranState-1+P)%P);let L=this.vetNavSelectionSet.filter(P=>P.rules.selectable&&!P.isDestroyed&&!P.isCrashing&&!P.limboData&&P.owner===g);var P=L.filter(g=>g.veteranLevel===I);this.selectMultipleUnits(P,{queryType:V.Veteran,veteranLevel:L.length?I:void 0}),this.selectVeteranState=I}}selectByHealth(){let g=this.player??this.unitSelection.getSelectedUnits()[0]?.owner;if(g){let I;var P=Object.keys(G.HealthLevel).filter(g=>!isNaN(Number(g))).length;void 0===this.selectHealthState?(I=P-1,this.healthNavSelectionSet=this.unitSelection.getSelectedUnits(),this.healthNavSelectionSet.length||(this.healthNavSelectionSet=this.getOwnedObjectsOnScreen(g).filter(g=>g.isUnit()))):I=(this.selectHealthState-1+P)%P;let L=this.healthNavSelectionSet.filter(P=>P.rules.selectable&&!P.isDestroyed&&!P.isCrashing&&!P.limboData&&P.owner===g);P=L.filter(g=>g.healthTrait.level===I),this.selectMultipleUnits(P,{queryType:V.Health,healthLevel:L.length?I:void 0}),this.selectHealthState=I}}getOwnedObjectsOnScreen(g){var P=this.worldScene.viewport;P=new THREE.Box2(new THREE.Vector2(P.x,P.y),new THREE.Vector2(P.x+P.width-1,P.x+P.height-1));return this.entityIntersectHelper.getEntitiesAtScreenBox(P)?.map(g=>g.gameObject).filter(P=>P.isTechno()&&P.owner===g)}disposeBoxSelect(){this.selectBox&&(this.uiScene.get3DObject().remove(this.selectBox),this.selectBox.geometry.dispose(),this.selectBox.material.dispose(),this.selectBox=void 0)}clampPointerToWorldViewport(g){var P=this.worldScene.viewport;return{x:L.clamp(g.x,P.x,P.x+P.width-1),y:L.clamp(g.y,P.y,P.y+P.height-1)}}getHash(){return this.unitSelection.getHash()}dispose(){this.cancelBoxSelect(),this._onUserSelectionChange=new _.EventDispatcher,this._onUserSelectionUpdate=new _.EventDispatcher}createSelectBox(g){var P=new THREE.LineBasicMaterial({color:16777215,transparent:!0,depthTest:!1,depthWrite:!1}),I=this.createBoxGeometry(g);return new THREE.Line(I,P)}createBoxGeometry(g){var P={x:g.min.x,y:g.min.y},I={x:g.max.x,y:g.max.y},L={x:g.max.x,y:g.min.y},_={x:g.min.x,y:g.max.y};let U=new THREE.Geometry;return U.vertices.push(new THREE.Vector3(P.x,P.y,0),new THREE.Vector3(_.x,_.y,0),new THREE.Vector3(I.x,I.y,0),new THREE.Vector3(L.x,L.y,0),new THREE.Vector3(P.x,P.y,0)),U}})}}}),System.register("gui/screen/game/worldInteraction/WorldInteraction",["util/geometry","engine/type/PointerType","gui/screen/game/worldInteraction/DefaultActionHandler","util/userAgent"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("WorldInteraction",class{constructor(g,P,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se){this.worldScene=g,this.pointer=P,this.pointerEvents=_,this.cameraPanHandler=U,this.mapScrollHandler=G,this.mapHoverHandler=V,this.tooltipHandler=W,this.unitSelectionHandler=z,this.defaultActionHandler=K,this.keyboardHandler=q,this.arrowScrollHandler=$,this.customScrollHandler=Q,this.minimapHandler=Y,this.cameraZoom=Z,this.document=X,this.renderer=J,this.targetLines=ee,this.rightClickMove=te,this.rightClickScroll=re,this.battleControlApi=se,this.initialized=!1,this.enabled=!0,this.clickOrigin={x:0,y:0},this.maybePan=!1,this.hasDragged=!1,this.isMinimapHover=!1,this.clearModeOnSelectionChange=!1,this.handleSelectionChange=()=>{this.clearModeOnSelectionChange&&this.setMode(void 0)},this.handleKeyDown=g=>{this.handleKeyModifierChange(g),this.keyboardHandler.handleKeyDown(g),this.arrowScrollHandler.handleKeyDown(g),this.chatTypingHandler?.handleKeyDown(g)},this.handleKeyUp=g=>{this.handleKeyModifierChange(g),this.keyboardHandler.handleKeyUp(g),this.arrowScrollHandler.handleKeyUp(g),this.chatTypingHandler?.handleKeyUp(g),this.tooltipHandler.reset()},this.handleKeyModifierChange=g=>{var P=this.lastKeyMods;this.lastKeyMods=g,this.lastKeyboardEvent=g,this.currentMode||this.maybePan&&this.hasDragged||this.mapScrollHandler.isScrolling()||g.repeat||g.shiftKey===P?.shiftKey&&g.ctrlKey===P?.ctrlKey&&g.altKey===P?.altKey||this.updateDefaultAction(this.getCurrentHover(),this.unitSelectionHandler.getSelectedUnits(),g)},this.handleMapHoverChange=g=>{this.currentMode?.hover(g,this.isMinimapHover),this.isMinimapHover||this.currentMode||this.updateDefaultAction(g,this.unitSelectionHandler.getSelectedUnits(),this.lastKeyMods)},this.handleMouseMove=g=>{this.queuedMouseMoveEvent=g},this.handleFrame=g=>{this.lastFrameTime=g;let P=!1;var I=this.unitSelectionHandler.getHash();I===this.lastSelectionHash||this.currentMode||(this.lastSelectionHash=I,P=!0),(I=this.queuedMouseMoveEvent)&&(this.queuedMouseMoveEvent=void 0,this.processMouseMove(I)),(!this.lastDefaultActionUpdate||g-this.lastDefaultActionUpdate>=1e3/15)&&(this.lastDefaultActionUpdate=g,this.currentMode||this.mapScrollHandler.isScrolling()||this.hasDragged&&this.maybePan||(P=!0)),P&&this.updateDefaultAction(this.getCurrentHover(),this.unitSelectionHandler.getSelectedUnits(),this.lastKeyMods)},this.handleMouseDown=g=>{I.rectContainsPoint(this.worldScene.viewport,g.pointer)&&void 0===this.mousePressed&&(this.hasFaultyCtrlLeftClick&&g.ctrlKey&&2===g.button&&(g.button=0),this.mapScrollHandler.cancel(),this.pointerEvents.intersectionsEnabled=!1,this.clickOrigin=g.pointer,this.mousePressed=g.button,this.lastMouseDownEvent=g,this.hasDragged=!1,(2===g.button&&this.isRightClickPanAllowed()||1===g.button)&&(this.maybePan=!0,this.cameraPanHandler.start(g.pointer)),2===g.button&&(this.isRightClickPanAllowed()||this.isRightClickMove()||this.unitSelectionHandler.deselectAll(),this.chatTypingHandler?.endTyping()))},this.handleMouseUp=g=>{if(this.hasFaultyCtrlLeftClick&&g.ctrlKey&&2===g.button&&(g.button=0),this.mousePressed===g.button){g.isTouch&&this.lastKeyMods&&this.lastKeyMods!==this.lastKeyboardEvent&&(g.ctrlKey=this.lastKeyMods.ctrlKey,g.shiftKey=this.lastKeyMods.shiftKey,g.altKey=this.lastKeyMods.altKey),this.pointerEvents.intersectionsEnabled=!0,this.mousePressed=void 0;var P=this.maybePan;if(this.maybePan=!1,P&&this.cameraPanHandler.finish(),P&&this.hasDragged)return this.mapHoverHandler.update(g.pointer,!0),void this.currentMode?.hover(this.getCurrentHover(),this.isMinimapHover);if(this.currentMode)0===g.button?(this.mapHoverHandler.update(g.pointer,!0),!1!==this.currentMode.execute(this.getCurrentHover(),this.isMinimapHover)&&(this.currentMode=void 0)):2===g.button&&this.isClickRange(g.pointer)&&(this.currentMode.cancel?.(),this.currentMode=void 0,this.pointer.setPointerType(L.PointerType.Default));else{let L=!1;if(0===g.button&&this.hasDragged&&(L=this.unitSelectionHandler.finishBoxSelect(g.pointer,!g.shiftKey),L||this.mapHoverHandler.update(g.pointer,!0)),0===g.button||2===g.button){var I=this.isRightClickMove(),_=g.button===(I?2:0),U=this.isClickRange(g.pointer);let z=!1;var G=U&&g.isTouch&&500<=g.timeStamp-this.lastMouseDownEvent.timeStamp;g.isTouch&&this.mapHoverHandler.update(g.pointer,!0);var V,W=this.mapHoverHandler.getCurrentHover();if(U&&(V=this.lastDefaultModeClickDetails,P={mouseUpEvent:g,hoverObject:W?.gameObject,selectionHash:this.unitSelectionHandler.getHash(),time:Date.now()},V&&(z=P.mouseUpEvent.button===V.mouseUpEvent.button&&P.hoverObject===V.hoverObject&&P.selectionHash===V.selectionHash&&P.time-V.time<500),this.lastDefaultModeClickDetails=z?void 0:P),!_&&(!I||!g.shiftKey||g.ctrlKey)&&(!I||!z)){if(!U)return;this.unitSelectionHandler.deselectAll()}L||!I&&!_||this.handleDefaultClickAction(I,_,z,G,g,W),this.lastDefaultModeClickDetails&&(this.lastDefaultModeClickDetails.selectionHash=this.unitSelectionHandler.getHash())}}}},this.handleWheel=g=>{this.cameraZoom.applyStep(0<g.wheelDeltaY?-.1:.1)},this.handleMinimapClick=g=>{this.executeMinimapClickCommand(g,!1)},this.handleMinimapRightClick=g=>{this.executeMinimapClickCommand(g,!0)},this.handleMinimapMouseOver=()=>{this.isMinimapHover=!0},this.handleMinimapMouseMove=g=>{this.minimapHoverTile=g;var P=this.minimapHandler.getHover(g);this.currentMode?this.currentMode.hover(P,!0):this.updateDefaultAction(P,this.unitSelectionHandler.getSelectedUnits(),this.lastKeyMods)},this.handleMinimapMouseOut=()=>{this.pointer.setPointerType(L.PointerType.Default),this.isMinimapHover=!1,this.minimapHoverTile=void 0}}init(){this.initialized||(this.setupHandlers(),this.worldScene.add(this.targetLines),this.initialized=!0,this.hasFaultyCtrlLeftClick=U.isMacFirefox(),this.battleControlApi._setWorldInteraction(this),this.battleControlApi._notifyToggle(!0))}setShroud(g){this.mapHoverHandler.setShroud(g),this.minimapHandler.setShroud(g)}setupHandlers(){this.pointerEvents.addEventListener("canvas","mousemove",this.handleMouseMove),this.pointerEvents.addEventListener("canvas","mousedown",this.handleMouseDown),this.pointerEvents.addEventListener("canvas","mouseup",this.handleMouseUp),this.pointerEvents.addEventListener("canvas","wheel",this.handleWheel),this.document.addEventListener("keydown",this.handleKeyDown),this.document.addEventListener("keyup",this.handleKeyUp),this.mapHoverHandler.onHoverChange.subscribe(this.handleMapHoverChange),this.renderer.onFrame.subscribe(this.handleFrame),this.unitSelectionHandler.onUserSelectionChange.subscribe(this.handleSelectionChange),this.minimapHandler.minimap.onClick.subscribe(this.handleMinimapClick),this.minimapHandler.minimap.onRightClick.subscribe(this.handleMinimapRightClick),this.minimapHandler.minimap.onMouseOver.subscribe(this.handleMinimapMouseOver),this.minimapHandler.minimap.onMouseMove.subscribe(this.handleMinimapMouseMove),this.minimapHandler.minimap.onMouseOut.subscribe(this.handleMinimapMouseOut),this.tooltipHandler.init()}teardownHandlers(){this.pointerEvents.removeEventListener("canvas","mousemove",this.handleMouseMove),this.pointerEvents.removeEventListener("canvas","mousedown",this.handleMouseDown),this.pointerEvents.removeEventListener("canvas","mouseup",this.handleMouseUp),this.pointerEvents.removeEventListener("canvas","wheel",this.handleWheel),this.document.removeEventListener("keydown",this.handleKeyDown),this.document.removeEventListener("keyup",this.handleKeyUp),this.mapHoverHandler.onHoverChange.unsubscribe(this.handleMapHoverChange),this.renderer.onFrame.unsubscribe(this.handleFrame),this.unitSelectionHandler.onUserSelectionChange.unsubscribe(this.handleSelectionChange),this.unitSelectionHandler.cancelBoxSelect(),this.minimapHandler.minimap.onClick.unsubscribe(this.handleMinimapClick),this.minimapHandler.minimap.onRightClick.unsubscribe(this.handleMinimapRightClick),this.minimapHandler.minimap.onMouseOver.unsubscribe(this.handleMinimapMouseOver),this.minimapHandler.minimap.onMouseMove.unsubscribe(this.handleMinimapMouseMove),this.minimapHandler.minimap.onMouseOut.unsubscribe(this.handleMinimapMouseOut),this.tooltipHandler.dispose(),this.mapScrollHandler.cancel(),this.arrowScrollHandler.cancel(),this.customScrollHandler.cancel()}dispose(){this.initialized&&this.enabled&&(this.teardownHandlers(),this.pointer.setPointerType(L.PointerType.Default),this.battleControlApi._setWorldInteraction(void 0),this.battleControlApi._notifyToggle(!1)),this.currentMode?.dispose(),this.mapScrollHandler.dispose(),this.cameraPanHandler.dispose(),this.mapHoverHandler.dispose(),this.unitSelectionHandler.dispose(),this.chatTypingHandler?.dispose(),this.keyboardHandler.dispose(),this.worldScene.remove(this.targetLines),this.targetLines.dispose(),this.tooltipHandler.dispose()}setEnabled(g){this.enabled!==g&&((this.enabled=g)?this.setupHandlers():(this.teardownHandlers(),this.cancelMouseUp(),this.cancelKeyUp(),this.pointer.setPointerType(L.PointerType.Default),this.chatTypingHandler?.endTyping()),this.battleControlApi._setWorldInteraction(g?this:void 0),this.battleControlApi._notifyToggle(g))}isEnabled(){return this.enabled}pausePanning(){this.cameraPanHandler.setPaused(!0),this.mapScrollHandler.setPaused(!0)}unpausePanning(){this.cameraPanHandler.setPaused(!1),this.mapScrollHandler.setPaused(!1)}setMode(g){var P;this.currentMode!==g&&(this.currentMode?.cancel?.(),this.pointer.setPointerType(L.PointerType.Default)),this.currentMode=g,this.clearModeOnSelectionChange=!1,g&&(this.unitSelectionHandler.cancelBoxSelect(),this.unitSelectionHandler.deselectAll(),this.clearModeOnSelectionChange=!0,g.enter(),this.mapHoverHandler.update(this.pointer.getPosition(),!0),(P=this.getCurrentHover())&&g.hover(P,this.isMinimapHover))}getMode(){return this.currentMode}getLastKeyModifiers(){return this.lastKeyMods}registerKeyCommand(g,P){return this.keyboardHandler.registerCommand(g,P),this}unregisterKeyCommand(g){return this.keyboardHandler.unregisterCommand(g),this}applyKeyModifiers(g){this.lastKeyMods=g,this.currentMode||this.maybePan&&this.hasDragged||this.mapScrollHandler.isScrolling()||this.updateDefaultAction(this.getCurrentHover(),this.unitSelectionHandler.getSelectedUnits(),g)}updateDefaultAction(g,P,I){var _=this.mapScrollHandler.isScrolling();g?(this.defaultActionHandler.update(g,P,this.isRightClickMove(),I,this.isMinimapHover),_||this.pointer.setPointerType(this.defaultActionHandler.getPointerType(this.isMinimapHover))):_||this.pointer.setPointerType(this.isMinimapHover?L.PointerType.Mini:L.PointerType.Default),this.lastDefaultActionUpdate=this.lastFrameTime}processMouseMove(g){var P=this.mapScrollHandler.isScrolling();void 0===this.mousePressed?g.isTouch||this.mapScrollHandler.update(g.pointer):this.hasDragged||this.isClickRange(g.pointer)||(this.hasDragged=!0,this.currentMode||0!==this.mousePressed||this.unitSelectionHandler.startBoxSelect(this.clickOrigin)),!this.currentMode||this.mapScrollHandler.isScrolling()||this.maybePan&&this.hasDragged||(!this.isMinimapHover&&P&&this.pointer.setPointerType(L.PointerType.Default),this.mapHoverHandler.update(g.pointer),this.currentMode.hover(this.getCurrentHover(),this.isMinimapHover)),void 0===this.mousePressed?this.mapScrollHandler.isScrolling()||(this.mapHoverHandler.update(g.pointer),this.currentMode||this.updateDefaultAction(this.getCurrentHover(),this.unitSelectionHandler.getSelectedUnits(),g)):(!this.hasDragged||(this.currentMode||this.isRightClickMove()&&2===this.mousePressed)&&!this.maybePan?this.mapHoverHandler.update(g.pointer):this.mapHoverHandler.finish(),this.hasDragged&&(this.maybePan?this.cameraPanHandler.update(g.pointer,g.isTouch):this.currentMode||this.isRightClickMove()&&2===this.mousePressed||(this.pointer.setPointerType(L.PointerType.Default),this.unitSelectionHandler.updateBoxSelect(g.pointer))))}handleDefaultClickAction(g,P,I,L,U,G){var V,W;G&&(V=this.unitSelectionHandler.getSelectedUnits(),W=g?P?_.ActionFilter.NoSelect:_.ActionFilter.SelectOnly:_.ActionFilter.All,this.defaultActionHandler.execute(G,V,W,g&&!P,I,L?{...U,ctrlKey:!0}:U))}cancelMouseUp(){void 0!==this.mousePressed&&(this.pointerEvents.intersectionsEnabled=!0,this.mousePressed=void 0,this.maybePan&&(this.maybePan=!1,this.cameraPanHandler.finish()),this.currentMode&&(this.currentMode.cancel?.(),this.currentMode=void 0),this.unitSelectionHandler.cancelBoxSelect())}cancelKeyUp(){var g;"keydown"===this.lastKeyboardEvent?.type&&(g=new KeyboardEvent("keyup",{key:this.lastKeyboardEvent.key,keyCode:this.lastKeyboardEvent.keyCode,ctrlKey:this.lastKeyboardEvent.ctrlKey,altKey:this.lastKeyboardEvent.altKey,shiftKey:this.lastKeyboardEvent.shiftKey,metaKey:this.lastKeyboardEvent.metaKey}),this.handleKeyUp(g))}isClickRange(g){return Math.abs(g.x-this.clickOrigin.x)<=7&&Math.abs(g.y-this.clickOrigin.y)<=7}isRightClickPanAllowed(){return this.rightClickScroll.value}isRightClickMove(){return this.rightClickMove.value}executeMinimapClickCommand(g,P){let I=!1;var L,U;P===this.isRightClickMove()&&(L=this.minimapHandler.getHover(g),this.currentMode?!1!==this.currentMode.execute(L,!0)&&(this.currentMode=void 0,I=!0):(U=this.unitSelectionHandler.getSelectedUnits(),I=this.defaultActionHandler.execute(L,U,_.ActionFilter.All,!1,!1,this.lastKeyMods,!0))),I||this.minimapHandler.panToTile(g)}getCurrentHover(){return this.isMinimapHover?this.minimapHoverTile?this.minimapHandler.getHover(this.minimapHoverTile):void 0:this.mapHoverHandler.getCurrentHover()}})}}}),System.register("gui/screen/game/worldInteraction/WorldInteractionFactory",["engine/util/MapTileIntersectHelper","engine/util/EntityIntersectHelper","gui/screen/game/worldInteraction/UnitSelectionHandler","gui/screen/game/worldInteraction/DefaultActionHandler","gui/screen/game/worldInteraction/WorldInteraction","gui/screen/game/worldInteraction/CameraPanHandler","gui/screen/game/worldInteraction/MapScrollHandler","gui/screen/game/worldInteraction/MapHoverHandler","gui/screen/game/worldInteraction/keyboard/KeyboardHandler","engine/util/RaycastHelper","engine/util/WorldViewportHelper","engine/renderable/entity/TargetLines","gui/screen/game/worldInteraction/MinimapHandler","engine/util/MapPanningHelper","gui/screen/game/worldInteraction/TooltipHandler","gui/screen/game/worldInteraction/ArrowScrollHandler","gui/screen/game/worldInteraction/CustomScrollHandler"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g}],execute:function(){g("WorldInteractionFactory",class{constructor(g,P,I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee){this.player=g,this.game=P,this.unitSelection=I,this.renderableManager=L,this.uiScene=_,this.worldScene=U,this.pointer=G,this.renderer=V,this.keyBinds=W,this.generalOptions=z,this.freeCamera=K,this.debugPaths=q,this.devMode=$,this.document=Q,this.minimap=Y,this.strings=Z,this.tooltipTextColor=X,this.tooltipDebugText=J,this.battleControlApi=ee}create(){var g=this.game.map,P=this.worldScene,te=this.pointer;let re=this.renderer;var se=new I.MapTileIntersectHelper(g,P),ae=new q.RaycastHelper(P),ne=new $.WorldViewportHelper(P),oe=new L.EntityIntersectHelper(g,this.renderableManager,se,ae,P,ne),le=new _.UnitSelectionHandler(P,this.uiScene,this.player,this.unitSelection,oe,this.game.rules.general.veteran.veteranCap),ce=U.DefaultActionHandler.factory(this.renderableManager,this.unitSelection,le,this.player,g,this.game,this.game.rules.audioVisual);ae=this.player?this.game.mapShroudTrait.getPlayerShroud(this.player):void 0,ne=new K.KeyboardHandler(this.keyBinds,this.devMode),oe=new z.MapHoverHandler(oe,se,g,ae,re),se=new W.MapScrollHandler(re.getCanvas(),P.cameraPan,te,this.generalOptions.scrollRate,P);return new G.WorldInteraction(P,te,te.pointerEvents,new V.CameraPanHandler(P.cameraPan,te,this.generalOptions.scrollRate,this.freeCamera,P),se,oe,new X.TooltipHandler(oe,this.tooltipTextColor,te,this.uiScene,this.renderer,this.strings,this.tooltipDebugText),le,ce,ne,new J.ArrowScrollHandler(se),new ee.CustomScrollHandler(se),new Y.MinimapHandler(this.minimap,g,ae,P,new Z.MapPanningHelper(g)),P.cameraZoom,this.document,re,new Q.TargetLines(this.player,this.unitSelection,P.camera,this.debugPaths,this.generalOptions.targetLines),this.generalOptions.rightClickMove,this.generalOptions.rightClickScroll,this.battleControlApi)}})}}}),System.register("gui/screen/game/WorldView",["util/disposable/CompositeDisposable","engine/renderable/WorldScene","engine/util/WorldViewportHelper","engine/util/MapTileIntersectHelper","engine/sound/WorldSound","engine/Engine","engine/util/MapPanningHelper","engine/IsoCoords","engine/ImageFinder","engine/renderable/entity/map/MapRenderable","engine/renderable/entity/RenderableFactory","engine/RenderableManager","engine/renderable/fx/handler/ChronoFxHandler","engine/Lighting","engine/gfx/lighting/LightingDirector","engine/renderable/fx/handler/WarheadDetonateFxHandler","engine/renderable/fx/handler/SuperWeaponFxHandler","engine/renderable/fx/handler/CrateFxHandler","engine/renderable/fx/handler/BeaconFxHandler","engine/renderable/builder/VxlBuilderFactory","engine/renderable/fx/handler/TriggerActionFxHandler","util/BoxedVar","engine/renderable/fx/handler/ParasiteSparkFxHandler"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g}],execute:function(){g("WorldView",class{constructor(g,P,L,_,U,G,V,W,z,K){this.hudGutterSize=g,this.game=P,this.sound=L,this.renderer=_,this.runtimeVars=U,this.minimap=G,this.strings=V,this.generalOptions=W,this.vxlGeometryPool=z,this.buildingImageDataCache=K,this.disposables=new I.CompositeDisposable,this.localPlayer=new ne.BoxedVar(void 0)}init(g,P,I){this.localPlayer.value=g,this.disposables.add(()=>this.localPlayer.value=void 0);let L=this.game,V=L.map;var W=this.computeMapScreenBounds(V.mapBounds.getLocalSize()),z=this.computeWorldViewport(P,W);let K=this.initWorldView(g,z,L,V);this.worldScene=K,this.disposables.add(()=>this.worldScene=void 0);var q=new _.WorldViewportHelper(K),$=new U.MapTileIntersectHelper(V,K);W=L.getWorld(),z=g?this.game.mapShroudTrait.getPlayerShroud(g):void 0;let Q=new G.WorldSound(this.sound,g,z,q,$,W,K,this.renderer);Q.init(),this.worldSound=Q,this.disposables.add(Q,()=>this.worldSound=void 0);let Y=new Z.Lighting(L.mapLightingTrait);this.disposables.add(Y),K.applyLighting(Y);let J=new X.LightingDirector(Y,this.renderer,L.speed);J.init(),this.disposables.add(J),W=L.getUnitSelection();let{renderableManager:ee,mapRenderable:te,superWeaponFxHandler:re,beaconFxHandler:se}=this.initRenderables(L,this.localPlayer,K,I,W,Q,Y,J);this.mapRenderable=te,this.disposables.add(()=>this.mapRenderable=void 0);let y=g=>{K.applyLighting(Y),ee.updateLighting(),te.updateLighting(g)};Y.onChange.subscribe(y),this.disposables.add(()=>Y.onChange.unsubscribe(y)),this.minimap.initWorld(K);let T=()=>{this.handleMapBoundsOrViewportChange(P),this.minimap.forceRerender()};return V.mapBounds.onLocalResize.subscribe(T),this.disposables.add(()=>V.mapBounds.onLocalResize.unsubscribe(T)),{worldScene:K,worldSound:Q,renderableManager:ee,superWeaponFxHandler:re,beaconFxHandler:se}}changeLocalPlayer(g){var P=(this.localPlayer.value=g)?this.game.mapShroudTrait.getPlayerShroud(g):void 0;this.worldSound?.changeLocalPlayer(g,P),this.mapRenderable?.setShroud(P)}handleViewportChange(g){this.handleMapBoundsOrViewportChange(g)}handleMapBoundsOrViewportChange(g){var P;this.worldScene&&(P=this.computeMapScreenBounds(this.game.map.mapBounds.getLocalSize()),P=this.computeWorldViewport(g,P),this.worldScene.updateViewport(P),this.updatePanLimits(this.game.map,this.worldScene.cameraPan,P))}initWorldView(g,P,I,_){let U=L.WorldScene.factory(P,this.runtimeVars.freeCamera,this.generalOptions.graphics.shadows);this.disposables.add(U),this.updatePanLimits(_,U.cameraPan,P);var G=(!g||g.isObserver?I.getCombatants()[0]:g).startLocation;G=_.startingLocations[G];let V=new W.MapPanningHelper(_);return U.cameraPan.setPan(V.computeCameraPanFromTile(G.x,G.y)),G=_.mapBounds.getFullSize(),G=z.IsoCoords.screenTileToWorld(G.width/2,G.height/2),U.setLightFocusPoint(G.x,G.y),U}initRenderables(g,P,I,L,_,U,G,W){var z=V.Engine.getImages(),Z=V.Engine.getVoxels(),X=V.Engine.getVoxelAnims(),ne=new K.ImageFinder(z,L),le=V.Engine.getPalettes(),ce=P.value?g.mapShroudTrait.getPlayerShroud(P.value):void 0;z=new q.MapRenderable(g.map,ce,g.mapRadiationTrait,G,L,g.rules,g.art,ne,I.camera,this.runtimeVars.debugWireframes,g.speed,U,!0);I.add(z),this.disposables.add(z),ce=this.renderer.supportsInstancing(),ce=new $.RenderableFactory(P,_,g.alliances,g.rules,g.art,z,ne,le,Z,X,L,I.camera,G,W,this.runtimeVars.debugWireframes,this.runtimeVars.debugText,this.runtimeVars.persistentHoverTags,g.speed,U,this.strings,this.generalOptions.flyerHelper,this.generalOptions.hiddenObjects,new se.VxlBuilderFactory(this.vxlGeometryPool,ce,I.camera),this.buildingImageDataCache,!0,ce);let he=new Q.RenderableManager(g.getWorld(),I,I.camera,ce);he.init(),this.disposables.add(he);let ue=new Y.ChronoFxHandler(g,he);ue.init(),this.disposables.add(ue);let de=new J.WarheadDetonateFxHandler(g,he);de.init(),this.disposables.add(de);let ge=new ee.SuperWeaponFxHandler(g,he,W);ge.init(),this.disposables.add(ge);let pe=new te.CrateFxHandler(g,he);pe.init(),this.disposables.add(pe);let me=new re.BeaconFxHandler(g,P,he,this.renderer,U);me.init(),this.disposables.add(me);let fe=new oe.ParasiteSparkFxHandler(g,he);fe.init(),this.disposables.add(fe);let ye=new ae.TriggerActionFxHandler(g,he);return ye.init(),this.disposables.add(ye),{renderableManager:he,mapRenderable:z,superWeaponFxHandler:ge,beaconFxHandler:me}}computeWorldViewport(g,P){return{x:g.x,y:g.y,width:Math.min(P.width,g.width-this.hudGutterSize.width),height:Math.min(P.height,g.height-this.hudGutterSize.height)}}updatePanLimits(g,P,I){let L=new W.MapPanningHelper(g);var _=this.computeMapScreenBounds(g.mapBounds.getLocalSize());P.setPanLimits(L.computeCameraPanLimits(I,_))}computeMapScreenBounds(g){var P=z.IsoCoords.screenTileToScreen(g.x,g.y),I=z.IsoCoords.screenTileToScreen(g.x+g.width,g.y+g.height-1);return{x:P.x,y:P.y,width:I.x-P.x,height:I.y-P.y}}dispose(){this.worldScene&&this.renderer.removeScene(this.worldScene),this.disposables.dispose()}})}}}),System.register("gui/screen/mainMenu/component/Iframe",["react"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("Iframe",({src:g,className:P})=>I.createElement("iframe",{src:g,className:P}))}}}),System.register("gui/screen/mainMenu/component/MainMenu",["gui/jsx/jsx","gui/UiObject","gui/HtmlContainer","gui/screen/mainMenu/component/MenuVideo","gui/component/MenuButton","util/event","gui/screen/mainMenu/component/MenuSlotAnimationRunner","gui/jsx/HtmlView","gui/screen/mainMenu/component/MenuMpSlotAnimRunner","gui/screen/mainMenu/component/MenuMpSlotText","gui/screen/mainMenu/component/SidebarPreview","gui/screen/mainMenu/component/MenuTooltip","gui/screen/mainMenu/component/VersionString"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g}],execute:function(){Z=class extends L.UiObject{constructor(g,P,I,L){super(new THREE.Object3D,new _.HtmlContainer),this.viewport=g,this.images=P,this.jsxRenderer=I,this.videoSrc=L,this.rootObjects=[],this.sidebarObjects=[],this.sidebarSlots=[],this.sidebarMpSlotEnabled=!1,this.sidebarButtons=[],this.sidebarButtonConfigs=[],this.sidebarCollapsed=!0,this._onSidebarToggle=new V.EventDispatcher,this.create3DObject()}get onSidebarToggle(){return this._onSidebarToggle}setViewport(g){this.viewport=g,this.setPosition(this.viewport.x,this.viewport.y);var P=this.getImage("lwscrnl.shp");this.statusBar.setPosition(0,this.viewport.height-P.height);var I=this.getImage("sdtp.shp");P=this.computeSidebarViewport(I);this.sidebarContainer.setPosition(P.x,P.y),this.sidebarContainer.remove(...this.sidebarObjects),this.sidebarObjects.forEach(g=>g.destroy()),this.createSidebarButtons(this.computeSidebarButtonsViewport(I)),this.updateButtons(this.sidebarButtonsRawConfigs??[]),this.sidebarCollapsed||this.showButtons()}setContentComponent(g){let P=this.mainContainer;this.contentComponent&&(P.remove(this.contentComponent),this.contentComponent.destroy(),this.contentComponent=void 0),g&&(P.add(g),this.contentComponent=g)}setSlots(g,P,I=!1){let L=this.sidebarSlots.length;if(!L)throw new Error("Cannot call setButtons prior to render");this.sidebarMpSlotContainer.setVisible(I),this.sidebarSlots[0].setVisible(!I),this.sidebarSlots.forEach((_,U)=>{let G=_.getAnimationRunner();G.buttonState=U<g+(I?1:0)||U===L-1&&P?W.MenuButtonState.Unlit:W.MenuButtonState.Hidden})}setButtons(g,P=!1){this.sidebarButtonsRawConfigs=g,this.sidebarMpSlotEnabled=P,this.updateButtons(g)}updateButtons(g){let P=this.sidebarMpSlotEnabled;var I=!!g.find(g=>!!g.isBottom);this.setSlots(g.length-(I?1:0),I,P),this.updateSidebarMpContent(),this.sidebarButtons.forEach(g=>g.applyOptions(g=>g.buttonConfig=void 0)),g.forEach((g,I)=>{var L=g.isBottom?this.sidebarButtons.length-1:P?I+1:I;this.sidebarButtonConfigs[L]=g,this.sidebarButtons[L]?.applyOptions(P=>P.buttonConfig={label:g.label,tooltip:g.tooltip,disabled:!!g.disabled})}),this.sidebarNeedsRefresh=!0}isSidebarCollapsed(){return this.sidebarCollapsed}showButtons(){this.sidebarCollapsed=!1,this.sidebarNeedsRefresh=!0,this.sidebarMpSlot.getAnimationRunner().slideIn(),this.sidebarSlots.forEach(g=>{g.getAnimationRunner().slideIn()})}hideButtons(){this.sidebarCollapsed=!0,this.updateSidebarButtons(),this.sidebarNeedsRefresh=!0,this.sidebarMpSlot.getAnimationRunner().slideOut(),this.sidebarSlots.forEach(g=>{g.getAnimationRunner().slideOut()})}setSidebarTitle(g){this.sidebarPreview.setTitle(g)}toggleSidebarPreview(g){this.sidebarPreview.toggleSidebarPreview(g)}setSidebarPreview(g){this.sidebarPreviewInner&&this.sidebarPreviewInner.destroy(),this.sidebarPreview.setPreview(g),this.sidebarPreviewInner=g}getSidebarPreviewSize(){return this.sidebarPreview.getPreviewSize()}toggleVideo(g){if(!this.menuVideo)throw new Error("Cannot call toggleVideo prior to render");this.menuVideo.getUiObject().setVisible(g)}showVersion(g){this.version.getUiObject().setVisible(!0),this.version.getElement().applyOptions(P=>P.value=g)}hideVersion(){this.version.getUiObject().setVisible(!1)}setSidebarMpContent(g){this.sidebarMpSlotContent=g,this.updateSidebarMpContent()}updateSidebarMpContent(){this.sidebarMpSlotContentEl.applyOptions(g=>{this.sidebarMpSlotContent&&(g.text=this.sidebarMpSlotContent.text,g.icon=this.sidebarMpSlotContent.icon,g.tooltip=this.sidebarMpSlotContent.tooltip)})}getImage(g){var P=this.images.get(g);if(!P)throw new Error(`Missing image "${g}"`);return P}create3DObject(){var g,P,L,_,G;super.create3DObject(),this.rootObjects.length||(this.setPosition(this.viewport.x,this.viewport.y),g=this.getImage("mnscrnl.shp"),P=this.getImage("lwscrnl.shp"),L=this.getImage("sdtp.shp"),_=this.getImage("sdwrnanm.shp"),G=this.computeSidebarViewport(L),this.rootObjects=this.jsxRenderer.render(I.jsx("fragment",null,I.jsx("container",{width:g.width,height:g.height,ref:g=>this.mainContainer=g},I.jsx("sprite",{image:g,palette:"shell.pal"}),I.jsx(z.HtmlView,{component:U.MenuVideo,props:{src:this.videoSrc},hidden:!0,ref:g=>this.menuVideo=g})),I.jsx("container",{x:0,y:this.viewport.height-P.height,ref:g=>this.statusBar=g},I.jsx("sprite",{image:P,palette:"shell.pal"}),I.jsx(z.HtmlView,{component:Q.MenuTooltip,props:{monitorContainer:this.getHtmlContainer()},width:P.width,height:P.height})),I.jsx("container",{x:G.x,y:G.y,ref:g=>this.sidebarContainer=g},I.jsx($.SidebarPreview,{sdtpImg:L,sdtpAnimImg:_,closed:!0,ref:g=>this.sidebarPreview=g}),I.jsx(z.HtmlView,{component:Y.VersionString,props:{value:""},width:G.width,y:G.height-20,ref:g=>this.version=g,hidden:!0})))),this.add(...this.rootObjects),this.createSidebarButtons(this.computeSidebarButtonsViewport(L)))}createSidebarButtons(g){let P=this.getImage("sdbtnbkgd.shp"),L=this.getImage("sdbtnanm.shp");var _=Math.floor(g.height/P.height);let U=this.getImage("sdbtm.shp");var V=g.height-P.height*_;V=U.clip(U.width,V);this.sidebarSlots=[],this.sidebarButtons=[],this.sidebarObjects=this.jsxRenderer.render(I.jsx("fragment",null,new Array(_).fill(0).map((_,U)=>{let V=new W.MenuSlotAnimationRunner(U);return I.jsx("fragment",null,I.jsx("container",{x:g.x,y:g.y+P.height*U},I.jsx("sprite",{image:P,palette:"shell2.pal"}),U?[]:I.jsx("container",{zIndex:1,hidden:!0,ref:g=>this.sidebarMpSlotContainer=g,x:12,y:-P.height},I.jsx("sprite",{image:"sdmpbtn.shp",palette:"shell.pal",ref:g=>this.sidebarMpSlot=g,animationRunner:new K.MenuMpSlotAnimRunner}),I.jsx(z.HtmlView,{component:q.MenuMpSlotText,props:{text:""},width:146,height:2*P.height,innerRef:g=>this.sidebarMpSlotContentEl=g})),I.jsx("sprite",{image:L,palette:"sdbtnanm.pal",ref:g=>this.sidebarSlots.push(g),x:12,animationRunner:V}),I.jsx(z.HtmlView,{x:12,hidden:!0,innerRef:g=>this.sidebarButtons.push(g),component:G.MenuButton,props:{box:{x:0,y:0,width:146,height:L.height},onMouseDown:()=>{V.buttonState=W.MenuButtonState.Active;let e=()=>{V.buttonState=W.MenuButtonState.Normal,document.removeEventListener("mouseup",e)};document.addEventListener("mouseup",e)},onClick:()=>{this.onSidebarButtonClick(U)}}})))}),I.jsx("sprite",{image:V,palette:"shell.pal",x:g.x,y:g.y+P.height*_}))),this.sidebarContainer.add(...this.sidebarObjects)}computeSidebarViewport(g){return{x:this.viewport.width-g.width,y:0,width:g.width,height:this.viewport.height}}computeSidebarButtonsViewport(g){return{x:0,y:g.height,width:g.width,height:this.viewport.height-g.height}}update(g){if(super.update(g),this.sidebarNeedsRefresh){this.sidebarSlots[this.sidebarSlots.length-1].getAnimationRunner().isStopped()&&(this.updateSidebarButtons(),this._onSidebarToggle.dispatch(this,!this.sidebarCollapsed))}}updateSidebarButtons(){this.sidebarCollapsed?(this.sidebarButtons.forEach(g=>g.hide()),this.sidebarMpSlotContentEl.hide(),this.sidebarSlots.forEach(g=>{let P=g.getAnimationRunner();P.buttonState!==W.MenuButtonState.Hidden&&(P.buttonState=W.MenuButtonState.Unlit)})):(this.sidebarButtons.forEach(g=>g.show()),this.sidebarMpSlotContentEl.show(),this.sidebarSlots.forEach((g,P)=>{let I=g.getAnimationRunner();I.buttonState!==W.MenuButtonState.Hidden&&I.buttonState!==W.MenuButtonState.Active&&(I.buttonState=this.sidebarButtonConfigs[P]?.flashing?W.MenuButtonState.Flashing:W.MenuButtonState.Normal)})),this.sidebarNeedsRefresh=!1}onSidebarButtonClick(g){const P=this.sidebarButtonConfigs[g].onClick;P&&P()}destroy(){this.sidebarButtons.length=0,this.remove(...this.rootObjects),this.rootObjects.forEach(g=>g.destroy()),this.rootObjects.length=0,super.destroy()}},g("MainMenu",Z)}}}),System.register("gui/screen/mainMenu/component/MenuMpSlotAnimRunner",["gui/screen/mainMenu/component/MenuSlotAnimationRunner","engine/Animation"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends I.MenuSlotAnimationRunner{getCurrentFrame(){if(this.currentAnimationType===I.AnimationType.None||this.animation.getState()===L.AnimationState.DELAYED)return this.collapsed?6:0;{var g=this.currentAnimationType===I.AnimationType.SlideIn?-1:1;let P=1;return-1==g&&(P+=5),P+g*this.animation.getCurrentFrame()}}},g("MenuMpSlotAnimRunner",_)}}}),System.register("gui/screen/mainMenu/component/MenuMpSlotText",["react","gui/component/Image"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("MenuMpSlotText",({text:g,icon:P,tooltip:_})=>I.default.createElement("div",{className:"menu-mp-slot"},I.default.createElement("pre",{className:"menu-mp-slot-text"},g),P&&I.default.createElement("div",{className:"menu-mp-slot-icon","data-r-tooltip":_},I.default.createElement(L.Image,{src:P}))))}}}),System.register("gui/screen/mainMenu/component/MenuSdTopAnimRunner",["gui/screen/mainMenu/component/MenuSlotAnimationRunner","engine/Animation"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends I.MenuSlotAnimationRunner{getCurrentFrame(){if(this.currentAnimationType===I.AnimationType.None||this.animation.getState()===L.AnimationState.DELAYED)return this.collapsed?5:0;{var g=this.currentAnimationType===I.AnimationType.SlideIn?-1:1;let P=0;return-1==g&&(P+=5),P+g*this.animation.getCurrentFrame()}}},g("MenuSdTopAnimRunner",_)}}}),System.register("gui/screen/mainMenu/component/MenuSlotAnimationRunner",["data/IniSection","data/ShpFile","engine/Animation","engine/AnimProps","engine/Engine","util/BoxedVar"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){var P;(P=W||g("AnimationType",W={}))[P.None=0]="None",P[P.SlideIn=1]="SlideIn",P[P.SlideOut=2]="SlideOut",(P=z||g("MenuButtonState",z={}))[P.Hidden=0]="Hidden",P[P.Unlit=1]="Unlit",P[P.Normal=2]="Normal",P[P.Active=3]="Active",P[P.Flashing=4]="Flashing",g("MenuSlotAnimationRunner",class{constructor(g=0){this.delayFrames=g,this.buttonState=z.Hidden,this.collapsed=!0,this.currentAnimationType=W.None,this.flashingFrame=2}slideIn(){this.currentAnimationType=W.SlideIn,this.initAnimation()}slideOut(){this.currentAnimationType=W.SlideOut,this.initAnimation()}initAnimation(){var g=new I.IniSection("");let P=new U.AnimProps(g,new L.ShpFile);P.loopEnd=5,g=new _.Animation(P,new V.BoxedVar(G.Engine.UI_ANIM_SPEED)),this.animation=g}tick(g){let P=this.animation;var I=this.currentAnimationType;if(this.buttonState===z.Flashing&&(this.flashingFrame=Math.floor(g/500)%2==0?2:4),P&&I!==W.None){switch(P.getState()){case _.AnimationState.STOPPED:break;case _.AnimationState.NOT_STARTED:P.start(g,this.delayFrames);case _.AnimationState.RUNNING:default:P.update(g)}P.getState()===_.AnimationState.STOPPED&&(this.collapsed=I===W.SlideOut,this.currentAnimationType=W.None)}}shouldUpdate(){return!0}isStopped(){return this.currentAnimationType===W.None}getCurrentFrame(){if(this.currentAnimationType!==W.None&&this.animation.getState()!==_.AnimationState.DELAYED){var g=this.currentAnimationType===W.SlideIn?-1:1;let P=this.buttonState!==z.Hidden?5:11;return-1==g&&(P+=5),P+g*this.animation.getCurrentFrame()}let P;if(this.collapsed)P=this.buttonState===z.Hidden?16:10;else if(this.buttonState===z.Hidden)P=0;else if(this.buttonState===z.Unlit)P=1;else if(this.buttonState===z.Normal)P=2;else if(this.buttonState===z.Active)P=4;else{if(this.buttonState!==z.Flashing)throw new Error(`Unknown buttonState "${this.buttonState}"`);P=this.flashingFrame}return P}})}}}),System.register("gui/screen/mainMenu/component/MenuTooltip",["react","classnames"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("MenuTooltip",({monitorContainer:g})=>{const[P,_]=I.useState(""),[U,G]=I.useState(!1);return I.useEffect(()=>{let P,I=g.getElement();const e=g=>{let L=g.target;if(L!==P){P=L;let g=L.getAttribute?.("data-r-tooltip");for(;L&&L!==I&&!g;)L=L.parentElement,g=L.getAttribute("data-r-tooltip");_(g||"")}};return I.addEventListener("mousemove",e),I.addEventListener("mouseleave",e),()=>{I.removeEventListener("mousemove",e),I.removeEventListener("mouseleave",e)}},[]),I.useEffect(()=>{G(!1);const g=setTimeout(()=>G(!0),10);return()=>clearTimeout(g)},[P]),I.default.createElement("div",{className:L.default("menu-tooltip",{anim:U})},P)})}}}),System.register("gui/screen/mainMenu/component/MenuVideo",["react","util/disposable/CompositeDisposable"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=new Map([["mp4","video/mp4"],["webm","video/webm"]]),U=class extends I.default.Component{constructor(){super(...arguments),this.el=null,this.disposables=new L.CompositeDisposable,this.disposed=!1}render(){const g=this.props.src;let P,L;return"string"==typeof g?(L=g,P=_.get(g.split("?")[0].split(".").pop())??"video/webm"):(L=URL.createObjectURL(g),P=g.type,this.disposables.add(()=>{URL.revokeObjectURL(L)})),I.default.createElement("div",{className:"video-wrapper",ref:g=>this.el=g,dangerouslySetInnerHTML:{__html:`\n            <video style="outline: none;" loop playsinline muted autoplay>\n                <source src="${L}" type="${P}" />\n            </video>\n            <div class="logo" style="opacity: 0;" />\n        `}})}componentDidMount(){const g=this.props.src;let P=this.el.querySelector("video"),I=this.el.querySelector("div");if(g instanceof File&&window.MediaSource){let e=async()=>{this.applyMediaSourceFallback(P,await g.arrayBuffer())};P.querySelector("source").addEventListener("error",e,{once:!0}),P.addEventListener("loadeddata",()=>{P.querySelector("source").removeEventListener("error",e)})}P.addEventListener("loadeddata",()=>{I.style.opacity=""})}async applyMediaSourceFallback(g,P){if(!this.disposed){let I=new MediaSource;I.addEventListener("sourceopen",()=>{try{let L=I.addSourceBuffer('video/webm; codecs="vp8"');L.mode="sequence",L.appendBuffer(P),this.timeoutId=setTimeout(()=>this.processNextSegment(L,g,P),1e3),this.disposables.add(()=>clearTimeout(this.timeoutId))}catch(g){return void("NotSupportedError"!==g.name&&console.error(g))}});let L=g.src=URL.createObjectURL(I);this.disposables.add(()=>{URL.revokeObjectURL(L),L=void 0})}}processNextSegment(g,P,I){try{!g.updating&&0<g.buffered.length&&(g.buffered.end(g.buffered.length-1)-P.currentTime<10&&g.appendBuffer(I),P.paused&&P.play()?.catch(g=>console.error(g)))}catch(g){return void console.error(g)}this.timeoutId=setTimeout(()=>this.processNextSegment(g,P,I),1e3)}componentWillUnmount(){this.disposables.dispose(),this.disposed=!0}},g("MenuVideo",U)}}}),System.register("gui/screen/mainMenu/component/PrefetchProgress",["react"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("PrefetchProgress",({progress:g,statusText:P})=>I.default.createElement("div",{className:"prefetch-progress"},I.default.createElement("div",null,I.default.createElement("label",null,P),I.default.createElement("progress",{value:g,max:100}))))}}}),System.register("gui/screen/mainMenu/component/SidebarPreview",["gui/jsx/jsx","gui/jsx/UiComponent","gui/UiObject","gui/HtmlContainer","gui/screen/mainMenu/component/MenuSdTopAnimRunner","data/IniSection","engine/AnimProps","engine/Animation","engine/animation/SimpleRunner","gui/jsx/HtmlView","gui/screen/mainMenu/component/SidebarTitle","engine/Engine","util/BoxedVar"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g}],execute:function(){Z=class extends L.UiComponent{constructor(){super(...arguments),this.sidebarPreviewNeedsRefresh=!1,this.closed=this.props.closed,this.preview=this.props.preview,this.title=this.props.title}createUiObject(){let g=new _.UiObject(new THREE.Object3D,new U.HtmlContainer);return g.onFrame.subscribe(g=>this.handleFrame(g)),g}defineChildren(){var{sdtpImg:g,sdtpAnimImg:P}=this.props,L=this.closed;let _=this.preview;var U=this.title||"",Z=new V.IniSection("");let X=new W.AnimProps(Z,P);X.loopCount=-1,Z=new z.Animation(X,new Y.BoxedVar(Q.Engine.UI_ANIM_SPEED));let J=new K.SimpleRunner;return J.animation=Z,Z=this.getPreviewSize(),I.jsx("fragment",null,I.jsx("sprite",{image:g,palette:"shell.pal",frame:L?0:1,ref:g=>this.sidebarTop=g}),I.jsx(q.HtmlView,{component:$.SidebarTitle,props:{title:U},innerRef:g=>this.titleView=g,x:25,y:3,width:118,height:this.closed?32:18}),I.jsx("sprite",{image:"sdwrntmp.shp",palette:"shell.pal",hidden:!0,ref:g=>this.sidebarTopPreviewAnim=g,animationRunner:new G.MenuSdTopAnimRunner}),I.jsx("sprite",{image:P,palette:"shell2.pal",x:38,y:48,hidden:!L,ref:g=>this.sidebarTopClosedAnim=g,animationRunner:J}),I.jsx("container",{hidden:!_||L,ref:g=>{this.previewContainer=g,_&&this.previewContainer.add(_)},x:12,y:40,width:Z.width,height:Z.height}))}getPreviewSize(){return{width:146,height:112}}toggleSidebarPreview(g){if(this.closed!==!g){let P=this.sidebarTopPreviewAnim.getAnimationRunner();g?P.slideIn():P.slideOut(),this.closed=!g,this.sidebarPreviewNeedsRefresh=!0,this.sidebarTopPreviewAnim.setVisible(!0),(g?this.sidebarTopClosedAnim:this.previewContainer).setVisible(!1),this.titleView.setVisible(!1),this.updateTitleSize()}}setPreview(g){this.preview&&this.previewContainer.remove(this.preview),g&&this.previewContainer.add(g),this.preview=g}setTitle(g){this.title=g,this.titleView.applyOptions(P=>P.title=g),this.updateTitleSize()}updateTitleSize(){this.titleView.setSize(this.titleView.getSize().width,this.closed?32:18)}handleFrame(g){if(this.sidebarPreviewNeedsRefresh){this.sidebarTopPreviewAnim.getAnimationRunner().isStopped()&&((this.closed?this.sidebarTopClosedAnim:this.previewContainer).setVisible(!0),this.sidebarTopPreviewAnim.setVisible(!1),this.sidebarTop.setFrame(this.closed?0:1),this.titleView.setVisible(!0),this.sidebarPreviewNeedsRefresh=!1)}}},g("SidebarPreview",Z)}}}),System.register("gui/screen/mainMenu/component/SidebarTitle",["react"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("SidebarTitle",({title:g})=>I.default.createElement("div",{className:"sidebar-title"},g))}}}),System.register("gui/screen/mainMenu/component/VersionString",["react"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("VersionString",({value:g})=>I.default.createElement("div",{className:"menu-version-string"},"v",g))}}}),System.register("gui/screen/mainMenu/component/viewmodel/MenuButtonConfig",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("gui/screen/mainMenu/credits/Credits",["react"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("Credits",({contentTpl:g,strings:P})=>{var L=g.replace(/\{([^}]+)\}/g,(g,I)=>P.get(I)).replace(/<([^>]+)>/g,(g,P)=>P.match(/^(https?|mailto):(\/\/)?/)?`<a href='${encodeURI(P)}' target='_blank' rel='noopener'>${encodeURI(P)}</a>`:"").replace(/\t*\r?\n/g,"<br />").replace(/([^>]+)\t+([^<]+)<br \/>/g,"<div class='def'>\n                <span class='title'>$1</span>\n                <span class='filler'></span>\n                <span class='name'>$2</span>\n            </div>");return I.createElement("div",{className:"credits-container"},I.createElement("div",{className:"credits",dangerouslySetInnerHTML:{__html:L}}))})}}}),System.register("gui/screen/mainMenu/credits/CreditsScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/mainMenu/credits/Credits","engine/Engine","gui/screen/mainMenu/MainMenuScreen"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){V=class extends G.MainMenuScreen{constructor(g,P){super(),this.strings=g,this.jsxRenderer=P,this.title=this.strings.get("GUI:Credits")}onEnter(){this.controller.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons(),this.controller.toggleMainVideo(!1);var g=U.Engine.vfs?.openFile("creditscd.txt").readAsString("utf-8")??"";g=(U.Engine.vfs?.openFile("credits.txt").readAsString()??"").replace(/\s+\{CRD:CREDITS\}\s+/,g);var[g]=this.jsxRenderer.render(I.jsx(L.HtmlView,{width:"100%",height:"100%",component:_.Credits,props:{contentTpl:g,strings:this.strings}}));this.controller.setMainComponent(g)}async onLeave(){await this.controller.hideSidebarButtons()}async onStack(){await this.onLeave()}onUnstack(){this.onEnter()}},g("CreditsScreen",V)}}}),System.register("gui/screen/mainMenu/customGame/component/GameBrowser",["react","gui/component/Chat","gui/component/List","gui/component/Image","gui/screen/mainMenu/lobby/component/RankIndicator","gui/component/ChannelUser","network/chat/ChatMessage"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g}],execute:function(){g("GameBrowser",g=>{const[P,U]=I.useState(void 0),G=[{label:g.strings.get("GUI:PlayerMenuMessage"),onClick:P=>{g.chatHistory.lastComposeTarget.value={type:W.ChatRecipientType.Whisper,name:P.name}}}];I.useEffect(()=>{P&&!g.games.find(g=>g.name===P.name)&&a(void 0)},[g.games]);const a=P=>{U(P),g.onSelectGame(P)};let K=g.strings;return I.default.createElement("div",{className:"gamebrowser-wrapper"},I.default.createElement("div",{className:"gamebrowser-top"},I.default.createElement("div",{className:"games"},I.default.createElement("div",{className:"games-header"},I.default.createElement("button",{className:"icon-button refresh-button",onClick:g.onRefreshClick,"data-r-tooltip":K.get("STT:WOLLobbyRefreshChannels")}),I.default.createElement("span",{className:"games-label"},K.get("GUI:OpenGames"))),I.default.createElement(z,{games:g.games,selectedGame:P,mapList:g.mapList,onClickGame:a,onDoubleClickGame:P=>{a(P),g.onDoubleClickGame(P)},tooltip:K.get("STT:LobbyListGames"),strings:K,playerProfiles:g.playerProfiles}))),I.default.createElement("div",{className:"gamebrowser-bottom"},I.default.createElement(L.Chat,{strings:K,messages:g.messages,channels:g.channels??[],chatHistory:g.chatHistory,localUsername:g.localUsername,onSendMessage:g.onSendMessage,tooltips:{input:K.get("STT:LobbyEditInput"),output:K.get("STT:LobbyEditOutput"),button:K.get("STT:EmoteButton")}}),I.default.createElement(_.List,{className:"players-list",tooltip:K.get("STT:LobbyListUsers")},g.users.map(P=>{var L=g.playerProfiles.get(P.name);return I.default.createElement(V.ChannelUser,{key:P.name,user:P,playerProfile:L,strings:K,localUsername:g.localUsername,menuItems:G})}))))}),z=({games:g,selectedGame:P,onClickGame:L,onDoubleClickGame:U,tooltip:G,strings:V,playerProfiles:W,mapList:z})=>I.default.createElement(I.default.Fragment,null,I.default.createElement(_.ListHeader,{className:"game game-list-header"},I.default.createElement("span",{className:"game-flags"},I.default.createElement("span",{className:"game-type"}),I.default.createElement("span",{className:"game-pass-locked"}),I.default.createElement("span",{className:"game-obs"})),I.default.createElement("span",{className:"game-map"},V.get("GUI:Map")),I.default.createElement("span",{className:"game-name"},V.get("GUI:RoomDesc")),I.default.createElement("span",{className:"game-players"},""),I.default.createElement("span",{className:"game-host"},V.get("GUI:HostName")),I.default.createElement("span",{className:"game-ping"},V.get("GUI:Ping"))),I.default.createElement(_.List,{className:"games-list",tooltip:G},g.map((g,_)=>{var G=g.hostPing,q=W.get(g.hostName),$=q?.rank;let Q=z.getByName(g.mapName);var Y=!Q?.official&&g.hostMuted?V.get("GUI:CustomMap"):Q?.getFullMapTitle(V)||g.mapName;return I.default.createElement(K,{key:g.name,game:g,uiMapName:Y,customMap:!Q?.official,ping:G,hostProfile:q,tooltip:[...g.modName?[""+V.get("GUI:GameMod",g.modName)]:[],V.get("TXT_MAP",Y),G?V.get("WOL:GamePing",G):V.get("TXT_UNKNOWN_PING"),...void 0!==$?[V.get("TXT_HOST_RANK")+" "+$]:[]].join(", "),selected:g.name===P?.name,strings:V,onClick:L,onDoubleClick:U})}))),K=({game:g,uiMapName:P,customMap:L,selected:V,tooltip:W,ping:z,hostProfile:K,strings:q,onClick:$,onDoubleClick:Q})=>I.default.createElement(_.ListItem,{key:g.name,className:"game",selected:V,tooltip:W,onClick:()=>$(g),onDoubleClick:()=>Q(g)},I.default.createElement("span",{className:"game-flags"},I.default.createElement("span",{className:"game-type",title:g.modName||!L?""+q.get("GUI:GameMod",g.modName||q.get("GUI:Official")):""+q.get("GUI:CustomMap")},g.modName||L?I.default.createElement(U.Image,{src:"settings.png"}):I.default.createElement(U.Image,{src:g.tournament?"woltrny.pcx":"gt18.pcx"})),I.default.createElement("span",{className:"game-pass-locked"},g.passLocked?I.default.createElement(U.Image,{src:"wolpriv.pcx"}):null),I.default.createElement("span",{className:"game-obs"},g.observable?I.default.createElement(U.Image,{src:"wolob.pcx"}):null)),I.default.createElement("span",{className:"game-map",title:P},P),I.default.createElement("span",{className:"game-name",title:g.hostMuted?void 0:g.description},g.hostMuted?void 0:g.description),I.default.createElement("span",{className:"game-players"},g.maxPlayers?g.humanPlayers+g.aiPlayers+"/"+(g.maxPlayers-(g.observable?1:0)):"?/?"),I.default.createElement("span",{className:"game-host"},g.hostName,void 0!==K&&I.default.createElement(G.RankIndicator,{playerProfile:K,strings:q})),I.default.createElement("span",{className:"game-ping"},z?I.default.createElement("meter",{value:z,max:300,low:100,high:250,optimum:0,title:z+"ms"}):null))}}}),System.register("gui/screen/mainMenu/customGame/component/viewmodel/gameBrowser",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("gui/screen/mainMenu/customGame/CustomGameScreen",["gui/screen/mainMenu/customGame/component/GameBrowser","gui/screen/mainMenu/ScreenType","util/disposable/CompositeDisposable","gui/jsx/jsx","gui/jsx/HtmlView","engine/sound/SoundKey","engine/sound/ChannelType","engine/sound/Music","network/IrcConnection","gui/screen/mainMenu/MainMenuScreen","@puzzl/core/lib/async/Task","@puzzl/core/lib/async/cancellation/OperationCanceledError","network/ladder/wladderConfig","gui/screen/mainMenu/MainMenuRoute","network/chat/ChatMessage","gui/chat/ChatHistory","network/WolError","@puzzl/core/lib/async/cancellation","network/partyCodes"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g}],execute:function(){se=class extends q.MainMenuScreen{constructor(g,P,I,L,U,G,K,q,$,Q){super(),this.engineModHash=g,this.strings=P,this.wolCon=I,this.wolService=L,this.wladderService=U,this.jsxRenderer=G,this.sound=K,this.serverRegions=q,this.mapList=$,this.errorHandler=Q,this.title=this.strings.get("GUI:CustomMatch"),this.musicType=z.MusicType.NormalShuffle,this.partyEnabled=!1,this.playerProfiles=new Map,this.disposables=new _.CompositeDisposable,this.handlePartyUpdate=g=>{if(this.partyEnabled){var P=g.split(" ");P[0]!==re.RPL_PARTY_INVITE||(P=P[1])&&this.wolCon.partyInviteUnavailable(P)}},this.onChannelJoinLeave=g=>{let P=g.channel,I=P.match(/#Lob \d+ (\d)/i);var L;I&&([,L]=I.map(Number),P=this.strings.get("TXT_LOB_"+(L+1))),g.user.name===this.wolCon.getCurrentUser()?this.addSystemMessage(this.strings.get("join"===g.type?"TXT_JOINED_S":"TXT_YOULEFT",P)):g.channel===this.channelName&&("join"===g.type?(this.users.push(g.user),this.users.sort((g,P)=>Number(P.operator)-Number(g.operator))):-1!==(L=this.users.findIndex(P=>P.name===g.user.name))&&this.users.splice(L,1),this.gameBrowser?.refresh())},this.onChannelUsers=g=>{g.channelName===this.channelName&&(this.users=g.users,this.gameBrowser?.applyOptions(g=>g.users=this.users))},this.onChannelMessage=g=>{g.to.type!==X.ChatRecipientType.Page&&g.to.type!==X.ChatRecipientType.Whisper||this.sound.play(V.SoundKey.IncomingMessage,W.ChannelType.Ui);var P={...g,operator:this.users.find(P=>P.name===g.from)?.operator};this.messages.push(P),this.gameBrowser?.refresh(),g.to.type===X.ChatRecipientType.Whisper&&g.to.name!==this.wolCon.getServerName()&&g.from!==this.wolCon.getCurrentUser()&&(this.chatHistory.lastWhisperFrom.value=g.from)},this.onWolClose=()=>{clearInterval(this.refreshTimeoutId)},this.onWolConLost=g=>{this.handleError(g,this.strings.get("TXT_YOURE_DISCON"))}}addSystemMessage(g){this.messages.push({text:g}),this.gameBrowser?.refresh()}async refreshGames(g){if(this.wolCon.isOpen()){if(this.channelName&&this.wolCon.getCurrentUser()){let I;try{var P=this.wolService.getConfig().getClientChannelType();if(I=await this.wolCon.listGames(P,P),g?.isCancelled())return}catch(g){if(g instanceof K.IrcConnection.SocketError)return;if(g instanceof K.IrcConnection.NoReplyError)return;throw g}I.sort((g,P)=>Number(g.passLocked)-Number(P.passLocked)),this.games=I;const L=this.selectedGame;L&&this.onGameSelectionChange(I.find(g=>g.name===L.name)),this.gameBrowser?.applyOptions(g=>g.games=I),this.refreshPlayerRanks()}}else this.onWolClose()}refreshPlayerRanks(){if(this.wladderService.getUrl()){this.ranksUpdateTask?.cancel();let g=this.ranksUpdateTask=new $.Task(async g=>{let P=[...new Set([...this.users.map(g=>g.name),...this.games.map(g=>g.hostName)])].filter(g=>!this.playerProfiles.has(g));if(P.length){for(;0<P.length;){var I,L=P.splice(0,Y.MAX_LIST_SEARCH_COUNT);L=await this.wladderService.listSearch(L,g);if(g.isCancelled())return;for(I of L)this.playerProfiles.set(I.name,I)}this.gameBrowser?.refresh()}});g.start().catch(g=>{g instanceof Q.OperationCanceledError||console.error(g)})}}onGameSelectionChange(g){this.selectedGame=g,this.refreshSidebarButtons()}gameIsFull(g){return g.humanPlayers+g.aiPlayers===g.maxPlayers-(g.observable?1:0)}refreshSidebarButtons(){let g=this.selectedGame;var P=[{label:this.strings.get("GUI:CreateGame"),tooltip:this.strings.get("STT:LobbyButtonNew"),onClick:()=>this.createGame()},{label:this.strings.get("GUI:JoinGame"),tooltip:this.strings.get("STT:LobbyButtonJoin"),disabled:!g||this.gameIsFull(g),onClick:()=>this.joinGame(g)},{label:this.strings.get("GUI:Observe"),tooltip:this.strings.get("STT:LobbyButtonObserve"),disabled:!g||!g.observable||!!g.observers,onClick:()=>{this.observeGame(g)}},...1<this.serverRegions.getSize()?[{label:this.strings.get("GUI:ChangeServer"),tooltip:this.strings.get("STT:ChangeServer"),onClick:()=>{this.wolService.closeWolConnection(),this.controller?.goToScreen(L.ScreenType.Login,{clearCredentials:!0,afterLogin:g=>new Z.MainMenuRoute(L.ScreenType.CustomGame,{messages:g})})}}]:[],{label:this.strings.get("GUI:Back"),tooltip:this.strings.get("STT:LobbyButtonBack"),isBottom:!0,onClick:()=>{this.wolService.closeWolConnection(),this.controller?.goToScreen(L.ScreenType.Home)}}];this.controller.setSidebarButtons(P)}initView(g){var[P]=this.jsxRenderer.render(U.jsx(G.HtmlView,{innerRef:g=>this.gameBrowser=g,component:I.GameBrowser,props:{strings:this.strings,messages:this.messages,chatHistory:this.chatHistory,channels:[this.channelName],localUsername:this.wolCon.getCurrentUser(),users:this.users,games:this.games,playerProfiles:this.playerProfiles,mapList:this.mapList,onSendMessage:g=>{g.value.length?this.wolCon.isOpen()&&(this.wolCon.sendChatMessage(g.value,g.recipient),g.recipient.type===X.ChatRecipientType.Whisper&&(this.chatHistory.lastWhisperTo.value=g.recipient.name)):this.addSystemMessage(this.strings.get("TXT_ENTER_MESSAGE"))},onRefreshClick:()=>this.refreshGames(g),onSelectGame:g=>this.onGameSelectionChange(g),onDoubleClickGame:g=>{this.gameIsFull(g)||this.joinGame(g)}}}));this.controller.setMainComponent(P),this.refreshSidebarButtons(),this.controller.showSidebarButtons()}async onEnter(g){this.messages=g?.messages??[],this.partyEnabled=this.resolvePartyEnabled(),this.wolCon.setPartyEnabled?.(this.partyEnabled),this.chatHistory=new J.ChatHistory,this.controller.toggleMainVideo(!1);let P=new te.CancellationTokenSource;this.disposables.add(()=>P.cancel());var I=P.token;this.wolCon.getCurrentUser()?await this.loadChannel(I):this.controller.goToScreen(L.ScreenType.Login,{afterLogin:g=>new Z.MainMenuRoute(L.ScreenType.CustomGame,{messages:g})})}async loadChannel(g){this.channelName=void 0,this.users=[],this.games=[],this.selectedGame=void 0,this.wolCon.onJoinChannel.subscribe(this.onChannelJoinLeave),this.wolCon.onLeaveChannel.subscribe(this.onChannelJoinLeave),this.wolCon.onChannelUsers.subscribe(this.onChannelUsers),this.wolCon.onChatMessage.subscribe(this.onChannelMessage),this.wolCon.onClose.subscribe(this.onWolClose),this.partyEnabled&&this.wolCon.onPartyUpdate.subscribe(this.handlePartyUpdate),this.wolService.onWolConnectionLost.subscribe(this.onWolConLost);try{let I=this.wolService.getConfig();var P=`#Lob ${I.getClientChannelType()} 0`;if(await this.wolCon.joinChannel(P,I.getGlobalChannelPass()),g.isCancelled())return;this.channelName=P,this.playerProfiles.clear(),this.initView(g),this.gameBrowser?.applyOptions(g=>g.users=this.users),this.refreshGames(g),this.refreshTimeoutId=setInterval(()=>this.refreshGames(g),5e3)}catch(g){let I=this.strings.get("WOL:MatchBadParameters");if(g instanceof ee.WolError){(P=(new Map).set(ee.WolError.Code.NoSuchChannel,"WOL:ChannelJoinFailure").set(ee.WolError.Code.BadChannelPass,"TXT_BADPASS").set(ee.WolError.Code.ChannelFull,"TXT_CHANNEL_FULL").set(ee.WolError.Code.BannedFromChannel,"TXT_JOINBAN").get(g.code))&&(I=this.strings.get(P))}return void this.handleError(g,I)}}async onLeave(){this.disposables.dispose(),this.refreshTimeoutId&&clearInterval(this.refreshTimeoutId),this.ranksUpdateTask&&(this.ranksUpdateTask.cancel(),this.ranksUpdateTask=void 0),this.wolCon.isOpen()&&this.channelName&&this.wolCon.leaveChannel(this.channelName),this.wolCon.onJoinChannel.unsubscribe(this.onChannelJoinLeave),this.wolCon.onLeaveChannel.unsubscribe(this.onChannelJoinLeave),this.wolCon.onChannelUsers.unsubscribe(this.onChannelUsers),this.wolCon.onChatMessage.unsubscribe(this.onChannelMessage),this.wolCon.onClose.unsubscribe(this.onWolClose),this.partyEnabled&&this.wolCon.onPartyUpdate.unsubscribe(this.handlePartyUpdate),this.wolService.onWolConnectionLost.unsubscribe(this.onWolConLost),await this.controller.hideSidebarButtons(),this.channelName=void 0,this.gameBrowser=void 0,this.messages=[],this.users=[],this.playerProfiles.clear(),this.games=[],this.selectedGame=void 0}async createGame(){this.controller.goToScreen(L.ScreenType.Lobby,{create:!0})}async joinGame(g){this.joinRoom(g,!1)}observeGame(g){this.joinRoom(g,!0)}joinRoom(g,P){g.modHash===this.engineModHash?this.controller.goToScreen(L.ScreenType.Lobby,{game:g,observe:P}):void 0!==g.modHash&&this.addSystemMessage(this.strings.get("TXT_MISMATCH"))}handleError(g,P){this.errorHandler.handle(g,P,()=>{this.wolService.closeWolConnection(),this.controller?.goToScreen(L.ScreenType.Home)}),clearInterval(this.refreshTimeoutId)}resolvePartyEnabled(){try{return!!this.serverRegions?.getSelectedRegion?.()?.partyEnabled}catch(g){return!1}}},g("CustomGameScreen",se)}}}),System.register("gui/screen/mainMenu/infoAndCredits/InfoAndCreditsScreen",["react","gui/screen/mainMenu/main/ReportBug","gui/screen/mainMenu/MainMenuScreen","gui/screen/mainMenu/ScreenType"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=class extends _.MainMenuScreen{constructor(g,P,I){super(),this.strings=g,this.config=P,this.messageBoxApi=I,this.title=this.strings.get("TS:InfoAndCredits")}onEnter(){let g=this.strings;const P=this.config.discordUrl,_=this.config.donateUrl;this.controller.setSidebarButtons([...this.controller.hasScreen(U.ScreenType.PatchNotes)?[{label:g.get("TS:PatchNotes"),tooltip:g.get("STT:PatchNotes"),onClick:()=>{this.controller?.pushScreen(U.ScreenType.PatchNotes)}}]:[],...P?[{label:g.get("TS:ReportBug"),tooltip:g.get("TS:ReportBugTT"),onClick:()=>{this.messageBoxApi.show(I.createElement(L.ReportBug,{discordUrl:P,strings:this.strings}),this.strings.get("GUI:OK"))}}]:[],..._?[{label:g.get("TS:Donate"),onClick:()=>{window.open(_,"_blank"),window.gtag?.("event","donate_click")}}]:[],{label:g.get("GUI:ViewCredits"),onClick:()=>{this.controller?.pushScreen(U.ScreenType.Credits)}},{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons(),this.controller.toggleMainVideo(!0),this.controller.setMainComponent()}async onLeave(){await this.controller.hideSidebarButtons()}async onStack(){await this.onLeave()}onUnstack(){this.onEnter()}},g("InfoAndCreditsScreen",G)}}}),System.register("gui/screen/mainMenu/ladder/component/Ladder",["react","classnames","gui/screen/mainMenu/lobby/component/RankIndicator","gui/component/Select","gui/component/Option","network/ladder/wladderConfig","gui/component/List","network/ladder/WLadderService"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q;function j(g,P){return g===z.WLadderService.CURRENT_SEASON?P.get("GUI:LadderCurrent"):g===z.WLadderService.PREV_SEASON?P.get("GUI:LadderPrev"):P.get("GUI:LadderSeason",g)}function D(g){return new Date(g).toLocaleDateString(void 0,{dateStyle:"medium"})}function F(g){return new Date(g).toLocaleTimeString(void 0,{timeStyle:"short"})}return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g}],execute:function(){K=new Map([[V.LadderType.Solo1v1,"gui:laddertype1v1"],[V.LadderType.Random2v2,"gui:laddertype2v2random"]]),g("Ladder",({players:g,highlightPlayer:P,hasPrevPage:_,hasNextPage:V,seasons:z,selectedSeason:$,seasonDetails:Q,ladders:Y,selectedLadder:Z,serverRegion:X,disabled:J,strings:ee,onFirstPageClick:te,onPrevPageClick:re,onNextPageClick:se,onLastPageClick:ae,onPlayerSearch:ne,onSeasonSelect:oe,onLadderSelect:le,onLadderTypeSelect:ce})=>{if(!g)return I.createElement("div",{className:"ladder"},ee.get("GUI:LoadingEx"));const he=I.useRef(null),[ue,de]=I.useState(!Z);I.useEffect(()=>{de(!Z)},[Z]);const E=g=>g.type+"_"+g.id;var ge=g.some(g=>void 0!==g.mmr),pe=g.some(g=>void 0!==g.points);let me=Z?.type,fe=[...new Set(Q?.ladders.map(g=>g.type)??(me?[me]:void 0))];var ye=Q?.totalRankedPlayers.find(g=>g.ladderType===me)?.value;return I.createElement("div",{className:"ladder"},I.createElement("div",{className:L.default("toolbar",{"no-season-select":!z||z.length<2})},void 0!==z&&0<z.length&&I.createElement(U.Select,{disabled:J,initialValue:$??z[0],onSelect:oe,className:"season-select"},z.map(g=>I.createElement(G.Option,{key:g,label:j(g,ee),value:g}))),!ue&&I.createElement(I.Fragment,null,void 0!==Y&&0<Y.length&&I.createElement(U.Select,{disabled:J,initialValue:E(Z??Y[0]),onSelect:g=>{let{type:P,id:I}=(g=>{var[P,I]=g.split("_");return{type:P,id:Number(I)}})(g);var L=Y?.find(g=>g.id===I&&g.type===P);L&&le(L)},className:"ladder-select"},Y.map(g=>I.createElement(G.Option,{key:g.type+"_"+g.id,label:g.name+(g.divisionName?", "+ee.get("GUI:LadderDivision",g.divisionName):""),value:E(g)})),ye?I.createElement(G.Option,{label:ee.get("GUI:LadderRankedPlayers",ye),disabled:!0,value:""}):void 0),I.createElement("form",{className:"player-search",onSubmit:g=>{g.preventDefault(),he.current?.value&&(ne(he.current.value),he.current.value="")}},I.createElement("input",{className:"player",type:"text",disabled:J,ref:he,placeholder:ee.get("GUI:Player")}),I.createElement("button",{type:"submit",disabled:J},ee.get("GUI:Search"))))),I.createElement("div",{className:"ladder-content"},I.createElement(W.List,{className:"ladder-types"},I.createElement(W.ListItem,{selected:ue,disabled:J,onClick:()=>de(!0)},ee.get("gui:ladderseasoninfo")),fe.map(g=>I.createElement(W.ListItem,{key:g,selected:!ue&&me===g,disabled:J,onClick:()=>{de(!1),ce(g)}},ee.get(K.get(g)??g)))),ue&&Q?I.createElement("div",{className:"season-info"},I.createElement("header",null,I.createElement("h2",null,j(Q.name,ee)),void 0!==Q.startTime&&void 0!==Q.endTime&&I.createElement("p",null,D(Q.startTime)+" - "+D(Q.endTime))),void 0!==Q.topTierStartTime&&I.createElement("div",{className:"item"},I.createElement("span",{className:"label"},ee.get("gui:laddertoptierstart")),I.createElement("span",{className:"label"},D(Q.topTierStartTime))),void 0!==Q.nextTopTierDemoteTime&&I.createElement("div",{className:"item"},I.createElement("span",{className:"label"},ee.get("gui:laddertoptierdemotions")),I.createElement("span",{className:"label"},F(Q.nextTopTierDemoteTime))),void 0!==Q.nextTopTierPromoteTime&&I.createElement("div",{className:"item"},I.createElement("span",{className:"label"},ee.get("gui:laddertoptierpromotions")),I.createElement("span",{className:"label"},F(Q.nextTopTierPromoteTime))),void 0!==Q.lockTime&&I.createElement("div",{className:"item"},I.createElement("span",{className:"label"},ee.get("gui:ladderseasonlock")),I.createElement("span",{className:"value"},D(Q.lockTime)))):I.createElement(q,{players:g,highlightPlayer:P,ladderType:Z?.type??Y?.[0].type,region:X,season:$,showPoints:pe,showMmr:ge,strings:ee,hasPrevPage:_,hasNextPage:V,disabled:J,onFirstPageClick:te,onPrevPageClick:re,onNextPageClick:se,onLastPageClick:ae})))}),q=({players:g,highlightPlayer:P,ladderType:U,region:G,season:V,showPoints:W,showMmr:K,strings:q,hasPrevPage:$,hasNextPage:Q,disabled:Y,onFirstPageClick:Z,onPrevPageClick:X,onNextPageClick:J,onLastPageClick:ee})=>I.createElement("div",{className:"ladder-table"},I.createElement("table",null,I.createElement("thead",null,I.createElement("tr",null,I.createElement("th",{className:"player-rank"},"#"),I.createElement("th",{className:"player-rank-icon"},q.get("GUI:Rank")),I.createElement("th",{className:"player-name"},q.get("GUI:Name")),W&&I.createElement("th",{className:"player-points"},q.get("GUI:Points")),K&&I.createElement("th",{className:"player-mmr"},q.get("GUI:MMR")),I.createElement("th",{className:"player-wins"},q.get("GUI:NumberWins")),I.createElement("th",{className:"player-losses"},q.get("GUI:NumberLosses")))),I.createElement("tbody",null,g.map(g=>I.createElement("tr",{key:g.name,className:L.default({selected:P?.toLowerCase()===g.name.toLowerCase(),disabled:void 0===g.points&&!g.wins&&!g.losses&&!g.draws})},I.createElement("td",{className:"player-rank"},g.rank),I.createElement("td",{className:"player-rank-icon"},I.createElement(_.RankIndicator,{playerProfile:g,strings:q})),I.createElement("td",{className:"player-name"},(()=>{var P,L,_,W=G&&U&&V===z.WLadderService.CURRENT_SEASON?(P=g.name,_=U,(L=G).leaderboardUrl?`${L.leaderboardUrl}/player/${L.id}/${_}/`+P:void 0):void 0;return W?I.createElement("a",{href:W,target:"_blank",rel:"noopener"},g.name):g.name})()),W&&I.createElement("td",{className:"player-points"},g.points),K&&I.createElement("td",{className:"player-mmr"},g.mmr),I.createElement("td",{className:"player-wins"},g.wins),I.createElement("td",{className:"player-losses"},g.losses??0))))),($||Q)&&I.createElement("div",{className:"pagination"},I.createElement("button",{className:"first-page",disabled:!$||Y,onClick:Z},"<<"),I.createElement("button",{className:"prev-page",disabled:!$||Y,onClick:X},"<"),I.createElement("button",{className:"next-page",disabled:!Q||Y,onClick:J},">"),I.createElement("button",{className:"last-page",disabled:!Q||Y,onClick:ee},">>")))}}}),System.register("gui/screen/mainMenu/ladder/LadderScreen",["@puzzl/core/lib/async/cancellation","@puzzl/core/lib/async/Task","gui/jsx/HtmlView","gui/jsx/jsx","network/ladder/wladderConfig","network/ladder/WLadderService","util/disposable/CompositeDisposable","gui/screen/mainMenu/MainMenuScreen","gui/screen/mainMenu/ladder/component/Ladder","network/HttpRequest"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g}],execute:function(){$=class d extends z.MainMenuScreen{constructor(g,P,I,L,_,U,G){super(),this.wladderService=g,this.jsxRenderer=P,this.errorHandler=I,this.messageBoxApi=L,this.serverRegions=_,this.strings=U,this.clientLocale=G,this.title=this.strings.get("GUI:Ladder"),this.disposables=new W.CompositeDisposable}async onEnter(g){this.ladder=void 0,this.isBusy=!1,this.season=V.WLadderService.CURRENT_SEASON,this.selectedLadderType=g.ladderType,this.selectedLadder=g.highlightPlayer?.ladder,this.selectedPlayer=g.highlightPlayer,this.startIndex=this.computePageStartIndex(g.highlightPlayer?.rank),this.initSidebar(),this.initView();try{await this.fetchInitial(this.selectedLadderType,this.season,this.selectedLadder,g.highlightPlayer,this.startIndex)}catch(g){g instanceof I.OperationCanceledError||this.handleError(g,this.strings.get("TS:DownloadFailed"),{fatal:!0})}}computePageStartIndex(g){let P=1;return void 0!==g&&(P+=Math.floor((g-1)/d.PLAYERS_PER_PAGE)*d.PLAYERS_PER_PAGE),P}initSidebar(){this.controller?.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.popScreen()}}]),this.controller?.showSidebarButtons()}async fetchInitial(g,P,I,L,_){await this.runTaskAsync(async U=>{let G=await this.wladderService.getSeasons(U),V=await this.wladderService.getSeason(P,this.clientLocale,U);this.seasonDetails=V,this.selectedLadderType&&!V.ladders.some(g=>g.type===this.selectedLadderType)&&(this.selectedLadderType=V.ladders[0]?.type);let W=this.buildLadderList(g,V,I);if(I=this.selectedLadder=I?W.find(g=>g.id===I.id):void 0)try{var z=await this.wladderService.rungSearch(_,d.PLAYERS_PER_PAGE+1,g,P,I.id,U);this.updateView({head:I,players:z,start:_},L,V,W)}catch(U){if(!(U instanceof q.DownloadError&&404===U.statusCode))throw U;this.updateView(void 0,L,V,W)}else this.updateView(void 0,L,V,W);1<G.length&&this.ladder?.applyOptions(g=>{g.seasons=G})})}buildLadderList(g,P,I,L){let _=P.ladders.filter(P=>P.type===g);I&&!_.some(g=>g.id===I.id)&&_.push(I);let U=L?.ladder;return U&&U!==I&&!_.some(g=>g.id===U.id)&&_.push(U),_}fetchSeasonLadder(g,P,L,_){this.runTaskAsync(async I=>{let U,V,W=this.seasonDetails;if("season"===_&&(W=await this.wladderService.getSeason(g,this.clientLocale,I),this.seasonDetails=W,this.selectedLadderType&&!W.ladders.some(g=>g.type===this.selectedLadderType)&&(this.selectedLadderType=W.ladders[0]?.type)),"ladder"!==_&&L){var z="string"==typeof L?L:L.name;if((this.selectedLadderType||W?.ladders.some(g=>g.type===G.LadderType.Solo1v1))&&([U]=await this.wladderService.listSearch([z],I,this.selectedLadderType,g,this.clientLocale)),"search"===_){if(!U||!U.rank)return void this.messageBoxApi.show(this.strings.get("TXT_NOT_IN_LADDER"),this.strings.get("GUI:OK"));this.selectedPlayer=U}else U&&(this.selectedPlayer=U);P=U?.ladder}if(W&&(V=this.buildLadderList(this.selectedLadderType,W,P,U??("ladder"===_?this.selectedPlayer:void 0)),P=this.selectedLadder=P?V.find(g=>g.id===P.id):V[0]),P){let L=1;U&&(L=this.computePageStartIndex(U.rank)),z=await this.wladderService.rungSearch(L,d.PLAYERS_PER_PAGE+1,this.selectedLadderType,g,P.id,I),this.updateView({head:P,players:z,start:L},U??this.selectedPlayer,this.seasonDetails,V)}else this.updateView(void 0,U??this.selectedPlayer,this.seasonDetails,V)}).catch(g=>{g instanceof I.OperationCanceledError||this.handleError(g,this.strings.get("TS:DownloadFailed"))})}fetchLadderPage(g){this.runTaskAsync(async P=>{var I;void 0!==this.selectedLadder&&(I=await this.wladderService.rungSearch(g,d.PLAYERS_PER_PAGE+1,this.selectedLadderType,this.season,this.selectedLadder.id,P),this.updateView({head:this.selectedLadder,players:I,start:g},this.selectedPlayer))}).catch(g=>{g instanceof I.OperationCanceledError||this.handleError(g,this.strings.get("TS:DownloadFailed"))})}async runTaskAsync(g){this.asyncTask?.cancel();let P=this.asyncTask=new L.Task(g);try{this.isBusy=!0,this.ladder?.applyOptions(g=>g.disabled=!0),await P.start()}finally{this.isBusy=!1,this.ladder?.applyOptions(g=>g.disabled=!1)}return P}initView(){var[g]=this.jsxRenderer.render(U.jsx(_.HtmlView,{component:K.Ladder,innerRef:g=>this.ladder=g,props:{players:void 0,highlightPlayer:this.selectedPlayer?.name,hasPrevPage:!1,hasNextPage:!1,seasons:void 0,selectedSeason:this.season,seasonDetails:this.seasonDetails,ladders:void 0,selectedLadder:this.selectedLadder,strings:this.strings,serverRegion:this.serverRegions.getSelectedRegion(),disabled:this.isBusy,onFirstPageClick:()=>{this.ladder&&this.fetchLadderPage(1)},onPrevPageClick:()=>{this.ladder&&this.fetchLadderPage(Math.max(1,this.startIndex-d.PLAYERS_PER_PAGE))},onNextPageClick:()=>{this.ladder&&this.fetchLadderPage(this.startIndex+d.PLAYERS_PER_PAGE)},onLastPageClick:()=>{this.ladder&&void 0!==this.totalCount&&this.fetchLadderPage(this.computePageStartIndex(this.totalCount))},onPlayerSearch:g=>{this.ladder&&this.fetchSeasonLadder(this.season,this.selectedLadder,g,"search")},onSeasonSelect:g=>{this.season=g,this.ladder&&this.fetchSeasonLadder(g,this.selectedLadder,this.selectedPlayer,"season")},onLadderSelect:g=>{this.selectedLadder=g,this.ladder&&this.fetchSeasonLadder(this.season,g,this.selectedPlayer,"ladder")},onLadderTypeSelect:g=>{this.selectedLadderType=g,this.selectedLadder=void 0,this.ladder&&this.fetchSeasonLadder(this.season,this.selectedLadder,this.selectedPlayer,"type")}}}));this.controller?.setMainComponent(g)}updateView(g,P,I,L){this.startIndex=g?.start??0,this.totalCount=g?.players.totalCount??0,this.ladder?.applyOptions(_=>{I&&(_.seasonDetails=I,_.selectedSeason=this.season),L&&(_.ladders=L),_.selectedLadder=g?.head,_.highlightPlayer=P?.name,_.players=g?.players.records.slice(0,d.PLAYERS_PER_PAGE)??[],_.hasPrevPage=1<this.startIndex,_.hasNextPage=(g?.players.records.length??0)>d.PLAYERS_PER_PAGE})}handleError(g,P,{fatal:I}={}){this.errorHandler.handle(g,P,()=>{I&&this.controller?.popScreen()})}async onLeave(){this.disposables.dispose(),this.ladder=void 0,this.asyncTask&&(this.asyncTask.cancel(),this.asyncTask=void 0),await(this.controller?.hideSidebarButtons())}},g("LadderScreen",$),$.PLAYERS_PER_PAGE=20}}}),System.register("gui/screen/mainMenu/ladderRules/LadderRulesScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/mainMenu/MainMenuScreen","gui/screen/mainMenu/component/Iframe"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=class extends _.MainMenuScreen{constructor(g,P,I){super(),this.strings=g,this.jsxRenderer=P,this.rulesUrl=I,this.title=this.strings.get("GUI:Rules")}onEnter(){this.controller.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons(),this.controller.toggleMainVideo(!1);var[g]=this.jsxRenderer.render(I.jsx(L.HtmlView,{width:"100%",height:"100%",component:U.Iframe,props:{src:this.rulesUrl,className:"ladder-rules"}}));this.controller.setMainComponent(g)}async onLeave(){await this.controller.hideSidebarButtons()}async onStack(){await this.onLeave()}onUnstack(){this.onEnter()}},g("LadderRulesScreen",G)}}}),System.register("gui/screen/mainMenu/lobby/component/CreateGameBox",["react","gui/component/Dialog","network/WolConnection"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("CreateGameBox",({strings:g,viewport:P,onSubmit:U,onDismiss:G})=>{let[V,W]=I.useState(!1),[z,K]=I.useState(""),q=I.useRef(null),$=I.useRef(null),[Q,Y]=I.useState(!1),Z=I.useRef(null);return I.default.createElement(L.Dialog,{className:"login-box create-game-box",hidden:V,viewport:P,buttons:[{label:g.get("GUI:Ok"),onClick:()=>$.current?.click()},{label:g.get("GUI:Cancel"),onClick:()=>{W(!0),G?.()}}],zIndex:100},I.default.createElement("form",{onSubmit:g=>{g.preventDefault(),W(!0),U(z,Q?q.current.value:"",Z.current.checked)},autoComplete:"off"},I.default.createElement("div",{className:"field"},I.default.createElement("label",null,g.get("GUI:RoomDesc")),I.default.createElement("input",{name:"roomname",type:"text",value:z,maxLength:_.WolConnection.MAX_ROOM_DESC_LEN,onChange:g=>{K(g.target.value)}})),I.default.createElement("div",{className:"field"},I.default.createElement("label",null,g.get("GUI:Password")),I.default.createElement("input",{name:"enablepass",type:"checkbox",checked:Q,onChange:()=>{Y(!Q)}}),I.default.createElement("input",{name:"lobbypass",type:"password",autoComplete:"off","data-lpignore":"true",ref:q,disabled:!Q,required:Q})),I.default.createElement("div",{className:"field"},I.default.createElement("label",null,g.get("GUI:Observe")),I.default.createElement("input",{type:"checkbox",name:"test",ref:Z})),I.default.createElement("button",{type:"submit",ref:$,style:{visibility:"hidden"}})))})}}}),System.register("gui/screen/mainMenu/lobby/component/LobbyForm",["react","classnames","gui/screen/mainMenu/lobby/component/viewmodel/lobby","gui/component/Slider","gui/component/Chat","gui/component/CountrySelect","gui/component/ColorSelect","gui/component/PingIndicator","game/gameopts/GameOpts","gui/component/Image","gui/component/StartPosSelect","gui/component/TeamSelect","game/gameopts/constants","gui/component/Select","gui/component/Option","util/typeGuard","gui/screen/mainMenu/lobby/component/RankIndicator"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g}],execute:function(){te=class extends I.default.Component{constructor(){super(...arguments),this.onPlayerSelect=(g,P)=>{let I,L;g.match(/^\d+$/)?I=Number(g):(I=_.SlotOccupation.Occupied,L=K.AiDifficulty[g]),this.props.onSlotChange(I,P,L)}}render(){let{strings:g,lobbyType:P,mpDialogSettings:V}=this.props;var W=P===_.LobbyType.Singleplayer||P===_.LobbyType.MultiplayerHost,z=P===_.LobbyType.Singleplayer;let K=this.props;return I.default.createElement("div",{className:L.default("lobby-form",{"lobby-form-sp":z,"lobby-form-server-sel":K.selectedGameServer})},K.selectedGameServer&&I.default.createElement("div",{className:"game-server"},I.default.createElement("span",{className:"label"},g.get("TS:ServerLabel")),I.default.createElement(Z.Select,{initialValue:K.selectedGameServer,disabled:!0},I.default.createElement(X.Option,{label:K.selectedGameServer,value:K.selectedGameServer}))),I.default.createElement("div",{className:"player-slots"},I.default.createElement("div",{className:"player-slot player-slot-header"},I.default.createElement("div",{className:"player-header-players"},g.get("GUI:Players")),I.default.createElement("div",{className:"player-header-side"},g.get("GUI:Side")),I.default.createElement("div",{className:"player-header-color"},g.get("GUI:Color")),I.default.createElement("div",{className:"player-header-position"},g.get("GUI:StartPosition")),I.default.createElement("div",{className:"player-header-team"},g.get("GUI:Team"))),K.playerSlots.map((g,P)=>this.renderPlayerSlot(K,g,P))),I.default.createElement("div",{className:"game-options"},I.default.createElement("div",{className:"game-options-left"},I.default.createElement("div",{"data-r-tooltip":g.get("STT:HostCBoxShortGame")},I.default.createElement("label",null,I.default.createElement("input",{type:"checkbox",name:"shortGame",checked:K.shortGame,onChange:g=>this.props.onToggleShortGame(g.target.checked),disabled:!W})," ",I.default.createElement("span",null,g.get("GUI:ShortGame")))),I.default.createElement("div",{"data-r-tooltip":g.get("STT:HostCBoxRedeploys")},I.default.createElement("label",null,I.default.createElement("input",{type:"checkbox",name:"mcvRepacks",checked:K.mcvRepacks,onChange:g=>this.props.onToggleMcvRepacks(g.target.checked),disabled:!W})," ",I.default.createElement("span",null,g.get("GUI:MCVRepacks")))),I.default.createElement("div",{"data-r-tooltip":g.get("STT:HostCBoxCrates")},I.default.createElement("label",null,I.default.createElement("input",{type:"checkbox",name:"cratesAppear",checked:K.cratesAppear,onChange:g=>this.props.onToggleCratesAppear(g.target.checked),disabled:!W})," ",I.default.createElement("span",null,g.get("GUI:CratesAppear")))),I.default.createElement("div",{"data-r-tooltip":g.get("STT:HostCBoxSWAllowed")},I.default.createElement("label",null,I.default.createElement("input",{type:"checkbox",name:"superWeapons",checked:K.superWeapons,onChange:g=>this.props.onToggleSuperWeapons(g.target.checked),disabled:!W})," ",I.default.createElement("span",null,g.get("GUI:SuperWeaponsAllowed")))),void 0!==K.hostTeams&&I.default.createElement("div",{"data-r-tooltip":g.get("STT:HostCBoxHostTeams")},I.default.createElement("label",null,I.default.createElement("input",{type:"checkbox",name:"hostTeams",checked:K.hostTeams,onChange:g=>this.props.onToggleHostTeams?.(g.target.checked),disabled:!W})," ",I.default.createElement("span",null,g.get("GUI:HostTeams")))),I.default.createElement("div",{"data-r-tooltip":g.get("STT:DestroyableBridges")},I.default.createElement("label",null,I.default.createElement("input",{type:"checkbox",name:"destBridges",checked:K.destroyableBridges,onChange:g=>this.props.onToggleDestroyableBridges?.(g.target.checked),disabled:!W})," ",I.default.createElement("span",null,g.get("GUI:DestroyableBridges")))),I.default.createElement("div",{"data-r-tooltip":g.get("STT:MultiEngineer",K.multiEngineerCount)},I.default.createElement("label",null,I.default.createElement("input",{type:"checkbox",name:"multiEngineer",checked:K.multiEngineer,onChange:g=>this.props.onToggleMultiEngineer?.(g.target.checked),disabled:!W})," ",I.default.createElement("span",null,g.get("GUI:MultiEngineer")))),I.default.createElement("div",{"data-r-tooltip":g.get("STT:NoDogEngiKills")},I.default.createElement("label",null,I.default.createElement("input",{type:"checkbox",name:"noDogEngiKills",checked:K.noDogEngiKills,onChange:g=>this.props.onToggleNoDogEngiKills?.(g.target.checked),disabled:!W})," ",I.default.createElement("span",null,g.get("GUI:NoDogEngiKills"))))),I.default.createElement("div",{className:"game-options-right"+(W?"":" all-disabled")},I.default.createElement("div",{className:"slider-item"},I.default.createElement("span",{className:"label"},g.get("GUI:GameSpeed")),I.default.createElement(U.Slider,{name:"gameSpeed",min:0,max:6,value:""+K.gameSpeed,disabled:!W,"data-r-tooltip":g.get("STT:HostSliderSpeed"),onChange:g=>this.props.onChangeGameSpeed(Number(g.target.value))})),I.default.createElement("div",{className:"slider-item"},I.default.createElement("span",{className:"label"},g.get("GUI:Credits")),I.default.createElement(U.Slider,{name:"credits",min:V.minMoney,max:V.maxMoney,step:V.moneyIncrement,value:""+K.credits,"data-r-tooltip":g.get("STT:HostSliderCredits"),onChange:g=>this.props.onChangeCredits(Number(g.target.value)),disabled:!W})),I.default.createElement("div",{className:"slider-item"},I.default.createElement("span",{className:"label"},g.get("GUI:UnitCount")),I.default.createElement(U.Slider,{name:"unitCount",min:V.minUnitCount,max:V.maxUnitCount,value:""+K.unitCount,"data-r-tooltip":g.get("STT:HostSliderUnit"),onChange:g=>this.props.onChangeUnitCount(Number(g.target.value)),disabled:!W})),I.default.createElement("div",{className:"checkbox-item","data-r-tooltip":g.get("STT:HostCBoxBuildOffAlly")},I.default.createElement("label",null,I.default.createElement("input",{type:"checkbox",name:"buildOffAlly",checked:K.buildOffAlly,disabled:!W,onChange:g=>this.props.onToggleBuildOffAlly(g.target.checked)})," ",I.default.createElement("span",null,g.get("GUI:BuildOffAlly")))))),void 0!==this.props.messages&&void 0!==this.props.localUsername&&this.props.onSendMessage&&I.default.createElement(G.Chat,{messages:this.props.messages,localUsername:this.props.localUsername,channels:this.props.channels??[],chatHistory:this.props.chatHistory,onSendMessage:this.props.onSendMessage,tooltips:{button:g.get("STT:EmoteButton"),input:W?g.get("STT:HostEditInput"):g.get("STT:GuestEditInput"),output:W?g.get("STT:HostEditOutput"):g.get("STT:GuestEditOutput")},strings:g}))}renderPlayerSlot(g,P,L){const U=g.strings;var G=g.lobbyType===_.LobbyType.Singleplayer||g.lobbyType===_.LobbyType.MultiplayerHost;return P?I.default.createElement("div",{className:"player-slot",key:"playerslot"+L},P.type===_.SlotType.Player?I.default.createElement(ee.RankIndicator,{playerProfile:P.playerProfile,strings:U}):I.default.createElement(ee.RankIndicator,{playerProfile:void 0,strings:U}),I.default.createElement(z.PingIndicator,{ping:P.type===_.SlotType.Player?P.ping:void 0,strings:U}),I.default.createElement("div",{className:"player-status","data-r-tooltip":U.get("STT:HostPictureAcceptance")},this.renderPlayerStatus(P.status)),this.renderPlayerSelect(P,L,g.lobbyType),I.default.createElement(V.CountrySelect,{countryUiNames:g.countryUiNames,countryUiTooltips:g.countryUiTooltips,country:P.country,availableCountries:g.availablePlayerCountries,disabled:L!==g.activeSlotIndex&&(!G||P.type!==_.SlotType.Ai)||P.type===_.SlotType.Observer||P.status===_.PlayerStatus.Ready&&P.type!==_.SlotType.Ai,strings:g.strings,onSelect:g=>this.props.onCountrySelect(g,L)}),P.type!==_.SlotType.Observer?I.default.createElement(I.default.Fragment,null,I.default.createElement(W.ColorSelect,{color:P.color,availableColors:g.availablePlayerColors,disabled:L!==g.activeSlotIndex&&(!G||P.type!==_.SlotType.Ai)||P.status===_.PlayerStatus.Ready&&P.type!==_.SlotType.Ai,strings:g.strings,onSelect:g=>this.props.onColorSelect(g,L)}),I.default.createElement($.StartPosSelect,{disabled:g.hostTeams?!G||P.occupation!==_.SlotOccupation.Occupied:L!==g.activeSlotIndex&&(!G||P.type!==_.SlotType.Ai)||P.status===_.PlayerStatus.Ready&&P.type!==_.SlotType.Ai,startPos:P.startPos,availableStartPositions:g.availableStartPositions,onSelect:g=>this.props.onStartPosSelect(g,L),strings:g.strings}),I.default.createElement(Q.TeamSelect,{disabled:!g.teamsAllowed||(g.hostTeams?!G||P.occupation!==_.SlotOccupation.Occupied:L!==g.activeSlotIndex&&(!G||P.type!==_.SlotType.Ai)||P.status===_.PlayerStatus.Ready&&P.type!==_.SlotType.Ai),teamId:g.teamsAllowed?P.team:Y.NO_TEAM_ID,required:g.teamsRequired,maxTeams:g.maxTeams,onSelect:g=>this.props.onTeamSelect(g,L),strings:g.strings})):null):I.default.createElement("div",{className:"player-slot",key:"playerslot"+L})}renderPlayerStatus(g){return g===_.PlayerStatus.Host?I.default.createElement(q.Image,{src:"wolhost.pcx"}):g===_.PlayerStatus.Ready?I.default.createElement(q.Image,{src:"wolacpt.pcx"}):null}renderPlayerSelect(g,P,L){let U=L===_.LobbyType.Singleplayer;var G=U||L===_.LobbyType.MultiplayerHost;if(P===this.props.activeSlotIndex||G&&0===P)return I.default.createElement("input",{type:"text",className:"player-name",value:g.name,readOnly:!0});let V=this.props.strings,W=(new Map).set(_.SlotOccupation.Occupied,g.name||"").set(_.SlotOccupation.Open,V.get(g.type===_.SlotType.Observer?"GUI:OpenObserver":"GUI:Open")).set(_.SlotOccupation.Closed,U?V.get("GUI:None"):V.get("GUI:Closed")),z=g.occupation;return g.occupation===_.SlotOccupation.Occupied&&g.type===_.SlotType.Ai&&(W.delete(_.SlotOccupation.Occupied),z=K.AiDifficulty[g.aiDifficulty]),g.type!==_.SlotType.Observer&&this.props.availableAiNames.forEach((g,P)=>{W.set(K.AiDifficulty[P],V.get(g))}),I.default.createElement(Z.Select,{initialValue:""+z,disabled:!G,onSelect:g=>this.onPlayerSelect(g,P),className:"player-name",tooltip:U?V.get("STT:SkirmishComboAiPlayer"):V.get("STT:HostComboPlayer")},[...W].map(([P,L])=>P===_.SlotOccupation.Occupied&&g.occupation!==_.SlotOccupation.Occupied||P===_.SlotOccupation.Open&&U?null:I.default.createElement(X.Option,{key:P,value:""+P,label:L,tooltip:U?(()=>{let g;return g=P===_.SlotOccupation.Closed?"STT:PlayerNone":Y.aiUiTooltips.get(K.AiDifficulty[P]),g?V.get(g):void 0})():void 0})).filter(J.isNotNullOrUndefined))}},g("LobbyForm",te)}}}),System.register("gui/screen/mainMenu/lobby/component/PasswordBox",["react","gui/component/Dialog"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("PasswordBox",({strings:g,viewport:P,onSubmit:_,onDismiss:U})=>{let G=I.useRef(null),[V,W]=I.useState(!1);I.useEffect(()=>{setTimeout(()=>{G.current?.focus()},50)},[]);var o=g=>{g&&g.preventDefault(),W(!0),_(G.current.value)};return I.default.createElement(L.Dialog,{className:"login-box password-box",hidden:V,viewport:P,zIndex:100,buttons:[{label:g.get("GUI:Ok"),onClick:o},{label:g.get("GUI:Cancel"),onClick:()=>{W(!0),U?.()}}]},I.default.createElement("form",{onSubmit:o,autoComplete:"off"},I.default.createElement("div",{className:"field"},I.default.createElement("label",null,g.get("GUI:Password")),I.default.createElement("input",{name:"lobbypass",type:"password",autoComplete:"off","data-lpignore":"true",ref:G})),I.default.createElement("button",{type:"submit",style:{visibility:"hidden"}})))})}}}),System.register("gui/screen/mainMenu/lobby/component/RankIndicator",["react","gui/component/Image","network/ladder/PlayerRankType"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=(new Map).set(_.PlayerRankType.Private,"private").set(_.PlayerRankType.Corporal,"corporal").set(_.PlayerRankType.Sergeant,"sergeant").set(_.PlayerRankType.Lieutenant,"lieutena").set(_.PlayerRankType.Major,"major").set(_.PlayerRankType.Colonel,"colonel").set(_.PlayerRankType.BrigGeneral,"briggenr").set(_.PlayerRankType.General,"general").set(_.PlayerRankType.FiveStarGeneral,"stargen").set(_.PlayerRankType.CommanderInChief,"comchief"),g("RANK_LABELS",G=(new Map).set(_.PlayerRankType.Private,"GUI:RankPrivate").set(_.PlayerRankType.Corporal,"GUI:RankCorporal").set(_.PlayerRankType.Sergeant,"GUI:RankSergeant").set(_.PlayerRankType.Lieutenant,"GUI:RankLieutenant").set(_.PlayerRankType.Major,"GUI:RankMajor").set(_.PlayerRankType.Colonel,"GUI:RankColonel").set(_.PlayerRankType.BrigGeneral,"GUI:RankBrigGeneral").set(_.PlayerRankType.General,"GUI:RankGeneral").set(_.PlayerRankType.FiveStarGeneral,"GUI:RankFiveStar").set(_.PlayerRankType.CommanderInChief,"GUI:RankCmdInChief")),g("RankIndicator",({playerProfile:g,strings:P})=>{var V=g?.rankType??_.PlayerRankType.None,W=g?V!==_.PlayerRankType.None?g.name+" : "+P.get(G.get(V)):g.name+" : "+P.get("TXT_UNRANKED"):void 0;return I.default.createElement("div",{className:"rank-indicator","data-r-tooltip":W},V!==_.PlayerRankType.None?I.default.createElement(L.Image,{src:U.get(V)+".pcx"}):null)})}}}),System.register("gui/screen/mainMenu/lobby/component/viewmodel/lobby",[],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[],execute:function(){var P,G;(P=I||g("LobbyType",I={}))[P.Singleplayer=0]="Singleplayer",P[P.MultiplayerHost=1]="MultiplayerHost",P[P.MultiplayerGuest=2]="MultiplayerGuest",(G=L||g("SlotType",L={}))[G.Player=1]="Player",G[G.Ai=2]="Ai",G[G.Observer=3]="Observer",(G=_||g("SlotOccupation",_={}))[G.Open=1]="Open",G[G.Closed=2]="Closed",G[G.Occupied=3]="Occupied",(G=U||g("PlayerStatus",U={}))[G.NotReady=1]="NotReady",G[G.Ready=2]="Ready",G[G.Host=3]="Host"}}}),System.register("gui/screen/mainMenu/lobby/LobbyScreen",["@puzzl/core/lib/async/Task","network/WolConnection","network/WolError","network/gameopt/SlotInfo","game/gameopts/GameOpts","game/gameopts/constants","gui/screen/mainMenu/lobby/component/LobbyForm","gui/screen/mainMenu/lobby/component/viewmodel/lobby","gui/screen/mainMenu/lobby/component/PasswordBox","gui/screen/mainMenu/lobby/component/CreateGameBox","gui/screen/mainMenu/ScreenType","util/disposable/CompositeDisposable","gui/jsx/jsx","gui/jsx/HtmlView","engine/ResourceLoader","@puzzl/core/lib/async/cancellation","gui/screen/mainMenu/lobby/MapPreviewRenderer","util/array","engine/sound/SoundKey","engine/sound/ChannelType","LocalPrefs","gui/screen/mainMenu/lobby/PreferredHostOpts","util/typeGuard","game/gameopts/GameOptSanitizer","gui/screen/mainMenu/MainMenuScreen","data/MapFile","engine/MapDigest","network/gservConfig","network/WolConfig","gui/screen/mainMenu/MainMenuRoute","@puzzl/core/lib/async/sleep","network/chat/ChatMessage","gui/chat/ChatHistory","util/time","network/partyCodes"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g},function(g){ce=g},function(g){he=g},function(g){ue=g},function(g){de=g},function(g){ge=g},function(g){pe=g},function(g){me=g},function(g){fe=g},function(g){ye=g},function(g){Te=g},function(g){ve=g}],execute:function(){be=class extends ce.MainMenuScreen{constructor(g,P,_,G,V,W,z,K,q,Y,Z,X,ee,te,ae,ne,le,ce,he,ue,de,ge){super(),this.botsEnabled=g,this.engineModHash=P,this.activeModMeta=_,this.rootController=G,this.errorHandler=V,this.messageBoxApi=W,this.strings=z,this.uiScene=K,this.wolCon=q,this.wolService=Y,this.wladderService=Z,this.mapTransferService=X,this.gservCon=ee,this.rules=te,this.gameOptParser=ae,this.gameOptSerializer=ne,this.jsxRenderer=le,this.mapFileLoader=ce,this.mapList=he,this.gameModes=ue,this.sound=de,this.localPrefs=ge,this.messages=[],this.playerReadyStatus=new Map,this.playerHasMapStatus=new Map,this.acceptButtonFlashing=!1,this.partyEnabled=!1,this.playerProfiles=new Map,this.disposables=new Q.CompositeDisposable,this.updatePings=()=>{if(this.wolCon.isOpen()){if(this.gameChannelName&&this.wolCon.isInChannel(this.gameChannelName)){this.pingsUpdateTask?.cancel();let g=this.pingsUpdateTask=new I.Task(async g=>{var P=await this.wolCon.listUsers(this.gameChannelName);if(!g.isCancelled()){for(var I of P)this.updatePlayerPing(I.name,I.ping);this.sendPingData()}});g.start().catch(g=>{g instanceof J.OperationCanceledError||console.error(g)})}}else this.onWolClose()},this.updateRanks=()=>{if(this.wladderService.getUrl()&&this.slotsInfo){this.ranksUpdateTask?.cancel();let g=this.ranksUpdateTask=new I.Task(async g=>{await me.sleep(5e3,g);var P=this.slotsInfo.map(g=>g.type===U.SlotType.Player?g.name:void 0).filter(oe.isNotNullOrUndefined);P=await this.wladderService.listSearch(P,g);if(!g.isCancelled()){for(var I of P)this.playerProfiles.set(I.name,I);this.updateFormModel()}});g.start().catch(g=>{g instanceof J.OperationCanceledError||console.error(g)})}},this.handlePartyUpdate=g=>{if(this.partyEnabled){var P=g.split(" ");P[0]!==ve.RPL_PARTY_INVITE||(P=P[1])&&this.wolCon.partyInviteUnavailable(P)}},this.onChannelLeave=g=>{g.channel===this.gameChannelName&&(this.hostMode?g.user.name!==this.wolCon.getCurrentUser()&&this.handlePlayerJoinLeave(g):g.user.name!==this.hostPlayerName&&g.user.name!==this.wolCon.getCurrentUser()||this.controller?.goToScreen($.ScreenType.CustomGame,{}))},this.onChannelJoin=g=>{this.wolCon.isOpen()&&this.gameChannelName&&g.user.name!==this.wolCon.getCurrentUser()&&(this.sound.play("join"===g.type?re.SoundKey.PlayerJoined:re.SoundKey.PlayerLeft,se.ChannelType.Ui),"join"===g.type&&this.updatePlayerPing(g.user.name,g.user.ping),this.hostMode?this.handlePlayerJoinLeave(g):this.wolCon.sendPlayerReady(!1),this.playerProfiles.has(g.user.name)||this.updateRanks())},this.onChannelMessage=g=>{this.lobbyForm&&(g.to.type!==fe.ChatRecipientType.Page&&g.to.type!==fe.ChatRecipientType.Whisper||this.sound.play(re.SoundKey.IncomingMessage,se.ChannelType.Ui),this.messages.push(g),this.lobbyForm.refresh()),g.to.type===fe.ChatRecipientType.Whisper&&g.to.name!==this.wolCon.getServerName()&&g.from!==this.wolCon.getCurrentUser()&&(this.chatHistory.lastWhisperFrom.value=g.from)},this.handleGameStart=g=>{var P,I,_=this.wolCon.getCurrentUser(),U=new pe.MainMenuRoute($.ScreenType.Login,{afterLogin:g=>new pe.MainMenuRoute($.ScreenType.CustomGame,{messages:g})});this.hostMode?(P=this.frozenGameOpts??this.gameOpts,I=[...this.playerHasMapStatus.values()].includes(L.WolHasMapStatus.MapTransfer),this.rootController.createGame(g.gameId,g.timestamp,g.gservUrl,_,P,!1,this.isTournament,I,this.hostPrivateGame,U)):(I=this.playerHasMapStatus.get(_)===L.WolHasMapStatus.MapTransfer,this.rootController.joinGame(g.gameId,g.timestamp,g.gservUrl,_,this.isTournament,I,U))},this.handleGameServer=g=>{this.currentGameServer?.id!==g.id&&(this.currentGameServer=g,this.formModel.selectedGameServer=g.id,this.playerPings.length=0,this.lobbyForm?.refresh(),this.hostMode&&this.updatePings(),this.updateGservPing())},this.handleGameOpt=g=>{let P=g.opt,I=P[0];if(this.hostMode){if(g.user!==this.hostPlayerName)if("A"===I)this.handleGameOptReady(g.user,P[1]);else if("R"===I)this.handlePlayerOptsChange(g.user,P);else{if("K"!==I)throw new Error("Unknown GAMEOPT string "+P);this.handleGameOptHasMap(g.user,P[1])}}else if("L"===I)this.handleGameOptSlots(P),this.slotsInfo.some(g=>g.type===U.SlotType.Player&&!this.playerProfiles.has(g.name))&&this.updateRanks();else if("P"===I)this.handleGameOptPing(P.slice(1));else if("O"===I)this.handleGameOptObserver(P[1]);else if("A"===I)this.handleGameOptReady(g.user,P[1]);else if("K"===I)this.handleGameOptHasMap(g.user,P[1]);else{if("R"===I)return;if("G"===I)return void(this.playerReadyStatus.get(this.wolCon.getCurrentUser())||(this.addSystemMessage(this.strings.get("GUI:HostGameStartJoiner")),this.acceptButtonFlashing=!0,this.refreshSidebarButtons()));if(!I.match(/^-|\d+/))throw new Error("Unknown GAMEOPT string "+P);this.handleGameOptOptions(P)}this.updateFormModel()},this.onWolClose=()=>{this.hostOptsIntervalId&&clearInterval(this.hostOptsIntervalId),this.gservPingIntervalId&&clearInterval(this.gservPingIntervalId)},this.onWolConLost=g=>{this.errorHandler.handle(g,this.strings.get("TXT_YOURE_DISCON"),()=>{this.controller?.goToScreen($.ScreenType.Home)})}}async onEnter(g){if(this.wolCon.getCurrentUser()){let _=new J.CancellationTokenSource;this.disposables.add(()=>_.cancel());var P,I,L=_.token;this.gameChannelName=void 0,this.partyEnabled=this.resolvePartyEnabled(),this.wolCon.setPartyEnabled?.(this.partyEnabled),this.lobbyForm=void 0,this.chatHistory=new ye.ChatHistory,this.playerPings=[],this.initFormModel(),this.wolCon.onGameOpt.subscribe(this.handleGameOpt),this.wolCon.onGameStart.subscribe(this.handleGameStart),this.wolCon.onGameServer.subscribe(this.handleGameServer),this.wolCon.onLeaveChannel.subscribe(this.onChannelLeave),this.wolCon.onJoinChannel.subscribe(this.onChannelJoin),this.wolCon.onChatMessage.subscribe(this.onChannelMessage),this.wolCon.onClose.subscribe(this.onWolClose),this.partyEnabled&&this.wolCon.onPartyUpdate.subscribe(this.handlePartyUpdate),this.wolService.onWolConnectionLost.subscribe(this.onWolConLost),this.hostMode=g.create,this.hostMode?(this.title=this.strings.get("GUI:HostScreen"),this.createGame(L)):(this.title=this.strings.get("GUI:JoinScreen"),({game:P,observe:I}=g),this.joinGame(P,I,void 0,L))}else this.messageBoxApi.show(this.strings.get("TXT_YOURE_DISCON"),this.strings.get("GUI:Ok"),()=>{this.controller?.goToScreen($.ScreenType.Home)})}async joinGame(g,P,I,L){if(I||!g.passLocked){var U=g.name;try{var G=this.waitForHostPlayer(U,L).catch(g=>{if(!(g instanceof J.OperationCanceledError))throw g});if(await this.wolCon.joinGame(U,I,P),L.isCancelled())return;this.gameChannelName=U;var W,z,K,q=await G;if(L?.isCancelled())return;this.hostPlayerName=q.name,this.hostIsFreshAccount=q.fresh,this.isTournament=g.tournament,this.formModel.channels=[this.gameChannelName],P?this.sendPlayerInfo(V.OBS_COUNTRY_ID,V.RANDOM_COLOR_ID,V.RANDOM_START_POS,V.NO_TEAM_ID):(W=this.localPrefs.getItem(ae.StorageKey.LastPlayerCountry),z=this.localPrefs.getItem(ae.StorageKey.LastPlayerColor),K=void 0!==W&&Number(W)<this.getAvailablePlayerCountries().length?Number(W):V.RANDOM_COUNTRY_ID,Q=void 0!==z&&Number(z)<this.getAvailablePlayerColors().length&&this.getSelectablePlayerColors().includes(this.getColorNameById(Number(z)))?Number(z):V.RANDOM_COLOR_ID,K===V.RANDOM_COUNTRY_ID&&Q===V.RANDOM_COLOR_ID||this.sendPlayerInfo(K,Q,V.RANDOM_START_POS,V.NO_TEAM_ID)),this.observerSlotIndex=8}catch(g){if(g instanceof _.WolError){var Q=(new Map).set(_.WolError.Code.BadChannelPass,"TXT_BADPASS").set(_.WolError.Code.GameHasClosed,"TXT_GAME_CLOSED").set(_.WolError.Code.ChannelFull,"TXT_CHANNEL_FULL").set(_.WolError.Code.BannedFromChannel,"TXT_JOINBAN").get(g.code);if(Q)return void this.messageBoxApi.show(this.strings.get(Q),this.strings.get("GUI:Ok"),()=>{this.controller?.goToScreen($.ScreenType.CustomGame,{})})}else if(g instanceof J.OperationCanceledError)return;return void this.handleError(g,this.strings.get("WOL:MatchBadParameters"))}this.controller.toggleSidebarPreview(!0),this.initView()}else this.showPasswordBox(I=>{this.joinGame(g,P,I,L)},()=>{this.controller?.goToScreen($.ScreenType.CustomGame,{})})}waitForHostPlayer(g,P){return new Promise((I,L)=>{let s=P=>{var _;P.channelName===g&&(this.wolCon.onChannelUsers.unsubscribe(s),(_=P.users.find(g=>g.operator))?I(_):L(new Error("Host player not found")))};this.wolCon.onChannelUsers.subscribe(s),P.register(()=>{this.wolCon.onChannelUsers.unsubscribe(s),L(new J.OperationCanceledError(P))})})}async createGame(g,P){if(P){try{var{roomDesc:I,tournament:L,observe:_,pass:U}=P,G=this.wolCon.makeGameChannelName(),V=this.waitForHostPlayer(G,g).catch(g=>{if(!(g instanceof J.OperationCanceledError))throw g});if(await this.wolCon.createGame(G,1,9,this.wolService.getConfig().getClientChannelType(),L,U),g?.isCancelled())return;this.gameChannelName=G;var W=await V;if(g?.isCancelled())return;if(this.hostPlayerName=this.wolCon.getCurrentUser(),this.hostIsFreshAccount=W.fresh,this.hostRoomDesc=I,this.isTournament=L,this.hostPrivateGame=!!U,this.observerSlotIndex=_?0:8,this.formModel.lobbyType=z.LobbyType.MultiplayerHost,this.formModel.activeSlotIndex=_?-1:0,this.formModel.channels=[this.gameChannelName],await this.initHostOptions(_,g),g?.isCancelled())return;this.updateMapPreview(this.currentMapFile),this.updateFormModel(),this.updatePings(),this.updateRanks(),this.sendGameOpts(),this.sendModeMaxSlots(),this.hostOptsIntervalId=setInterval(()=>{this.wolCon.isOpen()&&this.gameChannelName&&(this.sendGameOpts(),this.updatePings())},5e3)}catch(P){return void this.handleError(P,P instanceof X.DownloadError?this.strings.get("TXT_DOWNLOAD_FAILED"):this.strings.get("WOL:MatchBadParameters"))}this.controller.toggleSidebarPreview(!0),this.initView()}else this.showCreateGameBox((P,I,L)=>{this.createGame(g,{roomDesc:P,observe:L,pass:I,tournament:!1})},()=>{this.controller?.goToScreen($.ScreenType.CustomGame,{})})}onViewportChange(){this.createGameBox&&this.createGameBox.applyOptions(g=>g.viewport=this.uiScene.viewport),this.passBox&&this.passBox.applyOptions(g=>g.viewport=this.uiScene.viewport)}onUnstack(g){if(this.wolCon.isOpen()&&this.gameChannelName){if(g){let W=g.gameMode.id!==this.gameOpts.gameMode;var P=g.mapName!==this.gameOpts.mapName;this.gameOpts.gameMode=g.gameMode.id;let z=this.mapList.getByName(g.mapName),K=g.changedMapFile??this.currentMapFile;this.currentMapFile=K;var I=te.findIndexReverse(this.slotsInfo,(g,P)=>g.type===U.SlotType.Ai||g.type===U.SlotType.Player&&(this.observerSlotIndex!==P||0===P)||g.type===U.SlotType.Open),L=Math.min(9,z.maxSlots+(0===this.observerSlotIndex?1:0)),_=Math.max(0,I+1-L);for(let g=0;g<_;g++){let P=this.slotsInfo[I-g];P.type===U.SlotType.Player?this.kickPlayer(P.name):P.type===U.SlotType.Ai&&(this.gameOpts.aiPlayers[I-g]=void 0),P.type=U.SlotType.Closed}for(let g=I+1;g<L;g++)this.slotsInfo[g].type=this.preferredHostOpts.slotsClosed.has(g)?U.SlotType.Closed:this.observerSlotIndex===g?U.SlotType.OpenObserver:U.SlotType.Open;let q=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings;if([...this.gameOpts.humanPlayers,...this.gameOpts.aiPlayers].forEach(g=>{g&&(g.startPos>z.maxSlots-1&&(g.startPos=V.RANDOM_START_POS),W&&(g.teamId=q.alliesAllowed&&q.mustAlly?0:V.NO_TEAM_ID))}),P){for(var G of this.playerReadyStatus.keys())this.playerReadyStatus.set(G,!1);this.playerHasMapStatus.clear()}this.sendGameSlotInfo(),this.sendModeMaxSlots(),this.applyGameOption(g=>{g.mapName=z.fileName,g.mapDigest=ue.MapDigest.compute(K),g.mapSizeBytes=K.getSize(),g.mapTitle=z.getFullMapTitle(this.strings),g.maxSlots=z.maxSlots,g.mapOfficial=z.official}),this.localPrefs.setItem(ae.StorageKey.LastMap,z.fileName),this.localPrefs.setItem(ae.StorageKey.LastMode,String(g.gameMode.id))}this.updateMapPreview(this.currentMapFile),this.initView()}else this.onWolClose()}async onStack(){await this.unrender()}initView(){this.initLobbyForm(),this.refreshSidebarButtons(),this.refreshSidebarMpText(),this.controller.showSidebarButtons(),this.gservPingIntervalId=setInterval(()=>{this.updateGservPing()},3e4)}async initHostOptions(g,P){var I=this.localPrefs.getItem(ae.StorageKey.PreferredGameOpts),L=this.localPrefs.getItem(ae.StorageKey.LastPlayerCountry),_=this.localPrefs.getItem(ae.StorageKey.LastPlayerColor),G=this.localPrefs.getItem(ae.StorageKey.LastMap),W=this.localPrefs.getItem(ae.StorageKey.LastMode);let z,K=G?this.mapList.getByName(G):void 0,q=K&&W&&this.gameModes.hasId(Number(W))?Number(W):1,$=this.gameModes.getById(q);z=K?.gameModes.find(g=>g.mapFilter===$.mapFilter)?K:(q=1,$=this.gameModes.getById(q),this.mapList.getAll().find(g=>g.gameModes.find(g=>$.mapFilter===g.mapFilter)));let Q=await this.mapFileLoader.load(z.fileName);if(!P?.isCancelled()){this.currentMapFile=Q;let P=this.preferredHostOpts=new ne.PreferredHostOpts;I?P.unserialize(I):P.applyMpDialogSettings(this.rules.mpDialogSettings),I=this.gameModes.getById(q).mpDialogSettings,this.gameOpts={gameMode:q,shortGame:P.shortGame,mcvRepacks:P.mcvRepacks,cratesAppear:P.cratesAppear,superWeapons:P.superWeapons,gameSpeed:P.gameSpeed,credits:P.credits,unitCount:P.unitCount,buildOffAlly:P.buildOffAlly,hostTeams:P.hostTeams,destroyableBridges:P.destroyableBridges,multiEngineer:P.multiEngineer,noDogEngiKills:P.noDogEngiKills,humanPlayers:[{name:this.hostPlayerName,countryId:g?V.OBS_COUNTRY_ID:void 0!==L&&Number(L)<this.getAvailablePlayerCountries().length?Number(L):V.RANDOM_COUNTRY_ID,colorId:!g&&void 0!==_&&Number(_)<this.getAvailablePlayerColors().length?Number(_):V.RANDOM_COLOR_ID,startPos:V.RANDOM_START_POS,teamId:I.mustAlly?0:V.NO_TEAM_ID}],aiPlayers:new Array(8).fill(void 0),mapName:z.fileName,mapDigest:ue.MapDigest.compute(Q),mapSizeBytes:Q.getSize(),mapTitle:z.getFullMapTitle(this.strings),maxSlots:z.maxSlots,mapOfficial:z.official},this.slotsInfo=[{type:U.SlotType.Player,name:this.hostPlayerName}];for(let I=1;I<9;++I)this.slotsInfo.push({type:P.slotsClosed.has(I)?U.SlotType.Closed:this.observerSlotIndex===I?U.SlotType.OpenObserver:I<z.maxSlots+(g?1:0)?U.SlotType.Open:U.SlotType.Closed});this.playerProfiles.clear()}}updateGservPing(){if(this.wolCon.isOpen()){if(this.gameChannelName&&this.wolCon.isInChannel(this.gameChannelName)){this.gservPingUpdateTask?.cancel();let g=this.gservPingUpdateTask=new I.Task(async g=>{var P;this.currentGameServer&&(P=this.currentGameServer.url,void 0!==(P=await this.pingGserv(P,g))&&(this.wolCon.sendGservPing(this.currentGameServer.id,P),this.hostMode&&this.updatePings()))});g.start().catch(g=>{g instanceof J.OperationCanceledError||console.error(g)})}}else this.onWolClose()}async pingGserv(g,P){try{await this.gservCon.connect(g,{cancelToken:P,timeoutSeconds:5}),P?.throwIfCancelled();var I=await this.gservCon.ping(5);return P?.throwIfCancelled(),I}catch(g){return void(g instanceof J.OperationCanceledError||console.error(g))}finally{this.gservCon.close()}}handleError(g,P){this.errorHandler.handle(g,P,()=>{this.controller?.goToScreen($.ScreenType.CustomGame,{})}),this.hostOptsIntervalId&&clearInterval(this.hostOptsIntervalId),this.gservPingIntervalId&&clearInterval(this.gservPingIntervalId)}showPasswordBox(g,P){let[I]=this.jsxRenderer.render(Y.jsx(Z.HtmlView,{innerRef:g=>this.passBox=g,component:K.PasswordBox,props:{strings:this.strings,onSubmit:P=>{g(P),I.destroy()},onDismiss:()=>{P(),I.destroy()},viewport:this.uiScene.viewport}}));this.uiScene.add(I),this.disposables.add(I,()=>this.uiScene.remove(I),()=>this.passBox=void 0)}showCreateGameBox(g,P){let[I]=this.jsxRenderer.render(Y.jsx(Z.HtmlView,{component:q.CreateGameBox,innerRef:g=>this.createGameBox=g,props:{strings:this.strings,onSubmit:(P,L,_)=>{I.destroy(),g(P,L,_)},onDismiss:()=>{I.destroy(),P()},viewport:this.uiScene.viewport}}));this.uiScene.add(I),this.disposables.add(I,()=>this.uiScene.remove(I),()=>this.createGameBox=void 0)}getAvailablePlayerCountryRules(){return this.rules.getMultiplayerCountries()}getAvailablePlayerCountries(){return this.getAvailablePlayerCountryRules().map(g=>g.name)}getAvailablePlayerColors(){return[...this.rules.getMultiplayerColors().values()].map(g=>g.asHexString())}getAvailableStartPositions(){return new Array(this.gameOpts?.maxSlots??8).fill(0).map((g,P)=>P)}getSelectablePlayerColors(){let g=[];this.formModel&&this.formModel.playerSlots.forEach(P=>{P&&g.push(P.color)});let P=this.getAvailablePlayerColors();return[V.RANDOM_COLOR_NAME].concat(P.filter(P=>P&&-1===g.indexOf(P)))}getSelectableStartPositions(){let g=[];this.formModel&&this.formModel.playerSlots.forEach(P=>{P&&g.push(P.startPos)});let P=this.getAvailableStartPositions();return[V.RANDOM_START_POS].concat(P.filter(P=>!g.includes(P)))}initFormModel(){var g=this.rules.mpDialogSettings;this.formModel={strings:this.strings,countryUiNames:new Map([[V.RANDOM_COUNTRY_NAME,V.RANDOM_COUNTRY_UI_NAME],[V.OBS_COUNTRY_NAME,V.OBS_COUNTRY_UI_NAME]].concat(this.getAvailablePlayerCountryRules().map(g=>[g.name,g.uiName]))),countryUiTooltips:new Map([[V.RANDOM_COUNTRY_NAME,V.RANDOM_COUNTRY_UI_TOOLTIP],[V.OBS_COUNTRY_NAME,V.OBS_COUNTRY_UI_TOOLTIP]].concat(this.getAvailablePlayerCountryRules().filter(g=>g.uiTooltip).map(g=>[g.name,g.uiTooltip]))),availablePlayerCountries:[V.RANDOM_COUNTRY_NAME].concat(this.getAvailablePlayerCountries()),availablePlayerColors:this.getSelectablePlayerColors(),availableAiNames:this.botsEnabled?new Map([...V.aiUiNames.entries()].filter(([g])=>g!==G.AiDifficulty.Easy)):new Map,availableStartPositions:this.getSelectableStartPositions(),maxTeams:4,lobbyType:z.LobbyType.MultiplayerGuest,messages:this.messages,chatHistory:this.chatHistory,channels:[],localUsername:this.wolCon.getCurrentUser(),mpDialogSettings:g,onSendMessage:g=>{g.value.length?this.wolCon.isOpen()&&this.gameChannelName&&(this.wolCon.sendChatMessage(g.value,g.recipient),g.recipient.type===fe.ChatRecipientType.Whisper&&(this.chatHistory.lastWhisperTo.value=g.recipient.name)):this.addSystemMessage(this.strings.get("TXT_ENTER_MESSAGE"))},onCountrySelect:(g,P)=>{this.wolCon.isOpen()&&this.gameChannelName&&(this.sendPlayerInfo(this.getCountryIdByName(g),this.getColorIdByName(this.formModel.playerSlots[P].color),this.formModel.playerSlots[P].startPos,this.formModel.playerSlots[P].team,P),this.updateFormModel())},onColorSelect:(g,P)=>{this.wolCon.isOpen()&&this.gameChannelName&&(this.sendPlayerInfo(this.getCountryIdByName(this.formModel.playerSlots[P].country),this.getColorIdByName(g),this.formModel.playerSlots[P].startPos,this.formModel.playerSlots[P].team,P),this.updateFormModel())},onStartPosSelect:(g,P)=>{this.wolCon.isOpen()&&this.gameChannelName&&(this.sendPlayerInfo(this.getCountryIdByName(this.formModel.playerSlots[P].country),this.getColorIdByName(this.formModel.playerSlots[P].color),g,this.formModel.playerSlots[P].team,P),this.updateFormModel())},onTeamSelect:(g,P)=>{this.wolCon.isOpen()&&this.gameChannelName&&(this.sendPlayerInfo(this.getCountryIdByName(this.formModel.playerSlots[P].country),this.getColorIdByName(this.formModel.playerSlots[P].color),this.formModel.playerSlots[P].startPos,g,P),this.updateFormModel())},onSlotChange:(g,P,I)=>{this.wolCon.isOpen()&&this.gameChannelName&&this.changeSlotType(g,P,I)},onToggleShortGame:g=>this.applyGameOption(P=>P.shortGame=g),onToggleMcvRepacks:g=>this.applyGameOption(P=>P.mcvRepacks=g),onToggleCratesAppear:g=>this.applyGameOption(P=>P.cratesAppear=g),onToggleSuperWeapons:g=>this.applyGameOption(P=>P.superWeapons=g),onToggleBuildOffAlly:g=>this.applyGameOption(P=>P.buildOffAlly=g),onToggleHostTeams:g=>this.applyGameOption(P=>P.hostTeams=g),onToggleDestroyableBridges:g=>this.applyGameOption(P=>P.destroyableBridges=g),onToggleMultiEngineer:g=>this.applyGameOption(P=>P.multiEngineer=g),onToggleNoDogEngiKills:g=>this.applyGameOption(P=>P.noDogEngiKills=g),onChangeGameSpeed:g=>this.applyGameOption(P=>P.gameSpeed=g),onChangeCredits:g=>this.applyGameOption(P=>P.credits=g),onChangeUnitCount:g=>this.applyGameOption(P=>P.unitCount=g),activeSlotIndex:-1,teamsAllowed:!0,teamsRequired:!1,playerSlots:[],shortGame:!0,mcvRepacks:!0,cratesAppear:!0,superWeapons:!0,buildOffAlly:!0,hostTeams:!1,destroyableBridges:!0,multiEngineer:!1,multiEngineerCount:Math.ceil((1-this.rules.general.engineerCaptureLevel)/this.rules.general.engineerDamage)+1,noDogEngiKills:!1,gameSpeed:6,credits:g.money,unitCount:g.unitCount},this.playerReadyStatus.clear(),this.playerHasMapStatus.clear(),this.messages.length=0}applyGameOption(g){if(!this.hostMode)throw new Error("Can't change options when not a host");this.wolCon.isOpen()?(g(this.gameOpts),le.GameOptSanitizer.sanitize(this.gameOpts,this.rules),this.updateFormModel(),this.sendGameOpts(),this.localPrefs.setItem(ae.StorageKey.PreferredGameOpts,this.preferredHostOpts.applyGameOpts(this.gameOpts).serialize())):this.onWolClose()}changeSlotType(g,P,I){if(!this.hostMode)throw new Error("Only host can change slot type");if(0===P)throw new Error("Change slot type of host");var L=this.formModel.playerSlots[P];let _=this.slotsInfo[P];L.occupation===g&&_.type===U.SlotType.Player&&void 0===I||(L.occupation===z.SlotOccupation.Occupied&&(_.type===U.SlotType.Player?this.kickPlayer(_.name):this.gameOpts.aiPlayers[P]=void 0),L=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings,g===z.SlotOccupation.Closed?(_.type=U.SlotType.Closed,this.preferredHostOpts.slotsClosed.add(P)):g===z.SlotOccupation.Open?(_.type=P===this.observerSlotIndex?U.SlotType.OpenObserver:U.SlotType.Open,this.preferredHostOpts.slotsClosed.delete(P)):g===z.SlotOccupation.Occupied&&void 0!==I&&(_.type=U.SlotType.Ai,_.difficulty=I,this.gameOpts.aiPlayers[P]={difficulty:I,countryId:V.RANDOM_COUNTRY_ID,colorId:V.RANDOM_COLOR_ID,startPos:V.RANDOM_START_POS,teamId:L.mustAlly?3:V.NO_TEAM_ID},this.preferredHostOpts.slotsClosed.delete(P)),this.updateFormModel(),this.sendGameSlotInfo(),this.sendGameOpts(),this.sendModeMaxSlots(),this.localPrefs.setItem(ae.StorageKey.PreferredGameOpts,this.preferredHostOpts.serialize()))}getCountryNameById(g){let P;return P=g===V.RANDOM_COUNTRY_ID?V.RANDOM_COUNTRY_NAME:g===V.OBS_COUNTRY_ID?V.OBS_COUNTRY_NAME:this.getAvailablePlayerCountries()[g],P}getCountryIdByName(g){let P;if(g===V.RANDOM_COUNTRY_NAME)P=V.RANDOM_COUNTRY_ID;else if(g===V.OBS_COUNTRY_NAME)P=V.OBS_COUNTRY_ID;else{P=this.getAvailablePlayerCountries().indexOf(g)}return P}getColorNameById(g){let P;return P=g===V.RANDOM_COLOR_ID?V.RANDOM_COLOR_NAME:this.getAvailablePlayerColors()[g],P}getColorIdByName(g){let P;if(g===V.RANDOM_COLOR_NAME)P=V.RANDOM_COLOR_ID;else{if(P=this.getAvailablePlayerColors().indexOf(g),-1===P)throw new Error(`Color ${g} not found in available player colors`)}return P}sendPlayerInfo(g,P,I,L,_){if(!this.hostPlayerName)throw new Error("Host player name not yet set.");if(this.hostMode){if(void 0!==_&&_!==this.formModel.activeSlotIndex){const G=this.slotsInfo[_];if(G.type!==U.SlotType.Ai&&!this.gameOpts.hostTeams)throw new Error("Can't change country and color for a non-AI slot");let V=this.gameOpts.aiPlayers[_];if(!V){if(!this.gameOpts.hostTeams)throw new Error("No AI found in slot "+_);if(G.type!==U.SlotType.Player)return void console.warn(`Can't change player info for ${U.SlotType[G.type]} slot at `+_);V=this.gameOpts.humanPlayers.find(g=>g.name===G.name)}if(!V)throw new Error("No human player found in slot "+_);V.countryId=g,V.colorId=P,V.startPos=I,V.teamId=L}else this.updatePlayerInfo(this.hostPlayerName,g,P,I,L);this.updateFormModel(),this.sendGameOpts()}else this.wolCon.sendPlayerOpts(this.hostPlayerName,g,P,I,L);void 0!==_&&_!==this.formModel.activeSlotIndex||g!==V.OBS_COUNTRY_ID&&(g!==V.RANDOM_COUNTRY_ID?this.localPrefs.setItem(ae.StorageKey.LastPlayerCountry,String(g)):this.localPrefs.removeItem(ae.StorageKey.LastPlayerCountry),P!==V.RANDOM_COLOR_ID?this.localPrefs.setItem(ae.StorageKey.LastPlayerColor,String(P)):this.localPrefs.removeItem(ae.StorageKey.LastPlayerColor))}updatePlayerInfo(g,P,I,L,_,U=!1){if(!this.hostMode)throw new Error("Method should only be used in host mode");let G=this.gameOpts.humanPlayers.find(P=>P.name===g);G?(G.countryId=P,G.colorId=I,U||(G.startPos=L,G.teamId=_)):console.error("Can't set country/color for non-existent player "+g)}updateFormModel(){var g=this.gameOpts;if(g&&(this.formModel.gameSpeed=g.gameSpeed,this.formModel.credits=g.credits,this.formModel.unitCount=g.unitCount,this.formModel.shortGame=g.shortGame,this.formModel.superWeapons=g.superWeapons,this.formModel.buildOffAlly=g.buildOffAlly,this.formModel.hostTeams=g.hostTeams,this.formModel.mcvRepacks=g.mcvRepacks,this.formModel.cratesAppear=g.cratesAppear,this.formModel.destroyableBridges=g.destroyableBridges,this.formModel.multiEngineer=g.multiEngineer,this.formModel.noDogEngiKills=g.noDogEngiKills),this.gameOpts&&this.slotsInfo){let P=g.maxSlots;this.slotsInfo.forEach((g,I)=>{I!==this.observerSlotIndex?P?(P--,this.formModel.playerSlots[I]={country:V.RANDOM_COUNTRY_NAME,color:V.RANDOM_COLOR_NAME,startPos:V.RANDOM_START_POS,team:V.NO_TEAM_ID}):this.formModel.playerSlots[I]=void 0:this.formModel.playerSlots[I]={country:V.RANDOM_COUNTRY_NAME,color:V.RANDOM_COLOR_NAME,startPos:V.RANDOM_START_POS,team:V.NO_TEAM_ID}}),this.slotsInfo.forEach((g,P)=>{if(this.formModel.playerSlots[P]){let I=this.formModel.playerSlots[P];g.type===U.SlotType.Closed?I.occupation=z.SlotOccupation.Closed:g.type===U.SlotType.Open||g.type===U.SlotType.OpenObserver?I.occupation=z.SlotOccupation.Open:I.occupation=z.SlotOccupation.Occupied,g.type===U.SlotType.OpenObserver||P===this.observerSlotIndex?I.type=z.SlotType.Observer:g.type===U.SlotType.Ai?I.type=z.SlotType.Ai:I.type=z.SlotType.Player,g.type===U.SlotType.Ai?(I.aiDifficulty=g.difficulty,I.status=z.PlayerStatus.Ready):g.type===U.SlotType.Player&&(I.name=g.name,g.name===this.hostPlayerName?I.status=z.PlayerStatus.Host:I.status=this.playerReadyStatus.get(g.name)?z.PlayerStatus.Ready:z.PlayerStatus.NotReady)}})}let P=this.gameOpts?this.gameOpts.humanPlayers:[],I=this.gameOpts?this.gameOpts.aiPlayers:[],L=this.gameOpts?this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings:void 0;this.formModel.playerSlots.forEach((g,_)=>{var U,G;g&&P.length&&(g.occupation===z.SlotOccupation.Occupied?((U=P.find(P=>P.name===g.name))?(g.country=this.getCountryNameById(U.countryId),g.color=this.getColorNameById(U.colorId),g.startPos=U.startPos,g.team=U.teamId):(G=I[_])&&(g.country=this.getCountryNameById(G.countryId),g.color=this.getColorNameById(G.colorId),g.startPos=G.startPos,g.team=G.teamId),(G=this.playerPings.find(P=>!!g.name&&P.playerName===g.name))&&(g.ping=0<G.ping?G.ping:void 0),this.playerProfiles&&g.type===z.SlotType.Player&&(g.playerProfile=this.playerProfiles.get(g.name))):_===this.observerSlotIndex?g.country=V.OBS_COUNTRY_NAME:(g.country=V.RANDOM_COUNTRY_NAME,L&&(g.team=L.mustAlly?3:V.NO_TEAM_ID)))}),this.hostMode||(this.formModel.activeSlotIndex=this.slotsInfo?this.slotsInfo.findIndex(g=>g.type===U.SlotType.Player&&g.name===this.wolCon.getCurrentUser()):-1),this.formModel.availablePlayerColors=this.getSelectablePlayerColors(),this.formModel.availableStartPositions=this.getSelectableStartPositions(),this.gameOpts&&(this.formModel.teamsAllowed=this.gameModes.getById(g.gameMode).mpDialogSettings.alliesAllowed,this.formModel.teamsRequired=this.gameModes.getById(g.gameMode).mpDialogSettings.mustAlly),this.lobbyForm&&P.length&&this.lobbyForm.refresh()}addSystemMessage(g,P=!1){this.lobbyForm&&(this.messages.push({text:g,untrustedContent:P}),this.lobbyForm.refresh())}sendGameOpts(){if(!this.hostMode)throw new Error("Should only be used in host mode");var g,P,I;this.gameOpts&&this.wolCon.isOpen()&&this.gameChannelName&&(this.gameOpts.humanPlayers.forEach(g=>{-1===g.colorId&&(g.colorId=V.RANDOM_COLOR_ID)}),I=this.gameOptSerializer.serializeOptions(this.gameOpts),this.wolCon.sendGameOpts(I),g=this.slotsInfo.filter(g=>g.type===U.SlotType.Ai||g.type===U.SlotType.Player||g.type===U.SlotType.Open||g.type===U.SlotType.OpenObserver).length,P=this.slotsInfo.filter(g=>g.type===U.SlotType.Player).length,I=this.activeModMeta?this.activeModMeta.name+(void 0!==this.activeModMeta.version?` (${this.activeModMeta.version})`:""):void 0,this.wolCon.sendGameTopic(P,g,this.gameOpts.aiPlayers.filter(g=>!!g).length,Number(this.slotsInfo[this.observerSlotIndex].type===U.SlotType.Player),this.slotsInfo[this.observerSlotIndex].type===U.SlotType.OpenObserver,this.gameOpts.mapName,this.engineModHash,this.hostRoomDesc,I),this.sendPingData())}handlePlayerJoinLeave(g){if(!this.hostMode)throw new Error("Should only be used in host mode");if(this.wolCon.isOpen()&&this.gameChannelName&&this.slotsInfo){if("join"===g.type){let L=this.slotsInfo.findIndex(g=>g.type===U.SlotType.Open),_=!1;if(-1===L&&(L=this.slotsInfo.findIndex(g=>g.type===U.SlotType.OpenObserver),_=!0,-1===L))return void this.kickPlayer(g.user.name);this.slotsInfo[L]={type:U.SlotType.Player,name:g.user.name};var P,I=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings;for(P of(this.gameOpts.humanPlayers.push({name:g.user.name,countryId:_?V.OBS_COUNTRY_ID:V.RANDOM_COUNTRY_ID,colorId:_?V.OBS_COLOR_ID:V.RANDOM_COLOR_ID,startPos:V.RANDOM_START_POS,teamId:I.mustAlly?0:V.NO_TEAM_ID}),this.playerReadyStatus.set(g.user.name,!1),this.playerReadyStatus.keys()))this.playerReadyStatus.set(P,!1)}else this.removeHumanPlayer(g.user.name);this.sendGameSlotInfo(),this.sendObserverSlotInfo(),this.sendGameOpts()}}removeHumanPlayer(g){var P=this.slotsInfo.findIndex(P=>P.type===U.SlotType.Player&&P.name===g);if(-1!==P){let g=this.slotsInfo[P];P===this.observerSlotIndex?g.type=U.SlotType.OpenObserver:g.type=U.SlotType.Open}P=this.gameOpts.humanPlayers.findIndex(P=>P.name===g),-1!==P&&this.gameOpts.humanPlayers.splice(P,1),this.playerReadyStatus.delete(g),this.playerHasMapStatus.delete(g),P=this.playerPings.findIndex(P=>P.playerName===g),-1!==P&&this.playerPings.splice(P,1)}kickPlayer(g,P){this.gameChannelName&&this.wolCon.isInChannel(this.gameChannelName)&&(this.wolCon.kick([g],this.gameChannelName,P),this.removeHumanPlayer(g))}sendObserverSlotInfo(){this.wolCon.sendObserverSlot(this.observerSlotIndex)}sendGameSlotInfo(){var g;this.wolCon.isOpen()&&this.gameChannelName&&(g=this.gameOptSerializer.serializeSlotData(this.slotsInfo),this.wolCon.sendGameSlotsInfo(g))}sendPingData(){var g;this.playerPings.length&&(g=this.gameOptSerializer.serializePingData(this.playerPings),this.wolCon.sendPingData(g))}sendModeMaxSlots(){if(!this.hostMode)throw new Error("Must be in host mode");if(!this.slotsInfo)throw new Error("Slots info should be set by now");var g=this.gameChannelName;if(!g||!this.wolCon.isInChannel(g))throw new Error("Must be in a game channel");var P=this.slotsInfo.filter(g=>g.type!==U.SlotType.Closed&&g.type!==U.SlotType.Ai).length;this.wolCon.sendModeChannelMax(g,P)}updatePlayerPing(g,P){let I=this.playerPings.find(P=>P.playerName===g);I?I.ping=P:this.playerPings.push({ping:P,playerName:g})}handlePlayerOptsChange(g,P){var I=this.slotsInfo.findIndex(P=>P.type===U.SlotType.Player&&P.name===g);if(-1!==I){let[_,G,W,z]=P.slice(1).split(",").map(Number);G=this.getSelectablePlayerColors().includes(this.getColorNameById(G))?G:this.gameOpts.humanPlayers.find(P=>P.name===g).colorId,W=this.getSelectableStartPositions().includes(W)?W:this.gameOpts.humanPlayers.find(P=>P.name===g).startPos;var L=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings;z=!L.alliesAllowed||z===V.NO_TEAM_ID&&L.mustAlly?L.mustAlly?0:V.NO_TEAM_ID:z,_===V.OBS_COUNTRY_ID||I!==this.observerSlotIndex?(this.updatePlayerInfo(g,_,G,W,z,this.gameOpts.hostTeams),this.sendGameOpts(),_===V.OBS_COUNTRY_ID&&((L=this.slotsInfo[this.observerSlotIndex]).type!==U.SlotType.OpenObserver?L.type===U.SlotType.Player&&L.name===g||(console.warn(`Player ${g} tried to move to an unavailable observer slot`),this.kickPlayer(g)):(this.slotsInfo[this.observerSlotIndex]=this.slotsInfo[I],this.slotsInfo[I]={type:U.SlotType.Open},this.sendGameSlotInfo()))):this.kickPlayer(g)}}handleGameOptReady(g,P){if(this.slotsInfo){var I=this.slotsInfo.findIndex(P=>P.type===U.SlotType.Player&&P.name===g);if(-1===I&&this.hostMode)return}this.playerReadyStatus.set(g,Boolean(Number(P))),this.hostMode||g!==this.wolCon.getCurrentUser()||(Number(P)&&(this.acceptButtonFlashing=!1),this.refreshSidebarButtons()),this.hostMode&&![...this.playerReadyStatus.values()].filter(g=>!1===g).length&&this.sound.play(re.SoundKey.OptionsChanged,se.ChannelType.Ui)}handleGameOptHasMap(g,P){if(this.slotsInfo){var I=this.slotsInfo.findIndex(P=>P.type===U.SlotType.Player&&P.name===g);if(-1===I&&this.hostMode)return}let _=Number(P);Object.values(L.WolHasMapStatus).includes(_)||(_=L.WolHasMapStatus.NoMap),this.playerHasMapStatus.set(g,_),this.hostMode||g!==this.wolCon.getCurrentUser()?_!==L.WolHasMapStatus.HasMap&&this.gameOpts&&this.messages.push({untrustedContent:!0,text:_===L.WolHasMapStatus.MapTransfer?this.strings.get("GUI:HostMapTransfer",g,`"${this.gameOpts.mapTitle}"`):this.strings.get("GUI:HostNoMap",g,`"${this.gameOpts.mapTitle}"`)+(this.hostIsFreshAccount?" "+this.strings.get("GUI:HostNoMapUpload"):"")}):this.refreshSidebarButtons()}handleGameOptObserver(g){this.observerSlotIndex=Number(g)}handleGameOptSlots(g){this.slotsInfo=this.gameOptParser.parseSlotData(g)}handleGameOptPing(g){this.playerPings=this.gameOptParser.parsePingData(g)}handleGameOptOptions(g){var P,I;this.gameChannelName&&this.wolCon.isInChannel(this.gameChannelName)&&(I=(P=this.gameOptParser.parseOptions(g)).mapName!==this.gameOpts?.mapName||P.mapDigest!==this.gameOpts?.mapDigest,le.GameOptSanitizer.sanitize(P,this.rules),this.gameOpts=P,this.refreshSidebarMpText(),I&&this.wolCon.isOpen()&&(I=this.wolCon.getCurrentUser(),this.playerReadyStatus.set(I,!1),this.playerHasMapStatus.set(I,L.WolHasMapStatus.NoMap),this.refreshSidebarButtons(),this.wolCon.sendPlayerReady(!1),this.guestUpdateMapDeferred(P)))}guestUpdateMapDeferred(g){this.mapLoadTask?.cancel(),this.mapLoadTask=new I.Task(async P=>{this.controller.setSidebarPreview(),this.currentMapFile=void 0;var I,_,U=this.currentMapFile=await this.loadAndCheckMap(g);!P.isCancelled()&&this.wolCon.isOpen()&&(I=!U&&!g.mapOfficial&&!this.hostIsFreshAccount&&g.mapSizeBytes<=(this.mapTransferService.getUrl()?ge:de).MAX_MAP_TRANSFER_BYTES,_=U?L.WolHasMapStatus.HasMap:I?L.WolHasMapStatus.MapTransfer:L.WolHasMapStatus.NoMap,this.wolCon.sendPlayerHasMap(_),U?this.updateMapPreview(U):this.addSystemMessage(I?this.strings.get("GUI:JoinerMapTransfer",`"${g.mapTitle}"`):this.hostIsFreshAccount?this.strings.get("GUI:HostNoMapUpload"):this.strings.get("GUI:JoinerNoMap",`"${g.mapTitle}"`),!0),this.refreshSidebarMpText())}),this.mapLoadTask.start().catch(g=>{g instanceof J.OperationCanceledError||this.handleError(g,this.strings.get("TXT_DOWNLOAD_FAILED"))})}updateMapPreview(g){try{var P=new ee.MapPreviewRenderer(this.strings).render(new he.MapFile(g),this.hostMode?z.LobbyType.MultiplayerHost:z.LobbyType.MultiplayerGuest,this.controller.getSidebarPreviewSize());this.controller.setSidebarPreview(P)}catch(g){console.error("Failed to render map preview"),console.error(g),this.controller.setSidebarPreview()}}async loadAndCheckMap(g){if(this.mapList.getByName(g.mapName)){let P=await this.mapFileLoader.load(g.mapName);return ue.MapDigest.compute(P)===g.mapDigest&&P.getSize()===g.mapSizeBytes?P:void 0}}initLobbyForm(){var[g]=this.jsxRenderer.render(Y.jsx(Z.HtmlView,{innerRef:g=>this.lobbyForm=g,component:W.LobbyForm,props:this.formModel}));this.controller.setMainComponent(g)}refreshSidebarButtons(){let g=this.strings,P=this.playerReadyStatus.get(this.wolCon.getCurrentUser());var I=this.playerHasMapStatus.get(this.wolCon.getCurrentUser())??L.WolHasMapStatus.NoMap;I=[this.hostMode?{label:g.get("GUI:StartGame"),tooltip:g.get("STT:HostButtonGo"),disabled:!1,onClick:()=>{var g;this.wolCon.isOpen()&&(void 0!==(g=[...this.playerHasMapStatus].find(([,g])=>g===L.WolHasMapStatus.NoMap)?.[0])?this.addSystemMessage(this.strings.get("GUI:HostNoMap",g,`"${this.gameOpts.mapTitle}"`)+(this.hostIsFreshAccount?" "+this.strings.get("GUI:HostNoMapUpload"):""),!0):this.gameOpts.humanPlayers.filter(g=>g.countryId!==V.OBS_COUNTRY_ID).length<2?this.addSystemMessage(this.strings.get("TXT_ONLY_ONE")):this.meetsMinimumTeams()?[...this.playerReadyStatus.values()].filter(g=>!1===g).length?(this.addSystemMessage(this.strings.get("GUI:HostGameStartHost")),this.wolCon.sendGameStartRequest()):(this.frozenGameOpts=this.gameOptParser.parseOptions(this.gameOptSerializer.serializeOptions(this.gameOpts)),this.wolCon.startGame(this.gameOpts.humanPlayers.map(g=>g.name))):this.addSystemMessage(this.strings.get("TXT_CANNOT_ALLY")))}}:{label:P?g.get("GUI:NotReady"):g.get("GUI:Accept"),tooltip:P?g.get("STT:NotReady"):g.get("STT:GuestButtonAccept"),disabled:I===L.WolHasMapStatus.NoMap,flashing:!P&&this.acceptButtonFlashing,onClick:()=>{this.wolCon.isOpen()&&this.gameChannelName&&(this.playerReadyStatus.set(this.wolCon.getCurrentUser(),!P),this.wolCon.sendPlayerReady(!P))}},...this.hostMode?[{label:g.get("GUI:ChooseMap"),tooltip:g.get("STT:HostButtonChooseMap"),onClick:()=>{this.controller?.pushScreen($.ScreenType.MapSelection,{lobbyType:this.hostMode?z.LobbyType.MultiplayerHost:z.LobbyType.MultiplayerGuest,gameOpts:this.gameOpts,usedSlots:()=>1+te.findIndexReverse(this.slotsInfo,(g,P)=>g.type===U.SlotType.Ai||g.type===U.SlotType.Player&&this.observerSlotIndex!==P)-(0===this.observerSlotIndex?1:0)})}}]:[],{label:g.get("GUI:Back"),tooltip:this.hostMode?g.get("STT:HostButtonBack"):g.get("STT:GuestButtonBack"),isBottom:!0,onClick:()=>{this.controller?.goToScreen($.ScreenType.CustomGame,{})}}];this.controller.setSidebarButtons(I,!0),this.refreshSidebarMpText()}meetsMinimumTeams(){let g=[...this.gameOpts.humanPlayers,...this.gameOpts.aiPlayers].filter(oe.isNotNullOrUndefined).filter(g=>g.countryId!==V.OBS_COUNTRY_ID),P=g[0].teamId;return P===V.NO_TEAM_ID||g.some(g=>g.teamId!==P)}refreshSidebarMpText(){this.gameOpts?this.controller.setSidebarMpContent({text:this.strings.get(this.gameModes.getById(this.gameOpts.gameMode).label)+"\n\n"+(this.hostMode||!this.hostIsFreshAccount||this.currentMapFile?this.gameOpts.mapTitle:this.strings.get("GUI:CustomMap")),icon:this.gameOpts.mapOfficial?"gt18.pcx":"settings.png",tooltip:this.gameOpts.mapOfficial?this.strings.get("STT:VerifiedMap"):this.strings.get("STT:UnverifiedMap")}):this.controller.setSidebarMpContent({text:""})}async onLeave(){this.wolCon.isOpen()&&this.wolCon.getCurrentUser()&&this.gameChannelName&&this.wolCon.leaveChannel(this.gameChannelName),this.disposables.dispose(),this.mapLoadTask?.cancel(),this.mapLoadTask=void 0,this.ranksUpdateTask?.cancel(),this.ranksUpdateTask=void 0,this.pingsUpdateTask?.cancel(),this.pingsUpdateTask=void 0,this.gservPingUpdateTask?.cancel(),this.gservPingUpdateTask=void 0,this.currentMapFile=void 0,this.gameChannelName=void 0,this.hostPlayerName=void 0,this.hostIsFreshAccount=void 0,this.hostRoomDesc="",this.gameOpts=void 0,this.frozenGameOpts=void 0,this.preferredHostOpts=void 0,this.playerPings=this.slotsInfo=void 0,this.playerProfiles.clear(),this.currentGameServer=void 0,this.acceptButtonFlashing=!1,this.hostOptsIntervalId&&clearInterval(this.hostOptsIntervalId),this.gservPingIntervalId&&clearInterval(this.gservPingIntervalId),this.wolCon.onGameOpt.unsubscribe(this.handleGameOpt),this.wolCon.onGameStart.unsubscribe(this.handleGameStart),this.wolCon.onGameServer.unsubscribe(this.handleGameServer),this.wolCon.onLeaveChannel.unsubscribe(this.onChannelLeave),this.wolCon.onJoinChannel.unsubscribe(this.onChannelJoin),this.wolCon.onChatMessage.unsubscribe(this.onChannelMessage),this.wolCon.onClose.unsubscribe(this.onWolClose),this.partyEnabled&&this.wolCon.onPartyUpdate.unsubscribe(this.handlePartyUpdate),this.wolService.onWolConnectionLost.unsubscribe(this.onWolConLost),this.controller.toggleSidebarPreview(!1),await this.unrender()}resolvePartyEnabled(){try{return!!this.serverRegions?.getSelectedRegion?.()?.partyEnabled}catch(g){return!1}}async unrender(){await this.controller.hideSidebarButtons(),this.lobbyForm&&(this.lobbyForm=void 0)}},g("LobbyScreen",be),__decorate([Te.Throttle(5e3)],be.prototype,"updateGservPing",null),__decorate([Te.Throttle(350)],be.prototype,"sendGameOpts",null),__decorate([Te.Throttle(350)],be.prototype,"sendGameSlotInfo",null)}}}),System.register("gui/screen/mainMenu/lobby/MapPreviewRenderer",["engine/gfx/CanvasUtils","gui/HtmlContainer","gui/UiObject","gui/screen/mainMenu/lobby/component/viewmodel/lobby","game/Coords","engine/IsoCoords"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){W=new Map([[U.LobbyType.Singleplayer,"STT:SkirmishMapThumbnail"],[U.LobbyType.MultiplayerHost,"STT:HostMapThumbnail"],[U.LobbyType.MultiplayerGuest,"STT:GuestMapThumbnail"]]),g("MapPreviewRenderer",class{constructor(g){this.strings=g}render(g,P,U){let G;try{G=g.decodePreviewImage()}catch(g){console.error("Failed to decode map preview data",g)}if(G){var{data:V,width:z,height:K}=G;let q=I.CanvasUtils.canvasFromRgbImageData(V,z,K),$=1;K=q.width<U.width/2||q.height<U.height/2?4:2;let Q=document.createElement("canvas");Q.width=K*q.width,Q.height=K*q.height;let Y=Q.getContext("2d");Y&&($=K,Y.scale($,$),Y.drawImage(q,0,0),q=Q),this.drawStartLocations(q,g,U,$);let Z=new L.HtmlContainer;return K=new _.UiObject(new THREE.Object3D,Z),Z.setSize("100%","100%"),Z.render(),q.style.objectFit="contain",q.style.width="100%",q.style.height="100%",q.setAttribute("data-r-tooltip",this.strings.get(W.get(P))),Z.getElement().appendChild(q),K}}drawStartLocations(g,P,L,_){var U=g.getContext("2d");if(U){V.IsoCoords.init({x:0,y:P.fullSize.width*G.Coords.getWorldTileSize()/2});var W,z,K=V.IsoCoords.worldToScreen(0,0),q=V.IsoCoords.screenToScreenTile(K.x,K.y),$=13*(K=g.width>g.height?g.width/L.width/_:g.height/L.height/_),Q=2*K;for([W,z]of P.startingLocations.entries()){var Y=z;Y=V.IsoCoords.tileToScreen(Y.x,Y.y);let L=V.IsoCoords.screenToScreenTile(Y.x,Y.y);L.x+=q.x,L.y+=q.y;let G=this.dxyToCanvas(L.x,L.y,g,P.localSize);G.x/=_,G.y/=_,I.CanvasUtils.drawText(U,String(W+1),G.x-$/4,G.y-$/2,{fontSize:$,color:"yellow",outlineColor:"black",outlineWidth:Q})}}}dxyToCanvas(g,P,I,L){var _=I.width/(2*L.width),U=I.height/L.height/2;return{x:(g-2*L.x)*_,y:(P-2*L.y)*U}}})}}}),System.register("gui/screen/mainMenu/lobby/PreferredHostOpts",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("PreferredHostOpts",class{constructor(){this.gameSpeed=6,this.credits=1e4,this.unitCount=10,this.shortGame=!0,this.superWeapons=!1,this.buildOffAlly=!0,this.mcvRepacks=!0,this.cratesAppear=!1,this.hostTeams=!1,this.destroyableBridges=!0,this.multiEngineer=!1,this.noDogEngiKills=!1,this.slotsClosed=new Set}serialize(){return[this.gameSpeed,this.credits,this.unitCount,Number(this.shortGame),Number(this.superWeapons),Number(this.buildOffAlly),Number(this.mcvRepacks),Number(this.cratesAppear),[...this.slotsClosed].join(","),Number(this.hostTeams),Number(this.destroyableBridges),Number(this.multiEngineer),Number(this.noDogEngiKills)].join(";")}unserialize(g){let[P,I,L,_,U,G,V,W,z,K,q="1",$,Q]=g.split(";");return this.gameSpeed=Number(P),this.credits=Number(I),this.unitCount=Number(L),this.shortGame=Boolean(Number(_)),this.superWeapons=Boolean(Number(U)),this.buildOffAlly=Boolean(Number(G)),this.mcvRepacks=Boolean(Number(V)),this.cratesAppear=Boolean(Number(W)),this.hostTeams=Boolean(Number(K)),this.destroyableBridges=Boolean(Number(q)),this.multiEngineer=Boolean(Number($)),this.noDogEngiKills=Boolean(Number(Q)),this.slotsClosed=new Set(z?z.split(",").map(g=>Number(g)):[]),this}applyGameOpts(g){return this.gameSpeed=g.gameSpeed,this.credits=g.credits,this.unitCount=g.unitCount,this.shortGame=g.shortGame,this.superWeapons=g.superWeapons,this.buildOffAlly=g.buildOffAlly,this.mcvRepacks=g.mcvRepacks,this.cratesAppear=g.cratesAppear,this.hostTeams=!!g.hostTeams,this.destroyableBridges=g.destroyableBridges,this.multiEngineer=g.multiEngineer,this.noDogEngiKills=g.noDogEngiKills,this}applyMpDialogSettings(g){return this.gameSpeed=6-g.gameSpeed,this.credits=g.money,this.unitCount=g.unitCount,this.shortGame=g.shortGame,this.mcvRepacks=g.mcvRedeploys,this.cratesAppear=g.crates,this.superWeapons=g.superWeapons,this.destroyableBridges=g.bridgeDestruction,this.multiEngineer=g.multiEngineer,this}})}}}),System.register("gui/screen/mainMenu/lobby/SelectMapParams",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("gui/screen/mainMenu/lobby/SkirmishScreen",["@puzzl/core/lib/async/Task","network/gameopt/SlotInfo","game/gameopts/GameOpts","game/gameopts/constants","gui/screen/mainMenu/lobby/component/LobbyForm","gui/screen/mainMenu/lobby/component/viewmodel/lobby","gui/screen/mainMenu/ScreenType","util/disposable/CompositeDisposable","gui/jsx/jsx","gui/jsx/HtmlView","engine/ResourceLoader","@puzzl/core/lib/async/cancellation","gui/screen/mainMenu/lobby/MapPreviewRenderer","util/array","LocalPrefs","util/typeGuard","gui/screen/mainMenu/lobby/PreferredHostOpts","gui/screen/mainMenu/MainMenuScreen","data/MapFile","engine/MapDigest","gui/screen/mainMenu/MainMenuRoute","engine/sound/Music","network/gameopt/Parser","network/gameopt/Serializer"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g}],execute:function(){ce=class extends te.MainMenuScreen{constructor(g,P,I,L,_,U,G,V,W,K){super(),this.rootController=g,this.errorHandler=P,this.messageBoxApi=I,this.strings=L,this.rules=_,this.jsxRenderer=U,this.mapFileLoader=G,this.mapList=V,this.gameModes=W,this.localPrefs=K,this.title=this.strings.get("GUI:SkirmishGame"),this.musicType=ne.MusicType.Intro,this.playerName="Player 1",this.disposables=new z.CompositeDisposable}onEnter(){this.controller.toggleMainVideo(!1),this.lobbyForm=void 0,this.initFormModel(),this.createGame()}async createGame(){try{await this.initOptions()}catch(g){return void this.handleError(g,g instanceof $.DownloadError?this.strings.get("TXT_DOWNLOAD_FAILED"):this.strings.get("WOL:MatchErrorCreatingGame"))}this.updateMapPreview(),this.updateFormModel(),this.controller.toggleSidebarPreview(!0),this.initView()}onViewportChange(){}onUnstack(g){if(g){let _=g.gameMode.id!==this.gameOpts.gameMode;this.gameOpts.gameMode=g.gameMode.id;let G=this.mapList.getByName(g.mapName),V=g.changedMapFile??this.currentMapFile;this.currentMapFile=V;var P=Z.findIndexReverse(this.slotsInfo,g=>g.type===L.SlotType.Ai||g.type===L.SlotType.Player||g.type===L.SlotType.Open),I=Math.max(0,P+1-G.maxSlots);for(let g=0;g<I;g++)this.slotsInfo[P-g].type=L.SlotType.Closed,this.gameOpts.aiPlayers[P-g]=void 0;let W=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings;[...this.gameOpts.humanPlayers,...this.gameOpts.aiPlayers].forEach(g=>{g&&(g.startPos>G.maxSlots-1&&(g.startPos=U.RANDOM_START_POS),_&&(g.teamId=W.alliesAllowed&&W.mustAlly?0:U.NO_TEAM_ID))}),this.applyGameOption(g=>{g.mapName=G.fileName,g.mapDigest=se.MapDigest.compute(V),g.mapSizeBytes=V.getSize(),g.mapTitle=G.getFullMapTitle(this.strings),g.maxSlots=G.maxSlots,g.mapOfficial=G.official}),this.localPrefs.setItem(X.StorageKey.LastMap,G.fileName),this.localPrefs.setItem(X.StorageKey.LastMode,String(g.gameMode.id)),this.saveBotSettings()}this.updateMapPreview(),this.initView()}async onStack(){await this.unrender()}initView(){this.initLobbyForm(),this.refreshSidebarButtons(),this.refreshSidebarMpText(),this.controller.showSidebarButtons()}async initOptions(){var g=this.localPrefs.getItem(X.StorageKey.PreferredGameOpts),P=this.localPrefs.getItem(X.StorageKey.LastPlayerCountry),I=this.localPrefs.getItem(X.StorageKey.LastPlayerColor),G=this.localPrefs.getItem(X.StorageKey.LastPlayerStartPos),V=this.localPrefs.getItem(X.StorageKey.LastPlayerTeam),W=this.localPrefs.getItem(X.StorageKey.LastMap),z=this.localPrefs.getItem(X.StorageKey.LastMode),K=this.localPrefs.getItem(X.StorageKey.LastBots);let q,$=W?this.mapList.getByName(W):void 0,Q=$&&z&&this.gameModes.hasId(Number(z))?Number(z):1,Y=this.gameModes.getById(Q);q=$?.gameModes.find(g=>g.mapFilter===Y.mapFilter)?$:(Q=1,Y=this.gameModes.getById(Q),this.mapList.getAll().find(g=>g.gameModes.find(g=>Y.mapFilter===g.mapFilter)));let Z=this.currentMapFile=await this.mapFileLoader.load(q.fileName),J=new ee.PreferredHostOpts;g?J.unserialize(g):J.applyMpDialogSettings(this.rules.mpDialogSettings);let te=Y.mpDialogSettings,re=_.AiDifficulty.Medium,ae=K?(new oe.Parser).parseAiOpts(K):void 0;ae&&this.sanitizeLastBotSettings(ae,I,G,q.maxSlots,te),this.gameOpts={gameMode:Q,shortGame:J.shortGame,mcvRepacks:J.mcvRepacks,cratesAppear:J.cratesAppear,superWeapons:J.superWeapons,gameSpeed:J.gameSpeed,credits:J.credits,unitCount:J.unitCount,buildOffAlly:J.buildOffAlly,destroyableBridges:J.destroyableBridges,multiEngineer:J.multiEngineer,noDogEngiKills:J.noDogEngiKills,humanPlayers:[{name:this.playerName,countryId:void 0!==P&&Number(P)<this.getAvailablePlayerCountries().length?Number(P):U.RANDOM_COUNTRY_ID,colorId:void 0!==I&&Number(I)<this.getAvailablePlayerColors().length?Number(I):U.RANDOM_COLOR_ID,startPos:void 0!==G&&Number(G)<this.getAvailableStartPositions(q.maxSlots).length?Number(G):U.RANDOM_START_POS,teamId:void 0!==V&&te.alliesAllowed&&Number(V)<4?Number(V):te.mustAlly?0:U.NO_TEAM_ID}],aiPlayers:[...new Array(8).fill(void 0).map((g,P)=>{if(P&&!(P>q.maxSlots-1)){var I=1<P||ae?ae?.[P]?.difficulty:re;if(void 0!==I)return{countryId:ae?.[P]?.countryId??U.RANDOM_COUNTRY_ID,colorId:ae?.[P]?.colorId??U.RANDOM_COLOR_ID,startPos:ae?.[P]?.startPos??U.RANDOM_START_POS,teamId:ae?.[P]?.teamId??(te.mustAlly?3:U.NO_TEAM_ID),difficulty:I}}})],mapName:q.fileName,mapDigest:se.MapDigest.compute(Z),mapSizeBytes:Z.getSize(),mapTitle:q.getFullMapTitle(this.strings),maxSlots:q.maxSlots,mapOfficial:q.official},this.slotsInfo=[{type:L.SlotType.Player,name:this.playerName},...this.gameOpts.aiPlayers.slice(1).map(g=>g?{type:L.SlotType.Ai,difficulty:g.difficulty}:{type:L.SlotType.Closed})]}sanitizeLastBotSettings(g,P,I,L,G){let V=0;for(let P=0;P<g.length;++P)g[P]&&(V++,V>L-1&&(g[P]=void 0));let W=void 0!==P?[Number(P)]:[],z=void 0!==I?[Number(I)]:[];for(var K of g)K&&(void 0===K.difficulty||_.AiDifficulty[K.difficulty]||(K.difficulty=_.AiDifficulty.Easy),void 0!==K.countryId&&K.countryId>=this.getAvailablePlayerCountries().length&&(K.countryId=U.RANDOM_COUNTRY_ID),void 0!==K.colorId&&K.colorId!==U.RANDOM_COUNTRY_ID&&(K.colorId>=this.getAvailablePlayerColors().length||W.includes(K.colorId)?K.colorId=U.RANDOM_COLOR_ID:W.push(K.colorId)),void 0!==K.startPos&&K.startPos!==U.RANDOM_START_POS&&(K.startPos>=this.getAvailableStartPositions(L).length||z.includes(K.startPos)?K.startPos=U.RANDOM_START_POS:z.push(K.startPos)),K.teamId!==U.NO_TEAM_ID?(4<=K.teamId||!G.alliesAllowed)&&(K.teamId=G.mustAlly?3:U.NO_TEAM_ID):G.mustAlly&&(K.teamId=3))}handleError(g,P){this.errorHandler.handle(g,P,()=>{this.controller?.goToScreen(W.ScreenType.Home)})}getAvailablePlayerCountryRules(){return this.rules.getMultiplayerCountries()}getAvailablePlayerCountries(){return this.getAvailablePlayerCountryRules().map(g=>g.name)}getAvailablePlayerColors(){return[...this.rules.getMultiplayerColors().values()].map(g=>g.asHexString())}getAvailableStartPositions(g){return new Array(g).fill(0).map((g,P)=>P)}getSelectablePlayerColors(g){let P=[];g.forEach(g=>{g&&P.push(g.color)});let I=this.getAvailablePlayerColors();return[U.RANDOM_COLOR_NAME].concat(I.filter(g=>g&&-1===P.indexOf(g)))}getSelectableStartPositions(g,P){let I=[];g.forEach(g=>{g&&I.push(g.startPos)});let L=this.getAvailableStartPositions(P);return[U.RANDOM_START_POS].concat(L.filter(g=>!I.includes(g)))}initFormModel(){var g=this.rules.mpDialogSettings;this.formModel={strings:this.strings,countryUiNames:new Map([[U.RANDOM_COUNTRY_NAME,U.RANDOM_COUNTRY_UI_NAME],[U.OBS_COUNTRY_NAME,U.OBS_COUNTRY_UI_NAME]].concat(this.getAvailablePlayerCountryRules().map(g=>[g.name,g.uiName]))),countryUiTooltips:new Map([[U.RANDOM_COUNTRY_NAME,U.RANDOM_COUNTRY_UI_TOOLTIP],[U.OBS_COUNTRY_NAME,U.OBS_COUNTRY_UI_TOOLTIP]].concat(this.getAvailablePlayerCountryRules().filter(g=>g.uiTooltip).map(g=>[g.name,g.uiTooltip]))),availablePlayerCountries:[U.RANDOM_COUNTRY_NAME].concat(this.getAvailablePlayerCountries()),availablePlayerColors:[],availableStartPositions:[],maxTeams:4,availableAiNames:U.aiUiNames,lobbyType:V.LobbyType.Singleplayer,mpDialogSettings:g,onCountrySelect:(g,P)=>{this.updatePlayerInfo(this.getCountryIdByName(g),this.getColorIdByName(this.formModel.playerSlots[P].color),this.formModel.playerSlots[P].startPos,this.formModel.playerSlots[P].team,P),this.updateFormModel()},onColorSelect:(g,P)=>{this.updatePlayerInfo(this.getCountryIdByName(this.formModel.playerSlots[P].country),this.getColorIdByName(g),this.formModel.playerSlots[P].startPos,this.formModel.playerSlots[P].team,P),this.updateFormModel()},onStartPosSelect:(g,P)=>{this.updatePlayerInfo(this.getCountryIdByName(this.formModel.playerSlots[P].country),this.getColorIdByName(this.formModel.playerSlots[P].color),g,this.formModel.playerSlots[P].team,P)},onTeamSelect:(g,P)=>{this.updatePlayerInfo(this.getCountryIdByName(this.formModel.playerSlots[P].country),this.getColorIdByName(this.formModel.playerSlots[P].color),this.formModel.playerSlots[P].startPos,g,P)},onSlotChange:(g,P,I)=>{this.changeSlotType(g,P,I),this.saveBotSettings()},onToggleShortGame:g=>this.applyGameOption(P=>P.shortGame=g),onToggleMcvRepacks:g=>this.applyGameOption(P=>P.mcvRepacks=g),onToggleCratesAppear:g=>this.applyGameOption(P=>P.cratesAppear=g),onToggleSuperWeapons:g=>this.applyGameOption(P=>P.superWeapons=g),onToggleBuildOffAlly:g=>this.applyGameOption(P=>P.buildOffAlly=g),onToggleDestroyableBridges:g=>this.applyGameOption(P=>P.destroyableBridges=g),onToggleMultiEngineer:g=>this.applyGameOption(P=>P.multiEngineer=g),onToggleNoDogEngiKills:g=>this.applyGameOption(P=>P.noDogEngiKills=g),onChangeGameSpeed:g=>this.applyGameOption(P=>P.gameSpeed=g),onChangeCredits:g=>this.applyGameOption(P=>P.credits=g),onChangeUnitCount:g=>this.applyGameOption(P=>P.unitCount=g),activeSlotIndex:0,teamsAllowed:!0,teamsRequired:!1,playerSlots:[],shortGame:!0,mcvRepacks:!0,cratesAppear:!0,superWeapons:!0,buildOffAlly:!0,destroyableBridges:!0,multiEngineer:!1,multiEngineerCount:Math.ceil((1-this.rules.general.engineerCaptureLevel)/this.rules.general.engineerDamage)+1,noDogEngiKills:!1,gameSpeed:6,credits:g.money,unitCount:g.unitCount}}applyGameOption(g){g(this.gameOpts),this.updateFormModel(),this.localPrefs.setItem(X.StorageKey.PreferredGameOpts,(new ee.PreferredHostOpts).applyGameOpts(this.gameOpts).serialize())}changeSlotType(g,P,I){var _;if(0===P)throw new Error("Change slot type of host");if(g===V.SlotOccupation.Occupied&&void 0!==I){var G=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings;let g=this.slotsInfo[P];g.type=L.SlotType.Ai,g.difficulty=I,(_=this.gameOpts.aiPlayers)[P]??(_[P]={difficulty:I,countryId:U.RANDOM_COUNTRY_ID,colorId:U.RANDOM_COLOR_ID,startPos:U.RANDOM_START_POS,teamId:G.mustAlly?3:U.NO_TEAM_ID}),this.gameOpts.aiPlayers[P].difficulty=I}g===V.SlotOccupation.Closed&&(this.slotsInfo[P].type=L.SlotType.Closed,this.gameOpts.aiPlayers[P]=void 0),this.updateFormModel()}saveBotSettings(){this.localPrefs.setItem(X.StorageKey.LastBots,(new le.Serializer).serializeAiOpts(this.gameOpts.aiPlayers))}getCountryNameById(g){let P;return P=g===U.RANDOM_COUNTRY_ID?U.RANDOM_COUNTRY_NAME:g===U.OBS_COUNTRY_ID?U.OBS_COUNTRY_NAME:this.getAvailablePlayerCountries()[g],P}getCountryIdByName(g){let P;if(g===U.RANDOM_COUNTRY_NAME)P=U.RANDOM_COUNTRY_ID;else if(g===U.OBS_COUNTRY_NAME)P=U.OBS_COUNTRY_ID;else{P=this.getAvailablePlayerCountries().indexOf(g)}return P}getColorNameById(g){let P;return P=g===U.RANDOM_COLOR_ID?U.RANDOM_COLOR_NAME:this.getAvailablePlayerColors()[g],P}getColorIdByName(g){let P;if(g===U.RANDOM_COLOR_NAME)P=U.RANDOM_COLOR_ID;else{if(P=this.getAvailablePlayerColors().indexOf(g),-1===P)throw new Error(`Color ${g} not found in available player colors`)}return P}updatePlayerInfo(g,P,I,_,G){const V=this.slotsInfo[G];if(V.type===L.SlotType.Ai){let L=this.gameOpts.aiPlayers[G];if(!L)throw new Error("No AI found on slot "+G);L.countryId=g,L.colorId=P,L.startPos=I,L.teamId=_,this.saveBotSettings()}else{if(V.type!==L.SlotType.Player)throw new Error("Unexpected slot type "+V.type);{let L=this.gameOpts.humanPlayers.find(g=>g.name===V.name);if(!L)throw new Error("No player found on slot "+G);L.countryId=g,L.colorId=P,L.startPos=I,L.teamId=_,g!==U.RANDOM_COUNTRY_ID?this.localPrefs.setItem(X.StorageKey.LastPlayerCountry,String(g)):this.localPrefs.removeItem(X.StorageKey.LastPlayerCountry),P!==U.RANDOM_COLOR_ID?this.localPrefs.setItem(X.StorageKey.LastPlayerColor,String(P)):this.localPrefs.removeItem(X.StorageKey.LastPlayerColor),I!==U.RANDOM_START_POS?this.localPrefs.setItem(X.StorageKey.LastPlayerStartPos,String(I)):this.localPrefs.removeItem(X.StorageKey.LastPlayerStartPos),_!==U.NO_TEAM_ID?this.localPrefs.setItem(X.StorageKey.LastPlayerTeam,String(_)):this.localPrefs.removeItem(X.StorageKey.LastPlayerTeam)}}this.updateFormModel()}updateFormModel(){var g=this.gameOpts;this.formModel.gameSpeed=g.gameSpeed,this.formModel.credits=g.credits,this.formModel.unitCount=g.unitCount,this.formModel.shortGame=g.shortGame,this.formModel.superWeapons=g.superWeapons,this.formModel.buildOffAlly=g.buildOffAlly,this.formModel.mcvRepacks=g.mcvRepacks,this.formModel.cratesAppear=g.cratesAppear,this.formModel.destroyableBridges=g.destroyableBridges,this.formModel.multiEngineer=g.multiEngineer,this.formModel.noDogEngiKills=g.noDogEngiKills;let P=g.maxSlots;this.slotsInfo.forEach((g,I)=>{P?(P--,this.formModel.playerSlots[I]={country:U.RANDOM_COUNTRY_NAME,color:U.RANDOM_COLOR_NAME,startPos:U.RANDOM_START_POS,team:U.NO_TEAM_ID}):this.formModel.playerSlots[I]=void 0}),this.slotsInfo.forEach((g,P)=>{if(this.formModel.playerSlots[P]){let I=this.formModel.playerSlots[P];g.type===L.SlotType.Closed?I.occupation=V.SlotOccupation.Closed:g.type===L.SlotType.Open||g.type===L.SlotType.OpenObserver?I.occupation=V.SlotOccupation.Open:I.occupation=V.SlotOccupation.Occupied,g.type===L.SlotType.Ai?(I.aiDifficulty=g.difficulty,I.type=V.SlotType.Ai):g.type===L.SlotType.Player&&(I.name=g.name,I.type=V.SlotType.Player),I.status=V.PlayerStatus.NotReady}});let I=this.gameOpts?this.gameOpts.humanPlayers:[],_=this.gameOpts?this.gameOpts.aiPlayers:[],G=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings;this.formModel.playerSlots.forEach((g,P)=>{var L;g&&I.length&&(g.occupation===V.SlotOccupation.Occupied?((L=I.find(P=>P.name===g.name))||(L=_[P]))&&(g.country=this.getCountryNameById(L.countryId),g.color=this.getColorNameById(L.colorId),g.startPos=L.startPos,g.team=L.teamId):(g.country=U.RANDOM_COUNTRY_NAME,g.team=G.mustAlly?3:U.NO_TEAM_ID))}),this.formModel.availablePlayerColors=this.getSelectablePlayerColors(this.formModel.playerSlots),this.formModel.availableStartPositions=this.getSelectableStartPositions(this.formModel.playerSlots,g.maxSlots),this.formModel.teamsAllowed=this.gameModes.getById(g.gameMode).mpDialogSettings.alliesAllowed,this.formModel.teamsRequired=this.gameModes.getById(g.gameMode).mpDialogSettings.mustAlly,this.lobbyForm&&I.length&&this.lobbyForm.refresh()}updateMapPreview(){this.mapTask?.cancel(),this.mapTask=new I.Task(async g=>{if(this.controller){let I;this.controller.setSidebarPreview();try{I=new re.MapFile(await this.mapFileLoader.load(this.gameOpts.mapName,g))}catch(g){if(g instanceof $.DownloadError)return void this.handleError(g,this.strings.get("TXT_DOWNLOAD_FAILED"));throw g}var P=new Y.MapPreviewRenderer(this.strings).render(I,V.LobbyType.Singleplayer,this.controller.getSidebarPreviewSize());this.controller.setSidebarPreview(P)}}),this.mapTask.start().catch(g=>{g instanceof Q.OperationCanceledError||(console.error("Failed to render map preview"),console.error(g))}),this.disposables.add(()=>this.mapTask?.cancel(),()=>this.mapTask=void 0)}initLobbyForm(){var[g]=this.jsxRenderer.render(K.jsx(q.HtmlView,{innerRef:g=>this.lobbyForm=g,component:G.LobbyForm,props:this.formModel}));this.controller.setMainComponent(g)}refreshSidebarButtons(){let g=this.strings;var P=[{label:g.get("GUI:StartGame"),tooltip:g.get("STT:SkirmishButtonStartGame"),disabled:!1,onClick:()=>{this.gameOpts.aiPlayers.filter(J.isNotNullOrUndefined).length<1?this.messageBoxApi.show(this.strings.get("TXT_NEED_AT_LEAST_TWO_PLAYERS"),this.strings.get("GUI:Ok")):this.meetsMinimumTeams()?this.rootController.createGame("0",Date.now(),void 0,this.playerName,this.gameOpts,!0,!1,!1,!1,new ae.MainMenuRoute(W.ScreenType.Skirmish)):this.messageBoxApi.show(this.strings.get("TXT_CANNOT_ALLY"),this.strings.get("GUI:Ok"))}},{label:g.get("GUI:ChooseMap"),tooltip:g.get("STT:SkirmishButtonChooseMap"),onClick:()=>{this.controller?.pushScreen(W.ScreenType.MapSelection,{lobbyType:V.LobbyType.Singleplayer,gameOpts:this.gameOpts,usedSlots:()=>1+Z.findIndexReverse(this.slotsInfo,g=>g.type===L.SlotType.Ai||g.type===L.SlotType.Player)})}},{label:g.get("GUI:Back"),tooltip:g.get("STT:SkirmishButtonBack"),isBottom:!0,onClick:()=>{this.controller?.goToScreen(W.ScreenType.Home)}}];this.controller.setSidebarButtons(P,!0),this.refreshSidebarMpText()}meetsMinimumTeams(){let g=[...this.gameOpts.humanPlayers,...this.gameOpts.aiPlayers].filter(J.isNotNullOrUndefined).filter(g=>g.countryId!==U.OBS_COUNTRY_ID),P=g[0].teamId;return P===U.NO_TEAM_ID||g.some(g=>g.teamId!==P)}refreshSidebarMpText(){this.controller?.setSidebarMpContent({text:this.gameOpts?this.strings.get(this.gameModes.getById(this.gameOpts.gameMode).label)+"\n\n"+this.gameOpts.mapTitle:""})}async onLeave(){this.disposables.dispose(),this.gameOpts=void 0,this.slotsInfo=void 0,this.currentMapFile=void 0,this.controller.toggleSidebarPreview(!1),await this.unrender()}async unrender(){await this.controller.hideSidebarButtons(),this.lobbyForm&&(this.lobbyForm=void 0)}},g("SkirmishScreen",ce)}}}),System.register("gui/screen/mainMenu/login/LoginBox",["react","gui/screen/mainMenu/login/ServerList","gui/screen/mainMenu/login/LoginDebugUi","@puzzl/core/lib/async/Task","network/HttpRequest","network/WolConfig"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){W=({regions:g,selectedRegion:P,selectedUser:W,pings:z,breakingNewsUrl:K,strings:q,devMode:$,onRegionChange:Q,onRequestRegionRefresh:Y,onSubmit:Z},X)=>{let J=I.useRef(null),ee=I.useRef(null),te=I.useRef(null),[re,se]=I.useState();I.useEffect(()=>{setTimeout(()=>ee.current?.focus(),50)},[]),I.useEffect(()=>{if(K){let g=new U.Task(async g=>{let P=await(new G.HttpRequest).fetchHtml(K,g);P=P.trim(),P.length&&se(P)});return g.start().catch(g=>console.error(g)),()=>g.cancel()}},[K]);const f=()=>{ee.current&&te.current&&Z(ee.current.value,te.current.value)};return I.useImperativeHandle(X,()=>({submit(){J.current?.requestSubmit?J.current.requestSubmit():f()}})),I.default.createElement("div",{className:"login-wrapper"},I.default.createElement("div",{className:"title"},q.get("GUI:Login")),I.default.createElement("form",{onSubmit:g=>{g.preventDefault(),f()},className:"login-form login-box",ref:J},I.default.createElement("div",{className:"field"},I.default.createElement("label",null,q.get("TS:Region")),W&&P?I.default.createElement("input",{type:"text",value:P.label,readOnly:!0}):I.default.createElement(I.default.Fragment,null,I.default.createElement(L.ServerList,{regionId:P?.id,regions:g,pings:z,strings:q,onChange:g=>{Q(g)}}),I.default.createElement("button",{type:"button",className:"icon-button refresh-button",onClick:Y}))),I.default.createElement("div",{className:"field"},I.default.createElement("label",null,q.get("GUI:Nickname")),I.default.createElement("input",{name:"user",type:"text",required:!0,minLength:V.MIN_USERNAME_LEN,maxLength:V.MAX_USERNAME_LEN,pattern:"[a-zA-Z0-9_\\-]+",ref:ee,value:W,readOnly:!!W})),I.default.createElement("div",{className:"field"},I.default.createElement("label",null,q.get("GUI:Password")),I.default.createElement("input",{name:"pass",type:"password",required:!0,maxLength:V.MAX_PASS_LEN,ref:te})),I.default.createElement("button",{type:"submit",style:{visibility:"hidden",position:"absolute",width:0,height:0}})),$&&I.default.createElement(_.LoginDebugUi,{onSubmit:Z}),re&&I.default.createElement("fieldset",{className:"news"},I.default.createElement("legend",null,q.get("GUI:BreakingNews")),I.default.createElement("div",{dangerouslySetInnerHTML:{__html:re}})))},g("LoginBox",I.forwardRef(W))}}}),System.register("gui/screen/mainMenu/login/LoginDebugUi",["react"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("TEST_USERS",L=["test1","test2","test3","test4","test5","test6","test7","test8"]),g("TEST_PASSWORD","testpass"),g("LoginDebugUi",({onSubmit:g})=>I.createElement("div",{className:"login-debug-ui"},I.createElement("div",{className:"login-debug-buttons"},L.map(P=>I.createElement("button",{key:P,type:"button",className:"login-debug-button",onClick:()=>g(P,"testpass")},P)))))}}}),System.register("gui/screen/mainMenu/login/LoginScreen",["gui/jsx/jsx","network/WolError","gui/screen/mainMenu/login/LoginBox","gui/screen/mainMenu/ScreenType","gui/jsx/HtmlView","@puzzl/core/lib/async/Task","@puzzl/core/lib/async/sleep","LocalPrefs","gui/screen/mainMenu/MainMenuScreen","gui/screen/mainMenu/login/ServerPings","@puzzl/core/lib/async/cancellation","gui/screen/mainMenu/MainMenuRoute"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g}],execute:function(){Y=void 0,Z=class extends K.MainMenuScreen{constructor(g,P,I,L,_,U,G,V,W,z,K,q,$,Q,Y){super(),this.wolService=g,this.wladderService=P,this.wgameresService=I,this.mapTransferService=L,this.strings=_,this.jsxRenderer=U,this.messageBoxApi=G,this.serverRegions=V,this.serversUrl=W,this.breakingNewsUrl=z,this.wolLogger=K,this.errorHandler=q,this.localPrefs=$,this.rootController=Q,this.devMode=Y,this.title=this.strings.get("GUI:Login"),this.needsServerListRefresh=!1,this.handleLoginSubmit=async(g,P)=>{var I;!this.isBusy&&this.loginBoxApi&&this.controller&&(this.isBusy=!0,(I=this.selectedRegion)&&(await this.controller.hideSidebarButtons(),await this.login(g,P,I.id)))}}async onEnter(g){this.params=g,this.formRendered=!1,this.controller.toggleMainVideo(!1),g.clearCredentials?Y=void 0:g.useCredentials&&(Y=g.useCredentials);try{await this.loadServerList()}catch(g){return void this.handleWolError(g,this.strings.get("TXT_NO_SERV_LIST"),{fatal:!0})}this.needsServerListRefresh=!1,this.serverPings=new q.ServerPings(this.serverRegions,this.wolLogger),Y&&this.serverRegions.isAvailable(Y.regionId)?(this.isBusy=!0,this.login(Y.user,Y.pass,Y.regionId)):(this.isBusy=!1,this.initView(!0))}async loadServerList(g){let P=!1;var I=setTimeout(async()=>{this.messageBoxApi.show(this.strings.get("TXT_CONNECTING")),P=!0},1e3);try{var L=await this.wolService.loadServerList(this.serversUrl,g);if(g?.isCancelled())return;this.serverRegions.load(L),this.selectedRegion&&(this.selectedRegion=this.serverRegions.getAll().find(g=>g.id===this.selectedRegion.id))}finally{clearTimeout(I),P&&this.messageBoxApi.destroy()}}initView(g=!1){if(this.controller){if(this.updateSidebarButtons(),this.isBusy||this.controller.showSidebarButtons(),!this.selectedRegion){var P=(P=this.localPrefs.getItem(z.StorageKey.PreferredServerRegion))&&this.serverRegions.isAvailable(P)?this.serverRegions.get(P):this.serverRegions.getFirstAvailable();let g=this.serverPings.pings;!P||g.has(P)&&void 0===g.get(P)?this.selectedRegion=void 0:this.selectedRegion=P}g&&!this.params.forceUser&&this.selectedRegion&&this.updateServers();var[P]=this.jsxRenderer.render(I.jsx(G.HtmlView,{width:"100%",height:"100%",component:_.LoginBox,props:{ref:g=>this.loginBoxApi=g,regions:this.serverRegions.getAll(),selectedRegion:this.selectedRegion,selectedUser:this.params.forceUser,pings:this.serverPings.pings,breakingNewsUrl:this.breakingNewsUrl,strings:this.strings,onRegionChange:g=>{this.selectedRegion=this.serverRegions.get(g),this.loginBox?.applyOptions(g=>g.selectedRegion=this.selectedRegion),this.updateSidebarButtons()},onRequestRegionRefresh:()=>{this.needsServerListRefresh=!0,this.updateServers()},onSubmit:this.handleLoginSubmit,devMode:this.devMode},innerRef:g=>this.loginBox=g}));this.controller.setMainComponent(P),this.updateSidebarButtons(),this.formRendered=!0}}updateSidebarButtons(){this.controller&&this.controller.setSidebarButtons([{label:this.strings.get("GUI:Login"),disabled:!this.selectedRegion,onClick:()=>{this.submitLoginForm()}},{label:this.strings.get("GUI:NewAccount"),disabled:!!this.params.forceUser,onClick:()=>{this.controller?.goToScreen(U.ScreenType.NewAccount,{regionId:this.selectedRegion?.id,afterLogin:this.params.afterLogin})}},{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.goToScreen(U.ScreenType.Home)}}])}updateServers(){this.isBusy||this.serversUpdateTask||(this.serverPings.pings.clear(),this.handleServerPingsUpdate(),this.serversUpdateTask=new V.Task(async g=>{if(this.formRendered||await W.sleep(500,g),this.needsServerListRefresh){this.needsServerListRefresh=!1;try{await this.loadServerList(g)}catch(g){return this.handleWolError(g,this.strings.get("TXT_NO_SERV_LIST"),{fatal:!0}),void(this.serversUpdateTask=void 0)}}this.loginBox?.applyOptions(g=>{g.selectedRegion=this.selectedRegion,g.regions=this.serverRegions.getAll()}),this.updateSidebarButtons();try{await this.serverPings.update(()=>this.handleServerPingsUpdate(),g)}finally{this.serversUpdateTask=void 0}this.handleServerPingsUpdate()}),this.serversUpdateTask.start().catch(g=>{g instanceof $.OperationCanceledError||console.error(g)}))}handleServerPingsUpdate(){if(this.loginBoxApi){var g=this.selectedRegion;let P=this.serverPings.pings;g&&P.has(g)&&void 0===P.get(g)&&(this.selectedRegion=void 0,this.loginBox?.applyOptions(g=>g.selectedRegion=void 0),this.updateSidebarButtons()),this.loginBox?.refresh()}}submitLoginForm(){!this.isBusy&&this.loginBoxApi&&this.controller&&this.selectedRegion&&this.loginBoxApi.submit()}async login(g,P,I){if(g.match(/^[A-Za-z0-9-_]+$/)){this.serversUpdateTask?.cancel(),this.serversUpdateTask=void 0;let G=new V.Task(async g=>{await W.sleep(1e3,g),g.isCancelled()||this.messageBoxApi.show(this.strings.get("TXT_CONNECTING"))});G.start().catch(g=>{g instanceof $.OperationCanceledError||console.error(g)});var _=this.serverRegions.get(I);this.serverRegions.setSelectedRegion(I);try{await this.wolService.validateGameVersion(_)}catch(g){let P;return G.cancel(),this.messageBoxApi.destroy(),P=g instanceof L.WolError&&g.code===L.WolError.Code.OutdatedClient?this.strings.get("TS:OutdatedClient"):this.strings.get("TXT_NO_SERV_LIST"),void this.handleWolError(g,P,{fatal:!1})}let K=!1;try{let L=[];this.wolService.isConnected()&&this.wolService.getConnection().getCurrentUser()||(L=await this.wolService.connectAndLogin({url:_.wolUrl,user:g,pass:P},({position:g,avgWaitSeconds:P})=>{G.cancel(),this.messageBoxApi.show(this.strings.get("TS:ServerFull")+"\n\n\n"+this.strings.get("TS:LoginPositionInQueue",g)+"\n"+this.strings.get("TS:LoginAvgWaitTime")+(0<P&&P<3600?this.strings.get("TS:LoginAvgWaitTimeMinutes",P<60?"<1":"~"+Math.ceil(P/60)):this.strings.get("TS:LoginAvgWaitTimeUnavail")),this.strings.get("GUI:Cancel"),()=>{K=!0,this.wolService.closeWolConnection()})}),this.wladderService.setUrl(_.wladderUrl),this.wgameresService.setUrl(_.wgameresUrl),this.mapTransferService.setUrl(_.mapTransferUrl),Y={user:g,pass:P,regionId:I}),G.cancel(),this.messageBoxApi.destroy(),this.localPrefs.setItem(z.StorageKey.PreferredServerRegion,I);var U=this.params.afterLogin(L);U instanceof Q.MainMenuRoute?this.controller?.goToScreen(U.screenType,U.params):this.rootController.goToScreen(U.screenType,U.params)}catch(g){if(G.cancel(),this.messageBoxApi.destroy(),K)return this.isBusy=!1,void(this.formRendered?(this.updateSidebarButtons(),this.controller?.showSidebarButtons()):this.initView());if(g instanceof L.WolError&&g.code===L.WolError.Code.OutdatedClient)return void this.handleWolError(g,this.strings.get("TS:OutdatedClient"),{fatal:!1});g instanceof L.WolError&&g.code===L.WolError.Code.BadLogin?(this.wolService.closeWolConnection(),this.handleBadPass()):g instanceof L.WolError&&g.code===L.WolError.Code.BannedFromServer?(this.wolService.closeWolConnection(),this.handleLoginError(g.reason??"This account is banned")):g instanceof L.WolError&&g.code===L.WolError.Code.ServerFull?this.handleLoginError(this.strings.get("TS:ServerFull")):this.handleWolError(g,this.strings.get("TS:ConnectFailed"),{fatal:!1,netError:!0})}}else this.handleBadPass()}handleBadPass(){this.handleLoginError(this.strings.get("TXT_BADPASS"))}handleLoginError(g){this.messageBoxApi.show(g,this.strings.get("GUI:Ok"),()=>{this.isBusy=!1,this.formRendered?(this.updateSidebarButtons(),this.controller.showSidebarButtons()):this.initView()})}handleWolError(g,P,{fatal:I,netError:L}){this.errorHandler.handle(g,P,()=>{this.isBusy=!1,this.serversUpdateTask?.cancel(),this.serversUpdateTask=void 0,this.wolService.closeWolConnection(),I?this.controller?.goToScreen(U.ScreenType.Home):this.formRendered?(this.updateSidebarButtons(),this.controller?.showSidebarButtons()):(L&&(this.needsServerListRefresh=!0),this.initView(L))})}async onLeave(){this.loginBoxApi=null,this.loginBox=void 0,this.formRendered=!1,this.serversUpdateTask?.cancel(),this.serversUpdateTask=void 0,this.isBusy||await this.controller.hideSidebarButtons(),this.isBusy=!1}},g("LoginScreen",Z)}}}),System.register("gui/screen/mainMenu/login/ServerList",["gui/component/List","react"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("ServerList",({regionId:g,regions:P,pings:_,strings:U,onChange:G})=>L.default.createElement(I.List,{className:"server-list"},P.map(P=>{var V=_.get(P);let W=!P.available||_.has(P)&&void 0===V;return L.default.createElement(I.ListItem,{key:P.id,selected:P.id===g&&!W,disabled:W,onClick:()=>!W&&G(P.id)},L.default.createElement("span",{className:"label"},P.label),L.default.createElement("span",{className:"ping"},W?L.default.createElement("span",{className:"offline-text"},U.get("TS:ServerOffline")):void 0!==V&&L.default.createElement("span",{className:"online-text"},U.get("TS:ServerOnline"))))})))}}}),System.register("gui/screen/mainMenu/login/ServerPingIndicator",["react","classnames","gui/component/Image"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){var P;(P=U=U||{})[P.Good=1]="Good",P[P.Average=2]="Average",P[P.Bad=3]="Bad",G=g=>g<=100?U.Good:g<=250?U.Average:U.Bad,V=(new Map).set(U.Bad,"pingr").set(U.Average,"pingy").set(U.Good,"pingg"),W=(new Map).set(U.Bad,"ping-bad").set(U.Average,"ping-avg").set(U.Good,"ping-good"),g("ServerPingIndicator",({ping:g,strings:P})=>{var U=G(g);return I.default.createElement("div",{className:"server-ping"},I.default.createElement("span",{className:L.default("ping-text",W.get(U))},P.get("TS:PingValue",g)),I.default.createElement(_.Image,{src:V.get(U)+".pcx"}))})}}}),System.register("gui/screen/mainMenu/login/ServerPings",["@puzzl/core/lib/async/cancellation","network/WolConnection"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("ServerPings",_=class o{constructor(g,P){this.regions=g,this.wolLogger=P,this.pings=new Map}async update(g,P){await Promise.all(this.regions.getAll().filter(g=>g.available).map(async _=>{let U,G=L.WolConnection.factory(this.wolLogger);try{await G.connect(_.wolUrl,{timeoutSeconds:o.CONNECT_TIMEOUT,cancelToken:P})}catch(U){return U instanceof I.OperationCanceledError||(console.error(U),G.close(),this.pings.set(_,void 0)),void g?.()}try{U=await G.ping(5)}catch(U){console.error(U)}finally{G.close()}P?.isCancelled()||(this.pings.set(_,U),g?.())}))}}),_.CONNECT_TIMEOUT=5}}}),System.register("gui/screen/mainMenu/main/HomeScreen",["gui/screen/mainMenu/ScreenType","gui/FullScreen","engine/sound/Music","gui/screen/options/component/getHumanReadableKey","gui/screen/mainMenu/MainMenuScreen","gui/screen/mainMenu/MainMenuRoute"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){W=class extends G.MainMenuScreen{constructor(g,P,I,L,U){super(),this.strings=g,this.fullScreen=P,this.appVersion=I,this.storageEnabled=L,this.quickMatchEnabled=U,this.title=this.strings.get("GUI:MainMenu"),this.musicType=_.MusicType.Intro}onEnter(){let g=this.strings;this.controller.setSidebarButtons([{label:g.get("GUI:QuickMatch"),tooltip:g.get("STT:WOLWelcomeQuickMatch"),disabled:!this.quickMatchEnabled,onClick:()=>{this.controller?.goToScreen(I.ScreenType.Login,{afterLogin:g=>new V.MainMenuRoute(I.ScreenType.QuickGame,{messages:g})})}},{label:g.get("GUI:CustomMatch"),tooltip:g.get("STT:WOLWelcomeCustomMatch"),onClick:()=>{this.controller?.goToScreen(I.ScreenType.Login,{afterLogin:g=>new V.MainMenuRoute(I.ScreenType.CustomGame,{messages:g})})}},{label:g.get("GUI:Demo"),tooltip:g.get("STT:Demo"),onClick:()=>{this.controller?.goToScreen(I.ScreenType.Skirmish)}},{label:g.get("GUI:Replays"),tooltip:g.get("STT:Replays"),onClick:()=>{this.controller?.pushScreen(I.ScreenType.ReplaySelection)}},...this.storageEnabled?[{label:g.get("GUI:Mods"),tooltip:g.get("STT:Mods"),onClick:()=>{this.controller?.pushScreen(I.ScreenType.ModSelection)}}]:[],{label:g.get("TS:InfoAndCredits"),tooltip:g.get("STT:InfoAndCredits"),onClick:()=>{this.controller?.pushScreen(I.ScreenType.InfoAndCredits)}},{label:g.get("GUI:Options"),tooltip:g.get("STT:MainButtonOptions"),onClick:()=>{this.controller?.pushScreen(I.ScreenType.Options)}},{label:g.get("GUI:Fullscreen",U.getHumanReadableKey(L.FullScreen.hotKey)),tooltip:g.get("STT:Fullscreen"),isBottom:!0,disabled:!this.fullScreen.isAvailable(),onClick:()=>this.fullScreen.toggle()}]),this.controller.showSidebarButtons(),this.controller.toggleMainVideo(!0),this.controller.showVersion(this.appVersion)}async onLeave(){this.controller.hideVersion(),await this.controller.hideSidebarButtons()}async onStack(){await this.onLeave()}onUnstack(){this.onEnter()}},g("HomeScreen",W)}}}),System.register("gui/screen/mainMenu/main/ReportBug",["react"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("ReportBug",({strings:g,discordUrl:P})=>I.createElement("div",null,g.get("TS:ReportBugDesc"),I.createElement("br",null),I.createElement("br",null),I.createElement("a",{target:"_blank",href:P},P)))}}}),System.register("gui/screen/mainMenu/MainMenuController",["gui/screen/Controller","engine/sound/SoundKey","engine/sound/ChannelType"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class extends I.Controller{constructor(g,P,I){super(),this.mainMenu=g,this.sound=P,this.music=I}async goToScreenBlocking(...g){var[P,I]=g;return super.goToScreenBlocking(P,I)}goToScreen(...g){var[P,I]=g;return super.goToScreen(P,I)}async pushScreen(...g){var[P,I]=g;this.setMainComponent(),this.mainMenu.setSidebarTitle(""),await super.pushScreen(P,I),(P=this.screens.get(P)).title&&this.mainMenu.setSidebarTitle(P.title),void 0!==P.musicType&&this.music?.play(P.musicType).catch(g=>console.warn("Failed to play menu music",g))}async popScreen(g){this.setMainComponent(),this.mainMenu.setSidebarTitle(""),await super.popScreen(g);var P=this.getCurrentScreen();P?.title&&this.mainMenu.setSidebarTitle(P.title)}setSidebarButtons(g,P=!1){this.mainMenu.setButtons(g,P)}showSidebarButtons(){this.mainMenu.isSidebarCollapsed()&&(this.sound.play(L.SoundKey.GUIMoveInSound,_.ChannelType.Ui),this.mainMenu.showButtons())}setSidebarMpContent(g){this.mainMenu.setSidebarMpContent(g)}hideSidebarButtons(){if(!this.mainMenu.isSidebarCollapsed())return this.sound.play(L.SoundKey.GUIMoveOutSound,_.ChannelType.Ui),new Promise(g=>{let t=()=>{this.mainMenu.onSidebarToggle.unsubscribe(t),g()};this.mainMenu.onSidebarToggle.subscribe(t),this.mainMenu.hideButtons()})}toggleSidebarPreview(g){this.mainMenu.toggleSidebarPreview(g)}setSidebarPreview(g){this.mainMenu.setSidebarPreview(g)}getSidebarPreviewSize(){return this.mainMenu.getSidebarPreviewSize()}toggleMainVideo(g){this.mainMenu.toggleVideo(g)}showVersion(g){this.mainMenu.showVersion(g)}hideVersion(){this.mainMenu.hideVersion()}setMainComponent(g){this.mainMenu.setContentComponent(g)}destroy(){this.setMainComponent(void 0),super.destroy()}},g("MainMenuController",U)}}}),System.register("gui/screen/mainMenu/MainMenuRootScreen",["gui/jsx/jsx","gui/screen/mainMenu/component/MainMenu","gui/screen/mainMenu/MainMenuController","gui/screen/mainMenu/ScreenType","engine/resourceConfigs","util/disposable/CompositeDisposable","@puzzl/core/lib/async/Task","@puzzl/core/lib/async/cancellation","gui/jsx/HtmlView","gui/screen/mainMenu/component/PrefetchProgress","@puzzl/core/lib/async/sleep","gui/screen/RootScreen"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g}],execute:function(){Y=class extends Q.RootScreen{constructor(g,P,I,L,_,U,G,W,z,K,q){super(),this.subScreens=g,this.uiScene=P,this.gameResConfig=I,this.strings=L,this.images=_,this.jsxRenderer=U,this.videoSrc=G,this.cdnResourceLoader=W,this.sound=z,this.music=K,this.sentry=q,this.prefetched=!1,this.disposables=new V.CompositeDisposable}createView(){var g;this.mainMenu=new L.MainMenu(this.uiScene.menuViewport,this.images,this.jsxRenderer,this.videoSrc),!this.prefetched&&this.gameResConfig.isCdn()&&([g]=this.jsxRenderer.render(I.jsx(K.HtmlView,{component:q.PrefetchProgress,ref:g=>this.prefetchProgressView=g,props:{progress:0,statusText:this.strings.get("TS:Preloading")}})),this.prefetchProgressEl=g,this.prefetched=!0,this.updatePrefetchProgressViewport())}createViewAndController(){return this.createView(),this.mainMenuCtrl=new _.MainMenuController(this.mainMenu,this.sound,this.music),this.mainMenuCtrl.onScreenChange.subscribe(g=>this.sentry?.addBreadcrumb({category:"ui",message:void 0!==g?"Navigated to screen "+U.ScreenType[g]:"Navigated to previous screen",level:"info"})),this.mainMenuCtrl}onViewportChange(){this.mainMenu.setViewport(this.uiScene.menuViewport),this.mainMenuCtrl?.rerenderCurrentScreen(),this.updatePrefetchProgressViewport()}onEnter(g){let P=this.createViewAndController();for(var[I,L]of this.subScreens)P.addScreen(I,L);if(this.uiScene.add(this.mainMenu),setTimeout(()=>{g?.route?P.goToScreen(g.route.screenType,g.route.params):P.goToScreen(U.ScreenType.Home)}),this.prefetchProgressEl){let g=!1,P=new W.Task(async P=>{await $.sleep(5e3,P),$.sleep(15e3,P).then(()=>{g||this.uiScene.add(this.prefetchProgressEl)}).catch(g=>{if(!(g instanceof z.OperationCanceledError))throw g}),await this.cdnResourceLoader.loadResources(G.resourcesForPrefetch,P,g=>{this.prefetchProgressView.getElement().applyOptions(P=>P.progress=g)}),g=!0,this.uiScene.remove(this.prefetchProgressEl)});P.start().catch(P=>{this.prefetchProgressEl&&this.uiScene.remove(this.prefetchProgressEl),g=!0,P instanceof z.OperationCanceledError||console.error(P)}).then(()=>P=void 0),this.disposables.add(()=>{P?.cancel(),this.prefetchProgressEl.destroy(),this.prefetchProgressEl=void 0,this.prefetchProgressView=void 0})}}updatePrefetchProgressViewport(){this.prefetchProgressEl?.getHtmlContainer()?.setSize(this.uiScene.viewport.width,0)}async onLeave(){this.mainMenuCtrl&&(this.mainMenuCtrl.toggleMainVideo(!1),await this.mainMenuCtrl.leaveCurrentScreen(),this.mainMenuCtrl.destroy(),this.mainMenuCtrl=void 0),this.uiScene.remove(this.mainMenu),this.mainMenu.destroy(),this.mainMenu=void 0,this.disposables.dispose()}},g("MainMenuRootScreen",Y)}}}),System.register("gui/screen/mainMenu/MainMenuRoute",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("MainMenuRoute",class{constructor(...g){var[P,I]=g;this.screenType=P,this.params=I}})}}}),System.register("gui/screen/mainMenu/MainMenuScreen",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("MainMenuScreen",class{setController(g){this.controller=g}})}}}),System.register("gui/screen/mainMenu/mapSel/component/MapSel",["react","gui/component/List","gui/component/Select","gui/component/Option"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){var P;(P=G||g("SortType",G={})).None="",P.NameAsc="nameAsc",P.NameDesc="nameDesc",P.MaxSlotsAsc="maxSlotsAsc",P.MaxSlotsDesc="maxSlotsDesc",V=(g,P)=>{switch(P){case G.None:return g;case G.NameAsc:return g.sort((g,P)=>g.mapTitle.localeCompare(P.mapTitle));case G.NameDesc:return g.sort((g,P)=>P.mapTitle.localeCompare(g.mapTitle));case G.MaxSlotsAsc:return g.sort((g,P)=>g.maxSlots-P.maxSlots);case G.MaxSlotsDesc:return g.sort((g,P)=>P.maxSlots-g.maxSlots);default:throw new Error(`Unsupported sort type "${P}"`)}},g("MapSel",({strings:g,gameModes:P,maps:W,selectedGameMode:z,selectedMapName:K,initialSortType:q,onSelectGameMode:$,onSelectMap:Q,onSelectSort:Y})=>{const Z=I.useRef(null),[X,J]=I.useState(W),[ee,te]=I.useState(""),[re,se]=I.useState(q);I.useEffect(()=>{f()},[W,ee,re]),I.useEffect(()=>{let g=setTimeout(()=>Z.current?.scrollIntoView(),50);return()=>clearTimeout(g)},[W]);const f=()=>{J(V(W.filter(g=>g.mapTitle.toLowerCase().includes(ee.toLowerCase())),re))};return I.default.createElement("div",{className:"map-sel-form"},I.default.createElement("div",{className:"map-sel-title"},g.get("GUI:SelectEngagement")),I.default.createElement("div",{className:"map-sel-body"},I.default.createElement("div",{className:"map-sel-game-mode"},I.default.createElement(L.List,{title:g.get("GUI:GameType"),className:"game-mode-list",tooltip:g.get("STT:ScenarioListGameType")},P.map(P=>I.default.createElement(L.ListItem,{key:P.id,selected:z===P,onClick:()=>$(P),"data-r-tooltip":g.get(P.description)},g.get(P.label))))),I.default.createElement("div",{className:"map-sel-map"},I.default.createElement(L.List,{title:I.default.createElement("div",{className:"map-list-title"},I.default.createElement("div",null,g.get("GUI:GameMap")),I.default.createElement("div",{className:"map-list-sort","data-r-tooltip":g.get("STT:SortBy")},I.default.createElement("label",null,""),I.default.createElement(_.Select,{initialValue:re,onSelect:g=>(g=>{se(g),Y(g)})(g),className:"map-list-sort-select"},I.default.createElement(U.Option,{value:G.None,label:g.get("TS:SortNone")}),I.default.createElement(U.Option,{value:G.NameAsc,label:g.get("TS:SortName")+" "}),I.default.createElement(U.Option,{value:G.NameDesc,label:g.get("TS:SortName")+" "}),I.default.createElement(U.Option,{value:G.MaxSlotsAsc,label:g.get("TS:SortMaxSlots")+" "}),I.default.createElement(U.Option,{value:G.MaxSlotsDesc,label:g.get("TS:SortMaxSlots")+" "})))),className:"map-list",tooltip:g.get("STT:ScenarioListMaps")},X.map(g=>{var P=g.mapName===K;return I.default.createElement(L.ListItem,{key:g.mapName,selected:P,innerRef:P?Z:null,onClick:()=>Q(g.mapName,!1),onDoubleClick:()=>Q(g.mapName,!0)},g.mapTitle)})),I.default.createElement("div",{className:"map-sel-search"},I.default.createElement("label",null,I.default.createElement("span",null,g.get("GUI:Search")),I.default.createElement("input",{type:"text",className:"new-message",value:ee,onChange:g=>{var P=g.target.value;te(P)}}))))))})}}}),System.register("gui/screen/mainMenu/mapSel/MapSelScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/mainMenu/mapSel/component/MapSel","gui/screen/mainMenu/lobby/MapPreviewRenderer","@puzzl/core/lib/async/Task","@puzzl/core/lib/async/cancellation","gui/screen/mainMenu/MainMenuScreen","game/ini/GameModeType","LocalPrefs","data/MapFile","data/vfs/VirtualFile","engine/MapSupport","data/vfs/IOError","data/vfs/StorageQuotaError","data/vfs/FileNotFoundError","engine/Engine","util/disposable/CompositeDisposable","engine/ResourceLoader","engine/MapManifest","data/vfs/NameNotAllowedError"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g}],execute:function(){ae=class extends W.MainMenuScreen{constructor(g,P,I,L,_,U,G,V,W,z,q){super(),this.strings=g,this.jsxRenderer=P,this.mapFileLoader=I,this.errorHandler=L,this.messageBoxApi=_,this.localPrefs=U,this.mapList=G,this.gameModes=V,this.mapDir=W,this.fsAccessLib=z,this.sentry=q,this.title=this.strings.get("GUI:ChooseMap"),this.disposables=new ee.CompositeDisposable,this.handleSelectMap=(g,P)=>{var I=this.selectedMapName!==g;this.selectedMapName=g,this.refreshMapInfo(),I&&(this.updateMapDeferred({updatePreview:!P}),this.initSidebar()),this.form.applyOptions(P=>P.selectedMapName=g),P&&this.handleSubmit()},this.handleSelectGameMode=g=>{this.selectedGameMode=g;let P=this.computeAvailableMaps();P.find(g=>g.mapName===this.selectedMapName)||this.handleSelectMap(P[0].mapName,!1),this.refreshMapInfo(),this.form.applyOptions(I=>{I.selectedGameMode=g,I.maps=P})},this.handleSelectSort=g=>{this.localPrefs.setItem(K.StorageKey.LastSortMap,g)}}onEnter({gameOpts:g,usedSlots:P,lobbyType:I}){this.updateMapsAndModes(),this.selectedGameMode=this.availableGameModes.find(P=>P.id===g.gameMode),this.selectedMapName=g.mapName,this.lobbyType=I,this.computeUsedSlots=P,this.initSidebar(),this.initForm()}updateMapsAndModes(){let g=this.gameModes.getAll().filter(g=>this.mapList.getAll().find(P=>P.gameModes.some(P=>P.id===g.id)));var P=this.mapList.getAll().map(g=>({mapName:g.fileName,mapTitle:g.getFullMapTitle(this.strings),maxSlots:g.maxSlots,gameModes:g.gameModes}));this.availableGameModes=g.filter(g=>g.type!==z.GameModeType.Cooperative).sort((g,P)=>g.id-P.id),this.allMaps=P}initForm(){this.controller.setMainComponent(this.jsxRenderer.render(I.jsx(L.HtmlView,{innerRef:g=>this.form=g,component:_.MapSel,props:{strings:this.strings,maps:this.computeAvailableMaps(),gameModes:this.availableGameModes,selectedMapName:this.selectedMapName,selectedGameMode:this.selectedGameMode,initialSortType:this.readInitialSort(),onSelectMap:this.handleSelectMap,onSelectGameMode:this.handleSelectGameMode,onSelectSort:this.handleSelectSort}}))[0])}readInitialSort(){let g=this.localPrefs.getItem(K.StorageKey.LastSortMap);return g&&Object.values(_.SortType).includes(g)||(g=_.SortType.None),g}initSidebar(){this.controller.setSidebarButtons([{label:this.strings.get("GUI:UseMap"),tooltip:this.strings.get("STT:ScenarioButtonUseMap"),onClick:()=>{this.handleSubmit()}},...this.mapDir?[{label:this.strings.get("TS:ImportMap"),tooltip:this.strings.get("STT:ImportMap"),onClick:async()=>{let g=new V.CancellationTokenSource;var t=()=>g.cancel();this.disposables.add(t);try{await this.importMap(g.token)}catch(g){return void(g instanceof V.OperationCanceledError||this.handleMapImportError(g))}finally{this.disposables.remove(t)}}}]:[],{label:this.strings.get("GUI:Cancel"),tooltip:this.strings.get("STT:ScenarioButtonCancel"),isBottom:!0,onClick:()=>{this.controller?.popScreen()}}],!0),this.refreshMapInfo(),this.controller.showSidebarButtons()}async importMap(g){let P,I=J.Engine.supportedMapTypes.get(J.Engine.getActiveEngine());if(!I)throw new Error(`No supported map types found for engine type "${J.Engine.getActiveEngine()}"`);try{var L=await this.fsAccessLib.showOpenFilePicker({types:[{description:"RA2 Map",accept:{"text/plain":I.map(g=>"."+g)}}],excludeAcceptAllOption:!0});let g=Array.isArray(L)?L[0]:L;P=await g.getFile()}catch(g){if("AbortError"===g.name)return;if(g instanceof DOMException)throw new Y.IOError(`File could not be read (${g.name})`,{cause:g});throw g}if(I.some(g=>P.name.toLowerCase().endsWith("."+g)))if(this.mapList.getByName(P.name))await this.messageBoxApi.alert(this.strings.get("TS:ImportMapDuplicateError",P.name),this.strings.get("GUI:Ok"));else{let I,U;L=await $.VirtualFile.fromRealFile(P);try{I=new q.MapFile(L);var _=Q.MapSupport.check(I,this.strings);if(_)return void await this.messageBoxApi.alert(_,this.strings.get("GUI:Ok"));U=(new re.MapManifest).fromMapFile(L,this.gameModes.getAll())}catch(g){return console.error(g),void await this.messageBoxApi.alert(this.strings.get("TXT_MAP_ERROR"),this.strings.get("GUI:Ok"))}if((I.unknownActionTypes.size||I.unknownEventTypes.size)&&!await this.messageBoxApi.confirm(this.strings.get("TS:MapUnsupportedTriggers"),this.strings.get("GUI:Continue"),this.strings.get("GUI:Cancel")))return;let G=U.gameModes;G.length?(await this.mapDir.writeFile(L),this.mapList.add(U),g.throwIfCancelled(),this.updateMapsAndModes(),this.form.applyOptions(g=>{g.gameModes=this.availableGameModes,g.maps=this.computeAvailableMaps()}),G.some(g=>this.selectedGameMode.id===g.id)||this.handleSelectGameMode(G[0]),this.handleSelectMap(L.filename,!1)):await this.messageBoxApi.alert(this.strings.get("TS:MapUnsupportedGameMode"),this.strings.get("GUI:Ok"))}else await this.messageBoxApi.alert(this.strings.get("TS:ImportMapUnsupportedType",I.map(g=>"*."+g).join(", ")),this.strings.get("GUI:Ok"))}handleMapImportError(g){let P=this.strings,I=P.get("TS:ImportMapError");"QuotaExceededError"===g.name||g instanceof Z.StorageQuotaError?I+="\n\n"+P.get("ts:storage_quota_exceeded"):g instanceof se.NameNotAllowedError?I+="\n\n"+P.get("TS:FileNameError"):g instanceof Y.IOError||g instanceof X.FileNotFoundError||this.sentry?.captureException(new Error("Map import failed "+(g.message??g.name),{cause:g})),this.errorHandler.handle(g,I,()=>{})}async handleSubmit(){let g=new V.CancellationTokenSource;var t=()=>g.cancel();this.disposables.add(t);try{await this.submitMap(g.token)}catch(g){if(!(g instanceof V.OperationCanceledError))throw g}finally{this.disposables.remove(t)}}async submitMap(g){let P,I=!1;if(this.mapFileUpdateTask){this.form.hide(),this.controller?.hideSidebarButtons(),I=!0;try{await this.mapFileUpdateTask.wait()}catch(g){}}if(g.throwIfCancelled(),this.changedMapFile)try{var L=new q.MapFile(this.changedMapFile),_=Q.MapSupport.check(L,this.strings);if(_)return void await this.messageBoxApi.alert(_,this.strings.get("GUI:Ok"))}catch(g){return console.error(g),await this.messageBoxApi.alert(this.strings.get("TXT_MAP_ERROR"),this.strings.get("GUI:Ok")),void(I&&(this.form.show(),this.controller?.showSidebarButtons()))}P=!(this.computeUsedSlots()>this.allMaps.find(g=>g.mapName===this.selectedMapName).maxSlots)||await this.messageBoxApi.confirm(this.strings.get("GUI:EjectPlayers"),this.strings.get("GUI:Ok"),this.strings.get("GUI:Cancel")),g.throwIfCancelled(),P?await(this.controller?.popScreen({gameMode:this.selectedGameMode,mapName:this.selectedMapName,changedMapFile:this.changedMapFile})):I&&(this.form.show(),this.controller?.showSidebarButtons())}computeAvailableMaps(){return this.allMaps.filter(g=>g.gameModes.some(g=>g.id===this.selectedGameMode.id))}refreshMapInfo(){this.controller?.setSidebarMpContent({text:this.strings.get(this.selectedGameMode.label)+"\n\n"+this.allMaps.find(g=>g.mapName===this.selectedMapName)?.mapTitle})}async onLeave(){this.computeUsedSlots=void 0,this.availableGameModes=void 0,this.allMaps=void 0,this.messageBoxApi.destroy(),this.form=void 0,this.mapFileUpdateTask?.cancel(),this.mapFileUpdateTask=void 0,this.controller.setMainComponent(),this.disposables.dispose(),await this.controller.hideSidebarButtons()}updateMapDeferred({updatePreview:g}){this.mapFileUpdateTask?.cancel(),this.mapFileUpdateTask=new G.Task(async P=>{if(this.controller){let L;g&&this.controller.setSidebarPreview(),this.changedMapFile=void 0;try{L=this.changedMapFile=await this.mapFileLoader.load(this.selectedMapName,P)}catch(g){if(g instanceof te.DownloadError)return void this.errorHandler.handle(g,this.strings.get("TXT_DOWNLOAD_FAILED"),()=>{this.controller?.popScreen()});throw g}var I;g&&!P.isCancelled()&&(I=new U.MapPreviewRenderer(this.strings).render(new q.MapFile(L),this.lobbyType,this.controller.getSidebarPreviewSize()),this.controller.setSidebarPreview(I)),this.mapFileUpdateTask=void 0}}),this.mapFileUpdateTask.start().catch(g=>{g instanceof V.OperationCanceledError||(console.error("Failed to render map preview"),console.error(g))})}},g("MapSelScreen",ae)}}}),System.register("gui/screen/mainMenu/modSel/BadModArchiveError",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){I=class extends Error{},g("BadModArchiveError",I)}}}),System.register("gui/screen/mainMenu/modSel/DuplicateModError",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){I=class extends Error{},g("DuplicateModError",I)}}}),System.register("gui/screen/mainMenu/modSel/Mod",["gui/screen/mainMenu/modSel/ModStatus"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("Mod",class{get id(){return this.meta.id}get name(){return this.meta.name}get supported(){return this.meta.supported}constructor(g,P){if(g)P&&P.version!==g.version?(this.status=I.ModStatus.UpdateAvailable,this.meta=g.clone(),this.meta.download=P.download,this.meta.downloadSize=P.downloadSize,this.meta.manualDownload=P.manualDownload,this.latestVersion=P.version):(this.status=I.ModStatus.Installed,this.meta=g,this.latestVersion=g.version);else{if(this.status=I.ModStatus.NotInstalled,!P)throw new Error("At least a local or remote meta must be specified");this.meta=P,this.latestVersion=P.version}}isInstalled(){return this.status!==I.ModStatus.NotInstalled}})}}}),System.register("gui/screen/mainMenu/modSel/ModDetailsPane",["react","gui/screen/mainMenu/modSel/ModStatus"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=new Map([[L.ModStatus.Installed,"GUI:ModStatusInstalled"],[L.ModStatus.UpdateAvailable,"GUI:ModStatusUpdateAvail"],[L.ModStatus.NotInstalled,"GUI:ModStatusNotInstalled"]]),g("ModDetailsPane",({modDetails:{supported:g,name:P,description:L,authors:U,version:G,website:V},modLoaded:W,modStatus:z,strings:K})=>I.createElement("div",{className:"mod-details"},I.createElement("table",null,I.createElement("tbody",null,I.createElement("tr",null,I.createElement("td",null,K.get("GUI:ModName"),":"),I.createElement("td",null,P)),I.createElement("tr",null,I.createElement("td",null,K.get("GUI:ModStatus"),":"),I.createElement("td",null,K.get(_.get(z)??"GUI:Unknown"),W?", "+K.get("GUI:ModLoaded"):"",g?"":", "+K.get("GUI:ModUnsupported"))),G&&I.createElement("tr",null,I.createElement("td",null,K.get("GUI:ModVersion"),":"),I.createElement("td",null,G)),L&&I.createElement("tr",null,I.createElement("td",null,K.get("GUI:ModDescription"),":"),I.createElement("td",{className:"mod-desc"},L)),U&&I.createElement("tr",null,I.createElement("td",null,K.get("GUI:ModAuthor"),":"),I.createElement("td",null,U.join(", "))),V&&I.createElement("tr",null,I.createElement("td",null,K.get("GUI:ModWebsite"),":"),I.createElement("td",null,I.createElement("a",{href:V,rel:"nofollow noopener",target:"_blank"},V)))))))}}}),System.register("gui/screen/mainMenu/modSel/ModDownloadPrompt",["react"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("ModDownloadPrompt",({url:g,sizeMb:P,isUpdate:L,strings:_,onClick:U})=>I.createElement("div",null,L&&I.createElement("p",{style:{marginTop:0}},_.get("GUI:ModUpdateAvail")),I.createElement("p",null,_.get("GUI:ManualDownloadModPrompt")),I.createElement("a",{href:g,rel:"nofollow noopener",target:"_blank",onClick:U},g),I.createElement("br",null),I.createElement("br",null),I.createElement("em",null,_.get("ts:gameres_download_size",P))))}}}),System.register("gui/screen/mainMenu/modSel/ModImporter",["util/time","data/vfs/IOError","engine/gameRes/importError/ArchiveExtractionError","engine/gameRes/importError/InvalidArchiveError","gui/screen/mainMenu/modSel/ModManager","gui/screen/mainMenu/modSel/ModMeta","gui/screen/mainMenu/modSel/BadModArchiveError","data/IniFile","gui/screen/mainMenu/modSel/DuplicateModError","data/vfs/VirtualFile"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g}],execute:function(){g("ModImporter",$=class M{constructor(g,P,I){this.strings=g,this.messageBoxApi=P,this.storage=I}async import(g,P,q,$){let Q,Y,Z,X=this.strings;try{let g=await SystemJS.import("7z-wasm");Z=await g({quit:(g,P)=>{Q=g,Y=P}})}catch(g){if(g instanceof WebAssembly.RuntimeError)throw new L.IOError("Couldn't load 7z-wasm",{cause:g});throw g}$(X.get("ts:import_loading_archive")),Z.FS.chdir("/tmp");var J=g.name;try{var ee=await g.arrayBuffer(),te=Z.FS.open(J,"w+");Z.FS.write(te,new Uint8Array(ee),0,ee.byteLength,0,!0),Z.FS.close(te)}catch(g){if(g instanceof DOMException)throw new L.IOError(`File "${J}" could not be read (${g.name})`,{cause:g});throw g}if($(X.get("ts:import_extracting_archive")),await I.sleep(100),Z.callMain(["x","-ssc-","-x!*/",J,"*.*"]),Q){if(1!==Q)throw new U.InvalidArchiveError("7-Zip exited with code "+Q,{cause:Y});if(Y?.message?.match(/out of memory|allocation/i))throw new RangeError("Out of memory",{cause:Y});throw new _.ArchiveExtractionError("Archive extraction failed with code "+Q,{cause:Y})}Z.FS.unlink(J);let re=Z.FS.lookupPath(Z.FS.cwd()).node,se=Object.keys(re.contents),ae=new V.ModMeta;var ne;te=()=>{for(var g of(({node:re}=Z.FS.lookupPath(Z.FS.cwd())),se=Object.keys(re.contents),se))Z.FS.unlink(g)};let oe=0;for(ne of se)oe+=Z.FS.stat(ne).size;if(this.storage?.estimate&&(J=await this.storage.estimate().catch(g=>{console.warn("Couldn't get storage estimate",[g])}),J?.quota&&J.usage&&(J=J.quota-J.usage)<oe+1048576))return await this.messageBoxApi.alert(X.get("GUI:InstallModStorageFull",J/1024/1024,oe/1024/1024),X.get("GUI:OK")),void te();try{let I,L=await P.listEntries();if(se.includes(G.ModManager.modMetaFileName)){let P=this.readFileFromEmFs(Z.FS,G.ModManager.modMetaFileName);try{ae.fromIniFile(new z.IniFile(P.readAsString("utf-8")))}catch(g){throw new W.BadModArchiveError("Mod meta file is invalid")}if(I=ae.id,!q&&L.find(g=>g.toLowerCase()===I))throw new K.DuplicateModError(`A mod with the id "${ae.id}" already exists`)}else{if(!se.some(g=>M.modFileExtensions.includes(re.contents[g].name.toLowerCase().split(".").pop())))throw new W.BadModArchiveError("Archive doesn't contain a valid mod");if(!await this.messageBoxApi.confirm(this.strings.get("GUI:ImportModUnsupportedWarn"),this.strings.get("GUI:Continue"),this.strings.get("GUI:Cancel")))return void te();if(I=await this.promptFolderName(L),!I)return void te();ae.id=I,ae.name=I}let _=await P.getOrCreateDirectory(I);for await(var le of _.getFileHandles())await _.deleteFile(le.name);for(var ce of se){$(X.get("ts:import_importing",ce));try{var he=this.readFileFromEmFs(Z.FS,ce);await _.writeFile(he)}catch(g){throw await P.deleteDirectory(_.name,!0),g}finally{Z.FS.unlink(ce)}}}finally{te()}return ae}async promptFolderName(g){let P,I=this.strings;for(;;){if(P=await this.messageBoxApi.prompt(I.get("GUI:ImportModFolderPrompt"),I.get("GUI:Ok"),I.get("GUI:Cancel")),!P)return;if(P.match(G.ModManager.modIdRegex)){if(!g.some(g=>g.toLowerCase()===P))break;await this.messageBoxApi.alert(I.get("GUI:ImportModFolderExists"),I.get("GUI:Ok"))}else await this.messageBoxApi.alert(I.get("GUI:ImportModFolderBadName"),I.get("GUI:Ok"))}return P}readFileFromEmFs(g,P){g.chmod(P,448);let I=g.lookupPath(P).node;var L=I.contents.subarray(0,I.usedBytes);return q.VirtualFile.fromBytes(L,P.slice(P.lastIndexOf("/")+1))}}),$.modFileExtensions=["ini","mix"]}}}),System.register("gui/screen/mainMenu/modSel/ModManager",["data/IniFile","RouteHelper","gui/screen/mainMenu/modSel/Mod","gui/screen/mainMenu/modSel/ModMeta"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("ModManager",G=class c{constructor(g,P,I){this.location=g,this.modDir=P,this.appResourceLoader=I}getModDir(){return this.modDir}async buildModList(g,P){let I=[];P=[...P??[]];for(let U of g){var L=P.findIndex(g=>g.id===U.id);L=-1!==L?P.splice(L,1)[0]:void 0;I.push(new _.Mod(U,L))}for(var U of P)I.push(new _.Mod(void 0,U));return I}async listRemote(){var g,P=await this.appResourceLoader.loadText(c.remoteListFileName);let L=new I.IniFile(P),_=L.getSection("General");if(!_)throw new Error(c.remoteListFileName+" is missing the [General] section");let G=[];for(g of _.entries.values()){var V=L.getSection(g);V?(V=(new U.ModMeta).fromIniSection(V),G.push(V)):console.warn(`Mod "${g}" has no INI section`)}return G}async listLocal(){let g=[];if(this.modDir)for await(var P of this.modDir.getEntries())P=await this.loadModMeta(P),g.push(P);return g.sort((g,P)=>g.name.localeCompare(P.name)),g}async loadModMeta(g){let P=new U.ModMeta;P.id=g,P.name=g;try{let L=await this.modDir.getDirectory(g,!0),_=await L.containsEntry(c.modMetaFileName)?await L.getRawFile(c.modMetaFileName):void 0;if(_){try{P.fromIniFile(new I.IniFile(await _.text()))}catch(I){console.warn(`Couldn't parse meta file in mod folder "${g}"`),P.name=g}P.id=g}}catch(g){console.warn(g)}return P}async deleteModFiles(g){await(this.modDir?.containsEntry(g))&&await this.modDir.deleteDirectory(g,!0)}loadMod(g){let P=new URL(this.location.href);g?P.searchParams.set(L.RouteHelper.modQueryStringName,g):P.searchParams.delete(L.RouteHelper.modQueryStringName),this.location.href=P.href}}),G.remoteListFileName="mods.ini",G.modMetaFileName="modcd.ini",G.modIdRegex=/^[a-z0-9-_]+$/i}}}),System.register("gui/screen/mainMenu/modSel/ModMeta",["gui/screen/mainMenu/modSel/ModManager"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("ModMeta",class i{constructor(){this.supported=!1,this.manualDownload=!1}fromIniFile(g){var P=g.getSection("General");if(!P)throw new Error("Mod meta missing [General] section");return this.fromIniSection(P),this}fromIniSection(g){let P=g.getString("ID");var L=g.getString("Name");if(!P)throw new Error("Mod meta missing ID");if(!P.match(I.ModManager.modIdRegex))throw new Error(`Mod meta has invalid ID "${P}". ID must contain only alphanumeric characters, dash (-) or underscore (_)`);if(!L)throw new Error("Mod meta missing Name");this.id=P,this.name=L,this.supported=!0,this.description=g.getString("Description")||void 0,(L=g.get("Author"))&&(this.authors=Array.isArray(L)?L:[L]);let _=g.getString("Website");return _&&(_.match(/^https?:\/\//)?this.website=_:console.warn(`Invalid mod meta website "${_}"`)),this.version=g.getString("Version")||void 0,this.download=g.getString("Download")||void 0,this.downloadSize=g.getNumber("DownloadSize")||void 0,this.manualDownload=g.getBool("ManualDownload"),this}clone(){let g=new i;return g.id=this.id,g.name=this.name,g.supported=this.supported,g.description=this.description,g.authors=this.authors?.slice(),g.website=this.website,g.version=this.version,g.download=this.download,g.downloadSize=this.downloadSize,g.manualDownload=this.manualDownload,g}})}}}),System.register("gui/screen/mainMenu/modSel/ModSel",["react","gui/component/List","gui/screen/mainMenu/modSel/ModDetailsPane"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("ModSel",({strings:g,mods:P,activeMod:U,selectedMod:G,onSelectMod:V})=>{const W=I.useRef(null);return I.useEffect(()=>{W.current?.scrollIntoView()},[]),I.default.createElement("div",{className:"mod-sel-form"},I.default.createElement(L.List,{title:g.get("GUI:SelectMod"),className:"mod-list"},P?P.map(P=>{var _=P.id===G?.id;return I.default.createElement(L.ListItem,{key:P.id,selected:_,innerRef:_?W:null,onClick:()=>V(P),onDoubleClick:()=>V(P,!0),style:{display:"flex"}},I.default.createElement("div",{className:"mod-name"},(P===U?" ":"")+P.name+(P.supported?"":` (${g.get("GUI:ModUnsupported").toUpperCase()})`)))}):I.default.createElement(L.ListItem,{style:{textAlign:"center"}},g.get("GUI:LoadingEx"))),G&&I.default.createElement(_.ModDetailsPane,{modLoaded:U===G,modStatus:G.status,modDetails:G.meta,strings:g}))})}}}),System.register("gui/screen/mainMenu/modSel/ModSelScreen",["react","gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/ScreenType","gui/screen/mainMenu/ScreenType","util/disposable/CompositeDisposable","data/vfs/StorageQuotaError","gui/screen/mainMenu/MainMenuScreen","data/vfs/IOError","data/vfs/FileNotFoundError","gui/screen/mainMenu/modSel/ModSel","engine/Engine","engine/gameRes/FileSystemUtil","gui/screen/mainMenu/modSel/ModImporter","engine/gameRes/importError/InvalidArchiveError","engine/gameRes/importError/ArchiveExtractionError","gui/screen/mainMenu/modSel/BadModArchiveError","gui/screen/mainMenu/modSel/DuplicateModError","gui/screen/mainMenu/modSel/Mod","gui/screen/mainMenu/modSel/ModStatus","@puzzl/core/lib/async/cancellation","gui/screen/mainMenu/modSel/ModDownloadPrompt"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g}],execute:function(){oe=class extends z.MainMenuScreen{constructor(g,P,I,L,_,U,G,W,z,K,q){super(),this.rootController=g,this.strings=P,this.jsxRenderer=I,this.errorHandler=L,this.messageBoxApi=_,this.modManager=U,this.activeModId=G,this.modSdkUrl=W,this.modResourceLoader=z,this.fsAccessLib=K,this.sentry=q,this.title=this.strings.get("GUI:Mods"),this.disposables=new V.CompositeDisposable,this.handleSelectMod=async(g,P)=>{var I=this.selectedMod?.id!==g.id;this.selectedMod=g,I&&this.updateSidebarButtons(),this.form?.applyOptions(P=>{P.selectedMod=g}),P&&g!==this.activeMod&&g.status===se.ModStatus.Installed&&await this.loadOrUnloadMod(g)}}async onEnter(){this.availableMods=[],this.controller.toggleMainVideo(!1),this.initForm();var g=await this.loadAvailableMods();g&&(this.availableMods=g,this.activeMod=this.availableMods.find(g=>g.id===this.activeModId),this.selectedMod=this.activeMod,this.form.applyOptions(g=>{g.mods=this.availableMods,g.activeMod=this.activeMod,g.selectedMod=this.selectedMod}),this.initSidebar())}async loadAvailableMods(){try{var[g,P]=await Promise.all([this.modManager.listLocal(),this.modManager.listRemote().catch(g=>{console.warn("Failed to fetch remote mods",[g])})]);return await this.modManager.buildModList(g,P)}catch(g){return g instanceof K.IOError||g instanceof q.FileNotFoundError||g instanceof W.StorageQuotaError||this.sentry?.captureException(new Error(`Failed to load mod list (${g.name??g.message})`,{cause:g})),void this.handleError(g,this.strings.get("GUI:ModListError"))}}initForm(){this.controller.setMainComponent(this.jsxRenderer.render(L.jsx(_.HtmlView,{innerRef:g=>this.form=g,component:$.ModSel,props:{strings:this.strings,mods:void 0,activeMod:void 0,selectedMod:void 0,onSelectMod:this.handleSelectMod}}))[0])}initSidebar(){this.updateSidebarButtons(),this.controller.showSidebarButtons()}updateSidebarButtons(){this.controller?.setSidebarButtons([{label:this.selectedMod&&this.selectedMod===this.activeMod?this.strings.get("GUI:UnloadMod"):this.selectedMod?.isInstalled()?this.strings.get("GUI:LoadMod"):this.strings.get("GUI:ModActionInstall"),disabled:!this.selectedMod,onClick:async()=>{var g=this.selectedMod;if(g.status===se.ModStatus.Installed||g===this.activeMod)await this.loadOrUnloadMod(g);else{var P=(g.meta.downloadSize||0)/1024/1024;if(g.meta.manualDownload){var L=g.status===se.ModStatus.UpdateAvailable,_=I.createElement(ne.ModDownloadPrompt,{url:g.meta.download,sizeMb:P,isUpdate:L,strings:this.strings,onClick:()=>this.messageBoxApi.destroy()});L?await this.messageBoxApi.confirm(_,this.strings.get("GUI:Close"),this.strings.get("GUI:ModActionLoadAnyway"))||await this.loadOrUnloadMod(g):this.messageBoxApi.show(_,this.strings.get("GUI:Close"),()=>{})}else{let I,_=!1;if(g.status===se.ModStatus.UpdateAvailable){if(!await this.messageBoxApi.confirm(this.strings.get("GUI:ModUpdateAvail")+"\n\n"+this.strings.get("GUI:UpdateModPrompt",g.latestVersion,P),this.strings.get("GUI:ModActionUpdate"),this.strings.get("GUI:ModActionLoadAnyway")))return void await this.loadOrUnloadMod(g);_=!0}else if(10<P&&!await this.messageBoxApi.confirm(this.strings.get("GUI:InstallModDownloadPrompt",P),this.strings.get("GUI:Continue"),this.strings.get("GUI:Cancel")))return;try{I=await this.downloadMod(g)}catch(L){return L instanceof ae.OperationCanceledError?void 0:void this.errorHandler.handle(L,this.strings.get("GUI:DownloadFailed"),()=>{})}this.messageBoxApi.destroy();try{await this.importModFromFile(I,g.status===se.ModStatus.UpdateAvailable)}catch(L){return void this.handleModImportError(L)}_&&await this.loadOrUnloadMod(g)}}}},{label:this.strings.get("GUI:ImportMod"),tooltip:this.strings.get("STT:ImportMod"),onClick:async()=>{try{let g;try{let P=await Y.FileSystemUtil.showArchivePicker(this.fsAccessLib);g=await P.getFile()}catch(g){if("AbortError"===g.name)return;if(g instanceof DOMException)throw new K.IOError(`File could not be read (${g.name})`,{cause:g});throw g}await this.importModFromFile(g,!1)}catch(g){return void this.handleModImportError(g)}}},{label:this.strings.get("GUI:UninstallMod"),tooltip:this.strings.get("STT:UninstallMod"),disabled:!(this.selectedMod?.isInstalled()&&this.activeMod!==this.selectedMod),onClick:async()=>{var g=this.selectedMod;if(await this.messageBoxApi.confirm(this.strings.get("GUI:ConfirmUninstallMod",g.name),this.strings.get("GUI:Ok"),this.strings.get("GUI:Cancel"))){this.messageBoxApi.show(this.strings.get("GUI:WorkingPleaseWait"));try{await this.modManager.deleteModFiles(g.id)}catch(g){var P=g instanceof W.StorageQuotaError?this.strings.get("ts:storage_quota_exceeded"):this.strings.get("GUI:UninstallModError");return void this.errorHandler.handle(g,P,()=>{})}finally{this.messageBoxApi.destroy()}(P=await this.loadAvailableMods())&&(this.availableMods=P,this.selectedMod=void 0,this.form?.applyOptions(g=>{g.mods=this.availableMods,g.selectedMod=void 0}),this.updateSidebarButtons())}}},{label:this.strings.get("GUI:BrowseMod"),tooltip:this.strings.get("STT:BrowseMod"),onClick:()=>{this.controller?.pushScreen(G.ScreenType.OptionsStorage,{startIn:Q.Engine.rfsSettings.modDir+(this.selectedMod?.isInstalled()?"/"+this.selectedMod.id:"")})}},...this.modSdkUrl?[{label:this.strings.get("GUI:ModSDK"),tooltip:this.strings.get("STT:ModSDK"),onClick:()=>{window.open(this.modSdkUrl,"_blank")}}]:[],{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.popScreen()}}])}async loadOrUnloadMod(g){await(this.controller?.hideSidebarButtons()),this.modManager.loadMod(g!==this.activeMod?g.id:void 0)}async downloadMod(g){var P=g.meta.download;if(!P)throw new Error("Mod meta is missing download");let I=new ae.CancellationTokenSource;this.messageBoxApi.show(this.strings.get("TS:Downloading"),this.strings.get("GUI:Cancel"),()=>I.cancel());var L={id:"archive",src:P,type:"binary",sizeHint:g.meta.downloadSize};let _=await this.modResourceLoader.loadResources([L],I.token,g=>{this.messageBoxApi.updateText(this.strings.get("TS:DownloadingPg",g))});return P=_.pop("archive"),new File([P],this.modResourceLoader.getResourceFileName(L))}async importModFromFile(g,P){this.messageBoxApi.show(this.strings.get("ts:import_preparing_for_import"));var i=g=>{this.messageBoxApi.updateText(g)};let I;try{I=await new Z.ModImporter(this.strings,this.messageBoxApi,navigator.storage).import(g,this.modManager.getModDir(),P,i)}finally{this.messageBoxApi.destroy()}if(I){let g=new re.Mod(I,void 0);g&&(-1!==(i=this.availableMods.findIndex(P=>P.id===g.id))?this.availableMods.splice(i,1,g):this.availableMods.unshift(g),this.selectedMod=g,this.form?.applyOptions(P=>{P.mods=this.availableMods,P.selectedMod=g}),this.updateSidebarButtons())}}handleModImportError(g){let P=this.strings,I=P.get("GUI:ImportModError");g instanceof ee.BadModArchiveError?I+="\n\n"+P.get("GUI:ImportModBadArchive"):g instanceof te.DuplicateModError?I+="\n\n"+P.get("GUI:ImportDuplicateModError"):g instanceof X.InvalidArchiveError?I+="\n\n"+P.get("ts:import_invalid_archive"):g instanceof J.ArchiveExtractionError?g.cause?.message?.match(/out of memory|allocation/i)?I+="\n\n"+P.get("ts:import_out_of_memory"):I+="\n\n"+P.get("ts:import_archive_extract_failed"):g.message?.match(/out of memory|allocation/i)?I+="\n\n"+P.get("ts:import_out_of_memory"):"QuotaExceededError"===g.name||g instanceof W.StorageQuotaError?I+="\n\n"+P.get("ts:storage_quota_exceeded"):g instanceof K.IOError||g instanceof q.FileNotFoundError||this.sentry?.captureException(new Error("Mod import failed "+(g.message??g.name),{cause:g})),this.errorHandler.handle(g,I,()=>{})}async onStack(){await this.onLeave()}onUnstack(){this.onEnter()}async onLeave(){this.availableMods.length=0,this.form=void 0,this.messageBoxApi.destroy(),this.disposables.dispose(),this.controller.setMainComponent(),await this.controller.hideSidebarButtons()}handleError(g,P){this.errorHandler.handle(g,P,()=>{this.rootController.goToScreen(U.ScreenType.MainMenuRoot)})}},g("ModSelScreen",oe)}}}),System.register("gui/screen/mainMenu/modSel/ModStatus",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("ModStatus",I={}))[P.NotInstalled=0]="NotInstalled",P[P.Installed=1]="Installed",P[P.UpdateAvailable=2]="UpdateAvailable"}}}),System.register("gui/screen/mainMenu/newAccount/NewAccountBox",["react","network/WolConfig"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=({regions:g,initialRegion:P,strings:_,onRegionChange:U,onSubmit:G},V)=>{let[W,z]=I.useState(P.id),K=I.useRef(null),q=I.useRef(null),$=I.useRef(null),Q=I.useRef(null);I.useEffect(()=>{setTimeout(()=>q.current?.focus(),50)},[]);const d=()=>{G({user:q.current.value,pass:$.current.value,passMatch:$.current.value===Q.current.value,regionId:W})};return I.useImperativeHandle(V,()=>({submit(){K.current?.requestSubmit?K.current.requestSubmit():d()}})),I.default.createElement("div",{className:"login-wrapper new-account-box"},I.default.createElement("div",{className:"title"},_.get("GUI:NewAccount")),I.default.createElement("form",{onSubmit:g=>{g.preventDefault(),d()},className:"login-form login-box",ref:K},1<g.length?I.default.createElement("div",{className:"field"},I.default.createElement("label",null,_.get("TS:Region")),I.default.createElement("select",{name:"server",value:W,onChange:g=>{var P=g.target.value;z(P),U(P)}},g.map(g=>I.default.createElement("option",{value:g.id,key:g.id,disabled:!g.available},g.label)))):I.default.createElement("input",{type:"hidden",name:"server",value:W}),I.default.createElement("div",{className:"field"},I.default.createElement("label",null,_.get("GUI:Nickname")),I.default.createElement("input",{name:"user",type:"text",required:!0,minLength:L.MIN_USERNAME_LEN,maxLength:L.MAX_USERNAME_LEN,ref:q,autoComplete:"off"})),I.default.createElement("div",{className:"field"},I.default.createElement("label",null,_.get("GUI:Password")),I.default.createElement("input",{name:"pass",type:"password",required:!0,minLength:L.MIN_PASS_LEN,maxLength:L.MAX_PASS_LEN,ref:$,autoComplete:"off"})),I.default.createElement("div",{className:"field"},I.default.createElement("label",null,_.get("GUI:Re-enterPassword")),I.default.createElement("input",{name:"confirmPass",type:"password",required:!0,ref:Q,autoComplete:"off"})),I.default.createElement("button",{type:"submit",style:{visibility:"hidden"}})))},g("NewAccountBox",I.forwardRef(_))}}}),System.register("gui/screen/mainMenu/newAccount/NewAccountScreen",["gui/jsx/jsx","gui/screen/mainMenu/newAccount/NewAccountBox","gui/screen/mainMenu/ScreenType","gui/jsx/HtmlView","@puzzl/core/lib/async/Task","util/time","LocalPrefs","gui/screen/mainMenu/MainMenuScreen","network/HttpRequest"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g}],execute:function(){q=class extends z.MainMenuScreen{constructor(g,P,I,L,_,U,G){super(),this.appLocale=g,this.strings=P,this.jsxRenderer=I,this.messageBoxApi=L,this.serverRegions=_,this.errorHandler=U,this.localPrefs=G,this.title=this.strings.get("GUI:NewAccount"),this.handleSubmit=async(g,P)=>{if(!this.isBusy&&this.controller){this.isBusy=!0,await this.controller.hideSidebarButtons();let{user:I,pass:L,passMatch:_,regionId:U}=g;_?I.match(/^[A-Za-z0-9-_]+$/)?await this.createAccount(I,L,U,P):this.handleValidationError(this.strings.get("TS:BadNickname")):this.handleValidationError(this.strings.get("TXT_PASSWORD_VERIFY"))}}}async onEnter(g){var P;this.controller.toggleMainVideo(!1),this.isBusy=!1,(P=(P=g.regionId??this.localPrefs.getItem(W.StorageKey.PreferredServerRegion))&&this.serverRegions.isAvailable(P)?this.serverRegions.get(P):this.serverRegions.getFirstAvailable())?(this.controller.setSidebarButtons([{label:this.strings.get("GUI:Ok"),onClick:()=>this.submitForm()},{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.goToScreen(_.ScreenType.Login,{afterLogin:g.afterLogin})}}]),this.controller.showSidebarButtons(),[P]=this.jsxRenderer.render(I.jsx(U.HtmlView,{width:"100%",height:"100%",component:L.NewAccountBox,props:{ref:g=>this.newAccountBox=g,strings:this.strings,regions:this.serverRegions.getAll(),initialRegion:P,onRegionChange:g=>{this.localPrefs.setItem(W.StorageKey.PreferredServerRegion,g)},onSubmit:P=>this.handleSubmit(P,g.afterLogin)}})),this.controller.setMainComponent(P)):this.handleWolError("No servers available",this.strings.get("gui:noserversavailable"),{fatal:!0})}submitForm(){!this.isBusy&&this.controller&&this.newAccountBox?.submit()}async createAccount(g,P,I,L){var U=this.serverRegions.get(I);this.serverRegions.setSelectedRegion(I);let W=new G.Task(async g=>{await V.sleep(1e3),g.isCancelled()||this.messageBoxApi.show(this.strings.get("TXT_CONNECTING"))});W.start();try{var z={locale:this.appLocale,user:g,pass:P},q=await(new K.HttpRequest).fetchJson(U.apiRegUrl,void 0,{method:"POST",body:JSON.stringify(z)});if(W.cancel(),this.messageBoxApi.destroy(),q.error)return void this.handleValidationError(q.error);this.controller?.goToScreen(_.ScreenType.Login,{useCredentials:{regionId:U.id,user:g,pass:P},afterLogin:L})}catch(g){W.cancel(),this.messageBoxApi.destroy(),this.handleWolError(g,this.strings.get("TS:ConnectFailed"),{fatal:!1})}}handleValidationError(g){this.messageBoxApi.show(g,this.strings.get("GUI:Ok"),()=>{this.isBusy=!1,this.controller?.showSidebarButtons()})}handleWolError(g,P,{fatal:I}){this.errorHandler.handle(g,P,()=>{this.isBusy=!1,this.controller&&(I?this.controller.goToScreen(_.ScreenType.Home):this.controller.showSidebarButtons())})}async onLeave(){this.newAccountBox=void 0,!this.isBusy&&this.controller&&await this.controller.hideSidebarButtons(),this.isBusy=!1}},g("NewAccountScreen",q)}}}),System.register("gui/screen/mainMenu/patchNotes/PatchNotesScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/mainMenu/component/Iframe","gui/screen/mainMenu/MainMenuScreen"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=class extends U.MainMenuScreen{constructor(g,P,I){super(),this.strings=g,this.jsxRenderer=P,this.patchNotesUrl=I,this.title=this.strings.get("TS:PatchNotes")}onEnter(){this.controller.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons(),this.controller.toggleMainVideo(!1);var[g]=this.jsxRenderer.render(I.jsx(L.HtmlView,{width:"100%",height:"100%",component:_.Iframe,props:{src:this.patchNotesUrl,className:"patch-notes"}}));this.controller.setMainComponent(g)}async onLeave(){await this.controller.hideSidebarButtons()}async onStack(){await this.onLeave()}onUnstack(){this.onEnter()}},g("PatchNotesScreen",G)}}}),System.register("gui/screen/mainMenu/quickGame/ChatUi",["@puzzl/core/lib/async/cancellation","network/ladder/wladderConfig","util/disposable/CompositeDisposable","network/chat/ChatMessage","engine/sound/SoundKey","engine/sound/ChannelType","@puzzl/core/lib/async/Task","gui/chat/ChatHistory","util/time","gui/component/ChatInput"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g}],execute:function(){g("ChatUi",$=class{constructor(g,P,I,L,W,K,q,$,Q=!1){this.messages=g,this.updateView=P,this.wolConfig=I,this.wolCon=L,this.wolService=W,this.wladderService=K,this.strings=q,this.sound=$,this.partyEnabled=!!Q,this.disposables=new _.CompositeDisposable,this.users=[],this.chatHistory=new z.ChatHistory,this.playerProfiles=new Map,this.onChannelJoinLeave=g=>{let P=g.channel,I=P.match(/#Lob (\d+) (\d)/i);if(I){var[,L,_]=I.map(Number);if(this.wolConfig.getAllQuickMatchChannelIds().includes(L))return;P=this.strings.get("TXT_LOB_"+(_+1))}g.user.name===this.wolCon.getCurrentUser()?this.addSystemMessage(this.strings.get("join"===g.type?"TXT_JOINED_S":"TXT_YOULEFT",P)):g.channel===this.channelName&&("join"===g.type?(this.users.push(g.user),this.users.sort((g,P)=>Number(P.operator)-Number(g.operator))):-1!==(_=this.users.findIndex(P=>P.name===g.user.name))&&this.users.splice(_,1),this.updateView(),this.refreshPlayerRanks())},this.onChannelUsers=g=>{g.channelName===this.channelName&&(this.users=g.users,this.updateView({users:this.users}),this.refreshPlayerRanks())},this.onChannelMessage=g=>{var P;[g.from,g.to.name].includes(this.wolConfig.getQuickMatchBotName())||(g.to.type!==U.ChatRecipientType.Page&&g.to.type!==U.ChatRecipientType.Whisper||this.sound.play(G.SoundKey.IncomingMessage,V.ChannelType.Ui),P={...g,operator:this.users.find(P=>P.name===g.from)?.operator},this.messages.push(P),this.updateView(),g.to.type===U.ChatRecipientType.Whisper&&g.to.name!==this.wolCon.getServerName()&&g.from!==this.wolCon.getCurrentUser()&&(this.chatHistory.lastWhisperFrom.value=g.from))}}async loadChannel(g){this.channelName=void 0,this.users=[],this.wolCon.onJoinChannel.subscribe(this.onChannelJoinLeave),this.wolCon.onLeaveChannel.subscribe(this.onChannelJoinLeave),this.wolCon.onChannelUsers.subscribe(this.onChannelUsers),this.wolCon.onChatMessage.subscribe(this.onChannelMessage);let P=this.wolService.getConfig();var I=`#Lob ${P.getClientChannelType()} 0`;await this.wolCon.joinChannel(I,P.getGlobalChannelPass()),g.isCancelled()?this.wolCon.isOpen()&&this.wolCon.leaveChannel(I):(this.channelName=I,this.playerProfiles.clear(),this.updateView({channels:[I],users:this.users}))}getViewProps(){return{strings:this.strings,messages:this.messages,chatHistory:this.chatHistory,channels:this.channelName?[this.channelName]:[],localUsername:this.wolCon.getCurrentUser(),users:this.users,playerProfiles:this.playerProfiles,onSendMessage:g=>{g.value.length?g.recipient.type!==U.ChatRecipientType.Channel||g.recipient.name!==q.IMPLICIT_CHANNEL_NAME?this.wolCon.isOpen()&&(this.wolCon.sendChatMessage(g.value,g.recipient),g.recipient.type===U.ChatRecipientType.Whisper&&(this.chatHistory.lastWhisperTo.value=g.recipient.name)):this.addSystemMessage(this.strings.get("TXT_NOT_IN_CHAN")):this.addSystemMessage(this.strings.get("TXT_ENTER_MESSAGE"))},onInviteToTeam:this.partyEnabled?g=>{this.wolCon.partyInvite(g.name)}:void 0}}addSystemMessage(g){this.messages.push({text:g}),this.updateView()}refreshPlayerRanks(){if(this.wladderService.getUrl()){this.ranksUpdateTask?.cancel();let g=this.ranksUpdateTask=new W.Task(async g=>{let P=this.users.map(g=>g.name).filter(g=>!this.playerProfiles.has(g));if(P.length){for(;0<P.length;){var I,_=P.splice(0,L.MAX_LIST_SEARCH_COUNT);_=await this.wladderService.listSearch(_,g);if(g.isCancelled())return;for(I of _)this.playerProfiles.set(I.name,I)}this.updateView()}});g.start().catch(g=>{g instanceof I.OperationCanceledError||console.error(g)})}}dispose(){this.disposables.dispose(),this.ranksUpdateTask&&(this.ranksUpdateTask.cancel(),this.ranksUpdateTask=void 0),this.wolCon.isOpen()&&this.channelName&&this.wolCon.leaveChannel(this.channelName),this.wolCon.onJoinChannel.unsubscribe(this.onChannelJoinLeave),this.wolCon.onLeaveChannel.unsubscribe(this.onChannelJoinLeave),this.wolCon.onChannelUsers.unsubscribe(this.onChannelUsers),this.wolCon.onChatMessage.unsubscribe(this.onChannelMessage),this.channelName=void 0,this.messages=[],this.users=[],this.playerProfiles.clear()}}),__decorate([K.Throttle(5e3)],$.prototype,"refreshPlayerRanks",null)}}}),System.register("gui/screen/mainMenu/quickGame/component/QuickGameChat",["react","gui/component/Chat","gui/component/List","gui/component/ChannelUser","network/chat/ChatMessage"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){g("QuickGameChat",({strings:g,messages:P,channels:V,localUsername:W,users:z,chatHistory:K,playerProfiles:q,onSendMessage:$,onInviteToTeam:Q})=>{const Y=[{label:g.get("GUI:PlayerMenuMessage"),onClick:g=>{K.lastComposeTarget.value={type:G.ChatRecipientType.Whisper,name:g.name}}}];return Q&&Y.push({label:g.get("GUI:PlayerMenuInvite"),onClick:Q}),I.default.createElement(I.default.Fragment,null,I.default.createElement(L.Chat,{strings:g,messages:P,channels:V??[],chatHistory:K,localUsername:W,onSendMessage:$,tooltips:{input:g.get("STT:LobbyEditInput"),output:g.get("STT:LobbyEditOutput"),button:g.get("STT:EmoteButton")}}),I.default.createElement(_.List,{className:"players-list",tooltip:g.get("STT:LobbyListUsers")},z.map(P=>{var L=q.get(P.name);return I.default.createElement(U.ChannelUser,{key:P.name,user:P,playerProfile:L,strings:g,localUsername:W,menuItems:Y})})))})}}}),System.register("gui/screen/mainMenu/quickGame/component/QuickGameForm",["classnames","gui/component/Image","gui/component/ButtonSelect","gui/component/ColorSelect","gui/component/CountrySelect","gui/component/Option","react","gui/screen/mainMenu/lobby/component/RankIndicator","network/ladder/wladderConfig","gui/screen/mainMenu/quickGame/component/QuickGameChat"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g}],execute:function(){g("QuickGameForm",g=>{let{strings:P,disabled:$,playerName:Q,playerProfile:Y,unrankedEnabled:Z,ranked:X,type:J,availableTypes:ee,enabledTypes:te,chatProps:re,onRankedChange:se,onTypeChange:ae,partyEnabled:ne=!1,partyState:oe,partySize:le,noInvites:ce,onNoInvitesChange:he}=g;return W.createElement("div",{className:"qm-form"},W.createElement("div",{className:"qm-top"},W.createElement("div",{className:"opts"},W.createElement("div",{className:"item qm-game-type-item"},W.createElement("label",null,W.createElement("span",{className:"label"},P.get("GUI:QuickMatchGameMode")),W.createElement("div",{className:"qm-game-type"},W.createElement(_.ButtonSelect,{initialValue:J,onSelect:g=>ae(g),disabled:$},ee.map(g=>W.createElement(V.Option,{value:g,label:g,key:g,disabled:!te.includes(g)||2===le&&g===K.LadderQueueType.Solo1v1}))),W.createElement(_.ButtonSelect,{initialValue:String(Number(X)),onSelect:g=>{se(Boolean(Number(g)))},disabled:$},W.createElement(V.Option,{value:"1",label:P.get("GUI:Ranked")}),W.createElement(V.Option,{value:"0",disabled:!Z,label:P.get("GUI:Unranked")}))))),W.createElement("div",{className:"item"},W.createElement("label",null,W.createElement("span",{className:"label"},P.get("GUI:PreferredCountry")),W.createElement(G.CountrySelect,{countryUiNames:g.countryUiNames,countryUiTooltips:g.countryUiTooltips,country:g.country,availableCountries:g.availableCountries,disabled:$,strings:g.strings,onSelect:P=>g.onCountrySelect(P)}))),W.createElement("div",{className:"item"},W.createElement("label",null,W.createElement("span",{className:"label"},P.get("GUI:PreferredColor")),W.createElement(U.ColorSelect,{color:g.color,availableColors:g.availableColors,disabled:$,strings:g.strings,onSelect:P=>g.onColorSelect(P)}))),ne&&oe&&0<oe.members.length?W.createElement("div",{className:"item"},W.createElement("label",null,W.createElement("span",{className:"label"},P.get("GUI:CurrentParty")),W.createElement("div",{className:"party-info"},W.createElement("div",{className:"party-members"},W.createElement("span",null,oe.members.map(g=>g.name).join(", ")))))):ne?W.createElement("div",{className:"item party-noinvites"},W.createElement("label",null,W.createElement("span",{className:"label"},P.get("GUI:PartyNoInvites")),W.createElement("input",{type:"checkbox",checked:ce,onChange:g=>he?.(g.target.checked),disabled:$}))):null),W.createElement("fieldset",{className:"qm-profile"},W.createElement("legend",null,Y?.name??Q),void 0===Y?.rank?Y?W.createElement("div",{className:"item placement"},P.get("GUI:LadderPlacement",Y.placementMatchesLeft)):W.createElement("div",null):W.createElement(W.Fragment,null,W.createElement("div",{className:"player-rank"},W.createElement("div",{className:"rank-name"},W.createElement(z.RankIndicator,{playerProfile:Y,strings:P})," ",P.get(z.RANK_LABELS.get(Y.rankType))),W.createElement("div",{className:"rank-number"},P.get("GUI:Rank")," ",Y.rank)),Y.promotionProgress&&W.createElement("div",{className:I.default("item","promo-progress",{demotion:Y.promotionProgress.demotion})},W.createElement("span",{className:"label"},P.get("GUI:LadderPromoProgress")),W.createElement("span",{className:"value"},W.createElement("div",{className:"next-rank"},P.get(z.RANK_LABELS.get(Y.promotionProgress.rankType)),Y.promotionProgress.demotion?W.createElement("span",{className:"demotion-indicator"},""):W.createElement("span",{className:"promotion-indicator"},"")),W.createElement("progress",{value:Y.promotionProgress.progress,max:1}))),W.createElement("hr",null),W.createElement("div",{className:"item"},W.createElement("span",{className:"label"},P.get("GUI:LadderWins")),W.createElement("span",{className:"value"},Y.wins??P.get("GUI:UnknownStats"))),void 0!==Y.points&&W.createElement("div",{className:"item"},W.createElement("span",{className:"label"},P.get("GUI:LadderPoints")),W.createElement("span",{className:"value"},Y.points)),void 0!==Y.bonusPool&&W.createElement("div",{className:"item"},W.createElement("span",{className:"label"},P.get("GUI:ProfileBonusPool")),W.createElement("span",{className:"value"},Y.bonusPool)),void 0!==Y.mmr&&W.createElement("div",{className:"item"},W.createElement("span",{className:"label"},P.get("GUI:ProfileMMR")),W.createElement("span",{className:"value"},Y.mmr,void 0!==Y.provisionalMmr&&W.createElement("span",{className:"info",title:P.get("gui:profileprovmmr")+" "+Y.provisionalMmr},W.createElement(L.Image,{src:"info.png"}))))))),W.createElement("div",{className:"qm-bottom"},W.createElement(q.QuickGameChat,{...re})))})}}}),System.register("gui/screen/mainMenu/quickGame/PartyState",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("PartyStatus",I={})).Idle="idle",P.Queued="queued"}}}),System.register("gui/screen/mainMenu/quickGame/QuickGameScreen",["@puzzl/core/lib/async/Task","@puzzl/core/lib/async/cancellation","gui/jsx/jsx","gui/jsx/HtmlView","engine/sound/Music","gui/screen/mainMenu/MainMenuScreen","gui/screen/mainMenu/ScreenType","util/disposable/CompositeDisposable","game/gameopts/constants","engine/sound/SoundKey","engine/sound/ChannelType","gui/screen/mainMenu/MainMenuRoute","gui/screen/mainMenu/quickGame/PartyState","gui/screen/mainMenu/quickGame/component/QuickGameForm","LocalPrefs","network/ladder/WLadderService","network/ladder/wladderConfig","network/WolError","network/qmCodes","network/partyCodes","gui/screen/mainMenu/quickGame/ChatUi","gui/component/PartyInviteDialog"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g}],execute:function(){var P;(P=oe=oe||{})[P.None=0]="None",P[P.Initializing=1]="Initializing",P[P.WaitingForMatch=2]="WaitingForMatch",P[P.WaitingForStartTimer=3]="WaitingForStartTimer",P[P.WaitingForGameStart=4]="WaitingForGameStart",le=class extends V.MainMenuScreen{constructor(g,P,I,L,_,U,V,K,Z,X,J,te,ae,ne,le,ce,he){super(),this.unrankedEnabled=g,this.engineVersion=P,this.engineModHash=I,this.clientLocale=L,this.rules=_,this.wolService=U,this.wolCon=V,this.wladderService=K,this.serverRegions=Z,this.rootController=X,this.messageBoxApi=J,this.uiScene=te,this.jsxRenderer=ae,this.strings=ne,this.localPrefs=le,this.sound=ce,this.errorHandler=he,this.title=this.strings.get("GUI:WolMatch"),this.musicType=G.MusicType.NormalShuffle,this.partySize=1,this.partyState=this.getInitialPartyState(),this.partyEnabled=!1,this.userHasDeclinedInvitesFrom=new Set,this.availableQueueTypes=Object.values(ee.LadderQueueType),this.playButtonFlashing=!1,this.noInvites=!1,this.disposables=new z.CompositeDisposable,this.handleChatMessage=g=>{if(g.text.startsWith(re.RPL_QUEUE_LIST+" ")&&this.queueState===oe.None){let P=g.text.split(" ").slice(1).join(" ").split(",").filter(g=>Object.values(ee.LadderQueueType).includes(g));this.availableQueueTypes=P,!P.includes(this.queueOpts.type)&&P.length&&(this.queueOpts.type=P[0],this.form&&this.requestPlayerProfileRefresh()),this.form?.applyOptions(g=>{g.enabledTypes=P,g.type=this.queueOpts.type})}if(this.queueState!==oe.None&&g.from===this.wolConfig.getQuickMatchBotName())if([re.RPL_WORKING,re.RPL_BAD_VERS,re.RPL_BAD_HASH,re.RPL_MODE_UNAVAIL].includes(g.text))if(this.queueState===oe.Initializing)if(g.text===re.RPL_WORKING)this.updateQueueState(oe.WaitingForMatch);else{let P,I=!0;g.text===re.RPL_BAD_VERS?P=this.strings.get("TS:OutdatedClient"):g.text===re.RPL_BAD_HASH?P=this.strings.get("TXT_MISMATCH"):g.text===re.RPL_MODE_UNAVAIL?(P=this.strings.get("WOL:MatchModeUnavail"),I=!1):P=this.strings.get("WOL:MatchBadParameters"),I||this.leaveQueue(),this.handleError(g.text,P,{fatal:I})}else console.warn(`Unexpected reply "${g.text}" from match bot (qs: ${oe[this.queueState]})`);else if(g.text.startsWith(re.RPL_MATCHED+" "))this.queueState===oe.WaitingForMatch?(this.sound.play(q.SoundKey.PlayerJoined,$.ChannelType.Ui),P=g.text.split(" ")[1],this.countdownSeconds=Number(P),this.updateQueueState(oe.WaitingForStartTimer)):console.warn(`Unexpected reply "${g.text}" from match bot (qs: ${oe[this.queueState]})`);else if(g.text===re.RPL_REQUEUE)[oe.WaitingForGameStart,oe.WaitingForStartTimer].includes(this.queueState)&&(console.log("A player left. Returned to queue."),this.updateQueueState(oe.WaitingForMatch));else if(g.text===re.RPL_REMOVED_FROM_QUEUE)this.quickMatchChannelName&&(this.wolCon.leaveChannel(this.quickMatchChannelName),this.quickMatchChannelName=void 0),this.updateQueueState(oe.None),this.partyState.partyId&&(this.partyState.status=Y.PartyStatus.Idle,this.partyState.members.forEach(g=>g.ready=!1),this.playButtonFlashing=!1,this.updatePartyUI());else if(g.text.startsWith(re.RPL_STATS+" ")&&this.queueState===oe.WaitingForMatch)if(this.isWaitingForTeammate())this.updateSidebarText(this.strings.get("GUI:WaitingForTeammate"));else{let I=g.text.split(" ").slice(1).join(" ");var[,P]=I.split(","),P="-1"!==P?Number(P):void 0;this.updateSidebarText(this.strings.get("TXT_SEARCHING_FOR",this.queueOpts.type)+"\n\n"+this.strings.get("WOL:MatchAvgWaitTime")+"\n"+(void 0!==P&&P<3600?this.strings.get("WOL:MatchAvgWaitTimeMinutes",P<60?"<1":"~"+Math.ceil(P/60)):this.strings.get("WOL:MatchAvgWaitTimeUnavail")))}},this.handleLeaveChannel=async g=>{g.user.name===this.wolCon.getCurrentUser()&&g.channel===this.quickMatchChannelName&&(this.quickMatchChannelName=void 0,this.queueState!==oe.None&&(this.updateQueueState(oe.None),this.wolCon.close()))},this.handleGameStart=async g=>{if(this.queueState===oe.WaitingForGameStart||this.queueState===oe.WaitingForStartTimer)try{var P=this.wolCon.getCurrentUser();if(void 0===P)throw new Error("User should be logged in");this.updateQueueState(oe.None);var I=new Q.MainMenuRoute(W.ScreenType.Login,{afterLogin:g=>new Q.MainMenuRoute(W.ScreenType.QuickGame,{messages:g})});this.form||await(this.controller?.popScreen()),this.rootController.joinGame(g.gameId,g.timestamp,g.gservUrl,P,!0,!1,I)}catch(g){if(this.leaveQueue(),!this.wolCon.isOpen())return;this.handleError(g,this.strings.get("WOL:MatchTimeout"),{fatal:!1})}},this.onWolClose=()=>{this.updateQueueState(oe.None)},this.onWolConLost=g=>{this.handleError(g,this.strings.get("TXT_YOURE_DISCON"),{fatal:!0})},this.handlePartyUpdate=g=>{if(!this.partyEnabled)return;const P=g.split(" ");if((z=P[0])===se.RPL_PARTY_INVITE){if(console.log("Party invite received from "+P[1]),_=P[1])return this.queueState!==oe.None?(this.wolCon.partyDecline(_),void console.warn(`Ignoring party invite from ${_}: currently in queue`)):void(this.partyState.partyId?console.warn(`Ignoring party invite from ${_}: already in a party`):this.showInviteDialog(_));console.warn("Party invite received but inviter name is missing")}else if(z===se.RPL_PARTY_UPDATE){var I=P[1];const g=P[2]?.split(",")||[];var L=P[3]===Y.PartyStatus.Queued?Y.PartyStatus.Queued:Y.PartyStatus.Idle;const V="1"===P[4],W="1"===P[5];var _,U=g.map((g,P)=>({name:g,ready:0===P?V:W}));void 0!==(_=this.wolCon.getCurrentUser())&&(G=U[_=g.indexOf(_)]?.ready??!1,(G=(U[1-_]?.ready??!1)&&!G&&L!==Y.PartyStatus.Queued)&&!this.playButtonFlashing&&this.chatUi?.addSystemMessage(this.strings.get("GUI:TeammateWantsToStart")),this.playButtonFlashing=G,this.partyState={partyId:I,members:U,status:L},G=2!==this.partySize,this.partySize=g.length,2===this.partySize&&this.queueOpts.type!==ee.LadderQueueType.Team2v2&&(G&&this.savePrePartyQueueType(),this.queueOpts.type=ee.LadderQueueType.Team2v2),this.updatePartyUI(),this.queueState===oe.WaitingForMatch&&this.updateSidebarText(this.isWaitingForTeammate()?this.strings.get("GUI:WaitingForTeammate"):this.strings.get("TXT_SEARCHING_FOR",this.queueOpts.type)))}else if(z===se.RPL_PARTY_LEFT){L=P[1],this.leaveQueue(),this.restorePrePartyQueueType(),this.resetPartyState(),this.updatePartyUI();var G=this.wolCon.getCurrentUser();G&&(L===G?this.chatUi?.addSystemMessage(this.strings.get("GUI:PartyLeft")):L&&(this.chatUi?.addSystemMessage(this.strings.get("GUI:PartyMemberLeft",L)),this.messageBoxApi.show(this.strings.get("GUI:PartyDisbanded"),this.strings.get("GUI:OK"))))}else if(z===se.RPL_PARTY_INVITE_DECLINED){var V=P[1];this.chatUi?.addSystemMessage(this.strings.get("GUI:PartyInviteDeclinedBy",V))}else if(z===se.RPL_PARTY_INVITE_EXPIRED)this.chatUi?.addSystemMessage(this.strings.get("GUI:PartyInviteExpired"));else if(z===se.RPL_PARTY_INVITE_SENT)V=P[1],this.chatUi?.addSystemMessage(this.strings.get("GUI:PartyInviteSent",V));else if(z===se.RPL_PARTY_FORMED){var W=P[1];this.chatUi?.addSystemMessage(this.strings.get("GUI:PartyFormedWith",W)),this.sound.play(q.SoundKey.PartyFormed,$.ChannelType.Ui)}else if(z===se.RPL_PARTY_INVITE_PREVENTION)W=P[1],"1"===P[2]&&this.chatUi?.addSystemMessage(this.strings.get("GUI:PartyInvitePreventionEnabled",W));else if(z===se.RPL_PARTY_INVITE_ERROR){var z=P[1],K=P[2];switch(z){case se.ERR_TARGET_IN_PARTY:this.chatUi?.addSystemMessage(this.strings.get("GUI:PartyInviteAlreadyInParty",K));break;case se.ERR_TARGET_IN_QUEUE:this.chatUi?.addSystemMessage(this.strings.get("GUI:PartyInviteInQueue",K));break;case se.ERR_INVITER_IN_PARTY:case se.ERR_ACCEPTER_IN_PARTY:this.chatUi?.addSystemMessage(this.strings.get("GUI:PartyInviteYouInParty"));break;case se.ERR_INVITE_PREVENTED:this.chatUi?.addSystemMessage(this.strings.get("GUI:PartyInvitePrevented",K));break;case se.ERR_TARGET_NO_INVITES:this.chatUi?.addSystemMessage(this.strings.get("GUI:PartyInviteNoInvites",K));break;case se.ERR_INVITE_ALREADY_PENDING:this.chatUi?.addSystemMessage(this.strings.get("GUI:PartyInviteAlreadyPending",K));break;case se.ERR_NO_INVITE:this.chatUi?.addSystemMessage(this.strings.get("GUI:PartyInviteNoInvite"));break;case se.ERR_TARGET_NOT_IN_QUICK_MATCH:this.chatUi?.addSystemMessage(this.strings.get("GUI:PartyInviteNotInQuickMatch",K));break;case se.ERR_TARGET_SELF:this.chatUi?.addSystemMessage(this.strings.get("GUI:PartyInviteTargetSelf"));break;case se.ERR_INVITER_FRESH_ACCOUNT:this.chatUi?.addSystemMessage(this.strings.get("GUI:PartyInviteInviterFreshAccount"));break;default:this.chatUi?.addSystemMessage(this.strings.get("GUI:PartyInviteFailed",K))}}}}async onEnter(g){this.partyEnabled=this.resolvePartyEnabled(),this.wolCon.setPartyEnabled?.(this.partyEnabled),this.updateQueueState(oe.None),this.resetPartyState();var P=this.localPrefs.getItem(X.StorageKey.LastPlayerCountry),I=this.localPrefs.getItem(X.StorageKey.LastPlayerColor),_=this.localPrefs.getItem(X.StorageKey.LastQueueRanked),U=this.localPrefs.getItem(X.StorageKey.LastQueueType),G=this.localPrefs.getItem(X.StorageKey.PartyNoInvites);if(this.noInvites=this.partyEnabled&&"1"===G,P=void 0!==P&&Number(P)<this.getAvailablePlayerCountries().length?Number(P):K.RANDOM_COUNTRY_ID,I=void 0!==I&&Number(I)<this.getAvailablePlayerColors().length?Number(I):K.RANDOM_COLOR_ID,_=void 0===_||!this.unrankedEnabled||Boolean(Number(_)),U=void 0!==U&&Object.values(ee.LadderQueueType).includes(U)?U:ee.LadderQueueType.Solo1v1,this.queueOpts={type:U,ranked:_,countryId:P,colorId:I},this.playerProfile=void 0,this.controller.toggleMainVideo(!1),this.wolService.isConnected()&&this.wolCon.getCurrentUser()){this.wolConfig=this.wolService.getConfig(),this.wolCon.onClose.subscribe(this.onWolClose),this.disposables.add(()=>this.wolCon.onClose.unsubscribe(this.onWolClose)),this.wolService.onWolConnectionLost.subscribe(this.onWolConLost),this.disposables.add(()=>this.wolService.onWolConnectionLost.unsubscribe(this.onWolConLost)),this.wolCon.onChatMessage.subscribe(this.handleChatMessage),this.disposables.add(()=>this.wolCon.onChatMessage.unsubscribe(this.handleChatMessage)),this.wolCon.onLeaveChannel.subscribe(this.handleLeaveChannel),this.disposables.add(()=>this.wolCon.onLeaveChannel.unsubscribe(this.handleLeaveChannel)),this.wolCon.onGameStart.subscribe(this.handleGameStart),this.disposables.add(()=>this.wolCon.onGameStart.unsubscribe(this.handleGameStart)),this.disposables.add(()=>this.resetPartyState()),this.partyEnabled&&(this.wolCon.onPartyUpdate.subscribe(this.handlePartyUpdate),this.disposables.add(()=>this.wolCon.onPartyUpdate.unsubscribe(this.handlePartyUpdate)),this.wolCon.partyStatus(),this.wolCon.partyNoInvites(this.noInvites));let P=g.messages;this.chatUi=new ae.ChatUi(P,g=>{this.form?.applyOptions(P=>{var I=P.chatProps;P.chatProps={...I,...g}})},this.wolConfig,this.wolCon,this.wolService,this.wladderService,this.strings,this.sound,this.partyEnabled),this.disposables.add(this.chatUi,()=>this.chatUi=void 0),this.refreshSidebarButtons(),this.initView(),this.updatePartyUI(),this.requestPlayerProfileRefresh(),this.wolCon.privmsg([this.wolConfig.getQuickMatchBotName()],re.REQ_LIST_QUEUES),this.updateStatsIntervalId=setInterval(()=>{this.wolCon.privmsg([this.wolConfig.getQuickMatchBotName()],re.REQ_LIST_QUEUES)},3e4);let U=new L.CancellationTokenSource;this.disposables.add(()=>U.cancel()),I=U.token;try{await this.chatUi.loadChannel(I)}catch(_){let g=this.strings.get("WOL:MatchBadParameters");if(_ instanceof te.WolError){(I=(new Map).set(te.WolError.Code.NoSuchChannel,"WOL:ChannelJoinFailure").set(te.WolError.Code.BadChannelPass,"TXT_BADPASS").set(te.WolError.Code.ChannelFull,"TXT_CHANNEL_FULL").set(te.WolError.Code.BannedFromChannel,"TXT_JOINBAN").get(_.code))&&(g=this.strings.get(I))}return void P.push({text:g})}}else this.controller.goToScreen(W.ScreenType.Login,{afterLogin:g=>new Q.MainMenuRoute(W.ScreenType.QuickGame,{messages:g})})}resetPartyState(){this.partyState=this.getInitialPartyState(),this.partySize=1,this.playButtonFlashing=!1,this.prePartyQueueType=void 0}resolvePartyEnabled(){try{return!!this.serverRegions?.getSelectedRegion?.()?.partyEnabled}catch(g){return!1}}isWaitingForTeammate(){return this.partyEnabled&&!!this.partyState.partyId&&2===this.partySize&&!this.partyState.members.every(g=>g.ready)}savePrePartyQueueType(){this.queueOpts.type!==ee.LadderQueueType.Team2v2&&(this.prePartyQueueType=this.queueOpts.type)}restorePrePartyQueueType(){void 0!==this.prePartyQueueType&&(this.queueOpts.type=this.prePartyQueueType,this.form?.applyOptions(g=>g.type=this.prePartyQueueType),this.prePartyQueueType=void 0)}getInitialPartyState(){return{partyId:void 0,members:[],status:Y.PartyStatus.Idle}}requestPlayerProfileRefresh(){this.refreshProfileTask?.cancel(),this.refreshProfileTask=new I.Task(g=>this.refreshPlayerProfile(this.queueOpts.type,g)),this.refreshProfileTask.start().catch(g=>{g instanceof L.OperationCanceledError||console.error(g)})}refreshSidebarButtons(){this.controller.setSidebarButtons([{label:this.strings.get("GUI:QuickMatchPlay"),tooltip:this.strings.get("GUI:FindAGame"),disabled:this.queueState!==oe.None,flashing:this.playButtonFlashing,onClick:()=>{this.availableQueueTypes.includes(this.queueOpts.type)?setTimeout(()=>this.joinQueue(),0):this.messageBoxApi.show(this.strings.get("WOL:MatchModeUnavail"),this.strings.get("GUI:OK"))}},...this.partyEnabled&&this.partyState.partyId?[{label:this.strings.get("GUI:LeaveParty"),tooltip:this.strings.get("GUI:LeaveParty"),onClick:()=>{this.wolCon.partyLeave()}}]:[],...this.wladderService.getUrl()?[{label:this.strings.get("GUI:ViewLadder"),tooltip:this.strings.get("GUI:ViewTourLadder"),onClick:()=>{this.controller?.pushScreen(W.ScreenType.Ladder,{ladderType:ee.getLadderTypeForQueueType(this.queueOpts.type,this.partySize),highlightPlayer:this.playerProfile})}}]:[],...this.controller?.hasScreen(W.ScreenType.LadderRules)?[{label:this.strings.get("GUI:ViewRules"),onClick:()=>{this.controller?.pushScreen(W.ScreenType.LadderRules)}}]:[],...1<this.serverRegions.getSize()?[{label:this.strings.get("GUI:ChangeServer"),tooltip:this.strings.get("STT:ChangeServer"),onClick:()=>{this.wolService.closeWolConnection(),this.controller?.goToScreen(W.ScreenType.Login,{clearCredentials:!0,afterLogin:g=>new Q.MainMenuRoute(W.ScreenType.QuickGame,{messages:g})})}}]:[],{label:this.queueState===oe.None?this.strings.get("GUI:Back"):this.strings.get("GUI:Cancel"),isBottom:!0,onClick:()=>{this.queueState===oe.None?(this.wolService.closeWolConnection(),this.controller?.goToScreen(W.ScreenType.Home)):this.leaveQueue()}}],!0),this.controller.showSidebarButtons()}updateSidebarText(g){this.controller.setSidebarMpContent({text:g})}initView(){var[g]=this.jsxRenderer.render(_.jsx(U.HtmlView,{width:"100%",height:"100%",component:Z.QuickGameForm,innerRef:g=>this.form=g,props:{strings:this.strings,disabled:this.queueState!==oe.None,countryUiNames:new Map([[K.RANDOM_COUNTRY_NAME,K.RANDOM_COUNTRY_UI_NAME]].concat(this.getAvailablePlayerCountryRules().map(g=>[g.name,g.uiName]))),countryUiTooltips:new Map([[K.RANDOM_COUNTRY_NAME,K.RANDOM_COUNTRY_UI_TOOLTIP]].concat(this.getAvailablePlayerCountryRules().filter(g=>g.uiTooltip).map(g=>[g.name,g.uiTooltip]))),availableTypes:Object.values(ee.LadderQueueType),enabledTypes:this.availableQueueTypes,availableColors:[K.RANDOM_COLOR_NAME].concat(this.getAvailablePlayerColors()),availableCountries:[K.RANDOM_COUNTRY_NAME].concat(this.getAvailablePlayerCountries()),color:this.getColorNameById(this.queueOpts.colorId),country:this.getCountryNameById(this.queueOpts.countryId),type:this.queueOpts.type,ranked:this.queueOpts.ranked,unrankedEnabled:this.unrankedEnabled,playerName:this.wolCon.getCurrentUser()??"",playerProfile:this.playerProfile,chatProps:this.chatUi.getViewProps(),partyEnabled:this.partyEnabled,partyState:this.partyEnabled&&this.partyState.partyId?this.partyState:void 0,partySize:this.partyEnabled?this.partySize:1,noInvites:!!this.partyEnabled&&this.noInvites,onNoInvitesChange:g=>{this.partyEnabled&&(this.noInvites=g,this.form?.applyOptions(P=>P.noInvites=g),this.localPrefs.setItem(X.StorageKey.PartyNoInvites,g?"1":"0"),this.wolCon.partyNoInvites(g))},onCountrySelect:g=>{var P=this.getCountryIdByName(g);this.queueOpts.countryId=P,this.form?.applyOptions(P=>{P.country=g}),P!==K.RANDOM_COUNTRY_ID?this.localPrefs.setItem(X.StorageKey.LastPlayerCountry,String(P)):this.localPrefs.removeItem(X.StorageKey.LastPlayerCountry)},onColorSelect:g=>{var P=this.getColorIdByName(g);this.queueOpts.colorId=P,this.form?.applyOptions(P=>{P.color=g}),P!==K.RANDOM_COLOR_ID?this.localPrefs.setItem(X.StorageKey.LastPlayerColor,String(P)):this.localPrefs.removeItem(X.StorageKey.LastPlayerColor)},onRankedChange:g=>{this.queueOpts.ranked=g,this.form?.applyOptions(P=>P.ranked=g),this.localPrefs.setItem(X.StorageKey.LastQueueRanked,String(Number(g)))},onTypeChange:g=>{this.partySize>ee.teamSizes.get(g)||this.queueOpts.type!==g&&(this.queueOpts.type=g,this.playerProfile=void 0,this.form?.applyOptions(P=>{P.type=g,P.playerProfile=void 0}),this.localPrefs.setItem(X.StorageKey.LastQueueType,g),this.form&&this.requestPlayerProfileRefresh())}}}));this.controller.setMainComponent(g)}async refreshPlayerProfile(g,P){var I,L;!this.wladderService.getUrl()||(I=this.wolCon.getCurrentUser())&&(L=ee.getLadderTypeForQueueType(g,this.partySize),[L]=await this.wladderService.listSearch([I],P,L,J.WLadderService.CURRENT_SEASON,this.clientLocale),L&&!P.isCancelled()&&(this.playerProfile=L,this.form?.applyOptions(g=>g.playerProfile=this.playerProfile)))}getAvailablePlayerCountryRules(){return this.rules.getMultiplayerCountries()}getAvailablePlayerCountries(){return this.getAvailablePlayerCountryRules().map(g=>g.name)}getCountryNameById(g){let P;return P=g===K.RANDOM_COUNTRY_ID?K.RANDOM_COUNTRY_NAME:this.getAvailablePlayerCountries()[g],P}getCountryIdByName(g){let P;if(g===K.RANDOM_COUNTRY_NAME)P=K.RANDOM_COUNTRY_ID;else{P=this.getAvailablePlayerCountries().indexOf(g)}return P}getAvailablePlayerColors(){return[...this.rules.getMultiplayerColors().values()].map(g=>g.asHexString())}getColorNameById(g){let P;return P=g===K.RANDOM_COLOR_ID?K.RANDOM_COLOR_NAME:this.getAvailablePlayerColors()[g],P}getColorIdByName(g){let P;if(g===K.RANDOM_COLOR_NAME)P=K.RANDOM_COLOR_ID;else{if(P=this.getAvailablePlayerColors().indexOf(g),-1===P)throw new Error(`Color ${g} not found in available player colors`)}return P}async joinQueue(){if(this.queueState===oe.None){this.quickMatchChannelName=void 0,this.updateSidebarText(this.strings.get("WOL:RequestingMatch")+"..."),this.updateQueueState(oe.Initializing);try{var g=`#Lob ${this.wolConfig.getQuickMatchChannelId(this.queueOpts.type)} 0`;if(await this.wolCon.joinChannel(g,this.wolConfig.getGlobalChannelPass()),this.queueState!==oe.Initializing)return;this.quickMatchChannelName=g;let{countryId:I,colorId:L}=this.queueOpts;var P=re.REQ_MATCH+" "+[[re.TAG_COUNTRY,I],[re.TAG_COLOR,L],[re.TAG_VERSION,this.engineVersion],[re.TAG_MODHASH,this.engineModHash],[re.TAG_RANKED,Number(this.queueOpts.ranked)]].map(g=>g.join("=")).join(", ");this.wolCon.privmsg([this.wolConfig.getQuickMatchBotName()],P)}catch(g){return void(g instanceof te.WolError&&g.code===te.WolError.Code.BadChannelPass?this.handleError(g,this.strings.get("WOL:MatchModeUnavail"),{fatal:!1}):this.handleError(g,this.strings.get("WOL:MatchBadParameters"),{fatal:!0}))}}}leaveQueue(){this.queueState!==oe.None&&(this.updateQueueState(oe.None),this.wolCon.isOpen()&&this.quickMatchChannelName&&(this.wolCon.leaveChannel(this.quickMatchChannelName),this.quickMatchChannelName=void 0))}updateQueueState(g){if(this.queueState=g,this.gameStartTimeoutId&&(clearTimeout(this.gameStartTimeoutId),this.gameStartTimeoutId=void 0),this.countdownIntervalId&&(clearInterval(this.countdownIntervalId),this.countdownIntervalId=void 0),this.updateStatsIntervalId&&(clearInterval(this.updateStatsIntervalId),this.updateStatsIntervalId=void 0),this.form&&(this.form.applyOptions(P=>P.disabled=g!==oe.None),this.refreshSidebarButtons()),g!==oe.None){let P;switch(g===oe.WaitingForGameStart&&(this.gameStartTimeoutId=setTimeout(async()=>{console.log("Timed out. Rejoining queue..."),this.leaveQueue(),this.wolCon.isOpen()&&this.joinQueue()},1e4)),g===oe.WaitingForStartTimer&&(this.countdownIntervalId=setInterval(()=>this.tickStartTimer(),1e3)),g===oe.WaitingForMatch&&(this.updateStatsIntervalId=setInterval(()=>this.requestStats(),5e3)),g){case oe.WaitingForMatch:P=this.isWaitingForTeammate()?this.strings.get("GUI:WaitingForTeammate"):this.strings.get("TXT_SEARCHING_FOR",this.queueOpts.type);break;case oe.WaitingForStartTimer:P=this.strings.get("WOL:MatchStartSeconds",this.countdownSeconds);break;case oe.WaitingForGameStart:P=this.strings.get("WOL:MatchGameStarting")}void 0!==P&&(this.updateSidebarText(P),console.log(P))}else this.updateSidebarText("")}async tickStartTimer(){if(void 0===this.countdownSeconds)throw new Error("Game start countdown should be set by now");0<this.countdownSeconds?(this.countdownSeconds--,this.updateSidebarText(this.strings.get("WOL:MatchStartSeconds",this.countdownSeconds)),this.sound.play(q.SoundKey.QuickMatchTimer,$.ChannelType.Ui)):this.updateQueueState(oe.WaitingForGameStart)}requestStats(){this.queueState===oe.WaitingForMatch&&this.wolCon.privmsg([this.wolConfig.getQuickMatchBotName()],re.REQ_STATS)}async onUnstack(){this.refreshSidebarButtons(),this.initView(),this.wolService.isConnected()&&this.wolCon.getCurrentUser()?this.wolCon.privmsg([this.wolConfig.getQuickMatchBotName()],re.REQ_LIST_QUEUES):this.controller.goToScreen(W.ScreenType.Login,{afterLogin:g=>new Q.MainMenuRoute(W.ScreenType.QuickGame,{messages:g})}),this.requestPlayerProfileRefresh(),this.updatePartyUI()}async onStack(){await this.unrender()}async onLeave(){this.updateQueueState(oe.None),this.refreshProfileTask&&(this.refreshProfileTask.cancel(),this.refreshProfileTask=void 0),this.disposables.dispose(),this.wolCon.isOpen()&&this.quickMatchChannelName&&this.wolCon.leaveChannel(this.quickMatchChannelName),await this.unrender()}async unrender(){this.availQueueRefreshIntervalId&&(clearInterval(this.availQueueRefreshIntervalId),this.availQueueRefreshIntervalId=void 0),this.form=void 0,await this.controller.hideSidebarButtons()}showInviteDialog(g){if(!this.partyEnabled)return;this.pendingInvite&&clearTimeout(this.pendingInvite.timeoutId),this.destroyInviteDialog();var P=this.userHasDeclinedInvitesFrom.has(g);const i=()=>{this.pendingInvite&&(clearTimeout(this.pendingInvite.timeoutId),this.pendingInvite=void 0)};var I=setTimeout(()=>{this.pendingInvite=void 0,this.destroyInviteDialog()},3e4);this.pendingInvite={from:g,timeoutId:I},this.sound.play(q.SoundKey.PartyInvite,$.ChannelType.Ui);let[L]=this.jsxRenderer.render(_.jsx(U.HtmlView,{component:ne.PartyInviteDialog,props:{inviterName:g,strings:this.strings,showPreventionCheckbox:P,viewport:this.uiScene.viewport,onAccept:()=>{i(),this.destroyInviteDialog(),this.leaveQueue(),this.userHasDeclinedInvitesFrom.delete(g),this.wolCon.partyAccept(g)},onDecline:P=>{i(),this.destroyInviteDialog(),this.wolCon.partyDecline(g),this.userHasDeclinedInvitesFrom.add(g),P&&this.wolCon.partyPrevent(g,!0)}}}));this.inviteDialog=L,this.uiScene.add(L),this.disposables.add(L,()=>this.uiScene.remove(L),()=>this.inviteDialog=void 0)}destroyInviteDialog(){this.inviteDialog&&(this.inviteDialog.destroy(),this.inviteDialog=void 0)}updatePartyUI(){this.form&&this.form.applyOptions(g=>{g.partyState=this.partyEnabled&&this.partyState.partyId?this.partyState:void 0,g.partySize=this.partyEnabled?this.partySize:1,g.noInvites=!!this.partyEnabled&&this.noInvites,g.type=this.queueOpts.type}),this.refreshSidebarButtons()}handleError(g,P,{fatal:I}){this.updateQueueState(oe.None),this.errorHandler.handle(g,P,()=>{I&&(this.wolService.closeWolConnection(),this.controller?.goToScreen(W.ScreenType.Home))})}},g("QuickGameScreen",le)}}}),System.register("gui/screen/mainMenu/score/ScoreScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/mainMenu/score/ScoreTable","game/SideType","engine/sound/Music","gui/screen/mainMenu/MainMenuScreen","LocalPrefs","@puzzl/core/lib/async/Task","@puzzl/core/lib/async/cancellation/OperationCanceledError","@puzzl/core/lib/async/sleep"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g}],execute:function(){$=new Map([[U.SideType.GDI,{img:"mpascrnl.shp",pal:"mpascrn.pal"}],[U.SideType.Nod,{img:"mpsscrnl.shp",pal:"mpsscrn.pal"}],[U.SideType.ThirdSide,{img:"mpyscrnl.shp",pal:"mpyscrn.pal"}]]),Q=class extends V.MainMenuScreen{constructor(g,P,I,L,_,U){super(),this.strings=g,this.jsxRenderer=P,this.messageBoxApi=I,this.localPrefs=L,this.config=_,this.wolService=U,this.musicType=G.MusicType.Score}async onEnter(g){this.title=g.singlePlayer?this.strings.get("GUI:SkirmishScore"):this.strings.get("GUI:MultiplayerScore"),this.controller.toggleMainVideo(!1),this.initView(g),g.singlePlayer||this.loadGameReport(g.game)}initView({game:g,localPlayer:P,singlePlayer:G,tournament:V,returnTo:W}){this.controller.setSidebarButtons([{label:this.strings.get("GUI:Continue"),tooltip:this.strings.get("STT:MPScoreButtonContinue"),isBottom:!0,onClick:()=>{this.controller?.goToScreen(W.screenType,W.params)}}]),this.controller.showSidebarButtons();var z,K=P.country?.side??U.SideType.GDI;if(!(z=$.get(K)))throw new Error("Unsupported sideType "+K);var[z]=this.jsxRenderer.render(I.jsx("container",{width:"100%",height:"100%"},I.jsx("sprite",{image:z.img,palette:z.pal}),I.jsx(L.HtmlView,{width:"100%",height:"100%",component:_.ScoreTable,innerRef:g=>this.scoreTable=g,props:{game:g,singlePlayer:G,localPlayer:P,tournament:V,strings:this.strings}})));this.controller.setMainComponent(z)}loadGameReport(g){this.reportUpdateTask?.cancel();let P=this.reportUpdateTask=new z.Task(async P=>{for(;;){if(P.isCancelled())return;let I=this.wolService.getLastGameReport();if(I?.gameId===g.id)return void this.scoreTable.applyOptions(g=>{g.gameReport=I});await q.sleep(1e3,P)}});P.start().catch(g=>{g instanceof K.OperationCanceledError||console.error(g)})}async onLeave(){this.reportUpdateTask&&(this.reportUpdateTask.cancel(),this.reportUpdateTask=void 0),await this.controller.hideSidebarButtons();var g,P,I=this.config.donateUrl;I&&(2<=(P=Number(this.localPrefs.getItem(W.StorageKey.DonateBoxState)??"0"))?((g=await this.messageBoxApi.confirm(this.strings.get("TS:DonatePrompt"),this.strings.get("TS:DonateNow"),this.strings.get("TS:DonateLater")))&&window.open(I,"_blank"),this.localPrefs.setItem(W.StorageKey.DonateBoxState,"-"+Date.now()),window.gtag?.("event","donate_dismiss",{donate:g})):0<=P?this.localPrefs.setItem(W.StorageKey.DonateBoxState,String(P+1)):(P=-P,2592e6<Date.now()-P&&this.localPrefs.setItem(W.StorageKey.DonateBoxState,"0")))}},g("ScoreScreen",Q)}}}),System.register("gui/screen/mainMenu/score/ScoreTable",["classnames","game/gameopts/constants","gui/component/CountryIcon","react","util/format","gui/screen/mainMenu/lobby/component/RankIndicator","network/WolGameReport"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g}],execute:function(){g("ScoreTable",({game:g,singlePlayer:P,tournament:I,localPlayer:K,gameReport:q,strings:$})=>{const Q=g.getNonNeutralPlayers().filter(g=>!g.isObserver||g.defeated).sort((g,P)=>P.score-g.score);let Y=I&&q;var Z=q?.players.find(g=>g.name.toLowerCase()===K.name.toLowerCase());let X=Z?.resultType;return void 0===X&&(g.stalemateDetectTrait?.isStale()&&0===g.stalemateDetectTrait.getCountdownTicks()?X=W.WolGameReportResult.Draw:K.defeated?g.alliances.getAllies(K).filter(g=>!g.isAi&&!g.defeated).length||(X=W.WolGameReportResult.Loss):K.isObserver||(X=W.WolGameReportResult.Win)),U.default.createElement("div",{className:"score-wrapper"},(X||!P)&&U.default.createElement("div",{className:"score-title"},U.default.createElement("div",{className:"game-result"},X===W.WolGameReportResult.Win?$.get("gui:gameresultvictory"):X===W.WolGameReportResult.Draw?$.get("gui:gameresultdraw"):X===W.WolGameReportResult.Loss?$.get("gui:gameresultdefeat"):""),!q&&!P&&(I||void 0===X)&&U.default.createElement("div",{className:"pending-results"},$.get("gui:gameresultwaiting")),Z?.points&&U.default.createElement("div",{className:"points-gain"},$.get("GUI:LadderPoints")," ",Z.points.value," (",U.default.createElement(z,{className:"points-gain-value",value:Z.points.gain,win:X===W.WolGameReportResult.Win}),")")),U.default.createElement("div",{className:"score-header"},U.default.createElement("div",{"data-r-tooltip":$.get("STT:MPScoreLabelMapName")},$.get("TXT_MAP",g.gameOpts.mapTitle)),U.default.createElement("div",{"data-r-tooltip":$.get("STT:MPScoreLabelTime")},$.get("GUI:Time"),": ",G.formatTimeDuration(Math.floor(g.currentTime/1e3)))),U.default.createElement("table",null,U.default.createElement("thead",null,U.default.createElement("tr",null,U.default.createElement("th",null),U.default.createElement("th",{className:"player-rank"}),U.default.createElement("th",{className:"player-name","data-r-tooltip":$.get("STT:MPScoreLabelPlayer")},$.get("GUI:Player")),Y&&U.default.createElement("th",{className:"number"},$.get("GUI:MMR")),U.default.createElement("th",{className:"number","data-r-tooltip":$.get("STT:MPScoreLabelKills")},$.get("GUI:Kills")),U.default.createElement("th",{className:"number","data-r-tooltip":$.get("STT:MPScoreLabelLosses")},$.get("GUI:Losses")),U.default.createElement("th",{className:"number","data-r-tooltip":$.get("STT:MPScoreLabelBuilt")},$.get("GUI:Built")),U.default.createElement("th",{className:"number","data-r-tooltip":$.get("STT:MPScoreLabelScore")},$.get("GUI:Score")))),U.default.createElement("tbody",null,Q.map((g,P)=>{var I=q?.players.find(P=>P.name.toLowerCase()===g.name.toLowerCase()),G=I?.mmr?.value,K=I?.mmr?.gain;return U.default.createElement("tr",{key:P,style:{color:g.color.asHexString()}},U.default.createElement("td",null,U.default.createElement(_.CountryIcon,{country:g.country.name})),U.default.createElement("td",{className:"player-rank"},I&&U.default.createElement(V.RankIndicator,{playerProfile:I,strings:$})),U.default.createElement("td",{className:"player-name","data-r-tooltip":$.get("STT:MPScoreLabelPlayer")},g.isAi?$.get(L.aiUiNames.get(g.aiDifficulty)):g.name),Y&&U.default.createElement("td",{className:"number player-mmr"},G??"-",void 0!==K&&U.default.createElement(U.default.Fragment,null," (",U.default.createElement(z,{className:"mmr-gain",value:K,win:I?.resultType===W.WolGameReportResult.Win}),")")),U.default.createElement("td",{className:"number","data-r-tooltip":$.get("STT:MPScoreLabelKills")},g.getUnitsKilled()),U.default.createElement("td",{className:"number","data-r-tooltip":$.get("STT:MPScoreLabelLosses")},g.getUnitsLost()),U.default.createElement("td",{className:"number","data-r-tooltip":$.get("STT:MPScoreLabelBuilt")},g.getUnitsBuilt()),U.default.createElement("td",{className:"number","data-r-tooltip":$.get("STT:MPScoreLabelScore")},g.score))}))))}),z=({value:g,win:P,className:L})=>{let _;return _=0<g?"+":0===g?P?"+":"-":"",U.default.createElement("span",{className:I.default(L,{positive:P})},_,g)}}}}),System.register("gui/screen/mainMenu/ScreenParamsMap",["gui/screen/mainMenu/ScreenType"],function(g,P){"use strict";return P&&P.id,{setters:[function(g){}],execute:function(){}}}),System.register("gui/screen/mainMenu/ScreenType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("ScreenType",I={}))[P.Home=0]="Home",P[P.Skirmish=1]="Skirmish",P[P.QuickGame=2]="QuickGame",P[P.CustomGame=3]="CustomGame",P[P.Login=4]="Login",P[P.NewAccount=5]="NewAccount",P[P.Lobby=6]="Lobby",P[P.MapSelection=7]="MapSelection",P[P.Ladder=8]="Ladder",P[P.LadderRules=9]="LadderRules",P[P.ReplaySelection=10]="ReplaySelection",P[P.ModSelection=11]="ModSelection",P[P.Score=12]="Score",P[P.InfoAndCredits=13]="InfoAndCredits",P[P.PatchNotes=14]="PatchNotes",P[P.Credits=15]="Credits",P[P.Options=16]="Options",P[P.OptionsSound=17]="OptionsSound",P[P.OptionsKeyboard=18]="OptionsKeyboard",P[P.OptionsStorage=19]="OptionsStorage"}}}),System.register("gui/screen/options/component/configurableCmds",["gui/screen/game/worldInteraction/keyboard/KeyCommandType"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("configurableCmds",new Map([[I.KeyCommandType.Options,{label:"txt_options",desc:"txt_options_desc"}],[I.KeyCommandType.ToggleAlliance,{label:"txt_alliance",desc:"txt_alliance_desc"}],[I.KeyCommandType.PlaceBeacon,{label:"txt_place_beacon",desc:"txt_place_beacon_desc"}],[I.KeyCommandType.AllToCheer,{label:"cmnd:allcheer",desc:"cmnd:allcheerdesc"}],[I.KeyCommandType.DeployObject,{label:"txt_deploy_object",desc:"txt_deploy_object_desc"}],[I.KeyCommandType.Follow,{label:"txt_follow",desc:"txt_follow_desc"}],[I.KeyCommandType.GuardObject,{label:"txt_guard",desc:"txt_guard_desc"}],[I.KeyCommandType.StopObject,{label:"txt_stop_object",desc:"txt_stop_object_desc"}],[I.KeyCommandType.ScatterObject,{label:"txt_scatter",desc:"txt_scatter_desc"}],[I.KeyCommandType.CenterBase,{label:"txt_center_base",desc:"txt_center_base_desc"}],[I.KeyCommandType.ToggleRepair,{label:"txt_repair_mode",desc:"txt_repair_mode_desc"}],[I.KeyCommandType.ToggleSell,{label:"txt_sell_mode",desc:"txt_sell_mode_desc"}],[I.KeyCommandType.PreviousObject,{label:"txt_prev_object",desc:"txt_prev_object_desc"}],[I.KeyCommandType.NextObject,{label:"txt_next_object",desc:"txt_next_object_desc"}],[I.KeyCommandType.TypeSelect,{label:"cmnd:typeselect",desc:"cmnd:typeselectdesc"}],[I.KeyCommandType.CombatantSelect,{label:"cmnd:combatantselect",desc:"cmnd:combatantselectdesc"}],[I.KeyCommandType.StructureTab,{label:"txt_structure_tab",desc:"txt_structure_tab_desc"}],[I.KeyCommandType.DefenseTab,{label:"txt_defense_tab",desc:"txt_defense_tab_desc"}],[I.KeyCommandType.InfantryTab,{label:"txt_infantry_tab",desc:"txt_infantry_tab_desc"}],[I.KeyCommandType.UnitTab,{label:"txt_unit_tab",desc:"txt_unit_tab_desc"}],[I.KeyCommandType.PlanningMode,{label:"cmnd:planningmode",desc:"cmnd:planningmodedesc"}],[I.KeyCommandType.CenterOnRadarEvent,{label:"txt_radar_event",desc:"txt_radar_event_desc"}],[I.KeyCommandType.HealthNav,{label:"cmnd:healthnavigation",desc:"cmnd:healthnavigationdesc"}],[I.KeyCommandType.VeterancyNav,{label:"cmnd:vetnavigation",desc:"cmnd:vetnavigationdesc"}],[I.KeyCommandType.TeamSelect_1,{label:g=>g.get("txt_select_team",1),desc:g=>g.get("txt_select_team_desc",1)}],[I.KeyCommandType.TeamSelect_2,{label:g=>g.get("txt_select_team",2),desc:g=>g.get("txt_select_team_desc",2)}],[I.KeyCommandType.TeamSelect_3,{label:g=>g.get("txt_select_team",3),desc:g=>g.get("txt_select_team_desc",3)}],[I.KeyCommandType.TeamSelect_4,{label:g=>g.get("txt_select_team",4),desc:g=>g.get("txt_select_team_desc",4)}],[I.KeyCommandType.TeamSelect_5,{label:g=>g.get("txt_select_team",5),desc:g=>g.get("txt_select_team_desc",5)}],[I.KeyCommandType.TeamSelect_6,{label:g=>g.get("txt_select_team",6),desc:g=>g.get("txt_select_team_desc",6)}],[I.KeyCommandType.TeamSelect_7,{label:g=>g.get("txt_select_team",7),desc:g=>g.get("txt_select_team_desc",7)}],[I.KeyCommandType.TeamSelect_8,{label:g=>g.get("txt_select_team",8),desc:g=>g.get("txt_select_team_desc",8)}],[I.KeyCommandType.TeamSelect_9,{label:g=>g.get("txt_select_team",9),desc:g=>g.get("txt_select_team_desc",9)}],[I.KeyCommandType.TeamSelect_10,{label:g=>g.get("txt_select_team",10),desc:g=>g.get("txt_select_team_desc",10)}],[I.KeyCommandType.TeamCreate_1,{label:g=>g.get("txt_create_team",1),desc:g=>g.get("txt_create_team_desc",1)}],[I.KeyCommandType.TeamCreate_2,{label:g=>g.get("txt_create_team",2),desc:g=>g.get("txt_create_team_desc",2)}],[I.KeyCommandType.TeamCreate_3,{label:g=>g.get("txt_create_team",3),desc:g=>g.get("txt_create_team_desc",3)}],[I.KeyCommandType.TeamCreate_4,{label:g=>g.get("txt_create_team",4),desc:g=>g.get("txt_create_team_desc",4)}],[I.KeyCommandType.TeamCreate_5,{label:g=>g.get("txt_create_team",5),desc:g=>g.get("txt_create_team_desc",5)}],[I.KeyCommandType.TeamCreate_6,{label:g=>g.get("txt_create_team",6),desc:g=>g.get("txt_create_team_desc",6)}],[I.KeyCommandType.TeamCreate_7,{label:g=>g.get("txt_create_team",7),desc:g=>g.get("txt_create_team_desc",7)}],[I.KeyCommandType.TeamCreate_8,{label:g=>g.get("txt_create_team",8),desc:g=>g.get("txt_create_team_desc",8)}],[I.KeyCommandType.TeamCreate_9,{label:g=>g.get("txt_create_team",9),desc:g=>g.get("txt_create_team_desc",9)}],[I.KeyCommandType.TeamCreate_10,{label:g=>g.get("txt_create_team",10),desc:g=>g.get("txt_create_team_desc",10)}],[I.KeyCommandType.TeamAddSelect_1,{label:g=>g.get("txt_add_select_team",1),desc:g=>g.get("txt_add_select_team_desc",1)}],[I.KeyCommandType.TeamAddSelect_2,{label:g=>g.get("txt_add_select_team",2),desc:g=>g.get("txt_add_select_team_desc",2)}],[I.KeyCommandType.TeamAddSelect_3,{label:g=>g.get("txt_add_select_team",3),desc:g=>g.get("txt_add_select_team_desc",3)}],[I.KeyCommandType.TeamAddSelect_4,{label:g=>g.get("txt_add_select_team",4),desc:g=>g.get("txt_add_select_team_desc",4)}],[I.KeyCommandType.TeamAddSelect_5,{label:g=>g.get("txt_add_select_team",5),desc:g=>g.get("txt_add_select_team_desc",5)}],[I.KeyCommandType.TeamAddSelect_6,{label:g=>g.get("txt_add_select_team",6),desc:g=>g.get("txt_add_select_team_desc",6)}],[I.KeyCommandType.TeamAddSelect_7,{label:g=>g.get("txt_add_select_team",7),desc:g=>g.get("txt_add_select_team_desc",7)}],[I.KeyCommandType.TeamAddSelect_8,{label:g=>g.get("txt_add_select_team",8),desc:g=>g.get("txt_add_select_team_desc",8)}],[I.KeyCommandType.TeamAddSelect_9,{label:g=>g.get("txt_add_select_team",9),desc:g=>g.get("txt_add_select_team_desc",9)}],[I.KeyCommandType.TeamAddSelect_10,{label:g=>g.get("txt_add_select_team",10),desc:g=>g.get("txt_add_select_team_desc",10)}],[I.KeyCommandType.TeamCenter_1,{label:g=>g.get("txt_center_team",1),desc:g=>g.get("txt_center_team_desc",1)}],[I.KeyCommandType.TeamCenter_2,{label:g=>g.get("txt_center_team",2),desc:g=>g.get("txt_center_team_desc",2)}],[I.KeyCommandType.TeamCenter_3,{label:g=>g.get("txt_center_team",3),desc:g=>g.get("txt_center_team_desc",3)}],[I.KeyCommandType.TeamCenter_4,{label:g=>g.get("txt_center_team",4),desc:g=>g.get("txt_center_team_desc",4)}],[I.KeyCommandType.TeamCenter_5,{label:g=>g.get("txt_center_team",5),desc:g=>g.get("txt_center_team_desc",5)}],[I.KeyCommandType.TeamCenter_6,{label:g=>g.get("txt_center_team",6),desc:g=>g.get("txt_center_team_desc",6)}],[I.KeyCommandType.TeamCenter_7,{label:g=>g.get("txt_center_team",7),desc:g=>g.get("txt_center_team_desc",7)}],[I.KeyCommandType.TeamCenter_8,{label:g=>g.get("txt_center_team",8),desc:g=>g.get("txt_center_team_desc",8)}],[I.KeyCommandType.TeamCenter_9,{label:g=>g.get("txt_center_team",9),desc:g=>g.get("txt_center_team_desc",9)}],[I.KeyCommandType.TeamCenter_10,{label:g=>g.get("txt_center_team",10),desc:g=>g.get("txt_center_team_desc",10)}],[I.KeyCommandType.CenterView,{label:"txt_center_view",desc:"txt_center_view_desc"}],[I.KeyCommandType.View1,{label:"txt_view_bookmark1",desc:"txt_view_bookmark1_desc"}],[I.KeyCommandType.View2,{label:"txt_view_bookmark2",desc:"txt_view_bookmark2_desc"}],[I.KeyCommandType.View3,{label:"txt_view_bookmark3",desc:"txt_view_bookmark3_desc"}],[I.KeyCommandType.View4,{label:"txt_view_bookmark4",desc:"txt_view_bookmark4_desc"}],[I.KeyCommandType.SetView1,{label:"txt_set_bookmark1",desc:"txt_set_bookmark1_desc"}],[I.KeyCommandType.SetView2,{label:"txt_set_bookmark2",desc:"txt_set_bookmark2_desc"}],[I.KeyCommandType.SetView3,{label:"txt_set_bookmark3",desc:"txt_set_bookmark3_desc"}],[I.KeyCommandType.SetView4,{label:"txt_set_bookmark4",desc:"txt_set_bookmark4_desc"}],[I.KeyCommandType.Taunt_1,{label:g=>g.get("txt_taunt_number",1),desc:g=>g.get("txt_taunt_desc",1)}],[I.KeyCommandType.Taunt_2,{label:g=>g.get("txt_taunt_number",2),desc:g=>g.get("txt_taunt_desc",2)}],[I.KeyCommandType.Taunt_3,{label:g=>g.get("txt_taunt_number",3),desc:g=>g.get("txt_taunt_desc",3)}],[I.KeyCommandType.Taunt_4,{label:g=>g.get("txt_taunt_number",4),desc:g=>g.get("txt_taunt_desc",4)}],[I.KeyCommandType.Taunt_5,{label:g=>g.get("txt_taunt_number",5),desc:g=>g.get("txt_taunt_desc",5)}],[I.KeyCommandType.Taunt_6,{label:g=>g.get("txt_taunt_number",6),desc:g=>g.get("txt_taunt_desc",6)}],[I.KeyCommandType.Taunt_7,{label:g=>g.get("txt_taunt_number",7),desc:g=>g.get("txt_taunt_desc",7)}],[I.KeyCommandType.Taunt_8,{label:g=>g.get("txt_taunt_number",8),desc:g=>g.get("txt_taunt_desc",8)}],[I.KeyCommandType.Delete,{label:"cmnd:delete",desc:"cmnd:deletedesc"}],[I.KeyCommandType.PageUser,{label:"txt_pageuser",desc:"txt_pageuser_desc"}],[I.KeyCommandType.SidebarPageUp,{label:"txt_sidebar_pgup",desc:"txt_sidebar_pgup_desc"}],[I.KeyCommandType.SidebarUp,{label:"txt_sidebar_up",desc:"txt_sidebar_up_desc"}],[I.KeyCommandType.SidebarPageDown,{label:"txt_sidebar_pgdn",desc:"txt_sidebar_pgdn_desc"}],[I.KeyCommandType.SidebarDown,{label:"txt_sidebar_down",desc:"txt_sidebar_down_desc"}],[I.KeyCommandType.TogglePersistentTags,{label:()=>"Persistent Tags",desc:()=>"Toggle unit and sidebar persistent tags"}],[I.KeyCommandType.ToggleFps,{label:"cmnd:togglefps",desc:"cmnd:togglefpsdesc"}]]))}}}),System.register("gui/screen/options/component/GeneralOpts",["react","gui/component/Slider","gui/screen/options/GeneralOptions","gui/component/Select","gui/component/Option","engine/renderable/entity/unit/FlyerHelperMode","engine/renderable/entity/unit/ModelQuality","engine/renderable/entity/unit/ShadowQuality","gui/component/Image","gui/screen/options/component/Resolution"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q;function p(g){var P=g?.getItem?.(Q);return"0"!==P&&("1"===P||(!!window.matchMedia?.("(pointer: coarse)")?.matches||(navigator.maxTouchPoints??0)>0||"ontouchstart"in window))}function m(g,P){g?.setItem?.(Q,P?"1":"0"),"undefined"!=typeof window&&window.__ra2webVirtualJoystickLite?.setEnabled?.(!!P,!1)}return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g}],execute:function(){Q="ra2web.mobileJoystickLite.enabled",$=new Map([[1,"TXT_SLOWEST"],[2,"TXT_SLOWER"],[3,"TXT_SLOW"],[4,"TXT_MEDIUM"],[5,"TXT_FAST"],[6,"TXT_FASTER"],[7,"TXT_FASTEST"]]),g("GeneralOpts",({strings:g,options:P,fullScreen:Q,inGame:Y,localPrefs:Z})=>I.createElement("div",{className:"opts general-opts"},I.createElement("fieldset",null,I.createElement("legend",null,g.get("TS:GameplayOpts")),I.createElement("div",{className:"slider-item"},I.createElement("span",{className:"label"},g.get("GUI:ScrollRate")),I.createElement(L.Slider,{min:1,max:7,value:""+Math.floor(P.scrollRate.value/_.SCROLL_BASE_FACTOR),getLabel:P=>g.get($.get(Number(P))),onChange:g=>P.scrollRate.value=Number(g.target.value)*_.SCROLL_BASE_FACTOR})),I.createElement("div",{className:"item","data-r-tooltip":g.get("STT:MouseAccel")},I.createElement("label",null,I.createElement("span",{className:"label"},g.get("TS:MouseAccel")),I.createElement(U.Select,{initialValue:""+Number(P.mouseAcceleration.value),onSelect:g=>P.mouseAcceleration.value=Boolean(Number(g))},I.createElement(G.Option,{value:"1",label:g.get("TXT_ON")}),I.createElement(G.Option,{value:"0",label:g.get("TXT_OFF")})),I.createElement("span",{className:"info",title:g.get("TS:MouseAccelHint")},I.createElement(K.Image,{src:"info.png"})))),I.createElement("div",{className:"item","data-r-tooltip":g.get("STT:AttackMoveButton")},I.createElement("label",null,I.createElement("span",{className:"label"},g.get("TS:AttackMoveButton")),I.createElement(U.Select,{initialValue:""+Number(P.rightClickMove.value),onSelect:g=>P.rightClickMove.value=Boolean(Number(g))},I.createElement(G.Option,{value:"0",label:g.get("TS:AttackMoveButtonLeft")}),I.createElement(G.Option,{value:"1",label:g.get("TS:AttackMoveButtonRight")})))),I.createElement("div",{className:"item","data-r-tooltip":g.get("STT:RightClickScroll")},I.createElement("label",null,I.createElement("span",{className:"label"},g.get("TS:RightClickScroll")),I.createElement(U.Select,{initialValue:""+Number(P.rightClickScroll.value),onSelect:g=>P.rightClickScroll.value=Boolean(Number(g))},I.createElement(G.Option,{value:"1",label:g.get("TXT_ON")}),I.createElement(G.Option,{value:"0",label:g.get("TXT_OFF")})))),I.createElement("div",{className:"item","data-r-tooltip":g.get("STT:FlyerLabel")},I.createElement("span",{className:"label"},g.get("TS:FlyerLabel")),I.createElement(U.Select,{initialValue:""+P.flyerHelper.value,onSelect:g=>P.flyerHelper.value=Number(g)},I.createElement(G.Option,{value:""+V.FlyerHelperMode.Always,label:g.get("TS:FlyerAlways")}),I.createElement(G.Option,{value:""+V.FlyerHelperMode.Selected,label:g.get("TS:FlyerSelected")}),I.createElement(G.Option,{value:""+V.FlyerHelperMode.Never,label:g.get("TS:FlyerNever")}))),I.createElement("div",{className:"item","data-r-tooltip":g.get("STT:IGGameOptCBoxHidden")},I.createElement("label",null,I.createElement("span",{className:"label"},g.get("GUI:ShowHidden")),I.createElement("input",{type:"checkbox",defaultChecked:P.hiddenObjects.value,onChange:g=>P.hiddenObjects.value=g.target.checked}))),I.createElement("div",{className:"item","data-r-tooltip":g.get("STT:IGGameOptCBoxTargetLines")},I.createElement("label",null,I.createElement("span",{className:"label"},g.get("GUI:TargetLines")),I.createElement("input",{type:"checkbox",defaultChecked:P.targetLines.value,onChange:g=>P.targetLines.value=g.target.checked}))),I.createElement("div",{className:"item","data-r-tooltip":""},I.createElement("label",null,I.createElement("span",{className:"label"},""),I.createElement("input",{type:"checkbox",defaultChecked:p(Z),onChange:g=>m(Z,g.target.checked)})))),I.createElement("fieldset",null,I.createElement("legend",null,g.get("TS:GfxOpts")),I.createElement("div",{className:"item"},I.createElement("span",{className:"label"},g.get("TS:Resolution")),I.createElement(q.ResolutionSelect,{resolution:P.graphics.resolution,fullScreen:Q,strings:g}),I.createElement("span",{className:"info",title:g.get("TS:ResolutionHint")},I.createElement(K.Image,{src:"info.png"}))),I.createElement("div",{className:"item","data-r-tooltip":g.get("STT:GfxModels")},I.createElement("span",{className:"label"},g.get("TS:GfxModels")),I.createElement(U.Select,{disabled:Y,initialValue:""+P.graphics.models.value,onSelect:g=>P.graphics.models.value=Number(g)},I.createElement(G.Option,{value:""+W.ModelQuality.High,label:g.get("TS:GfxQualityHigh")}),I.createElement(G.Option,{value:""+W.ModelQuality.Low,label:g.get("TS:GfxQualityLow")}))),I.createElement("div",{className:"item","data-r-tooltip":g.get("STT:GfxShadows")},I.createElement("span",{className:"label"},g.get("TS:GfxShadows")),I.createElement(U.Select,{initialValue:""+P.graphics.shadows.value,onSelect:g=>P.graphics.shadows.value=Number(g)},I.createElement(G.Option,{value:""+z.ShadowQuality.High,label:g.get("TS:GfxQualityHigh")}),I.createElement(G.Option,{value:""+z.ShadowQuality.Medium,label:g.get("TS:GfxQualityMed")}),I.createElement(G.Option,{value:""+z.ShadowQuality.Low,label:g.get("TS:GfxQualityLow")}),I.createElement(G.Option,{value:""+z.ShadowQuality.Off,label:g.get("TS:GfxQualityOff")}))))))}}}),System.register("gui/screen/options/component/getHumanReadableKey",["util/keyNames","util/userAgent"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("getHumanReadableKey",g=>{var P=L.isMac()||L.isIpad();let _=[];return g.ctrlKey&&_.push("Ctrl"),g.altKey&&_.push(P?"":"Alt"),g.shiftKey&&_.push("Shift"),g.metaKey&&_.push(P?"":"Win"),void 0!==g.keyCode?(_.push(I.getKeyName(g.keyCode)),_.join("+")):_.join("+")+"+"})}}}),System.register("gui/screen/options/component/KeyOpts",["react","gui/screen/options/component/configurableCmds","gui/component/List","gui/screen/options/component/PressKeyInput","gui/screen/options/component/getHumanReadableKey","gui/screen/game/worldInteraction/keyboard/KeyboardHandler"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){g("KeyOpts",({strings:g,keyBinds:P,onResetAll:W,onHotKeyChange:z})=>{let[K,q]=I.useState(),[$,Q]=I.useState(),[Y,Z]=I.useState(),[X,J]=I.useState(0),[ee,te]=I.useState();const p=P=>"function"==typeof P?P(g):g.get(P);let re=K&&L.configurableCmds.has(K)?L.configurableCmds.get(K).desc:void 0;var se=re?"function"==typeof re?re(g):g.get(re):void 0,ae=K?P.getHotKey(K):void 0;return I.default.createElement("div",{className:"opts key-opts"},I.default.createElement("div",{className:"key-opts-list"},I.default.createElement("div",{className:"key-opts-left"},I.default.createElement(_.List,{title:g.get("GUI:Commands"),className:"key-list"},[...L.configurableCmds].map(([g,{label:P}])=>I.default.createElement(_.ListItem,{key:g,selected:K===g,onClick:()=>(g=>{q(g),Q(void 0),J(X+1),te(void 0)})(g)},p(P))))),I.default.createElement("div",{className:"key-opts-right"},I.default.createElement("fieldset",{className:"key-opts-desc-container"},I.default.createElement("legend",null,g.get("GUI:Description")),I.default.createElement("div",{className:"key-opts-desc"},se)))),I.default.createElement("div",{className:"key-opts-assigns"},I.default.createElement("div",{className:"key-opts-cur-assign"},I.default.createElement("div",{className:"key-opts-left","data-r-tooltip":g.get("STT:KeyboardLabelAssigned")},I.default.createElement("div",{className:"key-opts-cur-assign-label"},g.get("GUI:CurrentShortcut")),I.default.createElement("div",{className:"key-opts-cur-assign-value"},ae&&G.getHumanReadableKey(ae))),I.default.createElement("div",{className:"key-opts-right"},ee)),I.default.createElement("div",{className:"key-opts-ch-assign"},I.default.createElement("div",{className:"key-opts-left"},I.default.createElement("div",{className:"key-opts-ch-assign-label"},g.get("GUI:PressShortcut")),I.default.createElement(U.PressKeyInput,{key:X,onChange:g=>{Q(g?P.getCommandType(g):void 0),Z(g),te(void 0)},tooltip:g.get("STT:KeyboardEditEntry")}),I.default.createElement("div",{className:"key-opts-ch-assign-current"},I.default.createElement("div",null,g.get("GUI:CurAssignedTo")),I.default.createElement("div",null,$&&L.configurableCmds.has($)?p(L.configurableCmds.get($).label):""))),I.default.createElement("div",{className:"key-opts-right"},I.default.createElement("button",{className:"dialog-button",disabled:!K,onClick:()=>{if(K){if(Y&&(Y.shiftKey||Y.ctrlKey||Y.altKey||Y.metaKey)){if(V.KeyboardHandler.anyModifierCommands.includes(K))return void te(g.get("Error:CannotMap"));var I=P.getCommandType({keyCode:Y.keyCode,altKey:!1,ctrlKey:!1,shiftKey:!1,metaKey:!1});if(void 0!==I&&V.KeyboardHandler.anyModifierCommands.includes(I))return void te(g.get("Error:CannotRemap"))}z?.(K,Y),Q(void 0),Z(void 0),J(X+1),te(void 0)}},"data-r-tooltip":g.get("STT:KeyboardButtonAssign")},g.get("GUI:Assign")),I.default.createElement("button",{className:"dialog-button",onClick:async()=>{q(void 0),Q(void 0),Z(void 0),te(void 0),await(W?.()),J(X+1)},"data-r-tooltip":g.get("STT:KeyboardButtonResetAll")},g.get("GUI:ResetAll")))),I.default.createElement("fieldset",{className:"key-opts-ch-assign-warn"},I.default.createElement("legend",null,g.get("TS:Warning").toLocaleUpperCase()),g.get("TS:HotKeyFSWarning"))))})}}}),System.register("gui/screen/options/component/MusicJukebox",["gui/component/List","react","util/string"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("MusicJukebox",({music:g,strings:P})=>{const[U,G]=L.useState(()=>g.getCurrentPlaylistItem());return L.default.createElement("div",{className:"music-jukebox"},L.default.createElement("div",{className:"jukebox-content"},L.default.createElement("div",{className:"controls"},L.default.createElement("div",null,L.default.createElement("label",null,L.default.createElement("input",{type:"checkbox",defaultChecked:g.getShuffleMode(),onChange:P=>g.setShuffleMode(P.target.checked)}),P.get("GUI:Shuffle"))),L.default.createElement("div",null,L.default.createElement("label",null,L.default.createElement("input",{type:"checkbox",defaultChecked:g.getRepeatMode(),onChange:P=>g.setRepeatMode(P.target.checked)}),P.get("GUI:Repeat")))),L.default.createElement(I.List,{className:"playlist"},g.getPlaylist().map((g,V)=>L.default.createElement(I.ListItem,{key:g.name,selected:g===U,onClick:()=>G(g)},_.pad(V+1,"00")," - ",P.get(g.name))))),L.default.createElement("div",{className:"jukebox-footer"},L.default.createElement("button",{className:"dialog-button",onClick:()=>U&&g.selectPlaylistItem(U)},P.get("GUI:Play")),L.default.createElement("button",{className:"dialog-button",onClick:()=>g.stopPlaying()},P.get("GUI:Stop"))))})}}}),System.register("gui/screen/options/component/PressKeyInput",["gui/FullScreen","react","gui/screen/options/component/getHumanReadableKey"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=g=>g.shiftKey||g.ctrlKey||g.altKey||g.metaKey,G=g=>["Alt","Control","Shift","Meta"].includes(g.key),V=["Escape","Backspace","Enter","Tab","ArrowLeft","ArrowRight","ArrowUp","ArrowDown"," "],g("PressKeyInput",({tooltip:g,onChange:P})=>{const[W,z]=L.useState(),s=g=>{z(g),g&&void 0===g.keyCode||P(g)};var K=W?_.getHumanReadableKey(W):"";return L.default.createElement("input",{type:"text",value:K,"data-r-tooltip":g,onChange:()=>{},onKeyDown:g=>{g.preventDefault(),g.stopPropagation(),g.repeat||255<g.keyCode||(V.includes(g.key)||I.FullScreen.isFullScreenHotKey(g)?s(void 0):s({shiftKey:g.shiftKey,ctrlKey:g.ctrlKey,altKey:g.altKey,metaKey:g.metaKey,keyCode:G(g)?void 0:g.keyCode}))},onKeyUp:g=>{g.preventDefault(),g.stopPropagation(),g.repeat||255<g.keyCode||void 0===W?.keyCode&&G(g)&&s(U(g)?{shiftKey:g.shiftKey,ctrlKey:g.ctrlKey,altKey:g.altKey,metaKey:g.metaKey,keyCode:void 0}:void 0)},onBlur:()=>{W&&void 0===W?.keyCode&&s(void 0)}})})}}}),System.register("gui/screen/options/component/Resolution",["gui/component/Select","gui/component/Option","react"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=[{width:1920,height:1080},{width:1600,height:900},{width:1280,height:1024},{width:1366,height:768},{width:1024,height:768},{width:800,height:600}],g("ResolutionSelect",({resolution:g,fullScreen:P,strings:G})=>{const r=g=>g.width+" x "+g.height,s=()=>({width:Math.max(U[U.length-1].width,window.innerWidth),height:Math.max(U[U.length-1].height,window.innerHeight)}),a=g=>U.filter((P,I)=>P.height<=g.height&&P.width<=g.width||I===U.length-1),[V,W]=_.useState(()=>s()),[z,K]=_.useState(g.value),[q,$]=_.useState(()=>a(V));var Q=P.isFullScreen(),Y=z&&!q.find(g=>g.height===z.height&&g.width===z.width);return _.useEffect(()=>{const e=()=>{var g=s();W(g),$(a(g))};return window.addEventListener("resize",e),g.onChange.subscribe(K),()=>{window.removeEventListener("resize",e),g.onChange.unsubscribe(K)}},[]),Q?_.createElement(I.Select,{className:"resolution-select",initialValue:"",disabled:!0,onSelect:()=>{}},_.createElement(L.Option,{value:"",label:G.get("TS:ResolutionFullScreen",r(V))})):_.createElement(I.Select,{className:"resolution-select",initialValue:z?r(z):"",onSelect:P=>{var I=(I=""!==P?P.split(" x ").map(g=>Number(g)):void 0)?{width:I[0],height:I[1]}:void 0;g.value=I}},Y&&_.createElement(L.Option,{value:r(z),label:`${r(z)} (${r({width:Math.min(z.width,V.width),height:Math.min(z.height,V.height)})})`}),_.createElement(L.Option,{value:"",label:G.get("TS:ResolutionFit",r(V))}),q.map(g=>{var P=r(g);return _.createElement(L.Option,{key:P,value:P,label:P})}))})}}}),System.register("gui/screen/options/component/SoundOpts",["react","gui/component/Slider","engine/sound/ChannelType","gui/screen/options/component/MusicJukebox"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=new Map([[_.ChannelType.Master,"GUI:MasterVolume"],[_.ChannelType.Music,"GUI:MusicVolume"],[_.ChannelType.Effect,"GUI:SFXVolume"],[_.ChannelType.Voice,"GUI:VoiceVolume"],[_.ChannelType.Ambient,"GUI:AmbientVolume"],[_.ChannelType.Ui,"GUI:UIVolume"],[_.ChannelType.CreditTicks,"GUI:CreditsVolume"]]),g("SoundOpts",({strings:g,music:P,mixer:_})=>I.createElement("div",{className:"opts sound-opts"},I.createElement("div",{className:"sound-sliders"},[...G].map(([P,U])=>I.createElement("div",{className:"slider-item",key:P},I.createElement("span",{className:"label"},g.get(U)),I.createElement(L.Slider,{min:0,max:10,value:""+10*_.getVolume(P),onChange:g=>_.setVolume(P,Number(g.target.value)/10)})))),P&&I.createElement(U.MusicJukebox,{music:P,strings:g})))}}}),System.register("gui/screen/options/component/StorageExplorer",["@puzzl/core/lib/regexp","data/vfs/RealFileSystemDir","data/zip/Zip","engine/Engine","gui/replay/ReplayStorageFileSystem","gui/screen/mainMenu/modSel/ModManager","network/gamestate/Replay","react","util/CssLoader","util/ScriptLoader","util/time"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g}],execute:function(){var P;Q=g=>te.some(P=>"string"==typeof P?g.toLowerCase()===P.toLowerCase():P.test(g)),Y=async(g,P)=>{let I=[];for await(var[L,_]of g.entries())I.push({id:L,name:L,type:"directory"===_.kind?"folder":"file",hash:L,attrs:"directory"!==_.kind||Q(("/"!==P?P:"")+"/"+L)?void 0:{canmodify:!1},..."file"===_.kind?{size:(await _.getFile()).size}:{}});return I},Z=async(g,P,I=!1)=>{let L=P;for(var _ of g.slice(1))L=await L.getDirectoryHandle(_,{create:I});return L},X=["/keyboard.ini",/^\/(language|multi|ra2)\.mix$/i,"/"+U.Engine.rfsSettings.menuVideoFileName,"/"+U.Engine.rfsSettings.splashImgFileName,new RegExp(`^/${U.Engine.rfsSettings.musicDir}/([^/]+)\\.mp3$`,"i"),new RegExp(`^/${U.Engine.rfsSettings.replayDir}/(([^/]+)${I.escape(W.Replay.extension)})|(${I.escape(G.ReplayStorageFileSystem.manifestFileName)})$`,"i"),new RegExp(`^/${U.Engine.rfsSettings.tauntsDir}/tau([^/]+)\\.wav$`,"i"),new RegExp(`^/${U.Engine.rfsSettings.modDir}/[^/]+/`,"i"),new RegExp(`^/${U.Engine.rfsSettings.mapDir}/[^/]+\\.(${[...new Set([...U.Engine.supportedMapTypes.values()].flat())].join("|")})$`,"i")],J=["/keyboard.ini",/^\/[^/]+\.mix$/i,new RegExp(`^/${U.Engine.rfsSettings.musicDir}/`,"i"),new RegExp(`^/${U.Engine.rfsSettings.tauntsDir}/`,"i")],ee=[/^\/([^/]+)\.mix$/i,"/"+U.Engine.rfsSettings.menuVideoFileName,"/"+U.Engine.rfsSettings.splashImgFileName,"/"+U.Engine.rfsSettings.musicDir,"/"+U.Engine.rfsSettings.tauntsDir,"/"+U.Engine.rfsSettings.replayDir+"/"+G.ReplayStorageFileSystem.manifestFileName],te=["/","/"+U.Engine.rfsSettings.replayDir,new RegExp(`^/${U.Engine.rfsSettings.modDir}(/.*)?`),new RegExp(`^/${U.Engine.rfsSettings.mapDir}(/.*)?`)],re=[U.Engine.rfsSettings.modDir],(P=se=se||{})[P.None=0]="None",P[P.OverwriteAll=1]="OverwriteAll",P[P.SkipAll=2]="SkipAll",g("StorageExplorer",({messageBoxApi:g,storageDirHandle:P,startIn:I,strings:U,onFileSystemChange:G})=>{const W=z.useRef(null);return z.useEffect(()=>{let z,te,ae=!1,ne=se.None,oe=0,le=!1;const m=async()=>{var g,P,I;z&&navigator.storage?.estimate&&(({usage:g,quota:P}=await navigator.storage.estimate()),g&&P&&(I=U.get("GUI:StorageUsed",z.GetDisplayFilesize(g),z.GetDisplayFilesize(P)),z.SetNamedStatusBarText("quota",P<=g?"<font color='red'>"+I+"</font>":I)))},r=async(g,I)=>{if(re.includes(I.GetPathIDs().pop())){let _=prompt(U.get("GUI:NewFolderPrompt"));if(_?.match(V.ModManager.modIdRegex)){try{let G=await Z(I.GetPathIDs(),P);if(await new L.RealFileSystemDir(G).containsEntry(_))return void g(U.get("GUI:NewFolderExists"));_=(await G.getDirectoryHandle(_,{create:!0})).name}catch(P){return console.error(P),void g(!1)}g({type:"folder",name:_,id:_,hash:_})}else g(U.get("GUI:NewFolderInvalidName"))}else g(U.get("GUI:NewFolderNotAllowed"))},s=async(I,L,_)=>{let V=[],W=[];var K,q=_.length;for(K of _){let g=[...L.GetPathIDs(),K].join("/");(ee.some(P=>"string"==typeof P?g.toLowerCase()===P.toLowerCase():P.test(g))?V:W).push(g)}if(!W.length||await g.confirm(1===q?U.get("GUI:ConfirmDeleteFile"):U.get("GUI:ConfirmDeleteFiles",q),U.get("GUI:Yes"),U.get("GUI:No"))){if(V.length)for(var $ of V)await g.confirm(U.get("GUI:ConfirmDeleteSystemFile",$),U.get("GUI:Yes"),U.get("GUI:No"))&&W.push($);if(W.length){let g;try{for(var Q of W){console.log(`Deleting "${Q}"...`);var Y=Q.substring(0,Q.lastIndexOf("/")).split("/");let g=await Z(Y,P);await g.removeEntry(Q.split("/").pop(),{recursive:!0}),console.log(`Deleted "${Q}".`)}}catch(I){console.error(I),g=I}I(!!g&&g.message),z?.RefreshFolders(!0),le||(le=!0,G())}else I(!1)}else I(!1)},a=async(I,_)=>{let V=_.folder.GetPathIDs().join("/")+_.fullPath,W=V.substring(0,V.lastIndexOf("/")).split("/"),K=!1;te&&(clearTimeout(te),te=void 0),oe++;let q,$=!1;try{if(X.some(g=>"string"==typeof g?V.toLowerCase()===g.toLowerCase():g.test(V))){for await(var Q of(q=await Z(W,P,!0),q.keys()))if(Q.toLowerCase()===_.file.name.toLowerCase()){var Y;ne===se.None?(2===(Y=await new Promise(P=>{g.show(U.get("GUI:ConfirmOverwriteFile",W.join("/")||"/",_.file.name),[{label:U.get("GUI:Yes"),onClick:()=>P(1)},{label:U.get("GUI:YesToAll"),onClick:()=>P(2)},{label:U.get("GUI:No"),onClick:()=>P(0)},{label:U.get("GUI:Cancel"),onClick:()=>P(-1)}])}))?ne=se.OverwriteAll:-1===Y&&(ne=se.SkipAll),Y<=0&&($=!0)):ne===se.SkipAll&&($=!0);break}}else $=!0;if($)console.log("File skipped: "+V);else{console.log("Uploading file: "+V),z?.SetNamedStatusBarText("message",U.get("GUI:Uploading",V));let g=_.file.name;J.some(g=>"string"==typeof g?V.toLowerCase()===g.toLowerCase():g.test(V))&&(g=g.toLowerCase()),await new L.RealFileSystemDir(q).writeFile(_.file,g),K=!0,console.log("File uploaded: "+V)}}catch(I){console.error(I);var ee="QuotaExceededError"===I.name?U.get("GUI:UploadFailedQuota"):U.get("GUI:UploadFailed");z?.SetNamedStatusBarText("message","<font color='red'>"+ee+"</font>",1e4)}oe--,oe||(te=setTimeout(()=>{ne=se.None,z?.SetNamedStatusBarText("message",U.get("GUI:UploadFinished"),2e3)},1e3)),I(!1),z&&K&&(z.RefreshFolders(!0),await m(),le||(le=!0,G()))},n=(I,L,G,V)=>{1!==V.length||"file"!==V[0].type?(async()=>{let I=await SystemJS.import("file-system-access"),G=await I.showSaveFilePicker({suggestedName:"cdexport.zip"}),W=await Z(L.GetPathIDs(),P),K=new _.Zip;const s=async(g,P,I)=>{for await(var L of g.values())"directory"===L.kind?await s(L,P+"/"+L.name,I):await I(await L.getFile(),P+"/"+L.name)};let q=new AbortController,Q=z.CreateProgressTracker(()=>{try{q.abort()}catch(g){}});Q.queueditems=V.length,Q.showbyterate=!0;const o=async(g,P)=>{K.startFile(P,g.lastModified);const I=g.stream().getReader();for(;;){var{done:L,value:_}=await I.read();if(L)break;K.appendData(_),await $.sleep(0)}K.endFile(),Q.totalbytes+=g.size};var Y=setTimeout(()=>{g.show(U.get("GUI:CreatingArchive"),U.get("GUI:Cancel"),()=>{try{Q.cancelcallback()}catch(g){console.error(g)}})},1e3);try{await Promise.all([(async()=>{for(var{id:g,type:P}of V){if("folder"===P){var I=await W.getDirectoryHandle(g);await s(I,g,async(g,P)=>{await o(g,P)})}else{let P=await W.getFileHandle(g);I=await P.getFile(),await o(I,g)}Q.itemsdone++}K.finish()})(),(async()=>{var g=await G.createWritable();await K.outputStream.pipeTo(g,{signal:q.signal})})()]),console.log("ZIP file saved successfully."),z?.RemoveProgressTracker(Q,U.get("GUI:DownloadFinished"))}catch(I){clearTimeout(Y),"AbortError"!==I.name?(console.error(I),z?.RemoveProgressTracker(Q,U.get("GUI:DownloadFailed")),await g.alert(U.get("GUI:DownloadFailed"),U.get("GUI:OK"))):z?.RemoveProgressTracker(Q,U.get("GUI:DownloadAborted"))}finally{clearTimeout(Y),g.destroy()}})().catch(g=>{"AbortError"!==g.name&&console.error(g)}):z.OpenSelectedItems()},o=(g,I)=>{(async()=>{let L=await Z(g.GetPathIDs(),P),_=await L.getFileHandle(I.id);var U=await _.getFile();let G=await SystemJS.import("file-system-access"),V=await G.showSaveFilePicker({suggestedName:U.name}),W=await V.createWritable();try{await W.write(U),await W.close()}catch(L){throw await W.abort(),L}})().catch(g=>{"AbortError"!==g.name&&console.error(g)})},l=(g,I)=>{(async()=>{var I=await Z(g.GetPathIDs(),P);I=await Y(I,g.GetPathIDs().join("/"));z?.IsDestroyed()||g.SetEntries(I)})().catch(g=>{console.error(g)})};return(async()=>{g.show(U.get("GUI:LoadingEx"));try{if(await Promise.all([new q.ScriptLoader(document).load("lib/file-explorer/file-explorer.js"),new K.CssLoader(document).load("lib/file-explorer/file-explorer.css")]),ae)return;let g=[["","/",{canmodify:Q("/")}]];if(I){let L="";for(var P of I.split("/"))L+="/"+P,g.push([P,P,{canmodify:Q(L)}])}z=new window.FileExplorer(W.current,{initpath:g,onrefresh:l,onopenfile:o,concurrentuploads:1,oninitupload:a,oninitdownload:n,onnewfolder:r,ondelete:s}),await m()}finally{g.destroy()}})().catch(g=>console.error(g)),()=>{ae=!0,z?.Destroy(),z=void 0,te&&clearTimeout(te)}},[]),z.default.createElement("div",{ref:W,className:"storage-explorer"})})}}}),System.register("gui/screen/options/GeneralOptions",["engine/renderable/entity/unit/FlyerHelperMode","util/Base64","util/BoxedVar","gui/screen/options/GraphicsOptions"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("SCROLL_BASE_FACTOR",3),g("GeneralOptions",class{constructor(){this.scrollRate=new _.BoxedVar(12),this.flyerHelper=new _.BoxedVar(I.FlyerHelperMode.Selected),this.hiddenObjects=new _.BoxedVar(!0),this.targetLines=new _.BoxedVar(!0),this.rightClickMove=new _.BoxedVar(!1),this.rightClickScroll=new _.BoxedVar(!0),this.mouseAcceleration=new _.BoxedVar(!0),this.graphics=new U.GraphicsOptions}unserialize(g){var[P,I,_,U,G,V,W,z]=g.split(",");return this.scrollRate.value=Number(P),void 0!==I&&(this.flyerHelper.value=Number(I)),void 0!==_&&this.graphics.unserialize(L.Base64.decode(_)),void 0!==U&&(this.hiddenObjects.value=Boolean(Number(U))),void 0!==G&&(this.rightClickMove.value=Boolean(Number(G))),void 0!==V&&(this.rightClickScroll.value=Boolean(Number(V))),void 0!==W&&(this.targetLines.value=Boolean(Number(W))),void 0!==z&&(this.mouseAcceleration.value=Boolean(Number(z))),this}serialize(){return[this.scrollRate.value,this.flyerHelper.value,L.Base64.encode(this.graphics.serialize()),Number(this.hiddenObjects.value),Number(this.rightClickMove.value),Number(this.rightClickScroll.value),Number(this.targetLines.value),Number(this.mouseAcceleration.value)].join(",")}})}}}),System.register("gui/screen/options/GraphicsOptions",["engine/renderable/entity/unit/ModelQuality","engine/renderable/entity/unit/ShadowQuality","util/BoxedVar"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("GraphicsOptions",class{constructor(){this.resolution=new _.BoxedVar(void 0),this.models=new _.BoxedVar(I.ModelQuality.High),this.shadows=new _.BoxedVar(L.ShadowQuality.High)}unserialize(g){let[P,I,L]=g.split(",");var _;return this.models.value=Number(P),this.shadows.value=Number(I),void 0!==L&&(_=L.length?L.split("x").map(g=>Number(g)):void 0,this.resolution.value=_?{width:_[0],height:_[1]}:void 0),this}serialize(){return[this.models.value,this.shadows.value,this.resolution.value?[this.resolution.value.width,this.resolution.value.height].join("x"):""].join(",")}applyLowPreset(){this.models.value=I.ModelQuality.Low,this.shadows.value=L.ShadowQuality.Low}applyHighPreset(){this.models.value=I.ModelQuality.High,this.shadows.value=L.ShadowQuality.High}})}}}),System.register("gui/screen/options/KeyboardScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/options/component/KeyOpts"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("KeyboardScreen",class{constructor(g,P,I){this.strings=g,this.jsxRenderer=P,this.keyBinds=I,this.title=this.strings.get("GUI:KeyboardOptions")}setController(g){this.controller=g}onEnter(){this.isDirty=!1,this.controller.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons();var[g]=this.jsxRenderer.render(I.jsx(L.HtmlView,{width:"100%",height:"100%",component:_.KeyOpts,props:{keyBinds:this.keyBinds,strings:this.strings,onHotKeyChange:(g,P)=>{this.keyBinds.changeHotKey(g,P),this.isDirty=!0},onResetAll:async()=>{try{await this.keyBinds.resetAndReload()}catch(g){console.error(g)}}}}));this.controller.setMainComponent(g)}async onLeave(){if(await this.controller.hideSidebarButtons(),this.isDirty){this.isDirty=!1;try{await this.keyBinds.save()}catch(g){console.error(g)}}}})}}}),System.register("gui/screen/options/OptionsScreen",["gui/jsx/jsx","gui/screen/mainMenu/MainMenuController","gui/screen/game/gameMenu/GameMenuController","gui/screen/game/gameMenu/ScreenType","gui/screen/mainMenu/ScreenType","LocalPrefs","gui/jsx/HtmlView","gui/screen/options/component/GeneralOpts"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g}],execute:function(){g("OptionsScreen",class{constructor(g,P,I,L,_,U,G){this.strings=g,this.jsxRenderer=P,this.options=I,this.localPrefs=L,this.fullScreen=_,this.inGame=U,this.storageOptsEnabled=G,this.title=this.strings.get("GUI:Options")}setController(g){this.controller=g}onEnter(){this.initialOptionsStr=this.options.serialize(),this.controller instanceof L.MainMenuController&&this.controller.toggleMainVideo(!1),this.controller.setSidebarButtons([{label:this.strings.get("GUI:Sound"),onClick:()=>{this.controller instanceof _.GameMenuController?this.controller.pushScreen(U.ScreenType.OptionsSound):this.controller?.pushScreen(G.ScreenType.OptionsSound)}},{label:this.strings.get("GUI:Keyboard"),onClick:()=>{this.controller instanceof _.GameMenuController?this.controller.pushScreen(U.ScreenType.OptionsKeyboard):this.controller?.pushScreen(G.ScreenType.OptionsKeyboard)}},...this.controller instanceof L.MainMenuController&&this.storageOptsEnabled?[{label:this.strings.get("GUI:Storage"),onClick:()=>{this.controller.pushScreen(G.ScreenType.OptionsStorage,{})}}]:[],{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons();var[g]=this.jsxRenderer.render(I.jsx(W.HtmlView,{width:"100%",height:"100%",component:z.GeneralOpts,props:{options:this.options,fullScreen:this.fullScreen,strings:this.strings,inGame:this.inGame,localPrefs:this.localPrefs}}));this.controller.setMainComponent(g)}async onLeave(){var g=this.options.serialize();g!==this.initialOptionsStr&&this.localPrefs.setItem(V.StorageKey.Options,g),await this.controller.hideSidebarButtons()}async onStack(){await this.onLeave()}onUnstack(){this.onEnter()}})}}}),System.register("gui/screen/options/SoundOptsScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/options/component/SoundOpts","LocalPrefs"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("SoundOptsScreen",class{constructor(g,P,I,L,_){this.strings=g,this.jsxRenderer=P,this.mixer=I,this.music=L,this.localPrefs=_,this.title=this.strings.get("GUI:Sound")}setController(g){this.controller=g}onEnter(){this.initialSettings=this.mixer.serialize(),this.controller.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons();var[g]=this.jsxRenderer.render(I.jsx(L.HtmlView,{width:"100%",height:"100%",component:_.SoundOpts,props:{mixer:this.mixer,music:this.music,strings:this.strings}}));this.controller.setMainComponent(g)}async onLeave(){var g=this.mixer.serialize();g!==this.initialSettings&&this.localPrefs.setItem(U.StorageKey.Mixer,g),this.music&&(g=this.music.serializeOptions(),this.localPrefs.setItem(U.StorageKey.MusicOpts,g)),await this.controller.hideSidebarButtons()}})}}}),System.register("gui/screen/options/StorageScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/options/component/StorageExplorer","gui/screen/mainMenu/MainMenuScreen"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=class extends U.MainMenuScreen{constructor(g,P,I,L){super(),this.strings=g,this.jsxRenderer=P,this.messageBoxApi=I,this.rfs=L,this.title=this.strings.get("GUI:Storage")}onEnter(g){this.controller.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons();var[P]=this.jsxRenderer.render(I.jsx(L.HtmlView,{width:"100%",height:"100%",component:_.StorageExplorer,props:{strings:this.strings,messageBoxApi:this.messageBoxApi,storageDirHandle:this.rfs.getRootDirectoryHandle(),startIn:g?.startIn,onFileSystemChange:()=>{this.controller?.setSidebarButtons([{label:this.strings.get("GUI:ExitAndReload"),isBottom:!0,onClick:()=>{location.reload()}}])}}}));this.controller.setMainComponent(P)}async onLeave(){await this.controller.hideSidebarButtons()}},g("StorageScreen",G)}}}),System.register("gui/screen/replay/KeepReplayBox",["react","gui/component/Dialog","network/gamestate/Replay"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("KeepReplayBox",({defaultName:g,strings:P,viewport:U,onSubmit:G,onDismiss:V})=>{let W=I.useRef(null),[z,K]=I.useState(!1);I.useEffect(()=>{setTimeout(()=>{W.current?.focus(),W.current?.setSelectionRange(0,W.current.value.length)},50)},[]);var l=g=>{g&&g.preventDefault();var P=W.current.value;P&&(K(!0),G(P))};return I.default.createElement(L.Dialog,{className:"keep-replay-box",hidden:z,viewport:U,zIndex:100,buttons:[{label:P.get("GUI:Ok"),onClick:l},{label:P.get("GUI:Cancel"),onClick:()=>{K(!0),V?.()}}]},I.default.createElement("form",{onSubmit:l},I.default.createElement("div",{className:"field"},I.default.createElement("label",null,P.get("GUI:ReplayNamePrompt")),I.default.createElement("input",{type:"text",name:"replayname",autoComplete:"off",ref:W,defaultValue:g,maxLength:_.Replay.maxNameLength})),I.default.createElement("button",{type:"submit",style:{visibility:"hidden"}})))})}}}),System.register("gui/screen/replay/ReplayDetailsPane",["react","util/format"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("ReplayDetailsPane",({replayDetails:{engineVersion:g,durationSeconds:P,gameId:_,gameTimestamp:U,mapName:G,players:V},strings:W})=>I.createElement("div",{className:"replay-details"},I.createElement("table",null,I.createElement("tbody",null,U?I.createElement("tr",null,I.createElement("td",null,W.get("GUI:ReplayTime"),":"),I.createElement("td",{dir:"auto"},new Date(U*(String(U).length<13?1e3:1)).toLocaleString())):null,I.createElement("tr",null,I.createElement("td",null,W.get("GUI:GameVersion"),":"),I.createElement("td",null,g)),"0"!==_?I.createElement("tr",null,I.createElement("td",null,W.get("GUI:GameID"),":"),I.createElement("td",null,_)):null,void 0!==G&&I.createElement("tr",null,I.createElement("td",null,W.get("GUI:Map"),":"),I.createElement("td",null,G)),V&&I.createElement("tr",null,I.createElement("td",null,W.get("GUI:Players"),":"),I.createElement("td",null,V.map((g,P)=>I.createElement(I.Fragment,{key:g.name},P?", ":"",I.createElement("span",{style:{color:g.color}},g.name))))),void 0!==P&&I.createElement("tr",null,I.createElement("td",null,W.get("GUI:Duration"),":"),I.createElement("td",null,L.formatTimeDuration(P)))))))}}}),System.register("gui/screen/replay/ReplayScreen",["engine/Engine","gui/screen/game/component/hud/viewmodel/SidebarModel","tools/DevToolsApi","engine/GameAnimationLoop","util/disposable/CompositeDisposable","gui/screen/game/SoundHandler","gui/screen/game/worldInteraction/WorldInteractionFactory","gui/screen/game/ObserverUi","gui/screen/game/GameMenu","gui/screen/game/WorldView","engine/sound/Eva","engine/sound/EvaSpecs","gui/screen/game/HudFactory","gui/screen/game/component/Minimap","game/SideType","network/gamestate/ReplayTurnManager","game/action/ActionFactory","game/action/ActionFactoryReg","gui/screen/game/component/hud/viewmodel/MessageList","engine/sound/Music","network/gamestate/replay/ChatMessageReplayEvent","engine/sound/SoundKey","engine/sound/ChannelType","network/gamestate/replay/TauntReplayEvent","gui/screen/game/TauntPlayback","gui/screen/game/component/hud/commandBar/CommandBarButtonType","util/userAgent","gui/screen/RootScreen","gui/screen/game/loadingScreen/LoadingScreenApiFactory","data/MapFile","engine/ResourceLoader","engine/MapDigest","gui/chat/ChatHistory"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g},function(g){ce=g},function(g){he=g},function(g){ue=g},function(g){de=g},function(g){ge=g},function(g){pe=g},function(g){me=g},function(g){fe=g},function(g){ye=g}],execute:function(){Te=class extends de.RootScreen{constructor(g,P,I,L,_,U,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce,he){super(),this.engineVersion=g,this.engineModHash=P,this.errorHandler=I,this.gameMenuSubScreens=L,this.loadingScreenApiFactory=_,this.config=U,this.strings=V,this.renderer=W,this.uiScene=z,this.runtimeVars=K,this.messageBoxApi=q,this.uiAnimationLoop=$,this.viewport=Q,this.jsxRenderer=Y,this.pointer=Z,this.sound=X,this.music=J,this.keyBinds=ee,this.generalOptions=te,this.actionLogger=re,this.fullScreen=se,this.mapFileLoader=ae,this.gameLoader=ne,this.vxlGeometryPool=oe,this.buildingImageDataCache=le,this.leaveAction=ce,this.battleControlApi=he,this.preventUnload=!0,this.disposables=new G.CompositeDisposable}async onEnter(g){this.params=g,this.disposables.add(()=>this.params=void 0),this.pointer.lock(),this.pointer.setVisible(!1),this.music?.play(se.MusicType.Loading).catch(g=>console.warn("Failed to play replay loading music",g));var{gameId:P,gameTimestamp:U,gameOpts:G,engineVersion:V,modHash:W}=g.replay;let z;if(V!==this.engineVersion?z=this.strings.get("GUI:ReplayVersionMismatch",V):W!==this.engineModHash&&(z=this.strings.get("GUI:ReplayModMismatch")),z)this.messageBoxApi.show(z,this.strings.get("GUI:Ok"),()=>{this.leaveAction()});else{let Q;V=this.loadingScreenApiFactory.create(ge.LoadingScreenType.Replay),this.loadingScreenApi=V,this.disposables.add(V,()=>this.loadingScreenApi=void 0),W=G.mapName;try{var K=await this.mapFileLoader.load(W);if(fe.MapDigest.compute(K)!==G.mapDigest)return void this.handleError("Map digest mismatch",this.strings.get("TS:MapMismatch",W));var $=new pe.MapFile(K);Q=await this.gameLoader.load(P,U,G,$,void 0,1===G.humanPlayers.length,V)}catch(z){let g;return z.message?.match(/memory|allocation/i)?g=this.strings.get("TS:GameInitOom"):z instanceof me.DownloadError?g=this.strings.get("TS:MapNotFound",W):(g=this.strings.get("TS:GameInitError"),G.mapOfficial||(g+="\n\n"+this.strings.get("TS:CustomMapCrash"))),void this.handleError(z,g)}let{game:X,theater:se,hudSide:ne,cameoFilenames:oe}=Q;this.game=X,this.baseSpeed=this.game.speed.value,this.disposables.add(()=>this.game=void 0),this.disposables.add(()=>{I.Engine.unloadTheater(se.type),this.gameLoader.clearStaticCaches()}),this.disposables.add(X),V=new L.SidebarModel(X,g.replay);let ue=new re.MessageList(X.rules.audioVisual.messageDuration,6,void 0);W=new ye.ChatHistory,this.sidebarModel=V,this.disposables.add(()=>this.sidebarModel=void 0),this.messageList=ue,this.disposables.add(()=>this.messageList=void 0),G=[he.CommandBarButtonType.ReplayRewind,he.CommandBarButtonType.ReplayPlay,he.CommandBarButtonType.ReplayPause,he.CommandBarButtonType.ReplaySpeed],this.hudFactory=new Y.HudFactory(ne,this.uiScene,V,ue,W,X.debugText,this.runtimeVars.debugText,void 0,X.getCombatants(),X.stalemateDetectTrait,X.countdownTimer,oe,this.jsxRenderer,this.strings,G),this.disposables.add(()=>this.hudFactory=void 0);let de=this.hudFactory.create();this.hud=de;let Te=this.minimap=new Z.Minimap(X,void 0,de.getTextColor(),X.rules.general.radar);de.setMinimap(Te),this.disposables.add(Te,()=>this.minimap=void 0),Te.setPointerEvents(this.pointer.pointerEvents),G={width:de.sidebarWidth,height:de.actionBarHeight};let ve=new q.WorldView(G,X,this.sound,this.renderer,this.runtimeVars,Te,this.strings,this.generalOptions,this.vxlGeometryPool,this.buildingImageDataCache),{worldScene:be,worldSound:Se,renderableManager:we}=ve.init(void 0,this.viewport.value,se);this.worldView=ve,this.disposables.add(ve,()=>this.worldView=void 0),be.create3DObject(),G=new ee.ActionFactory,(new te.ActionFactoryReg).register(G,X,void 0);let Ee=this.gameTurnMgr=new J.ReplayTurnManager(X,g.replay,G,this.actionLogger);this.gameTurnMgr.init();let Ce=new ce.TauntPlayback(this.sound.audioSystem,I.Engine.getTaunts());const w=g=>{if(g instanceof ae.ChatMessageReplayEvent){var P=g.payload;let L=X.getPlayer(P.playerId);var I=this.strings.get("TS:ReplayChatFrom",L.name)+" "+P.message;P=L.color.asHexString();ue.addChatMessage(I,P)}else g instanceof le.TauntReplayEvent&&(I=g.payload,P=X.getPlayer(I.playerId),I=I.tauntNo,Ce.playTaunt(P,I).catch(g=>console.error(g)))};Ee.onReplayEvent.subscribe(w),this.disposables.add(()=>Ee.onReplayEvent.unsubscribe(w)),this.onGameStart(X,Te,ue,be,Se,we),_.DevToolsApi.registerCommand("reset",async()=>{await this.onLeave(),await this.onEnter(g)}),_.DevToolsApi.registerVar("speed",X.desiredSpeed),this.disposables.add(()=>_.DevToolsApi.unregisterCommand("reset"),()=>_.DevToolsApi.unregisterVar("speed"))}}onViewportChange(){this.loadingScreenApi?.updateViewport(),this.rerenderHud()}rerenderHud(){if(this.hud){this.uiScene.remove(this.hud),this.hud.destroy(),this.hudFactory.setSidebarModel(this.sidebarModel);let g=this.hudFactory.create();this.hud=g,g.setMinimap(this.minimap),this.worldView&&(this.uiScene.add(g),this.menu?.handleHudChange(g),this.worldView.handleViewportChange(this.viewport.value),this.playerUi?.handleHudChange(g),this.initHudEvents(g,this.messageList))}}onGameStart(g,P,L,_,G,V){this.loadingScreenApi?.dispose(),this.music?.play(se.MusicType.Normal);var W=new Q.EvaSpecs(X.SideType.GDI).readIni(I.Engine.getIni(I.Engine.getFileNameVariant("eva.ini")));let z=new $.Eva(W,this.sound,this.renderer);z.init(),this.disposables.add(z);try{this.initUi(g,_,G,z,V,P,L)}catch(P){return W=P.message?.match(/memory|allocation/i)?this.strings.get("TS:GameInitOom"):this.strings.get("TS:GameInitError"),void this.handleError(P,W)}this.renderer.removeScene(this.uiScene),this.renderer.addScene(_),this.renderer.addScene(this.uiScene),this.pointer.setVisible(!0),g.start(),this.gameAnimationLoop=new U.GameAnimationLoop(void 0,this.renderer,this.sound,this.gameTurnMgr,{skipFrames:!0,skipBudgetMillis:8,onError:this.config.devMode?void 0:(P,I)=>this.handleError(P,this.strings.get("TS:GameCrashed")+(I||g.gameOpts.mapOfficial?"":"\n\n"+this.strings.get("TS:CustomMapCrash")),I)}),this.uiAnimationLoop.stop(),this.gameAnimationLoop.start()}initUi(g,P,I,L,_,U,G){let q=new V.SoundHandler(g,I,L,this.sound,g.events,G,this.strings,void 0);if(q.init(),this.disposables.add(q),G.onNewMessage.subscribe(g=>{g.animate&&this.sound.play(ne.SoundKey.IncomingMessage,oe.ChannelType.Ui)}),ue.isIpad()){let e=g=>{this.sidebarModel.topTextLeftAlign=g};this.fullScreen.onChange.subscribe(e),this.disposables.add(()=>this.fullScreen.onChange.unsubscribe(e))}this.uiScene.add(this.hud),this.initHudEvents(this.hud,G);let $=this.menu=new K.GameMenu(this.gameMenuSubScreens,g,void 0,void 0,void 0,!0);$.init(this.hud),this.initGameMenuEvents($),this.disposables.add($,()=>this.menu=void 0);var Q=g.getUnitSelection(),Y=this.runtimeVars.freeCamera,Z=this.runtimeVars.debugPaths,X=this.runtimeVars.debugText,J=this.config.devMode;J=new W.WorldInteractionFactory(void 0,g,Q,_,this.uiScene,P,this.pointer,this.renderer,this.keyBinds,this.generalOptions,Y,Z,J,document,U,this.strings,this.hud.getTextColor(),X,this.battleControlApi),X=this.config.discordUrl;(this.playerUi=new z.ObserverUi(g,void 0,this.sidebarModel,this.params.replay,this.renderer,P,this.sound,J,$,this.runtimeVars,this.strings,_,this.messageBoxApi,X)).onPlayerChange.subscribe(({player:g,sidebarModel:P})=>{this.sidebarModel=P,this.rerenderHud(),this.worldView?.changeLocalPlayer(g),this.minimap.changeLocalPlayer(g)}),this.playerUi.init(this.hud),this.disposables.add(this.playerUi,()=>this.playerUi=void 0)}initGameMenuEvents(g){g.onOpen.subscribe(()=>{this.pointer.unlock(),this.playerUi.worldInteraction.setEnabled(!1)}),g.onQuit.subscribe(async()=>{this.playerUi.dispose(),this.gameTurnMgr.dispose(),this.leaveAction()}),g.onCancel.subscribe(()=>{this.pointer.lock(),this.playerUi.worldInteraction.setEnabled(!0)})}initHudEvents(g,P){g.onCommandBarButtonClick.subscribe(g=>{switch(this.sound.play(ne.SoundKey.GenericClick,oe.ChannelType.Ui),g){case he.CommandBarButtonType.ReplayRewind:(async()=>{var g=this.params;await this.onLeave(),await this.onEnter(g)})().catch(g=>console.error(g));break;case he.CommandBarButtonType.ReplayPlay:this.game.desiredSpeed.value=this.baseSpeed,this.game.speed.value===Number.EPSILON?this.gameTurnMgr.doGameTurn(performance.now()):this.game.speed.value!==this.baseSpeed&&P.addSystemMessage(this.strings.get("TS:ReplaySpeedConfirm","1x"),"grey");break;case he.CommandBarButtonType.ReplayPause:this.game.desiredSpeed.value=Number.EPSILON;break;case he.CommandBarButtonType.ReplaySpeed:{this.game.speed.value===Number.EPSILON&&(this.game.desiredSpeed.value=this.baseSpeed,this.gameTurnMgr.doGameTurn(performance.now()));let g=Math.floor(this.game.desiredSpeed.value/this.baseSpeed);g=16===g?1:2*g,this.game.desiredSpeed.value=g*this.baseSpeed,P.addSystemMessage(this.strings.get("TS:ReplaySpeedConfirm",g+"x"),"grey");break}default:console.warn("Unhandled command type "+g)}})}async onLeave(){this.pointer.unlock(),this.gameAnimationLoop&&(this.gameAnimationLoop.destroy(),this.gameAnimationLoop=void 0,this.uiAnimationLoop.start()),this.hud&&(this.uiScene.remove(this.hud),this.hud.destroy(),this.hud=void 0),this.gameTurnMgr?.dispose(),this.gameTurnMgr=void 0,this.disposables.dispose()}handleError(g,P,I){this.gameTurnMgr&&this.gameTurnMgr.setErrorState(),this.pointer.unlock(),this.errorHandler.handle(g,P,I?void 0:()=>{this.leaveAction()}),I&&this.playerUi?.dispose()}},g("ReplayScreen",Te)}}}),System.register("gui/screen/replay/ReplaySel",["react","gui/component/List","gui/screen/replay/StorageWarning","gui/screen/replay/ReplayDetailsPane"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("ReplaySel",({strings:g,replays:P,selectedReplay:G,selectedReplayDetails:V,onSelectReplay:W})=>{const z=I.useRef(null);return I.useEffect(()=>{z.current?.scrollIntoView()},[]),I.default.createElement("div",{className:"replay-sel-form"},I.default.createElement(L.List,{title:g.get("GUI:SelectReplay"),className:"replay-list"},P?P.map(g=>{var P=g.id===G?.id;return I.default.createElement(L.ListItem,{key:g.id,selected:P,innerRef:P?z:null,onClick:()=>W(g),onDoubleClick:()=>W(g,!0),style:{display:"flex"}},I.default.createElement("div",{className:"replay-name"},g.keep?"":"* ",g.name),I.default.createElement("div",{className:"replay-time",dir:"auto"},new Date(g.timestamp).toLocaleString()))}):I.default.createElement(L.ListItem,{style:{textAlign:"center"}},g.get("GUI:LoadingEx"))),V&&I.default.createElement(U.ReplayDetailsPane,{replayDetails:V,strings:g}),I.default.createElement(_.StorageWarning,{strings:g}))})}}}),System.register("gui/screen/replay/ReplaySelScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/replay/ReplaySel","network/gamestate/Replay","gui/screen/ScreenType","gui/screen/replay/KeepReplayBox","util/disposable/CompositeDisposable","gui/replay/ReplayStorageError","engine/ResourceLoader","data/vfs/StorageQuotaError","@puzzl/core/lib/async/Task","network/gameopt/Parser","game/GameSpeed","gui/replay/ReplayExistsError","gui/screen/mainMenu/MainMenuScreen","@puzzl/core/lib/async/cancellation","data/vfs/IOError","data/vfs/FileNotFoundError","RouteHelper","game/gameopts/GameOptRandomGen","game/gameopts/constants"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g}],execute:function(){ne=class extends X.MainMenuScreen{constructor(g,P,I,L,_,U,G,V,z,K,q,$,Q){super(),this.engineVersion=g,this.engineModHash=P,this.activeMod=I,this.oldClientsBaseUrl=L,this.rootController=_,this.strings=U,this.jsxRenderer=G,this.errorHandler=V,this.messageBoxApi=z,this.replayManager=K,this.uiScene=q,this.rules=$,this.sentry=Q,this.title=this.strings.get("GUI:Replays"),this.disposables=new W.CompositeDisposable,this.handleSelectReplay=(g,P)=>{var I=this.selectedReplay?.id!==g.id;this.selectedReplay=g,I&&this.updateSidebarButtons(),this.form.applyOptions(P=>{P.selectedReplay=g,P.selectedReplayDetails=void 0}),P?this.loadSelectedReplay():this.loadReplayDetails(g)}}async onEnter(){this.availableReplays=[],this.controller.toggleMainVideo(!1),this.initForm();try{this.availableReplays=await this.replayManager.loadList(!0)}catch(g){return g instanceof ee.IOError||g instanceof te.FileNotFoundError||g instanceof q.StorageQuotaError||this.sentry?.captureException(new Error(`Failed to load replay list (${g.name??g.message})`,{cause:g})),void this.handleError(g,this.strings.get("GUI:ReplayListError"))}this.selectedReplay=this.availableReplays[0],this.form.applyOptions(g=>{g.replays=this.availableReplays,g.selectedReplay=this.selectedReplay}),void 0!==this.selectedReplay&&this.loadReplayDetails(this.selectedReplay),this.initSidebar(),this.initFileInput()}initForm(){this.controller.setMainComponent(this.jsxRenderer.render(I.jsx(L.HtmlView,{innerRef:g=>this.form=g,component:_.ReplaySel,props:{strings:this.strings,replays:void 0,selectedReplay:void 0,selectedReplayDetails:void 0,onSelectReplay:this.handleSelectReplay}}))[0])}initFileInput(){let g=this.fileInput=document.createElement("input");g.setAttribute("type","file"),g.setAttribute("accept",U.Replay.extension),g.setAttribute("style","display: none"),document.body.appendChild(g);const t=async()=>{var g=this.fileInput.files?.[0];if(g)try{await this.replayManager.importReplay(g),this.availableReplays=await this.replayManager.loadList(),this.form.applyOptions(g=>g.replays=this.availableReplays)}catch(g){let P;P=g instanceof q.StorageQuotaError?this.strings.get("ts:storage_quota_exceeded"):g instanceof z.ReplayStorageError?this.strings.get("GUI:SaveReplayError"):this.strings.get("GUI:ImportReplayError"),this.errorHandler.handle(g,P,()=>{})}};g.addEventListener("change",t),this.disposables.add(()=>{this.fileInput&&document.body.removeChild(this.fileInput),this.fileInput.removeEventListener("change",t),this.fileInput=void 0})}initSidebar(){this.updateSidebarButtons(),this.controller.showSidebarButtons()}updateSidebarButtons(){let g=this.getSelectedReplayMeta();this.controller?.setSidebarButtons([{label:this.strings.get("GUI:LoadReplay"),disabled:!this.selectedReplay,onClick:()=>{this.loadSelectedReplay()}},{label:this.strings.get(g?.keep?"GUI:RenameReplay":"GUI:KeepReplay"),tooltip:g?.keep?void 0:this.strings.get("STT:KeepReplay"),disabled:!this.selectedReplay,onClick:()=>{this.showKeepReplayBox(g.name,P=>{this.replayManager.keepReplay(g.id,P).then(async()=>{this.availableReplays=await this.replayManager.loadList(),this.selectedReplay=this.getSelectedReplayMeta(),this.form.applyOptions(g=>g.replays=this.availableReplays),this.updateSidebarButtons()}).catch(g=>{let P;P=g instanceof Z.ReplayExistsError?this.strings.get("GUI:ReplayExistsError"):this.strings.get("GUI:SaveReplayError"),this.errorHandler.handle(g,P,()=>{})})})}},{label:this.strings.get("GUI:ImportReplay"),tooltip:this.strings.get("STT:ImportReplay"),onClick:()=>{if(void 0!==this.fileInput.click)this.fileInput.click();else{let g=document.createEvent("Event");g.initEvent("click",!0,!0),this.fileInput.dispatchEvent(g)}}},{label:this.strings.get("GUI:ExportReplay"),tooltip:this.strings.get("STT:ExportReplay"),disabled:!this.selectedReplay,onClick:()=>{this.exportCurrentReplay().catch(g=>this.errorHandler.handle(g,this.strings.get("GUI:ReplayError"),()=>{}))}},{label:this.strings.get("GUI:DeleteReplay"),disabled:!this.selectedReplay,onClick:async()=>{var g=this.getSelectedReplayMeta();if(await this.messageBoxApi.confirm(this.strings.get("GUI:ConfirmDeleteReplay",g.name),this.strings.get("GUI:Ok"),this.strings.get("GUI:Cancel"))){try{await this.replayManager.deleteReplay(g)}catch(P){return g=P instanceof q.StorageQuotaError?this.strings.get("ts:storage_quota_exceeded"):this.strings.get("GUI:DeleteReplayError"),void this.errorHandler.handle(P,g,()=>{})}this.selectedReplay=void 0,this.availableReplays=await this.replayManager.loadList(),this.form.applyOptions(g=>{g.replays=this.availableReplays,g.selectedReplay=void 0,g.selectedReplayDetails=void 0}),this.updateSidebarButtons()}}},{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.popScreen()}}])}async loadSelectedReplay(){var g=this.selectedReplay;let P;try{var I=await this.replayManager.loadSerializedReplay(g);P=await(new U.Replay).parseHeader(I)}catch(g){return void this.errorHandler.handle(g,this.strings.get("GUI:ReplayError"),()=>{})}if(P.engineVersion!==this.engineVersion){if(!this.clientVersions&&this.oldClientsBaseUrl){this.messageBoxApi.show(this.strings.get("GUI:LoadingEx"));try{let g=new K.ResourceLoader(this.oldClientsBaseUrl);this.clientVersions=await g.loadJson("versions.json")}catch(g){console.warn("Couldn't download client version list",g)}finally{this.messageBoxApi.destroy()}}let L;return this.clientVersions&&(L=this.clientVersions[P.engineVersion]),void(L?await this.messageBoxApi.confirm(this.strings.get("GUI:ReplayOpenOldClient",P.engineVersion),this.strings.get("TXT_CONTINUE"),this.strings.get("GUI:Close"))&&(I=this.activeMod?`?${re.RouteHelper.modQueryStringName}=`+this.activeMod:"",window.open(`${this.oldClientsBaseUrl}v${L}/${I}#/replay/`+g.id,"_blank")):this.messageBoxApi.show(this.strings.get("GUI:ReplayVersionMismatch",P.engineVersion),this.strings.get("GUI:Ok")))}if(P.modHash===this.engineModHash){let P;try{P=await this.replayManager.loadReplay(g)}catch(g){return void this.errorHandler.handle(g,this.strings.get("GUI:ReplayError"),()=>{})}this.rootController.goToScreen(G.ScreenType.Replay,{replay:P})}else this.messageBoxApi.show(this.strings.get("GUI:ReplayModMismatch"),this.strings.get("GUI:Ok"))}showKeepReplayBox(g,P){let[_]=this.jsxRenderer.render(I.jsx(L.HtmlView,{component:V.KeepReplayBox,props:{defaultName:g,strings:this.strings,onSubmit:g=>{P(g),_.destroy()},onDismiss:()=>{_.destroy()},viewport:this.uiScene.viewport}}));this.uiScene.add(_),this.disposables.add(_,()=>this.uiScene.remove(_))}async exportCurrentReplay(){var g=this.getSelectedReplayMeta();if(!g)throw new Error("No replay selected");var P=await this.replayManager.loadSerializedReplay(g);this.currentReplayUrl&&URL.revokeObjectURL(this.currentReplayUrl),P=URL.createObjectURL(new Blob([P],{type:"application/octet-stream"})),this.currentReplayUrl=P;let I=document.createElement("a");I.setAttribute("href",P),I.setAttribute("download",g.name+U.Replay.extension),document.body.appendChild(I),I.click(),document.body.removeChild(I)}getSelectedReplayMeta(){if(this.selectedReplay)return this.availableReplays.find(g=>g.id===this.selectedReplay.id)}async onLeave(){this.currentReplayUrl&&URL.revokeObjectURL(this.currentReplayUrl),this.clientVersions=void 0,this.availableReplays.length=0,this.form=void 0,this.messageBoxApi.destroy(),this.disposables.dispose(),this.replayDetailsTask?.cancel(),this.replayDetailsTask=void 0,this.controller.setMainComponent(),await this.controller.hideSidebarButtons()}loadReplayDetails(g){this.replayDetailsTask?.cancel(),this.replayDetailsTask=new $.Task(async P=>{let I=await this.replayManager.loadSerializedReplay(g);var L=await(new U.Replay).parseHeader(I);let _,G,V;if(P.throwIfCancelled(),L.engineVersion===this.engineVersion){let L=new U.Replay;L.unserialize("string"==typeof I?I:await I.text(),g),P.throwIfCancelled(),_=L.gameOpts,G=Math.floor(L.endTick/Y.GameSpeed.BASE_TICKS_PER_SECOND)}else try{_=(new Q.Parser).parseOptions(L.gameOptsSerialized)}catch(g){console.warn("Replay couldn't be parsed",g)}if(_){let g=se.GameOptRandomGen.factory(L.gameId,L.gameTimestamp).generateColors(_),P=this.getAvailablePlayerColors();V=_.humanPlayers.filter(g=>g.countryId!==ae.OBS_COUNTRY_ID).map(I=>({name:I.name,color:P[g.get(I)??I.colorId]}))}let W={gameId:L.gameId,gameTimestamp:L.gameTimestamp||void 0,engineVersion:L.engineVersion,durationSeconds:G,mapName:_?.mapTitle,players:V};this.form.applyOptions(g=>{g.selectedReplayDetails=W})}),this.replayDetailsTask.start().catch(g=>{g instanceof J.OperationCanceledError||console.error(g)})}getAvailablePlayerColors(){return[...this.rules.getMultiplayerColors().values()].map(g=>g.asHexString())}handleError(g,P){this.errorHandler.handle(g,P,()=>{this.rootController.goToScreen(G.ScreenType.MainMenuRoot)})}},g("ReplaySelScreen",ne)}}}),System.register("gui/screen/replay/StorageWarning",["react"],function(g,P){"use strict";var I;function s(g){return Math.ceil(g/1024/1024)}return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("StorageWarning",({strings:g})=>{const[P,L]=I.useState();return I.useEffect(()=>{navigator.storage?.estimate&&navigator.storage.estimate().then(g=>L(g)).catch(g=>console.warn("Couldn't get storage estimate",[g]))},[]),P?.quota&&P.usage&&P.quota-P.usage<1048576?I.default.createElement("div",{className:"storage-warning"},g.get("ts:storage_quota_warning",s(P.usage),s(P.quota))):null})}}}),System.register("gui/screen/RootController",["gui/screen/Controller","gui/screen/ScreenType"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends I.Controller{constructor(g){super(),this.serverRegions=g}async goToScreenBlocking(...g){var[P,I]=g;return super.goToScreenBlocking(P,I)}goToScreen(...g){var[P,I]=g;return super.goToScreen(P,I)}async pushScreen(...g){var[P,I]=g;return super.pushScreen(P,I)}createGame(g,P,I,_,U,G,V,W=!1,z=!1,K){if(!this.serverRegions)throw new Error("Server regions must be loaded first");let q="";if(!G){if(!I)throw new Error("Game server must be set for a multiplayer game");q=I}this.goToScreen(L.ScreenType.Game,{create:!0,gameId:g,timestamp:P,playerName:_,gameOpts:U,singlePlayer:G,tournament:V,mapTransfer:W,createPrivateGame:z,gservUrl:q,returnTo:K})}joinGame(g,P,I,_,U,G=!1,V){if(!this.serverRegions)throw new Error("Server regions must be loaded first");this.goToScreen(L.ScreenType.Game,{create:!1,gameId:g,timestamp:P,playerName:_,tournament:U,mapTransfer:G,gservUrl:I,returnTo:V})}},g("RootController",_)}}}),System.register("gui/screen/RootRoute",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("RootRoute",class{constructor(...g){var[P,I]=g;this.screenType=P,this.params=I}})}}}),System.register("gui/screen/RootScreen",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("RootScreen",class{constructor(){this.preventUnload=!1}setController(g){this.controller=g}})}}}),System.register("gui/screen/Screen",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("gui/screen/ScreenParamsMap",["gui/screen/ScreenType"],function(g,P){"use strict";return P&&P.id,{setters:[function(g){}],execute:function(){}}}),System.register("gui/screen/ScreenType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("ScreenType",I={}))[P.MainMenuRoot=0]="MainMenuRoot",P[P.Game=1]="Game",P[P.Replay=2]="Replay"}}}),System.register("gui/ShpSpriteBatch",["gui/UiObject","gui/HtmlContainer","data/ShpFile","engine/renderable/builder/BatchShpBuilder"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=class extends I.UiObject{constructor(g,P,I,_){super(new THREE.Object3D,new L.HtmlContainer),this.spriteProps=g,this.getShpFile=P,this.getPalette=I,this.camera=_,this.textureCache=new Map,this.batchShpBuilders=[]}create3DObject(){super.create3DObject();var g=this.createAggregatedShpFile();this.createObjects(this.get3DObject(),g)}createAggregatedShpFile(){let g=new _.ShpFile;g.filename="agg_unnamed_spritebatch.shp";let P=new Map,I=0;for(var L of this.spriteProps){L=("string"==typeof L.image?this.getShpFile(L.image):L.image).getImage(L.frame??0),P.has(L)||(g.addImage(L),P.set(L,I),I++)}return{file:g,imageIndexes:P}}createObjects(g,P){let L=new Map;for(var _ of this.spriteProps){var G=("string"==typeof _.palette?this.getPalette(_.palette):_.palette).hash;L.set(G,(L.get(G)??[]).concat(_))}for(var V of L.values()){var W,z="string"==typeof V[0].palette?this.getPalette(V[0].palette):V[0].palette;let L=[];for(W of V){let g="string"==typeof W.image?this.getShpFile(W.image):W.image;var K=P.imageIndexes.get(g.getImage(W.frame??0));if(void 0===K)throw new Error("Missing frame in aggregated sprite shp file");K={position:new THREE.Vector3(W.x??0,W.y??0,I.UiObject.zIndexToWorld(W.zIndex??0)),shpFile:g,depth:!1,flat:!1,frameNo:K,offset:{x:g.width/2,y:g.height/2}},L.push(K)}if(L.length){let I=new U.BatchShpBuilder(P.file,z,this.camera,this.textureCache,void 0,void 0,L.length);L.forEach(g=>I.add(g)),this.batchShpBuilders.push(I),g.add(I.build())}}}destroy(){super.destroy(),this.batchShpBuilders.forEach(g=>g.dispose()),[...this.textureCache.values()].forEach(g=>g.dispose()),this.textureCache.clear()}},g("ShpSpriteBatch",G)}}}),System.register("gui/UiObject",["engine/renderable/WithPosition","engine/gfx/RenderableContainer","util/event","engine/renderable/WithVisibility"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("UiObject",class n{get onFrame(){return this._onFrame.asEvent()}get onDispose(){return this._onDispose.asEvent()}static zIndexToWorld(g){return-g}constructor(g,P){this.rendered=!1,this.eventHandlers=[],this._onFrame=new _.EventDispatcher,this._onDispose=new _.EventDispatcher,g&&this.set3DObject(g),P&&this.setHtmlContainer(P),this.withPosition=new I.WithPosition,this.withVisibility=new U.WithVisibility,this.container=new L.RenderableContainer}get3DObject(){return this.target}set3DObject(g){(this.target=g).matrixAutoUpdate=!1}getRenderableContainer(){return this.container}getHtmlContainer(){return this.htmlContainer}setHtmlContainer(g){this.htmlContainer=g}setPosition(g,P){var I=this.withPosition.getPosition().z||0;this.withPosition.setPosition(g,P,I),this.htmlContainer?.setPosition(g,P)}getPosition(){var{x:g,y:P}=this.withPosition.getPosition();return{x:g,y:P}}setZIndex(g){var P=this.withPosition.getPosition();this.withPosition.setPosition(P.x,P.y,n.zIndexToWorld(g))}setVisible(g){this.withVisibility.setVisible(g),this.htmlContainer?.setVisible(g)}isVisible(){return this.withVisibility.isVisible()}setTooltip(g){this.tooltip=g,this.updateTooltip()}updateTooltip(){let g=this.get3DObject();g&&(g.userData.tooltip=this.tooltip)}setPointerEvents(g){if(this.pointerEvents)throw new Error("A PointerEvents instance is already set");this.pointerEvents=g}addEventListener(g,P){return this.eventHandlers.push({eventName:g,handler:P}),this.rendered&&this.setupEventListener(g,P),()=>this.removeEventListener(g,P)}removeEventListener(g,P){var I=this.eventHandlers.findIndex(I=>g===I.eventName&&P===I.handler);-1!==I&&(this.eventHandlers[I].disposer?.(),this.eventHandlers.splice(I,1))}setupEventListener(g,P){if(!this.pointerEvents)throw new Error("A PointerEvents object must be provided prior to setting up an event listener");var I=this.pointerEvents.addEventListener(this.get3DObject(),g,P);let L=this.eventHandlers.find(I=>g===I.eventName&&P===I.handler);L&&(L.disposer=I)}create3DObject(){if(!this.get3DObject())throw new Error("Expecting a THREE.Object3D to have been set by now");this.rendered||(this.rendered=!0,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.withVisibility.applyTo(this),this.htmlContainer?.render(),this.htmlContainer?.setPosition(this.withPosition.getPosition().x,this.withPosition.getPosition().y),this.htmlContainer?.setVisible(this.withVisibility.isVisible()),this.container.set3DObject(this.get3DObject()),this.container.create3DObject(),this.updateTooltip(),this.eventHandlers.forEach(g=>this.setupEventListener(g.eventName,g.handler)))}update(g){this.container.update(g),this._onFrame.dispatch(this,g)}add(...g){this.container.add(...g),g.map(g=>g.getHtmlContainer()).forEach(g=>{if(g){if(!this.htmlContainer)throw new Error("Can't add an UiObject that defines an HTMLContainer to a parent that doesn't provide an HTML container.");this.htmlContainer.add(g)}})}remove(...g){g.map(g=>g.getHtmlContainer()).forEach(g=>g&&this.htmlContainer?.remove(g)),this.container.remove(...g)}removeAll(){this.container.removeAll()}destroy(){this.container.getChildren().forEach(g=>g.destroy?.()),this.htmlContainer?.unrender(),this.eventHandlers.forEach(g=>g.disposer?.()),this.eventHandlers.length=0,this._onFrame=new _.EventDispatcher,this._onDispose.dispatch(),this._onDispose=new _.EventDispatcher}})}}}),System.register("gui/UiObjectSprite",["engine/renderable/builder/ShpBuilder","gui/UiObject"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends L.UiObject{static fromShpFile(g,P,L){let _=new I.ShpBuilder(g,P,L);return _.setBatched(!0),_.setBatchPalettes([P]),_.setOffset({x:Math.floor(g.width/2),y:Math.floor(g.height/2)}),new this(_)}constructor(g){super(),this.builder=g}setAnimationRunner(g){this.animationRunner=g}getAnimationRunner(){return this.animationRunner}update(g){super.update(g),this.animationRunner&&(this.animationRunner.tick(g),this.animationRunner.shouldUpdate()&&this.setFrame(this.animationRunner.getCurrentFrame()))}getSize(){return this.builder.getSize()}setFrame(g){this.builder.setFrame(g)}getFrame(){return this.builder.getFrame()}getFrameCount(){return this.builder.frameCount}setTransparent(g){this.get3DObject()?this.builder.setForceTransparent(g):this.initialTransparency=g}setOpacity(g){this.get3DObject()?this.builder.setOpacity(g):this.initialOpacity=g}setLightMult(g){this.get3DObject()?this.builder.setExtraLight((new THREE.Vector3).addScalar(-1+g)):this.initialLightMult=g}create3DObject(){this.set3DObject(this.builder.build()),super.create3DObject(),void 0!==this.initialTransparency&&this.builder.setForceTransparent(this.initialTransparency),void 0!==this.initialOpacity&&this.builder.setOpacity(this.initialOpacity),void 0!==this.initialLightMult&&this.builder.setExtraLight((new THREE.Vector3).addScalar(this.initialLightMult))}destroy(){super.destroy(),this.builder.dispose()}},g("UiObjectSprite",_)}}}),System.register("gui/UiScene",["gui/UiObject","gui/HtmlContainer","engine/gfx/batch/MeshBatchManager"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){U=class a extends I.UiObject{static factory(g){let P=new THREE.Scene;P.matrixAutoUpdate=!1;var I=a.createCamera(g),_=new L.HtmlContainer;return new a(P,I,g,_)}static createCamera(g){var P=g.height/2,I=g.width/g.height;let L=new THREE.OrthographicCamera(-P*I,P*I,P,-P,-1e3,1e3);return L.rotation.x=Math.PI,L.position.x=-g.x+g.width/2,L.position.y=-g.y+g.height/2,L.position.z=-1e3,L}constructor(g,P,I,L){super(g,L),this.scene=g,this.camera=P,this.viewport=I}setCamera(g){this.camera=g}setViewport(g){this.viewport=g}create3DObject(){var g;super.create3DObject(),this.meshBatchManager||(g=this.meshBatchManager=new _.MeshBatchManager(this.getRenderableContainer()),this.getRenderableContainer().add(g),this.scene.autoUpdate=!1)}update(g){super.update(g),this.meshBatchManager&&(this.scene.updateMatrixWorld(!1),this.meshBatchManager.updateMeshes())}get menuViewport(){return{x:Math.max(0,(this.viewport.width-800)/2),y:Math.max(0,(this.viewport.height-600)/2),width:800,height:600}}destroy(){super.destroy(),this.meshBatchManager?.dispose()}},g("UiScene",U)}}}),System.register("LocalPrefs",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("StorageKey",I={})).GameRes="_r_gameRes",P.Options="_r_opts_v3",P.Mixer="_r_mixer_v3",P.MusicOpts="_r_opts_music",P.LastGpuTier="_r_last_gpu",P.LastSeenPatch="_r_last_patch",P.LastMap="_r_lastMap",P.LastMode="_r_lastMode",P.LastSortMap="_r_lastSortMap",P.LastPlayerCountry="_r_lastCountry",P.LastPlayerColor="_r_lastColor",P.LastPlayerStartPos="_r_lastStartPos",P.LastPlayerTeam="_r_lastTeam",P.LastQueueRanked="_r_lastRanked",P.LastQueueType="_r_lastQueueType",P.LastBots="_r_lastBots",P.PreferredGameOpts="_r_hostOpts",P.LastConnection="_r_lastCon",P.PreferredServerRegion="_r_region",P.TauntsEnabled="_r_taunts",P.DonateBoxState="_r_donateBoxState",P.PartyNoInvites="_r_partyNoInvites",g("LocalPrefs",class{constructor(g){this.storage=g}getItem(g){try{return this.storage?.getItem(g)??void 0}catch(P){return void console.warn(`Unable to read key ${g} from localStorage.`,P)}}setItem(g,P){try{return this.storage?.setItem(g,P),!0}catch(P){return console.warn(`Unable to write key ${g} to localStorage.`,P),!1}}removeItem(g){try{this.storage?.removeItem(g)}catch(P){console.warn(`Unable to remove key ${g} from localStorage.`,P)}}listItems(){return this.storage?Object.keys(this.storage):[]}})}}}),System.register("main",["Application","automation/AiAutomationBridge","FullscreenParityPatch","VirtualJoystickPatch","WerhdMixPatch"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(){},function(){},function(){},function(){}],execute:function(){L=new I.Application,window.__RA2WEB_AUTOMATION__?.registerApplication?.(L),document.body?L.main():document.addEventListener("DOMContentLoaded",()=>{L.main()})}}}),System.register("network/AccountRegFormData",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("network/chat/ChatMessage",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("ChatRecipientType",I={}))[P.Channel=0]="Channel",P[P.Page=1]="Page",P[P.Whisper=2]="Whisper"}}}),System.register("network/chat/Message",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("network/chat/SystemMessage",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("network/gameopt/FileNameEncoder",["util/Base64","util/string"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("FileNameEncoder",class{encode(g){return g.match(/^[a-z0-9-_]+\.[a-z]{3}$/i)?g:I.Base64.encode(L.utf16ToBinaryString(g))}decode(g){return g.match(/\.[a-z]{3}$/i)?g:L.binaryStringToUtf16(I.Base64.decode(g))}})}}}),System.register("network/gameopt/LoadInfoParser",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("LoadInfoParser",class{parse(g){let P=[];var I=g.split(",");for(let g=0;g<I.length/5;++g){var L={name:I[5*g],status:Number(I[5*g+1]),loadPercent:Number(I[5*g+2]),ping:Number(I[5*g+3]),lagAllowanceMillis:Number(I[5*g+4])};P.push(L)}return P}})}}}),System.register("network/gameopt/MapNameLegacyEncoder",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("MapNameLegacyEncoder",class{encode(g){let P=[],I=0;return g.split("").forEach((g,L)=>{var _,U=127&(_=g.charCodeAt(0)<<2*L-7*I),G=_>>7&127;(_=_>>14&127)&&I++,P.push(U,G),_&&P.push(_)}),P.push(0,0),2<=g.length&&P.push(0),P=P.map(g=>128^g),P.map(g=>String.fromCharCode(g)).join("")}decode(g){let P=g.split("").map(g=>g.charCodeAt(0));for(P=P.map(g=>128^g);0===P[P.length-1];)P.pop();let I=[],L=0,_=0;for(;P.length;){var U=I.length,G=P.shift(),V=P.shift();let g=0,W=!1;(-1!==[1,2,3].indexOf(P[0])||U>L+3)&&(g=P.shift(),L=U,W=!0),U=(g<<14|V<<7|G)>>2*U-7*_,I.push(127&U),W&&_++}return I.map(g=>String.fromCharCode(g)).join("")}})}}}),System.register("network/gameopt/Parser",["data/DataStream","network/gameopt/MapNameLegacyEncoder","network/gameopt/SlotInfo","game/gameopts/GameOpts","network/gameopt/FileNameEncoder","util/Base64","util/string"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g}],execute:function(){g("Parser",class{parseOptions(g){let P={},[I,_,,U]=g.split(":"),z=I.split(",");z.shift(),z.shift(),P.gameSpeed=6-Number(z.shift()),P.credits=Number(z.shift()),P.unitCount=Number(z.shift()),P.shortGame=Boolean(Number(z.shift())),P.superWeapons=Boolean(Number(z.shift())),P.buildOffAlly=Boolean(Number(z.shift())),P.mcvRepacks=Boolean(Number(z.shift())),P.cratesAppear=Boolean(Number(z.shift())),P.gameMode=Number(z.shift()),P.hostTeams=Boolean(Number(z.shift()));var K=z.shift();return P.mapTitle=V.Base64.isBase64(K)?W.binaryStringToUtf16(V.Base64.decode(K)):(new L.MapNameLegacyEncoder).decode(K),P.maxSlots=Number(z.shift()),P.mapOfficial=Boolean(Number(z.shift())),P.mapSizeBytes=Number(z.shift()),P.mapName=(new G.FileNameEncoder).decode(z.shift()),P.mapDigest=z.shift(),P.destroyableBridges=Boolean(Number(z.shift()??"1")),P.multiEngineer=Boolean(Number(z.shift()??"0")),P.noDogEngiKills=Boolean(Number(z.shift()??"0")),P.unknown=z.length?z.join(","):void 0,P.humanPlayers=this.parsePlayerOpts(_),P.aiPlayers=this.parseAiOpts(U?.slice(0,-1)),P}parsePlayerOpts(g){var P=g.split(",");if(P.length%8!=0)throw new Error("Couldn't parse gameopt: unexpected players data length "+P.length);let I=[];for(let g=0,_=Math.floor(P.length/8);g<_;++g){var L={name:P[8*g],countryId:Number(P[8*g+1]),colorId:Number(P[8*g+2]),startPos:Number(P[8*g+3]),teamId:Number(P[8*g+4])};I.push(L)}return I}parseAiOpts(g){let P=[];if(g){var I=g.split(",");if(I.length%5!=0)throw new Error("Couldn't parse gameopt: unexpected ai data length "+I.length);for(let g=0,_=Math.floor(I.length/5);g<_;++g){var L={difficulty:Number(I[5*g]),countryId:Number(I[5*g+1]),colorId:Number(I[5*g+2]),startPos:Number(I[5*g+3]),teamId:Number(I[5*g+4])};P.push(-1!==L.countryId?L:void 0)}}return P}parseTopic(g){var P=g.split(",");if(!(P.length<6)){var I=P[0],L=Number(P[1]),_=I[2],U=P[2],z=P[3],K=P[4];I=(new G.FileNameEncoder).decode(P[5]);return{description:P[6]?W.binaryStringToUtf16(V.Base64.decode(P[6])):"",modHash:L,modName:P[7]?W.binaryStringToUtf16(V.Base64.decode(P[7])):void 0,aiPlayers:Number(U),maxPlayers:Number(_),observers:Number(z),observable:Boolean(Number(K)),mapName:I}}}parsePingData(g){var P=g.split(",").slice(1);if(P.length%2)throw new Error("Couldn't parse gameopt: unexpected ping data length "+P.length);let I=[];for(let g=0,L=Math.floor(P.length/2);g<L;++g)I.push({playerName:P[2*g],ping:Number(P[2*g+1])});return I}parseSlotData(g){var P;let I=[];for(P of g.slice(1,-1).split(",")){let g={};if("@Closed@"===P)g.type=_.SlotType.Closed;else if("@Open@"===P)g.type=_.SlotType.Open;else if("@OpenObserver@"===P)g.type=_.SlotType.OpenObserver;else if(-1!==["@EasyAI@","@MediumAI@","@HardAI@","@MediumSeaAI@"].indexOf(P)){let I;if(g.type=_.SlotType.Ai,"@EasyAI@"===P)I=U.AiDifficulty.Easy;else if("@MediumAI@"===P)I=U.AiDifficulty.Medium;else if("@HardAI@"===P)I=U.AiDifficulty.Brutal;else{if("@MediumSeaAI@"!==P)throw new Error("Couldn't parse gameopt: unknown slot type "+P);I=U.AiDifficulty.MediumSea}g.difficulty=I}else g.type=_.SlotType.Player,g.name=P;I.push(g)}return I}parsePlayerActions(g){let P=new I.DataStream(g);var L=P.readUint8();let _=[];for(let g=0;g<L;++g){var U=P.readUint8(),G=0<(G=P.readUint16())?P.readUint8Array(G):new Uint8Array;_.push({id:U,params:G})}return _}parseAllPlayerActions(g){var P=g.readUint8();let I=new Map;for(let U=0;U<P;++U){var L=g.readUint8(),_=0<(_=g.readUint16())?g.readUint8Array(_):new Uint8Array;_=this.parsePlayerActions(_);I.set(L,_)}return I}parseMapData(g){return W.uint8ArrayToBinaryString(g)}})}}}),System.register("network/gameopt/PingInfo",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("network/gameopt/Serializer",["data/DataStream","network/gameopt/SlotInfo","game/gameopts/GameOpts","network/gameopt/MapNameLegacyEncoder","network/gameopt/FileNameEncoder","util/Base64","util/string"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g}],execute:function(){g("Serializer",z=class a{serializeOptions(g,P=!1){let I=g.gameMode,L=P?(new U.MapNameLegacyEncoder).encode(g.mapTitle):V.Base64.encode(W.utf16ToBinaryString(g.mapTitle)),_=(new G.FileNameEncoder).encode(g.mapName);return["0","0",6-g.gameSpeed,g.credits,g.unitCount,Number(g.shortGame),Number(g.superWeapons),Number(g.buildOffAlly),Number(g.mcvRepacks),Number(g.cratesAppear),I,Number(g.hostTeams??!1),L,g.maxSlots,Number(g.mapOfficial),g.mapSizeBytes,_,g.mapDigest,Number(g.destroyableBridges),Number(g.multiEngineer),Number(g.noDogEngiKills),...g.unknown?[g.unknown]:[]].join(",")+`:${g.humanPlayers.map(g=>g.name+`,${g.countryId},${g.colorId},${g.startPos},${g.teamId},0,0,0`).join(",")}:@:${this.serializeAiOpts(g.aiPlayers)},`}serializeAiOpts(g){return g.map(g=>g?`${g.difficulty},${g.countryId},${g.colorId},${g.startPos},`+g.teamId:"0,-1,-1,-1,-1").join(",")}serializePingData(g){return g.length+","+g.map(g=>g.playerName+","+g.ping).join(",")}serializeSlotData(g){return g.map(g=>{if(g.type===L.SlotType.Closed)return"@Closed@";if(g.type===L.SlotType.Open)return"@Open@";if(g.type===L.SlotType.OpenObserver)return"@OpenObserver@";if(g.type===L.SlotType.Ai){if(g.difficulty===_.AiDifficulty.Easy)return"@EasyAI@";if(g.difficulty===_.AiDifficulty.Medium)return"@MediumAI@";if(g.difficulty===_.AiDifficulty.Brutal)return"@HardAI@";if(g.difficulty===_.AiDifficulty.MediumSea)return"@MediumSeaAI@"}else if(g.type===L.SlotType.Player)return g.name;throw new Error("Unexpected slot info with type "+L.SlotType[g.type])}).join(",")+","}serializeLoadInfo(g){return g.map(g=>[g.name,g.status,g.loadPercent,g.ping,g.lagAllowanceMillis].join(",")).join(",")}serializePlayerActions(g){let P=new I.DataStream;for(var{id:L,params:_}of(P.writeUint8(g.length),g))if(P.writeUint8(L),P.writeUint16(_.byteLength),0<_.byteLength){if(_.byteLength>a.MAX_ACTION_PAYLOAD_SIZE-P.position)throw console.error(`Action #${L} payload exceeds max data size`,_),new RangeError("Maximum payload data size exceeded");P.writeUint8Array(_)}return P.toUint8Array()}serializeAllPlayerActions(g,P){for(var[I,L]of(g.writeUint8(P.size),P)){g.writeUint8(I);var _=this.serializePlayerActions(L);if(g.writeUint16(_.byteLength),0<_.byteLength){if(_.byteLength>a.MAX_ACTION_PAYLOAD_SIZE)throw console.error(`Player #${I} actions payload exceeds max data size`,L),new RangeError("Maximum payload data size exceeded");g.writeUint8Array(_)}}}serializeMapData(g){return W.binaryStringToUint8Array(g)}}),z.MAX_ACTION_PAYLOAD_SIZE=65536}}}),System.register("network/gameopt/SlotInfo",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("SlotType",I={}))[P.Closed=0]="Closed",P[P.Open=1]="Open",P[P.OpenObserver=2]="OpenObserver",P[P.Player=3]="Player",P[P.Ai=4]="Ai"}}}),System.register("network/gameopt/WolGameTopic",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("network/gameres/GameRes",["data/DataStream","engine/type/ObjectType","game/gameopts/constants","util/typeGuard","network/gameres/GameResType"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g}],execute:function(){var P;(P=V=V||{})[P.Byte=1]="Byte",P[P.Boolean=2]="Boolean",P[P.Time=5]="Time",P[P.Int=6]="Int",P[P.String=7]="String",g("GameRes",class{fromGame(g,P,I){let G=g.gameOpts,V=g.gameOpts.humanPlayers.filter(g=>g.countryId!==_.OBS_COUNTRY_ID).map(P=>g.getPlayerByName(P.name));this.game={id:g.id,startTime:g.startTimestamp,duration:Math.floor(g.currentTime/1e3),speed:6-G.gameSpeed,players:V.length,mapName:G.mapName,mapDigest:G.mapDigest,unitCount:G.unitCount,cratesAppear:G.cratesAppear,credits:G.credits,tournament:P,shortGame:G.shortGame,superWeapons:G.superWeapons,aiPlayers:G.aiPlayers.filter(U.isNotNullOrUndefined).length,gameMode:G.gameMode,buildOffAlly:G.buildOffAlly,mcvRepacks:G.mcvRepacks,destroyableBridges:G.destroyableBridges,multiEngineer:G.multiEngineer,noDogEngiKills:G.noDogEngiKills},this.client=I;let W=this.computePlayerTeams(g,V);return this.players=V.map(P=>({buildingsBuilt:P.getUnitsBuilt(L.ObjectType.Building),buildingsCaptured:P.buildingsCaptured,buildingsKilled:P.getUnitsKilled(L.ObjectType.Building),buildingsLeft:P.buildings.size,color:2*[...g.rules.colors.values()].findIndex(g=>g.asHex()===P.color.asHex())+1,cratesFound:P.cratesPickedUp,endCredits:P.credits,creditsGained:P.creditsGained,infantryBuilt:P.getUnitsBuilt(L.ObjectType.Infantry),infantryKilled:P.getUnitsKilled(L.ObjectType.Infantry),infantryLeft:P.getOwnedObjectsByType(L.ObjectType.Infantry).length,lostConnection:P.name===I.accountName&&I.suddenDisconnect,name:P.name,planesBuilt:P.getUnitsBuilt(L.ObjectType.Aircraft),planesKilled:P.getUnitsKilled(L.ObjectType.Aircraft),planesLeft:P.getOwnedObjectsByType(L.ObjectType.Aircraft).length,unitsBuilt:P.getUnitsBuilt(L.ObjectType.Vehicle),unitsKilled:P.getUnitsKilled(L.ObjectType.Vehicle),unitsLeft:P.getOwnedObjectsByType(L.ObjectType.Vehicle).length,completionStatus:this.getCompletionStatus(P,g,this.client,V.length),country:P.country.id,side:P.country.side,team:W.get(P),startPos:P.startLocation})),this}computePlayerTeams(g,P){let I=new Map,L=0;for(var _ of P)if(!I.has(_)){var U;for(U of(I.set(_,L),g.alliances.getAllies(_)))I.has(U)||I.set(U,L);L++}return I}getCompletionStatus(g,P,I,L){return I.finished?P.stalemateDetectTrait?.isStale()&&0===P.stalemateDetectTrait.getCountdownTicks()?G.GameResType.Draw:!g.defeated||P.alliances.getAllies(g).some(g=>!g.defeated)?G.GameResType.Win:g.resigned?G.GameResType.Resign:g.dropped?G.GameResType.Disconnect:G.GameResType.Loss:I.outOfSync?G.GameResType.Disconnect:2<L?I.accountName!==g.name?G.GameResType.Playing:I.quit?G.GameResType.Resign:G.GameResType.Disconnect:I.accountName!==g.name?G.GameResType.Win:I.quit?G.GameResType.Resign:g.defeated?G.GameResType.Loss:G.GameResType.Disconnect}toFlat(){return{AFPS:[V.Int,this.client.avgFps],APNG:[V.Int,this.client.avgRtt],AIPL:[V.Int,this.game.aiPlayers],CRAT:[V.Boolean,this.game.cratesAppear],DURA:[V.Int,this.game.duration],FINI:[V.Boolean,this.client.finished],GSKU:[V.Int,this.client.gameSku],CRED:[V.Int,this.game.credits],OOSY:[V.Boolean,this.client.outOfSync],PLRS:[V.Int,this.game.players],PNGR:[V.Int,this.client.pingsRecv],PNGS:[V.Int,this.client.pingsSent],SCEN:[V.String,this.game.mapName],SHRT:[V.Boolean,this.game.shortGame],SPED:[V.Int,this.game.speed],SUPR:[V.Boolean,this.game.superWeapons],TIME:[V.Time,this.game.startTime],TRNY:[V.Boolean,this.game.tournament],UNIT:[V.Int,this.game.unitCount],VERS:[V.String,this.client.clientVers],MODE:[V.Int,this.game.gameMode],BAMR:[V.Int,Number(this.game.mcvRepacks)+2*Number(this.game.buildOffAlly)],MAPC:[V.String,this.game.mapDigest],GMID:[V.String,this.game.id],SNAM:[V.String,this.client.accountName],DSTB:[V.Boolean,this.game.destroyableBridges],MENG:[V.Boolean,this.game.multiEngineer],DOGK:[V.Boolean,this.game.noDogEngiKills],...this.players.map((g,P)=>({["BLB"+P]:[V.Time,g.buildingsBuilt],["BLC"+P]:[V.Int,g.buildingsCaptured],["BLK"+P]:[V.Time,g.buildingsKilled],["BLL"+P]:[V.Time,g.buildingsLeft],["COL"+P]:[V.Int,g.color],["CRA"+P]:[V.Int,g.cratesFound],["CRD"+P]:[V.Time,g.endCredits],["HRV"+P]:[V.Int,g.creditsGained],["INB"+P]:[V.Time,g.infantryBuilt],["INK"+P]:[V.Time,g.infantryKilled],["INL"+P]:[V.Time,g.infantryLeft],["LCN"+P]:[V.Boolean,g.lostConnection],["NAM"+P]:[V.String,g.name],["PLB"+P]:[V.Time,g.planesBuilt],["PLK"+P]:[V.Time,g.planesKilled],["PLL"+P]:[V.Time,g.planesLeft],["UNB"+P]:[V.Time,g.unitsBuilt],["UNK"+P]:[V.Time,g.unitsKilled],["UNL"+P]:[V.Time,g.unitsLeft],["CMP"+P]:[V.Int,g.completionStatus],["CTY"+P]:[V.Int,g.country],["SID"+P]:[V.Int,g.side],["TID"+P]:[V.Int,g.team],["STP"+P]:[V.Int,g.startPos]})).reduce((g,P)=>({...g,...P}),{})}}fromFlat(g){function r(g){return g[0]===V.Int||g[0]===V.Time?g[1]:0}function s(g){return g[0]===V.Boolean&&g[1]}function a(g){return g[0]===V.String?g[1]:""}var P=r(g.PLRS),I=r(g.BAMR),L=Boolean(1&I);I=Boolean(2&I);this.game={aiPlayers:r(g.AIPL),cratesAppear:s(g.CRAT),duration:r(g.DURA),credits:r(g.CRED),id:a(g.GMID),players:P,mapName:a(g.SCEN),shortGame:s(g.SHRT),speed:r(g.SPED),superWeapons:s(g.SUPR),startTime:r(g.TIME),tournament:s(g.TRNY),unitCount:r(g.UNIT),gameMode:r(g.MODE),buildOffAlly:I,mcvRepacks:L,mapDigest:a(g.MAPC),destroyableBridges:void 0===g.DSTB||s(g.DSTB),multiEngineer:void 0!==g.MENG&&s(g.MENG),noDogEngiKills:void 0!==g.DOGK&&s(g.DOGK)},this.players=new Array(P).fill(0).map((P,I)=>({buildingsBuilt:r(g["BLB"+I]),buildingsCaptured:r(g["BLC"+I]),buildingsKilled:r(g["BLK"+I]),buildingsLeft:r(g["BLL"+I]),color:r(g["COL"+I]),cratesFound:r(g["CRA"+I]),endCredits:r(g["CRD"+I]),creditsGained:void 0!==g["HRV"+I]?r(g["HRV"+I]):-1,infantryBuilt:r(g["INB"+I]),infantryKilled:r(g["INK"+I]),infantryLeft:r(g["INL"+I]),lostConnection:s(g["LCN"+I]),name:a(g["NAM"+I]),planesBuilt:r(g["PLB"+I]),planesKilled:r(g["PLK"+I]),planesLeft:r(g["PLL"+I]),unitsBuilt:r(g["UNB"+I]),unitsKilled:r(g["UNK"+I]),unitsLeft:r(g["UNL"+I]),completionStatus:r(g["CMP"+I]),country:r(g["CTY"+I]),side:r(g["SID"+I]),team:r(g["TID"+I]),startPos:void 0!==g["STP"+I]?r(g["STP"+I]):-1}));let _=a(g.SNAM);P=this.players.find(g=>g.name===_),this.client={avgFps:r(g.AFPS),avgRtt:r(g.APNG??0),finished:s(g.FINI),gameSku:r(g.GSKU),outOfSync:s(g.OOSY),pingsRecv:r(g.PNGR),pingsSent:r(g.PNGS),clientVers:a(g.VERS),quit:P?.completionStatus===G.GameResType.Resign,accountName:_,suddenDisconnect:P?.lostConnection??!1}}toBinary(){var g,P=new I.DataStream,L=this.toFlat();for(g of Object.keys(L)){var[_,U]=L[g];this.writeType(_,g,U,P)}let G=new I.DataStream;return G.writeUint16(P.byteLength+4,I.DataStream.BIG_ENDIAN),G.writeUint16(0),G.writeUint8Array(new Uint8Array(P.buffer,P.byteOffset,P.byteLength)),new Uint8Array(G.buffer,G.byteOffset,G.byteLength)}fromBinary(g){let P=new I.DataStream(g);var L=P.readUint16(I.DataStream.BIG_ENDIAN)-4;if(0!==P.readUint16())throw new Error("Invalid game res packet. Second byte should be 0.");let _={};for(;L&&P.position<=L-4;){var{fieldName:U,type:G,data:V}=this.readType(P);void 0!==V&&(_[U]=[G,V])}return this.fromFlat(_),this}writeType(g,P,L,_){if(4<P.length)throw new Error(`Field "${P}" must not exceed 4 characters`);switch(_.writeString(P,"ASCII",4),_.writeUint16(g,I.DataStream.BIG_ENDIAN),g){case V.Byte:return _.writeUint16(1,I.DataStream.BIG_ENDIAN),_.writeUint32(L,I.DataStream.BIG_ENDIAN);case V.Boolean:return _.writeUint16(1,I.DataStream.BIG_ENDIAN),_.writeUint8Array([L?1:0,0,0,0]);case V.Time:case V.Int:return _.writeUint16(4,I.DataStream.BIG_ENDIAN),_.writeUint32(L,I.DataStream.BIG_ENDIAN);case V.String:var U=L.length+1;return _.writeUint16(U,I.DataStream.BIG_ENDIAN),_.writeCString(L,4*Math.ceil(U/4));default:throw new Error(`Unhandled type "${g}"`)}}readType(g){var P=g.readString(4,"ASCII"),L=g.readUint16(I.DataStream.BIG_ENDIAN),_=g.readUint16(I.DataStream.BIG_ENDIAN);let U;switch(L){case V.Byte:U=g.readUint32(I.DataStream.BIG_ENDIAN);break;case V.Boolean:U=Boolean(g.readUint8Array(4)[0]);break;case V.Time:case V.Int:U=g.readUint32(I.DataStream.BIG_ENDIAN);break;case V.String:U=g.readCString(4*Math.ceil(_/4));break;default:console.warn(`Unknown game res field type "${L}"`),g.position+=_,U=void 0}return{fieldName:P,type:L,data:U}}})}}}),System.register("network/gameres/GameResClientInfo",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("network/gameres/GameResGameInfo",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("network/gameres/GameResPlayerInfo",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("GameResPlayerInfo",class{})}}}),System.register("network/gameres/GameResType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("GameResType",I={}))[P.ConnectionLost=2]="ConnectionLost",P[P.Playing=8]="Playing",P[P.Draw=64]="Draw",P[P.Win=256]="Win",P[P.Loss=512]="Loss",P[P.Resign=528]="Resign",P[P.Disconnect=768]="Disconnect"}}}),System.register("network/gamestate/ActionSerializer",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("ActionSerializer",class{getActionPayload(g){return{id:g.actionType,params:g.serialize()}}})}}}),System.register("network/gamestate/LockstepManager",["data/DataStream","game/action/NoAction","game/Game","util/event","network/gservConfig","game/GameSpeed","network/gamestate/lockstepUtil"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g}],execute:function(){g("LockstepManager",z=class o{get onLagStateChange(){return this._onLagStateChange.asEvent()}get onActionsSent(){return this._onActionsSent.asEvent()}get onActionsProcessed(){return this._onActionsProcessed.asEvent()}get onActionsReceived(){return this._onActionsReceived.asEvent()}constructor(g,P,L,_,G,V,W,z,K,q,$,Q,Y){this.game=g,this.gservCon=P,this.gameoptParser=L,this.gameoptSerializer=_,this.actionSerializer=G,this.actionFactory=V,this.inputActions=W,this.onDesync=z,this.actionLogger=K,this.netLogger=q,this.debugLogger=$,this.replayRecorder=Q,this.debugGameState=Y,this.debugGameStateHistory=[],this.queuedRateChanges=[],this.errorState=!1,this.passiveMode=!1,this.receivedActions=new Map,this.receivedNetworkTurn=0,this.lagState=!1,this._onLagStateChange=new U.EventDispatcher,this._onActionsSent=new U.EventDispatcher,this._onActionsProcessed=new U.EventDispatcher,this._onActionsReceived=new U.EventDispatcher,this.receiveActions=g=>{let P=new I.DataStream(g);var L=P.readUint32(),_=this.gameoptParser.parseAllPlayerActions(P);this.receivedNetworkTurn=L,this.receivedActions.set(L,_),this._onActionsReceived.dispatch(void 0,L)},this.handleGameDesync=()=>{this.setErrorState(),this.onDesync()}}init(){this.gameTurnMillis=1e3/(this.game.desiredSpeed.value*V.GameSpeed.BASE_TICKS_PER_SECOND),this.currentNetworkTurn=0,this.currentSubTurn=0,this.gservCon.onGameActions.subscribe(this.receiveActions),this.gservCon.onGameDesync.subscribe(this.handleGameDesync),this.debug("Init: gameTurnMillis = "+this.gameTurnMillis)}canAdvanceNetworkTurn(){return this.currentNetworkTurn<2||this.receivedActions.has(this.currentNetworkTurn-2)}setErrorState(){this.errorState=!0}getErrorState(){return this.errorState}setRate(g){if(this.debug(`Recv rate: ${g.rate} (turn ${g.turnNo})`),0===this.currentSubTurn&&0===this.currentNetworkTurn&&0===g.turnNo)this.updateRate(g.rate);else{if(g.turnNo<this.currentNetworkTurn-2)throw new Error("Rate change has turn number more than two turns in the past.");this.queuedRateChanges.push(g)}}updateRate(g){this.networkTurnMillis=W.computeNetworkTurnMillis(g,this.gameTurnMillis),this.hashCheckTurnInterval=Math.ceil(o.PREFERRED_HASH_CHECK_MILLIS/this.networkTurnMillis),this.netLogger?.debug(`Rate set to ${g} (${this.networkTurnMillis}ms) @ `+this.currentNetworkTurn)}setPassiveMode(g){this.debug("Send passive: "+g),this.passiveMode=g,this.gservCon.sendPlayerActive(!g)}getTurnMillis(){return this.gameTurnMillis}doGameTurn(g){if(!this.errorState){if(!this.networkTurnMillis)throw new Error("Network turn rate should be set by now.");if(this.game.status!==_.GameStatus.Ended){if(0===this.currentSubTurn){var P=this.queuedRateChanges[0];if(P&&P.turnNo+2===this.currentNetworkTurn&&(this.debug(`Process rate ${P.rate} (turn ${P.turnNo})`),this.updateRate(P.rate),this.queuedRateChanges.shift()),!this.canAdvanceNetworkTurn())return this.handleCommsLag(!0,g),this.debug("Lag state: "+this.lagState),!1;this.debug("Advance turn"),this.commsLagStartTime&&0<g-this.commsLagStartTime&&this.netLogger?.debug(`Waited ${Math.round(g-this.commsLagStartTime)}ms for other clients to catch up.`),this.handleCommsLag(!1,g),!this.passiveMode&&this.currentNetworkTurn>=this.receivedNetworkTurn&&this.sendActions(),2<=this.currentNetworkTurn&&(I=this.receivedActions.get(this.currentNetworkTurn-2),this.replayRecorder.recordActions(this.game.currentTick,I),this.processActions(I),this.receivedActions.delete(this.currentNetworkTurn-2),this._onActionsProcessed.dispatch(void 0,this.currentNetworkTurn-2)),this.game.update(),this.passiveMode||this.currentNetworkTurn%this.hashCheckTurnInterval!=0||this.gservCon.sendGameStateHash(this.currentNetworkTurn,this.game.getHash()),this.networkTurnMillis>this.gameTurnMillis?this.currentSubTurn++:this.currentNetworkTurn++}else this.debug("Update"),this.game.update(),this.currentSubTurn++,this.currentSubTurn>=this.networkTurnMillis/this.gameTurnMillis&&(this.currentSubTurn=0,this.currentNetworkTurn++);var I;this.debugGameState&&(I=this.networkTurnMillis/this.gameTurnMillis*this.hashCheckTurnInterval,this.debugGameStateHistory.length>I&&this.debugGameStateHistory.shift(),this.debugGameStateHistory.push(this.game.debugGetState()))}else this.game.update()}}handleCommsLag(g,P){g?(this.commsLagStartTime||(this.commsLagStartTime=P),P-this.commsLagStartTime>G.LAG_STATE_THRESH_MILLIS&&this.updateLagState(!0)):(this.commsLagStartTime=void 0,this.updateLagState(!1))}updateLagState(g){g!==this.lagState&&(this.lagState=g,this._onLagStateChange.dispatch(void 0,g))}sendActions(){let g=this.inputActions.dequeueAll();g.length||g.push(new L.NoAction);var P=this.gameoptSerializer.serializePlayerActions(g.map(g=>this.actionSerializer.getActionPayload(g)));this.debug("Send actions: "+P),this.gservCon.sendPlayerActions(this.currentNetworkTurn,P),this._onActionsSent.dispatch(void 0,this.currentNetworkTurn)}processActions(g){[...g].forEach(([g,P])=>P.forEach(P=>{let I=this.actionFactory.create(P.id);I.player=this.game.getPlayer(g),I.unserialize(P.params),I.process();var L=I.print();L&&this.actionLogger?.debug(`(${I.player.name})@${this.game.currentTick}: `+L)}))}debug(g){this.debugLogger?.(`${this.currentNetworkTurn}-${this.currentSubTurn}-${this.game.currentTick}: `+g)}dispose(){this.setErrorState(),this.gservCon.onGameActions.unsubscribe(this.receiveActions),this.gservCon.onGameDesync.unsubscribe(this.handleGameDesync)}}),z.PREFERRED_HASH_CHECK_MILLIS=1e3}}}),System.register("network/gamestate/lockstepUtil",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("computeNetworkTurnMillis",(g,P)=>Math.max(1,Math.ceil(g/P))*P)}}}),System.register("network/gamestate/PlayerActionPayload",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("network/gamestate/PlayerConnectionInfo",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("network/gamestate/PlayerConnectionStatus",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("PlayerConnectionStatus",I={}))[P.NotConnected=0]="NotConnected",P[P.Connected=1]="Connected"}}}),System.register("network/gamestate/Replay",["network/gameopt/Serializer","network/gameopt/Parser","util/Base64","network/gamestate/replay/ReplayEventFactory","util/stream","util/string"],function(g,P){"use strict";var I,L,_,U,G,V,W,z;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){W=[5,6],g("Replay",z=class C{constructor(){this.name="",this.events=[]}static sanitizeFileName(g,P="_"){return g.replace(/[/?<>\\:*|"]/g,P).replace(/[\x00-\x1f\x7f\x80-\x9f]/g,P).slice(0,this.maxNameLength)}init(g,P,I,L,_){this.gameId=g,this.gameTimestamp=P,this.gameOpts=I,this.engineVersion=L,this.modHash=_,this.name=C.sanitizeFileName(this.gameOpts.mapTitle+" "+(new Date).toISOString().replace(/(\.|,)\d+Z$/,"Z")),this.timestamp=Date.now()}writeEvent(...g){this.events.push(...g)}finish(g){this.endTick=g}getEvents(){return this.events}*flush(){if(!this.gameOpts)throw new Error("Game options must be set first");if(!this.engineVersion)throw new Error("Engine version is not set");if(void 0===this.modHash)throw new Error("Mod hash is not set");let g=new I.Serializer,P=this.getHeaderTag()+"\n";for(P+=`ENGINE ${this.engineVersion} ${this.modHash}\n`,P+=[this.gameId,this.gameTimestamp,g.serializeOptions(this.gameOpts)].join(" ")+"\n",yield P,P="";void 0===this.endTick||this.events.length;){for(var L of this.events)P+=L.tickNo+"="+L.type+"|"+L.serialize()+"\n";this.events.length=0,yield P,P=""}P+=this.getEndTag()+" "+this.endTick+"\n",this.debugInfo&&(P+=_.Base64.encode(V.utf16ToBinaryString(this.debugInfo))+"\n"),yield P}serialize(){if(void 0===this.endTick)throw new Error("Replay is not finished");let g="";var P,I=this.events.slice();for(P of this.flush())g+=P;return this.events=I,g}async parseHeader(g){let P,I,L,U,V,W,z=0;var K;for await(K of"string"==typeof g?g.split("\n"):G.makeTextFileLineIterator(g)){if(0===z)P=this.readReplayVersion(K);else if(1===z){if(!K.match(C.engineLineRegex))throw new Error("Missing or invalid game engine version line");var q;I=(q=K.split(" "))[1],L=Number(P<4?"0":q[2])}else{if(2!==z)break;if(!K.match(/^([a-zA-Z0-9-]+) \d+ .*$/))throw new Error("Missing or invalid game id/time/opts line");var[$,Q,q]=K.split(" ");U=$,V=Number(Q),W=P<6?_.Base64.decode(q):q}z++}if(z<3)throw new Error("Bad replay header");return{replayVersion:P,engineVersion:I,modHash:L,gameId:U,gameTimestamp:V,gameOptsSerialized:W}}unserialize(g,P){let G=g.split("\n");var z=this.readReplayVersion(G.shift()||"");if(!W.includes(z))throw new Error("Unsupported replay version "+z);let K=new L.Parser,q=G.shift();if(!q||!q.match(C.engineLineRegex))throw new Error("Missing or invalid game engine version line");var[,$,Q]=q.split(" ");let Y=G.shift();if(!Y)throw new Error("Missing game id/time/opts line");var Z=Y.match(/^([a-zA-Z0-9-]+) (\d+) (.*)$/);if(!Z)throw new Error("Invalid game id/time/opts line");let[,X,J,ee]=Z;z<6&&(ee=_.Base64.decode(ee)),z=K.parseOptions(ee),this.init(X,Number(J),z,$,Number(Q)),this.name=P.name,this.timestamp=P.timestamp;let te,re=!1;for(;te=G.shift();){if(te.startsWith(this.getEndTag())){re=!0;break}var se;if(!(se=te.match(/^(\d+)=(\d+)\|(.+)$/)))throw new Error(`Invalid event line "${te}"`);var[,ae,ne,se]=se,ae=Number(ae),ne=Number(ne);let g=new U.ReplayEventFactory(K,new I.Serializer).create(ne,ae);g.unserialize(se),this.writeEvent(g)}if(!re)throw new Error("Incomplete replay data");if(!(Q=te.match(new RegExp(`^${this.getEndTag()} (\\d+)$`))))throw new Error("Invalid end tag");this.endTick=Number(Q[1]),1<=G.length&&(this.debugInfo=V.binaryStringToUtf16(_.Base64.decode(G[0])))}getHeaderTag(){return"RA2TSREPL_v6"}readReplayVersion(g){var P=g.match(/^RA2TSREPL_v(\d+)$/);if(!P||P.length<2)throw new Error("Unknown replay format");return Number(P[1])}getEndTag(){return"END"}}),z.extension=".rpl",z.maxNameLength=128,z.engineLineRegex=/^ENGINE \d+\.\d+( \d+)?$/}}}),System.register("network/gamestate/replay/ChatMessageReplayEvent",["util/Base64","util/string","network/gamestate/replay/ReplayEvent","network/gamestate/replay/ReplayEventType"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=class extends _.ReplayEvent{constructor(g){super(U.ReplayEventType.ChatMessage,g)}serialize(){return this.payload.playerId+":"+I.Base64.encode(L.utf16ToBinaryString(this.payload.message))}unserialize(g){var[P,_]=g.split(":"),P=Number(P),_=L.binaryStringToUtf16(I.Base64.decode(_));this.payload={playerId:P,message:_}}},g("ChatMessageReplayEvent",G)}}}),System.register("network/gamestate/replay/ReplayEvent",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("ReplayEvent",class{constructor(g,P){this.type=g,this.tickNo=P}})}}}),System.register("network/gamestate/replay/ReplayEventFactory",["network/gamestate/replay/ChatMessageReplayEvent","network/gamestate/replay/ReplayEventType","network/gamestate/replay/TauntReplayEvent","network/gamestate/replay/TurnActionsReplayEvent"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("ReplayEventFactory",class{constructor(g,P){this.gameOptsParser=g,this.gameOptsSerializer=P}create(g,P){switch(g){case L.ReplayEventType.TurnActions:return new U.TurnActionsReplayEvent(this.gameOptsParser,this.gameOptsSerializer,P);case L.ReplayEventType.ChatMessage:return new I.ChatMessageReplayEvent(P);case L.ReplayEventType.Taunt:return new _.TauntReplayEvent(P);default:throw new Error(`Unsupported replay event type "${g}" at game tick "${P}"`)}}})}}}),System.register("network/gamestate/replay/ReplayEventType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("ReplayEventType",I={}))[P.TurnActions=0]="TurnActions",P[P.ChatMessage=1]="ChatMessage",P[P.Taunt=2]="Taunt"}}}),System.register("network/gamestate/replay/TauntReplayEvent",["network/gamestate/replay/ReplayEvent","network/gamestate/replay/ReplayEventType"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){_=class extends I.ReplayEvent{constructor(g){super(L.ReplayEventType.Taunt,g)}serialize(){return this.payload.playerId+":"+this.payload.tauntNo}unserialize(g){var[P,I]=g.split(":"),P=Number(P),I=Number(I);this.payload={playerId:P,tauntNo:I}}},g("TauntReplayEvent",_)}}}),System.register("network/gamestate/replay/TurnActionsReplayEvent",["data/DataStream","util/string","network/gamestate/replay/ReplayEvent","network/gamestate/replay/ReplayEventType"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){G=class extends _.ReplayEvent{constructor(g,P,I){super(U.ReplayEventType.TurnActions,I),this.gameOptsParser=g,this.gameOptsSerializer=P}serialize(){let g=new I.DataStream;return this.gameOptsSerializer.serializeAllPlayerActions(g,new Map(this.payload)),L.uint8ArrayToBase64String(g.toUint8Array())}unserialize(g){var P=new I.DataStream(L.base64StringToUint8Array(g));P=this.gameOptsParser.parseAllPlayerActions(P);this.payload=[...P]}},g("TurnActionsReplayEvent",G)}}}),System.register("network/gamestate/ReplayRecorder",["game/action/ActionType","network/gamestate/replay/TurnActionsReplayEvent","network/gameopt/Parser","network/gameopt/Serializer","network/gamestate/replay/ChatMessageReplayEvent","network/gamestate/replay/TauntReplayEvent"],function(g,P){"use strict";var I,L,_,U,G,V;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){g("ReplayRecorder",class{constructor(g,P,I,L){this.replay=g,this.playerId=P,this.humanPlayers=I,this.actionSerializer=L}recordActions(g,P){if(Array.isArray(P)){let I=new L.TurnActionsReplayEvent(new _.Parser,new U.Serializer,g);I.payload=[[this.playerId,P.map(g=>this.actionSerializer.getActionPayload(g))]],this.replay.writeEvent(I)}else if(this.hasActualActions(P)){let I=new L.TurnActionsReplayEvent(new _.Parser,new U.Serializer,g);I.payload=[...P].map(([g,P])=>[g,P]),this.replay.writeEvent(I)}}recordChatMessage(g,P,I){let L=new G.ChatMessageReplayEvent(g);L.payload={playerId:this.humanPlayers.findIndex(g=>g.name===P),message:I},this.replay.writeEvent(L)}recordTaunt(g,P,I){let L=new V.TauntReplayEvent(g);L.payload={playerId:this.humanPlayers.findIndex(g=>g.name===P),tauntNo:I},this.replay.writeEvent(L)}hasActualActions(g){return!![...g.values()].find(g=>g.find(g=>g.id!==I.ActionType.NoAction))}})}}}),System.register("network/gamestate/ReplayTurnManager",["game/Game","game/GameSpeed","network/gamestate/replay/TurnActionsReplayEvent","util/event"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("ReplayTurnManager",class{get onReplayEvent(){return this._onReplayEvent.asEvent()}constructor(g,P,I,L){this.game=g,this.replay=P,this.actionFactory=I,this.actionLogger=L,this.errorState=!1,this.gameSpeedChanged=!1,this._onReplayEvent=new U.EventDispatcher,this.onGameSpeedChanged=()=>{this.gameSpeedChanged=!0}}init(){this.game.desiredSpeed.onChange.subscribe(this.onGameSpeedChanged),this.computeGameTurn(this.game.speed.value),this.replayIterator=this.replay.getEvents().values(),this.nextReplayEvent=this.replayIterator.next().value}computeGameTurn(g){this.gameTurnMillis=1e3/(g*L.GameSpeed.BASE_TICKS_PER_SECOND)}setErrorState(){this.errorState=!0}getErrorState(){return this.errorState}getTurnMillis(){return this.gameTurnMillis}doGameTurn(g){if(!this.errorState)if(this.game.status!==I.GameStatus.Ended){for(;this.nextReplayEvent&&this.nextReplayEvent.tickNo===this.game.currentTick;)this.nextReplayEvent instanceof _.TurnActionsReplayEvent&&this.processActions(this.nextReplayEvent.payload),this._onReplayEvent.dispatch(this,this.nextReplayEvent),this.nextReplayEvent=this.replayIterator.next().value;if(this.nextReplayEvent&&this.nextReplayEvent.tickNo<this.game.currentTick)throw new Error("Replay event desync");this.replay.endTick+1<=this.game.currentTick?this.game.status=I.GameStatus.Ended:(this.game.update(),this.gameSpeedChanged&&(this.game.speed.value=this.game.desiredSpeed.value,this.computeGameTurn(this.game.speed.value),this.gameSpeedChanged=!1))}else this.game.speed.value=0}processActions(g){g.forEach(([g,P])=>P.forEach(P=>{let I=this.actionFactory.create(P.id);I.player=this.game.getPlayer(g),I.unserialize(P.params),I.process();var L=I.print();L&&this.actionLogger?.debug(`(${I.player.name})@${this.game.currentTick}: `+L)}))}dispose(){this.game.desiredSpeed.onChange.unsubscribe(this.onGameSpeedChanged)}})}}}),System.register("network/gamestate/SoloPlayTurnManager",["game/action/NoAction","game/Game","game/GameSpeed"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("SoloPlayTurnManager",class{constructor(g,P,I,L,_){this.game=g,this.currentPlayer=P,this.inputActions=I,this.actionLogger=L,this.replayRecorder=_,this.errorState=!1,this.gameSpeedChanged=!1,this.onGameSpeedChanged=()=>{this.gameSpeedChanged=!0}}init(){this.game.desiredSpeed.onChange.subscribe(this.onGameSpeedChanged),this.computeGameTurn(this.game.speed.value)}computeGameTurn(g){this.gameTurnMillis=1e3/(g*_.GameSpeed.BASE_TICKS_PER_SECOND)}setErrorState(){this.errorState=!0}getErrorState(){return this.errorState}getTurnMillis(){return this.gameTurnMillis}doGameTurn(g){if(!this.errorState){if(this.game.status!==L.GameStatus.Ended){let g=this.inputActions.dequeueAll();g.length?this.replayRecorder.recordActions(this.game.currentTick,g):g.push(new I.NoAction),this.processActions(g)}this.game.update(),this.gameSpeedChanged&&(this.game.speed.value=this.game.desiredSpeed.value,this.computeGameTurn(this.game.speed.value),this.gameSpeedChanged=!1)}}processActions(g){g.forEach(g=>{g.player=this.currentPlayer,g.process();var P=g.print();P&&this.actionLogger?.debug(`(${g.player.name})@${this.game.currentTick}: `+P)})}dispose(){this.game.desiredSpeed.onChange.unsubscribe(this.onGameSpeedChanged)}})}}}),System.register("network/gserv/CreateGameInstanceParams",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("network/gservCodes",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("RPL_CVERS_OK",10),g("RPL_CVERS_OUTDATED",11),g("RPL_CVERS_MISSING",12),g("RPL_LOGGED_IN",100),g("RPL_ALREADY_LOGGED_IN",101),g("RPL_NOT_LOGGED_IN",102),g("RPL_BAD_LOGIN",103),g("RPL_TOO_MANY_LOGIN_ATTEMPTS",104),g("RPL_INSTANCE_CREATED",200),g("RPL_INSTANCE_EXISTS",201),g("RPL_INSTANCE_TOO_MANY",202),g("RPL_NOT_ENOUGH_PARAMS",300),g("RPL_INVALID_PARAMS",301),g("RPL_RATE_LIMIT_EXCEEDED",302),g("RPL_INSTANCE_CONNECTED",400),g("RPL_INSTANCE_NONEXISTENT",401),g("RPL_INSTANCE_NOT_ALLOWED",402),g("RPL_INSTANCE_ALREADY_STARTED",403),g("RPL_NO_INSTANCE",404),g("RPL_INSTANCE_NOT_RUNNING",405),g("RPL_INSTANCE_VERS_MISMATCH",406),g("RPL_GAME_OPTS",500),g("RPL_LOAD_INFO",600),g("RPL_MAP_TOO_BIG",602),g("RPL_MAP_ALREADY_SENT",603),g("RPL_GAME_START",700),g("RPL_GAME_DESYNC",801),g("RPL_NET_RATE",802),g("RPL_TAUNT",803),g("RPL_PLAYER_DISCONNECT",804),g("RPL_PRIVMSG_NOT_ALLOWED",805),g("RPL_BIN_PREFIX",2),g("RPL_BIN_GAME_ACTIONS",1),g("RPL_BIN_MAP_DATA",2),g("REQ_BIN_PREFIX",2),g("REQ_BIN_GAME_ACTIONS",1),g("REQ_BIN_GAME_STATE_HASH",2),g("REQ_BIN_PUT_MAP",3),g("REQ_BIN_GET_MAP",4)}}}),System.register("network/gservConfig",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("API_VERSION",2),g("RECIPIENT_ALL","#all"),g("RECIPIENT_TEAM","#team"),g("TURN_TIMEOUT_MILLIS",3e4),g("LAG_STATE_THRESH_MILLIS",1e3),g("CON_INFO_THRESH_MILLIS",2e3),g("LAG_CHECK_INTERVAL_MILLIS",1e3),g("MAX_MAP_TRANSFER_BYTES",2097152)}}}),System.register("network/GservConnection",["util/event","data/DataStream","network/IrcConnection","network/gservCodes","network/GservError","network/gservConfig","network/gameopt/Parser","network/gameopt/Serializer","network/chat/ChatMessage","util/Base64"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g}],execute:function(){$=new Map([[U.RPL_BAD_LOGIN,G.GservError.Code.BadLogin],[U.RPL_TOO_MANY_LOGIN_ATTEMPTS,G.GservError.Code.TooManyLoginAttempts],[U.RPL_ALREADY_LOGGED_IN,G.GservError.Code.AlreadyLoggedIn],[U.RPL_INSTANCE_EXISTS,G.GservError.Code.InstanceAlreadyExists],[U.RPL_INSTANCE_TOO_MANY,G.GservError.Code.CreatedTooManyInstances],[U.RPL_INSTANCE_NONEXISTENT,G.GservError.Code.InstanceNonExistent],[U.RPL_INSTANCE_NOT_ALLOWED,G.GservError.Code.InstanceNotAllowed],[U.RPL_INSTANCE_ALREADY_STARTED,G.GservError.Code.InstanceAlreadyStarted],[U.RPL_INSTANCE_VERS_MISMATCH,G.GservError.Code.InstanceVersMismatch]]),g("GservConnection",class{get onError(){return this.con.onError}get onClose(){return this.con.onClose}get onLoadInfo(){return this._onLoadInfo.asEvent()}get onGameStart(){return this._onGameStart.asEvent()}get onGameActions(){return this._onGameActions.asEvent()}get onGameDesync(){return this._onGameDesync.asEvent()}get onRateChange(){return this._onRateChange.asEvent()}get onChatMessage(){return this._onChatMessage.asEvent()}get onTaunt(){return this._onTaunt.asEvent()}get onPlayerDisconnect(){return this._onPlayerDisconnect.asEvent()}get onPrivMsgNotAllowed(){return this._onPrivMsgNotAllowed.asEvent()}static factory(g){return new this(new _.IrcConnection({mode:"text",binaryRplPrefix:U.RPL_BIN_PREFIX,binaryReqPrefix:U.REQ_BIN_PREFIX,logFilter:g=>g.replace(/^(user [^ ]+) ([^ ]+)/i,"$1 <redacted>").replace(/^((:.+!.+@.+)?privmsg ([^ ]+ )+):(.+)\r?\n?$/i,"$1:<redacted>")},g))}constructor(g){this._onLoadInfo=new I.EventDispatcher,this._onGameStart=new I.EventDispatcher,this._onGameActions=new I.EventDispatcher,this._onGameDesync=new I.EventDispatcher,this._onRateChange=new I.EventDispatcher,this._onChatMessage=new I.EventDispatcher,this._onTaunt=new I.EventDispatcher,this._onPlayerDisconnect=new I.EventDispatcher,this._onPrivMsgNotAllowed=new I.EventDispatcher,this.handleMessage=g=>{if("string"==typeof g){let L=g.split(" ");var P,I;"ping"===L[0]?this.isOpen()&&this.con.sendMessage("pong"+(L[1]?" "+L[1]:"")):"privmsg"===L[1].toLowerCase()?this.handlePrivMsg(g):L[1]===""+U.RPL_LOAD_INFO?this.handleLoadInfo(L[3]):L[1]===""+U.RPL_GAME_START?this.handleGameStart():L[1]===""+U.RPL_GAME_DESYNC?this._onGameDesync.dispatch(this):L[1]===""+U.RPL_NET_RATE?([P,I]=L[3].slice(1).split(","),this._onRateChange.dispatch(this,{rate:Number(P),turnNo:Number(I)})):L[1]===""+U.RPL_TAUNT?this._onTaunt.dispatch(this,{from:L[0].replace(/^:/,""),tauntNo:Number(L[3].replace(/^:/,""))}):L[1]===""+U.RPL_PLAYER_DISCONNECT?this._onPlayerDisconnect.dispatch(this,L[3].replace(/^:/,"")):L[1]===""+U.RPL_PRIVMSG_NOT_ALLOWED&&this._onPrivMsgNotAllowed.dispatch(this)}else g[0]===U.RPL_BIN_GAME_ACTIONS&&this.handlePlayerActions(g.slice(1))},this.con=g}getCurrentUser(){return this.currentUser}getServerName(){return this.serverName}async connect(g,P){return this.con.onMessage.subscribe(this.handleMessage),await this.con.connect(g,P)}close(){this.con.onMessage.unsubscribe(this.handleMessage),this.con.close(),this.currentUser=void 0}isOpen(){return this.con.isOpen()}async cvers(g){let P=await this.con.sendCommand(`cvers ${g} `+V.API_VERSION,{replyCodes:[U.RPL_CVERS_OK,U.RPL_CVERS_OUTDATED]});if(P[0].code===U.RPL_CVERS_OUTDATED){var I=P[0].params?P[0].params.splice(1).join(" ").replace(/^:/,""):"unknown";throw new G.GservError("Cvers error: "+I,G.GservError.Code.OutdatedClient)}}async login(g,P){let I=await this.con.sendCommand(`user ${g} `+q.Base64.encode(P),{replyCodes:[U.RPL_LOGGED_IN,U.RPL_BAD_LOGIN,U.RPL_TOO_MANY_LOGIN_ATTEMPTS,U.RPL_ALREADY_LOGGED_IN],timeout:10});if(I[0].code!==U.RPL_LOGGED_IN){var L=$.get(I[0].code)??G.GservError.Code.Unknown,_=I[0].params?I[0].params.splice(1).join(" ").replace(/^:/,""):"unknown";throw new G.GservError("Login error: "+_,L)}this.currentUser=g,this.serverName=I[0].raw.match(/^:([^\s]+)/)?.[1]||""}async createGame(g,P,I,L,_,V=!1){if(I.includes(" "))throw new Error("Game opts string cannot include spaces");let W=await this.con.sendCommand(`create ${g} ${P} ${I} ${L} ${_} `+Number(V),{replyCodes:[U.RPL_INSTANCE_CREATED,U.RPL_INSTANCE_EXISTS,U.RPL_INSTANCE_TOO_MANY,U.RPL_INSTANCE_NOT_ALLOWED]});if(W[0].code!==U.RPL_INSTANCE_CREATED){var z=$.get(W[0].code)??G.GservError.Code.Unknown,K=W[0].params?W[0].params.splice(1).join(" ").replace(/^:/,""):"unknown";throw new G.GservError("Create error: "+K,z)}}async joinGame(g,P,I){let L=await this.con.sendCommand(`join ${g} ${P} `+I,{replyCodes:[U.RPL_INSTANCE_CONNECTED,U.RPL_INSTANCE_NONEXISTENT,U.RPL_INSTANCE_NOT_ALLOWED,U.RPL_INSTANCE_ALREADY_STARTED,U.RPL_INSTANCE_VERS_MISMATCH]});if(L[0].code!==U.RPL_INSTANCE_CONNECTED){var _=$.get(L[0].code)??G.GservError.Code.Unknown,V=L[0].params?L[0].params.splice(1).join(" ").replace(/^:/,""):"unknown";throw new G.GservError("Join error: "+V,_)}}async gameOpts(){let g=await this.con.sendCommand("gameopts",{replyCodes:[U.RPL_GAME_OPTS]});if(!g[0].params)throw new Error("Unexpected server reply for getopts command. Missing params.");return g[0].params.splice(1).join(" ").replace(/^:/,"")}sendLoadedPercent(g){this.con.sendMessage("loaded "+g)}requestLoadInfo(){this.con.sendMessage("loadinfo")}sendGameStateHash(g,P){let I=new L.DataStream(10);I.dynamicSize=!1,I.writeUint8(U.REQ_BIN_PREFIX),I.writeUint8(U.REQ_BIN_GAME_STATE_HASH),I.writeUint32(g),I.writeUint32(P),this.con.sendMessage(I.toUint8Array())}sendPlayerActive(g){this.con.sendMessage("active "+(g?1:0))}sendTaunt(g){this.con.sendMessage("taunt "+g)}async ping(g){return await this.con.ping(g)}sendPlayerActions(g,P){let I=new L.DataStream(6);I.writeUint8(U.REQ_BIN_PREFIX),I.writeUint8(U.REQ_BIN_GAME_ACTIONS),I.writeUint32(g),I.writeUint8Array(P),this.con.sendMessage(I.toUint8Array())}sendMap(g){let P=new L.DataStream(2);P.writeUint8(U.REQ_BIN_PREFIX),P.writeUint8(U.REQ_BIN_PUT_MAP),P.writeUint8Array((new z.Serializer).serializeMapData(g)),this.con.sendMessage(P.toUint8Array())}async getMap(){let g=new L.DataStream(2);g.dynamicSize=!1,g.writeUint8(U.REQ_BIN_PREFIX),g.writeUint8(U.REQ_BIN_GET_MAP);var P=await this.con.sendBinCommand(g.toUint8Array(),{replyCodes:[U.RPL_BIN_MAP_DATA],timeout:15});return(new W.Parser).parseMapData(P.data)}handleLoadInfo(g){this._onLoadInfo.dispatch(this,g.replace(/^:/,""))}handleGameStart(){this._onGameStart.dispatch(this,void 0)}handlePlayerActions(g){this._onGameActions.dispatch(this,g)}sayChannel(g){this.privmsg([V.RECIPIENT_ALL],g)}privmsg(g,P){if(!this.currentUser)throw new Error("Must login before sending messages");var I;P.length&&(I=g.join(","),this.con.sendMessage(`privmsg ${I} :`+P))}handlePrivMsg(g){var P=g.match(/^:([A-Za-z0-9-_]+) PRIVMSG ([A-Za-z0-9-_#']+) :(.*)/i);if(!P)throw new Error(`Unexpected PRIVMSG message format "${g}"`);var[,I,L,_]=P;let U;P=new Date,L===V.RECIPIENT_ALL?U={from:I,to:{type:K.ChatRecipientType.Channel,name:L},text:_,time:P}:L===this.currentUser&&(U={from:I,to:I===this.getServerName()?{type:K.ChatRecipientType.Page,name:L}:{type:K.ChatRecipientType.Channel,name:V.RECIPIENT_TEAM},text:_,time:P}),U&&this._onChatMessage.dispatch(this,U)}})}}}),System.register("network/GservError",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;I=class extends Error{constructor(g,P){super(g),this.code=P}},g("GservError",I),(P=(P=I||g("GservError",I={})).Code||(P.Code={}))[P.Unknown=0]="Unknown",P[P.OutdatedClient=1]="OutdatedClient",P[P.BadLogin=2]="BadLogin",P[P.TooManyLoginAttempts=3]="TooManyLoginAttempts",P[P.AlreadyLoggedIn=4]="AlreadyLoggedIn",P[P.InstanceNonExistent=5]="InstanceNonExistent",P[P.InstanceAlreadyExists=6]="InstanceAlreadyExists",P[P.InstanceNotAllowed=7]="InstanceNotAllowed",P[P.InstanceAlreadyStarted=8]="InstanceAlreadyStarted",P[P.InstanceVersMismatch=9]="InstanceVersMismatch",P[P.CreatedTooManyInstances=10]="CreatedTooManyInstances"}}}),System.register("network/HttpRequest",["@puzzl/core/lib/async/cancellation"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("HttpRequest",class{async fetchText(g,P,I){return await this.fetchAndParse({url:g,type:"text"},P,I)}async fetchBinary(g,P,I){return await this.fetchAndParse({url:g,type:"binary"},P,I)}async fetchJson(g,P,I){return await this.fetchAndParse({url:g,type:"json"},P,I)}async fetchHtml(g,P,I){return await this.fetchAndParse({url:g,type:"text"},P,{...I,allowHtmlMimeType:!0})}async fetchAndParse(g,P,I){var L=await this.fetchRaw(g.url,P,I);return this.parseResult(g.type,L)}async fetchRaw(g,P,_){let U,G=new AbortController;P?.register(()=>{try{G.abort()}catch(g){}});try{U=await fetch(g,{signal:G.signal,body:_?.body,method:_?.method,headers:_?.headers})}catch(g){if(G.signal.aborted||"AbortError"===g.name||g instanceof DOMException&&g.code===DOMException.ABORT_ERR)throw new I.OperationCanceledError(P);throw console.error(g),new L(`Fetch failed with error: ${g.name}:`+g.message)}if(!U.ok)throw new L(`Fetch failed with status ${U.status}:`+U.statusText,void 0,U.status);if("text/html"===U.headers.get("Content-Type")&&!_?.allowHtmlMimeType)throw new L(`Fetch failed with invalid mime type "text/html" (HTTP status ${U.status})`);let V=U.body.getReader(),W=0,z=[];for(var K,q=U.headers.get("Content-Encoding")?void 0:Number(U.headers.get("Content-Length")||0);;)try{var{done:$,value:Q}=await V.read();if($)break;z.push(Q),W+=Q.length,_?.onProgress?.(Q.length,q)}catch(g){if("AbortError"===g.name)throw new I.OperationCanceledError(P);throw console.error(g),new L(g.message)}let Y=new Uint8Array(W),Z=0;for(K of z)Y.set(K,Z),Z+=K.length;return Y}parseResult(g,P){if("binary"===g)return P;var I=new TextDecoder("utf-8").decode(P);return"json"===g?JSON.parse(I):I}}),L=class extends Error{constructor(g,P,I){super(g,P),this.statusCode=I}},g("DownloadError",L)}}}),System.register("network/IrcConnection",["@puzzl/core/lib/async/cancellation","util/event","util/Logger","util/string","util/time"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){0}],execute:function(){g("IrcConnection",G=class m{constructor(g,P){this.options=g,this.logger=P,this.timeout=5,this._onMessage=new L.EventDispatcher,this._onError=new L.EventDispatcher,this._onClose=new L.EventDispatcher,this.messageBuffer=""}get onMessage(){return this._onMessage.asEvent()}get onError(){return this._onError.asEvent()}get onClose(){return this._onClose.asEvent()}async connect(g,P){let L=P?.timeoutSeconds?setTimeout(()=>this.close(),1e3*P.timeoutSeconds):void 0;return P?.cancelToken?.register(()=>{L&&(clearTimeout(L),this.close())}),new Promise((L,_)=>{this.socket=new WebSocket(g),"arraybuffer"!==this.socket.binaryType&&(this.socket.binaryType="arraybuffer");let i=L=>{this.socket.removeEventListener("error",i),P?.cancelToken?.isCancelled()?_(new I.OperationCanceledError(P.cancelToken)):_(new m.ConnectError(`Connection to "${g}" failed`))};this.socket.addEventListener("open",()=>{this.socket.removeEventListener("error",i),this.socket.addEventListener("error",g=>this.handleError(g)),this.handleOpen(),L()}),this.socket.addEventListener("error",i),this.socket.addEventListener("close",g=>this.handleClose(g)),this.socket.addEventListener("message",g=>{g.data instanceof ArrayBuffer?this.handleMessage(new Uint8Array(g.data)):this.handleMessage(g.data)})}).finally(()=>{L&&clearTimeout(L)})}handleOpen(){this.logger.info("Connection open to "+this.socket.url)}handleError(g){this.logger.error("Connection error",g),this._onError.dispatch(this,g)}handleClose(g){this.logger.info(`Connection closed (${this.socket.url})`,g),this._onClose.dispatch(this,g)}handleMessage(g){if("string"!=typeof g){if(g[0]===this.options.binaryRplPrefix)return void this._onMessage.dispatch(this,g.slice(1));g=U.uint8ArrayToBinaryString(g)}this.logger.enabledFor(_.AppLogger.DEBUG)&&this.logger.debug("Got message:","string"==typeof g?this.options.logFilter?.(g)??g:g),g=this.messageBuffer+g,this.messageBuffer="";let P=g.split(/\r?\n/);var I=P.pop();I.length&&(this.messageBuffer=I),P.filter(g=>!!g).forEach(g=>this._onMessage.dispatch(this,g))}async sendCommand(g,P){if(P.replyStartCode&&!P.replyEndCode)throw new Error("Invalid argument. Expected a reply end code, but got only a start code.");let I=[];return await this.sendRawCommand(g,(g,L,_,G)=>{let o=(g,P)=>{if("number"==typeof g)return P.code===g;let[I,L]=g;return P.code===I&&L(P)};if("string"!=typeof g){if(g[0]===this.options.binaryRplPrefix)return!1;g=U.uint8ArrayToBinaryString(g)}return P.replyRawText?(_(g.split(/\r?\n/).map(g=>({raw:g,time:L}))),!0):g.split(/\r?\n/).filter(g=>!!g).some(g=>(g=>{if(P.replyMatch){if(P.replyMatch.exec(g))return _([{raw:g,time:L}]),!0;if(!P.replyCodes)return!1}if(!P.replyEndCode&&!P.replyCodes)return _([{raw:g,time:L}]),!0;var U,[,U,...V]=g.split(" ");let W={raw:g,code:U=parseInt(U,10),params:V,time:L};if(P.replyEndCode)return P.replyCodes&&P.replyCodes.some(g=>o(g,W))?(_([W]),!0):(P.replyHeartbeatCodes&&-1!==P.replyHeartbeatCodes.indexOf(U)&&G(P.heartbeatTimeout),(U===P.replyStartCode||P.replyBodyCodes&&-1!==P.replyBodyCodes.indexOf(U)||U===P.replyEndCode)&&I.push(W),U===P.replyEndCode&&(_(I),!0));if(void 0===P.replyCodes)throw new Error("List of replyCodes must be specified when not using start/end codes");return!!P.replyCodes.some(g=>o(g,W))&&(_([W]),!0)})(g))},P.timeout)}async sendBinCommand(g,P){const I=this.options.binaryRplPrefix;if(!I)throw new Error("Must configure binary message reply prefix to send binary commands");const L=this.options.binaryReqPrefix;if(!L)throw new Error("Must configure binary message request prefix to send binary commands");if(g[0]!==L)throw new Error("Binary command must start with the magic prefix 0x"+L.toString(16));return await this.sendRawCommand(g,(g,L,_)=>{if("string"==typeof g||g[0]!==I)return!1;var U=g[1];return-1!==P.replyCodes.indexOf(U)&&(_({code:U,data:g.slice(2),time:L}),!0)},P.timeout)}sendRawCommand(g,P,I){return new Promise((L,_)=>{let U,G=!1,s=g=>{clearTimeout(U),void 0!==g&&Number.isFinite(g)&&(U=setTimeout(o,1e3*(g??I??this.timeout)))},a=g=>{clearTimeout(U),L(g)},n=g=>{this.socket.removeEventListener("message",h),this.socket.removeEventListener("close",l),clearTimeout(U),U=void 0,_(g)},o=()=>{var P="string"==typeof g?this.options.logFilter?.(g)??g:"0x"+g[1].toString(16);n(new m.NoReplyError("Timeout reached for command "+P))},l=async()=>{V||n(new m.SocketError("Connection was closed prematurely"))},V=!1,h=g=>{var I;V||(I=Date.now(),g.data instanceof ArrayBuffer?V||P(new Uint8Array(g.data),I,a,s)&&(V=!0,this.socket.removeEventListener("message",h),this.socket.removeEventListener("close",l)):P(g.data,I,a,s)&&(V=!0,this.socket.removeEventListener("message",h),this.socket.removeEventListener("close",l)))};if(this.socket&&this.socket.readyState===WebSocket.OPEN){U=setTimeout(o,1e3*(I??this.timeout)),this.socket.addEventListener("message",h),this.socket.addEventListener("close",l);try{this.sendMessage(g)}catch(G){n(G)}}else n(new m.SocketError("Send command failed. Socket is not open."+(this.socket?` (readyState = ${this.socket.readyState})`:"")))})}sendMessage(g){if(!this.socket||this.socket.readyState!==WebSocket.OPEN)throw new m.SocketError("Socket is not open"+(this.socket?` (readyState = ${this.socket.readyState})`:""));let P;this.logger.enabledFor(_.AppLogger.DEBUG)&&this.logger.debug("Sent message:","string"==typeof g?this.options.logFilter?.(g)??g:g),"string"==typeof g&&(g+="\r\n"),P="binary"===this.options.mode&&"string"==typeof g?U.binaryStringToUint8Array(g):g,this.socket.send(P)}async ping(g){var P=Date.now();return(await this.sendCommand("ping :"+P,{replyMatch:new RegExp("^:[^ ]+ PONG [^ :]+ :"+P,"i"),timeout:g}))[0].time-P}close(){this.socket&&this.socket.close()}isOpen(){return this.socket&&this.socket.readyState===WebSocket.OPEN}}),function(g){class t extends Error{constructor(g){super(g)}}g.NoReplyError=t;class i extends Error{constructor(g){super(g)}}g.SocketError=i;class r extends Error{constructor(g){super(g)}}g.ConnectError=r}(G||g("IrcConnection",G={}))}}}),System.register("network/IrcProtocol",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){g("IrcProtocol",I=class{static escapeChannelName(g){return g.split("").map(g=>{switch(g){case" ":return"_";case"%":return"%%";case"_":return"%_";case"\b":return"%b";case"\n":return"%n";case"\r":return"%r";case":":return"%=";case",":return"%-";default:return g}}).join("")}static unescapeChannelName(g){var P=g.split("");let I="",L=0;for(;L<P.length;){var _,U=P[L++];let g;g="%"===U?"b"===(_=P[L++])?"\b":"n"===_?"\n":"r"===_?"\r":"="===_?":":"-"===_?",":_:"_"===U?" ":U,I+=g}return I}}),I.MAX_CHANNELNAME_LEN=30}}}),System.register("network/ladder/LadderHead",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("network/ladder/PagedResponse",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("network/ladder/PlayerLadderRung",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("network/ladder/PlayerMatchHistoryEntry",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("network/ladder/PlayerProfile",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("network/ladder/PlayerRankType",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("PlayerRankType",I={}))[P.None=0]="None",P[P.Private=1]="Private",P[P.Corporal=2]="Corporal",P[P.Sergeant=3]="Sergeant",P[P.Lieutenant=4]="Lieutenant",P[P.Major=5]="Major",P[P.Colonel=6]="Colonel",P[P.BrigGeneral=7]="BrigGeneral",P[P.General=8]="General",P[P.FiveStarGeneral=9]="FiveStarGeneral",P[P.CommanderInChief=10]="CommanderInChief"}}}),System.register("network/ladder/wladderConfig",[],function(g,P){"use strict";var I,L;return P&&P.id,g("getLadderTypeForQueueType",function(g,P){switch(g){case L.Solo1v1:return I.Solo1v1;case L.Team2v2:return I.Random2v2;default:throw new Error(`Unhandled queue type "${g}"`)}}),g("getQueueTypeForLadderType",function(g){switch(g){case I.Solo1v1:return L.Solo1v1;case I.Random2v2:return L.Team2v2;default:throw new Error(`Unhandled ladder type "${g}"`)}}),{setters:[],execute:function(){var P;g("CURRENT_SEASON","current"),g("PREV_SEASON","prev"),g("MAX_LIST_SEARCH_COUNT",50),(P=I||g("LadderType",I={})).Solo1v1="1v1",P.Random2v2="2v2-random",(P=L||g("LadderQueueType",L={})).Solo1v1="1v1",P.Team2v2="2v2",g("teamSizes",new Map([[L.Solo1v1,1],[L.Team2v2,2]]))}}}),System.register("network/ladder/WLadderService",["network/ladder/wladderConfig","network/HttpRequest"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){L=I=g},function(g){_=g}],execute:function(){g("WLadderService",U=class l{constructor(g){this.wolConfig=g}setUrl(g){this.url=g}getUrl(){return this.url}async getSeasons(g){if(!this.url)throw new Error("No ladder URL is set");var P=this.wolConfig.getClientSku();return await(new _.HttpRequest).fetchJson(this.url+"/"+P,g)}async getSeason(g,P,I){if(!this.url)throw new Error("No ladder URL is set");var L=this.wolConfig.getClientSku();return await(new _.HttpRequest).fetchJson(this.url+`/${L}/${g}?locale=`+P,I)}async listSearch(g,P,I=L.LadderType.Solo1v1,U=l.CURRENT_SEASON,G){if(!this.url)throw new Error("No ladder URL is set");var V=this.wolConfig.getClientSku();return await(new _.HttpRequest).fetchJson(this.url+`/${V}/${I}/${U}/listsearch`,P,{method:"POST",body:JSON.stringify({players:g,locale:G})})}async rungSearch(g,P,I,L,U,G){if(!this.url)throw new Error("No ladder URL is set");var V=this.wolConfig.getClientSku();return await(new _.HttpRequest).fetchJson(this.url+`/${V}/${I}/${L}/rungsearch`,G,{method:"POST",body:JSON.stringify({ladderId:U,start:g,count:P})})}}),U.CURRENT_SEASON=I.CURRENT_SEASON,U.PREV_SEASON=I.PREV_SEASON}}}),System.register("network/Logger",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("network/MapTransferService",["network/HttpRequest","util/Base64","@puzzl/core/lib/async/sleep","util/math"],function(g,P){"use strict";var I,L,_,U;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("MapTransferService",class{constructor(g){this.wolService=g}setUrl(g){this.url=g}getUrl(){return this.url}async putMap(g,P,L){if(!this.url)throw new Error("No MapTransfer URL is set");var G=this.makeAuthorizationHeader();let V,W=3;for(;W--;)try{return console.log("Uploading map...",W+" retries left"),L?.throwIfCancelled(),await(new I.HttpRequest).fetchRaw(this.url+"/"+P,L,{method:"PUT",body:g,headers:{authorization:G,"Content-Type":"application/octet-stream"}}),void console.log(`Map upload finished. (size=${g.byteLength})`)}catch(g){if(!(g instanceof I.DownloadError)||g.statusCode&&U.isBetween(g.statusCode,400,499))throw g;V=g,await _.sleep(1e3,L)}throw V}async getMap(g,P){if(!this.url)throw new Error("No MapTransfer URL is set");var L=this.makeAuthorizationHeader();let U,G=6;for(;G--;)try{console.log("Transferring map...",G+" retries left"),P?.throwIfCancelled();var V=await(new I.HttpRequest).fetchBinary(this.url+"/"+g,P,{headers:{authorization:L}});return console.log(`Map download finished. (size=${V.byteLength})`),V}catch(g){if(!(g instanceof I.DownloadError&&404===g.statusCode))throw g;U=g,await _.sleep(3e3,P)}throw U}makeAuthorizationHeader(){var g=this.wolService.getCredentials();if(!g)throw new Error("Missing WOL credentials");return L.Base64.encode(JSON.stringify({nick:g.user,pass:g.pass}))}})}}}),System.register("network/partyCodes",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("RPL_PARTY_INVITE","PARTY_INVITE"),g("RPL_PARTY_UPDATE","PARTY_UPDATE"),g("RPL_PARTY_INVITE_DECLINED","PARTY_INVITE_DECLINED"),g("RPL_PARTY_INVITE_DECLINED_SELF","PARTY_INVITE_DECLINED_SELF"),g("RPL_PARTY_INVITE_EXPIRED","PARTY_INVITE_EXPIRED"),g("RPL_PARTY_INVITE_SENT","PARTY_INVITE_SENT"),g("RPL_PARTY_FORMED","PARTY_FORMED"),g("RPL_PARTY_LEFT","PARTY_LEFT"),g("RPL_PARTY_INVITE_PREVENTION","PARTY_INVITE_PREVENTION"),g("RPL_PARTY_INVITE_ERROR","PARTY_INVITE_ERROR"),g("ERR_TARGET_IN_PARTY","TARGET_IN_PARTY"),g("ERR_TARGET_IN_QUEUE","TARGET_IN_QUEUE"),g("ERR_INVITER_IN_PARTY","INVITER_IN_PARTY"),g("ERR_ACCEPTER_IN_PARTY","ACCEPTER_IN_PARTY"),g("ERR_INVITE_PREVENTED","INVITE_PREVENTED"),g("ERR_TARGET_NO_INVITES","TARGET_NO_INVITES"),g("ERR_INVITE_ALREADY_PENDING","INVITE_ALREADY_PENDING"),g("ERR_NO_INVITE","NO_INVITE"),g("ERR_TARGET_NOT_IN_QUICK_MATCH","TARGET_NOT_IN_QUICK_MATCH"),g("ERR_TARGET_SELF","TARGET_SELF"),g("ERR_INVITER_FRESH_ACCOUNT","INVITER_FRESH_ACCOUNT")}}}),System.register("network/qmCodes",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("REQ_MATCH","Match"),g("REQ_STATS","Stats"),g("REQ_LIST_QUEUES","ListQueues"),g("RPL_WORKING","Working"),g("RPL_STATS","Stats"),g("RPL_QUEUE_LIST","QueueList"),g("RPL_BAD_VERS","Badvers"),g("RPL_BAD_HASH","Badhash"),g("RPL_MODE_UNAVAIL","Unavailable"),g("RPL_ALREADY_QUEUED","AlreadyQueued"),g("RPL_MATCHED","Matched"),g("RPL_REQUEUE","Requeue"),g("RPL_REMOVED_FROM_QUEUE","Removed"),g("TAG_COUNTRY","COU"),g("TAG_COLOR","COL"),g("TAG_RANKED","RKD"),g("TAG_VERSION","VRS"),g("TAG_MODHASH","MOD")}}}),System.register("network/ServerRegions",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("ServerRegions",class{constructor(){this.regions=new Map}load(g){for(var P of(this.regions.clear(),g.getOrderedSections())){var I=P.getString("protocolProfile")||"downstream",L=P.getBool("partyEnabled","cd-2026"===I||"ra2web-2026"===I||"party"===I);this.regions.set(P.name,{id:P.name,label:P.getString("label"),available:P.getBool("available",!0),gameVersion:this.normalizeVersion(P.getString("gameVersion")||void 0),wolUrl:P.getString("wolUrl"),apiRegUrl:P.getString("apiRegUrl"),wladderUrl:P.getString("wladderUrl")||void 0,wgameresUrl:P.getString("wgameresUrl")||void 0,mapTransferUrl:P.getString("mapTransferUrl")||void 0,leaderboardUrl:P.getString("leaderboardUrl")||void 0,protocolProfile:I,partyEnabled:L})}}normalizeVersion(g){return void 0!==g&&g.match(/^\d+\.\d+$/)&&(g+=".0"),g}get(g){if(!this.regions.has(g))throw new Error("Unknown region id "+g);return this.regions.get(g)}has(g){return this.regions.has(g)}isAvailable(g){return this.regions.has(g)&&this.regions.get(g).available}getAll(){return[...this.regions.values()]}getFirstAvailable(){return this.getAll().filter(g=>g.available)[0]}getSize(){return this.regions.size}setSelectedRegion(g){this.selectedRegion=this.get(g)}getSelectedRegion(){if(!this.selectedRegion)throw new Error("No server region selected");return this.selectedRegion}})}}}),System.register("network/WGameResService",["network/HttpRequest","util/Base64","util/string"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g}],execute:function(){g("WGameResService",class{constructor(g,P){this.wolService=g,this.wolConfig=P}setUrl(g){this.url=g}getUrl(){return this.url}async sendGameResPacket(g,P){if(!this.url)throw new Error("No WGameRes URL is set");var U=this.wolConfig.getClientSku(),G=this.wolService.getCredentials();if(!G)throw new Error("Missing WOL credentials");await(new I.HttpRequest).fetchRaw(this.url+"/"+U,P,{method:"POST",body:_.uint8ArrayToBase64String(g),headers:{authorization:L.Base64.encode(JSON.stringify({nick:G.user,pass:G.pass}))}})}})}}}),System.register("network/WolAccount",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("network/wolCodes",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("RPL_GET_LOCALE",309),g("RPL_SET_LOCALE",310),g("RPL_LISTSTART",321),g("RPL_LIST",322),g("RPL_CHANNELMODEIS",324),g("RPL_GAME_CHANNEL",326),g("RPL_CHANNEL",327),g("RPL_LISTEND",323),g("RPL_TOPIC",332),g("RPL_NAMREPLY",353),g("RPL_ENDOFNAMES",366),g("RPL_MOTD",372),g("RPL_MOTDSTART",375),g("RPL_ENDOFMOTD",376),g("RPL_BAD_LOGIN",378),g("ERR_UNKNOWNERROR",400),g("ERR_NOSUCHNICK",401),g("ERR_NOSUCHCHANNEL",403),g("ERR_UNKNOWNCOMMAND",421),g("ERR_USERNOTINCHANNEL",441),g("ERR_NOTONCHANNEL",442),g("ERR_NEEDMOREPARAMS",461),g("ERR_ALREADYREGISTERED",462),g("ERR_YOUREBANNEDCREEP",465),g("ERR_BADCHANNELKEY",475),g("ERR_GAMEHASCLOSED",478),g("ERR_CHANNELISFULL",471),g("ERR_UNKNOWNMODE",472),g("ERR_BANNEDFROMCHAN",474),g("ERR_CHANOPRIVSNEEDED",482),g("ERR_RESTRICTED",484),g("ERR_UMODEUNKNOWNFLAG",501),g("RPL_QUIT",607),g("RPL_CVERS_OK",700),g("RPL_CVERS_OUTDATED",701),g("ERR_CVERS_UNKNOWN",702),g("ERR_BAD_PARAMS",710),g("ERR_RATE_LIMIT_EXCEEDED",711),g("RPL_LOGIN_QUEUE",720),g("ERR_SERVER_FULL",721),g("RPL_GAME_REPORT",730),g("RPL_PARTY_UPDATE",731)}}}),System.register("network/WolConfig",["network/ladder/wladderConfig"],function(g,P){"use strict";var I,L,_;return P&&P.id,{setters:[function(g){I=g}],execute:function(){var P;g("MATCH_BOT_NAME","matchbot"),g("MIN_USERNAME_LEN",2),g("MAX_USERNAME_LEN",15),g("MIN_PASS_LEN",8),g("MAX_PASS_LEN",128),g("MAX_MAP_TRANSFER_BYTES",2097152),(P=L||g("ClientType",L={}))[P.Cdral2=0]="Cdral2",g("WolConfig",_=class n{static skuToClientType(g){return[...n.allClientSettings.entries()].find(([,P])=>P.sku===g)?.[0]}static factory(g){var P=n.allClientSettings.get(g);if(!P)throw new Error(`Unhandled client type "${L[g]}"`);return new this(g,P)}constructor(g,P){this.clientType=g,this.clientSettings=P}getClientSku(){return this.clientSettings.sku}getClientChannelType(){return this.clientSettings.channelType}getGlobalChannelPass(){return"zotclot9"}getQuickMatchBotName(){return"matchbot"}getAllQuickMatchChannelIds(){return[...this.clientSettings.qmChanIds.values()]}getQuickMatchChannelId(g){var P=this.clientSettings.qmChanIds.get(g);if(void 0===P)throw new Error(`Client type ${this.clientType} doesn't have a configured channel for ladder=`+g);return P}}),_.allClientSettings=(new Map).set(L.Cdral2,{sku:16640,channelType:45,qmChanIds:(new Map).set(I.LadderQueueType.Solo1v1,50).set(I.LadderQueueType.Team2v2,51)})}}}),System.register("network/WolConnection",["util/event","network/IrcConnection","network/WolError","util/string","util/Base64","util/typeGuard","network/gameopt/FileNameEncoder","network/chat/ChatMessage","network/wolCodes","network/IrcProtocol","network/WolLocale","network/WolConfig","network/gameopt/Parser","@puzzl/core/lib/regexp","network/WolGameReport"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g}],execute:function(){var P;(P=J||g("WolHasMapStatus",J={}))[P.NoMap=0]="NoMap",P[P.HasMap=1]="HasMap",P[P.MapTransfer=2]="MapTransfer",g("WolConnection",ee=class T{get onError(){return this.con.onError}get onClose(){return this.con.onClose}get onLoginQueueUpdate(){return this._onLoginQueueUpdate}get onChatMessage(){return this._onChatMessage}get onJoinChannel(){return this._onJoinChannel}get onLeaveChannel(){return this._onLeaveChannel}get onGameStart(){return this._onGameStart}get onGameOpt(){return this._onGameOpt}get onGameMode(){return this._onGameMode}get onGameServer(){return this._onGameServer}get onChannelUsers(){return this._onChannelUsers}get onGameReport(){return this._onGameReport}get onPartyUpdate(){return this._onPartyUpdate}static factory(g){return new this(new L.IrcConnection({mode:"text",logFilter:g=>g.replace(/((^|\n)(apgar|pass)) ([^ \n]+)/gi,"$1 <redacted>").replace(/^(join [^ ]+) ([^ ]+)/gi,"$1 <redacted>").replace(/^(joingame (([^ ]+ ){2}|([^ ]+ ){8}))([^ ]+)$/gi,"$1<redacted>").replace(/^((privmsg|page|notice) ([^ ]+ )+):(.+)\r?\n?$/i,(g,P,I,L)=>L===Q.MATCH_BOT_NAME+" "?g:P+":<redacted>").replace(/^(:([^ ]+) (privmsg|page|notice) ([^ ]+ )+):(.+)\r?\n?$/i,(g,P,I)=>I.startsWith(Q.MATCH_BOT_NAME+"!")?g:P+":<redacted>")},g),g)}constructor(g,P){this.con=g,this.logger=P,this.partyEnabled=!1,this.currentChannels=new Set,this.lastChannelOpts=new Map,this.pendingChannelUsers=new Map,this._onLoginQueueUpdate=new I.EventDispatcher,this._onChatMessage=new I.EventDispatcher,this._onJoinChannel=new I.EventDispatcher,this._onLeaveChannel=new I.EventDispatcher,this._onGameStart=new I.EventDispatcher,this._onGameOpt=new I.EventDispatcher,this._onGameMode=new I.EventDispatcher,this._onGameServer=new I.EventDispatcher,this._onChannelUsers=new I.EventDispatcher,this._onGameReport=new I.EventDispatcher,this._onPartyUpdate=new I.EventDispatcher,this.handleMessage=g=>{if("string"==typeof g){let L=g.split(" ");var P,I;"ping"===L[0].toLowerCase()?this.con.sendMessage("PONG"+(L[1]?" "+L[1]:"")):"privmsg"===L[1].toLowerCase()?this.handlePrivMsg(g):"page"===L[1].toLowerCase()||"notice"===L[1].toLowerCase()?this.handlePageOrNotice(g):"join"===L[1].toLowerCase()?this.handleJoin(g):"joingame"===L[1].toLowerCase()?this.handleJoingame(g):"part"===L[1].toLowerCase()?this.handlePart(g):"kick"===L[1].toLowerCase()?this.handleKick(g):"gameopt"===L[1].toLowerCase()?this.handleGameOpt(g):"mode"===L[1].toLowerCase()?this.handleMode(g):"startg"===L[1].toLowerCase()?this.handleStartGame(g):"gserv"===L[1].toLowerCase()?this.handleGserv(g):(P=Number(L[1]),Number.isNaN(P)||(I={raw:g,code:P,params:L.slice(2),time:Date.now()},P===K.RPL_LOGIN_QUEUE?this.handleLoginQueueUpdate(I):P===K.RPL_NAMREPLY?this.handleNamReply(I):P===K.RPL_ENDOFNAMES?this.handleEndOfNames(I):P===K.RPL_GAME_REPORT?this.handleGameReport(I):P===K.RPL_PARTY_UPDATE?this.handlePartyUpdate(g):this.handleIrcError(g)))}},this.handleClose=()=>{this.currentUser=void 0,this.currentGameChannel=void 0,this.currentChannels.clear(),this.pendingChannelUsers.clear(),this.con.onMessage.unsubscribe(this.handleMessage)}}getCurrentUser(){return this.currentUser}getCurrentChannels(){return[...this.currentChannels]}isInChannel(g){return this.currentChannels.has(g)}getServerName(){return this.serverName}setPartyEnabled(g){this.partyEnabled=!!g}async connect(g,P){return this.con.onMessage.subscribe(this.handleMessage),this.con.onClose.subscribeOnce(this.handleClose),await this.con.connect(g,P)}close(){this.con.onMessage.unsubscribe(this.handleMessage),this.con.close()}isOpen(){return this.con.isOpen()}ping(g){return this.con.ping(g)}async cvers(g,P){let I=await this.con.sendCommand(`cvers ${g} `+P,{replyCodes:[K.RPL_CVERS_OK,K.RPL_CVERS_OUTDATED]});if(I[0].code===K.RPL_CVERS_OUTDATED){var L=I[0].params?I[0].params.splice(1).join(" ").replace(/^:/,""):"unknown";throw new _.WolError("Cvers error: "+L,_.WolError.Code.OutdatedClient)}}async login(g,P,I){I&&this._onLoginQueueUpdate.subscribe(I);let L=await this.con.sendCommand(["pass "+G.Base64.encode(P),"nick "+g,"user UserName HostName irc.westwood.com :RealName"].join("\r\n"),{replyCodes:[K.RPL_BAD_LOGIN,K.ERR_YOUREBANNEDCREEP,K.ERR_SERVER_FULL],replyStartCode:K.RPL_MOTDSTART,replyBodyCodes:[K.RPL_MOTD],replyEndCode:K.RPL_ENDOFMOTD,replyHeartbeatCodes:[K.RPL_LOGIN_QUEUE],heartbeatTimeout:Number.POSITIVE_INFINITY}).finally(()=>{I&&this._onLoginQueueUpdate.unsubscribe(I)});if(1===L.length){var U=L[0].params?L[0].params.splice(2).join(" ").replace(/^:/,""):"unknown";if(L[0].code===K.RPL_BAD_LOGIN)throw new _.WolError("Login error: "+U,_.WolError.Code.BadLogin);if(L[0].code===K.ERR_YOUREBANNEDCREEP)throw new _.WolError("Login error: "+U,_.WolError.Code.BannedFromServer,U);if(L[0].code===K.ERR_SERVER_FULL)throw new _.WolError("Login error: "+U,_.WolError.Code.ServerFull)}return this.currentUser=g,this.serverName=L[0].raw.match(/^:([^\s]+)/)?.[1]||"",L.slice(0,-1).map(g=>g.raw.replace(/^.*:- /,""))}async setLocale(g){await this.con.sendCommand("setlocale "+g,{replyCodes:[K.RPL_SET_LOCALE]})}async getLocale(){if(!this.currentUser)throw new Error("Must login first");let g=await this.con.sendCommand("getlocale "+this.currentUser,{replyCodes:[K.RPL_GET_LOCALE]});return g[0].params?.[2].split("`")[1]??$.WolLocale.Unknown}async joinChannel(g,P){if(!this.currentUser)throw new Error("Must login before sending messages");let I=q.IrcProtocol.escapeChannelName(g);var L="join "+I+(void 0!==P?" "+P:"");L=await this.con.sendCommand(L,{replyCodes:[[K.ERR_NOSUCHCHANNEL,g=>!!g.params&&g.params[1]===this.currentUser&&g.params[2]===I],K.ERR_BADCHANNELKEY,K.ERR_CHANNELISFULL,K.ERR_BANNEDFROMCHAN],replyMatch:new RegExp(`^:${Z.escape(this.currentUser)}![^ ]+ JOIN :[^ ]+ ${Z.escape(I)}$`,"i")});if(void 0!==L[0].code)switch(L[0].code){case K.ERR_NOSUCHCHANNEL:throw new _.WolError("No such channel",_.WolError.Code.NoSuchChannel);case K.ERR_BADCHANNELKEY:throw new _.WolError("Wrong password",_.WolError.Code.BadChannelPass);case K.ERR_CHANNELISFULL:throw new _.WolError("Channel is full",_.WolError.Code.ChannelFull);case K.ERR_BANNEDFROMCHAN:throw new _.WolError("Banned from channel",_.WolError.Code.BannedFromChannel);default:throw new Error("Unknown error")}else this.lastChannelOpts.set(g,P)}async listUsers(g){let P=await this.con.sendCommand("NAMES "+q.IrcProtocol.escapeChannelName(g),{replyCodes:[K.ERR_NOSUCHCHANNEL,K.ERR_NOTONCHANNEL],replyBodyCodes:[K.RPL_NAMREPLY],replyEndCode:K.RPL_ENDOFNAMES});if(P[0].code!==K.RPL_NAMREPLY)throw new Error("Unknown error");return this.parseNames(P.slice(0,-1)).sort((g,P)=>Number(P.operator)-Number(g.operator))}async rejoinLastChannels(){if(this.lastChannelOpts)for(var[g,P]of this.lastChannelOpts)this.isInChannel(g)||await this.joinChannel(g,P)}sendChatMessage(g,P){if(!this.currentUser)throw new Error("Must login before sending messages");P.type!==z.ChatRecipientType.Channel&&P.type!==z.ChatRecipientType.Whisper||this.privmsg([P.name],g)}privmsg(g,P){if(!this.currentUser)throw new Error("Must login before sending messages");var I,L=g.map(g=>g.startsWith("#")?q.IrcProtocol.escapeChannelName(g):g).join(",");for(I of(this.con.sendMessage(`privmsg ${L} :`+P),g)){var _=I.startsWith("#");this._onChatMessage.dispatch(this,{from:this.currentUser,to:{type:_?z.ChatRecipientType.Channel:z.ChatRecipientType.Whisper,name:I},text:P,time:new Date})}}kick(g,P,I){this.con.sendMessage(`kick ${q.IrcProtocol.escapeChannelName(P)} ${g.join(",")} :`+(I||""))}partyInvite(g){this.partyEnabled&&this.con.sendMessage("PARTY_INVITE "+g)}partyAccept(g){this.partyEnabled&&this.con.sendMessage("PARTY_ACCEPT "+g)}partyDecline(g){this.partyEnabled&&this.con.sendMessage("PARTY_DECLINE "+g)}partyInviteUnavailable(g){this.partyEnabled&&this.con.sendMessage("PARTY_INVITE_UNAVAILABLE "+g)}partyLeave(){this.partyEnabled&&this.con.sendMessage("PARTY_LEAVE")}partyPrevent(g,P){this.partyEnabled&&this.con.sendMessage(`PARTY_PREVENT ${g} `+(P?"1":"0"))}partyStatus(){this.partyEnabled&&this.con.sendMessage("PARTY_STATUS")}partyNoInvites(g){this.partyEnabled&&this.con.sendMessage("PARTY_NOINVITES "+(g?"1":"0"))}async listGames(g,P){if(!this.currentUser)throw new Error("Must login before sending messages");return(await this.con.sendCommand(`list ${g} `+g,{replyStartCode:K.RPL_LISTSTART,replyBodyCodes:[K.RPL_LIST,K.RPL_GAME_CHANNEL],replyEndCode:K.RPL_LISTEND})).slice(1,-1).map(g=>{if(!g.params||g.params.length<9)throw new Error(`Unexpected reply for list command "${g.raw}". Insufficient params.`);let I=q.IrcProtocol.unescapeChannelName(g.params[1]);var L=g.params[2],_=Number(g.params[4]),U=g.params[5],G=g.params[6],V=g.params[7],[W,z]=g.params[8]?.split("::")??[],K=g.params[9];if(_===P&&z&&(z=(new Y.Parser).parseTopic(z)))return{hostName:I.match(/^#?([^']+)'s game$/)?.[1]??"",hostPing:Number(V),hostMuted:Boolean(Number(K)),name:I,description:z.description,modHash:z.modHash,modName:z.modName,tournament:Boolean(Number(U)),humanPlayers:Number(L),aiPlayers:z.aiPlayers,maxPlayers:z.maxPlayers,observers:z.observers,observable:z.observable,mapName:z.mapName,passLocked:384===Number(W),resLocked:Boolean(Number(G))}}).filter(V.isNotNullOrUndefined)}leaveChannel(g){this.currentChannels.has(g)&&(this.lastChannelOpts.delete(g),this.pendingChannelUsers.delete(g),this.con.sendMessage("PART "+q.IrcProtocol.escapeChannelName(g)))}leaveAllChannels(){for(var g of this.getCurrentChannels())this.leaveChannel(g)}async createGame(g,P,I,L,_,U,G=!1){if(!this.currentUser)throw new Error("Must login before sending messages");var V=q.IrcProtocol.escapeChannelName(g);await this.con.sendCommand(`joingame ${V} ${P} ${I} ${L} ${Number(G)} 0 ${Number(_)} 0`+(U?" "+U:""),{replyMatch:new RegExp(`^:${Z.escape(this.currentUser)}![^ ]+ JOINGAME [^:]+:${Z.escape(V)}$`,"i")}),this.logger.info(`Created game "${g}"`),this.currentChannels.add(g),this.currentGameChannel=g,this.logger.info(`Joined channel "${g}"`)}makeGameChannelName(){var g=this.getCurrentUser()+"'s game";g=q.IrcProtocol.escapeChannelName("#"+g).slice(0,q.IrcProtocol.MAX_CHANNELNAME_LEN-1);return q.IrcProtocol.unescapeChannelName(g)}async joinGame(g,P,I=!1){if(!this.currentUser)throw new Error("Must login before sending messages");var L=q.IrcProtocol.escapeChannelName(g);if(void 0===(L=await this.con.sendCommand(`joingame ${L} ${Number(I)} `+(P||""),{replyCodes:[K.ERR_BADCHANNELKEY,K.ERR_GAMEHASCLOSED,K.ERR_CHANNELISFULL,K.ERR_BANNEDFROMCHAN],replyMatch:new RegExp(`^:${Z.escape(this.currentUser)}![^ ]+ JOINGAME [^:]+:${Z.escape(L)}$`,"i")}))[0].code)return this.currentChannels.add(g),this.currentGameChannel=g,void this.logger.info(`Joined channel "${g}"`);switch(L[0].code){case K.ERR_BADCHANNELKEY:throw new _.WolError("Wrong password",_.WolError.Code.BadChannelPass);case K.ERR_GAMEHASCLOSED:throw new _.WolError("Game has closed",_.WolError.Code.GameHasClosed);case K.ERR_CHANNELISFULL:throw new _.WolError("Channel is full",_.WolError.Code.ChannelFull);case K.ERR_BANNEDFROMCHAN:throw new _.WolError("Banned from channel",_.WolError.Code.BannedFromChannel);default:throw new Error("Unknown error")}}sendGservPing(g,P){if(!this.currentGameChannel)throw new Error("No game channel active");var I=q.IrcProtocol.escapeChannelName(this.currentGameChannel);this.con.sendMessage(`gping ${I} ${g} `+Math.floor(P))}startGame(g){if(!this.currentGameChannel)throw new Error("No game channel active");var P=g.join(",");this.con.sendMessage(`startg ${q.IrcProtocol.escapeChannelName(this.currentGameChannel)} `+P)}parseNames(g){let P=[];return g.forEach(g=>{var I=this.parseNamReply(g);P=P.concat(I)}),P}parseNamReply(g){return g.raw.replace(new RegExp("^.*(=|\\*) [^ ]+ :"),"").split(" ").map(g=>g.split(",")).map(([g,,P,I])=>{var L=g.startsWith(T.CHAN_OP_PREFIX),_=Number(P);return{name:L?g.slice(T.CHAN_OP_PREFIX.length):g,operator:L,fresh:Boolean(Number(I)),ping:_}})}sendPlayerReady(g){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(this.currentGameChannel,"A"+(g?1:0))}sendPlayerHasMap(g){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(this.currentGameChannel,"K"+g)}sendGameStartRequest(){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(this.currentGameChannel,"G")}sendGameSlotsInfo(g){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(this.currentGameChannel,"L"+g)}sendPingData(g){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(this.currentGameChannel,"P"+g)}sendObserverSlot(g){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(this.currentGameChannel,"O"+g)}sendGameOpts(g){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(this.currentGameChannel,g)}sendPlayerOpts(g,P,I,L,_){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(g,`R${P},${I},${L},${_},0,0,0`)}sendModeChannelMax(g,P){this.con.sendMessage(`MODE ${q.IrcProtocol.escapeChannelName(g)} +l `+P)}sendGameTopic(g,P,I,L,_,V,z,K,$){if(!this.currentGameChannel)throw new Error("No game channel active");var Q=(new W.FileNameEncoder).encode(V),Y=G.Base64.encode(U.utf16ToBinaryString(K.slice(0,T.MAX_ROOM_DESC_LEN-1))),Z=void 0!==$?G.Base64.encode(U.utf16ToBinaryString($.slice(0,T.MAX_ROOM_DESC_LEN-1))):"",X=q.IrcProtocol.escapeChannelName(this.currentGameChannel);this.con.sendMessage(`topic ${X} :g${g}${P}N39,`+z+`,${I},${L},${_?1:0},`+Q+`,${Y},`+Z)}gameOpt(g,P){if(!this.currentUser)throw new Error("Must login first");if(!this.currentGameChannel)throw new Error("No game channel active");var I=g.startsWith("#")?q.IrcProtocol.escapeChannelName(g):g;this.con.sendMessage(`gameopt ${I} :`+P),this._onGameOpt.dispatch(this,{user:this.currentUser,opt:P})}handleJoin(g){if(!(U=g.match(/^:([A-Za-z0-9-_]+)![^ ]+ JOIN :([^ ]+) ([^ ]+)/i)))throw new Error(`Unexpected JOIN message format "${g}"`);let[,P,I,L]=U;var _=I.trim().split(","),U=q.IrcProtocol.unescapeChannelName(L);this.currentUser===P&&(this.currentChannels.add(U),this.logger.info(`Joined channel "${U}"`)),this._onJoinChannel.dispatch(this,{type:"join",user:{name:P,ping:Number(_[1]),operator:Boolean(Number(_[2])),fresh:Boolean(Number(_[3]))},channel:U})}handleJoingame(g){var P=g.match(/^:([A-Za-z0-9-_]+)![^ ]+ JOINGAME ([^:]+):([^ ]+)/i);if(!P)throw new Error(`Unexpected JOINGAME message format "${g}"`);let[,I,L,_]=P;P=L.trim().split(" "),_=q.IrcProtocol.unescapeChannelName(_),I!==this.currentUser&&this.logger.info(`Player "${I}" joined game "${_}"`),this._onJoinChannel.dispatch(this,{type:"join",user:{name:I,operator:!1,ping:Number(P[5]),fresh:Boolean(Number(P[6]))},channel:_})}handleStartGame(g){var P;if(!(P=g.match(/^:[^ ]+ STARTG [^:]+:([^ ]+) :([^ ]+) (\d+)/i)))throw new Error(`Unexpected STARTG message format "${g}"`);var[,I,L,P]=P;this._onGameStart.dispatch(this,{gameId:L,timestamp:Number(P),gservUrl:I})}handleGserv(g){var P;if(!(P=g.match(/^[^ ]+ GSERV [^:]+:([^ ]+) ([^ ]+)/i)))throw new Error(`Unexpected GSERV message format "${g}"`);var[,I,P]=P;this._onGameServer.dispatch(this,{id:I,url:P})}handlePrivMsg(g){var P=g.match(/^:([A-Za-z0-9-_]+)![^ ]+ PRIVMSG ([^ ]+) :(.*)/i);if(!P)throw new Error(`Unexpected PRIVMSG message format "${g}"`);let I,[,L,_,U]=P;P=new Date,_.startsWith("#")?I={from:L,to:{type:z.ChatRecipientType.Channel,name:q.IrcProtocol.unescapeChannelName(_)},text:U,time:P}:_===this.currentUser&&(I={from:L,to:{type:z.ChatRecipientType.Whisper,name:_},text:U,time:P}),I&&this._onChatMessage.dispatch(this,I)}handleLoginQueueUpdate(g){if(!g.params)throw new Error("Unexpected queue update reply "+g.raw);let[,P,I]=g.params;this._onLoginQueueUpdate.dispatch(this,{position:Number(P.slice(1)),avgWaitSeconds:I?Number(I):0})}handlePartyUpdate(g){if(!this.partyEnabled)return;const P=g.split(" ").slice(3).join(" ");var I=P.startsWith(":")?P.slice(1):P;I&&this._onPartyUpdate.dispatch(this,I)}handleNamReply(g){if(!g.params)throw new Error(`Missing NAMREPLY params: "${g.raw}"`);var P=q.IrcProtocol.unescapeChannelName(g.params[2]),I=this.parseNamReply(g);let L=this.pendingChannelUsers.get(P);L?L.push(...I):this.pendingChannelUsers.set(P,I)}handleEndOfNames(g){if(!g.params)throw new Error(`Missing ENDOFNAMES params: "${g.raw}"`);var P=q.IrcProtocol.unescapeChannelName(g.params[1]);let I=this.pendingChannelUsers.get(P)??[];I.sort((g,P)=>Number(P.operator)-Number(g.operator)),this.pendingChannelUsers.delete(P),this._onChannelUsers.dispatch(this,{channelName:P,users:I})}handleGameReport(g){if(!g.params)throw new Error(`Missing GAME_REPORT params: "${g.raw}"`);if(g.params.length<2)throw new Error("Insufficient number of params for GAME_REPORT: "+g.params.length);var P=new X.WolGameReport(g.params[1].slice(1));this._onGameReport.dispatch(this,P)}handleIrcError(g){var P;if(P=g.match(/^:([A-Za-z0-9-_]+) (\d+) ([^ ]+) (?:([^ ]*) )?:(.*)/i)){var[,I,L,_,,P]=P;if([K.ERR_NOSUCHNICK,K.ERR_NOSUCHCHANNEL,K.ERR_NOTONCHANNEL,K.ERR_CHANOPRIVSNEEDED].includes(Number(L))){let g;_===this.currentUser&&(g={from:I,to:{type:z.ChatRecipientType.Page,name:_},text:P,time:new Date}),g&&this._onChatMessage.dispatch(this,g)}}}handlePageOrNotice(g){var P;if(!(P=g.match(/^:([A-Za-z0-9-_]+)(?:![^ ]+)? (?:PAGE|NOTICE) ([^ ]+) :(.*)/i)))throw new Error(`Unexpected PAGE message format "${g}"`);var[,I,L,P]=P,L={text:P,from:I,to:{type:z.ChatRecipientType.Page,name:L},time:new Date};this._onChatMessage.dispatch(this,L)}handlePart(g){if(!(I=g.match(/^:([A-Za-z0-9-_]+)![^ ]+ PART ([^ ]+)/i)))throw new Error(`Unexpected PART message format "${g}"`);var[,P,I]=I,I=q.IrcProtocol.unescapeChannelName(I);P===this.currentUser?(I===this.currentGameChannel&&(this.currentGameChannel=void 0),this.currentChannels.delete(I),this.lastChannelOpts.delete(I),this.pendingChannelUsers.delete(I),this.logger.info(`Left channel "${I}"`)):I===this.currentGameChannel&&this.logger.info(`Player "${P}" left game "${I}"`),this._onLeaveChannel.dispatch(this,{type:"leave",user:{name:P},channel:I})}handleKick(g){var P;if(!(P=g.match(/^:([A-Za-z0-9-_]+)![^ ]+ KICK ([^ ]+) ([A-Za-z0-9-_]+)/i)))throw new Error(`Unexpected KICK message format "${g}"`);var[,,I,P]=P,I=q.IrcProtocol.unescapeChannelName(I);P===this.currentUser&&(I===this.currentGameChannel&&(this.currentGameChannel=void 0),this.currentChannels.delete(I),this.lastChannelOpts.delete(I),this.pendingChannelUsers.delete(I),this.logger.info(`Left channel "${I}"`)),this._onLeaveChannel.dispatch(this,{type:"leave",user:{name:P},channel:I})}handleGameOpt(g){var P;if(!(P=g.match(/^:([A-Za-z0-9-_]+)![^ ]+ GAMEOPT ([^ ]+) :(.*)/i)))throw new Error(`Unexpected GAMEOPT message format"${g}"`);var[,I,,P]=P;this._onGameOpt.dispatch(this,{user:I,opt:P})}handleMode(g){var P=g.match(/^:([A-Za-z0-9-_]+)![^ ]+ MODE ([^ ]+) \+l (\d+)/i);P?([,,,P]=P,this._onGameMode.dispatch(this,Number(P))):this.logger.warn("Got unknown MODE line: "+g)}}),ee.MAX_ROOM_DESC_LEN=64,ee.CHAN_OP_PREFIX="@"}}}),System.register("network/WolConnectOptions",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("network/WolError",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;I=class extends Error{constructor(g,P,I){super(g),this.code=P,this.reason=I}},g("WolError",I),(P=(P=I||g("WolError",I={})).Code||(P.Code={}))[P.OutdatedClient=0]="OutdatedClient",P[P.BadLogin=1]="BadLogin",P[P.BadChannelPass=2]="BadChannelPass",P[P.GameHasClosed=3]="GameHasClosed",P[P.ChannelFull=4]="ChannelFull",P[P.BannedFromChannel=5]="BannedFromChannel",P[P.BannedFromServer=6]="BannedFromServer",P[P.NoSuchChannel=7]="NoSuchChannel",P[P.ServerFull=8]="ServerFull"}}}),System.register("network/WolGameReport",["util/Base64"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){var P;(P=L||g("WolGameReportResult",L={}))[P.Win=0]="Win",P[P.Loss=1]="Loss",P[P.Draw=2]="Draw",g("WolGameReport",class{constructor(g){var P=JSON.parse(I.Base64.decode(g));return this.gameId=P.gameId,this.players=P.players,this.duration=P.duration,this}})}}}),System.register("network/WolLocale",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){var P;(P=I||g("WolLocale",I={}))[P.Unknown=0]="Unknown",P[P.Other=1]="Other",P[P.Usa=2]="Usa",P[P.Canada=3]="Canada",P[P.Uk=4]="Uk",P[P.Germany=5]="Germany",P[P.France=6]="France",P[P.Spain=7]="Spain",P[P.Netherlands=8]="Netherlands",P[P.Belgium=9]="Belgium",P[P.Austria=10]="Austria",P[P.Switzerland=11]="Switzerland",P[P.Italy=12]="Italy",P[P.Denmark=13]="Denmark",P[P.Sweden=14]="Sweden",P[P.Norway=15]="Norway",P[P.Finland=16]="Finland",P[P.Israel=17]="Israel",P[P.SouthAfrica=18]="SouthAfrica",P[P.Japan=19]="Japan",P[P.SouthKorea=20]="SouthKorea",P[P.China=21]="China",P[P.Singapore=22]="Singapore",P[P.Taiwan=23]="Taiwan",P[P.Malaysia=24]="Malaysia",P[P.Australia=25]="Australia",P[P.NewZealand=26]="NewZealand",P[P.Brazil=27]="Brazil",P[P.Thailand=28]="Thailand",P[P.Argentina=29]="Argentina",P[P.Philippines=30]="Philippines",P[P.Greece=31]="Greece",P[P.Ireland=32]="Ireland",P[P.Poland=33]="Poland",P[P.Portugal=34]="Portugal",P[P.Mexico=35]="Mexico",P[P.Russia=36]="Russia",P[P.Turkey=37]="Turkey",g("localeCodeMap",(new Map).set("en-US",I.Usa).set("en-GB",I.Uk).set("de-DE",I.Germany).set("es-ES",I.Spain).set("fr-FR",I.France).set("it-IT",I.Italy).set("ja-JP",I.Japan).set("ko-KR",I.SouthKorea).set("nl-NL",I.Netherlands).set("pl-PL",I.Poland).set("pt-BR",I.Brazil).set("pt-PT",I.Portugal).set("ru-RU",I.Russia).set("zh-CN",I.China).set("zh-TW",I.Taiwan))}}}),System.register("network/WolService",["util/event","engine/ResourceLoader","data/IniFile","network/WolError","network/WolLocale","network/IrcConnection"],function(g,P){"use strict";var I,L,_,U,G,V,W;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g}],execute:function(){g("WolService",W=class h{get onWolConnectionLost(){return this._onWolConnectionLost.asEvent()}constructor(g,P,L,_){this.wolConfig=g,this.wolCon=P,this.clientVersion=L,this.clientLocale=_,this.ignoreLastWolClose=!1,this._onWolConnectionLost=new I.EventDispatcher,this.autoReconnect=!1,this.pendingReconnect=!1,this.onWolClose=g=>{this.connectOpts&&!this.ignoreLastWolClose&&(this.autoReconnect&&!this.pendingReconnect&&(this.reconnectTimeout=setTimeout(()=>this.tryReconnect(h.MIN_RECONNECT_MILLIS),0)),this._onWolConnectionLost.dispatch(this,g)),this.ignoreLastWolClose=!1},this.onGameReport=g=>{this.lastGameReport=g}}init(){this.wolCon.onGameReport.subscribe(this.onGameReport),this.wolCon.onClose.subscribe(this.onWolClose)}getConfig(){return this.wolConfig}getConnection(){return this.wolCon}isConnected(){return this.wolCon.isOpen()}getCredentials(){return this.connectOpts?{user:this.connectOpts.user,pass:this.connectOpts.pass}:void 0}getLastGameReport(){return this.lastGameReport}async connectAndLogin(g,P){var I,{url:L,user:_,pass:W}=g;this.cancelReconnect(),this.wolCon.isOpen()&&JSON.stringify(this.connectOpts)!==JSON.stringify(g)&&this.closeWolConnection(),this.connectOpts=g,this.ignoreLastWolClose=!0;try{await this.wolCon.connect(L),await this.wolCon.cvers(this.clientVersion,this.wolConfig.getClientSku()),void 0===this.clientLocale||void 0!==(I=G.localeCodeMap.get(this.clientLocale))&&await this.wolCon.setLocale(I);let g=await this.wolCon.login(_,W,P);return this.ignoreLastWolClose=!1,g.map(g=>({text:g}))}catch(g){throw g instanceof U.WolError||g instanceof V.IrcConnection.ConnectError||g instanceof V.IrcConnection.SocketError||(this.ignoreLastWolClose=!1),g}}async loadServerList(g,P){let I=new L.ResourceLoader("");var U=await I.loadText(g,P);return(new _.IniFile).fromString(U)}async validateGameVersion(g){if(g.gameVersion&&!this.matchVersions(this.clientVersion,g.gameVersion))throw new U.WolError(`Game version mismatch: client version is ${this.clientVersion}, but expected `+g.gameVersion,U.WolError.Code.OutdatedClient)}matchVersions(g,P){let[I,L,_]=g.split(".");var[U,G,V]=P.split(".");return I===U&&L===G&&Number(_.split("-")[0])>=Number(V)}async tryReconnect(g){if(this.connectOpts&&!this.pendingReconnect)try{this.pendingReconnect=!0,await this.connectAndLogin(this.connectOpts),await this.wolCon.rejoinLastChannels()}catch(P){if(P instanceof U.WolError)console.error("Failed to reconnect to WoL service",P);else{let P=Math.min(h.MAX_RECONNECT_MILLIS,2*g);this.reconnectTimeout=setTimeout(()=>this.tryReconnect(P),g)}}finally{this.pendingReconnect=!1}}setAutoReconnect(g){g!==this.autoReconnect&&((this.autoReconnect=g)||this.cancelReconnect())}closeWolConnection(){this.cancelReconnect(),this.wolCon.isOpen()&&(this.connectOpts=void 0,this.ignoreLastWolClose=!0,this.wolCon.leaveAllChannels(),this.wolCon.close())}dispose(){this.cancelReconnect(),this.wolCon.onGameReport.unsubscribe(this.onGameReport),this.wolCon.onClose.unsubscribe(this.onWolClose)}cancelReconnect(){this.pendingReconnect&&this.wolCon.close(),this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0)}}),W.MIN_RECONNECT_MILLIS=5e3,W.MAX_RECONNECT_MILLIS=6e4}}}),System.register("RouteHelper",["util/Base64"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("RouteHelper",L=class{static getGameRoute(g){return"#/game/"+I.Base64.encode(JSON.stringify({gameId:g.gameId,gameTimestamp:g.gameTimestamp,gservUrl:g.gservUrl,playerName:g.playerName,gameOpts:g.gameOpts,tournament:g.tournament}))}static extractGameParams(g){return JSON.parse(I.Base64.decode(g))}}),L.modQueryStringName="mod"}}}),System.register("tools/AircraftTester",["engine/gfx/Renderer","engine/Engine","game/Coords","engine/IsoCoords","game/Player","engine/renderable/WorldScene","game/rules/Rules","engine/renderable/entity/map/MapGrid","util/BoxedVar","engine/UiAnimationLoop","engine/ImageFinder","game/art/Art","engine/renderable/entity/RenderableFactory","engine/TheaterType","game/Alliances","game/PlayerList","game/gameobject/selection/SelectionLevel","game/gameobject/unit/VeteranLevel","gui/PointerEvents","util/disposable/CompositeDisposable","game/gameobject/selection/UnitSelection","tools/CameraZoomControls","engine/Lighting","game/gameobject/ObjectFactory","game/map/TileCollection","engine/type/ObjectType","game/gameobject/trait/MoveTrait","game/map/TileOccupation","game/map/Bridges","engine/RenderableManager","game/World","data/Strings","game/map/MapBounds","engine/renderable/entity/unit/FlyerHelperMode","engine/gfx/lighting/LightingDirector","engine/renderable/builder/VxlBuilderFactory","engine/renderable/builder/vxlGeometry/VxlGeometryPool","engine/gfx/geometry/VxlGeometryCache","engine/renderable/entity/unit/ShadowQuality","gui/CanvasMetrics","game/gameobject/unit/ZoneType","util/math"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be,Se,we,Ee,Ce,xe,Oe,Ae;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g},function(g){ce=g},function(g){he=g},function(g){ue=g},function(g){de=g},function(g){ge=g},function(g){pe=g},function(g){me=g},function(g){fe=g},function(g){ye=g},function(g){Te=g},function(g){ve=g},function(g){be=g},function(g){Se=g},function(g){we=g},function(g){Ee=g},function(g){Ce=g},function(g){xe=g},function(g){Oe=g}],execute:function(){g("AircraftTester",Ae=class{static async main(g){let P=this.renderer=new I.Renderer(800,600);P.init(document.body),P.initStats(document.body);let _=V.WorldScene.factory({x:0,y:0,width:800,height:600},new K.BoxedVar(!0),new K.BoxedVar(Ee.ShadowQuality.High));this.disposables.add(_),_.scene.background=new THREE.Color(12632256),U.IsoCoords.init({x:0,y:0}),this.theater=await L.Engine.loadTheater(Z.TheaterType.Temperate);var G=new W.Rules(L.Engine.getRules());this.rules=G,this.art=new Q.Art(G,L.Engine.getArt()),this.images=L.Engine.getImages(),this.voxels=L.Engine.getVoxels(),this.voxelAnims=L.Engine.getVoxelAnims(),this.buildBrowser(G.aircraftRules);let z=new Ce.CanvasMetrics(P.getCanvas(),window);z.init(),this.disposables.add(z),G=new re.PointerEvents(P,{x:0,y:0},document,z);let $=new ne.CameraZoomControls(G,_.cameraZoom);$.init(),this.disposables.add(G,$),P.addScene(_),(this.uiAnimationLoop=new q.UiAnimationLoop(P)).start(),this.worldScene=_,this.vxlGeometryPool=new Se.VxlGeometryPool(new we.VxlGeometryCache),this.addGrid(),this.createFloor()}static addGrid(){var g=new z.MapGrid({width:10,height:10}).get3DObject();let P=new THREE.Object3D;P.add(g),this.worldScene.scene.add(P)}static createFloor(){var g=new THREE.PlaneGeometry(1e4,1e4);let P=new THREE.ShadowMaterial;P.opacity=.5;let I=new THREE.Mesh(g,P);I.rotation.x=-Math.PI/2,I.receiveShadow=!0,I.renderOrder=2e5,this.worldScene.scene.add(I)}static selectAircraft(g){this.currentAircraft&&(this.world.removeObject(this.currentAircraft),this.currentAircraft.dispose());let P=new G.Player("Player");this.disposables.add(P),P.color=this.rules.getMultiplayerColors().get("DarkRed");var I=new X.Alliances(new J.PlayerList),_=new ae.UnitSelection,U=new oe.Lighting;this.disposables.add(U);var V=new Y.RenderableFactory(new K.BoxedVar(P),_,I,this.rules,this.art,void 0,new $.ImageFinder(this.images,this.theater),L.Engine.getPalettes(),this.voxels,this.voxelAnims,this.theater,this.worldScene.camera,U,new ve.LightingDirector(U,this.renderer,new K.BoxedVar(1)),new K.BoxedVar(!1),new K.BoxedVar(!1),new K.BoxedVar(2),void 0,new fe.Strings,new K.BoxedVar(Te.FlyerHelperMode.Selected),new K.BoxedVar(!1),new be.VxlBuilderFactory(this.vxlGeometryPool,!1,this.worldScene.camera),new Map);_=new ce.TileCollection([],null,this.rules.general,Oe.getRandomInt),I=new de.TileOccupation(_),U=new ye.MapBounds,U=new ge.Bridges(this.theater.tileSets,_,I,U,this.rules);let W=this.currentAircraft=new le.ObjectFactory(_,I,U,new K.BoxedVar(0)).create(he.ObjectType.Aircraft,g,this.rules,this.art);W.owner=P,W.position.tile={rx:1,ry:1,z:0,rampType:0};let z=this.world=new me.World,q=new pe.RenderableManager(z,this.worldScene,this.worldScene.camera,V);q.init(),this.disposables.add(q),z.spawnObject(W);let Q=this.currentRenderable=q.getRenderableByGameObject(W);Q.selectionModel.setSelectionLevel(ee.SelectionLevel.None),Q.selectionModel.setControlGroupNumber(3),this.buildControls()}static buildControls(){this.controlsEl&&document.body.removeChild(this.controlsEl);let g=this.controlsEl=document.createElement("div");g.style.position="absolute",g.style.left="0",g.style.top="0",g.style.width="200px",g.style.padding="5px",g.style.background="rgba(255, 255, 255, 0.5)",g.style.border="1px black solid",g.appendChild(document.createTextNode("Remap color:"));let P=this.rules.getMultiplayerColors(),I=document.createElement("select");I.style.display="block",I.addEventListener("change",()=>{this.currentAircraft.owner.color=P.get(I.value)}),g.appendChild(I),P.forEach((g,P)=>{let L=document.createElement("option");L.innerHTML=P,L.value=P,L.selected=g.asHex()===this.currentAircraft.owner.color.asHex(),I.appendChild(L)}),g.appendChild(document.createTextNode("Selection level:"));let L=document.createElement("div");g.appendChild(L),[ee.SelectionLevel.None,ee.SelectionLevel.Hover,ee.SelectionLevel.Selected].forEach(g=>{let P=document.createElement("button");P.innerHTML=ee.SelectionLevel[g],P.disabled=!this.currentAircraft.rules.selectable,P.addEventListener("click",()=>this.currentRenderable.selectionModel.setSelectionLevel(g)),L.appendChild(P)}),g.appendChild(document.createTextNode("Veteran level:"));let U=document.createElement("div");g.appendChild(U),this.currentAircraft.veteranTrait&&[te.VeteranLevel.None,te.VeteranLevel.Veteran,te.VeteranLevel.Elite].forEach(g=>{let P=document.createElement("button");P.innerHTML=te.VeteranLevel[g],P.addEventListener("click",()=>this.currentAircraft.veteranTrait.veteranLevel=g),U.appendChild(P)}),g.appendChild(document.createTextNode("Rudder:"));let G=document.createElement("input");G.style.display="block",G.type="range",G.min="-180",G.max="180",G.value="0",G.addEventListener("input",()=>{this.currentAircraft.yaw=Number(G.value)}),g.appendChild(G);let V=document.createElement("input");V.style.display="block",V.type="range",V.min="-180",V.max="180",V.value="0",V.addEventListener("input",()=>{this.currentAircraft.pitch=Number(V.value)}),g.appendChild(V);let W=document.createElement("input");W.style.display="block",W.type="range",W.min="-180",W.max="180",W.value="0",W.addEventListener("input",()=>{this.currentAircraft.roll=Number(W.value)}),g.appendChild(W),g.appendChild(document.createTextNode("Height:"));let z=document.createElement("input");z.type="range",z.min="0",z.max="2560",z.value="0",z.style.display="block",z.addEventListener("input",()=>{this.currentAircraft.position.tileElevation=_.Coords.worldToTileHeight(Number(z.value))}),g.appendChild(z),g.appendChild(document.createTextNode("isMoving:"));let K=document.createElement("input");K.type="checkbox",K.style.display="block",K.addEventListener("change",g=>{var P=g.target.checked;this.currentAircraft.moveTrait.moveState=P?ue.MoveState.Moving:ue.MoveState.Idle,this.currentAircraft.zone=P?xe.ZoneType.Air:xe.ZoneType.Ground}),g.appendChild(K),g.appendChild(document.createTextNode("Warped out:"));let q=document.createElement("input");q.type="checkbox",q.style.display="block",q.addEventListener("change",g=>{this.currentAircraft.warpedOutTrait.debugSetActive(g.target.checked)}),g.appendChild(q);let $=document.createElement("button");$.style.display="block",$.style.color="red",$.innerHTML="DESTROY",$.addEventListener("click",async()=>{this.currentAircraft.isDestroyed=!0,this.world.removeObject(this.currentAircraft),this.currentAircraft.dispose(),this.currentAircraft=void 0,document.body.removeChild(this.controlsEl),this.controlsEl=void 0}),g.appendChild($),document.body.appendChild(g)}static buildBrowser(g){let P=this.listEl=document.createElement("div");P.style.position="absolute",P.style.right="0",P.style.top="0",P.style.height="600px",P.style.width="200px",P.style.overflowY="auto",P.style.padding="5px",P.style.background="rgba(255, 255, 255, 0.5)",P.style.border="1px black solid",P.appendChild(document.createTextNode("Aircraft types:"));let I=[...g.keys()].filter(g=>this.art.hasObject(g,he.ObjectType.Aircraft)).sort();I.forEach(g=>{let I=document.createElement("a");I.style.display="block",I.textContent=g,I.setAttribute("href","javascript:;"),I.addEventListener("click",()=>{console.log("Selected aircraft",g),this.selectAircraft(g)}),P.appendChild(I)}),document.body.appendChild(P),setTimeout(()=>{this.selectAircraft(I[0])},50)}static destroy(){this.renderer.destroy(),this.uiAnimationLoop.destroy(),this.listEl.remove(),this.controlsEl&&(this.controlsEl.remove(),this.controlsEl=void 0),this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=void 0),this.disposables.dispose()}}),Ae.disposables=new se.CompositeDisposable}}}),System.register("tools/BuildingTester",["engine/gfx/Renderer","engine/Engine","engine/IsoCoords","engine/TheaterType","game/Player","engine/renderable/entity/building/DamageType","engine/renderable/entity/building/AnimationType","engine/renderable/WorldScene","game/rules/Rules","engine/renderable/entity/map/MapGrid","util/BoxedVar","engine/UiAnimationLoop","engine/ImageFinder","game/art/Art","engine/renderable/entity/RenderableFactory","util/Color","game/gameobject/selection/SelectionLevel","game/Alliances","game/PlayerList","game/gameobject/ObjectFactory","engine/type/ObjectType","gui/PointerEvents","util/disposable/CompositeDisposable","game/gameobject/selection/UnitSelection","tools/CameraZoomControls","game/gameobject/Infantry","engine/Lighting","game/map/TileCollection","game/map/TileOccupation","game/map/Bridges","data/Strings","game/gameobject/trait/AutoRepairTrait","game/map/MapBounds","engine/renderable/entity/unit/FlyerHelperMode","engine/gfx/lighting/LightingDirector","game/World","engine/RenderableManager","engine/renderable/builder/VxlBuilderFactory","engine/renderable/builder/vxlGeometry/VxlGeometryPool","engine/gfx/geometry/VxlGeometryCache","engine/renderable/entity/unit/ShadowQuality","gui/CanvasMetrics","util/math"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be,Se,we,Ee,Ce,xe,Oe,Ae,Me;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g},function(g){ce=g},function(g){he=g},function(g){ue=g},function(g){de=g},function(g){ge=g},function(g){pe=g},function(g){me=g},function(g){fe=g},function(g){ye=g},function(g){Te=g},function(g){ve=g},function(g){be=g},function(g){Se=g},function(g){we=g},function(g){Ee=g},function(g){Ce=g},function(g){xe=g},function(g){Oe=g},function(g){Ae=g}],execute:function(){g("BuildingTester",Me=class n{static async main(g){let P=this.renderer=new I.Renderer(800,600);P.init(document.body),P.initStats(document.body);let G=z.WorldScene.factory({x:0,y:0,width:800,height:600},new $.BoxedVar(!0),new $.BoxedVar(xe.ShadowQuality.High));this.disposables.add(G),G.scene.background=new THREE.Color(12632256),_.IsoCoords.init({x:0,y:0}),this.theater=await L.Engine.loadTheater(U.TheaterType.Snow);var V=new K.Rules(L.Engine.getRules());this.buildBrowser(V.buildingRules),this.rules=V,this.art=new Z.Art(V,L.Engine.getArt()),this.images=L.Engine.getImages(),this.voxels=L.Engine.getVoxels(),this.voxelAnims=L.Engine.getVoxelAnims();let W=new Oe.CanvasMetrics(P.getCanvas(),window);W.init(),this.disposables.add(W),V=new ne.PointerEvents(P,{x:0,y:0},document,W);let q=new ce.CameraZoomControls(V,G.cameraZoom);this.disposables.add(q,V),q.init(),P.addScene(G),(this.uiAnimationLoop=new Q.UiAnimationLoop(P)).start(),this.worldScene=G,this.vxlGeometryPool=new Ee.VxlGeometryPool(new Ce.VxlGeometryCache),this.addGrid()}static addGrid(){var g=new q.MapGrid({width:10,height:10}).get3DObject();let P=new THREE.Object3D;P.add(g),this.worldScene.scene.add(P)}static selectBuilding(g){this.currentRenderable&&!this.currentBuilding.isDisposed&&(this.world.removeObject(this.currentBuilding),this.currentBuilding.dispose());var P=this.rules.getBuilding(g);let I=new G.Player("Player");this.disposables.add(I),I.color=-1!==P.techLevel||P.constructionYard?this.rules.getMultiplayerColors().get("DarkRed"):new J.Color(255,255,255);let _=new re.PlayerList;_.addPlayer(I);var U=new te.Alliances(_),V=new le.UnitSelection,W=new ue.Lighting;this.disposables.add(W),P=new X.RenderableFactory(new $.BoxedVar(I),V,U,this.rules,this.art,void 0,new Y.ImageFinder(this.images,this.theater),L.Engine.getPalettes(),this.voxels,this.voxelAnims,this.theater,this.worldScene.camera,W,new ve.LightingDirector(W,this.renderer,new $.BoxedVar(1)),new $.BoxedVar(!1),new $.BoxedVar(!1),new $.BoxedVar(2),void 0,new me.Strings({TXT_PRIMARY:"Primary"}),new $.BoxedVar(Te.FlyerHelperMode.Selected),new $.BoxedVar(!1),new we.VxlBuilderFactory(this.vxlGeometryPool,!1,this.worldScene.camera),new Map),V=new de.TileCollection([],null,this.rules.general,Ae.getRandomInt),U=new ge.TileOccupation(V),W=new ye.MapBounds,W=new pe.Bridges(this.theater.tileSets,V,U,W,this.rules);let z=this.currentBuilding=new se.ObjectFactory(V,U,W,new $.BoxedVar(1)).create(ae.ObjectType.Building,g,this.rules,this.art);z.owner=I,z.position.tile={rx:1,ry:1,z:0,rampType:0},z.position.setCenterOffset(z.getFoundationCenterOffset());let K=this.world=new be.World,q=new Se.RenderableManager(K,this.worldScene,this.worldScene.camera,P);q.init(),this.disposables.add(q),K.spawnObject(z),(this.currentRenderable=q.getRenderableByGameObject(z)).selectionModel.setSelectionLevel(ee.SelectionLevel.Selected),this.currentRenderable.selectionModel.setControlGroupNumber(3),setTimeout(()=>{this.buildBuildingControls(),this.createAnimButtons(),this.createOccupiedButtons()},50)}static selectAnimation(g){this.currentRenderable&&this.currentRenderable.setAnimation(g,performance.now())}static stopCurrentAnimation(){this.currentRenderable&&this.currentRenderable.endCurrentAnimation()}static setDamageType(g){this.currentBuilding.healthTrait.health=g?100*(g===V.DamageType.CONDITION_YELLOW?n.rules.audioVisual.conditionYellow:n.rules.audioVisual.conditionRed):100}static setActiveState(g){this.currentRenderable&&this.currentRenderable.setPowered(g)}static createAnimButtons(){let g=this.animButtonsWrap;g.innerHTML="";for(let I of[W.AnimationType.IDLE,W.AnimationType.PRODUCTION,W.AnimationType.BUILDUP,W.AnimationType.UNBUILD,W.AnimationType.SUPER_CHARGE_START,W.AnimationType.SPECIAL_REPAIR_START,W.AnimationType.SPECIAL_SHOOT,W.AnimationType.SPECIAL_DOCKING,W.AnimationType.FACTORY_DEPLOYING,W.AnimationType.FACTORY_ROOF_DEPLOYING]){let L=document.createElement("button");if(L.innerHTML=W.AnimationType[I],L.style.display="block",L.addEventListener("click",()=>this.selectAnimation(I)),!this.currentRenderable)throw new Error("Must build anim buttons after a building is selected");var P=!this.currentRenderable.hasAnimation(I);L.disabled=P,L.style.opacity=P?".5":"1",g.appendChild(L)}}static createOccupiedButtons(){let g=this.occupiedButtonsWrap;g.innerHTML="";let P=document.createElement("select");P.disabled=!this.currentBuilding.garrisonTrait,P.style.display="block",P.addEventListener("change",()=>{this.currentBuilding.garrisonTrait.units=new Array(Number(P.value)).fill(0).map(()=>new he.Infantry("dummy",this.rules.getObject("E1",ae.ObjectType.Infantry),null))});for(let g=0;g<this.currentBuilding.rules.maxNumberOccupants+1;g++){let I=document.createElement("option");I.innerHTML=String(g),I.value=String(g),I.selected=0===g,P.appendChild(I)}g.appendChild(P)}static buildBuildingControls(){this.controlsElement&&document.body.removeChild(this.controlsElement);let g=this.controlsElement=document.createElement("div");g.style.position="absolute",g.style.left="0",g.style.top="0",g.style.width="220px",g.style.padding="5px",g.style.background="rgba(255, 255, 255, 0.5)",g.style.border="1px black solid",g.appendChild(document.createTextNode("Remap color:"));let P=new Map(this.rules.getMultiplayerColors());P.set("None",new J.Color(255,255,255));let I=document.createElement("select");I.style.display="block",I.addEventListener("change",()=>{this.currentBuilding.owner.color=P.get(I.value)}),g.appendChild(I),P.forEach((g,P)=>{let L=document.createElement("option");L.innerHTML=P,L.value=P,L.selected=g.asHex()===this.currentBuilding.owner.color.asHex(),I.appendChild(L)}),g.appendChild(document.createTextNode("Selection level:"));let L=document.createElement("div");g.appendChild(L),[ee.SelectionLevel.None,ee.SelectionLevel.Hover,ee.SelectionLevel.Selected].forEach(g=>{let P=document.createElement("button");P.innerHTML=ee.SelectionLevel[g],P.disabled=g===ee.SelectionLevel.Selected&&!this.currentBuilding.rules.selectable,P.addEventListener("click",()=>this.currentRenderable.selectionModel.setSelectionLevel(g)),L.appendChild(P)}),g.appendChild(document.createTextNode("Animation type:"));var _=this.animButtonsWrap=document.createElement("div");g.appendChild(_);let U=document.createElement("button");U.innerHTML="Stop current",U.style.display="block",U.addEventListener("click",()=>this.stopCurrentAnimation()),g.appendChild(U),g.appendChild(document.createTextNode("Occupants:")),_=this.occupiedButtonsWrap=document.createElement("div"),g.appendChild(_),g.appendChild(document.createTextNode("Damage type:"));let G=document.createElement("button");G.innerHTML="NORMAL",G.style.display="block",G.addEventListener("click",()=>this.setDamageType(V.DamageType.NORMAL)),g.appendChild(G);let W=document.createElement("button");W.innerHTML="YELLOW",W.style.display="block",W.addEventListener("click",()=>this.setDamageType(V.DamageType.CONDITION_YELLOW)),g.appendChild(W);let z=document.createElement("button");z.innerHTML="RED",z.style.display="block",z.addEventListener("click",()=>this.setDamageType(V.DamageType.CONDITION_RED)),g.appendChild(z);let K=document.createElement("button");K.innerHTML="DESTROYED",K.style.display="block",K.addEventListener("click",async()=>{this.currentBuilding.isDestroyed=!0,this.currentBuilding.healthTrait.health=0,this.world.removeObject(this.currentBuilding),this.currentBuilding.dispose(),document.body.removeChild(this.controlsElement),this.controlsElement=void 0}),g.appendChild(K);let q=document.createElement("button");q.innerHTML="Toggle repair",q.style.display="block",q.addEventListener("click",()=>{let g=this.currentBuilding.traits.get(fe.AutoRepairTrait);g.setDisabled(!g.isDisabled())}),g.appendChild(q),g.appendChild(document.createTextNode("Powered state:"));let $=document.createElement("button");$.innerHTML="INACTIVE",$.style.display="block",$.addEventListener("click",()=>this.setActiveState(!1)),g.appendChild($);let Q=document.createElement("button");Q.innerHTML="ACTIVE",Q.style.display="block",Q.addEventListener("click",()=>this.setActiveState(!0)),g.appendChild(Q),g.appendChild(document.createTextNode("Warped out:"));let Y=document.createElement("input");Y.type="checkbox",Y.style.display="block",Y.addEventListener("change",g=>{this.currentBuilding.warpedOutTrait.debugSetActive(g.target.checked)}),g.appendChild(Y),document.body.appendChild(g)}static buildBrowser(g){let P=this.listEl=document.createElement("div");P.style.position="absolute",P.style.right="0",P.style.top="0",P.style.height="600px",P.style.width="200px",P.style.overflowY="auto",P.style.padding="5px",P.style.background="rgba(255, 255, 255, 0.5)",P.style.border="1px black solid",P.appendChild(document.createTextNode("Building types:"));let I=[];g.forEach((g,P)=>{-1!==["AMMOCRAT","GADUMY","GAGREEN","CAARMR"].indexOf(P)||/^CASIN/.exec(P)||/^CITY/.exec(P)||I.push(P)}),I.sort(),I.forEach(g=>{let I=document.createElement("a");I.style.display="block",I.textContent=g,I.setAttribute("href","javascript:;"),I.addEventListener("click",()=>{console.log("Selected building",g),this.selectBuilding(g)}),P.appendChild(I)}),document.body.appendChild(P),setTimeout(()=>{this.selectBuilding(I[0])},50)}static destroy(){this.renderer.destroy(),this.uiAnimationLoop.destroy(),this.listEl.remove(),this.controlsElement&&(this.controlsElement.remove(),this.controlsElement=void 0),this.disposables.dispose()}}),Me.disposables=new oe.CompositeDisposable}}}),System.register("tools/CameraZoomControls",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("CameraZoomControls",class{constructor(g,P){this.pointerEvents=g,this.cameraZoom=P,this.handleWheel=g=>{this.cameraZoom.applyStep(0<g.wheelDeltaY?-.1:.1)}}init(){this.pointerEvents.addEventListener("canvas","wheel",this.handleWheel)}destroy(){this.pointerEvents.removeEventListener("canvas","wheel",this.handleWheel)}})}}}),System.register("tools/DevToolsApi",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){g("DevToolsApi",I=class{static getPublicNamespace(){return window.r=window.r||Object.create(null)}static registerCommand(g,P){var I=this.getPublicNamespace();I[g]?console.error(`Command ${g} is already registered`):(this.cmdHandlers.set(g,P),Object.defineProperty(I,g,{configurable:!0,get:()=>this.cmdHandlers.get(g)()}))}static unregisterCommand(g){if(this.cmdHandlers.has(g)){this.cmdHandlers.delete(g),delete this.getPublicNamespace()[g]}else console.error(`Command ${g} is not registered`)}static registerVar(g,P){var I=this.getPublicNamespace();I[g]?console.error(`Runtime variable ${g} is already registered`):(this.runtimeVars.set(g,P),Object.defineProperty(I,g,{configurable:!0,get:()=>this.runtimeVars.get(g).value,set:P=>{this.runtimeVars.get(g).value=P}}))}static unregisterVar(g){if(this.runtimeVars.has(g)){this.runtimeVars.delete(g),delete this.getPublicNamespace()[g]}else console.error(`Runtime variable ${g} is not registered`)}static listVars(){return this.runtimeVars.keys()}static listCommands(){return this.cmdHandlers.keys()}}),I.cmdHandlers=new Map,I.runtimeVars=new Map}}}),System.register("tools/InfantryTester",["engine/gfx/Renderer","engine/Engine","engine/IsoCoords","game/Player","engine/renderable/WorldScene","game/rules/Rules","engine/renderable/entity/map/MapGrid","util/BoxedVar","engine/UiAnimationLoop","engine/ImageFinder","game/art/Art","engine/renderable/entity/RenderableFactory","engine/TheaterType","game/gameobject/unit/ZoneType","game/type/SpeedType","game/gameobject/infantry/StanceType","game/gameobject/infantry/InfDeathType","game/Alliances","game/PlayerList","game/gameobject/selection/SelectionLevel","game/gameobject/unit/VeteranLevel","gui/PointerEvents","util/disposable/CompositeDisposable","game/gameobject/selection/UnitSelection","tools/CameraZoomControls","engine/Lighting","game/gameobject/ObjectFactory","game/map/TileCollection","engine/type/ObjectType","game/gameobject/trait/MoveTrait","game/map/TileOccupation","game/map/Bridges","data/Strings","game/map/MapBounds","engine/renderable/entity/unit/FlyerHelperMode","engine/gfx/lighting/LightingDirector","game/World","engine/RenderableManager","engine/renderable/builder/VxlBuilderFactory","engine/renderable/builder/vxlGeometry/VxlGeometryPool","engine/gfx/geometry/VxlGeometryCache","engine/renderable/entity/unit/ShadowQuality","gui/CanvasMetrics","util/math"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be,Se,we,Ee,Ce,xe,Oe,Ae,Me,Re;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g},function(g){ce=g},function(g){he=g},function(g){ue=g},function(g){de=g},function(g){ge=g},function(g){pe=g},function(g){me=g},function(g){fe=g},function(g){ye=g},function(g){Te=g},function(g){ve=g},function(g){be=g},function(g){Se=g},function(g){we=g},function(g){Ee=g},function(g){Ce=g},function(g){xe=g},function(g){Oe=g},function(g){Ae=g},function(g){Me=g}],execute:function(){g("InfantryTester",Re=class{static async main(g){let P=this.renderer=new I.Renderer(800,600);P.init(document.body),P.initStats(document.body);let U=G.WorldScene.factory({x:0,y:0,width:800,height:600},new z.BoxedVar(!0),new z.BoxedVar(Oe.ShadowQuality.High));this.disposables.add(U),U.scene.background=new THREE.Color(12632256),_.IsoCoords.init({x:0,y:0}),this.theater=await L.Engine.loadTheater(Y.TheaterType.Snow);var W=new V.Rules(L.Engine.getRules());this.rules=W,this.art=new $.Art(W,L.Engine.getArt()),this.images=L.Engine.getImages(),this.buildBrowser(W.infantryRules);let q=new Ae.CanvasMetrics(P.getCanvas(),window);q.init(),this.disposables.add(q),W=new ne.PointerEvents(P,{x:0,y:0},document,q);let Q=new ce.CameraZoomControls(W,U.cameraZoom);this.disposables.add(Q,W),Q.init(),P.addScene(U),(this.uiAnimationLoop=new K.UiAnimationLoop(P)).start(),this.worldScene=U,this.addGrid()}static addGrid(){var g=new W.MapGrid({width:10,height:10}).get3DObject();let P=new THREE.Object3D;P.add(g),this.worldScene.scene.add(P)}static selectInfantry(g){this.currentInfantry&&!this.currentInfantry.isDisposed&&(this.world.removeObject(this.currentInfantry),this.currentInfantry.dispose());let P=new U.Player("Player");this.disposables.add(P),P.color=this.rules.getMultiplayerColors().get("DarkRed");var I=new te.Alliances(new re.PlayerList),_=new le.UnitSelection,G=new he.Lighting;this.disposables.add(G);var V=new Q.RenderableFactory(new z.BoxedVar(P),_,I,this.rules,this.art,void 0,new q.ImageFinder(this.images,this.theater),L.Engine.getPalettes(),null,null,this.theater,this.worldScene.camera,G,new be.LightingDirector(G,this.renderer,new z.BoxedVar(1)),new z.BoxedVar(!1),new z.BoxedVar(!1),new z.BoxedVar(2),void 0,new ye.Strings,new z.BoxedVar(ve.FlyerHelperMode.Selected),new z.BoxedVar(!1),new Ee.VxlBuilderFactory(new Ce.VxlGeometryPool(new xe.VxlGeometryCache),!1,this.worldScene.camera),new Map);_=new de.TileCollection([],null,this.rules.general,Me.getRandomInt),I=new me.TileOccupation(_),G=new Te.MapBounds,G=new fe.Bridges(this.theater.tileSets,_,I,G,this.rules);let W=this.currentInfantry=new ue.ObjectFactory(_,I,G,new z.BoxedVar(1)).create(ge.ObjectType.Infantry,g,this.rules,this.art);W.owner=P,W.position.tile={rx:1,ry:1,z:0,rampType:0};let K=this.world=new Se.World,$=new we.RenderableManager(K,this.worldScene,this.worldScene.camera,V);$.init(),this.disposables.add($),K.spawnObject(W);let Y=this.currentRenderable=$.getRenderableByGameObject(W);Y.selectionModel.setSelectionLevel(se.SelectionLevel.Selected),Y.selectionModel.setControlGroupNumber(3),this.buildControls()}static buildControls(){this.controlsEl&&document.body.removeChild(this.controlsEl);let g=this.controlsEl=document.createElement("div");g.style.position="absolute",g.style.left="0",g.style.top="0",g.style.width="200px",g.style.padding="5px",g.style.background="rgba(255, 255, 255, 0.5)",g.style.border="1px black solid",g.appendChild(document.createTextNode("Remap color:"));let P=new Map(this.rules.getMultiplayerColors()),I=document.createElement("select");I.style.display="block",I.addEventListener("change",()=>{this.currentInfantry.owner.color=P.get(I.value)}),g.appendChild(I),P.forEach((g,P)=>{let L=document.createElement("option");L.innerHTML=P,L.value=P,L.selected=g.asHex()===this.currentInfantry.owner.color.asHex(),I.appendChild(L)}),g.appendChild(document.createTextNode("Selection level:"));let L=document.createElement("div");g.appendChild(L),[se.SelectionLevel.None,se.SelectionLevel.Hover,se.SelectionLevel.Selected].forEach(g=>{let P=document.createElement("button");P.innerHTML=se.SelectionLevel[g],P.addEventListener("click",()=>this.currentRenderable.selectionModel.setSelectionLevel(g)),L.appendChild(P)}),g.appendChild(document.createTextNode("Veteran level:"));let _=document.createElement("div");g.appendChild(_),this.currentInfantry.veteranTrait&&[ae.VeteranLevel.None,ae.VeteranLevel.Veteran,ae.VeteranLevel.Elite].forEach(g=>{let P=document.createElement("button");P.innerHTML=ae.VeteranLevel[g],P.addEventListener("click",()=>this.currentInfantry.veteranTrait.veteranLevel=g),_.appendChild(P)}),g.appendChild(document.createTextNode("SubCell:"));let U=document.createElement("select");U.style.display="block",U.addEventListener("change",()=>{this.currentInfantry.position.subCell=Number(U.value)}),g.appendChild(U);for(let g=0;g<5;++g){let P=document.createElement("option");P.innerHTML=""+g,P.value=""+g,U.appendChild(P)}g.appendChild(document.createTextNode("Zone:")),this.createZoneSelect(g),g.appendChild(document.createTextNode("Stance:")),this.createStanceSelect(g),g.appendChild(document.createTextNode("isMoving:"));let G=document.createElement("input");G.type="checkbox",G.style.display="block",G.addEventListener("change",g=>{this.currentInfantry.moveTrait.moveState=g.target.checked?pe.MoveState.Moving:pe.MoveState.Idle}),g.appendChild(G),g.appendChild(document.createTextNode("isFiring:"));let V=document.createElement("input");V.type="checkbox",V.disabled=!this.currentInfantry.rules.primary,V.style.display="block",V.addEventListener("change",g=>{this.currentInfantry.isFiring=g.target.checked}),g.appendChild(V),g.appendChild(document.createTextNode("isPanicked:"));let W=document.createElement("input");W.type="checkbox",W.disabled=!this.currentInfantry.rules.fraidycat,W.style.display="block",W.addEventListener("change",g=>{this.currentInfantry.isPanicked=g.target.checked}),g.appendChild(W),g.appendChild(document.createTextNode("Warped out:"));let z=document.createElement("input");z.type="checkbox",z.style.display="block",z.addEventListener("change",g=>{this.currentInfantry.warpedOutTrait.debugSetActive(g.target.checked)}),g.appendChild(z),this.createDeathSelect(g),document.body.appendChild(g)}static createZoneSelect(g){let P=document.createElement("select");P.style.display="block",P.addEventListener("change",()=>{this.currentInfantry.zone=Number(P.value)}),g.appendChild(P);let I=document.createElement("option");if(I.value=""+Z.ZoneType.Ground,I.innerHTML=Z.ZoneType[Z.ZoneType.Ground],P.appendChild(I),this.currentInfantry.rules.consideredAircraft){let g=document.createElement("option");g.value=""+Z.ZoneType.Air,g.innerHTML=Z.ZoneType[Z.ZoneType.Air],P.appendChild(g)}if(this.currentInfantry.rules.speedType===X.SpeedType.Amphibious){let g=document.createElement("option");g.value=""+Z.ZoneType.Water,g.innerHTML=Z.ZoneType[Z.ZoneType.Water],P.appendChild(g)}}static createStanceSelect(g){let P=document.createElement("select");P.style.display="block",P.addEventListener("change",()=>{this.currentInfantry.stance=Number(P.value)}),g.appendChild(P);let I=document.createElement("option");I.value=""+J.StanceType.None,I.innerHTML=J.StanceType[J.StanceType.None],P.appendChild(I);let L=document.createElement("option");L.value=""+J.StanceType.Guard,L.innerHTML=J.StanceType[J.StanceType.Guard],P.appendChild(L);let _=document.createElement("option");_.value=""+J.StanceType.Paradrop,_.innerHTML=J.StanceType[J.StanceType.Paradrop],P.appendChild(_);let U=document.createElement("option");if(U.value=""+J.StanceType.Cheer,U.innerHTML=J.StanceType[J.StanceType.Cheer],P.appendChild(U),!this.currentInfantry.rules.fearless){let g=document.createElement("option");g.value=""+J.StanceType.Prone,g.innerHTML=J.StanceType[J.StanceType.Prone],P.appendChild(g)}if(this.currentInfantry.rules.deployer){let g=document.createElement("option");g.value=""+J.StanceType.Deployed,g.innerHTML=J.StanceType[J.StanceType.Deployed],P.appendChild(g)}}static createDeathSelect(g){g.appendChild(document.createTextNode("Death"));let P=document.createElement("select"),I=1,L=ee.InfDeathType[I];for(;void 0!==L;){let g=document.createElement("option");g.innerHTML=L,g.value=""+I,g.disabled=!this.currentInfantry.rules.isHuman&&![ee.InfDeathType.Gunfire,ee.InfDeathType.Explode].includes(I),P.appendChild(g),L=ee.InfDeathType[++I]}g.appendChild(P);let _=document.createElement("button");_.style.display="block",_.style.color="red",_.innerHTML="KILL",_.addEventListener("click",async()=>{this.currentInfantry.isDestroyed=!0,this.currentInfantry.infDeathType=Number(P.value),this.world.removeObject(this.currentInfantry),this.currentInfantry.dispose(),document.body.removeChild(this.controlsEl),this.controlsEl=void 0}),g.appendChild(_)}static buildBrowser(g){let P=this.listEl=document.createElement("div");P.style.position="absolute",P.style.right="0",P.style.top="0",P.style.height="600px",P.style.width="200px",P.style.overflowY="auto",P.style.padding="5px",P.style.width="200px",P.style.background="rgba(255, 255, 255, 0.5)",P.style.border="1px black solid",P.appendChild(document.createTextNode("Infantry types:"));let I=[...g.keys()].filter(g=>this.art.hasObject(g,ge.ObjectType.Infantry)).sort();I.forEach(g=>{let I=document.createElement("a");I.style.display="block",I.textContent=g,I.setAttribute("href","javascript:;"),I.addEventListener("click",()=>{console.log("Selected infantry",g),this.selectInfantry(g)}),P.appendChild(I)}),document.body.appendChild(P),setTimeout(()=>{this.selectInfantry(I[0]),this.animateInfantry()},50)}static animateInfantry(){this.currentInfantry.isDisposed||(this.currentInfantry.direction=(this.currentInfantry.direction+1)%360),setTimeout(()=>this.animateInfantry(),50)}static destroy(){this.renderer.destroy(),this.uiAnimationLoop.destroy(),this.listEl.remove(),this.controlsEl&&(this.controlsEl.remove(),this.controlsEl=void 0),this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=void 0),this.disposables.dispose()}}),Re.disposables=new oe.CompositeDisposable}}}),System.register("tools/LobbyFormTester",["engine/gfx/Renderer","engine/Engine","gui/UiScene","gui/screen/mainMenu/lobby/component/viewmodel/lobby","gui/screen/mainMenu/component/MainMenu","game/rules/Rules","gui/screen/mainMenu/lobby/component/LobbyForm","engine/UiAnimationLoop","gui/jsx/JsxRenderer","util/disposable/CompositeDisposable","gui/jsx/jsx","gui/jsx/HtmlView","game/gameopts/constants","network/ladder/PlayerRankType","network/ladder/wladderConfig"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g}],execute:function(){g("LobbyFormTester",J=class{static main(g,P){let q=new I.Renderer(800,600);q.init(g),q.initStats(document.body),this.disposables.add(q);let J=_.UiScene.factory({x:0,y:0,width:800,height:600});this.disposables.add(J);var ee={x:Math.max(0,(J.viewport.width-800)/2),y:Math.max(0,(J.viewport.height-600)/2),width:800,height:600};let te=new K.JsxRenderer(L.Engine.getImages(),L.Engine.getPalettes(),J.camera,void 0),re=new G.MainMenu(ee,L.Engine.getImages(),te,"dummy.webm");J.add(re);let se=new V.Rules(L.Engine.getRules());var[ee]=te.render($.jsx(Q.HtmlView,{x:ee.x,y:ee.y,component:W.LobbyForm,props:{strings:P,countryUiNames:new Map([["Random","GUI:RandomEx"],["Observer","GUI:Observer"]].concat(se.getMultiplayerCountries().map(g=>[g.name,g.uiName]))),countryUiTooltips:new Map,availablePlayerCountries:["Random"].concat(se.getMultiplayerCountries().map(g=>g.name)),availablePlayerColors:[""].concat([...se.getMultiplayerColors().values()].map(g=>g.asHexString())),maxTeams:4,availableAiNames:Y.aiUiNames,availableStartPositions:new Array(8).fill(0).map((g,P)=>P),activeSlotIndex:0,teamsAllowed:!0,teamsRequired:!1,lobbyType:U.LobbyType.MultiplayerHost,playerSlots:[{name:"Player 1",type:U.SlotType.Player,occupation:U.SlotOccupation.Occupied,country:"French",color:"#2269d4",startPos:Y.RANDOM_START_POS,team:Y.NO_TEAM_ID,status:U.PlayerStatus.Host,ping:50,playerProfile:{name:"Player 1",rank:2,rankType:Z.PlayerRankType.Private,points:100,ladder:{id:0,name:"1v1",divisionName:"Test ladder",type:X.LadderType.Solo1v1},wins:0,losses:0}},{name:"Player 2",type:U.SlotType.Player,occupation:U.SlotOccupation.Occupied,country:"Russians",color:"#ff1818",startPos:1,team:0,status:U.PlayerStatus.Ready,ping:300},{name:"Open",type:U.SlotType.Player,occupation:U.SlotOccupation.Open,country:"Random",color:"",startPos:Y.RANDOM_START_POS,team:Y.NO_TEAM_ID,status:U.PlayerStatus.NotReady},{type:U.SlotType.Observer,occupation:U.SlotOccupation.Open,country:"Observer",color:"",startPos:Y.RANDOM_START_POS,team:Y.NO_TEAM_ID,status:U.PlayerStatus.NotReady}],shortGame:!0,mcvRepacks:!0,cratesAppear:!0,superWeapons:!0,buildOffAlly:!0,destroyableBridges:!0,multiEngineer:!1,multiEngineerCount:3,noDogEngiKills:!1,gameSpeed:6,credits:1e4,unitCount:10,messages:[],mpDialogSettings:se.mpDialogSettings,onSendMessage:()=>{},onCountrySelect:g=>{console.log("selected country",g)},onColorSelect:g=>{console.log("selected color",g)},onStartPosSelect:g=>{console.log("selected start pos",g)},onTeamSelect:g=>{console.log("selected team",g)},onSlotChange:(g,P)=>{console.log("changed slot",g,P)},onToggleShortGame:g=>console.log(g),onToggleMcvRepacks:g=>console.log(g),onToggleCratesAppear:g=>console.log(g),onToggleSuperWeapons:g=>console.log(g),onToggleBuildOffAlly:g=>console.log(g),onChangeGameSpeed:g=>console.log(g),onChangeCredits:g=>console.log(g),onChangeUnitCount:g=>console.log(g)}}));re.add(ee),q.addScene(J);let ae=new z.UiAnimationLoop(q);ae.start(),this.disposables.add(ae),g.appendChild(J.getHtmlContainer().getElement()),this.disposables.add(()=>g.removeChild(J.getHtmlContainer().getElement()))}static destroy(){this.disposables.dispose()}}),J.disposables=new q.CompositeDisposable}}}),System.register("tools/ShpTester",["engine/gfx/Renderer","gui/UiScene","gui/screen/game/component/Hud","engine/Engine","gui/screen/game/component/hud/viewmodel/SidebarModel","game/rules/Rules","game/art/Art","game/Country","game/Player","game/World","game/gameobject/ObjectFactory","game/art/ObjectArt","engine/type/ObjectType","engine/UiAnimationLoop","game/Game","gui/jsx/JsxRenderer","util/disposable/CompositeDisposable","game/Alliances","game/PlayerList","gui/Pointer","util/BoxedVar","game/map/TileCollection","game/map/TileOccupation","game/map/Bridges","game/gameobject/selection/UnitSelection","game/ini/GameModeType","util/math","engine/TheaterType","game/GameMap","game/player/trait/RadarTrait","gui/screen/game/component/Minimap","game/player/production/Production","gui/screen/game/component/hud/viewmodel/CombatantSidebarModel","gui/screen/game/component/hud/viewmodel/MessageList","game/trait/MapShroudTrait","game/trait/SellTrait","game/map/MapBounds","engine/mixDatabase","gui/screen/game/component/hud/commandBar/CommandBarButtonType","gui/CanvasMetrics","game/trait/StalemateDetectTrait","game/CountdownTimer","data/IniSection","gui/chat/ChatHistory"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be,Se,we,Ee,Ce,xe,Oe,Ae,Me,Re;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g},function(g){ce=g},function(g){he=g},function(g){ue=g},function(g){de=g},function(g){ge=g},function(g){pe=g},function(g){me=g},function(g){fe=g},function(g){ye=g},function(g){Te=g},function(g){ve=g},function(g){be=g},function(g){Se=g},function(g){we=g},function(g){Ee=g},function(g){Ce=g},function(g){xe=g},function(g){Oe=g},function(g){Ae=g},function(g){Me=g}],execute:function(){g("ShpTester",Re=class{static async main(g,P,ee,Re){let Pe=new I.Renderer(800,600);Pe.init(ee),Pe.initStats(document.body),this.disposables.add(Pe);let Ie=L.UiScene.factory({x:0,y:0,width:800,height:600});this.disposables.add(Ie),await g.addMixFile("sidec01.mix");var ke=we.mixDatabase.get("cameo.mix");if(!ke)throw new Error("Missing file list database for cameos");let Be=new V.Rules(U.Engine.getRules()),Ne=new W.Art(Be,U.Engine.getArt());var Le=await U.Engine.loadTheater(de.TheaterType.Temperate),je=new ge.GameMap(P,Le.tileSets,Be,ue.getRandomInt),De={superWeapons:!1,gameSpeed:5},Fe=z.Country.factory("Americans",Be);let _e=new K.Player("Player",Fe);_e.radarTrait=new pe.RadarTrait,_e.production=new fe.Production(_e,10,De,Be,[...Be.buildingRules.values(),...Be.infantryRules.values()]),this.disposables.add(_e);var Ue=new q.World,He=new re.PlayerList,Ge=new te.Alliances(He),Ve=new ce.UnitSelection,We=new ne.TileCollection([],null,Be.general,ue.getRandomInt),ze=new oe.TileOccupation(We);Fe=new Se.MapBounds,Le=new le.Bridges(Le.tileSets,We,ze,Fe,Be),Fe=new ae.BoxedVar(1);let Ke=new $.ObjectFactory(We,ze,Le,Fe),qe=new X.Game(Ue,je,Be,Ne,null,"0",0,De,he.GameModeType.Battle,He,Ve,Ge,Fe,Ke,null);var $e;qe.addPlayer(_e),qe.mapShroudTrait=new ve.MapShroudTrait(je,Ge),qe.traits.add(qe.mapShroudTrait),qe.sellTrait=new be.SellTrait(qe,qe.rules.general),qe.traits.add(qe.sellTrait),["GACNST","GAPOWR","GAREFN","GAPILE","GAAIRC","GAWEAP","GATECH","NACNST","NAPOWR"].forEach(g=>_e.addOwnedObject(Ke.create(Y.ObjectType.Building,g,Be,Ne)));let Qe=new ye.CombatantSidebarModel(_e,qe);Qe.powerDrained=150,Qe.powerGenerated=300,_e.radarTrait.setDisabled(!1);let Ye=setInterval(()=>{Qe.powerDrained=ue.getRandomInt(0,300),Qe.powerGenerated=ue.getRandomInt(200,1e3),console.log(`Set power = ${Qe.powerGenerated}, drain = `+Qe.powerDrained)},5e3);this.disposables.add(()=>clearInterval(Ye)),_e.credits=5e3;let Ze=setInterval(()=>{_e.credits=ue.clamp(_e.credits+ue.getRandomInt(-1e3,1e3),0,1e6),console.log("Set credits",_e.credits)},5e3);for($e of(this.disposables.add(()=>clearInterval(Ze)),_e.production.getAvailableObjects())){var Xe=Q.ObjectArt.factory($e.type,$e,U.Engine.getArt(),U.Engine.getArt().getSection($e.imageName)??new Ae.IniSection($e.imageName));let g=Qe.getTabForQueueType(_e.production.getQueueTypeForObject($e));g.items.push({target:{type:G.SidebarItemTargetType.Techno,rules:$e},cameo:Xe.cameo,disabled:g.id===G.SidebarCategory.Structures,progress:0,quantity:0,status:G.SidebarItemStatus.Idle})}let Je=Qe.activeTab.items[1];Je.disabled=!1,Je.progress=.75,Je.quantity=2,Je.status=G.SidebarItemStatus.OnHold;let et=Qe.tabs[G.SidebarCategory.Infantry].items[0];et.quantity=5,et.progress=1,et.status=G.SidebarItemStatus.Ready;let tt=new Ce.CanvasMetrics(Pe.getCanvas(),window);tt.init(),this.disposables.add(tt);let it=se.Pointer.factory(U.Engine.getImages().get("mouse.shp"),U.Engine.getPalettes().get("mousepal.pal"),Pe,document,tt,new ae.BoxedVar(!1));it.init(),it.lock(),this.disposables.add(it),Ie.add(it.getSprite()),Ge=new J.JsxRenderer(U.Engine.getImages(),U.Engine.getPalettes(),Ie.camera,it.pointerEvents);let rt,st=new Te.MessageList(qe.rules.audioVisual.messageDuration,6,_e),at=["txt_low_power","txt_space_cant_save","txt_receiving_scenario","txt_bad_chankey"],N=()=>{var g=Re.get(at[ue.getRandomInt(0,at.length-1)]);console.log("Add system message:",g),st.addSystemMessage(g,"#"+new THREE.Color(Math.random(),Math.random(),Math.random()).getHexString()),rt=setTimeout(N,5e3*Math.random())};rt=setTimeout(N,5e3*Math.random()),this.disposables.add(()=>clearTimeout(rt));let nt=new _.Hud(_e.country.side,Ie.viewport,U.Engine.getImages(),U.Engine.getPalettes(),ke,Qe,st,new Me.ChatHistory,new ae.BoxedVar(""),new ae.BoxedVar(!1),void 0,[],new xe.StalemateDetectTrait,new Oe.CountdownTimer,Ge,Re,Object.values(Ee.CommandBarButtonType).filter(g=>"number"==typeof g)),ot=new me.Minimap(qe,_e,nt.getTextColor(),Be.general.radar);ot.setPointerEvents(it.pointerEvents),nt.setMinimap(ot),this.disposables.add(ot),Ie.add(nt),nt.onSidebarSlotClick.subscribe(g=>{console.log("clicked",g)}),nt.onOptButtonClick.subscribe(()=>{it.unlock(),nt.showSidebarMenu([{label:"Button 1",onClick(){console.log("button 1 clicked")}},{label:"Button 2",disabled:!0,onClick(){console.error("button 2 should not trigger onClick")}},{label:"Exit",isBottom:!0,onClick(){it.lock(),nt.hideSidebarMenu()}}])}),nt.onRepairButtonClick.subscribe(()=>{_e.radarTrait.setDisabled(!_e.radarTrait.isDisabled())}),nt.onCommandBarButtonClick.subscribe(g=>{console.log("Clicked command bar -> "+Ee.CommandBarButtonType[g])}),ke=(new Date).getTime(),Pe.addScene(Ie);let lt=new Z.UiAnimationLoop(Pe);this.disposables.add(lt),lt.start(),Ge=(new Date).getTime(),console.log("Rendering took "+(Ge-ke)+"ms"),ee.appendChild(Ie.getHtmlContainer().getElement()),this.disposables.add(()=>{ee.removeChild(Ie.getHtmlContainer().getElement())})}static destroy(){this.disposables.dispose()}}),Re.disposables=new ee.CompositeDisposable}}}),System.register("tools/SoundTester",["util/disposable/CompositeDisposable","data/AudioBagFile","data/IdxFile","engine/Engine"],function(g,P){"use strict";var I,L,_,U,G;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g}],execute:function(){g("SoundTester",G=class r{static async main(g,P){this.sounds=U.Engine.getSounds(),this.audioBag=new L.AudioBagFile;var I=g.openFile("audio.bag"),G=g.openFile("audio.idx");this.audioBag.fromVirtualFile(I,new _.IdxFile(G.stream)),g.addArchive(this.audioBag,"audio.bag"),this.buildBrowser()}static selectSound(g){let P=new AudioContext,I=P.createGain();I.gain.value=.5;var L=new Uint8Array(this.sounds.get(g).getData()).buffer;P.decodeAudioData(L,g=>{let L=P.createBufferSource();L.buffer=g,L.connect(I).connect(P.destination),L.start(0)},g=>console.log(g))}static buildBrowser(){let g=this.listEl=document.createElement("div");g.style.position="absolute",g.style.right="0",g.style.top="0",g.style.height="600px",g.style.width="200px",g.style.overflowY="auto",g.style.padding="5px",g.style.background="rgba(255, 255, 255, 0.5)",g.style.border="1px black solid",g.appendChild(document.createTextNode("Sound files:")),this.audioBag.getFileList().forEach(P=>{let I=document.createElement("a");I.style.display="block",I.textContent=P,I.setAttribute("href","javascript:;"),I.addEventListener("click",()=>{r.selectSound(P)}),g.appendChild(I)}),document.body.appendChild(g)}static destroy(){this.listEl.remove(),this.disposables.dispose()}}),G.disposables=new I.CompositeDisposable}}}),System.register("tools/VehicleTester",["engine/gfx/Renderer","engine/Engine","engine/IsoCoords","game/Player","engine/renderable/WorldScene","game/rules/Rules","engine/renderable/entity/map/MapGrid","util/BoxedVar","engine/UiAnimationLoop","engine/ImageFinder","game/art/Art","engine/renderable/entity/RenderableFactory","engine/TheaterType","game/theater/rampHeights","game/Alliances","game/PlayerList","game/gameobject/selection/SelectionLevel","game/gameobject/unit/VeteranLevel","game/gameobject/ObjectFactory","engine/type/ObjectType","gui/PointerEvents","util/disposable/CompositeDisposable","game/gameobject/selection/UnitSelection","tools/CameraZoomControls","engine/Lighting","game/map/TileCollection","game/gameobject/trait/MoveTrait","game/map/TileOccupation","game/map/Bridges","data/Strings","game/map/MapBounds","engine/renderable/entity/unit/FlyerHelperMode","engine/gfx/lighting/LightingDirector","game/World","engine/RenderableManager","engine/renderable/builder/VxlBuilderFactory","engine/renderable/builder/vxlGeometry/VxlGeometryPool","engine/gfx/geometry/VxlGeometryCache","engine/renderable/entity/unit/ShadowQuality","gui/CanvasMetrics","game/gameobject/unit/ZoneType","util/math","game/gameobject/trait/interface/NotifyTileChange","engine/type/TiberiumType"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee,te,re,se,ae,ne,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be,Se,we,Ee,Ce,xe,Oe,Ae,Me,Re;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g},function(g){X=g},function(g){J=g},function(g){ee=g},function(g){te=g},function(g){re=g},function(g){se=g},function(g){ae=g},function(g){ne=g},function(g){oe=g},function(g){le=g},function(g){ce=g},function(g){he=g},function(g){ue=g},function(g){de=g},function(g){ge=g},function(g){pe=g},function(g){me=g},function(g){fe=g},function(g){ye=g},function(g){Te=g},function(g){ve=g},function(g){be=g},function(g){Se=g},function(g){we=g},function(g){Ee=g},function(g){Ce=g},function(g){xe=g},function(g){Oe=g},function(g){Ae=g},function(g){Me=g}],execute:function(){g("VehicleTester",Re=class{static async main(g){let P=this.renderer=new I.Renderer(800,600);P.init(document.body),P.initStats(document.body);let U=G.WorldScene.factory({x:0,y:0,width:800,height:600},new z.BoxedVar(!0),new z.BoxedVar(Ee.ShadowQuality.High));this.disposables.add(U),U.scene.background=new THREE.Color(12632256),_.IsoCoords.init({x:0,y:0}),this.theater=await L.Engine.loadTheater(Y.TheaterType.Temperate);var W=new V.Rules(L.Engine.getRules());this.rules=W,this.art=new $.Art(W,L.Engine.getArt()),this.images=L.Engine.getImages(),this.voxels=L.Engine.getVoxels(),this.voxelAnims=L.Engine.getVoxelAnims(),this.buildBrowser(W.vehicleRules);let q=new Ce.CanvasMetrics(P.getCanvas(),window);q.init(),this.disposables.add(q),W=new ae.PointerEvents(P,{x:0,y:0},document,q);let Q=new le.CameraZoomControls(W,U.cameraZoom);this.disposables.add(Q,W),Q.init(),P.addScene(U),(this.uiAnimationLoop=new K.UiAnimationLoop(P)).start(),this.worldScene=U,this.vxlGeometryPool=new Se.VxlGeometryPool(new we.VxlGeometryCache),this.addGrid(),this.createFloor()}static addGrid(){var g=new W.MapGrid({width:10,height:10}).get3DObject();let P=new THREE.Object3D;P.add(g),this.worldScene.scene.add(P)}static createFloor(){var g=new THREE.PlaneGeometry(1e4,1e4);let P=new THREE.ShadowMaterial;P.opacity=.5;let I=new THREE.Mesh(g,P);I.rotation.x=-Math.PI/2,I.receiveShadow=!0,I.renderOrder=2e5,I.position.y=1,this.worldScene.scene.add(I)}static selectVehicle(g){this.currentVehicle&&!this.currentVehicle.isDisposed&&(this.world.removeObject(this.currentVehicle),this.currentVehicle.dispose());let P=new U.Player("Player");this.disposables.add(P),P.color=this.rules.getMultiplayerColors().get("DarkRed");var I=new X.Alliances(new J.PlayerList),_=new oe.UnitSelection,G=new ce.Lighting;this.disposables.add(G);var V=new Q.RenderableFactory(new z.BoxedVar(P),_,I,this.rules,this.art,void 0,new q.ImageFinder(this.images,this.theater),L.Engine.getPalettes(),this.voxels,this.voxelAnims,this.theater,this.worldScene.camera,G,new ye.LightingDirector(G,this.renderer,new z.BoxedVar(1)),new z.BoxedVar(!1),new z.BoxedVar(!1),new z.BoxedVar(2),void 0,new pe.Strings,new z.BoxedVar(fe.FlyerHelperMode.Selected),new z.BoxedVar(!1),new be.VxlBuilderFactory(this.vxlGeometryPool,!1,this.worldScene.camera),new Map);_=new he.TileCollection([],null,this.rules.general,Oe.getRandomInt),I=new de.TileOccupation(_),G=new me.MapBounds,G=new ge.Bridges(this.theater.tileSets,_,I,G,this.rules);let W=new re.ObjectFactory(_,I,G,new z.BoxedVar(1)),K=this.currentVehicle=W.create(se.ObjectType.Vehicle,g,this.rules,this.art);K.owner=P,K.position.tile=this.tile,K.harvesterTrait?(K.harvesterTrait.addBails(Me.TiberiumType.Ore,5),K.harvesterTrait.addBails(Me.TiberiumType.Gems,10)):K.transportTrait&&K.transportTrait.units.push(W.create(se.ObjectType.Vehicle,"FV",this.rules,this.art),W.create(se.ObjectType.Infantry,"E1",this.rules,this.art),W.create(se.ObjectType.Infantry,"CLEG",this.rules,this.art)),K.tilterTrait?.[Ae.NotifyTileChange.onTileChange](K);let $=this.world=new Te.World,Y=new ve.RenderableManager($,this.worldScene,this.worldScene.camera,V);Y.init(),this.disposables.add(Y),$.spawnObject(K);let Z=this.currentRenderable=Y.getRenderableByGameObject(K);Z.selectionModel.setSelectionLevel(ee.SelectionLevel.Selected),Z.selectionModel.setControlGroupNumber(3),this.buildControls()}static buildControls(){this.controlsEl&&document.body.removeChild(this.controlsEl);let g=this.controlsEl=document.createElement("div");g.style.position="absolute",g.style.left="0",g.style.top="0",g.style.width="200px",g.style.padding="5px",g.style.background="rgba(255, 255, 255, 0.5)",g.style.border="1px black solid",g.appendChild(document.createTextNode("Remap color:"));let P=this.rules.getMultiplayerColors(),I=document.createElement("select");I.style.display="block",I.addEventListener("change",()=>{this.currentVehicle.owner.color=P.get(I.value)}),g.appendChild(I),P.forEach((g,P)=>{let L=document.createElement("option");L.innerHTML=P,L.value=P,L.selected=g.asHex()===this.currentVehicle.owner.color.asHex(),I.appendChild(L)}),g.appendChild(document.createTextNode("Selection level:"));let L=document.createElement("div");g.appendChild(L),[ee.SelectionLevel.None,ee.SelectionLevel.Hover,ee.SelectionLevel.Selected].forEach(g=>{let P=document.createElement("button");P.innerHTML=ee.SelectionLevel[g],P.addEventListener("click",()=>this.currentRenderable.selectionModel.setSelectionLevel(g)),L.appendChild(P)}),g.appendChild(document.createTextNode("Veteran level:"));let _=document.createElement("div");g.appendChild(_),this.currentVehicle.veteranTrait&&[te.VeteranLevel.None,te.VeteranLevel.Veteran,te.VeteranLevel.Elite].forEach(g=>{let P=document.createElement("button");P.innerHTML=te.VeteranLevel[g],P.addEventListener("click",()=>this.currentVehicle.veteranTrait.veteranLevel=g),_.appendChild(P)}),g.appendChild(document.createTextNode("Ramp type:"));let U=document.createElement("select");U.style.display="block",U.addEventListener("change",()=>{this.tile.rampType=Number(U.value),this.currentVehicle.tilterTrait?.[Ae.NotifyTileChange.onTileChange](this.currentVehicle)}),g.appendChild(U);for(let g=0;g<Z.rampHeights.length;++g){let P=document.createElement("option");P.innerHTML=""+g,P.value=""+g,U.appendChild(P)}g.appendChild(document.createTextNode("Turret #:"));let G=document.createElement("select");G.style.display="block",G.disabled=!this.currentVehicle.rules.turret,G.addEventListener("change",()=>{this.currentVehicle.turretNo=Number(G.value)}),g.appendChild(G);for(let g=0;g<this.currentVehicle.rules.turretCount;++g){let P=document.createElement("option");P.innerHTML=""+g,P.value=""+g,G.appendChild(P)}g.appendChild(document.createTextNode("isMoving:"));let V=document.createElement("input");V.type="checkbox",V.style.display="block",V.addEventListener("change",g=>{var P=g.target.checked;this.currentVehicle.moveTrait.moveState=P?ue.MoveState.Moving:ue.MoveState.Idle,this.currentVehicle.rules.consideredAircraft&&P?this.currentVehicle.zone=xe.ZoneType.Air:this.currentVehicle.zone=this.currentVehicle.rules.naval?xe.ZoneType.Water:xe.ZoneType.Ground}),g.appendChild(V),g.appendChild(document.createTextNode("isFiring:"));let W=document.createElement("input");W.type="checkbox",W.style.display="block",W.addEventListener("change",g=>{this.currentVehicle.isFiring=g.target.checked}),g.appendChild(W),g.appendChild(document.createTextNode("isRocking:"));let z=document.createElement("input");if(z.type="checkbox",z.style.display="block",z.addEventListener("change",g=>{g.target.checked?this.currentVehicle.applyRocking(360*Math.random(),1):this.currentVehicle.rocking=void 0}),g.appendChild(z),this.currentVehicle.airSpawnTrait){g.appendChild(document.createTextNode("hasSpawns:"));let P=document.createElement("input");P.type="checkbox",P.style.display="block",P.checked=!!this.currentVehicle.airSpawnTrait.availableSpawns,P.addEventListener("change",g=>{var P=g.target.checked?1:0;this.currentVehicle.airSpawnTrait.debugSetStorage(null,P)}),g.appendChild(P)}g.appendChild(document.createTextNode("Warped out:"));let K=document.createElement("input");K.type="checkbox",K.style.display="block",K.addEventListener("change",g=>{this.currentVehicle.warpedOutTrait.debugSetActive(g.target.checked)}),g.appendChild(K),g.appendChild(document.createTextNode("Direction:"));let q=document.createElement("div");g.appendChild(q);let $=document.createElement("input");$.type="range",$.min="-180",$.max="180",$.value="0",$.disabled=void 0===this.fixedDirection,$.style.verticalAlign="middle",$.addEventListener("input",()=>{this.fixedDirection=Number($.value)}),q.appendChild($);let Q=document.createElement("button");Q.innerHTML="Reset",Q.disabled=void 0===this.fixedDirection,Q.style.verticalAlign="middle",Q.addEventListener("click",()=>{void 0!==this.fixedDirection&&(this.fixedDirection=0,$.value="0")}),q.appendChild(Q);let Y=document.createElement("input");Y.type="checkbox",Y.checked=void 0===this.fixedDirection,Y.addEventListener("change",g=>{this.fixedDirection=g.target.checked?void 0:0,$.disabled=Q.disabled=void 0===this.fixedDirection,$.value="0"}),g.appendChild(Y);let X=document.createElement("label");X.innerHTML="Auto rotate",g.appendChild(X);let J=document.createElement("button");J.style.display="block",J.style.color="red",J.innerHTML="DESTROY",J.addEventListener("click",async()=>{this.currentVehicle.isDestroyed=!0,this.world.removeObject(this.currentVehicle),this.currentVehicle.dispose(),document.body.removeChild(this.controlsEl),this.controlsEl=void 0}),g.appendChild(J),document.body.appendChild(g)}static buildBrowser(g){let P=this.listEl=document.createElement("div");P.style.position="absolute",P.style.right="0",P.style.top="0",P.style.height="600px",P.style.width="200px",P.style.overflowY="auto",P.style.padding="5px",P.style.background="rgba(255, 255, 255, 0.5)",P.style.border="1px black solid",P.appendChild(document.createTextNode("Vehicle types:"));let I=[...g.keys()].filter(g=>this.art.hasObject(g,se.ObjectType.Vehicle)).sort();I.forEach(g=>{let I=document.createElement("a");I.style.display="block",I.textContent=g,I.setAttribute("href","javascript:;"),I.addEventListener("click",()=>{console.log("Selected vehicle",g),this.selectVehicle(g)}),P.appendChild(I)}),document.body.appendChild(P),setTimeout(()=>{this.selectVehicle(I[0]),this.animateVehicle()},50)}static animateVehicle(){this.currentVehicle.direction=this.fixedDirection??(this.currentVehicle.direction+1)%360,this.currentVehicle.turretTrait&&(this.currentVehicle.turretTrait.facing=this.fixedDirection??(this.currentVehicle.turretTrait.facing+2)%360),setTimeout(()=>this.animateVehicle(),50)}static destroy(){this.renderer.destroy(),this.uiAnimationLoop.destroy(),this.listEl.remove(),this.controlsEl&&(this.controlsEl.remove(),this.controlsEl=void 0),this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=void 0),this.disposables.dispose()}}),Re.tile={rx:1,ry:1,rampType:0,z:0},Re.disposables=new ne.CompositeDisposable}}}),System.register("tools/VxlTester",["data/Palette","data/VxlFile","engine/gfx/Renderer","engine/renderable/WorldScene","engine/renderable/builder/VxlNonBatchedBuilder","engine/UiAnimationLoop","gui/PointerEvents","util/disposable/CompositeDisposable","tools/CameraZoomControls","util/BoxedVar","engine/renderable/builder/vxlGeometry/VxlGeometryPool","engine/gfx/geometry/VxlGeometryCache","engine/renderable/entity/unit/ShadowQuality","gui/CanvasMetrics"],function(g,P){"use strict";var I,L,_,U,G,V,W,z,K,q,$,Q,Y,Z,X,J,ee;return P&&P.id,{setters:[function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g},function(g){$=g},function(g){Q=g},function(g){Y=g},function(g){Z=g}],execute:function(){X=["1tnk.vxl","1tnkbarl.vxl","1tnktur.vxl","2tnk.vxl","2tnkbarl.vxl","2tnktur.vxl","3tnk.vxl","3tnkbarl.vxl","3tnktur.vxl","4tnk.vxl","4tnkbarl.vxl","4tnktur.vxl","aegis.vxl","apache.vxl","apc.vxl","apcw.vxl","art2.vxl","art2barl.vxl","art2tur.vxl","arty.vxl","artybarl.vxl","asw.vxl","axle.vxl","bana.vxl","beag.vxl","bggy.vxl","bike.vxl","bus.vxl","car.vxl","cargocar.vxl","carrier.vxl","cdest.vxl","cdestwo.vxl","cmin.vxl","cmon.vxl","cona.vxl","cop.vxl","cplane.vxl","cruise.vxl","dest.vxl","destwo.vxl","dmisl.vxl","dpod.vxl","dred.vxl","dredwo.vxl","dshp.vxl","euroc.vxl","falc.vxl","flak.vxl","flaktur.vxl","flata.vxl","fortress.vxl","ftnk.vxl","fv.vxl","fvtur.vxl","fvtur1.vxl","fvtur10.vxl","fvtur11.vxl","fvtur12.vxl","fvtur13.vxl","fvtur14.vxl","fvtur2.vxl","fvtur3.vxl","fvtur4.vxl","fvtur5.vxl","fvtur6.vxl","fvtur7.vxl","fvtur8.vxl","fvtur9.vxl","gastank.vxl","gtgcanbarl.vxl","gtgcantur.vxl","gtnk.vxl","gtnkbarl.vxl","gtnktur.vxl","harv.vxl","harvtur.vxl","heli.vxl","hind.vxl","hmec.vxl","hornet.vxl","horv.vxl","htk.vxl","htkbarl.vxl","htktur.vxl","htnk.vxl","htnkbarl.vxl","htnktur.vxl","hvr.vxl","hvrtur.vxl","hwtz.vxl","hyd.vxl","icbm.vxl","jeep.vxl","jeeptur.vxl","laser.vxl","lcrf.vxl","limo.vxl","lpst.vxl","ltnk.vxl","ltnkbarl.vxl","ltnktur.vxl","m113.vxl","m113tur.vxl","mcv.vxl","misl.vxl","mislchem.vxl","mislmlti.vxl","mislorca.vxl","mislsam.vxl","mlrs.vxl","mlrstur.vxl","mmchbarl.vxl","mnly.vxl","monocar.vxl","monoeng.vxl","mrj.vxl","mrjtur.vxl","mtnk.vxl","mtnkbarl.vxl","mtnktur.vxl","mtrb.vxl","mtrs.vxl","mtrt.vxl","orca.vxl","orcab.vxl","orcatran.vxl","outp.vxl","pdplane.vxl","phal.vxl","pick.vxl","piece.vxl","probe.vxl","propa.vxl","ptruck.vxl","pulscan.vxl","repair.vxl","rtnk.vxl","rtnkbarl.vxl","rtnktur.vxl","sam.vxl","sapc.vxl","scrin.vxl","shad.vxl","smcv.vxl","sonic.vxl","sonictur.vxl","sref.vxl","sreftur.vxl","sreftur1.vxl","sreftur2.vxl","sreftur3.vxl","stang.vxl","stnk.vxl","sub.vxl","subt.vxl","subtank.vxl","suvb.vxl","suvw.vxl","taxi.vxl","tire.vxl","tnkd.vxl","tractor.vxl","tran.vxl","trnsport.vxl","trs.vxl","truck2.vxl","trucka.vxl","truckb.vxl","truk.vxl","ttnk.vxl","ttnktur.vxl","tug.vxl","utnk.vxl","v3.vxl","v3rocket.vxl","v3wo.vxl","vlad.vxl","vladwo.vxl","weed.vxl","wini.vxl","wrmn.vxl","zbomb.vxl","zep.vxl"],J=class{constructor(g,P,I,L,_){this.builder=new G.VxlNonBatchedBuilder(g,P,I,L,_),this.wrapper=new THREE.Object3D}get3DObject(){return this.wrapper}create3DObject(){var g=this.builder.build();this.wrapper.add(g)}update(){this.wrapper.rotation.y-=.01}dispose(){this.builder.dispose()}},g("VxlTester",ee=class o{static async main(g,P){let L=this.renderer=new _.Renderer(800,600);L.init(document.body),L.initStats(document.body),this.vfs=g,this.vxlGeometryPool=new $.VxlGeometryPool(new Q.VxlGeometryCache),this.palette=new I.Palette(g.openFile("unittem.pal"));let G=this.worldScene=U.WorldScene.factory({x:0,y:0,width:800,height:600},new q.BoxedVar(!0),new q.BoxedVar(Y.ShadowQuality.High));this.disposables.add(G),G.scene.background=new THREE.Color(14737632),G.camera.far+=1e3,G.camera.updateProjectionMatrix();let z=new Z.CanvasMetrics(L.getCanvas(),window);z.init(),this.disposables.add(z);var X=new W.PointerEvents(L,{x:0,y:0},document,z);let J=new K.CameraZoomControls(X,G.cameraZoom);this.disposables.add(J,X),J.init(),this.createFloor(),this.buildBrowser(),L.addScene(G),(this.uiAnimationLoop=new V.UiAnimationLoop(L)).start()}static createFloor(){var g=new THREE.PlaneGeometry(1e4,1e4);let P=new THREE.ShadowMaterial;P.opacity=.5;let I=new THREE.Mesh(g,P);I.rotation.x=-Math.PI/2,I.position.y=-100,I.receiveShadow=!0,this.worldScene.scene.add(I)}static async selectVxl(g){o.currentVxl&&(o.worldScene.remove(o.currentVxl),o.currentVxl.dispose());var P=this.vfs.openFile(g),I=(new Date).getTime(),_=new L.VxlFile(P);P=(new Date).getTime();console.log("Parsing took "+(P-I)+"ms"),_=this.currentVxl=new J(_,void 0,this.palette,this.vxlGeometryPool,o.worldScene.camera),o.worldScene.add(_)}static buildBrowser(){let g=this.listEl=document.createElement("div");g.style.position="absolute",g.style.right="0",g.style.top="0",g.style.height="600px",g.style.width="200px",g.style.overflowY="auto",g.appendChild(document.createTextNode("Vxl files:")),X.forEach(P=>{let I=document.createElement("a");I.style.display="block",I.textContent=P,I.setAttribute("href","javascript:;"),I.addEventListener("click",()=>{console.log("Selected vxl",P),o.selectVxl(P)}),g.appendChild(I)}),document.body.appendChild(g),setTimeout(()=>{o.selectVxl("zep.vxl")},50)}static destroy(){this.renderer.destroy(),this.uiAnimationLoop.destroy(),this.listEl.remove(),this.disposables.dispose()}}),ee.disposables=new z.CompositeDisposable}}}),System.register("util/array",[],function(g,P){"use strict";return P&&P.id,g("findReverse",function(g,P){for(let I=g.length-1;0<=I;I--)if(P(g[I],I,g))return g[I]}),g("findIndexReverse",function(g,P){for(let I=g.length-1;0<=I;I--)if(P(g[I],I,g))return I;return-1}),g("equals",function(g,P){if(g.length!==P.length)return!1;for(let I=0,L=g.length;I<L;I++)if(g[I]!==P[I])return!1;return!0}),{setters:[],execute:function(){}}}),System.register("util/Base64",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("Base64",class{static encode(g){return void 0!==globalThis.btoa?globalThis.btoa(g):Buffer.from(g,"binary").toString("base64")}static decode(g){return void 0!==globalThis.atob?globalThis.atob(g):Buffer.from(g,"base64").toString("binary")}static isBase64(g){return!!g.match(/^([A-Za-z0-9+/]{4})*([A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{2}==)?$/)}})}}}),System.register("util/BoxedVar",["util/event"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("BoxedVar",class{constructor(g){this._onChange=new I.EventDispatcher,this.value=g}get value(){return this._value}set value(g){var P=g!==this._value;this._value=g,P&&this._onChange.dispatch(this,g)}get onChange(){return this._onChange.asEvent()}})}}}),System.register("util/bresenham",[],function(g,P){"use strict";return P&&P.id,g("bresenham",function(g,P,I,L,_){let U=[];_=_||((g,P)=>{U.push({x:g,y:P})});var G=I-g,V=L-P,W=Math.abs(G),z=Math.abs(V);let K=0;var q=0<G?1:-1,$=0<V?1:-1;if(z<W)for(let L=g,U=P;q<0?L>=I:L<=I;L+=q)_(L,U),K+=z,K<<1>=W&&(U+=$,K-=W);else for(let I=g,U=P;$<0?U>=L:U<=L;U+=$)_(I,U),K+=W,K<<1>=z&&(I+=q,K-=z);return U}),{setters:[],execute:function(){}}}),System.register("util/Color",["util/string"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("Color",class u{static fromRgb(g,P,I){return new u(g,P,I)}static fromHsv(g,P,I){let L=0,_=0,U=0;if(g=g/255*360%360,I/=255,0==(P/=255))L=I,_=I,U=I;else{var G=g/60,V=Math.floor(G),W=I*(1-P),z=I*(1-P*(G=G-V)),K=I*(1-P*(1-G));switch(V){case 0:L=I,_=K,U=W;break;case 1:L=z,_=I,U=W;break;case 2:L=W,_=I,U=K;break;case 3:L=W,_=z,U=I;break;case 4:L=K,_=W,U=I;break;case 5:L=I,_=W,U=z}}return u.fromRgb(Math.floor(255*L),Math.floor(255*_),Math.floor(255*U))}constructor(g,P,I){this.r=g,this.g=P,this.b=I}asHex(){return(this.r<<16)+(this.g<<8)+this.b}asHexString(){return"#"+I.pad(this.asHex().toString(16),"000000")}clone(){return new u(this.r,this.g,this.b)}})}}}),System.register("util/CssLoader",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("CssLoader",class{constructor(g){this.document=g}async load(g){return new Promise((P,I)=>{let L=document.createElement("link");L.rel="stylesheet",L.type="text/css",L.href=g,"onload"in L&&(L.onload=()=>P()),"onerror"in L&&(L.onerror=()=>I(new Error(`Couldn't load CSS at "${g}"`))),this.document.head.appendChild(L),"onload"in L||P()})}})}}}),System.register("util/disposable/CompositeDisposable",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){I=g=>!g.dispose,g("CompositeDisposable",class{constructor(){this.disposables=new Set}add(...g){g.map(g=>this.disposables.add("function"==typeof g?{dispose:g}:g))}remove(...g){g.map(g=>this.disposables.delete(g))}dispose(){this.disposables.forEach(g=>{"function"==typeof g?g():I(g)?g.destroy():g.dispose()}),this.disposables.clear()}})}}}),System.register("util/disposable/Disposable",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("util/disposable/LegacyDisposable",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("util/dom",[],function(g,P){"use strict";return P&&P.id,g("getOffset",function(g){let P=0,I=0;for(;P+=g.offsetTop||0,I+=g.offsetLeft||0,g=g.offsetParent;);return{top:P,left:I}}),g("contains",function(g,P){do{if(P===g)return!0}while(P=P.parentElement);return!1}),{setters:[],execute:function(){}}}),System.register("util/event",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("EventDispatcher",class{constructor(){this.listeners=new Set}subscribe(g){this.listeners.add(g)}subscribeOnce(g){let r=(P,I)=>{g(P,I),this.unsubscribe(r),r=void 0};this.subscribe(r)}unsubscribe(g){this.listeners.delete(g)}dispatch(g,P){this.listeners.forEach(I=>I(P,g))}asEvent(){return this}})}}}),System.register("util/format",["util/string"],function(g,P){"use strict";var I;return P&&P.id,g("formatTimeDuration",function(g,P=!1){var L=Math.floor(g/3600);g-=3600*L;var _=Math.floor(g/60),U=g-=60*_;return[...L||!P?[L]:[],I.pad(_,"00"),I.pad(U,"00")].join(":")}),{setters:[function(g){I=g}],execute:function(){}}}),System.register("util/fullScreen",[],function(g,P){"use strict";return P&&P.id,g("setupFullScreenChangeListener",function(g,P){if(g.fullscreenEnabled){let I=!0;const e=()=>{var L=!!g.fullscreenElement;L?I=!1:setTimeout(()=>I=!0,100),P(L)},s=async P=>{if(122===P.keyCode&&I&&!g.fullscreenElement)try{await g.documentElement.requestFullscreen()}catch{console.warn("Full screen permission denied by user.")}};return g.addEventListener("fullscreenchange",e),g.addEventListener("keyup",s),()=>{g.removeEventListener("fullscreenchange",e),g.removeEventListener("keyup",s)}}console.warn("Browser fullscreen API not available.")}),{setters:[],execute:function(){}}}),System.register("util/geometry",["util/math"],function(g,P){"use strict";var I;return P&&P.id,g("pointEquals",function(g,P){return g&&P&&g.x===P.x&&g.y===P.y||!g&&!P}),g("rectIntersect",function(g,P){return g.x<=P.x+P.width&&P.x<=g.x+g.width&&g.y<=P.y+P.height&&P.y<=g.y+g.height}),g("rectEquals",function(g,P){return g.x===P.x&&g.y===P.y&&g.width===P.width&&g.height===P.height}),g("circleIntersect",function(g,P){var L=g.center,_=P.center;return I.isBetween((L.x-_.x)*(L.x-_.x)+(L.y-_.y)*(L.y-_.y),(g.radius-P.radius)*(g.radius-P.radius),(g.radius+P.radius)*(g.radius+P.radius))}),g("circleContainsPoint",function(g,P){var I=g.center;return(I.x-P.x)*(I.x-P.x)+(I.y-P.y)*(I.y-P.y)<=g.radius*g.radius}),g("rectContainsPoint",function(g,P){return new THREE.Box2(new THREE.Vector2(g.x,g.y),new THREE.Vector2(g.x+g.width,g.y+g.height)).containsPoint(new THREE.Vector2(P.x,P.y))}),g("rectContainsRect",function(g,P){let I=new THREE.Box2(new THREE.Vector2(g.x,g.y),new THREE.Vector2(g.x+g.width,g.y+g.height));var L=new THREE.Box2(new THREE.Vector2(P.x,P.y),new THREE.Vector2(P.x+P.width,P.y+P.height));return I.containsBox(L)}),g("rectClampPoint",function(g,P){return new THREE.Box2(new THREE.Vector2(g.x,g.y),new THREE.Vector2(g.x+g.width,g.y+g.height)).clampPoint(new THREE.Vector2(P.x,P.y),new THREE.Vector2)}),g("octileDistance",function(g,P){var I=Math.abs(g.x-P.x),L=Math.abs(g.y-P.y);return I+L+(Math.SQRT2-2)*Math.min(I,L)}),{setters:[function(g){I=g}],execute:function(){}}}),System.register("util/Graph",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){g("Node",I=class{constructor(g,P){this.id=g,this.data=P,this.neighbors=new Set}addLink(g){this.neighbors.add(g),g!==this&&g.neighbors.add(this)}removeLink(g){this.neighbors.delete(g),g.neighbors.delete(this)}deleteLinks(){for(var g of this.neighbors)g.neighbors.delete(this);this.neighbors.clear()}}),g("Graph",class{constructor(){this.nodes=new Map}addNode(g,P){let L=this.getNode(g);return L?L.data=P:L=new I(g,P),this.nodes.set(g,L),L}removeNode(g){let P=this.getNode(g);return!!P&&(P.deleteLinks(),this.nodes.delete(g),!0)}hasNode(g){return this.nodes.has(g)}getNode(g){return this.nodes.get(g)}getNodeCount(){return this.nodes.size}forEachNode(g){for(var P of this.nodes.values())g(P)}clear(){for(var g of this.nodes.values())g.deleteLinks();this.nodes.clear()}})}}}),System.register("util/keyNames",[],function(g,P){"use strict";var I;return P&&P.id,g("getKeyName",function(g){var P=I.get(g);return void 0!==P?P:String.fromCharCode(g)}),{setters:[],execute:function(){I=new Map([[8,"Backspace"],[9,"Tab"],[12,"Clear"],[13,"Enter"],[19,"Pause/Break"],[20,"CapsLock"],[27,"Esc"],[32,"Space"],[33,"PageUp"],[34,"PageDown"],[35,"End"],[36,"Home"],[37,"ArrowLeft"],[38,"ArrowUp"],[39,"ArrowRight"],[40,"ArrowDown"],[44,"PrintScreen"],[45,"Insert"],[46,"Delete"],[91,"LeftWin/"],[92,"RightWin/"],...new Array(10).fill(0).map((g,P)=>[96+P,"Num"+P]),[106,"Num*"],[107,"Num+"],[109,"Num-"],[110,"NumDel"],[111,"Num/"],...new Array(32).fill(0).map((g,P)=>[111+P+1,"F"+(P+1)]),[144,"NumLock"],[145,"ScrollLock"],[186,";"],[187,"="],[188,","],[189,"-"],[190,"."],[191,"/"],[192,"`"],[219,"["],[220,"\\"],[221,"]"],[222,"'"]])}}}),System.register("util/Logger",["js-logger"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("AppLogger",I)}}}),System.register("util/math",[],function(g,P){"use strict";return P&&P.id,g("getRandomInt",function(g,P){return Math.floor(Math.random()*(P+1-g))+g}),g("clamp",function(g,P,I){return Math.min(I,Math.max(g,P))}),g("isBetween",function(g,P,I){return P<=g&&g<=I}),g("lerp",function(g,P,I){return(1-I)*g+I*P}),g("truncToDecimals",function(g,P){if(!g)return g;var I=10**P;return 0<=g?Math.floor(g*I)/I:Math.ceil(g*I)/I}),g("roundToDecimals",function(g,P){if(!g)return g;var I=10**P;return Math.round(g*I)/I}),g("floorTo",function(g,P){return Math.floor(g/P)*P}),g("fnv32a",function(g){let P=2166136261;for(let I=0,L=g.length;I<L;++I)P^=g[I],P+=(P<<1)+(P<<4)+(P<<7)+(P<<8)+(P<<24);return P>>>0}),{setters:[],execute:function(){}}}),System.register("util/mouse",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("util/number",[],function(g,P){"use strict";return P&&P.id,g("int32ToFloat32",function(g){let P=new DataView(new ArrayBuffer(4));return P.setInt32(0,g),P.getFloat32(0)}),{setters:[],execute:function(){}}}),System.register("util/PointerLock",["util/event","util/disposable/CompositeDisposable"],function(g,P){"use strict";var I,L;return P&&P.id,{setters:[function(g){I=g},function(g){L=g}],execute:function(){g("PointerLock",class{get onChange(){return this._onChange.asEvent()}constructor(g,P){this.element=g,this.document=P,this._onChange=new I.EventDispatcher,this.disposables=new L.CompositeDisposable,this.listening=!1}async request(g){if(g?.unadjustedMovement)try{await this.requestInternal({unadjustedMovement:!0})}catch(g){if("NotSupportedError"!==g.name)throw g;await this.requestInternal()}else await this.requestInternal()}async requestInternal(g){if(!this.isActive()){if(!this.listening){this.listening=!0;const t=()=>{this._onChange.dispatch(this,this.isActive())};this.document.addEventListener("pointerlockchange",t,!1),this.disposables.add(()=>this.document.removeEventListener("pointerlockchange",t,!1));let e=()=>{this.exit().catch(g=>console.error(g))};this.document.addEventListener("touchstart",e,!1),this.disposables.add(()=>this.document.removeEventListener("touchstart",e,!1))}return new Promise((P,I)=>{const i=()=>{this.document.removeEventListener("pointerlockchange",i,!1),this.document.removeEventListener("pointerlockerror",r,!1),P()},r=g=>{this.document.removeEventListener("pointerlockchange",i,!1),this.document.removeEventListener("pointerlockerror",r,!1),console.error(g),I(new Error("Pointer lock error"))};this.document.addEventListener("pointerlockerror",r,!1),this.document.addEventListener("pointerlockchange",i,!1),this.element.requestPointerLock(g)?.catch?.(I)})}}async exit(){if(this.isActive())return new Promise((g,P)=>{const i=()=>{this.document.removeEventListener("pointerlockchange",i,!1),this.document.removeEventListener("pointerlockerror",r,!1),g()},r=g=>{this.document.removeEventListener("pointerlockchange",i,!1),this.document.removeEventListener("pointerlockerror",r,!1),console.error(g),P(new Error("Pointer lock error"))};this.document.addEventListener("pointerlockerror",r,!1),this.document.addEventListener("pointerlockchange",i,!1),this.document.exitPointerLock()})}isActive(){return this.element===this.document.pointerLockElement}dispose(){this.disposables.dispose()}})}}}),System.register("util/QuadTree",[],function(g,P){"use strict";var I;return P&&P.id,{setters:[],execute:function(){I=new THREE.Vector2,g("QuadTree",class a{constructor(g,P){this.box=g,this.config=P,this.parentMap=new Map,this.objects=[]}add(g,P=!0){var I=this.config.getKey(g);if(this.box.containsPoint(I)){if(!this.regions)return this.parentMap.get(g)?.remove(g),this.parentMap.set(g,this),this.objects.push({key:I,value:g}),P&&this.update(),!0;for(var L of this.regions)if(L.add(g,P))return!0}return!1}remove(g,P=!0){let I=this.parentMap.get(g);I&&(I===this?(this.parentMap.delete(g),this.objects.splice(this.objects.findIndex(P=>P.value===g),1),P&&this.parent?.update()):I.remove(g,P))}updateObject(g){let P=this.parentMap.get(g);if(P){var I=this.config.getKey(g);if(P.box.containsPoint(I))P.objects.find(P=>P.value===g).key=I;else{P.remove(g,!1);let I=P.parent;for(;I&&!I.add(g,!1);)I=I.parent}}}queryRange(g,P=[]){if(this.box.intersectsBox(g))if(this.regions)for(var I of this.regions)I.queryRange(g,P);else for(var L of this.objects)g.containsPoint(L.key)&&P.push(L.value);return P}update(){let g=0;if(this.regions){for(var P of this.regions)g+=P.update();g<=this.config.joinThreshold&&this.join()}else g=this.objects.length,g>=this.config.splitThreshold&&this.split()&&this.update();return g}split(){if(this.regions||this.config.maxDepth<=1)return!1;var g,P,I={getKey:this.config.getKey,joinThreshold:this.config.joinThreshold,splitThreshold:this.config.splitThreshold,maxDepth:this.config.maxDepth-1},L=this.generateRegions(),_=this.objects;for(g of(this.objects=[],this.regions=[],L)){let P=new a(g,I);P.parentMap=this.parentMap,this.regions.push(P),P.parent=this}for(P of _)this.parentMap.delete(P.value),this.add(P.value,!1);return!0}join(){if(!this.regions)return!1;for(var g of this.regions)for(var P of(g.join(),g.parent=void 0,g.objects))this.objects.push(P),this.parentMap.set(P.value,this);return!(this.regions=void 0)}generateRegions(){let g=[this.box.clone()];var P=this.box.getCenter(I);let L=g[0],_=L.clone();L.max.x=P.x,_.min.x=P.x,g.push(_);for(let I=0,U=g.length;I<U;I++)L=g[I],_=L.clone(),L.max.y=P.y,_.min.y=P.y,g.push(_);return g}})}}}),System.register("util/Routing",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("Routing",class{constructor(){this.routes={}}addRoute(g,P){this.routes[g]={controller:P}}init(){window.addEventListener("hashchange",()=>this.router()),this.router()}async router(){let g=location.hash.slice(1)||"/";if(g.match(/^\//)){var[,P,...I]=g.split("/");this.routes["*"]&&await this.routes["*"].controller(I);let L=this.routes["/"+P];L.controller&&await L.controller(I)}}})}}}),System.register("util/ScriptLoader",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("ScriptLoader",class{constructor(g){this.document=g}load(g,P={}){return new Promise((I,L)=>{let _=this.document.head,U=this.document.createElement("script");U.type=P.type||"text/javascript",U.charset=P.charset||"utf8",U.async=void 0===P.async||P.async,U.src=g;const G=P.attrs;G&&Object.keys(G).forEach(g=>U.setAttribute(g,G[g])),P.text&&(U.text=P.text),U.onload=()=>{I()};let V=new Error(`Failed to load script "${g}"`);U.onerror=()=>{L(V)},_.appendChild(U)})}})}}}),System.register("util/Sentry",["util/ScriptLoader"],function(g,P){"use strict";var I;return P&&P.id,{setters:[function(g){I=g}],execute:function(){g("Sentry",class{async init(g,P){await new I.ScriptLoader(document).load(`https://js.sentry-cdn.com/${g.dsn}.min.js`);let L=this.sdk=window.Sentry,_=new Date;L.init({environment:g.env,release:P,denyUrls:[/^file:/],ignoreErrors:[/init message from worker/,/The object can not be found here/,/itemsclipboard/,/A requested file or directory could not be found/,/The requested file could not be read/,/The play\(\) request/,/^db$/],initialScope:g=>g.setTags({locale:navigator.language}).setExtra("initTime",_),...g.defaultIntegrations?{}:{defaultIntegrations:!1}}),L.onLoad(()=>{this.sdk=window.Sentry}),g.lazyLoad||L.forceLoad()}captureException(g,P){this.sdk?.captureException(g,P)}configureScope(g){this.sdk?.configureScope(g)}addBreadcrumb(g){this.sdk?.addBreadcrumb(g)}})}}}),System.register("util/Serializable",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}}),System.register("util/stream",[],function(g,P){"use strict";return P&&P.id,g("makeTextFileLineIterator",async function*(g){const P=new TextDecoder("utf-8");let I=g.stream().getReader(),{value:L,done:_}=await I.read();L=L?P.decode(L,{stream:!0}):"";let U=/\r\n|\n|\r/gm,G=0;for(;;){var V=U.exec(L);if(V)yield L.substring(G,V.index),G=U.lastIndex;else{if(_)break;V=L.substr(G),({value:L,done:_}=await I.read()),L=V+(L?P.decode(L,{stream:!0}):""),G=U.lastIndex=0}}G<L.length&&(yield L.substr(G))}),{setters:[],execute:function(){}}}),System.register("util/string",["util/Base64"],function(g,P){"use strict";var I;function r(g){var P=g.length;let I=new Uint8Array(P);for(let L=0;L<P;L++)I[L]=g.charCodeAt(L);return I}function s(g){return g.reduce((g,P)=>g+String.fromCharCode(P),"")}return P&&P.id,g("pad",function(g,P="0000"){var I=""+g;return P.substring(0,P.length-I.length)+I}),g("equalsIgnoreCase",function(g,P){return g.toLowerCase()===P.toLowerCase()}),g("binaryStringToUint8Array",r),g("base64StringToUint8Array",function(g){return r(I.Base64.decode(g))}),g("uint8ArrayToBase64String",function(g){return I.Base64.encode(s(g))}),g("uint8ArrayToBinaryString",s),g("utf16ToBinaryString",function(g){var P=g.length;let I="";for(let _=0;_<P;_++){var L=g.charCodeAt(_);I+=String.fromCharCode(L>>8),I+=String.fromCharCode(255&L)}return I}),g("binaryStringToUtf16",function(g){var P=g.length;let I="";for(let _=0;_<P;_+=2){var L=(g.charCodeAt(_)<<8)+g.charCodeAt(_+1);I+=String.fromCharCode(L)}return I}),g("bufferToHexString",function(g){const P=[],I=new DataView(g);for(let g=0;g<I.byteLength;g+=4){var L=((L="00000000")+I.getUint32(g).toString(16)).slice(-L.length);P.push(L)}return P.join("")}),{setters:[function(g){I=g}],execute:function(){}}}),System.register("util/time",[],function(g,P){"use strict";async function o(g){return new Promise(P=>{setTimeout(()=>P(),g)})}function a(g,P){let I=!1,L=Number.NEGATIVE_INFINITY;return async function(..._){var U,G;I||(G=(U=Date.now())-L,L=P<=G?U:(I=!0,await o(P-G),I=!1,Date.now()),await g.apply(this,_))}}return P&&P.id,g("sleep",o),g("throttle",a),g("Throttle",function(g){return(P,I,L)=>{var _=L.value;L.value=a(_,g)}}),{setters:[],execute:function(){}}}),System.register("util/typeGuard",[],function(g,P){"use strict";return P&&P.id,g("isNotNullOrUndefined",function(g){return null!=g}),{setters:[],execute:function(){}}}),System.register("util/userAgent",[],function(g,P){"use strict";function i(){return navigator.platform.includes("Mac")}return P&&P.id,g("isIpad",function(){return/iPad/i.test(navigator.userAgent)||/MacIntel/i.test(navigator.platform)&&!!navigator.maxTouchPoints}),g("isMac",i),g("isMacFirefox",function(){return i()&&-1!==navigator.userAgent.toLowerCase().indexOf("firefox")}),{setters:[],execute:function(){}}}),System.register("version",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){g("version","0.80.0-c1")}}}),System.register("VirtualJoystickPatch",["gui/screen/game/GameScreen","gui/screen/game/worldInteraction/WorldInteraction","gui/screen/game/worldInteraction/DefaultActionHandler","gui/screen/game/component/hud/VirtualJoystickLite"],function(){"use strict";var g,P,I,L;function hasNonZeroRect(g){var P=g?.getBoundingClientRect?.();return!!P&&P.width>8&&P.height>8}function subscribeEvent(g,P,I){g?.subscribe&&g?.unsubscribe&&(g.subscribe(P),I.push(()=>{try{g.unsubscribe(P)}catch(g){}}))}function mountJoystickLite(g){if(!g.__ra2webVirtualJoystickLite){var P=g.uiScene?.getHtmlContainer?.()?.getElement?.(),I=g.pointer?.pointerEvents,_=g.pointer?.canvasMetrics,U=g.battleControlApi,G=L?.VirtualJoystickLite;if(P&&I&&_&&U&&G){var V=function chooseMountHost(g,P){var I=document.getElementById("ra2web-stage"),L=document.getElementById("ra2web-root"),_=[{key:"uiSceneRoot",el:g},{key:"uiSceneRootParent",el:g?.parentElement},{key:"canvasParent",el:P?.parentElement},{key:"stage",el:I},{key:"root",el:L},{key:"body",el:document.body}],U=new Set;for(var G of _){var V=G.el;if(V&&!U.has(V)&&(U.add(V),hasNonZeroRect(V)))return{key:G.key,el:V}}return{key:"fallbackPrimary",el:g}}(P,_?.canvas).el;if(V){var W=new G({pointerEvents:I,battleControlApi:U,canvasMetrics:_,localPrefs:g.localPrefs,getWorldInteraction:()=>g.playerUi?.worldInteraction});if(W.mount(V)){var z=[];subscribeEvent(g.menu?.onOpen,()=>{W.setMenuOpen(!0)},z),subscribeEvent(g.menu?.onCancel,()=>{W.setMenuOpen(!1)},z),subscribeEvent(g.menu?.onQuit,()=>{W.setMenuOpen(!0)},z),subscribeEvent(g.viewport?.onChange,()=>W.onViewportChange?.(),z),g.__ra2webVirtualJoystickLite=W,g.__ra2webVirtualJoystickLiteDisposers=z,"undefined"!=typeof window&&(window.__ra2webVirtualJoystickLite=W)}}}}}function patchGameScreenLifecycle(){var P=g?.GameScreen;if(P&&!P.prototype.__ra2webVirtualJoystickPatched){var I=P.prototype.initUi,L=P.prototype.onLeave;P.prototype.initUi=function(){var g=I.apply(this,arguments);try{mountJoystickLite(this)}catch(g){console.warn("VirtualJoystickLite mount failed",g)}return g},P.prototype.onLeave=async function(){return function unmountJoystickLite(g){(g.__ra2webVirtualJoystickLiteDisposers||[]).forEach(g=>{try{g()}catch(g){}});var P=g.__ra2webVirtualJoystickLite;P&&(P.dispose?.(),"undefined"!=typeof window&&window.__ra2webVirtualJoystickLite===P&&(window.__ra2webVirtualJoystickLite=void 0)),g.__ra2webVirtualJoystickLite=void 0,g.__ra2webVirtualJoystickLiteDisposers=[]}(this),await L.apply(this,arguments)},P.prototype.__ra2webVirtualJoystickPatched=!0}}return{setters:[function(P){g=P},function(g){P=g},function(g){I=g},function(g){L=g}],execute:function(){!function patchWorldInteractionVirtualTap(){var g=P?.WorldInteraction;if(g&&!g.prototype.__ra2webVirtualTapPatched){var L=I?.ActionFilter?.All??0;g.prototype.virtualTap=function(g,P,I=!1){if(!(g&&this.defaultActionHandler&&this.mapHoverHandler&&this.unitSelectionHandler))return!1;var _=this.worldScene?.viewport;if(!function pointInViewport(g,P){return!!P&&g.x>=P.x&&g.y>=P.y&&g.x<P.x+P.width&&g.y<P.y+P.height}(g,_))return!1;try{this.mapHoverHandler.update?.(g,!0);var U=this.mapHoverHandler.getCurrentHover?.();if(!U)return!1;var G=this.unitSelectionHandler.getSelectedUnits?.()??[],V=P??this.lastKeyMods;return!!this.defaultActionHandler.execute(U,G,L,!1,!!I,V)}catch(g){return console.warn("WorldInteraction.virtualTap failed",g),!1}},g.prototype.__ra2webVirtualTapPatched=!0}}(),patchGameScreenLifecycle()}}}),System.register("WerhdMixPatch",["engine/gameRes/GameRes","engine/Engine","engine/ResourceLoader","data/DataStream","data/MixFile","engine/type/ObjectType","gui/screen/game/loadingScreen/LoadingScreenWrapper","engine/gfx/ImageUtils","data/ShpFile","data/Palette","engine/EngineType","game/gameopts/constants"],function(){"use strict";var g,P,I,L,_,U,G,V,W,z,K,q,$="__ra2webWerhdMixPatched",Q="__ra2webWerhdVfsProbePatched",Y="werhd.mix",Z="__ra2webWerhdLoadRulesProbePatched",X="__ra2webLoadingScreenShpPatch";function getArchiveNameByInstance(g,P){var I=g?.allArchives;if(!I?.entries)return"";for(var L of I.entries())if(L[1]===P)return L[0];return""}function logRuleFileResolution(g,P){var I=!1;try{I=!!g?.fileExists?.(P)}catch(g){}I&&function getArchiveProbe(g,P){var I=[],L="",_=!1,U=!1,G=g?.archivesByPriority??[];for(var V of G){var W=!1;try{W=!!V?.containsFile?.(P)}catch(g){}if(W){var z=getArchiveNameByInstance(g,V)||"(unknown)";L||(L=z),z===Y?_=!0:"ra2cd.mix"===z&&(U=!0),I.length<6&&I.push(z)}}return{candidates:I,chosenArchive:L,werhdContains:_,ra2cdContains:U}}(g,P);if(I)try{var L=g?.openFile?.(P);L?.getSize?.()??-1;var _=L?.readAsString?.()??"";/\[\s*SMIN\s*\]/i.test(_),/\[\s*HARV\s*\]/i.test(_),/\[\s*VehicleTypes\s*\]/i.test(_);var U=_.match(/^\s*HarvesterUnit\s*=\s*([^\r\n;]+)/im);U?.[1]&&U[1].trim();var G=_.match(/^\s*BaseUnit\s*=\s*([^\r\n;]+)/im);G?.[1]&&G[1].trim()}catch(g){}}function installLoadingScreenShpPatch(g,P,I,L,_,U,G){if(P&&!P.prototype[X]){var V=P.prototype.createUiObject;"function"==typeof V&&(P.prototype.createUiObject=function(P){var W=V.apply(this,arguments);try{var z=P?.gameResConfig;if(!z?.isCdn?.())return W;var K=this.bgHtmlImg;if(!K||!String(K).toLowerCase().includes("/ls/")||!String(K).toLowerCase().includes(".png"))return W;var q=(String(K).split("?")[0].split("/").pop()??"").replace(/\.png$/i,".shp"),$=g.getActiveEngine?.(),Q=function getLoadingScreenPaletteByCountry(g,P,I,L){var _=L?.OBS_COUNTRY_NAME;return P===I?.YurisRevenge?(new Map).set("Americans","mplsu.pal").set("French","mplsf.pal").set("Germans","mplsg.pal").set("British","mplsuk.pal").set("Russians","mplsr.pal").set("Confederation","mplsc.apl").set("Africans","mplsl.pal").set("Arabs","mplsi.pal").set("Alliance","mplsk.pal").set("YuriCountry","mpyls.pal").set(_,"mplsobs.pal").get(g)??"mplsobs.pal":g===_?"mplsobs.pal":"mpls.pal"}(this.countryName,$,U,G),Y=!!g.vfs?.fileExists?.(q),Z=!!g.vfs?.fileExists?.(Q);if(!Y||!Z)return W;var X=new L(g.vfs.openFile(q)),J=new _(g.vfs.openFile(Q)),ee=I.convertShpToCanvas(X,J);this.bgHtmlImg=ee.toDataURL("image/png")}catch(g){console.error("Failed to load loading screen SHP override",g)}return W},P.prototype[X]=!0)}}return{setters:[function(P){g=P},function(g){P=g},function(g){I=g},function(g){L=g},function(g){_=g},function(g){U=g},function(g){G=g},function(g){V=g},function(g){W=g},function(g){z=g},function(g){K=g},function(g){q=g}],execute:function(){var X=g?.GameRes;if(X&&!X.prototype[$]){var J=P?.Engine,ee=I?.ResourceLoader,te=L?.DataStream,re=_?.MixFile,se=U?.ObjectType,ae=G?.LoadingScreenWrapper,ne=V?.ImageUtils,oe=W?.ShpFile,le=z?.Palette,ce=K?.EngineType,he=q;if(J&&ee&&te&&re){!function installLoadRulesProbe(g,P){if(g&&!g[Z]){var I=g.loadRules;"function"==typeof I&&(g.loadRules=function(){var L=g.vfs;try{g.getActiveEngine?.()}catch(g){}for(var _ of["rules.ini","rulesmd.ini","rulescd.ini","art.ini","artmd.ini","artcd.ini","ai.ini","aimd.ini","mpmodescd.ini"])logRuleFileResolution(L,_);var U=I.apply(this,arguments);try{var G=g.getRules?.(),V=P?.Vehicle;G&&void 0!==V&&(G.hasObject?.("SMIN",V),G.hasObject?.("HARV",V),String(G?.general?.harvesterUnit??""),Array.isArray(G?.general?.baseUnit)&&G.general.baseUnit.slice(0,6)),G?.getIni?.().getSection?.("SMIN")}catch(g){}return U},g[Z]=!0)}}(J,se),installLoadingScreenShpPatch(J,ae,ne,oe,le,ce,he);var ue=X.prototype.loadCustomMix;"function"==typeof ue?(X.prototype.loadCustomMix=async function(g){if(await ue.apply(this,arguments),!J.getActiveMod?.())try{var P=new ee(this.appResPath),I=await P.loadBinary(`${Y}?v=${this.appVersion}`),L=new re(new te(I));!function probeWerhdDirectContent(g){var P=[];for(var I of["ltank.vxl","ltanktur.vxl","ltankbarl.vxl","cfv.vxl","cfvtur.vxl","cmmtk.vxl","cmmtktur.vxl","cmcv.vxl","cminer.vxl","csub.vxl","cv3.vxl","hvhelo.vxl","cabiboat.vxl","cdronecarrier.vxl"]){var L=!1;try{L=!!g?.containsFile?.(I)}catch(g){}L&&P.push(I)}}(L),function probeWerhdNestedMixCandidates(g){var P=[];for(var I of["ecache","expand","elocal"])for(var L=0;L<=99;L+=1){var _=L<10?"0"+L:""+L,U=I+_+".mix",G=I+"md"+_+".mix",V=!1,W=!1;try{V=!!g?.containsFile?.(U)}catch(g){}try{W=!!g?.containsFile?.(G)}catch(g){}V&&P.push(U),W&&P.push(G)}}(L),g.addArchive(L,Y);(function loadNestedMixesFromWerhd(g,P,I,L){var _=function collectWerhdNestedMixNames(g){var P=[];for(var I of["ecache","expand","elocal"])for(var L=99;L>=0;L-=1){var _=L<10?"0"+L:""+L,U=I+_+".mix",G=I+"md"+_+".mix";try{g?.containsFile?.(U)&&P.push(U)}catch(g){}try{g?.containsFile?.(G)&&P.push(G)}catch(g){}}return P}(P),U=[];for(var G of _){var V=`${Y}::${G}`;if(g?.hasArchive?.(V))U.push(V);else try{var W=P.openFile(G),z=W?.stream;if(!z)throw new Error(`Nested mix stream missing for "${G}"`);var K=new I(new L(z.dataView));g.addArchive(K,V),U.push(V)}catch(g){throw new Error(`Failed to load nested mix "${G}" from "${Y}"`,{cause:g})}}return U})(g,L,re,te);var _=g.listArchives?.()??[];_.indexOf(Y),_.indexOf("ra2cd.mix"),g?.archivesByPriority?.slice?.(0,6)?.map?.(function(P){return getArchiveNameByInstance(g,P)||"(unknown)"});!function ensureVfsProbe(g){if(g&&!g[Q]){var P=g.openFile,I=g.fileExists;"function"==typeof P&&"function"==typeof I&&(g.fileExists=function(g){return I.apply(this,arguments)},g.openFile=function(g){var I=String(g||"").toLowerCase();if(!I.endsWith(".vxl")&&!I.endsWith(".hva"))return P.apply(this,arguments);try{return P.apply(this,arguments)}catch(g){throw g}},g[Q]=!0)}}(g)}catch(g){throw function wrapRequiredMixError(g){try{return new Error(`Failed to load required mix "${Y}"`,{cause:g})}catch(I){var P=new Error(`Failed to load required mix "${Y}"`);return P.cause=g,P}}(g)}},X.prototype[$]=!0):console.warn("WerhdMixPatch skipped: loadCustomMix is not a function.")}else console.warn("WerhdMixPatch skipped due to missing dependencies.")}}}}),System.register("worker/WorkerApi",[],function(g,P){"use strict";return P&&P.id,{setters:[],execute:function(){}}});